<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Phone Chat Ê®°ÊãüÂô®</title>
    <script src="https://cdn.jsdelivr.net/npm/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&family=Comic+Neue:wght@400;700&family=Fredoka+One&family=Nunito:wght@400;500;600;700&family=Montserrat:wght@400;500;600&family=Inter:wght@400;500;600&family=Roboto:wght@400;500&family=Raleway:wght@400;500;600&family=Lato:wght@400;700&family=Poppins:wght@400;500;600&family=Quicksand:wght@400;500;600&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="phone-frame">
    <div id="phone-screen">
        <div class="wallpaper" id="wallpaper-element">
            <!-- ‰∏ªÂ±èÂπïÁä∂ÊÄÅÊ†è -->
            <div id="status-bar">
                <span id="status-bar-time">14:25</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">·∞î·©ö</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            
            <!-- Êó∂ÈíüÂÆπÂô® -->
            <div id="clock-container">
                <div id="main-time">14:25</div>
                <div id="main-date">12Êúà18Êó• ÊòüÊúü‰∏Ä</div>
            </div>
            
            <div id="worldbook-screen" class="app-screen">
                <div class="app-status-bar">
                    <div class="app-status-time"></div>
                    <div class="app-battery-container">
                        <span class="battery-text">·∞î·©ö</span>
                        <div class="app-battery-icon">
                            <div class="app-battery-level"></div>
                        </div>
                    </div>
                </div>
                <div class="app-header">
                    <button class="back-button" onclick="hideApp('worldbook-screen')">‚Äπ</button>
                    <div class="app-title">‰∏ñÁïå‰π¶</div>
                    <div class="add-worldbook-btn worldbook-add-btn" onclick="onWorldbookAddClick()">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>

                <div class="app-content">
                    <div id="global-worldbooks-content" class="worldbook-content-pane">
                        </div>
                    <div id="local-worldbooks-content" class="worldbook-content-pane" style="display: none;">
                        </div>
                </div>

                <div class="worldbook-tabs">
                    <div class="worldbook-tab active" onclick="switchWorldbookTab('global')">
                        <i class="fas fa-globe-asia"></i>
                        <span>ÂÖ®Â±ÄËÆæÂÆö</span>
                    </div>
                    <div class="worldbook-tab" onclick="switchWorldbookTab('local')">
                        <i class="fas fa-comment-dots"></i>
                        <span>Â±ÄÈÉ®ËÆæÂÆö</span>
                    </div>
                </div>
            </div>
                
                <!-- Â∫îÁî®ÂõæÊ†á -->
                <div id="app-grid">
                    <div class="app-row">
                        <a href="#" class="app" onclick="showApp('chat-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" alt="Chat" class="app-icon-img">
                            </div>
                            <span>Chat</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('worldbook-screen'); switchWorldbookTab('global');">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/Xqz3zPz7/IMG-3080.jpg" alt="‰∏ñÁïå‰π¶" class="app-icon-img">
                            </div>
                            <span>‰∏ñÁïå‰π¶</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('settings-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/764L3jpF/IMG-3079.jpg" alt="ËÆæÁΩÆ" class="app-icon-img">
                            </div>
                            <span>ËÆæÁΩÆ</span>
                        </a>
                    </div>
                    <div class="app-row">
                                        <a href="#" class="app" onclick="showApp('game-screen')">
                            <div class="app-icon">
                        <i class="fas fa-gamepad"></i>
                            </div>
                    <span>Ê∏∏Êàè</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('music-screen')">
                            <div class="app-icon">
                                <i class="fas fa-music"></i>
                            </div>
                            <span>Èü≥‰πê</span>
                        </a>
                                        <a href="#" class="app" onclick="showApp('forum-screen')">
                            <div class="app-icon">
                        <i class="fas fa-comments"></i>
                            </div>
                    <span>ËÆ∫Âùõ</span>
                        </a>
                    </div>
                </div>

                
                <!-- ËÅäÂ§©ÁïåÈù¢ -->
                <div id="chat-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('chat-screen')">‚Äπ</button>
                        <div class="app-title">üí¨</div>
                        <div class="chat-header-actions">
                            <div id="add-contact-btn" class="add-btn" onclick="showCharacterForm()">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div id="add-chat-btn" class="add-btn" onclick="showChatOptions()">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="app-content" id="chat-content">
                        <!-- ÈªòËÆ§ÊòæÁ§∫Ê∂àÊÅØÂàóË°® -->
                        <div class="message-list" id="message-list">
                            <!-- Ê∂àÊÅØÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        
                        <!-- ÈÄöËÆØÂΩï -->
                        <div class="contact-list hide" id="contact-list">
                            <div class="contact-section">
        
                                <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>

                        </div>
                        
                        <!-- Âä®ÊÄÅÈ°µÈù¢ -->
                        <div class="moments-page hide moments-page-no-padding" id="moments-page">
                            <div class="moments-header">
                                <div class="moments-cover" onclick="changeCoverImage()">
                                    <div class="cover-image-placeholder" id="cover-placeholder">
                                        <div class="cover-placeholder-text">ÁÇπÂáªÊõ¥Êç¢Â∞ÅÈù¢</div>
                                        </div>
                                    <img class="cover-image hide" id="cover-image" src="">
                                    </div>
                                
                                <!-- Áî®Êà∑ÂêçÔºåÁã¨Á´ãÊîæÁΩÆÂú®Â§¥ÂÉèÂ∑¶‰∏äËßí -->
                                <div class="moments-username" onclick="changeUsername(event)" id="moments-username">Áî®Êà∑</div>
                                
                                <!-- Áã¨Á´ãÁöÑÂ§¥ÂÉèÔºåË∑®Ë∂äËÉåÊôØÂíåÂä®ÊÄÅÂàóË°®Âå∫ÂüüÔºåÊîæÂú®headerÂ§ñÈù¢ -->
                                <div class="moments-avatar" onclick="changeAvatarImage(event)" id="moments-avatar">
                                    <i class="fas fa-user moments-avatar-icon"></i>
                                </div>
                            </div>
                            
                            <div class="moments-list" id="moments-list">
                                <!-- Âä®ÊÄÅÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            

                        </div>

                        
                        <!-- Èù¢ÂÖ∑Âå∫Âüü -->
                        <div class="profile-page hide" id="profile-page">
                            <div class="persona-header">
                                <div class="persona-title">
                                    <h2>ÊàëÁöÑÈù¢ÂÖ∑</h2>
                                    <p>ÁÆ°ÁêÜ‰Ω†ÁöÑÂ§öÈáçË∫´‰ªΩËÆæÂÆö</p>
                                </div>
                                <div class="add-persona-btn persona-add-btn" onclick="showPersonaForm()">
                                    <i class="fas fa-plus"></i>
                                </div>
                            </div>
                            
                            <div class="persona-list" id="persona-list">
                                <!-- Èù¢ÂÖ∑ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            

                        </div>
                    </div>
                    
                    <div class="chat-tabs">
                        <div class="chat-tab active" onclick="switchChatTab('message-list')" id="message-tab">
                            <i class="fas fa-comment-alt"></i>
                            <span>Ê∂àÊÅØ</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('contact-list')">
                            <i class="fas fa-address-book"></i>
                            <span>ËßíËâ≤</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('moments-page')">
                            <i class="fas fa-circle-notch"></i>
                            <span>Âä®ÊÄÅ</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('profile-page')">
                            <i class="fas fa-masks-theater"></i>
                            <span>Êàë</span>
                        </div>
                    </div>
                </div>
                
                <!-- ÂèëÂ∏ÉÂä®ÊÄÅÁïåÈù¢ -->
                <div id="publish-moment-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hidePublishMoment()">‚Äπ</button>
                        <div class="app-title">ÂèëË°®Âä®ÊÄÅ</div>
                        <button class="publish-btn" onclick="publishMoment()">ÂèëË°®</button>
                    </div>
                    <div class="app-content">
                        <div class="publish-moment-form">
                            <!-- ÊñáÂ≠óËæìÂÖ•Âå∫Âüü -->
                            <div class="moment-text-input">
                                <textarea 
                                    id="moment-text" 
                                    placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã..." 
                                    class="moment-textarea"
                                    maxlength="500"
                                    oninput="updateTextCount()"></textarea>
                                <div class="text-count" id="text-count">0/500</div>
                            </div>
                            
                            <!-- ÂõæÁâá‰∏ä‰º†Âå∫Âüü -->
                            <div class="moment-images-section">
                                <div class="moment-images-grid" id="moment-images-grid">
                                    <!-- Âä®ÊÄÅÊ∑ªÂä†ÁöÑÂõæÁâáÈ¢ÑËßà -->
                                </div>
                                <div class="add-image-btn" onclick="addMomentImage()">
                                    <i class="fas fa-plus"></i>
                                    <span>Ê∑ªÂä†ÂõæÁâá</span>
                                </div>
                            </div>
                            
                            <!-- ÂèëÂ∏ÉÈÄâÈ°π -->
                            <div class="publish-options">
                                <div class="option-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>ÊâÄÂú®‰ΩçÁΩÆ</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                <div class="option-item">
                                    <i class="fas fa-users"></i>
                                    <span>ÊèêÈÜíË∞ÅÁúã</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                <div class="option-item">
                                    <i class="fas fa-eye"></i>
                                    <span>Ë∞ÅÂèØ‰ª•Áúã</span>
                                    <span class="option-value">ÂÖ¨ÂºÄ</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ËÆ∫ÂùõÁïåÈù¢ -->
                <div id="forum-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('forum-screen')">‚Äπ</button>
                        <div class="app-title">ËÆ∫Âùõ</div>
                    </div>
                    <div class="app-content">
                        <div class="forum-categories">
                            <div class="forum-category">
                                <div class="category-icon">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">ÁÉ≠Èó®ËØùÈ¢ò</div>
                                    <div class="category-desc">ÊúÄÂèóÊ¨¢ËøéÁöÑËÆ®ËÆ∫</div>
                            </div>
                                <div class="category-count">128</div>
                            </div>
                            <div class="forum-category">
                                <div class="category-icon">
                                    <i class="fas fa-gamepad"></i>
                            </div>
                                <div class="category-info">
                                    <div class="category-name">Ê∏∏ÊàèËÆ®ËÆ∫</div>
                                    <div class="category-desc">ÂàÜ‰∫´Ê∏∏ÊàèÂøÉÂæó</div>
                                </div>
                                <div class="category-count">89</div>
                                </div>
                            <div class="forum-category">
                                <div class="category-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">ËßíËâ≤‰∫íÂä®</div>
                                    <div class="category-desc">‰∏éAIËßíËâ≤ÁöÑÊïÖ‰∫ã</div>
                                </div>
                                <div class="category-count">256</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏ñÁïå‰π¶ÁºñËæëË°®Âçï -->
                <div id="worldbook-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideWorldbookForm()">‚Äπ</button>
                        <div class="app-title" id="worldbook-form-title">Êñ∞Âª∫‰∏ñÁïå‰π¶</div>
                        <button class="save-worldbook-btn save-btn-absolute" onclick="saveWorldbook()">‰øùÂ≠ò</button>
                    </div>
                    <div class="app-content">
                        <div class="worldbook-form">
                            <div class="form-group">
                                <label class="form-label">Ê†áÈ¢ò</label>
                                <input type="text" id="worldbook-title" class="form-input" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶Ê†áÈ¢ò">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂÜÖÂÆπ</label>
                                <textarea id="worldbook-content" class="form-textarea textarea-large" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºåËøôÈáåÂèØ‰ª•ÊèèËø∞ËßíËâ≤ËÉåÊôØ„ÄÅ‰∏ñÁïåËßÇËÆæÂÆöÁ≠â..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Èü≥‰πêÂ∫îÁî®ÁïåÈù¢ -->
                <div id="music-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('music-screen')">‚Äπ</button>
                        <div class="app-title">Èü≥‰πê</div>
                    </div>
                    <div class="app-content">
                        <div class="music-player">
                            <div class="now-playing">
                                <div class="album-cover" id="album-cover">
                                    <i class="fas fa-music"></i>
                                </div>
                                <div class="song-info">
                                    <div class="song-title" id="song-title">ÈÄâÊã©‰∏ÄÈ¶ñÊ≠åÊõ≤</div>
                                    <div class="artist-name" id="artist-name">Êú™Áü•Ëâ∫ÊúØÂÆ∂</div>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress" id="progress"></div>
                                </div>
                                <div class="time-info">
                                    <span id="current-time">0:00</span>
                                    <span id="total-time">0:00</span>
                                </div>
                            </div>
                            
                            <div class="music-controls">
                                <button class="control-btn" onclick="previousSong()">
                                    <i class="fas fa-step-backward"></i>
                                </button>
                                <button class="control-btn play-pause" id="play-pause-btn" onclick="togglePlayPause()">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="control-btn" onclick="nextSong()">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                            </div>
                            
                            <div class="playlist-section">
                                <div class="section-header">
                                    <h3>Êí≠ÊîæÂàóË°®</h3>
                                    <button class="add-music-btn" onclick="addMusicToPlaylist()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="playlist" id="playlist">
                                    <!-- Êí≠ÊîæÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                            
                            <div class="character-listening">
                                <div class="listening-header">
                                    <h3>‰∏ÄËµ∑Âê¨Ê≠åÁöÑËßíËâ≤</h3>
                                    <button class="invite-character-btn" onclick="inviteCharacterToListen()">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                                <div class="listening-characters" id="listening-characters">
                                    <!-- Âê¨Ê≠åËßíËâ≤Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢ -->
                <div id="api-chat-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideChatSettings()">‚Äπ</button>
                        <div class="app-title">ËÅäÂ§©ËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content padding-none-flex overflow-auto">
                        <div class="settings-container">
                            
                            <!-- Áæ§ËÅä‰∏ìÁî®ËÆæÁΩÆ - ‰ªøQQ/ÂæÆ‰ø°Áæ§ËÅäÁïåÈù¢ -->
                            <div class="settings-section" id="group-chat-settings" style="display: none;">
                                <!-- Áæ§ËÅä‰ø°ÊÅØÂç°Áâá -->
                                <div class="group-info-card">
                                    <div class="group-avatar-section" onclick="changeGroupAvatar()">
                                        <img id="group-avatar-preview" src="" class="group-avatar-large" alt="Áæ§Â§¥ÂÉè">
                                        <div class="group-avatar-edit-hint">ÁÇπÂáª‰øÆÊîπ</div>
                                    </div>
                                    <div class="group-basic-info">
                                        <div class="group-name" onclick="changeGroupName()" id="group-name-display">Áæ§ËÅäÂêçÁß∞</div>
                                        <div class="group-member-count" id="group-member-count-display">0ÂêçÊàêÂëò</div>
                                        <div class="group-description" onclick="editGroupDescription()" id="group-description-display">Áæ§ÂÖ¨ÂëäÔºöÁÇπÂáªËÆæÁΩÆÁæ§ÂÖ¨Âëä</div>
                                    </div>
                                </div>

                                <!-- Áæ§ÊàêÂëòÂ±ïÁ§∫Âå∫Âüü -->
                                <div class="group-members-section">
                                    <div class="section-title">Áæ§ÊàêÂëò</div>
                                    <div class="group-members-grid" id="group-members-grid">
                                        <!-- Áæ§ÊàêÂëòÂ§¥ÂÉèÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                                        <div class="member-item add-member" onclick="addGroupMember()">
                                            <div class="member-avatar">
                                                <i class="fas fa-plus"></i>
                                            </div>
                                            <div class="member-name">ÈÇÄËØ∑</div>
                                        </div>
                                        <div class="member-item remove-member" onclick="removeGroupMember()">
                                            <div class="member-avatar">
                                                <i class="fas fa-minus"></i>
                                            </div>
                                            <div class="member-name">ÁßªÈô§</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Áæ§ÂäüËÉΩËÆæÁΩÆ -->
                                <div class="setting-card">
                                    <div class="setting-item" onclick="changeMyGroupNickname()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊàëÂú®Êú¨Áæ§ÁöÑÊòµÁß∞</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-my-group-nickname">Êú™ÈÄâÊã©</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showGroupNotice()">
                                        <div class="setting-left">
                                            <div class="setting-label">Áæ§ÂÖ¨Âëä</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value">Êü•ÁúãËØ¶ÊÉÖ</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>

                                <!-- Áæ§Â∫îÁî®‰∏≠ÂøÉ -->
                                <div class="group-apps-section">
                                    <div class="section-title">Áæ§Â∫îÁî®</div>
                                    <div class="group-apps-grid">
                                        <div class="app-item" onclick="showGroupVote()">
                                            <i class="fas fa-vote-yea app-icon"></i>
                                            <span class="app-name">ÊäïÁ•®</span>
                                        </div>
                                        <div class="app-item" onclick="showGroupActivity()">
                                            <i class="fas fa-calendar-alt app-icon"></i>
                                            <span class="app-name">Áæ§Ê¥ªÂä®</span>
                                        </div>
                                        <div class="app-item" onclick="showGroupTask()">
                                            <i class="fas fa-tasks app-icon"></i>
                                            <span class="app-name">Áæ§‰ªªÂä°</span>
                                        </div>
                                        <div class="app-item" onclick="showMoreApps()">
                                            <i class="fas fa-ellipsis-h app-icon"></i>
                                            <span class="app-name">Êõ¥Â§ö</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ËÅäÂ§©Á™óÂè£ËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-user-edit section-icon"></i>
                                    <span class="section-title">ËÅäÂ§©Á™óÂè£ËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <!-- Ë∫´‰ªΩÈÄâÊã©ÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåË∫´‰ªΩÂú®ÂàõÂª∫ÂØπËØùÊó∂ÈÄâÊã© -->
                                    <!-- ÂçïËÅäÊó∂ÊòæÁ§∫ÂèåÊñπËÆæÁΩÆÔºåÁæ§ËÅäÊó∂ÈöêËóè -->
                                    <div class="setting-item single-chat-only" onclick="showAvatarSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂèåÊñπÂ§¥ÂÉèËÆæÁΩÆ</div>
                                            <div class="setting-desc">ËÆæÁΩÆÂú®Ê≠§ËÅäÂ§©Á™óÂè£‰∏≠ÊòæÁ§∫ÁöÑÂ§¥ÂÉè</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only" onclick="showNicknameSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂèåÊñπÂ§áÊ≥®ËÆæÁΩÆ</div>
                                            <div class="setting-desc">ËÆæÁΩÆÂú®Ê≠§ËÅäÂ§©Á™óÂè£‰∏≠ÊòæÁ§∫ÁöÑÊòµÁß∞</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBackgroundSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ËÅäÂ§©ËÉåÊôØËÆæÁΩÆ</div>
                                            <div class="setting-desc">Ëá™ÂÆö‰πâËÅäÂ§©ÁïåÈù¢ÁöÑËÉåÊôØÂõæÁâá</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBubbleStyleSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ</div>
                                            <div class="setting-desc">ÈÄâÊã©Ê∞îÊ≥°Â§ñËßÇÊ†∑ÂºèÂíåÈ¢úËâ≤</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-bubble-style">ÈªòËÆ§Ê†∑Âºè</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Êà≥‰∏ÄÊà≥ÂäüËÉΩËÆæÁΩÆ - ÂçïËÅäÁâπÊúâ -->
                            <div class="settings-section" id="poke-settings-section">
                                <div class="section-header">
                                    <i class="fas fa-hand-paper section-icon"></i>
                                    <span class="section-title">Êà≥‰∏ÄÊà≥ÂäüËÉΩ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂêØÁî®Êà≥‰∏ÄÊà≥</div>
                                            <div class="setting-desc">ÂÖÅËÆ∏ÂèëÈÄÅÊà≥‰∏ÄÊà≥Ê∂àÊÅØÔºåÂèåÊñπÂèØËá™ÂÆö‰πâÊà≥‰∏ÄÊà≥ÂêéÁºÄ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="poke-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item poke-settings poke-settings-visible" id="poke-suffix-settings" onclick="showPokeSuffixSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ</div>
                                            <div class="setting-desc">Ëá™ÂÆö‰πâÂèåÊñπÁöÑÊà≥‰∏ÄÊà≥Âä®‰ΩúÂêéÁºÄ</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-explanation">
                                        <div class="explanation-text">
                                            <strong>ÂäüËÉΩËØ¥ÊòéÔºö</strong><br>
                                            ‚Ä¢ ÁÇπÂáªÂØπÊñπÂ§¥ÂÉèÂç≥ÂèØÂèëÈÄÅÊà≥‰∏ÄÊà≥<br>
                                            ‚Ä¢ ‰Ω†ÂèØ‰ª•Ëá™ÂÆö‰πâÊà≥‰∏ÄÊà≥ÂêéÁºÄÔºåÂ¶Ç"ÁöÑÂ∞èËÑ∏Ëõã"„ÄÅ"ÁöÑÂ∞èÊâã"Á≠â<br>
                                            ‚Ä¢ ËßíËâ≤‰πü‰ºöÊ†πÊçÆÂøÉÊÉÖÂíåËÅäÂ§©ÂÜÖÂÆπËá™‰∏ª‰øÆÊîπËá™Â∑±ÁöÑÊà≥‰∏ÄÊà≥ÂêéÁºÄ
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ËÆ∞ÂøÜËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-brain section-icon"></i>
                                    <span class="section-title">ËÆ∞ÂøÜËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showHistorySettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÈôÑÂ∏¶ÂéÜÂè≤Ê∂àÊÅØÊï∞</div>
                                            <div class="setting-desc">Ëá™ÂÆö‰πâËßíËâ≤ÂõûÂ§çÊó∂ÂèÇËÄÉÁöÑÂéÜÂè≤ÂØπËØùÊï∞Èáè</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-history-count">5ÂõûÂêà</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showMemoryMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊåÇËΩΩÂÖ∂‰ªñËÅäÂ§©ËÆ∞ÂøÜ</div>
                                            <div class="setting-desc">ËÆ©ËßíËâ≤ÂèÇËÄÉÂÖ∂‰ªñËÅäÂ§©Á™óÂè£ÁöÑÂØπËØùËÆ∞ÂøÜ</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-memory-mount">Â∑≤ÂÖ≥Èó≠</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showWorldbookMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊåÇËΩΩ‰∏ñÁïå‰π¶</div>
                                            <div class="setting-desc">ËÆ©ËßíËâ≤ÂèÇËÄÉÈÄâÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØÁü•ËØÜ</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-worldbook-mount">Êú™ÊåÇËΩΩ</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Êó∂Èó¥ÊÑüÁü•ËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-clock section-icon"></i>
                                    <span class="section-title">Êó∂Èó¥ÊÑüÁü•</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">Êó∂Èó¥ÊÑüÁü•ÂºÄÂÖ≥</div>
                                            <div class="setting-desc">ËßíËâ≤‰ºöÊÑüÁü•ÂΩìÂâçÊó∂Èó¥Âπ∂Ë∞ÉÊï¥ÂõûÂ§ç</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="time-awareness-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÈÄöËØùËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-phone section-icon"></i>
                                    <span class="section-title">ÈÄöËØùËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ËßíËâ≤‰∏ªÂä®Êã®ÊâìÁîµËØù</div>
                                            <div class="setting-desc">ÂÖÅËÆ∏ËßíËâ≤Ê†πÊçÆÂØπËØùÂÜÖÂÆπ‰∏ªÂä®ÂèëËµ∑ÈÄöËØù</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-call-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-explanation">
                                        <div class="explanation-text">
                                            <strong>ÂäüËÉΩËØ¥ÊòéÔºö</strong><br>
                                            ‚Ä¢ <strong>ÂºÄÂêØÊó∂Ôºö</strong>ÂΩìÊú¨ËΩÆËÅäÂ§©‰∏≠ÊèêÂà∞ÈÄöËØùÁõ∏ÂÖ≥ÂÜÖÂÆπÊó∂ÔºåËßíËâ≤Êúâ20%Ê¶ÇÁéá‰∏ªÂä®Áªô‰Ω†ÊâìÁîµËØù<br>
                                            ‚Ä¢ <strong>ÂÖ≥Èó≠Êó∂Ôºö</strong>ËßíËâ≤‰∏ç‰ºö‰∏ªÂä®Êã®ÊâìÁîµËØùÔºåÂè™ËÉΩÁî±Áî®Êà∑‰∏ªÂä®ÂèëËµ∑ÈÄöËØù<br>
                                            ‚Ä¢ <strong>ÈÄöËØùÂÖ≥ÈîÆËØçÔºö</strong>ÈÄöËØù„ÄÅÁîµËØù„ÄÅËßÜÈ¢ë„ÄÅËØ≠Èü≥„ÄÅÊâìÁªô‰Ω†„ÄÅÊÉ≥Âê¨„ÄÅÊÉ≥ÁúãÁ≠â
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AIÂøÉÁéáÁõëÊµã -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-heartbeat section-icon"></i>
                                    <span class="section-title">ËßíËâ≤ÂøÉÁéáÁõëÊµã</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂøÉÁéáÁõëÊµãÊòæÁ§∫</div>
                                            <div class="setting-desc">Âú®Áä∂ÊÄÅÊ†èÊòæÁ§∫ËßíËâ≤ÁöÑÊÉÖÊÑüÂøÉÁéá</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-heartrate-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-comments section-icon"></i>
                                    <span class="section-title">ËÅäÂ§©Ê®°Âºè</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">Ê®°ÂºèÈÄâÊã©</div>
                                            <div class="setting-desc">ÈÄâÊã©Á∫ø‰∏äÁ∫ØËÅäÂ§©ÊàñÁ∫ø‰∏ãÂâßÊÉÖÊ®°Âºè</div>
                                        </div>
                                    </div>
                                    <div class="chat-mode-switch">
                                        <div class="chat-mode-option">
                                            <input type="radio" id="chat-mode-online" name="chat-mode" value="online" checked>
                                            <label for="chat-mode-online">Á∫ø‰∏äÊ®°Âºè</label>
                                        </div>
                                        <div class="chat-mode-option">
                                            <input type="radio" id="chat-mode-offline" name="chat-mode" value="offline">
                                            <label for="chat-mode-offline">Á∫ø‰∏ãÊ®°Âºè</label>
                                        </div>
                                    </div>
                                    <div class="offline-length-control hide" id="offline-length-control">
                                        <span class="control-label">ÊØèÊù°Ê∂àÊÅØÊúÄÈïøÔºö</span>
                                        <input type="number" id="offline-mode-max-length" min="50" max="500" value="100">
                                        <span class="control-unit">Â≠ó</span>
                                    </div>
                                </div>
                            </div>



                            <!-- ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-robot section-icon"></i>
                                    <span class="section-title">ÂêéÂè∞‰∫íÂä®</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂêéÂè∞‰∫íÂä®ÂºÄÂÖ≥</div>
                                            <div class="setting-desc">ËßíËâ≤ÂèØÂú®ÂêéÂè∞‰∏ªÂä®Ê¥ªÂä®Âπ∂ÂèëÈÄÅÊé®ÈÄÅ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="background-interaction-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="background-interaction-details hide" id="background-interaction-settings">
                                        <div class="setting-item">
                                        <div class="setting-left">
                                                <div class="setting-label">‰∏ªÂä®ËÅäÂ§©</div>
                                                <div class="setting-desc">ËßíËâ≤Âú®‰Ω†10ÂàÜÈíüÊú™ÂõûÂ§çÊó∂‰∏ªÂä®ÂèëÊ∂àÊÅØ</div>
                                        </div>
                                        <div class="setting-right">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="background-chat-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                        </div>
                                    </div>
                                        
                                        <div class="setting-item" id="chat-frequency-setting" style="display: none;">
                                        <div class="setting-left">
                                                <div class="setting-label">‰∏ªÂä®ËÅäÂ§©È¢ëÁéá</div>
                                                <div class="setting-desc">ËßíËâ≤‰∏ªÂä®ÂèëËµ∑ÂØπËØùÁöÑÈ¢ëÁéá</div>
                                        </div>
                                        <div class="setting-right">
                                                <select id="background-chat-frequency" class="setting-select">
                                                    <option value="low">‰Ωé (1-2Â∞èÊó∂/Ê¨°)</option>
                                                    <option value="medium">‰∏≠ (30-60ÂàÜÈíü/Ê¨°)</option>
                                                    <option value="high">È´ò (10-30ÂàÜÈíü/Ê¨°)</option>
                                                </select>
                                </div>
                            </div>

                                    <div class="setting-item">
                                        <div class="setting-left">
                                                <div class="setting-label">‰∏ªÂä®ÂèëÂä®ÊÄÅ</div>
                                                <div class="setting-desc">ËßíËâ≤Ê†πÊçÆ‰∫∫ËÆæ‰∏ªÂä®ÂèëÂ∏ÉÂä®ÊÄÅ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                    <input type="checkbox" id="background-moments-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                        <div class="setting-item" id="moments-frequency-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">‰∏ªÂä®ÂèëÂä®ÊÄÅÈ¢ëÁéá</div>
                                                <div class="setting-desc">ËßíËâ≤‰∏ªÂä®ÂèëÂ∏ÉÁ§æ‰∫§Âä®ÊÄÅÁöÑÈ¢ëÁéá</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; flex-shrink: 0 !important;">
                                                <select id="background-moments-frequency" class="setting-select">
                                                    <option value="low">‰Ωé (4-8Â∞èÊó∂/Ê¨°)</option>
                                                    <option value="medium">‰∏≠ (2-4Â∞èÊó∂/Ê¨°)</option>
                                                    <option value="high">È´ò (1-2Â∞èÊó∂/Ê¨°)</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="setting-item" id="scheduled-moments-setting" style="display: none; justify-content: space-between !important; align-items: flex-start !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">ÂÆöÊó∂ÂèëÂ∏ÉÂä®ÊÄÅ</div>
                                                <div class="setting-desc">ËÆæÁΩÆÂõ∫ÂÆöÊó∂Èó¥ÁÇπËá™Âä®ÂèëÂ∏ÉÂä®ÊÄÅ</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; flex-direction: column !important; align-items: flex-end !important; gap: 8px !important; flex-shrink: 0 !important;">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="scheduled-moments-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <button onclick="showScheduleTimesModal()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    <span id="schedule-times-display">Êú™ËÆæÁΩÆ</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="setting-item" id="test-publish-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">ÊµãËØïÂèëÂ∏É</div>
                                                <div class="setting-desc">ËÆ©ËßíËâ≤Á´ãÂç≥ÂèëÂ∏É‰∏ÄÊù°ÊµãËØïÂä®ÊÄÅ</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; flex-shrink: 0 !important; gap: 8px;">
                                                <button onclick="testPublishMoment()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    ÂèëÂ∏É
                                                </button>
                                                <button onclick="fixAvatarData()" style="background-color: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    ‰øÆÂ§çÂ§¥ÂÉè
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÂÖ∂‰ªñËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-cog section-icon"></i>
                                    <span class="section-title">ÂÖ∂‰ªñËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊòæÁ§∫Êó∂Èó¥Êà≥</div>
                                            <div class="setting-desc">Âú®ËÅäÂ§©Ê∂àÊÅØ‰∏≠ÊòæÁ§∫Êó∂Èó¥‰ø°ÊÅØ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="timestamp-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showTimestampSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">Êó∂Èó¥Êà≥ËÆæÁΩÆ</div>
                                            <div class="setting-desc">ËÆæÁΩÆÊó∂Èó¥Êà≥ÊòæÁ§∫‰ΩçÁΩÆÂíåÊ†ºÂºè</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="searchChatContent()">
                                        <div class="setting-left">
                                            <div class="setting-label">Êü•ÊâæËÅäÂ§©ÂÜÖÂÆπ</div>
                                            <div class="setting-desc">ÊêúÁ¥¢ÂéÜÂè≤Ê∂àÊÅØ‰∏≠ÁöÑÂÖ≥ÈîÆËØç</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="exportChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</div>
                                            <div class="setting-desc">ÂØºÂá∫ÂΩìÂâçÂØπËØùÁöÑÊâÄÊúâÊ∂àÊÅØ</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- Âç±Èô©Êìç‰Ωú -->
                            <div class="settings-section">
                                <div class="section-header">
                                                    <i class="fas fa-exclamation-triangle section-icon danger-section-icon"></i>
                <span class="section-title danger-section-title">Âç±Èô©Êìç‰Ωú</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item danger-item" onclick="clearChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label danger-color">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</div>
                                            <div class="setting-desc">Âà†Èô§ÊâÄÊúâÂéÜÂè≤Ê∂àÊÅØÔºå‰∏çÂèØÊÅ¢Â§ç</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right danger-color"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                
                <!-- ‰∫∫Áâ©ÁºñËæëË°®Âçï -->
                <div id="character-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideCharacterForm()">‚Äπ</button>
                        <div class="app-title" id="character-form-title">Êñ∞Âª∫‰∫∫Áâ©</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">Â§¥ÂÉè</label>
                                <div class="avatar-preview" id="avatar-preview">
                                    <div class="avatar-preview-text" id="avatar-preview-text">A</div>
                                </div>
                                <input type="file" id="avatar-upload" accept="image/*" class="file-input-hidden">
                                <button class="upload-button" onclick="handleAvatarUploadClick()">‰∏ä‰º†Â§¥ÂÉè</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÂßìÂêç</label>
                                <input type="text" class="form-input" id="character-name" placeholder="ËæìÂÖ•ÂßìÂêç">
                            </div>
                            <div class="form-group">
                                <label class="form-label">‰∫∫ËÆæ</label>
                                <textarea class="form-textarea" id="character-bio" placeholder="ËæìÂÖ•‰∫∫Áâ©ËÆæÂÆö"></textarea>
                            </div>
                            <div class="form-actions form-actions-flex">
                                <button class="form-submit form-submit-flex">‰øùÂ≠ò</button>
                                <button class="form-delete form-delete-red" id="character-delete-btn" onclick="deleteCurrentCharacter()">Âà†Èô§</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Èù¢ÂÖ∑ÂàõÂª∫Ë°®Âçï -->
                <div id="persona-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hidePersonaForm()">‚Äπ</button>
                        <div class="app-title" id="persona-form-title">Êñ∞Âª∫Èù¢ÂÖ∑</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">Â§¥ÂÉè</label>
                                <div class="avatar-preview" id="persona-avatar-preview">
                                    <div class="avatar-preview-text" id="persona-avatar-preview-text">Êàë</div>
                                </div>
                                <input type="file" id="persona-avatar-upload" accept="image/*" class="file-input-hidden">
                                <button class="upload-button" onclick="handlePersonaAvatarUploadClick()">‰∏ä‰º†Â§¥ÂÉè</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÂêçÁß∞</label>
                                <input type="text" class="form-input" id="persona-name" placeholder="‰æãÂ¶ÇÔºöuserÂ∞èÊòé„ÄÅuserÂ≠¶Áîü„ÄÅuserÂ∑•‰ΩúËÄÖ">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÊèèËø∞</label>
                                <textarea class="form-textarea" id="persona-description" placeholder="ÊèèËø∞Ëøô‰∏™Ë∫´‰ªΩÁöÑÁâπÁÇπÔºåÂåÖÊã¨ÊÄßÊ†º„ÄÅËØ¥ËØùÈ£éÊ†º„ÄÅ‰ΩøÁî®Âú∫ÂêàÁ≠â..."></textarea>
                            </div>
                            
                            <button class="form-submit" onclick="savePersona()">‰øùÂ≠òÈù¢ÂÖ∑</button>
                        </div>
                    </div>
                </div>
                
                <!-- APIËÅäÂ§©ÁïåÈù¢ -->
                <div id="api-chat-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="header">
                        <div class="default-controls">
                            <button class="back-btn" onclick="backToChatApp()">‚Äπ</button>
                            <span class="header-title" id="api-chat-title">ËßíËâ≤ËÅäÂ§©</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="showChatSettings()">
                                <i class="fas fa-ellipsis-v"></i>
                                </span>
                            </div>
                        </div>
                        <div class="selection-controls">
                            <span id="selection-cancel-btn">ÂèñÊ∂à</span>
                            <span id="selection-count"></span>
                            <span id="selection-delete-btn">Âà†Èô§</span>
                        </div>
                    </div>
                    <div class="app-content padding-none-flex">

                        <div class="chat-dialog">
                            <div class="chat-messages" id="api-chat-messages">
                                <!-- ËÅäÂ§©Ê∂àÊÅØÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            
                            <!-- ÊÇ¨ÊµÆÊåâÈíÆÁªÑ -->
                            <div class="floating-actions" id="floating-actions">
                                <button class="floating-btn" id="regenerate-btn" onclick="regenerateLastResponse()" title="ÈáçÊñ∞ÁîüÊàêÂõûÁ≠î">
                                    <i class="fas fa-redo-alt"></i>
                                </button>
                            </div>
                            
                            <div class="chat-input-area">
                                <!-- Â∑•ÂÖ∑Ê†èÂå∫Âüü -->
                                <div class="chat-tools-row">
                                    <button class="tool-btn-mini" id="voice-record-btn" onclick="handleVoiceRecording()" title="ËØ≠Èü≥Ê∂àÊÅØ">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <button class="tool-btn-mini" onclick="openCamera()" title="ÊãçÁÖß">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                    <button class="tool-btn-mini" onclick="uploadImage()" title="ÂõæÁâá">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="tool-btn-mini" onclick="openTransfer()" title="ËΩ¨Ë¥¶">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                    <button class="tool-btn-mini" onclick="makeCall()" title="ÁîµËØù">
                                        <i class="fas fa-phone"></i>
                                    </button>
                                    <button class="tool-btn-mini" onclick="openVideoCall()" title="ËßÜÈ¢ëÈÄöËØù">
                                        <i class="fas fa-video"></i>
                                    </button>
                                    <button class="tool-btn-mini" onclick="shareLocation()" title="‰ΩçÁΩÆ">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </button>
                                </div>
                                
                                <!-- ËæìÂÖ•Âå∫Âüü -->
                                <div class="input-controls">
                                <button class="chat-action-btn" onclick="showCustomEmojiPanel()" title="Ë°®ÊÉÖÂåÖ">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <textarea class="chat-input" id="api-chat-input" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."></textarea>
                                    <button class="chat-action-btn" onclick="triggerSmartReply()" title="Ëé∑ÂèñAIÂõûÂ§ç">
                                        <i class="fas fa-comment-dots"></i>
                                </button>
                                <button class="send-button" onclick="sendApiMessage()">
                                    ÂèëÈÄÅ
                                </button>
                                </div>
                                <input type="file" id="image-upload" accept="image/*" class="file-input-hidden">
                                <input type="file" id="emoji-upload" accept="image/*" class="file-input-hidden" multiple>
                            </div>
                        </div>
                        
                        <!-- Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÈù¢Êùø -->
                        <div class="custom-emoji-panel" id="custom-emoji-panel">
                            <div class="emoji-tabs">
                                <div class="emoji-tab active" data-tab="recent">ÊúÄËøë</div>
                                <div class="emoji-tab" data-tab="custom">ÂÖ®ÈÉ®</div>
                            </div>
                            <div class="emoji-content">
                                <div class="emoji-grid" id="emoji-grid">
                                    <!-- Ë°®ÊÉÖÂåÖÁΩëÊ†ºÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÊµèËßàÂô®ÁïåÈù¢ -->
                <div id="browser-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('browser-screen')">‚Äπ</button>
                        <div class="app-title">ÊµèËßàÂô®</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="browser-toolbar">
                            <input type="text" class="browser-url-bar" id="browser-url" placeholder="ËæìÂÖ•ÁΩëÂùÄ">
                            <button onclick="loadUrl()">ÂâçÂæÄ</button>
                        </div>
                        <iframe class="browser-content" id="browser-frame"></iframe>
                    </div>
                </div>
                

                
                <!-- Ê∏∏ÊàèÁïåÈù¢ -->
                <div id="game-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('game-screen')">‚Äπ</button>
                        <div class="app-title">Ê∏∏Êàè‰∏≠ÂøÉ</div>
                    </div>
                    <div class="app-content">
                        <div class="game-list">
                            <div class="game-item" onclick="startGame('witchPotion')">
                                <div class="game-icon">
                                    <i class="fas fa-flask"></i>
                        </div>
                                <div class="game-info">
                                    <div class="game-name">Â•≥Â∑´ÁöÑËß£ËçØ</div>
                                    <div class="game-desc">‰∏éAIËßíËâ≤‰∏ÄËµ∑Ë∞ÉÂà∂Á•ûÁßòËçØÊ∞¥</div>
                                </div>
                                <div class="game-badge">NEW</div>
                            </div>
                            <div class="game-item coming-soon">
                                <div class="game-icon">
                                    <i class="fas fa-dice"></i>
                                </div>
                                <div class="game-info">
                                    <div class="game-name">ËßíËâ≤ÁåúË∞ú</div>
                                    <div class="game-desc">Âç≥Â∞ÜÊé®Âá∫</div>
                                </div>
                            </div>
                            <div class="game-item coming-soon">
                                <div class="game-icon">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="game-info">
                                    <div class="game-name">‰∫íÂä®ÊïÖ‰∫ã</div>
                                    <div class="game-desc">Âç≥Â∞ÜÊé®Âá∫</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                

                

                
                <!-- ËÆæÁΩÆÂ∫îÁî® -->
                <div id="settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('settings-screen')">‚Äπ</button>
                        <div class="app-title">ËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showApp('api-settings-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wifi">
                                    <i class="fas fa-wifi"></i>
                                </div>
                                <div>APIËÆæÁΩÆ</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('theme-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon settings-icon-custom">
                                    <i class="fas fa-palette"></i>
                                </div>
                                <div>‰∏ªÈ¢òËÆæÁΩÆ</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('display-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-font"></i>
                                </div>
                                <div>Â≠óÂè∑Â§ßÂ∞è</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('appearance-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div>
                                    <div class="setting-label">Â§ñËßÇËÆæÁΩÆ</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('wallpaper-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wallpaper">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div>Â£ÅÁ∫∏</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('datetime-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon datetime">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>Êó•Êúü‰∏éÊó∂Èó¥</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon notification">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div>ÈÄöÁü•</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('data-management-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon data-management">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div>Êï∞ÊçÆÁÆ°ÁêÜ</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('about-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon about">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div>ÂÖ≥‰∫éÊàë‰ª¨</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Êó•Êúü‰∏éÊó∂Èó¥ËÆæÁΩÆ -->
                <div id="datetime-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('datetime-screen')">‚Äπ</button>
                        <div class="app-title">Êó•Êúü‰∏éÊó∂Èó¥</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>Ëá™Âä®ËÆæÁΩÆ</div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" checked>
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Êï∞ÊçÆÁÆ°ÁêÜ -->
                <div id="data-management-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('data-management-screen')">‚Äπ</button>
                        <div class="app-title">Êï∞ÊçÆÁÆ°ÁêÜ</div>
                    </div>
                    <div class="app-content">
                        <!-- Â≠òÂÇ®Á©∫Èó¥‰ΩøÁî®ÊÉÖÂÜµ -->
                        <div class="data-section">
                            <div class="data-section-title">Â≠òÂÇ®Á©∫Èó¥‰ΩøÁî®ÊÉÖÂÜµ</div>
                            <div class="storage-usage" id="storage-usage">
                                <div class="storage-item">
                                    <div class="storage-label">ËÅäÂ§©ËÆ∞ÂΩï</div>
                                    <div class="storage-size" id="chat-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">ËßíËâ≤Êï∞ÊçÆ</div>
                                    <div class="storage-size" id="character-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">ËÅäÂ§©ËÆæÁΩÆ</div>
                                    <div class="storage-size" id="settings-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">Ë°®ÊÉÖÂåÖ</div>
                                    <div class="storage-size" id="emoji-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                                <div class="storage-total">
                                    <div class="storage-label">ÊÄªËÆ°</div>
                                    <div class="storage-size" id="total-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Êï∞ÊçÆÂØºÂÖ•ÂØºÂá∫ -->
                        <div class="data-section">
                            <div class="data-section-title">Êï∞ÊçÆÂ§á‰ªΩ‰∏éÊÅ¢Â§ç</div>
                            <div class="settings-item" onclick="exportAllData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon export">
                                        <i class="fas fa-download"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ</div>
                                        <div class="setting-desc">Â∞ÜÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂíåËÆæÁΩÆÂØºÂá∫‰∏∫JSONÊñá‰ª∂</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="importDataFromFile()">
                                <div class="settings-item-left">
                                    <div class="settings-icon import">
                                        <i class="fas fa-upload"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ÂØºÂÖ•Êï∞ÊçÆ</div>
                                        <div class="setting-desc">‰ªéJSONÊñá‰ª∂ÊÅ¢Â§çËÅäÂ§©ËÆ∞ÂΩïÂíåËÆæÁΩÆ</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- ÈÄâÊã©ÊÄßÊ∏ÖÁêÜ -->
                        <div class="data-section">
                            <div class="data-section-title">Â≠òÂÇ®Ê∏ÖÁêÜ</div>
                            <div class="settings-item" onclick="cleanupOrphanedContacts()">
                                <div class="settings-item-left">
                                    <div class="settings-icon cleanup">
                                        <i class="fas fa-user-slash"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">Ê∏ÖÁêÜÂ≠§Á´ãËÅîÁ≥ª‰∫∫</div>
                                        <div class="setting-desc">Ê∏ÖÁêÜ‰∏çÂ≠òÂú®ÁöÑËßíËâ≤ËÅîÁ≥ª‰∫∫ÂíåÁõ∏ÂÖ≥Êï∞ÊçÆ</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="showCleanupOptions()">
                                <div class="settings-item-left">
                                    <div class="settings-icon cleanup">
                                        <i class="fas fa-broom"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ÈÄâÊã©ÊÄßÊ∏ÖÁêÜ</div>
                                        <div class="setting-desc">Ê∏ÖÁêÜÁâπÂÆöÁ±ªÂûãÁöÑÊï∞ÊçÆ‰ª•ÈáäÊîæÁ©∫Èó¥</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="compressAllImages()">
                                <div class="settings-item-left">
                                    <div class="settings-icon compress">
                                        <i class="fas fa-compress-arrows-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ÂéãÁº©ÂõæÁâá</div>
                                        <div class="setting-desc">ÂéãÁº©ÊâÄÊúâÂ§¥ÂÉèÂíåËÉåÊôØÂõæÁâá‰ª•ËäÇÁúÅÁ©∫Èó¥</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- Âç±Èô©Êìç‰Ωú -->
                        <div class="data-section danger-section">
                            <div class="data-section-title">Âç±Èô©Êìç‰Ωú</div>
                            <div class="settings-item danger-item" onclick="clearAllData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ</div>
                                        <div class="setting-desc">Âà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï„ÄÅËßíËâ≤ÂíåËÆæÁΩÆÔºà‰∏çÂèØÊÅ¢Â§çÔºâ</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂÖ≥‰∫éÊàë‰ª¨ -->
                <div id="about-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('about-screen')">‚Äπ</button>
                        <div class="app-title">ÂÖ≥‰∫éÊàë‰ª¨</div>
                    </div>
                    <div class="app-content">
                        <div class="about-content">
                            <div class="about-title">iPhone Ê®°ÊãüÂô®</div>
                            <div class="about-version">ÁâàÊú¨ 1.0.0</div>
                            <div class="about-author">‰ΩúËÄÖ@EVE</div>
                        </div>
                    </div>
                </div>
                
                <!-- Â≠óÂè∑Â§ßÂ∞èËÆæÁΩÆ -->
                <div id="display-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('display-screen')">‚Äπ</button>
                        <div class="app-title">Â≠óÂè∑Â§ßÂ∞è</div>
                    </div>
                    <div class="app-content">
                        <div class="font-size-preview">
                            <div class="font-size-preview-text" id="font-size-preview">
                                ËøôÊòØ‰∏ÄÊÆµÁ§∫‰æãÊñáÂ≠óÔºåÁî®‰∫éÈ¢ÑËßàÂ≠ó‰ΩìÂ§ßÂ∞èÊïàÊûú„ÄÇË∞ÉËäÇ‰∏ãÊñπÊªëÂùóÂèØ‰ª•ÊîπÂèòÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÇ
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">Â≠óÂè∑Â§ßÂ∞è</div>
                                    <div class="setting-desc">Ë∞ÉËäÇËÅäÂ§©Ê∂àÊÅØÂíåÁ§æ‰∫§Âä®ÊÄÅÁöÑÂ≠ó‰ΩìÂ§ßÂ∞è</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="font-size-slider-container">
                            <div class="font-size-labels">
                                <span>Â∞è</span>
                                <span>Ê†áÂáÜ</span>
                                <span>Â§ß</span>
                            </div>
                            <input type="range" class="font-size-slider" id="font-size-slider" 
                                   min="12" max="20" step="1" value="15" 
                                   onchange="changeFontSize(this.value)">
                            <div class="font-size-value">
                                ÂΩìÂâçÂ≠óÂè∑Ôºö<span id="font-size-value">15px</span>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">Â≠óË∑ùËÆæÁΩÆ</div>
                                    <div class="setting-desc">Ë∞ÉËäÇÊñáÂ≠ó‰πãÈó¥ÁöÑÈó¥Ë∑ù</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="font-size-slider-container">
                            <div class="font-size-labels">
                                <span>Á¥ßÂáë</span>
                                <span>Ê†áÂáÜ</span>
                                <span>ÂÆΩÊùæ</span>
                            </div>
                            <input type="range" class="font-size-slider" id="letter-spacing-slider" 
                                   min="-0.5" max="2" step="0.1" value="0" 
                                   onchange="changeLetterSpacing(this.value)">
                            <div class="font-size-value">
                                ÂΩìÂâçÂ≠óË∑ùÔºö<span id="letter-spacing-value">Ê†áÂáÜ</span>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">Ëá™Âä®Áº©Êîæ</div>
                                    <div class="setting-desc">Ê†πÊçÆÂ±èÂπïÂ∞∫ÂØ∏Ëá™Âä®Ë∞ÉÊï¥Â≠ó‰ΩìÂ§ßÂ∞è</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="auto-scale-toggle" onchange="toggleAutoScale()">
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Â±èÂπïÂ∞∫ÂØ∏ËÆæÁΩÆ -->
                <div id="screen-size-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('screen-size-screen')">‚Äπ</button>
                        <div class="app-title">Â±èÂπïÂ∞∫ÂØ∏</div>
                    </div>
                    <div class="app-content">
                        <div class="size-option" onclick="changeScreenSize(320, 568, 'iPhone SE')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone SE</div>
                                <div class="size-desc">320√ó568 (Â∞èÂ±èÊ®°Âºè)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-xs"></div>
                            </div>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(350, 740, 'ÈÄÇ‰∏≠Â∞∫ÂØ∏')" id="size-350-740">
                            <div class="size-option-left">
                                <div class="size-name">ÈÄÇ‰∏≠Â∞∫ÂØ∏</div>
                                <div class="size-desc">350√ó740 (Êé®Ëçê)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-s"></div>
                            </div>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(375, 812, 'iPhone 12/13')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 12/13</div>
                                <div class="size-desc">375√ó812 (Ê†áÂáÜ)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-m"></div>
                            </div>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(390, 844, 'iPhone 15')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15</div>
                                <div class="size-desc">390√ó844 (ÁúüÂÆûÂ∞∫ÂØ∏)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-l"></div>
                            </div>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(428, 926, 'iPhone 15 Plus')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15 Plus</div>
                                <div class="size-desc">428√ó926 (Â§ßÂ±è)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-xl"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Â§ñËßÇËÆæÁΩÆ -->
                <div id="appearance-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('appearance-screen')">‚Äπ</button>
                        <div class="app-title">Â§ñËßÇËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">ÊòæÁ§∫ÊâãÊú∫ËæπÊ°Ü</div>
                                    <div class="setting-desc">ÊòæÁ§∫ÂúÜËßíËæπÊ°ÜÂíåÈò¥ÂΩ±ÊïàÊûú</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="phone-border-toggle" checked onchange="togglePhoneBorder()">
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item" onclick="showScreenSizeOptions()">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">Â±èÂπïÂ∞∫ÂØ∏</div>
                                    <div class="setting-desc" id="current-screen-size">ÂΩìÂâçÔºö350√ó740 (ÈÄÇ‰∏≠Â∞∫ÂØ∏)</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏ªÈ¢òËÆæÁΩÆÁïåÈù¢ -->
                <div id="theme-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('theme-screen')">‚Äπ</button>
                        <div class="app-title">‰∏ªÈ¢òËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="theme-option" onclick="changeTheme('default')">
                            <div class="theme-preview theme-preview-simple">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">ÁÆÄÁ∫¶È£éÊ†º</div>
                                <div class="theme-description">Ê∏ÖÊñ∞ÁÆÄÊ¥ÅÁöÑÈªòËÆ§‰∏ªÈ¢ò</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('cute')">
                            <div class="theme-preview theme-preview-cute">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">ÂèØÁà±È£éÊ†º</div>
                                <div class="theme-description">Ê∏©È¶®ÂèØÁà±ÁöÑÁ≤âËâ≤‰∏ªÈ¢ò</div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                
                <!-- Â£ÅÁ∫∏ËÆæÁΩÆ -->
                <div id="wallpaper-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('wallpaper-screen')">‚Äπ</button>
                        <div class="app-title">Â£ÅÁ∫∏</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showWallpaperPicker()">
                            <div class="settings-item-left">
                                <div>ÈÄâÊã©Êñ∞Â£ÅÁ∫∏</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showIconPicker()">
                            <div class="settings-item-left">
                                <div>Êõ¥ÊîπÂ∫îÁî®ÂõæÊ†á</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Êó†Á∫øÂ±ÄÂüüÁΩëËÆæÁΩÆ -->
                <div id="wifi-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('wifi-screen')">‚Äπ</button>
                        <div class="app-title">Êó†Á∫øÂ±ÄÂüüÁΩë</div>
                    </div>
                    <div class="app-content">
                        <div class="wifi-settings">
                            <div class="settings-item">
                                <div class="settings-item-left">
                                    <div>Êó†Á∫øÂ±ÄÂüüÁΩë</div>
                                </div>
                                <label class="settings-toggle">
                                    <input type="checkbox" checked>
                                    <span class="settings-slider"></span>
                                </label>
                            </div>
                            
                            <div class="wifi-network">
                                <div class="wifi-network-left">
                                    <div class="wifi-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div>
                                        <div>HomeWiFi</div>
                                        <div class="wifi-strength">
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                        </div>
                                    </div>
                                </div>
                                <i class="fas fa-check check-icon"></i>
                            </div>
                            
                            <div class="settings-item settings-item-margin" onclick="showApp('api-settings-screen')">
                                <div class="settings-item-left">
                                    <div>APIËÆæÁΩÆ</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- APIËÆæÁΩÆÁïåÈù¢ -->
                <div id="api-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('api-settings-screen')">‚Äπ</button>
                        <div class="app-title">APIËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="form-container" style="color: #000000;">
                            

                            
                            <!-- Âø´ÈÄüËÆæÁΩÆÂç°Áâá -->
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label style="color: #333; margin-bottom: 15px; display: block; font-size: 16px; font-weight: 600;">üöÄ Âø´ÈÄüËÆæÁΩÆ</label>
                                
                                <!-- GeminiÁõ¥ËøûÂç°Áâá -->
                                <div style="margin-bottom: 12px; padding: 18px; background: linear-gradient(135deg, rgba(74, 132, 193, 0.1) 0%, rgba(74, 132, 193, 0.05) 100%); border: 2px solid rgba(74, 132, 193, 0.2); border-radius: 16px; color: #333; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);" onclick="setGeminiDirect()">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--theme-button-bg, #4a84c1);">üåü Gemini Áõ¥Ëøû</div>
                                            <div style="font-size: 13px; color: #666;">Ëá™Âä®ÈÖçÁΩÆGoogleÂÆòÊñπAPIÔºåÊîØÊåÅÊúÄÊñ∞Ê®°Âûã</div>
                                        </div>
                                        <div style="background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(74, 132, 193, 0.3);">ÁÇπÂáªÈÖçÁΩÆ</div>
                                    </div>
                            </div>
                            
                                <!-- HuggingFaceÂèç‰ª£Âç°Áâá -->
                                <div style="margin-bottom: 15px; padding: 18px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%); border: 2px solid rgba(255, 193, 7, 0.2); border-radius: 16px; color: #333; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);" onclick="setHuggingFaceProxy()">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: #f39c12;">ü§ó HuggingFace Âèç‰ª£</div>
                                            <div style="font-size: 13px; color: #666;">ÂÖçË¥π‰ΩøÁî®Â§öÁßçÂ§ßÊ®°ÂûãÔºåÊîØÊåÅClaudeÁ≠â</div>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);">ÁÇπÂáªÈÖçÁΩÆ</div>
                                    </div>
                            </div>
                            
                                <div style="font-size: 12px; color: #666; text-align: center; margin-top: 10px;">
                                    ‚ö†Ô∏è ‰ΩøÁî®ÂâçËØ∑Á°Æ‰øùÊúâÂØπÂ∫îÁöÑAPIÂØÜÈí•
                                </div>
                            </div>
                            
                            <!-- APIÈÖçÁΩÆË°®Âçï - ÁæéÂåñÁâà -->
                            <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);">
                                
                                <!-- APIÂú∞ÂùÄ -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">APIÂú∞ÂùÄ</label>
                                    <input type="text" id="api-base" placeholder="‰æãÂ¶Ç: https://api.openai.com Êàñ @https://xxx-xxx.hf.space/v1" style="width: 100%; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); box-sizing: border-box;">
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">ÊîØÊåÅÊ†áÂáÜAPIÂíåHuggingFaceÂèç‰ª£ÔºàÊ†ºÂºèÔºö@https://xxx.hf.space/v1Ôºâ</div>
                            </div>
                            
                                <!-- APIÂØÜÈí• -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">APIÂØÜÈí•</label>
                                    <input type="password" id="api-key" placeholder="sk-... Êàñ Google AI Studio API Key" style="width: 100%; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); box-sizing: border-box;">
                                </div>
                                
                                <!-- Ê®°ÂûãÈÄâÊã© -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">Ê®°Âûã</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <select id="model-select" style="flex: 1; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333);">
                                            <!-- Ê®°ÂûãÈÄâÈ°πÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÂ°´ÂÖÖ -->
                                    </select>
                                        <button id="fetch-models-btn" onclick="fetchModels()" style="padding: 10px 16px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; backdrop-filter: blur(10px); transition: all 0.3s ease; white-space: nowrap;">ÊãâÂèñÊ®°Âûã</button>
                                </div>
                            </div>
                            
                                <!-- Ê∏©Â∫¶ÂèÇÊï∞ -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">Ê∏©Â∫¶ÂèÇÊï∞ (<span id="temperature-value" style="color: var(--theme-button-bg, #4a84c1); font-weight: 700;">0.75</span>)</label>
                                    <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 12px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));">
                                        <input type="range" id="temperature-slider" min="0" max="2" step="0.05" value="0.75" oninput="document.getElementById('temperature-value').textContent = parseFloat(this.value).toFixed(2);" style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, rgba(74, 132, 193, 0.2) 0%, rgba(74, 132, 193, 0.4) 100%); outline: none; -webkit-appearance: none; appearance: none;">
                                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #666;">
                                            <span>0.00 (‰øùÂÆà)</span>
                                            <span>1.00 (Âπ≥Ë°°)</span>
                                            <span>2.00 (ÂàõÊñ∞)</span>
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">Ê∏©Â∫¶Ë∂ä‰ΩéÔºåÂõûÁ≠îË∂ä‰øùÂÆàÁ®≥ÂÆöÔºõÊ∏©Â∫¶Ë∂äÈ´òÔºåÂõûÁ≠îË∂äÊúâÂàõÊÑèÂ§öÊ†∑</div>
                                    </div>
                            </div>
                            
                                <!-- Êìç‰ΩúÊåâÈíÆ -->
                                <div style="display: flex; gap: 12px; margin-top: 25px;">
                                    <button id="test-api-connection-btn" onclick="testApiConnection()" style="flex: 1; padding: 14px 20px; background: linear-gradient(135deg, #34c759 0%, #30d158 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3); transition: all 0.3s ease;">ÊµãËØïËøûÊé•</button>
                                    <button id="save-api-settings-btn" onclick="saveApiSettings()" style="flex: 1; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">‰øùÂ≠òËÆæÁΩÆ</button>
                                </div>
                            </div>

                            <!-- APIÈÖçÁΩÆÁÆ°ÁêÜ -->
                            <hr style="margin: 30px 0; border: none; border-top: 1px solid #eaeaea;">
                            <div class="api-config-manager" style="background: rgba(248, 249, 250, 0.8); border-radius: 16px; padding: 20px; margin: 15px 0; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>üíæ</span> APIÈÖçÁΩÆÁÆ°ÁêÜ
                                </h4>
                                <p style="font-size: 13px; color: #666; margin: 0 0 15px 0; line-height: 1.5;">‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ‰∏∫È¢ÑËÆæÔºåÊñπ‰æøÂø´ÈÄüÂàáÊç¢‰∏çÂêåÁöÑAPIÊúçÂä°</p>
                                
                                <div class="save-config-section" style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.6); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                                        <input type="text" id="config-name-input" placeholder="ËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞ (Â¶Ç: OpenAI„ÄÅGemini„ÄÅClaudeÁ≠â)" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.9);">
                                        <button id="save-current-config-btn" onclick="saveCurrentConfig()" style="padding: 10px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">üíæ ‰øùÂ≠òÈÖçÁΩÆ</button>
                        </div>
                                    <div style="font-size: 12px; color: #888;">ÂΩìÂâçÈÖçÁΩÆÂ∞Ü‰øùÂ≠ò‰∏∫: <span style="color: #333; font-weight: 500;">URL + Ê®°Âûã + Ê∏©Â∫¶ËÆæÁΩÆ</span></div>
                                </div>
                                
                                <div class="saved-configs-section">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                        <label style="font-size: 14px; font-weight: 500; color: #333;">Â∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ</label>
                                        <button id="clear-all-configs-btn" onclick="clearAllConfigs()" style="padding: 6px 12px; background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;">üóëÔ∏è Ê∏ÖÁ©∫ÂÖ®ÈÉ®</button>
                                    </div>
                                    <div id="saved-configs-container" style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                                        <!-- ‰øùÂ≠òÁöÑÈÖçÁΩÆÂç°ÁâáÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                                    </div>
                                    <div id="no-configs-message" style="text-align: center; color: #999; padding: 30px 20px; font-size: 14px; display: none;">
                                        <div style="font-size: 24px; margin-bottom: 8px;">üìù</div>
                                        <div>ËøòÊ≤°Êúâ‰øùÂ≠ò‰ªª‰ΩïÈÖçÁΩÆ</div>
                                        <div style="font-size: 12px; margin-top: 4px;">Âú®‰∏äÊñπËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞Âπ∂ÁÇπÂáª"‰øùÂ≠òÈÖçÁΩÆ"</div>
                                    </div>
                                </div>
                            </div>



                        </div>
                    </div>
                </div>
                
                <!-- È¢úËâ≤ÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="color-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title" id="color-picker-title">ÈÄâÊã©È¢úËâ≤</div>
                            <button class="modal-close" onclick="hideModal('color-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="color-picker" id="color-picker">
                                <div class="color-option color-red" onclick="selectColor('#FF3B30')"></div>
                                <div class="color-option color-orange" onclick="selectColor('#FF9500')"></div>
                                <div class="color-option color-yellow" onclick="selectColor('#FFCC00')"></div>
                                <div class="color-option color-green" onclick="selectColor('#34C759')"></div>
                                <div class="color-option color-light-blue" onclick="selectColor('#5AC8FA')"></div>
                                <div class="color-option color-blue" onclick="selectColor('#007AFF')"></div>
                                <div class="color-option color-purple" onclick="selectColor('#5856D6')"></div>
                                <div class="color-option color-pink" onclick="selectColor('#AF52DE')"></div>
                                <div class="color-option color-red-alt" onclick="selectColor('#FF2D55')"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÈÄèÊòéÂ∫¶</label>
                                <input type="range" class="opacity-slider" id="opacity-slider" min="0" max="1" step="0.1" value="1">
                                <span id="opacity-value">100%</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('color-picker-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="applyColorSelection()">Â∫îÁî®</button>
                        </div>
                    </div>
                </div>
                
                <!-- Â£ÅÁ∫∏ÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="wallpaper-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©Â£ÅÁ∫∏</div>
                            <button class="modal-close" onclick="hideModal('wallpaper-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="wallpaper-preview-container" id="wallpaper-preview-container">
                                <div class="wallpaper-preview-placeholder">
                                    <i class="fas fa-image"></i>
                                    <div>ÈÄâÊã©Êú¨Âú∞ÂõæÁâáÂêéÂèØÂú®Ê≠§È¢ÑËßà</div>
                                </div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomWallpaper()">
                                <div class="settings-item-left">
                                    <div>‰ªéÁõ∏ÂÜåÈÄâÊã©</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-wallpaper-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('wallpaper-picker-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="applyWallpaperSelection()">Â∫îÁî®</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂõæÊ†áÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="icon-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©Â∫îÁî®ÂõæÊ†á</div>
                            <button class="modal-close" onclick="hideModal('icon-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="icon-options">
                                <div class="icon-option" onclick="selectAppIcon('chat-screen', 'fas fa-comment-dots')">
                                    <div class="icon-preview">
                                        <i class="fas fa-comment-dots"></i>
                                    </div>
                                    <span>Chat</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('weibo-screen', 'fab fa-weibo')">
                                    <div class="icon-preview">
                                        <i class="fab fa-weibo"></i>
                                    </div>
                                    <span>Á§æ‰∫§ÁΩëÁªú</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('music-screen', 'fas fa-music')">
                                    <div class="icon-preview">
                                        <i class="fas fa-music"></i>
                                    </div>
                                    <span>Èü≥‰πê</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('album-screen', 'fas fa-images')">
                                    <div class="icon-preview">
                                        <i class="fas fa-images"></i>
                                    </div>
                                    <span>Áõ∏ÂÜå</span>
                                </div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomIcon()">
                                <div class="settings-item-left">
                                    <div>‰ªéÁõ∏ÂÜåÈÄâÊã©</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-icon-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('icon-picker-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="applyIconSelection()">Â∫îÁî®</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÁÖßÁâáÊãçÊëÑÊ®°ÊÄÅÊ°Ü -->

                

                
                <!-- Ê∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="add-contact-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Ê∑ªÂä†ËÅîÁ≥ª‰∫∫</div>
                            <button class="modal-close" onclick="hideModal('add-contact-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="contact-modal-body">
                            <!-- ËÅîÁ≥ª‰∫∫ÈÄâÈ°πÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('add-contact-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="addSelectedContacts()">Ê∑ªÂä†</button>
                        </div>
                    </div>
                </div>
                
                <!-- ËÅäÂ§©ÈÄâÈ°πÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="chat-options-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©ËÅäÂ§©Á±ªÂûã</div>
                            <button class="modal-close" onclick="hideModal('chat-options-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="chat-option-item" onclick="showSingleChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-user icon-user-blue"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">ÂçïËÅä</div>
                                    <div class="chat-option-desc">‰∏éÂçï‰∏™ËßíËâ≤ËøõË°åÂØπËØù</div>
                                </div>
                            </div>
                            <div class="chat-option-item" onclick="showGroupChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-users icon-users-green"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">Áæ§ËÅä</div>
                                    <div class="chat-option-desc">‰∏éÂ§ö‰∏™ËßíËâ≤ÂêåÊó∂ËÅäÂ§©</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÂçïËÅäËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="single-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©ËÅäÂ§©ËßíËâ≤</div>
                            <button class="modal-close" onclick="hideModal('single-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="single-chat-body">
                            <!-- ËßíËâ≤ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                
                <!-- Áæ§ËÅäËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="group-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂàõÂª∫Áæ§ËÅä</div>
                            <button class="modal-close" onclick="hideModal('group-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Áæ§ËÅäÂêçÁß∞</label>
                                <input type="text" class="form-input" id="group-chat-name" placeholder="‰æãÂ¶ÇÔºöÂä®ÊÄÅÂàÜ‰∫´„ÄÅÂ∑•‰ΩúÁæ§">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÈÄâÊã©ÊàêÂëò (Ëá≥Â∞ë2‰∫∫ÔºåÊúÄÂ§ö8‰∫∫)</label>
                                <div id="group-chat-members">
                                    <!-- Áæ§ËÅäÊàêÂëòÈÄâÊã©Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('group-chat-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="createGroupChat()">ÂàõÂª∫Áæ§ËÅä</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="history-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('history-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-card">
                                <div class="setting-item">
                                    <div class="setting-left">
                                        <div class="setting-label">ÈôÑÂ∏¶ÂéÜÂè≤Ê∂àÊÅØÊï∞ (ÂõûÂêàÊï∞)</div>
                                        <div class="setting-desc">AIÂõûÂ§çÊó∂ÂèÇËÄÉÁöÑÂéÜÂè≤ÂØπËØùÂõûÂêàÊï∞</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="history-count-display">5ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="setting-range-container">
                                    <input type="range" class="theme-range" id="history-messages-count" min="0" max="100" step="1" value="5">
                                    <div class="range-labels">
                                        <span>0ÂõûÂêà</span>
                                        <span>100ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="custom-input-container">
                                    <span class="input-label">Ëá™ÂÆö‰πâÊï∞ÂÄºÔºö</span>
                                    <input type="number" class="theme-input" id="custom-history-count" min="0" max="500" value="5">
                                    <span class="input-unit">ÂõûÂêà (ÊúÄÂ§ß500)</span>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>ËØ¥ÊòéÔºö</strong><br>
                                        ‚Ä¢ ‰∏ÄÂõûÂêà = ‰Ω†ÁöÑ‰∏ÄÊù°Ê∂àÊÅØ + AIÁöÑ‰∏ÄÊù°ÂõûÂ§ç<br>
                                        ‚Ä¢ ËÆæÁΩÆ‰∏∫5Ë°®Á§∫AIÂõûÂ§çÊó∂‰ºöÂèÇËÄÉÊúÄËøë5ËΩÆÂØπËØù<br>
                                        ‚Ä¢ Ê≥®ÊÑèÔºöÊï∞ÂÄºËøáÂ§ßÂèØËÉΩÂΩ±ÂìçAPIÂìçÂ∫îÈÄüÂ∫¶
                                    </div>
                                </div>
                            </div>
                            
                            <div class="setting-card">
                                <div class="setting-item">
                                    <div class="setting-left">
                                        <div class="setting-label">Ë∑®Á™óÂè£ËÆ∞ÂøÜÂõûÂêàÊï∞</div>
                                        <div class="setting-desc">‰ªéÂÖ∂‰ªñËÅäÂ§©Á™óÂè£ËØªÂèñÁöÑËÉåÊôØËÆ∞ÂøÜÂõûÂêàÊï∞</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="cross-memory-display">3ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="setting-range-container">
                                    <input type="range" class="theme-range" id="cross-chat-memory" min="0" max="20" step="1" value="3">
                                    <div class="range-labels">
                                        <span>0ÂõûÂêà</span>
                                        <span>20ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>ËØ¥ÊòéÔºö</strong><br>
                                        ‚Ä¢ AI‰ºöËØªÂèñÂÖ∂‰ªñËÅäÂ§©Á™óÂè£‰∏≠ÊúÄÊñ∞ÁöÑÂá†ËΩÆÂØπËØù‰Ωú‰∏∫ËÉåÊôØËÆ∞ÂøÜ<br>
                                        ‚Ä¢ ‰∏ÄÂõûÂêà = Áî®Êà∑‰∏ÄÊù°Ê∂àÊÅØ + AI‰∏ÄÊù°ÂõûÂ§ç<br>
                                        ‚Ä¢ Â∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÁêÜËß£Êï¥‰ΩìÂØπËØù‰∏ä‰∏ãÊñá
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="theme-button theme-button-secondary" onclick="hideModal('history-settings-modal')">ÂèñÊ∂à</button>
                            <button class="theme-button theme-button-primary" onclick="saveHistorySettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="memory-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('memory-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="memory-mount-enabled" class="checkbox-with-margin">
                                    ÂêØÁî®ËÆ∞ÂøÜÊåÇËΩΩ
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåAI‰ºöÂèÇËÄÉÂÖ∂‰ªñËÅäÂ§©Á™óÂè£ÁöÑÂØπËØùÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØËÆ∞ÂøÜ
                                </p>
                            </div>
                            <div class="form-group hide" id="memory-mount-details">
                                <label class="form-label">ÊØè‰∏™ËÅäÂ§©ÊåÇËΩΩÊù°Êï∞</label>
                                <input type="range" class="api-form-range" id="memory-mount-count" min="1" max="20" step="1" value="3">
                                <div class="flex-space-between">
                                    <span>1Êù°</span>
                                    <span id="memory-mount-display">3Êù°</span>
                                    <span>20Êù°</span>
                                </div>
                            </div>
                            <div class="form-group hide" id="memory-mount-chats">
                                <label class="form-label">ÈÄâÊã©Ë¶ÅÊåÇËΩΩÁöÑËÅäÂ§©</label>
                                <div id="memory-mount-list" class="max-height-200-auto">
                                    <!-- ËÅäÂ§©ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                                <p class="small-text margin-top-8">
                                    ÈÄâÊã©ÁöÑËÅäÂ§©ËÆ∞ÂΩï‰ºö‰Ωú‰∏∫ËÉåÊôØ‰ø°ÊÅØÊèê‰æõÁªôAIÂèÇËÄÉ
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('memory-mount-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveMemoryMountSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Â§¥ÂÉèËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="avatar-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂèåÊñπÂ§¥ÂÉèËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('avatar-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="avatar-setting-group">
                                <label class="form-label">ÊàëÁöÑÂ§¥ÂÉè (‰ªÖÂú®Ê≠§ËÅäÂ§©Á™óÂè£ÁîüÊïà)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="my-chat-avatar-preview">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <input type="file" id="my-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('my-chat-avatar-upload').click()">‰∏ä‰º†Â§¥ÂÉè</button>
                                </div>
                            </div>
                            <div class="avatar-setting-group">
                                <label class="form-label">ÂØπÊñπÂ§¥ÂÉè (‰ªÖÂú®Ê≠§ËÅäÂ§©Á™óÂè£ÁîüÊïà)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="ai-chat-avatar-preview">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <input type="file" id="ai-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('ai-chat-avatar-upload').click()">‰∏ä‰º†Â§¥ÂÉè</button>
                                    <button class="upload-button clear-avatar-btn" onclick="clearAiDynamicAvatar()">Ê∏ÖÈô§Âä®ÊÄÅÂ§¥ÂÉè</button>
                                </div>
                                <p class="small-text margin-top-5">
                                    Ê≥®ÊÑèÔºöÂ¶ÇÊûúËßíËâ≤Âú®ËÅäÂ§©‰∏≠Êõ¥Êç¢‰∫ÜÂ§¥ÂÉèÔºåÂä®ÊÄÅÂ§¥ÂÉè‰ºöË¶ÜÁõñÊ≠§ËÆæÁΩÆÔºåÁÇπÂáª"Ê∏ÖÈô§Âä®ÊÄÅÂ§¥ÂÉè"ÂèØÈáçÁΩÆ
                                </p>
                            </div>
                            <div class="form-group margin-top-20">
                                <label class="form-label">
                                    <input type="checkbox" id="hide-avatars" class="checkbox-with-margin">
                                    ÈöêËóèÂèåÊñπÂ§¥ÂÉè
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåËÅäÂ§©ÁïåÈù¢Â∞Ü‰∏çÊòæÁ§∫‰ªª‰ΩïÂ§¥ÂÉè
                                </p>
                            </div>
                            <p class="small-text margin-top-15">
                                Ê≥®ÊÑèÔºöÊ≠§ËÆæÁΩÆ‰ªÖÂΩ±ÂìçÂΩìÂâçËÅäÂ§©Á™óÂè£ÊòæÁ§∫Ôºå‰∏ç‰ºöÂêåÊ≠•‰øÆÊîπËßíËâ≤Âç°ÊàñÈù¢ÂÖ∑ËÆæÁΩÆ
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('avatar-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatAvatarSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÊòµÁß∞ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="nickname-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂèåÊñπÂ§áÊ≥®ËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('nickname-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÊòµÁß∞ (‰ªÖÂú®Ê≠§ËÅäÂ§©‰∏≠ÊòæÁ§∫)</label>
                                <input type="text" class="form-input" id="my-chat-nickname" placeholder="ËæìÂÖ•‰Ω†Âú®Ê≠§ËÅäÂ§©‰∏≠ÁöÑÊòµÁß∞">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂØπÊñπÊòµÁß∞ (‰ªÖÂú®Ê≠§ËÅäÂ§©‰∏≠ÊòæÁ§∫)</label>
                                <input type="text" class="form-input" id="ai-chat-nickname" placeholder="ËæìÂÖ•ÂØπÊñπÂú®Ê≠§ËÅäÂ§©‰∏≠ÁöÑÊòµÁß∞">
                            </div>
                            <p class="small-text margin-top-10">
                                Ê≥®ÊÑèÔºöÊ≠§ËÆæÁΩÆ‰ªÖÂΩ±ÂìçÂΩìÂâçËÅäÂ§©Á™óÂè£ÊòæÁ§∫Ôºå‰∏ç‰ºöÂêåÊ≠•‰øÆÊîπËßíËâ≤Âç°ÊàñÈù¢ÂÖ∑ËÆæÁΩÆ„ÄÇËßíËâ≤‰πüÂèØËÉΩÊ†πÊçÆÂøÉÊÉÖÂíåËÅäÂ§©ÂÜÖÂÆπËá™‰∏ª‰øÆÊîπËá™Â∑±ÁöÑÊòµÁß∞„ÄÇ
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('nickname-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatNicknameSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="poke-suffix-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('poke-suffix-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÊà≥‰∏ÄÊà≥ÂêéÁºÄ</label>
                                <input type="text" class="form-input" id="my-poke-suffix" placeholder="ÁïôÁ©∫‰∏∫Êó†ÂêéÁºÄÔºà‰æãÂ¶ÇÔºöÁöÑÂ∞èËÑ∏ËõãÔºâ">
                                <p class="tiny-text margin-top-5">ÊòæÁ§∫‰∏∫Ôºö‰Ω†Êà≥‰∫ÜÊà≥[ËßíËâ≤Âêç][ÂêéÁºÄ]ÔºåÁïôÁ©∫ÂàôÊòæÁ§∫Ôºö‰Ω†Êà≥‰∫ÜÊà≥[ËßíËâ≤Âêç]</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂØπÊñπÊà≥‰∏ÄÊà≥ÂêéÁºÄ</label>
                                <input type="text" class="form-input" id="ai-poke-suffix" placeholder="ÁïôÁ©∫‰∏∫Êó†ÂêéÁºÄÔºà‰æãÂ¶ÇÔºöÁöÑÂ∞èÊâãÔºâ">
                                <p class="tiny-text margin-top-5">ÊòæÁ§∫‰∏∫Ôºö[ËßíËâ≤Âêç]Êà≥‰∫ÜÊà≥‰Ω†[ÂêéÁºÄ]ÔºåÁïôÁ©∫ÂàôÊòæÁ§∫Ôºö[ËßíËâ≤Âêç]Êà≥‰∫ÜÊà≥‰Ω†„ÄÇËßíËâ≤ÂèØËÉΩÊ†πÊçÆÂøÉÊÉÖËá™‰∏ª‰øÆÊîπÊ≠§ÂêéÁºÄ„ÄÇ</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('poke-suffix-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="savePokeSuffixSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ËÅäÂ§©ËÉåÊôØËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="background-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ËÅäÂ§©ËÉåÊôØËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('background-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="background-preview-container">
                                <div class="background-preview" id="chat-background-preview">
                                    <div class="preview-text">ËÉåÊôØÈ¢ÑËßà</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="file" id="background-upload" accept="image/*" class="file-input-hidden">
                                <button class="form-button" onclick="document.getElementById('background-upload').click()">ÈÄâÊã©ËÉåÊôØÂõæÁâá</button>
                                <button class="form-button form-button-secondary" onclick="removeBackground()">ÁßªÈô§ËÉåÊôØ</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('background-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatBackgroundSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="bubble-style-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('bubble-style-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="bubble-style-section">
                                <label class="form-label">ÈÄâÊã©Ê∞îÊ≥°Ê†∑Âºè</label>
                                <div class="bubble-style-grid">
                                    <div class="bubble-style-option" data-style="default">
                                        <div class="style-preview">
                                            <div class="preview-bubble sent-preview">ÈªòËÆ§Ê†∑Âºè</div>
                                            <div class="preview-bubble received-preview">ÁªèÂÖ∏ÂúÜËßí</div>
                                        </div>
                                        <div class="style-name">ÈªòËÆ§Ê†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="glass">
                                        <div class="style-preview bubble-style-glass">
                                            <div class="preview-bubble sent-preview">ÊØõÁéªÁíÉ</div>
                                            <div class="preview-bubble received-preview">ÂçäÈÄèÊòé</div>
                                        </div>
                                        <div class="style-name">ÊØõÁéªÁíÉ</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="shadow">
                                        <div class="style-preview bubble-style-shadow">
                                            <div class="preview-bubble sent-preview">ÁªèÂÖ∏Èò¥ÂΩ±</div>
                                            <div class="preview-bubble received-preview">Á´ã‰ΩìÊÑü</div>
                                        </div>
                                        <div class="style-name">ÁªèÂÖ∏Èò¥ÂΩ±</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="tail">
                                        <div class="style-preview bubble-style-tail">
                                            <div class="preview-bubble sent-preview">Â∏¶Â∞ñËßí</div>
                                            <div class="preview-bubble received-preview">Ê∞îÊ≥°Êà≥</div>
                                        </div>
                                        <div class="style-name">ÁªèÂÖ∏Ê∞îÊ≥°</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="gradient">
                                        <div class="style-preview bubble-style-gradient">
                                            <div class="preview-bubble sent-preview">Ê∏êÂèòËâ≤</div>
                                            <div class="preview-bubble received-preview">ÁæéËßÇ</div>
                                        </div>
                                        <div class="style-name">Ê∏êÂèòÊ†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="minimal">
                                        <div class="style-preview bubble-style-minimal">
                                            <div class="preview-bubble sent-preview">ÊûÅÁÆÄÁ∫øÊù°</div>
                                            <div class="preview-bubble received-preview">ÁÆÄÁ∫¶</div>
                                        </div>
                                        <div class="style-name">ÊûÅÁÆÄÊ†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="neon">
                                        <div class="style-preview bubble-style-neon">
                                            <div class="preview-bubble sent-preview">ÈúìËôπÂèëÂÖâ</div>
                                            <div class="preview-bubble received-preview">ÁßëÊäÄÊÑü</div>
                                        </div>
                                        <div class="style-name">ÈúìËôπÊ†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="paper">
                                        <div class="style-preview bubble-style-paper">
                                            <div class="preview-bubble sent-preview">Á∫∏Âº†Âç°Áâá</div>
                                            <div class="preview-bubble received-preview">Ë¥®ÊÑü</div>
                                        </div>
                                        <div class="style-name">Á∫∏Âº†Ê†∑Âºè</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="color-setting-group">
                                <label class="form-label">Ëá™ÂÆö‰πâÈ¢úËâ≤</label>
                                <div class="color-picker-container">
                                    <div class="flex-gap-15">
                                        <div class="flex-1">
                                            <label class="label-small">ÊàëÁöÑÊ∞îÊ≥°</label>
                                            <input type="color" id="my-bubble-color" class="color-input" value="#007AFF">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">ÂØπÊñπÊ∞îÊ≥°</label>
                                            <input type="color" id="ai-bubble-color" class="color-input" value="#f0f0f0">
                                        </div>
                                    </div>
                                </div>
                                <div class="opacity-setting">
                                    <div class="flex-gap-15-mb-15">
                                        <div class="flex-1">
                                            <label class="label-small">ÊàëÁöÑÊ∞îÊ≥°ÈÄèÊòéÂ∫¶Ôºö<span id="my-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="my-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">ÂØπÊñπÊ∞îÊ≥°ÈÄèÊòéÂ∫¶Ôºö<span id="ai-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="ai-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="padding-setting">
                                    <label class="form-label">Ê∞îÊ≥°Â§ßÂ∞èË∞ÉËäÇ</label>
                                    <div class="flex-gap-15-mb-10">
                                        <div class="flex-1">
                                            <label class="label-small">ÂÜÖËæπË∑ùÔºö<span id="bubble-padding-value">‰∏≠Á≠â</span></label>
                                            <input type="range" id="bubble-padding" min="4" max="16" step="2" value="12" class="width-100">
                                        </div>
                                    </div>
                                    <p class="tiny-text-gray margin-top-5">
                                        Ë∞ÉÊï¥Ê∞îÊ≥°ÂÜÖÊñáÂ≠ó‰∏éËæπÁºòÁöÑË∑ùÁ¶ªÔºåÊï∞ÂÄºË∂äÂ§ßÊ∞îÊ≥°Ë∂äÂ§ß
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('bubble-style-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveBubbleStyleSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="schedule-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('schedule-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="schedule-enabled" class="checkbox-with-margin">
                                    ÂêØÁî®ÂÆöÊó∂ÂèëÂ∏É
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåËßíËâ≤‰ºöÂú®ÊåáÂÆöÊó∂Èó¥ÁÇπËá™Âä®ÂèëÂ∏ÉÁ§æ‰∫§Âä®ÊÄÅ
                                </p>
                            </div>
                            <div class="form-group hide" id="schedule-times-group">
                                <label class="form-label">ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ</label>
                                <div id="schedule-times-container">
                                    <!-- Êó∂Èó¥ÁÇπÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÊ∑ªÂä† -->
                                </div>
                                <button type="button" class="form-button form-button-secondary" onclick="addScheduleTime()">+ Ê∑ªÂä†Êó∂Èó¥ÁÇπ</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('schedule-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveScheduleSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ë∫´‰ªΩÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <!-- Ë∫´‰ªΩÈÄâÊã©Ê®°ÊÄÅÊ°ÜÂ∑≤ÁßªÈô§ÔºåË∫´‰ªΩÂú®ÂàõÂª∫ÂØπËØùÊó∂ÈÄâÊã© -->
                
                <!-- ‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="worldbook-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('worldbook-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="worldbook-mount-enabled" class="checkbox-with-margin">
                                    ÂêØÁî®‰∏ñÁïå‰π¶ÊåÇËΩΩ
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåAI‰ºöÂèÇËÄÉÈÄâÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØÁü•ËØÜËøõË°åÂØπËØù
                                </p>
                            </div>
                            <div class="form-group hide" id="worldbook-mount-details">
                                <label class="form-label">ÈÄâÊã©Ë¶ÅÊåÇËΩΩÁöÑ‰∏ñÁïå‰π¶</label>
                                <div id="worldbook-mount-list" class="max-height-300-auto">
                                    <!-- ‰∏ñÁïå‰π¶ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                                <p class="small-text margin-top-8">
                                    ÈÄâÊã©ÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰ºö‰Ωú‰∏∫ËÉåÊôØÁü•ËØÜÊèê‰æõÁªôAIÂèÇËÄÉÔºåÂ∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÁêÜËß£ÂØπËØù‰∏ä‰∏ãÊñá
                                </p>
                            </div>
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>ÂäüËÉΩËØ¥ÊòéÔºö</strong><br>
                                    ‚Ä¢ <strong>‰∏ñÁïå‰π¶ÊåÇËΩΩÔºö</strong>Â∞ÜÈÄâÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫AIÁöÑËÉåÊôØÁü•ËØÜ<br>
                                    ‚Ä¢ <strong>Â§öÈÄâÊîØÊåÅÔºö</strong>ÂèØ‰ª•ÂêåÊó∂ÊåÇËΩΩÂ§ö‰∏™‰∏ñÁïå‰π¶ÔºåÂÜÖÂÆπ‰ºöÂêàÂπ∂‰ΩøÁî®<br>
                                    ‚Ä¢ <strong>Êô∫ËÉΩÂ∫îÁî®Ôºö</strong>AI‰ºöÊ†πÊçÆÂØπËØùÂÜÖÂÆπÊô∫ËÉΩÂºïÁî®Áõ∏ÂÖ≥ÁöÑ‰∏ñÁïå‰π¶Áü•ËØÜ<br>
                                    ‚Ä¢ <strong>‰ºòÂÖàÁ∫ßÔºö</strong>‰∏ñÁïå‰π¶Áü•ËØÜ‰ºòÂÖàÁ∫ß‰Ωé‰∫éËßíËâ≤ËÆæÂÆöÂíåÂéÜÂè≤ÂØπËØù
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('worldbook-mount-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveWorldbookMountSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>

                <!-- Êó∂Èó¥Êà≥ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="timestamp-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Êó∂Èó¥Êà≥ËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('timestamp-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="timestamp-modal-enabled" class="checkbox-with-margin" checked>
                                    ÊòæÁ§∫Êó∂Èó¥Êà≥
                                </label>
                                <p class="small-text margin-top-5">
                                    Âú®ËÅäÂ§©Ê∂àÊÅØ‰∏≠ÊòæÁ§∫Êó∂Èó¥‰ø°ÊÅØ
                                </p>
                            </div>
                            
                            <div class="form-group" id="timestamp-options-group">
                                <label class="form-label">Êó∂Èó¥Êà≥‰ΩçÁΩÆ</label>
                                <div class="timestamp-position-options">
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="center" checked>
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Â±Ö‰∏≠ÊòæÁ§∫</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®ËÅäÂ§©‰∏≠Èó¥ÔºåÊØè5ÂàÜÈíüÂá∫Áé∞‰∏ÄÊ¨°</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="bubble">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Ê∞îÊ≥°Â§ñ‰æß</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®ÊØèÊù°Ê∂àÊÅØÊ∞îÊ≥°ÁöÑÂ§ñ‰æß</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="avatar">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Â§¥ÂÉè‰∏ãÊñπ</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®Â§¥ÂÉèÊ≠£‰∏ãÊñπ‰ΩçÁΩÆ</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="inside">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Ê∞îÊ≥°ÂÜÖ</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®Ê∞îÊ≥°ÂÜÖÂè≥‰∏ãËßíÔºå‰∏éÊñáÂ≠óÈΩêÂπ≥</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>‰ΩçÁΩÆËØ¥ÊòéÔºö</strong><br>
                                    ‚Ä¢ <strong>Â±Ö‰∏≠ÊòæÁ§∫Ôºö</strong>Êó∂Èó¥Êà≥Ê∞¥Âπ≥Â±Ö‰∏≠Ôºå‰ªÖÂú®Ë∂ÖËøá5ÂàÜÈíüÈó¥ÈöîÊó∂ÊòæÁ§∫<br>
                                    ‚Ä¢ <strong>Ê∞îÊ≥°Â§ñ‰æßÔºö</strong>ÊØèÊù°Ê∂àÊÅØÈÉΩÊòæÁ§∫Êó∂Èó¥ÔºåÁî®Êà∑Ê∂àÊÅØÂú®Â∑¶‰∏ãËßíÔºåËßíËâ≤Ê∂àÊÅØÂú®Âè≥‰∏ãËßí<br>
                                    ‚Ä¢ <strong>Â§¥ÂÉè‰∏ãÊñπÔºö</strong>Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®ÂØπÂ∫îÂ§¥ÂÉèÁöÑÊ≠£‰∏ãÊñπ‰ΩçÁΩÆ<br>
                                    ‚Ä¢ ÊâÄÊúâÊó∂Èó¥Êà≥Âùá‰ΩøÁî®ÁÅ∞Ëâ≤Â∞èÂ≠óÊòæÁ§∫Ôºå‰∏çÂΩ±ÂìçËÅäÂ§©‰ΩìÈ™å
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('timestamp-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveTimestampSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- ËΩ¨Ë¥¶ÂäüËÉΩÁõ∏ÂÖ≥Ê®°ÊÄÅÊ°Ü -->
    <div id="transfer-modal">
        <div class="transfer-content">
                            <div class="transfer-header">ÂèëËµ∑ËΩ¨Ë¥¶</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
                                    <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="1000000000" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">Â§áÊ≥® (ÂèØÈÄâ)</label>
                                    <input type="text" id="transfer-note" placeholder="ËØ¥ÁÇπ‰ªÄ‰πàÂêß..." maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">ÂèñÊ∂à</button>
                <button id="transfer-confirm-btn">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
            </div>
        </div>
    </div>
    
    <div id="transfer-confirm-modal">
        <div class="transfer-confirm-content">
            <div class="transfer-confirm-title">Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶</div>
            <div class="transfer-confirm-info">
                <div class="transfer-confirm-amount">¬• 0.00</div>
                <div class="transfer-confirm-note">Â§áÊ≥®Ôºö</div>
            </div>
            <div class="transfer-confirm-actions">
                <button id="transfer-reject-btn">ÈÄÄÂõû</button>
                <button id="transfer-accept-btn">Á°ÆËÆ§Êî∂Ê¨æ</button>
                </div>
            </div>
        </div>

    <script>
        // ÂàùÂßãÂåñDexieÊï∞ÊçÆÂ∫ì
        const db = new Dexie('PhoneChatDB');
        let activeGlobalWorldbooks = []; // Áî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊøÄÊ¥ªÁöÑÂÖ®Â±Ä‰∏ñÁïå‰π¶ID
        
        // ÁâàÊú¨1ÔºöÂéüÂßãË°®ÁªìÊûÑ
        db.version(1).stores({
            characters: '&id, name',
            contacts: '&id, characterId', 
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            wallpapers: '&id, type',
            worldbooks: '&id, name',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId'
        });
        
        // ÁâàÊú¨2ÔºöÊ∑ªÂä†Âä®ÊÄÅÁõ∏ÂÖ≥Ë°®
        db.version(2).stores({
            characters: '&id, name',
            contacts: '&id, characterId', 
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            wallpapers: '&id, type',
            worldbooks: '&id, name',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId',
            // Âä®ÊÄÅÁõ∏ÂÖ≥Ë°®
            moments: '&id, authorId, timestamp',
            momentLikes: '[momentId+authorId], momentId, authorId',
            momentComments: '&id, momentId, authorId, timestamp'
        });

        // ÁâàÊú¨3ÔºöÊ∑ªÂä†ÊúÄËøë‰ΩøÁî®Ë°®ÊÉÖÂåÖË°®
        db.version(4).stores({
            characters: '&id, name',
    contacts: '++id, characterId', 
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            wallpapers: '&id, type',
    worldbooks: '&id, name, isGlobal',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId',
            moments: '&id, authorId, timestamp',
            momentLikes: '[momentId+authorId], momentId, authorId',
            momentComments: '&id, momentId, authorId, timestamp',
            recentEmojis: '&id, lastUsed'
        });


        // ÂÖ®Â±ÄÂèòÈáè
        let characters = [];
        let contacts = [];
        let currentChatCharacter = null;
        let chatMessages = {};
        let selectedMessageId = null;
        let personas = []; // Áî®Êà∑Èù¢ÂÖ∑ÂàóË°®
        let currentPersona = null; // ÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑
        let editingPersona = null; // Ê≠£Âú®ÁºñËæëÁöÑÈù¢ÂÖ∑
        let isMultiSelectMode = false; // Â§öÈÄâÊ®°ÂºèÁä∂ÊÄÅ
        let selectedCharacters = []; // ÈÄâ‰∏≠ÁöÑËßíËâ≤IDÂàóË°®
        let currentEditingCharacterId = null; // ÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑËßíËâ≤ID
        let groupChats = []; // Áæ§ËÅäÂàóË°®
        let selectedGroupMembers = []; // Áæ§ËÅäÊàêÂëòÈÄâÊã©
        let currentWorldbookTab = 'global';
        
        // Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÁõ∏ÂÖ≥ÂèòÈáè
        let customEmojis = []; // Áî®Êà∑‰∏ä‰º†ÁöÑË°®ÊÉÖÂåÖ
        let recentEmojis = []; // ÊúÄËøë‰ΩøÁî®ÁöÑË°®ÊÉÖÂåÖ
        let currentEmojiTab = 'recent'; // ÂΩìÂâçË°®ÊÉÖÂåÖÊ†áÁ≠æÈ°µ
        
        // Ê∂àÊÅØÂ§öÈÄâÂà†Èô§Áõ∏ÂÖ≥ÂèòÈáè
        let isMessageSelectionMode = false; // Ê∂àÊÅØÈÄâÊã©Ê®°Âºè
        let selectedMessages = new Set(); // ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØIDÈõÜÂêà
        
        // Ê∂àÊÅØÂàóË°®Â§öÈÄâÁõ∏ÂÖ≥ÂèòÈáè
        let isMessageListMultiSelectMode = false; // Ê∂àÊÅØÂàóË°®Â§öÈÄâÊ®°ÂºèÁä∂ÊÄÅ
        let selectedConversations = []; // ÈÄâ‰∏≠ÁöÑÂØπËØùÊ°ÜIDÂàóË°®
        
        // Âä®ÊÄÅËØÑËÆ∫ÂØπËØùËΩÆÊ¨°ËøΩË∏™
        let commentConversationRounds = new Map(); // Ê†ºÂºè: "momentId-characterId" => ËΩÆÊ¨°Êï∞
        
        let apiSettings = {
            type: 'openai',
            base: 'https://api.openai.com/v1',
            endpoint: '/chat/completions',
            key: '',
            model: 'gpt-3.5-turbo',
            temperature: 0.70
        };
        
        // Ê≥®ÊÑèÔºöËÆ∞ÂøÜËÆæÁΩÆÁé∞Âú®Â∑≤Êîπ‰∏∫ÊØè‰∏™ËÅäÂ§©Á™óÂè£Áã¨Á´ãÁöÑËÆæÁΩÆÔºåÂ≠òÂÇ®Âú®ÂêÑËá™ÁöÑËÅäÂ§©ËÆæÁΩÆ‰∏≠
        
        let chatSettings = {
            themeColor: '#007AFF',
            theirBubbleColor: '#f0f0f0',
            myBubbleColor: '#007AFF',
            bubbleOpacity: 1,
            timestampEnabled: true,
            timestampPosition: 'center'
        };
        

        let selectedAppIcon = null;
        let selectedWallpaper = null;
        let colorPickerContext = null;
        let customIconImage = null;
        
        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', async function() {
            updateTime();
            
            try {
            
            // Âπ∂Ë°åÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
            await Promise.all([
                loadCharacters(),
                loadContacts(), 
                loadChatMessages(),
    
                loadChatSettings(),
                loadApiSettings(),
                loadCustomEmojis()
            ]);
            const globalSettings = await db.globalSettings.get('main');
            if (globalSettings && globalSettings.activeGlobalWorldbooks) {
                activeGlobalWorldbooks = globalSettings.activeGlobalWorldbooks;
            }
            
            // Âä†ËΩΩÂ§ñËßÇËÆæÁΩÆ
            loadPhoneBorderSetting();
            loadScreenSize();
            loadFontSizeSettings();
            
            // Âä†ËΩΩÂä®ÊÄÅÂõæÁâáËÆæÁΩÆ
            loadMomentsImages();
            
            // Âä†ËΩΩÂÖ∂‰ªñËÆæÁΩÆÔºàÂåÖÊã¨ÈúÄË¶ÅÊï∞ÊçÆÂ∫ìÁöÑÂ£ÅÁ∫∏ËÆæÁΩÆÔºâ
            await loadWallpaper();
            await loadAppIcons();
            loadSavedTheme();
            await loadWorldbooks();
            loadMusicData();
            await loadPersonas();
            await loadGroupChats();
            
            // Ê∏≤ÊüìÁïåÈù¢ - Ê∑ªÂä†Êï∞ÊçÆÈ™åËØÅ
            try {
                if (characters && contacts && chatMessages) {
            renderMessageList();
            renderContactList();
            renderCharacterList();
            renderPersonaList();
                } else {
                    console.warn('Êï∞ÊçÆÊú™ÂÆåÂÖ®Âä†ËΩΩÔºåÊé®ËøüÁïåÈù¢Ê∏≤Êüì');
                    // Âª∂ËøüÈáçËØïÊ∏≤Êüì
                    setTimeout(() => {
                        renderMessageList();
                        renderContactList();
                        renderCharacterList();
                        renderPersonaList();
                    }, 500);
                }
            } catch (renderError) {
                console.error('ÁïåÈù¢Ê∏≤ÊüìÂ§±Ë¥•:', renderError);
                // Â∞ùËØïÈáçÊñ∞ÂàùÂßãÂåñÁ©∫Êï∞ÊçÆ
                if (!chatMessages) chatMessages = {};
                if (!contacts) contacts = [];
                if (!characters) characters = [];
                renderMessageList();
                renderContactList();
                renderCharacterList();
            }
            
            // ÂàùÂßãÂåñÊó∂ËÆæÁΩÆÊ≠£Á°ÆÁöÑÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ - Âª∂ËøüÊâßË°åÁ°Æ‰øùDOMÂä†ËΩΩÂÆåÊàê
            setTimeout(() => {
                switchChatTab('message-list');
                // Á°Æ‰øùappÊ†áÈ¢òÊúâchat-modeÁ±ªÂíåÊ≠£Á°ÆÂÜÖÂÆπ
                const appTitle = document.querySelector('#chat-screen .app-title');
                if (appTitle) {
                    appTitle.classList.add('chat-mode');
                    appTitle.textContent = 'üí¨';
                }
                initializeChatSettings(); // ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢
                updateWorldbookMountDisplay(); // Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫
            }, 100);
            
            // Ê∏©Â∫¶ÊªëÂùóÊòæÁ§∫
            const temperatureSlider = document.getElementById('temperature-slider');
            if (temperatureSlider) {
                temperatureSlider.addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = parseFloat(this.value).toFixed(2);
            });
            }
            
            // ÂàùÂßãÂåñAPIËÆæÁΩÆÁïåÈù¢
            initializeApiSettings();
            
            // ÈÄèÊòéÂ∫¶ÊªëÂùóÊòæÁ§∫
            document.getElementById('opacity-slider').addEventListener('input', function() {
                document.getElementById('opacity-value').textContent = Math.round(this.value * 100) + '%';
            });
            
            // ÊåâEnterÈîÆÂèëÈÄÅÊ∂àÊÅØ
            document.getElementById('api-chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Èò≤Ê≠¢Êç¢Ë°å
                    sendApiMessage();
                }
            });
            

            
            // ÂàùÂßãÂåñÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
            initializeAvatarUpload();
            
            // ÂàùÂßãÂåñË°®ÊÉÖÂåÖ‰∏ä‰º†ÂäüËÉΩ
            initializeEmojiUpload();
            
            // ÂàùÂßãÂåñÊ∂àÊÅØÈÄâÊã©Ê®°ÂºèÁä∂ÊÄÅ
            isMessageSelectionMode = false;
            selectedMessages.clear();
            
            // ÂõæÁâá‰∏ä‰º†
            document.getElementById('image-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûãÔºåGIFÊ†ºÂºè‰∏çË¢´Gemini APIÊîØÊåÅ
                    if (file.type === 'image/gif') {
                        alert('Êä±Ê≠âÔºåGemini API ‰∏çÊîØÊåÅ GIF Ê†ºÂºèÁöÑÂõæÁâá„ÄÇ\n\nËØ∑ÈÄâÊã©ÂÖ∂‰ªñÊ†ºÂºèÁöÑÂõæÁâáÔºåÂ¶ÇÔºö\n‚Ä¢ JPEG\n‚Ä¢ PNG\n‚Ä¢ WEBP');
                        // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©Âô®
                        e.target.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        // üî•„Äê‰øÆÂ§ç„ÄëÁõ¥Êé•ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØÔºåÂ∞±ÂÉèÊ≠£Â∏∏ÁöÑÂõæÁâáÂèëÈÄÅ‰∏ÄÊ†∑
                        sendImageMessage(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
                
                // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©Âô®ÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
                e.target.value = '';
            });
            
            // Ëá™ÂÆö‰πâÂ£ÅÁ∫∏‰∏ä‰º†
            document.getElementById('custom-wallpaper-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        selectedWallpaper = event.target.result;
                        
                        // Êõ¥Êñ∞È¢ÑËßàÂÆπÂô®
                        const previewContainer = document.getElementById('wallpaper-preview-container');
                        if (previewContainer) {
                            previewContainer.innerHTML = `<img src="${selectedWallpaper}" class="wallpaper-preview-image" alt="Â£ÅÁ∫∏È¢ÑËßà">`;
                        }
                        
                        // ‰∏çÂú®ËøôÈáåÁ´ãÂç≥Â∫îÁî®Âà∞‰∏ªÁïåÈù¢ÔºåÁ≠âÁî®Êà∑ÁÇπÂáªÂ∫îÁî®Êó∂ÂÜçÂ∫îÁî®
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Ëá™ÂÆö‰πâÂõæÊ†á‰∏ä‰º†
            document.getElementById('custom-icon-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        customIconImage = event.target.result;
                        // Êõ¥Êñ∞È¢ÑËßà
                        const previews = document.querySelectorAll('.icon-preview');
                        previews.forEach(preview => {
                            preview.style.backgroundImage = `url(${customIconImage})`;
                            preview.innerHTML = ''; // ÁßªÈô§ÂõæÊ†á
                        });
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            setInterval(updateTime, 1000);
            initBatteryManager();
            
            } catch (error) {
                console.error('Â∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊòØÊï∞ÊçÆÂ∫ìÈîôËØØÔºåÂ∞ùËØïÈáçÁΩÆ
                if (error.name === 'DataError' || error.name === 'InvalidStateError' || error.name === 'DexieError') {
                    console.log('Ê£ÄÊµãÂà∞Êï∞ÊçÆÂ∫ìÈîôËØØÔºåÂ∞ùËØïÈáçÁΩÆÊï∞ÊçÆÂ∫ì...');
                    if (confirm('Â∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•ÔºåÊòØÂê¶ÈáçÁΩÆÊï∞ÊçÆÂ∫ìÔºü\nÊ≥®ÊÑèÔºöËøôÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆ„ÄÇ')) {
                        await resetDatabase();
                    }
                } else {
                    alert('Â∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï„ÄÇ');
                }
            }
        });
        
        // ÊòæÁ§∫/ÈöêËóèÂ∫îÁî®
        function showApp(appId) {
            if (event) event.preventDefault();
            
            // ÈöêËóèÊâÄÊúâappÁïåÈù¢
            const allApps = document.querySelectorAll('.app-screen');
            allApps.forEach(app => {
                app.style.display = 'none';
            });
            
            // ÈöêËóè‰∏ªÂ±èÂπïÁªÑ‰ª∂
            const clockContainer = document.getElementById('clock-container');
            const appGrid = document.getElementById('app-grid');
            if (clockContainer) clockContainer.style.display = 'none';
            if (appGrid) appGrid.style.display = 'none';
            
            // ÊòæÁ§∫ÁõÆÊ†áÁïåÈù¢
            document.getElementById(appId).style.display = 'flex';
            
            // Â¶ÇÊûúÊòØËÅäÂ§©ÁïåÈù¢ÔºåÂà∑Êñ∞Ê∂àÊÅØÂàóË°®
            if (appId === 'chat-screen') {
                renderMessageList();
            }
            
            // Â¶ÇÊûúÊòØAPIËÆæÁΩÆÁïåÈù¢ÔºåÂàùÂßãÂåñËÆæÁΩÆ
            if (appId === 'api-settings-screen') {
                // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥Á°Æ‰øùDOMÂ∑≤Ê∏≤Êüì
                setTimeout(() => {
                    initializeApiSettings();
                }, 100);
            }
        }
        

        
        // ÈöêËóèËßíËâ≤ÂàõÂª∫Ë°®ÂçïÔºåËøîÂõûÂà∞chatÁïåÈù¢ÁöÑÈÄöËÆØÂΩï
        function hideCharacterForm() {
            // Âú®ÈöêËóèË°®ÂçïÊó∂Ê∏ÖÁ©∫Ë°®ÂçïÊï∞ÊçÆ
            clearCharacterForm();
            
            hideApp('character-form-screen');
            showApp('chat-screen');
            switchChatTab('contact-list');
            // ÊâãÂä®Ëß¶ÂèëÊ†áÁ≠æÂàáÊç¢ÁöÑÊ†∑Âºè
            const chatTabs = document.querySelectorAll('.chat-tab');
            chatTabs.forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });
            // ÂÆâÂÖ®Âú∞Ê∑ªÂä†activeÁ±ªÂà∞Á¨¨‰∫å‰∏™Ê†áÁ≠æÔºàÈÄöËÆØÂΩïÔºâ
            if (chatTabs.length > 1 && chatTabs[1] && chatTabs[1].classList) {
                chatTabs[1].classList.add('active');
            }
        }
        
        function hideApp(appId) {
            document.getElementById(appId).style.display = 'none';
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÂ∫îÁî®ÈÉΩÂ∑≤ÈöêËóèÔºåÂ¶ÇÊûúÊòØÔºåÊòæÁ§∫‰∏ªÂ±èÂπïÁªÑ‰ª∂
            const allApps = document.querySelectorAll('.app-screen');
            const hasVisibleApp = Array.from(allApps).some(app => 
                app.style.display === 'flex' || app.style.display === 'block'
            );
            
            if (!hasVisibleApp) {
                // ÊòæÁ§∫‰∏ªÂ±èÂπïÁªÑ‰ª∂
                const clockContainer = document.getElementById('clock-container');
                const appGrid = document.getElementById('app-grid');
                if (clockContainer) clockContainer.style.display = 'block';
                if (appGrid) appGrid.style.display = 'flex';
            }
        }
        
        // ÊòæÁ§∫/ÈöêËóèÊ®°ÊÄÅÊ°Ü
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            
            // Â¶ÇÊûúÊòØÊ∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°ÜÔºåÊ∏≤ÊüìÂèØÈÄâËÅîÁ≥ª‰∫∫
            if (modalId === 'add-contact-modal') {
                renderContactModal();
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // ÂàáÊç¢ÁÖßÁâáÊñáÂ≠óÊòæÁ§∫
        function togglePhotoText(container, description) {
            const overlay = container.querySelector('.photo-text-overlay');
            const sparkles = container.querySelector('.sparkle-container');
            const badge = container.querySelector('.photo-badge');
            
            if (overlay.style.display === 'none') {
                // ÊòæÁ§∫ÊñáÂ≠óÔºåÈöêËóèÊòüÊòüÂíåÊ†áÂøó
                overlay.style.display = 'flex';
                sparkles.style.opacity = '0';
                badge.style.opacity = '0.3';
            } else {
                // ÈöêËóèÊñáÂ≠óÔºåÊòæÁ§∫ÊòüÊòüÂíåÊ†áÂøó
                overlay.style.display = 'none';
                sparkles.style.opacity = '1';
                badge.style.opacity = '1';
            }
        }

        // ÊòæÁ§∫Áî®Êà∑ÁÖßÁâáÊèèËø∞
        function showUserPhotoDescription(description) {
            const modalHtml = `
                <div id="photo-description-modal" class="modal" style="display: flex; z-index: 10000; background: rgba(0, 0, 0, 0.8);">
                    <div class="magical-photo-modal">
                        <div class="photo-modal-bg"></div>
                        <div class="photo-modal-content">
                            <div class="photo-modal-header">
                                <i class="fas fa-camera photo-modal-icon"></i>
                                <div class="photo-modal-title">ÁÖßÁâáÂÜÖÂÆπ</div>
                            </div>
                            <div class="photo-modal-body">
                                <div class="photo-description-text">${description}</div>
                            </div>
                            <div class="photo-modal-footer">
                                <button class="photo-modal-btn" id="photo-description-close">Á°ÆÂÆö</button>
                            </div>
                        </div>
                        <div class="modal-sparkles">
                            <div class="modal-sparkle modal-sparkle-1">‚ú®</div>
                            <div class="modal-sparkle modal-sparkle-2">‚≠ê</div>
                            <div class="modal-sparkle modal-sparkle-3">‚ú®</div>
                            <div class="modal-sparkle modal-sparkle-4">‚≠ê</div>
                            <div class="modal-sparkle modal-sparkle-5">üí´</div>
                            <div class="modal-sparkle modal-sparkle-6">‚ú®</div>
                            <div class="modal-sparkle modal-sparkle-7">‚≠ê</div>
                            <div class="modal-sparkle modal-sparkle-8">üí´</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = document.getElementById('photo-description-modal');
            const closeBtn = document.getElementById('photo-description-close');
            
            // ÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
            closeBtn.onclick = () => {
                modal.remove();
            };
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // Ëá™ÂÆö‰πâËæìÂÖ•ÊèêÁ§∫Ê°Ü
        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text') {
            return new Promise(resolve => {
                // ÂàõÂª∫Ê®°ÊÄÅÊ°ÜHTML
                const modalHtml = `
                    <div id="custom-prompt-modal" class="modal" style="display: flex; z-index: 10000;">
                        <div class="modal-content" style="max-width: 400px;">
                            <div class="modal-header">
                                <div class="modal-title">${title}</div>
                            </div>
                            <div class="modal-body">
                                <input type="${type}" id="custom-prompt-input" class="form-input" 
                                       placeholder="${placeholder}" value="${initialValue}"
                                       style="width: 100%; margin-top: 10px;">
                            </div>
                            <div class="modal-footer">
                                <button class="modal-button modal-secondary" id="custom-prompt-cancel">ÂèñÊ∂à</button>
                                <button class="modal-button modal-primary" id="custom-prompt-confirm">Á°ÆÂÆö</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = document.getElementById('custom-prompt-modal');
                const input = document.getElementById('custom-prompt-input');
                const confirmBtn = document.getElementById('custom-prompt-confirm');
                const cancelBtn = document.getElementById('custom-prompt-cancel');
                
                // Á°ÆÂÆöÊåâÈíÆ‰∫ã‰ª∂
                confirmBtn.onclick = () => {
                    const value = input.value;
                    modal.remove();
                    resolve(value);
                };
                
                // ÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂
                cancelBtn.onclick = () => {
                    modal.remove();
                    resolve(null);
                };
                
                // ÂõûËΩ¶ÈîÆÁ°ÆËÆ§
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    }
                };
                
                // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
                setTimeout(() => input.focus(), 100);
            });
        }
        
        // ÂàáÊç¢ËÅäÂ§©Ê†áÁ≠æ
        function switchChatTab(tabId) {
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑactiveÁ±ª
            document.querySelectorAll('.chat-tab').forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });
            
            // Ê∑ªÂä†ÂΩìÂâçÊ†áÁ≠æÁöÑactiveÁ±ª
            if (event && event.currentTarget && event.currentTarget.classList) {
                event.currentTarget.classList.add('active');
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâeventÂØπË±°ÔºåÊ†πÊçÆtabIdËÆæÁΩÆactive
                if (tabId === 'message-list') {
                    const messageTab = document.getElementById('message-tab');
                    if (messageTab && messageTab.classList) {
                        messageTab.classList.add('active');
                    }
                } else if (tabId === 'contact-list') {
                    const tabs = document.querySelectorAll('.chat-tab');
                    if (tabs.length > 1 && tabs[1] && tabs[1].classList) {
                        tabs[1].classList.add('active');
                    }
                } else if (tabId === 'moments-page') {
                    const tabs = document.querySelectorAll('.chat-tab');
                    if (tabs.length > 2 && tabs[2] && tabs[2].classList) {
                        tabs[2].classList.add('active');
                    }
                } else if (tabId === 'profile-page') {
                    const tabs = document.querySelectorAll('.chat-tab');
                    if (tabs.length > 3 && tabs[3] && tabs[3].classList) {
                        tabs[3].classList.add('active');
                    }
                }
            }
            
            // ÈöêËóèÊâÄÊúâÂÜÖÂÆπ
            const messageListEl = document.getElementById('message-list');
            const contactListEl = document.getElementById('contact-list');
            const profilePageEl = document.getElementById('profile-page');
            const momentsPageEl = document.getElementById('moments-page');
            const targetEl = document.getElementById(tabId);
            
            if (messageListEl) messageListEl.style.display = 'none';
            if (contactListEl) contactListEl.style.display = 'none';
            if (profilePageEl) profilePageEl.style.display = 'none';
            if (momentsPageEl) momentsPageEl.style.display = 'none';
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÂÜÖÂÆπ
            if (targetEl) targetEl.style.display = 'block';
            
            // ÊéßÂà∂appÊ†áÈ¢òÁöÑÊ∏êÂèòÊïàÊûúÂíåÂÜÖÂÆπ
            const appTitle = document.querySelector('#chat-screen .app-title');
            if (appTitle) {
                if (tabId === 'message-list') {
                    appTitle.classList.add('chat-mode');
                    appTitle.textContent = 'üí¨';
                } else if (tabId === 'contact-list') {
                    appTitle.classList.remove('chat-mode');
                    appTitle.textContent = 'ËßíËâ≤';
                } else if (tabId === 'moments-page') {
                    appTitle.classList.remove('chat-mode');
                                            appTitle.textContent = 'Âä®ÊÄÅ';
                } else if (tabId === 'profile-page') {
                    appTitle.classList.remove('chat-mode');
                    appTitle.textContent = 'Êàë';
                }
            }
            
            // ÊéßÂà∂Âä†Âè∑ÊåâÈíÆÊòæÁ§∫
            const addContactBtn = document.getElementById('add-contact-btn');
            const addChatBtn = document.getElementById('add-chat-btn');
            
            if (addContactBtn && addChatBtn) {
                if (tabId === 'contact-list') {
                    addContactBtn.style.display = 'flex';
                    addChatBtn.style.display = 'none';
                    // ‰øÆÊîπÂä†Âè∑ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂‰∏∫ÂàõÂª∫ËßíËâ≤
                    addContactBtn.onclick = () => showCharacterForm();
                } else if (tabId === 'message-list') {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'flex';
                } else if (tabId === 'moments-page') {
                                            // Âä®ÊÄÅÈ°µÈù¢ÊòæÁ§∫ÂèëÂ∏ÉÊåâÈíÆ
                    addContactBtn.style.display = 'flex';
                    addChatBtn.style.display = 'none';
                    // ‰øÆÊîπÂä†Âè∑ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂‰∏∫ÂèëÂ∏ÉÂä®ÊÄÅ
                    addContactBtn.onclick = () => showPublishMoment();
                } else {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'none';
                }
            }
            
            // Â¶ÇÊûúÊòØÂä®ÊÄÅÈ°µÈù¢ÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂä†ËΩΩÂä®ÊÄÅÂÜÖÂÆπ
            if (tabId === 'moments-page') {
                // Âè™Âú®Âä®ÊÄÅÂàóË°®‰∏∫Á©∫Êó∂Âä†ËΩΩÔºåÈÅøÂÖçÈáçÂ§çÊòæÁ§∫
                const momentsList = document.getElementById('moments-list');
                if (momentsList && momentsList.children.length === 0) {
                loadMoments();
                }
                                        // ÁßªÈô§Âä®ÊÄÅÈ°µÈù¢ÁöÑpaddingÔºåÂÆûÁé∞ÂÖ®Â±èÊïàÊûú
                const chatContent = document.getElementById('chat-content');
                if (chatContent) {
                    chatContent.style.padding = '0';
                }
            } else {
                // ÂÖ∂‰ªñÈ°µÈù¢ÊÅ¢Â§çÊ≠£Â∏∏padding
                const chatContent = document.getElementById('chat-content');
                if (chatContent) {
                    chatContent.style.padding = '15px';
                }
                
                // ÂÅúÊ≠¢Êó∂Èó¥Êõ¥Êñ∞Âô®ÔºàËäÇÁúÅËµÑÊ∫êÔºâ
                stopTimeUpdater();
            }
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            // Êõ¥Êñ∞Áä∂ÊÄÅÊ†èÊó∂Èó¥
            const statusTime = document.getElementById('status-bar-time');
            if (statusTime) {
                statusTime.textContent = timeString;
            }
            
            // Êõ¥Êñ∞Â∫îÁî®ÂÜÖÁä∂ÊÄÅÊ†èÊó∂Èó¥
            const appStatusTimes = document.querySelectorAll('.app-status-time');
            appStatusTimes.forEach(element => {
                element.textContent = timeString;
            });
            
            // Êõ¥Êñ∞‰∏ªÊó∂Èíü
            const mainTime = document.getElementById('main-time');
            if (mainTime) {
                mainTime.textContent = timeString;
            }
            
            // Êõ¥Êñ∞Êó•Êúü
            const mainDate = document.getElementById('main-date');
            if (mainDate) {
                const date = now.toLocaleDateString('zh-CN', { 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                });
                mainDate.textContent = date;
            }
        }
        
        // Âä†ËΩΩËßíËâ≤Êï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadCharacters() {
            try {
                // ÂÖàÊ£ÄÊü•IndexedDB‰∏≠ÊòØÂê¶ÊúâÊï∞ÊçÆ
                const savedCharacters = await db.characters.toArray();
                
                if (savedCharacters.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('characters');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑËßíËâ≤Êï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localCharacters = JSON.parse(localStorageData);
                        
                        if (localCharacters.length > 0) {
                            // ËøÅÁßªÊï∞ÊçÆÂà∞IndexedDB
                            await db.characters.bulkAdd(localCharacters);
                            characters = localCharacters;
                            console.log('ËßíËâ≤Êï∞ÊçÆËøÅÁßªÂÆåÊàê:', characters);
                            // ÂèØÈÄâÔºöÊ∏ÖÈô§localStorage‰∏≠ÁöÑÊóßÊï∞ÊçÆ
                            // localStorage.removeItem('characters');
                        } else {
                            characters = [];
                        }
                    } else {
                        characters = [];
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    characters = savedCharacters;
                    console.log('‰ªéIndexedDBÂä†ËΩΩËßíËâ≤Êï∞ÊçÆ:', characters);
                }
            } catch (error) {
                console.error('Âä†ËΩΩËßíËâ≤Êï∞ÊçÆÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªélocalStorageÂä†ËΩΩ
                const localStorageData = localStorage.getItem('characters');
                if (localStorageData) {
                    characters = JSON.parse(localStorageData);
                    console.log('‰ªélocalStorageÂ§á‰ªΩÂä†ËΩΩËßíËâ≤Êï∞ÊçÆ:', characters);
                } else {
                    characters = [];
                }
            }
        }
        
        // ‰øùÂ≠òËßíËâ≤Êï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function saveCharacters() {
            try {
                console.log('‰øùÂ≠òËßíËâ≤Êï∞ÊçÆÂà∞IndexedDB:', characters);
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
                await db.characters.clear();
                
                // ÊâπÈáèÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                if (characters.length > 0) {
                    await db.characters.bulkAdd(characters);
                }
                
                console.log('ËßíËâ≤Êï∞ÊçÆ‰øùÂ≠òÊàêÂäü');
            } catch (error) {
                console.error('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ:', error);
                alert('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ: ' + error.message);
                throw error;
            }
        }
        
        // ÊòæÁ§∫Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ
        function showStorageUsage() {
            const usage = [];
            
            // ËÆ°ÁÆóÂêÑÁßçÊï∞ÊçÆÁöÑÂ§ßÂ∞è
            const characters = localStorage.getItem('characters') || '[]';
            const chatMessages = localStorage.getItem('chatMessages') || '{}';
            const customEmojis = localStorage.getItem('customEmojis') || '[]';
            
            usage.push(`ËßíËâ≤Êï∞ÊçÆ: ${(characters.length / 1024).toFixed(1)} KB`);
            usage.push(`ËÅäÂ§©ËÆ∞ÂΩï: ${(chatMessages.length / 1024).toFixed(1)} KB`);
            usage.push(`Ë°®ÊÉÖÂåÖ: ${(customEmojis.length / 1024).toFixed(1)} KB`);
            
            const total = characters.length + chatMessages.length + customEmojis.length;
            usage.push(`ÊÄªËÆ°: ${(total / 1024).toFixed(1)} KB`);
            
            console.log('Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ:\n' + usage.join('\n'));
            alert('Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ:\n' + usage.join('\n'));
        }
        
        // Âä†ËΩΩËÅîÁ≥ª‰∫∫Êï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadContacts() {
            try {
                const savedContacts = await db.contacts.toArray();
        // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöËøáÊª§ÊéâÊâÄÊúâÊó†ÊïàÁöÑËÅîÁ≥ª‰∫∫Êï∞ÊçÆÔºåÁ°Æ‰øùÂàóË°®Âπ≤ÂáÄ
        contacts = savedContacts
            .map(contact => contact.characterId) // ÊèêÂèñID
            .filter(id => id !== undefined && id !== null); // Âè™‰øùÁïôÊúâÊïàÁöÑID

        // Ëá™Âä®Ê∏ÖÁêÜÈáçÂ§çÁöÑËÅîÁ≥ª‰∫∫IDÔºåÂ¢ûÂº∫Êï∞ÊçÆÂ∫ìÁ®≥ÂÆöÊÄß
        const uniqueContacts = [...new Set(contacts)];
        if (uniqueContacts.length < contacts.length) {
            console.warn('ÂèëÁé∞‰∫ÜÈáçÂ§çÁöÑËÅîÁ≥ª‰∫∫IDÔºåÂ∑≤Ëá™Âä®Ê∏ÖÁêÜ„ÄÇ');
            contacts = uniqueContacts;
            // Ê∏ÖÁêÜÂêéÔºåÁ´ãÂç≥Áî®Âπ≤ÂáÄÁöÑÊï∞ÊçÆË¶ÜÁõñÊï∞ÊçÆÂ∫ì
            await saveContacts();
        }

                    console.log('‰ªéIndexedDBÂä†ËΩΩËÅîÁ≥ª‰∫∫:', contacts);
            } catch (error) {
                console.error('Âä†ËΩΩËÅîÁ≥ª‰∫∫Â§±Ë¥•:', error);
        contacts = []; // Â¶ÇÊûúÂá∫ÈîôÔºåÁ°Æ‰øùËÅîÁ≥ª‰∫∫ÂàóË°®‰∏∫Á©∫ÔºåÈò≤Ê≠¢Á®ãÂ∫èÂ¥©Ê∫É
            }
        }
        
        // ‰øùÂ≠òËÅîÁ≥ª‰∫∫Êï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function saveContacts() {
            try {
        // ËøáÊª§Êéâ‰ªª‰ΩïÂèØËÉΩÂ≠òÂú®ÁöÑÊó†ÊïàID
        const validContacts = contacts.filter(id => id); 
        // Â∞ÜËÅîÁ≥ª‰∫∫IDÂàóË°®ËΩ¨Êç¢‰∏∫Êï∞ÊçÆÂ∫ìÈúÄË¶ÅÁöÑÂØπË±°Êï∞ÁªÑÊ†ºÂºè
        const contactArray = validContacts.map(id => ({ characterId: id }));

        await db.transaction('rw', db.contacts, async () => {
            // ÂÖàÊ∏ÖÁ©∫ÊóßË°®ÔºåÂÜçÊâπÈáèÂÜôÂÖ•Êñ∞Êï∞ÊçÆ
                await db.contacts.clear();
                if (contactArray.length > 0) {
                    await db.contacts.bulkAdd(contactArray);
                }
        });
            } catch (error) {
                console.error('‰øùÂ≠òËÅîÁ≥ª‰∫∫Â§±Ë¥•:', error);
            }
        }
        
        // Âä†ËΩΩËÅäÂ§©Ê∂àÊÅØ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadChatMessages() {
            try {
                const savedMessages = await db.chatMessages.toArray();
                chatMessages = {};
                
                if (savedMessages.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('chatMessages');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑËÅäÂ§©Êï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localMessages = JSON.parse(localStorageData);
                        
                        // Â∞ÜÂØπË±°Ê†ºÂºèËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®Âà∞IndexedDB
                        const messageArray = [];
                        for (const [characterId, messages] of Object.entries(localMessages)) {
                            for (const message of messages) {
                                messageArray.push({
                                    id: `${characterId}_${message.id || message.timestamp}`,
                                    characterId: characterId,
                                    timestamp: message.timestamp,
                                    messageData: message
                                });
                            }
                        }
                        
                        if (messageArray.length > 0) {
                            await db.chatMessages.bulkAdd(messageArray);
                        }
                        
                        chatMessages = localMessages;
                        console.log('ËÅäÂ§©Ê∂àÊÅØËøÅÁßªÂÆåÊàê:', chatMessages);
                    }
                } else {
                    // Â∞ÜÊï∞ÁªÑÊ†ºÂºèËΩ¨Êç¢ÂõûÂØπË±°Ê†ºÂºè
                    for (const msgRecord of savedMessages) {
                        const characterId = msgRecord.characterId;
                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        // üî•„ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•Ê∂àÊÅØÊï∞ÊçÆÊòØÂê¶ÊúâÊïàÔºåËøáÊª§Á©∫ÂÄº
                        if (msgRecord.messageData && typeof msgRecord.messageData === 'object') {
                        chatMessages[characterId].push(msgRecord.messageData);
                        }
                    }
                    
                    // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÂπ∂Ê∏ÖÁêÜÁ©∫ÂÄº
                    for (const characterId in chatMessages) {
                        // üî•„ÄêÊñ∞Â¢û„ÄëËøáÊª§Êéânull„ÄÅundefinedÊàñÊó†ÊïàÁöÑÊ∂àÊÅØ
                        chatMessages[characterId] = chatMessages[characterId]
                            .filter(msg => msg && typeof msg === 'object' && msg.timestamp)
                            .sort((a, b) => a.timestamp - b.timestamp);
                    }
                    
                    console.log('‰ªéIndexedDBÂä†ËΩΩËÅäÂ§©Ê∂àÊÅØ:', chatMessages);
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªélocalStorageÂä†ËΩΩ
                const localStorageData = localStorage.getItem('chatMessages');
                if (localStorageData) {
                    chatMessages = JSON.parse(localStorageData);
                    console.log('‰ªélocalStorageÂ§á‰ªΩÂä†ËΩΩËÅäÂ§©Ê∂àÊÅØ:', chatMessages);
                } else {
                    chatMessages = {};
                }
            }
        }
        
        // Èò≤Êäñ‰øùÂ≠òËÆ°Êó∂Âô®
        let saveMessagesTimer = null;
        let isSaving = false; // Èò≤Ê≠¢Âπ∂Âèë‰øùÂ≠ò
        
        // Èò≤ÊäñÁâàÊú¨ÁöÑ‰øùÂ≠òÂáΩÊï∞
        function saveChatMessages() {
            // Ê∏ÖÈô§‰πãÂâçÁöÑËÆ°Êó∂Âô®
            if (saveMessagesTimer) {
                clearTimeout(saveMessagesTimer);
            }
            
            // ËÆæÁΩÆÊñ∞ÁöÑËÆ°Êó∂Âô®Ôºå500msÂêéÊâßË°å‰øùÂ≠ò
            saveMessagesTimer = setTimeout(async () => {
                if (isSaving) {
                    console.log('Ê≠£Âú®‰øùÂ≠ò‰∏≠ÔºåË∑≥ËøáÊ≠§Ê¨°‰øùÂ≠òËØ∑Ê±Ç');
                    return;
                }
                await saveChatMessagesImmediate();
            }, 500);
        }
        
        // Á´ãÂç≥‰øùÂ≠òËÅäÂ§©Ê∂àÊÅØ - ‰ΩøÁî®IndexedDB
        async function saveChatMessagesImmediate() {
            if (isSaving) {
                console.log('‰øùÂ≠òÊìç‰ΩúÊ≠£Âú®ËøõË°å‰∏≠ÔºåË∑≥Ëøá');
                return;
            }
            
            isSaving = true;
            
            try {
                console.log('‰øùÂ≠òËÅäÂ§©Ê∂àÊÅØÂà∞IndexedDB');
                
                // Â∞ÜchatMessagesÂØπË±°ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®
                const messageArray = [];
                let globalSequentialId = 0; // ÂÖ®Â±ÄÈ°∫Â∫èIDÁ°Æ‰øùÂîØ‰∏ÄÊÄß
                const usedIds = new Set(); // Áî®‰∫éÊ£ÄÊµãIDÈáçÂ§ç
                
                for (const [characterId, messages] of Object.entries(chatMessages)) {
                    for (let i = 0; i < messages.length; i++) {
                        const message = messages[i];
                        
                        // ÁîüÊàêÂîØ‰∏ÄÁöÑ‰∏ªÈîÆ
                        let uniqueId = `${characterId}_${globalSequentialId++}`;
                        
                        // Á°Æ‰øùIDÁªùÂØπÂîØ‰∏Ä
                        while (usedIds.has(uniqueId)) {
                            uniqueId = `${characterId}_${globalSequentialId++}`;
                        }
                        usedIds.add(uniqueId);
                        
                        messageArray.push({
                            id: uniqueId,
                            characterId: characterId,
                            timestamp: message.timestamp,
                            messageOrder: i,
                            originalMessageId: message.id, // ‰øùÁïôÂéüÂßãÊ∂àÊÅØID‰Ωú‰∏∫Êï∞ÊçÆ
                            messageData: message
                        });
                    }
                }
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊ∂àÊÅØ
                await db.chatMessages.clear();
                
                // ÊâπÈáèÊèíÂÖ•Êñ∞Ê∂àÊÅØ
                if (messageArray.length > 0) {
                    await db.chatMessages.bulkAdd(messageArray);
                }
                
                console.log('ËÅäÂ§©Ê∂àÊÅØ‰øùÂ≠òÊàêÂäüÔºåÂÖ±‰øùÂ≠ò', messageArray.length, 'Êù°Ê∂àÊÅØ');
            } catch (error) {
                console.error('‰øùÂ≠òËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•:', error);
                
                // Â¶ÇÊûúÊâπÈáè‰øùÂ≠òÂ§±Ë¥•Ôºå‰ΩøÁî®ÁÆÄÂåñÁöÑÈáçËØïÊú∫Âà∂
                try {
                    console.log('‰ΩøÁî®ÁÆÄÂåñ‰øùÂ≠òÁ≠ñÁï•ÈáçËØï...');
                    await db.chatMessages.clear();
                    
                    // Âè™‰øùÂ≠òÊúÄËøëÁöÑ1000Êù°Ê∂àÊÅØÔºåÈÅøÂÖçËøáÂ§ßÁöÑÊï∞ÊçÆÈõÜ
                    const messageArray = [];
                    let globalSequentialId = 0;
                    let totalMessages = 0;
                    
                    // ÂÖàËÆ°ÁÆóÊÄªÊ∂àÊÅØÊï∞
                    for (const messages of Object.values(chatMessages)) {
                        totalMessages += messages.length;
                    }
                    
                    const maxMessages = 1000;
                    const skipCount = Math.max(0, totalMessages - maxMessages);
                    let currentSkip = 0;
                    
                    for (const [characterId, messages] of Object.entries(chatMessages)) {
                        for (let i = 0; i < messages.length; i++) {
                            if (currentSkip < skipCount) {
                                currentSkip++;
                                continue;
                            }
                            
                            const message = messages[i];
                            messageArray.push({
                                id: `${characterId}_${globalSequentialId++}`,
                                characterId: characterId,
                                timestamp: message.timestamp,
                                messageOrder: i,
                                originalMessageId: message.id,
                                messageData: message
                            });
                        }
                    }
                    
                    if (messageArray.length > 0) {
                        await db.chatMessages.bulkAdd(messageArray);
                    }
                    
                    console.log('ÁÆÄÂåñ‰øùÂ≠òÊàêÂäüÔºå‰øùÂ≠ò‰∫Ü', messageArray.length, 'Êù°Ê∂àÊÅØ');
                } catch (fallbackError) {
                    console.error('ÁÆÄÂåñ‰øùÂ≠ò‰πüÂ§±Ë¥•:', fallbackError);
                }
            } finally {
                isSaving = false;
            }
        }
        

        
        // Âä†ËΩΩËÅäÂ§©ËÆæÁΩÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadChatSettings() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedChatSettings = await db.chatSettings.toArray();
                
                if (savedChatSettings.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('chatSettings');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑËÅäÂ§©ËÆæÁΩÆÊï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localSettings = JSON.parse(localStorageData);
                        
                        // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®Âà∞IndexedDB
                        const settingsArray = Object.keys(localSettings).map(chatId => ({
                            id: chatId,
                            chatId: chatId,
                            settings: localSettings[chatId]
                        }));
                        
                        if (settingsArray.length > 0) {
                            await db.chatSettings.bulkAdd(settingsArray);
                            console.log('ËÅäÂ§©ËÆæÁΩÆÊï∞ÊçÆËøÅÁßªÂÆåÊàê:', settingsArray);
                        }
                        
                        chatSettings = localSettings;
                    } else {
                        chatSettings = {};
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    console.log('‰ªéIndexedDBÂä†ËΩΩËÅäÂ§©ËÆæÁΩÆÊï∞ÊçÆ:', savedChatSettings);
                    chatSettings = {};
                    savedChatSettings.forEach(item => {
                        chatSettings[item.chatId] = item.settings;
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('chatSettings');
                if (localStorageData) {
                    chatSettings = JSON.parse(localStorageData);
                    console.log('‰ªélocalStorageÂ§á‰ªΩÂä†ËΩΩËÅäÂ§©ËÆæÁΩÆ:', chatSettings);
                } else {
                    chatSettings = {};
                }
            }
        }
        
        // ‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆ - ‰ΩøÁî®IndexedDBÈÅøÂÖçlocalStorageÂÆπÈáèÈôêÂà∂
        async function saveChatSettings() {
            try {
                // Â∞ÜchatSettingsÂØπË±°ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®Âà∞IndexedDB
                const chatSettingsArray = Object.keys(chatSettings).map(chatId => ({
                    id: chatId,
                    chatId: chatId,
                    settings: chatSettings[chatId]
                }));
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆÂπ∂Â≠òÂÇ®Êñ∞Êï∞ÊçÆ
                await db.chatSettings.clear();
                if (chatSettingsArray.length > 0) {
                    await db.chatSettings.bulkAdd(chatSettingsArray);
                }
                
                console.log('ËÅäÂ§©ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞IndexedDB');
            } catch (error) {
                console.error('‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆÂà∞IndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage:', error);
                
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØïÂéãÁº©Êï∞ÊçÆÂêéÂ≠òÂÇ®Âà∞localStorage
                try {
                    // ÂàõÂª∫‰∏Ä‰∏™Á≤æÁÆÄÁâàÁöÑËÆæÁΩÆÔºåÁßªÈô§ÂèØËÉΩÂæàÂ§ßÁöÑÂõæÁâáÊï∞ÊçÆ
                    const compressedSettings = {};
                    Object.keys(chatSettings).forEach(chatId => {
                        compressedSettings[chatId] = { ...chatSettings[chatId] };
                        
                        // ‰∏çÂÜçËá™Âä®ÁßªÈô§Â§¥ÂÉèÔºåÂõ†‰∏∫IndexedDBÊúâË∂≥Â§üÁöÑÂ≠òÂÇ®Á©∫Èó¥
                        // Â¶ÇÊûúÁúüÁöÑÈúÄË¶ÅÂéãÁº©ÔºåÁî®Êà∑ÂèØ‰ª•ÊâãÂä®ÈÄâÊã©
                        console.log(`ËÅäÂ§©${chatId}ËÆæÁΩÆÂ§ßÂ∞è:`, JSON.stringify(compressedSettings[chatId]).length);
                    });
                    
                    localStorage.setItem('chatSettings', JSON.stringify(compressedSettings));
                    console.log('Â∑≤‰ΩøÁî®ÂéãÁº©ÁâàËÅäÂ§©ËÆæÁΩÆ‰øùÂ≠òÂà∞localStorage');
                } catch (localStorageError) {
                    console.error('localStorage‰πüÊó†Ê≥ï‰øùÂ≠òÔºåÂ≠òÂÇ®Á©∫Èó¥ÂèØËÉΩÂ∑≤Êª°:', localStorageError);
                    
                    // ÊòæÁ§∫Áî®Êà∑ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
                    alert('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºÅ\n\nÂèØËÉΩÁöÑËß£ÂÜ≥ÊñπÊ°àÔºö\n1. Ê∏ÖÁêÜÊµèËßàÂô®ÁºìÂ≠ò\n2. Âà†Èô§‰∏Ä‰∫õ‰∏çÂøÖË¶ÅÁöÑËÅäÂ§©ËÆ∞ÂΩï\n3. ÂáèÂ∞ë‰ΩøÁî®Â§ßÂ∞∫ÂØ∏ÁöÑÂ§¥ÂÉèÂõæÁâá\n\nÂΩìÂâçËÆæÁΩÆÂèØËÉΩÊó†Ê≥ï‰øùÂ≠ò„ÄÇ');
                    throw localStorageError;
                }
            }
        }
        
        // === ÂêéÂè∞‰∫íÂä®Á≥ªÁªü ===
        let backgroundTimers = {};

        // ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
        function initBackgroundInteractionSystem() {
            if (!currentChatCharacter) return;
            
            clearAllBackgroundTimers();
            
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.backgroundInteractionEnabled) return;
            
            const characterId = currentChatCharacter.id;
            
            // ËÆæÁΩÆ‰∏ªÂä®ËÅäÂ§©ÂÆöÊó∂Âô®
            if (chatSettings.backgroundChatEnabled) {
                const chatInterval = getBackgroundInterval(chatSettings.backgroundChatFrequency || 'low');
                backgroundTimers[characterId + '_chat'] = setInterval(() => {
                    triggerBackgroundChat(characterId);
                }, chatInterval);
                
                console.log(`${currentChatCharacter.name} ‰∏ªÂä®ËÅäÂ§©Â∑≤ÂêØÁî®ÔºåÈó¥Èöî: ${Math.round(chatInterval/60000)}ÂàÜÈíü`);
            }
            
            // ËÆæÁΩÆ‰∏ªÂä®ÂèëÂä®ÊÄÅÂÆöÊó∂Âô®
            if (chatSettings.backgroundMomentsEnabled) {
                const momentsInterval = getBackgroundMomentsInterval(chatSettings.backgroundMomentsFrequency || 'low');
                backgroundTimers[characterId + '_moments'] = setInterval(() => {
                    triggerBackgroundMoments(characterId);
                }, momentsInterval);
                
                console.log(`${currentChatCharacter.name} ‰∏ªÂä®ÂèëÂä®ÊÄÅÂ∑≤ÂêØÁî®ÔºåÈó¥Èöî: ${Math.round(momentsInterval/60000)}ÂàÜÈíü`);
            }
        }

        // Ê∏ÖÈô§ÊâÄÊúâÂêéÂè∞ÂÆöÊó∂Âô®
        function clearAllBackgroundTimers() {
            Object.values(backgroundTimers).forEach(timer => {
                if (timer) clearInterval(timer);
            });
            backgroundTimers = {};
        }

        // Ëé∑ÂèñÂêéÂè∞ËÅäÂ§©Èó¥ÈöîÊó∂Èó¥
        function getBackgroundInterval(frequency) {
            switch (frequency) {
                case 'low':
                    return Math.random() * 60 * 60 * 1000 + 60 * 60 * 1000; // 1-2Â∞èÊó∂
                case 'medium':
                    return Math.random() * 30 * 60 * 1000 + 30 * 60 * 1000; // 30-60ÂàÜÈíü
                case 'high':
                    return Math.random() * 20 * 60 * 1000 + 10 * 60 * 1000; // 10-30ÂàÜÈíü
                default:
                    return Math.random() * 60 * 60 * 1000 + 60 * 60 * 1000; // ÈªòËÆ§1-2Â∞èÊó∂
            }
        }

        // Ëé∑ÂèñÂêéÂè∞Âä®ÊÄÅÈó¥ÈöîÊó∂Èó¥
        function getBackgroundMomentsInterval(frequency) {
            switch (frequency) {
                case 'low':
                    return Math.random() * 4 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000; // 4-8Â∞èÊó∂
                case 'medium':
                    return Math.random() * 2 * 60 * 60 * 1000 + 2 * 60 * 60 * 1000; // 2-4Â∞èÊó∂
                case 'high':
                    return Math.random() * 60 * 60 * 1000 + 60 * 60 * 1000; // 1-2Â∞èÊó∂
                default:
                    return Math.random() * 4 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000; // ÈªòËÆ§4-8Â∞èÊó∂
            }
        }

        // Ëß¶ÂèëÂêéÂè∞ËÅäÂ§©
        async function triggerBackgroundChat(characterId) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;
                
                // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Ëá≥Â∞ë10ÂàÜÈíüÊ≤°ÊúâÂõûÂ§ç
                const messages = chatMessages[characterId] || [];
                const lastUserMessage = messages.slice().reverse().find(msg => msg.sender === 'user');
                
                if (lastUserMessage) {
                    const timeSinceLastUserMessage = Date.now() - lastUserMessage.timestamp;
                    const tenMinutes = 10 * 60 * 1000; // 10ÂàÜÈíü
                    if (timeSinceLastUserMessage < tenMinutes) {
                        console.log(`${character.name} Ë∑≥Ëøá‰∏ªÂä®ËÅäÂ§©ÔºöÁî®Êà∑ÊúÄËøë${Math.round(timeSinceLastUserMessage / 60000)}ÂàÜÈíüÂâçÊúâÂõûÂ§ç`);
                        return; // Áî®Êà∑ÊúÄËøëÊúâÊ¥ªÂä®Ôºå‰∏çÂèëÈÄÅËá™Âä®Ê∂àÊÅØ
                    }
                }
                
                const chatSettings = getCurrentChatSettings();
                
                // Ëé∑ÂèñÊúÄËøëÁöÑËÅäÂ§©ÂéÜÂè≤
                const maxMemory = chatSettings.historyCount || 5;
                const recentMessages = messages.slice(-maxMemory);
                
                // Ëé∑ÂèñÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπ
                const recentMoments = await getRecentMoments(5);
                let momentsContext = '';
                if (recentMoments.length > 0) {
                    momentsContext = '\n\nÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºö\n' + 
                        recentMoments.map(moment => `${moment.nickname}: ${moment.text}`).join('\n');
                }
                
                // ÊûÑÂª∫ËÅäÂ§©ÂéÜÂè≤‰∏ä‰∏ãÊñá
                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºö\n' + 
                        recentMessages.map(msg => {
                            if (msg.sender === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            if (msg.sender === 'ai') return `${character.name}Ôºö${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n');
                }
                
                // ÁîüÊàê‰∏ªÂä®ËÅäÂ§©ÂÜÖÂÆπ
                const prompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${character.bio}„ÄÇ

Áé∞Âú®‰Ω†Ë¶Å‰∏ªÂä®ÁªôÁî®Êà∑ÂèëÈÄÅ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇËøôÊù°Ê∂àÊÅØÂ∫îËØ•ÊòØÔºö
1. Á¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊÄßÊ†º
2. Ëá™ÁÑ∂„ÄÅÊúâË∂£„ÄÅÊúâ‰∫íÂä®ÊÄß
3. ÂèØ‰ª•ÊòØÈóÆÂÄô„ÄÅÂàÜ‰∫´„ÄÅËØ¢ÈóÆÁ≠â
4. ‰∏çË¶ÅËøá‰∫éÊ≠£ÂºèÔºåË¶ÅÂÉèÊúãÂèãÈó¥ÁöÑÊó•Â∏∏ËÅäÂ§©
5. Â¶ÇÊûúÊúâËÅäÂ§©ÂéÜÂè≤ÔºåË¶ÅÂü∫‰∫éÂéÜÂè≤ÂÜÖÂÆπËøõË°åËá™ÁÑ∂ÁöÑÂª∂Áª≠ÊàñÂõûÂ∫î
6. ÂèØ‰ª•ÈÄÇÂΩìÊèêÂèäÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºåËÆ©ÂØπËØùÊõ¥Ëá™ÁÑ∂${chatContext}${momentsContext}

ËØ∑ÁîüÊàê‰∏ÄÊù°‰∏ªÂä®ËÅäÂ§©ÁöÑÊ∂àÊÅØÔºö`;

                const content = await generateAIResponse(prompt, character);
                if (content && content.trim()) {
                    // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
                    const message = {
                        id: Date.now().toString(),
                        sender: 'ai',
                        content: content.trim(),
                        timestamp: Date.now()
                    };
                    
                    if (!chatMessages[characterId]) {
                        chatMessages[characterId] = [];
                    }
                    
                    chatMessages[characterId].push(message);
                    saveChatMessages();
                    
                    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ÂíåËøô‰∏™ËßíËâ≤ËÅäÂ§©ÔºåÁ´ãÂç≥ÊòæÁ§∫Ê∂àÊÅØ
                    if (currentChatCharacter && currentChatCharacter.id === characterId) {
                        renderChatMessages(characterId);
                    }
                    
                    // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                    renderMessageList();
                    
                    console.log(`${character.name} ‰∏ªÂä®ÂèëÈÄÅ‰∫ÜÊ∂àÊÅØ: ${content.substring(0, 50)}...`);
                }
            } catch (error) {
                console.error('ÂêéÂè∞ËÅäÂ§©Â§±Ë¥•:', error);
            }
        }

        // Ëß¶ÂèëÂêéÂè∞ÂèëÂä®ÊÄÅÔºàÊµãËØïÁâàÊú¨ÔºåË∑≥ËøáÂÜ∑Âç¥Êó∂Èó¥Ôºâ
        async function triggerBackgroundMomentsTest(characterId) {
            console.log(`ÊµãËØïÂèëÂ∏É: Ë∑≥ËøáÂÜ∑Âç¥Êó∂Èó¥Ê£ÄÊü•`);
            // Áõ¥Êé•Ë∞ÉÁî®Ê≠£Â∏∏ÂèëÂ∏ÉÂáΩÊï∞Ôºå‰ΩÜË∑≥ËøáÂÜ∑Âç¥Êó∂Èó¥Ê£ÄÊü•
            await triggerBackgroundMoments(characterId, true);
        }

        // Ëß¶ÂèëÂêéÂè∞ÂèëÂä®ÊÄÅ
        async function triggerBackgroundMoments(characterId, skipCooldown = false) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;
                
                // Ê£ÄÊü•ÂÜ∑Âç¥Êó∂Èó¥ÔºàÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÈáçÂ§çÂèëÂ∏ÉÔºâ
                if (!skipCooldown) {
                    const lastMomentTime = character.lastMomentTime || 0;
                    const cooldownTime = 30 * 60 * 1000; // 30ÂàÜÈíüÂÜ∑Âç¥Êó∂Èó¥
                    if (Date.now() - lastMomentTime < cooldownTime) {
                        console.log(`${character.name} Âú®ÂÜ∑Âç¥Êó∂Èó¥ÂÜÖÔºåË∑≥ËøáÂèëÂ∏ÉÂä®ÊÄÅ`);
                        return;
                    }
                } else {
                    console.log(`${character.name} ÊµãËØïÂèëÂ∏É: Ë∑≥ËøáÂÜ∑Âç¥Êó∂Èó¥Ê£ÄÊü•`);
                }
                
                const chatSettings = getCurrentChatSettings();
                
                // Ëé∑ÂèñÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩï
                const messages = chatMessages[characterId] || [];
                const maxMemory = chatSettings.historyCount || 5;
                const recentMessages = messages.slice(-maxMemory);
                
                // Ëé∑ÂèñÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπ
                const recentMoments = await getRecentMoments(5);
                
                // ÊûÑÂª∫‰∏ä‰∏ãÊñá
                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºö\n' + 
                        recentMessages.map(msg => {
                            if (msg.sender === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            if (msg.sender === 'ai') return `${character.name}Ôºö${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n');
                }
                
                let momentsContext = '';
                if (recentMoments.length > 0) {
                    momentsContext = '\n\nÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºö\n' + 
                        recentMoments.map(moment => `${moment.nickname}: ${moment.text}`).join('\n');
                }
                
                // ÁîüÊàêÂä®ÊÄÅÂÜÖÂÆπ
                const prompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${character.bio}„ÄÇ

Áé∞Âú®‰Ω†Ë¶ÅÂèëÂ∏É‰∏ÄÊù°Âä®ÊÄÅ„ÄÇËøôÊù°Âä®ÊÄÅÂ∫îËØ•ÊòØÔºö
1. Á¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊÄßÊ†º
2. ÁîüÊ¥ªÂåñ„ÄÅÊúâË∂£„ÄÅÊúâ‰∏™ÊÄß
3. 50-200Â≠óÂ∑¶Âè≥
4. ÂèØ‰ª•ÊòØÂøÉÊÉÖ„ÄÅÊÑüÊÇü„ÄÅÊó•Â∏∏„ÄÅÂàÜ‰∫´Á≠â
5. ÂèØ‰ª•ÁªìÂêàÊúÄËøëÁöÑËÅäÂ§©ÊàñÂä®ÊÄÅÂÜÖÂÆπ‰Ωú‰∏∫ÁÅµÊÑü
6. Ë¶ÅÊúâ‰Ω†Áã¨ÁâπÁöÑÈ£éÊ†ºÔºå‰∏çËÉΩÂíåÂÖ∂‰ªñËßíËâ≤Ê∑∑Ê∑Ü
7. ÊîØÊåÅÊç¢Ë°åÊòæÁ§∫ÔºåÂèØ‰ª•ÈÄÇÂΩìÂàÜÊÆµËÆ©ÂÜÖÂÆπÊõ¥ÊòìËØª
8. ÂèØ‰ª•ÈÄâÊã©ÊÄßÂú∞ÈÖçÂõæÔºåÂ¶ÇÊûúÊÉ≥Ë¶ÅÈÖçÂõæÔºåËØ∑Áõ¥Êé•Êç¢Ë°åÔºåÁÑ∂ÂêéÁî®Êñú‰ΩìÊ†ºÂºèÂÜôÔºö*[ÈÖçÂõæÔºöËØ¶ÁªÜÁöÑÂõæÁâáÊèèËø∞]*

## ÈÖçÂõæËßÑÂàôÔºàÈÅµÂæ™ÔºâÔºö
- ‰∏çÈúÄË¶ÅÊØèÊù°Âä®ÊÄÅÈÉΩÈÖçÂõæÔºåÂè™ÊúâÂΩìÂÜÖÂÆπÁúüÁöÑÈÄÇÂêàÈÖçÂõæÊó∂ÊâçÊ∑ªÂä†ÈÖçÂõæÊèèËø∞
- ÂõæÁâáÊèèËø∞Ë¶ÅÁîüÂä®„ÄÅÂÖ∑‰ΩìÔºåËÆ©‰∫∫ËÉΩÈÄöËøáÊñáÂ≠óÊÉ≥Ë±°Âá∫ÁîªÈù¢
- ‰ª•Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÊèèËø∞Ôºå‰æãÂ¶ÇÔºö*[ÈÖçÂõæÔºöÁÖßÁâáÈáå‰∏ÄÂè™Ê©òÁå´Ê≠£ÊáíÊ¥ãÊ¥ãÂú∞Ë∂¥Âú®Á™óÂè∞‰∏äÊôíÂ§™Èò≥ÔºåÈò≥ÂÖâÊääÂÆÉÈáëËâ≤ÁöÑÊØõÁÖßÂæóÂèë‰∫ÆÔºåËÉåÊôØÊòØËîöËìùÁöÑÂ§©Á©∫ÂíåÂá†ÊúµÁôΩ‰∫ë„ÄÇ]*
- ÂõæÁâáÊèèËø∞Ë¶ÅÁ¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºÂíåÂΩìÂâçÊÉÖÂ¢É

${chatContext}${momentsContext}

ËØ∑ÁîüÊàê‰∏ÄÊù°Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºö`;

                const content = await generateAIResponse(prompt, character);
                if (content && content.trim()) {
                    // Ëé∑ÂèñÂ§¥ÂÉèÔºåÁ°Æ‰øùÂÆâÂÖ®
                    const avatar = getCharacterAvatar(character);
                    console.log(`${character.name} ${skipCooldown ? 'ÊµãËØï' : 'Ê≠£Â∏∏'}ÂèëÂ∏ÉÂä®ÊÄÅÊó∂Ëé∑ÂèñÁöÑÂ§¥ÂÉè:`, avatar ? avatar.substring(0, 50) + '...' : 'null');
                    
                    // ÂèëÂ∏ÉÂä®ÊÄÅ
                    const moment = {
                        id: Date.now(),  // ‰ΩøÁî®Êï∞Â≠óIDËÄå‰∏çÊòØÂ≠óÁ¨¶‰∏≤
                        authorId: characterId,
                        nickname: character.name,
                        avatar: avatar, // ËßíËâ≤Â§¥ÂÉè
                        text: content.trim(),
                        time: formatTime(new Date()),
                        timestamp: Date.now(),
                        characterId: characterId
                    };
                    
                    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                    await db.moments.add(moment);
                    
                    // ËÆ∞ÂΩïÂèëÂ∏ÉÊó∂Èó¥
                    character.lastMomentTime = Date.now();
                    saveCharacters();
                    
                    // Âº∫Âà∂Âà∑Êñ∞Âä®ÊÄÅÊòæÁ§∫ÔºàÊó†ËÆ∫ÂΩìÂâçÂú®Âì™‰∏™È°µÈù¢Ôºâ
                    setTimeout(() => {
                        loadMoments();
                    }, 100);
                    
                    console.log(`${character.name} ${skipCooldown ? 'ÊµãËØï' : 'Ê≠£Â∏∏'}ÂèëÂ∏É‰∫ÜÂä®ÊÄÅ: ${content.substring(0, 50)}...`);
                }
            } catch (error) {
                console.error('ÂêéÂè∞ÂèëÂä®ÊÄÅÂ§±Ë¥•:', error);
            }
        }

        // Ëé∑ÂèñÊúÄËøëÁöÑÂä®ÊÄÅ
        async function getRecentMoments(count = 5) {
            try {
                // ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÊúÄÊñ∞ÁöÑÂä®ÊÄÅÊï∞ÊçÆ
                const momentsData = await db.moments.orderBy('timestamp').reverse().limit(count).toArray();
                return momentsData || [];
            } catch (error) {
                console.error('Ëé∑ÂèñÊúÄËøëÂä®ÊÄÅÂ§±Ë¥•:', error);
                return [];
            }
        }

        // ÁîüÊàêAIÂìçÂ∫îÁöÑÂåÖË£ÖÂáΩÊï∞ÔºåÁî®‰∫éÂêéÂè∞‰∫íÂä®
        async function generateAIResponse(prompt, character) {
            try {
                // ‰ΩøÁî®Áé∞ÊúâÁöÑ callChatAPI ÂáΩÊï∞
                const response = await callChatAPI(prompt, character);
                return response;
            } catch (error) {
                console.error('AIÂìçÂ∫îÁîüÊàêÂ§±Ë¥•:', error);
                return null;
            }
        }

        // È™åËØÅÂ§¥ÂÉèURLÊòØÂê¶ÊúâÊïà
        function isValidAvatarUrl(url) {
            if (!url || typeof url !== 'string') return false;
            
            // Ê£ÄÊü•base64Ê†ºÂºè
            if (url.startsWith('data:image/')) {
                // Êõ¥ÂÆΩÊùæÁöÑbase64È™åËØÅÔºåÂè™Ê£ÄÊü•Âü∫Êú¨ÁªìÊûÑ
                const parts = url.split(',');
                if (parts.length !== 2) {
                    console.warn('base64Â§¥ÂÉèURLÊ†ºÂºèÈîôËØØÔºàÁº∫Â∞ëÈÄóÂè∑ÂàÜÈöîÔºâ:', url.substring(0, 50) + '...');
                    return false;
                }
                
                const header = parts[0];
                const data = parts[1];
                
                // Ê£ÄÊü•headerÊòØÂê¶ÂåÖÂê´ÂøÖË¶Å‰ø°ÊÅØ
                if (!header.includes('data:image/') || !header.includes('base64')) {
                    console.warn('base64Â§¥ÂÉèURLÂ§¥ÈÉ®Ê†ºÂºèÈîôËØØ:', header);
                    return false;
                }
                
                // Ê£ÄÊü•base64Êï∞ÊçÆÊòØÂê¶‰∏∫Á©∫ÊàñËøáÈïø
                if (!data || data.length < 50) {
                    console.warn('base64Â§¥ÂÉèÊï∞ÊçÆ‰∏∫Á©∫ÊàñËøáÁü≠:', data.length);
                    return false;
                }
                
                if (data.length > 2000000) { // 2MBÈôêÂà∂ÔºåÊõ¥ÂÆΩÊùæ
                    console.warn('base64Â§¥ÂÉèÊï∞ÊçÆËøáÂ§ß:', data.length, 'Âª∫ËÆÆÂéãÁº©ÂêéÈáçÊñ∞‰∏ä‰º†‰ª•ÊèêÈ´òÊÄßËÉΩ');
                    // ‰∏çÂÜçÁõ¥Êé•ÊãíÁªùÔºåÂè™ÊòØË≠¶Âëä
                }
                
                // ÁÆÄÂçïÊ£ÄÊü•base64Â≠óÁ¨¶ÊòØÂê¶ÂêàÊ≥ï
                const base64Chars = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Chars.test(data)) {
                    console.warn('base64Â§¥ÂÉèÊï∞ÊçÆÂåÖÂê´ÈùûÊ≥ïÂ≠óÁ¨¶');
                    return false;
                }
                
                return true;
            }
            
            // Ê£ÄÊü•HTTP(S) URLÊ†ºÂºè
            if (url.startsWith('http://') || url.startsWith('https://')) {
                try {
                    new URL(url);
                    return true;
                } catch (error) {
                    console.warn('Êó†ÊïàÁöÑHTTPÂ§¥ÂÉèURL:', url);
                    return false;
                }
            }
            
            // Â¶ÇÊûú‰∏çÊòØdata:imageÊàñhttp(s)ÂºÄÂ§¥ÔºåËÄÉËôëÂèØËÉΩÊòØÂÖ∂‰ªñÊúâÊïàÊ†ºÂºè
            console.warn('Êú™Áü•ÁöÑÂ§¥ÂÉèURLÊ†ºÂºè:', url.substring(0, 50) + '...');
            return false;
        }

        // Ëé∑ÂèñËßíËâ≤ÁöÑÂ§¥ÂÉèÔºàÁî®‰∫éÂä®ÊÄÅÂèëÂ∏ÉÔºâ
        function getCharacterAvatar(character) {
            // ‰ΩøÁî®ÂêåÊ≠•ÁâàÊú¨ÁöÑËÆæÁΩÆËé∑ÂèñÔºåÈÅøÂÖçPromiseÈóÆÈ¢ò
            const chatSettings = getChatSettingsSync(character.id);
            
            // ‰ºòÂÖàÁ∫ß1ÔºöÂ¶ÇÊûúËßíËâ≤ÊúâËÅäÂ§©Á™óÂè£ÁöÑÂä®ÊÄÅÂ§¥ÂÉèËÆæÁΩÆÔºå‰ΩøÁî®ÈÇ£‰∏™
            if (chatSettings.aiDynamicAvatar && chatSettings.aiDynamicAvatar.trim()) {
                const avatar = chatSettings.aiDynamicAvatar;
                if (isValidAvatarUrl(avatar)) {
                    return avatar;
                } else {
                    console.warn(`ËßíËâ≤${character.name}ÁöÑÂä®ÊÄÅÂ§¥ÂÉèÊó†ÊïàÔºåÂ∞ùËØï‰ΩøÁî®ÂÖ∂‰ªñÂ§¥ÂÉè`);
                }
            }
            
            // ‰ºòÂÖàÁ∫ß2ÔºöÂ¶ÇÊûúËßíËâ≤ÊúâËÅäÂ§©Á™óÂè£ÁöÑÂ§¥ÂÉèËÆæÁΩÆÔºå‰ΩøÁî®ÈÇ£‰∏™
            if (chatSettings.aiChatAvatar && chatSettings.aiChatAvatar.trim()) {
                const avatar = chatSettings.aiChatAvatar;
                if (isValidAvatarUrl(avatar)) {
                    return avatar;
                } else {
                    console.warn(`ËßíËâ≤${character.name}ÁöÑËÅäÂ§©Â§¥ÂÉèÊó†ÊïàÔºåÂ∞ùËØï‰ΩøÁî®ËßíËâ≤Âç°Â§¥ÂÉè`);
                }
            }
            
            // ‰ºòÂÖàÁ∫ß3Ôºö‰ΩøÁî®ËßíËâ≤Âç°ÈáåÁöÑÂ§¥ÂÉè
            if (character.avatarUrl && character.avatarUrl.trim()) {
                const avatar = character.avatarUrl;
                if (isValidAvatarUrl(avatar)) {
                    return avatar;
                } else {
                    console.warn(`ËßíËâ≤${character.name}ÁöÑËßíËâ≤Âç°Â§¥ÂÉèÊó†ÊïàÔºåÂ§ßÂ∞èÊàñÊ†ºÂºèÈóÆÈ¢ò`);
                }
            }
            
            console.log(`ËßíËâ≤${character.name}Ê≤°ÊúâÂèØÁî®ÁöÑÂ§¥ÂÉè`);
            return null;
        }

        // Ëé∑ÂèñÊåáÂÆöËßíËâ≤ÁöÑËÅäÂ§©ËÆæÁΩÆ - ‰ΩøÁî®IndexedDB
        async function getChatSettings(characterId) {
            try {
                const chatSettingsRecord = await db.chatSettings.get(characterId);
                if (chatSettingsRecord) {
                    return chatSettingsRecord.settings;
                }
                
                // Â¶ÇÊûúIndexedDB‰∏≠Ê≤°ÊúâÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                const savedSettings = localStorage.getItem(`chatSettings_${characterId}`);
                if (savedSettings) {
                    console.log(`ËøÅÁßªËßíËâ≤ ${characterId} ÁöÑËÅäÂ§©ËÆæÁΩÆÂà∞IndexedDB`);
                    const settings = JSON.parse(savedSettings);
                    
                    // ‰øùÂ≠òÂà∞IndexedDB
                    await db.chatSettings.put({
                        id: characterId,
                        chatId: characterId,
                        settings: settings
                    });
                    
                    return settings;
                }
                
                return {};
            } catch (error) {
                console.error('Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                // ÂõûÈÄÄÂà∞localStorage
                const savedSettings = localStorage.getItem(`chatSettings_${characterId}`);
                return savedSettings ? JSON.parse(savedSettings) : {};
            }
        }
        
        // ÂêåÊ≠•ÁâàÊú¨ÁöÑgetChatSettingsÔºàÁî®‰∫é‰∏çÊîØÊåÅasyncÁöÑÂú∞ÊñπÔºâ
        function getChatSettingsSync(characterId) {
            const savedSettings = localStorage.getItem(`chatSettings_${characterId}`);
            return savedSettings ? JSON.parse(savedSettings) : {};
        }

        // Ê†ºÂºèÂåñÂä®ÊÄÅÊñáÂ≠óÔºåÊîØÊåÅÂàÜË°åÂíåÈÖçÂõæÊèèËø∞
        function formatMomentText(text) {
            if (!text) return '';
            
            // ÊõøÊç¢Êç¢Ë°åÁ¨¶‰∏∫<br>Ê†áÁ≠æÔºåÊîØÊåÅÂàÜË°åÊòæÁ§∫
            let formattedText = text.replace(/\n/g, '<br>');
            
            // Â§ÑÁêÜÈÖçÂõæÊèèËø∞ÔºöÂåπÈÖç*[ÈÖçÂõæÔºöÊèèËø∞]*Ê†ºÂºè
            formattedText = formattedText.replace(/\*\[ÈÖçÂõæÔºö([^\]]+)\]\*/g, function(match, description) {
                return `<span style="font-style: italic; color: #999; font-size: 13px; line-height: 1.4;">[ÈÖçÂõæÔºö${description}]</span>`;
            });
            
            return formattedText;
        }

        // Ë∞ÉËØïËßíËâ≤Âä®ÊÄÅÂ§¥ÂÉè
        function debugMomentAvatar(momentId) {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) {
                console.log('Êâæ‰∏çÂà∞Âä®ÊÄÅÂÖÉÁ¥†');
                return;
            }
            
            // ‰ªéIndexedDBËé∑ÂèñÂä®ÊÄÅÊï∞ÊçÆ
            db.moments.get(parseInt(momentId)).then(moment => {
                console.log('=== Âä®ÊÄÅÂ§¥ÂÉèË∞ÉËØï ===');
                console.log('Âä®ÊÄÅID:', momentId);
                console.log('ËßíËâ≤ID:', moment.characterId);
                console.log('‰øùÂ≠òÁöÑÂ§¥ÂÉè:', moment.avatar ? moment.avatar.substring(0, 50) + '...' : 'null');
                
                if (moment.characterId && moment.characterId !== 'user') {
                    const character = characters.find(c => c.id === moment.characterId);
                    if (character) {
                        console.log('ÊâæÂà∞ËßíËâ≤:', character.name);
                        console.log('ËßíËâ≤Âç°Â§¥ÂÉè:', character.avatarUrl ? character.avatarUrl.substring(0, 50) + '...' : 'null');
                    } else {
                        console.log('Êâæ‰∏çÂà∞ËßíËâ≤Êï∞ÊçÆ');
                    }
                }
                
                const avatarImg = momentElement.querySelector('.moment-avatar img');
                if (avatarImg) {
                    console.log('ÂΩìÂâçÊòæÁ§∫ÁöÑÂ§¥ÂÉèURL:', avatarImg.src ? avatarImg.src.substring(0, 50) + '...' : 'null');
                }
            });
        }
        
        // ÁÆÄÂçïÁöÑÂ§¥ÂÉèÊï∞ÊçÆ‰øÆÂ§ç
        async function fixAvatarData() {
            console.log('ÂºÄÂßã‰øÆÂ§çÂ§¥ÂÉèÊï∞ÊçÆ...');
            let fixedCount = 0;
            
            try {
                // Ê∏ÖÁêÜËßíËâ≤ËÆæÁΩÆ‰∏≠ÁöÑÊà™Êñ≠Â§¥ÂÉè
                for (const character of characters) {
                    const chatSettings = await getChatSettings(character.id);
                    let needSave = false;
                    
                    if (chatSettings.aiDynamicAvatar) {
                        const avatar = chatSettings.aiDynamicAvatar;
                        if (avatar.startsWith('data:image/') && !avatar.includes('=') && avatar.split(',').length === 2) {
                            console.log(`Ê∏ÖÁêÜ${character.name}ÁöÑÂä®ÊÄÅÂ§¥ÂÉèËÆæÁΩÆ`);
                            delete chatSettings.aiDynamicAvatar;
                            needSave = true;
                            fixedCount++;
                        }
                    }
                    
                    if (chatSettings.aiChatAvatar) {
                        const avatar = chatSettings.aiChatAvatar;
                        if (avatar.startsWith('data:image/') && !avatar.includes('=') && avatar.split(',').length === 2) {
                            console.log(`Ê∏ÖÁêÜ${character.name}ÁöÑËÅäÂ§©Â§¥ÂÉèËÆæÁΩÆ`);
                            delete chatSettings.aiChatAvatar;
                            needSave = true;
                            fixedCount++;
                        }
                    }
                    
                    if (needSave) {
                        // ‰øùÂ≠òÂà∞IndexedDBËÄå‰∏çÊòØlocalStorage
                        await db.chatSettings.put({
                            id: character.id,
                            chatId: character.id,
                            settings: chatSettings
                        });
                    }
                }
                
                // Ê∏ÖÁêÜÂä®ÊÄÅÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊà™Êñ≠Â§¥ÂÉè
                const allMoments = await db.moments.toArray();
                let momentFixedCount = 0;
                
                for (const moment of allMoments) {
                    if (moment.avatar && moment.avatar.startsWith('data:image/')) {
                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÊà™Êñ≠ÁöÑÂ§¥ÂÉèÔºà‰ª•VNEKhsVJikÁªìÂ∞æÁöÑÊòØÊà™Êñ≠ÁöÑÔºâ
                        if (moment.avatar.endsWith('VNEKhsVJik') || moment.avatar.endsWith('VNEKhsVJik:1') || 
                            (!moment.avatar.includes('=') && moment.avatar.split(',').length === 2)) {
                            console.log(`Ê∏ÖÁêÜÂä®ÊÄÅ ${moment.id} ÁöÑÊà™Êñ≠Â§¥ÂÉè`);
                            await db.moments.update(moment.id, { avatar: null });
                            momentFixedCount++;
                        }
                    }
                }
                
                const totalFixed = fixedCount + momentFixedCount;
                console.log(`‰øÆÂ§çÂÆåÊàê: Ê∏ÖÁêÜ‰∫Ü${fixedCount}‰∏™ËÆæÁΩÆÂ§¥ÂÉè, ${momentFixedCount}‰∏™Âä®ÊÄÅÂ§¥ÂÉè`);
                
                alert(`‰øÆÂ§çÂÆåÊàêÔºÅ\nÊ∏ÖÁêÜ‰∫Ü ${fixedCount} ‰∏™ËÆæÁΩÆ‰∏≠ÁöÑÊà™Êñ≠Â§¥ÂÉè\nÊ∏ÖÁêÜ‰∫Ü ${momentFixedCount} ‰∏™Âä®ÊÄÅ‰∏≠ÁöÑÊà™Êñ≠Â§¥ÂÉè\n\nËØ∑ÈáçÊñ∞‰∏∫ËßíËâ≤ËÆæÁΩÆÂ§¥ÂÉè`);
                
                if (totalFixed > 0) {
                    loadMoments();
                }
            } catch (error) {
                console.error('‰øÆÂ§çÂ§±Ë¥•:', error);
                alert('‰øÆÂ§çÂ§±Ë¥•: ' + error.message);
            }
        }

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÂêéÂè∞ÂÆöÊó∂Âô®
        window.addEventListener('beforeunload', function() {
            clearAllBackgroundTimers();
        });


        // Âä†ËΩΩÂ£ÅÁ∫∏ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadWallpaper() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedWallpaper = await db.wallpapers.get('main');
            
            if (savedWallpaper) {
                    selectedWallpaper = savedWallpaper.data;
                
                    if (savedWallpaper.type === 'image' && savedWallpaper.data.startsWith('data:image')) {
                    // Âä†ËΩΩ‰∏ä‰º†ÁöÑÂõæÁâá
                        document.querySelector('.wallpaper').style.backgroundImage = `url(${savedWallpaper.data})`;
                    } else if (savedWallpaper.type === 'gradient' || savedWallpaper.data.startsWith('linear-gradient')) {
                    // Âä†ËΩΩÊ∏êÂèòËÉåÊôØ
                        document.querySelector('.wallpaper').style.backgroundImage = savedWallpaper.data;
                } else {
                    // Âä†ËΩΩÁ∫ØËâ≤ËÉåÊôØ
                        document.querySelector('.wallpaper').style.backgroundColor = savedWallpaper.data;
                    document.querySelector('.wallpaper').style.backgroundImage = 'none';
                }
                
                document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                } else {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localWallpaper = localStorage.getItem('wallpaper');
                    const wallpaperType = localStorage.getItem('wallpaperType');
                    
                    if (localWallpaper) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑÂ£ÅÁ∫∏Êï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        selectedWallpaper = localWallpaper;
                        
                        // ËøÅÁßªÂà∞IndexedDB
                        await db.wallpapers.add({
                            id: 'main',
                            type: wallpaperType || 'gradient',
                            data: localWallpaper
                        });
                        
                        if (wallpaperType === 'image' && localWallpaper.startsWith('data:image')) {
                            document.querySelector('.wallpaper').style.backgroundImage = `url(${localWallpaper})`;
                        } else if (wallpaperType === 'gradient' || localWallpaper.startsWith('linear-gradient')) {
                            document.querySelector('.wallpaper').style.backgroundImage = localWallpaper;
                        } else {
                            document.querySelector('.wallpaper').style.backgroundColor = localWallpaper;
                            document.querySelector('.wallpaper').style.backgroundImage = 'none';
                        }
                        
                        document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                        document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                        
                        console.log('Â£ÅÁ∫∏Êï∞ÊçÆËøÅÁßªÂÆåÊàê');
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ£ÅÁ∫∏Â§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localWallpaper = localStorage.getItem('wallpaper');
                const wallpaperType = localStorage.getItem('wallpaperType');
                
                if (localWallpaper) {
                    selectedWallpaper = localWallpaper;
                    
                    if (wallpaperType === 'image' && localWallpaper.startsWith('data:image')) {
                        document.querySelector('.wallpaper').style.backgroundImage = `url(${localWallpaper})`;
                    } else if (wallpaperType === 'gradient' || localWallpaper.startsWith('linear-gradient')) {
                        document.querySelector('.wallpaper').style.backgroundImage = localWallpaper;
                    } else {
                        document.querySelector('.wallpaper').style.backgroundColor = localWallpaper;
                        document.querySelector('.wallpaper').style.backgroundImage = 'none';
                    }
                    
                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                }
            }
        }
        
        // Âä†ËΩΩÂ∫îÁî®ÂõæÊ†á - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadAppIcons() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedIcons = await db.appIcons.toArray();
                
                if (savedIcons.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('appIcons');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑÂ∫îÁî®ÂõæÊ†áÊï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localIcons = JSON.parse(localStorageData);
                        
                        // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®Âà∞IndexedDB
                        const iconArray = Object.keys(localIcons).map(appId => ({
                            id: appId,
                            appId: appId,
                            iconClass: localIcons[appId]
                        }));
                        
                        if (iconArray.length > 0) {
                            await db.appIcons.bulkAdd(iconArray);
                            console.log('Â∫îÁî®ÂõæÊ†áÊï∞ÊçÆËøÅÁßªÂÆåÊàê:', iconArray);
                        }
                        
                        // Â∫îÁî®ÂõæÊ†á
                        Object.keys(localIcons).forEach(appId => {
                            const iconElement = document.querySelector(`.app[onclick="showApp('${appId}')"] .app-icon i`);
                            if (iconElement) {
                                iconElement.className = localIcons[appId];
                            }
                        });
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    console.log('‰ªéIndexedDBÂä†ËΩΩÂ∫îÁî®ÂõæÊ†áÊï∞ÊçÆ:', savedIcons);
                    savedIcons.forEach(iconData => {
                        const iconElement = document.querySelector(`.app[onclick="showApp('${iconData.appId}')"] .app-icon i`);
                        if (iconElement) {
                            iconElement.className = iconData.iconClass;
                        }
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ∫îÁî®ÂõæÊ†áÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('appIcons');
                if (localStorageData) {
                    const icons = JSON.parse(localStorageData);
                Object.keys(icons).forEach(appId => {
                    const iconElement = document.querySelector(`.app[onclick="showApp('${appId}')"] .app-icon i`);
                    if (iconElement) {
                        iconElement.className = icons[appId];
                    }
                });
                }
            }
        }
        
        // Âä†ËΩΩAPIËÆæÁΩÆ - ‰ΩøÁî®IndexedDB
        async function loadApiSettings() {
            try {
                // ÂÖà‰ªéIndexedDBÂ∞ùËØïÂä†ËΩΩ
                const savedSettings = await db.apiSettings.get('main');
            if (savedSettings) {
                    apiSettings = savedSettings.settings;
                } else {
                    // Â∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localSettings = localStorage.getItem('apiSettings');
                    if (localSettings) {
                        console.log('ËøÅÁßªAPIËÆæÁΩÆÂà∞IndexedDB');
                        apiSettings = JSON.parse(localSettings);
                        
                        // ‰øùÂ≠òÂà∞IndexedDB
                        await db.apiSettings.put({
                            id: 'main',
                            settings: apiSettings
                        });
                    } else {
                        // ‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ
                        apiSettings = {
                            type: 'gemini',
                            base: 'https://generativelanguage.googleapis.com/v1beta',
                            endpoint: '/chat/completions',
                            key: '',
                            model: 'gemini-2.0-flash-exp',
                            temperature: 0.70
                        };
                    }
                }
                
                // Êõ¥Êñ∞Ë°®ÂçïÊòæÁ§∫
                if (document.getElementById('api-type')) {
                    const apiType = apiSettings.type || 'openai';
                    document.getElementById('api-type').value = apiType;
                    document.getElementById('api-base').value = apiSettings.base || (apiType === 'gemini' ? 'https://generativelanguage.googleapis.com/v1beta' : 'https://api.openai.com/v1');
                    document.getElementById('api-endpoint').value = apiSettings.endpoint || '/chat/completions';
                    document.getElementById('api-key').value = apiSettings.key || '';
                    
                    // Â§ÑÁêÜÊ®°ÂûãËÆæÁΩÆ
                    if (apiType === 'gemini') {
                        document.getElementById('api-model-select').value = apiSettings.model || 'gemini-2.0-flash-exp';
                        document.getElementById('api-model').value = apiSettings.model || 'gemini-2.0-flash-exp';
                    } else {
                        document.getElementById('api-model').value = apiSettings.model || 'gpt-3.5-turbo';
                    }
                    
                    document.getElementById('api-temperature').value = apiSettings.temperature || 0.70;
                    document.getElementById('temperature-value').textContent = (apiSettings.temperature || 0.70).toFixed(2);
                    
                    // Â§ÑÁêÜÊúÄÂ§ßtokenÊï∞ËÆæÁΩÆ

                    
                    // Ëß¶ÂèëAPIÁ±ªÂûãÂèòÂåñÂ§ÑÁêÜÔºåÁ°Æ‰øùÁïåÈù¢Ê≠£Á°ÆÊòæÁ§∫
                    onApiTypeChange();
                }
            } catch (error) {
                console.error('Âä†ËΩΩAPIËÆæÁΩÆÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ
            apiSettings = {
                type: 'gemini',
                base: 'https://generativelanguage.googleapis.com/v1beta',
                endpoint: '/chat/completions',
                key: '',
                model: 'gemini-2.0-flash-exp',
                temperature: 0.70
            };
            
            // Á°Æ‰øùÁïåÈù¢ÂÖÉÁ¥†Ê≠£Á°ÆÊòæÁ§∫
            if (document.getElementById('api-type')) {
                document.getElementById('api-type').value = 'gemini';
                document.getElementById('api-base').value = 'https://generativelanguage.googleapis.com/v1beta';
                document.getElementById('api-endpoint').value = '/chat/completions';
                document.getElementById('api-key').value = '';
                document.getElementById('api-model').value = 'gemini-2.0-flash-exp';
                document.getElementById('api-temperature').value = 0.70;
                document.getElementById('temperature-value').textContent = '0.70';
                
                // Ëß¶ÂèëAPIÁ±ªÂûãÂèòÂåñÂ§ÑÁêÜ
                onApiTypeChange();
            }
            }
        }
        
        // ‰øùÂ≠òÂ∫îÁî®ÂõæÊ†á - ‰ΩøÁî®IndexedDB
        async function saveAppIcons() {
            try {
                console.log('‰øùÂ≠òÂ∫îÁî®ÂõæÊ†áÊï∞ÊçÆÂà∞IndexedDB...');
                
                const defaultIcons = {
                    'chat-screen': 'fas fa-comment-dots',
                    'forum-screen': 'fas fa-comments',
                    'music-screen': 'fas fa-music',
                    'game-screen': 'fas fa-gamepad',
                    'characters-screen': 'fas fa-user-friends',
                    'shop-screen': 'fas fa-shopping-bag',
                    'settings-screen': 'fas fa-cog'
                };
                
                if (selectedAppIcon) {
                    defaultIcons[selectedAppIcon.appId] = selectedAppIcon.iconClass;
                }
                
                // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºè
                const iconArray = Object.keys(defaultIcons).map(appId => ({
                    id: appId,
                    appId: appId,
                    iconClass: defaultIcons[appId]
                }));
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆÂπ∂ÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                await db.appIcons.clear();
                await db.appIcons.bulkAdd(iconArray);
                
                console.log('Â∫îÁî®ÂõæÊ†áÊï∞ÊçÆ‰øùÂ≠òÊàêÂäü');
                
                // Âà∑Êñ∞ÂõæÊ†áÊòæÁ§∫
                await loadAppIcons();
            } catch (error) {
                console.error('‰øùÂ≠òÂ∫îÁî®ÂõæÊ†áÊó∂ÂèëÁîüÈîôËØØ:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
            const icons = {
                'chat-screen': 'fas fa-comment-dots',
                'weibo-screen': 'fab fa-weibo',
                'music-screen': 'fas fa-music',
                'album-screen': 'fas fa-images',
                'characters-screen': 'fas fa-user-friends',
                'shop-screen': 'fas fa-shopping-bag',
                'settings-screen': 'fas fa-cog'
            };
            
            if (selectedAppIcon) {
                icons[selectedAppIcon.appId] = selectedAppIcon.iconClass;
            }
            
            localStorage.setItem('appIcons', JSON.stringify(icons));
            loadAppIcons();
            }
        }
        
        // Ê∏≤ÊüìÊ∂àÊÅØÂàóË°®
        function renderMessageList() {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';
            
            // Ê∑ªÂä†Â§öÈÄâÊ®°ÂºèÁöÑÂ§¥ÈÉ®
            if (isMessageListMultiSelectMode) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'multiselect-header';
                headerDiv.innerHTML = `
                    <span>Â∑≤ÈÄâÊã© ${selectedConversations.length} ‰∏™ÂØπËØù</span>
                    <div>
                        <button onclick="deleteSelectedConversations()" class="delete-btn-red">Âà†Èô§</button>
                        <button onclick="exitMessageListMultiSelectMode()" class="cancel-btn-blue">ÂèñÊ∂à</button>
                    </div>
                `;
                messageList.appendChild(headerDiv);
            }
            
            // Ê∏≤ÊüìÂçï‰∫∫ËÅäÂ§©
            contacts.forEach(contactId => {
                const character = characters.find(c => c.id === contactId);
                if (character) {
                    // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñËØ•ËÅäÂ§©ÁöÑÊòµÁß∞ËÆæÁΩÆ
                    const savedSettings = localStorage.getItem(`chatSettings_${character.id}`);
                    const chatSettings = savedSettings ? JSON.parse(savedSettings) : {};
                    const displayName = chatSettings.aiChatNickname || character.name;
                    
                    const messages = chatMessages[character.id] || [];
                let lastMessageRaw = 'ÊöÇÊó†Ê∂àÊÅØ';
                
                if (messages.length > 0) {
                    const lastMsg = messages[messages.length - 1];
                    
                    // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•Ê∂àÊÅØÊòØÂê¶ÊúâÊïàÔºåÈò≤Ê≠¢undefinedÈîôËØØ
                    if (!lastMsg) {
                        lastMessageRaw = 'ÊöÇÊó†Ê∂àÊÅØ';
                    } else if (lastMsg.type === 'user_photo') {
                        lastMessageRaw = '[ÁÖßÁâá]';
                    } else if (lastMsg.type === 'ai_image') {
                        lastMessageRaw = '[ÂõæÁâá]';
                    } else if (lastMsg.type === 'voice_message') {
                        lastMessageRaw = '[ËØ≠Èü≥]';
                    } else if (lastMsg.type === 'transfer') {
                        lastMessageRaw = '[ËΩ¨Ë¥¶]';
                    } else if (lastMsg.type === 'recalled_message') {
                        lastMessageRaw = '[Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ]';
                    } else if (lastMsg.type === 'location') {
                        lastMessageRaw = '[‰ΩçÁΩÆ]';
                    } else if (lastMsg.sender === 'system') {
                        lastMessageRaw = lastMsg.content || '[Á≥ªÁªüÊ∂àÊÅØ]';
                    } else if (lastMsg.isEmoji) {
                        lastMessageRaw = '[Ë°®ÊÉÖ]';
                    } else {
                        lastMessageRaw = lastMsg.content || '';
                    }
                }
                
                const lastMessage = truncateText(String(lastMessageRaw || 'ÊöÇÊó†Ê∂àÊÅØ'), 30);
                    const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : 'ÂàöÂàö';
                    
                    const messageItem = document.createElement('div');
                    messageItem.className = `message-item ${isMessageListMultiSelectMode && selectedConversations.includes(character.id) ? 'selected' : ''}`;
                    messageItem.dataset.conversationId = character.id; // Ê∑ªÂä†ÂØπËØùID
                    
                    // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÁÇπÂáª‰∫ã‰ª∂
                    if (isMessageListMultiSelectMode) {
                        messageItem.onclick = () => toggleConversationSelection(character.id);
                    } else {
                        // ‰ΩøÁî®ÂèòÈáèÊù•ÊéßÂà∂ÁÇπÂáªË°å‰∏∫
                        let isLongPress = false;
                        
                        messageItem.onclick = (e) => {
                            if (!isLongPress) {
                                startChat(character);
                            }
                            isLongPress = false; // ÈáçÁΩÆÊ†áÂøó
                        };
                        
                        // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂ÔºàÊîØÊåÅÁßªÂä®Á´ØÂíåÊ°åÈù¢Á´ØÔºâ
                        let pressTimer;
                        
                        // ÁßªÂä®Á´ØËß¶Êë∏‰∫ã‰ª∂
                        messageItem.addEventListener('touchstart', (e) => {
                            e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                            pressTimer = setTimeout(() => {
                                console.log('Ëß¶Êë∏ÈïøÊåâËß¶ÂèëÔºåËßíËâ≤ID:', character.id);
                                isLongPress = true; // ËÆæÁΩÆÈïøÊåâÊ†áÂøó
                                enterMessageListMultiSelectMode(character.id);
                                e.preventDefault();
                            }, 800); // 800msÈïøÊåâ
                        });
                        
                        messageItem.addEventListener('touchend', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });
                        
                        messageItem.addEventListener('touchmove', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });
                        
                        // Ê°åÈù¢Á´ØÈº†Ê†á‰∫ã‰ª∂
                        messageItem.addEventListener('mousedown', (e) => {
                            if (e.button === 0) { // Â∑¶ÈîÆ
                                e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                                pressTimer = setTimeout(() => {
                                    console.log('Èº†Ê†áÈïøÊåâËß¶ÂèëÔºåËßíËâ≤ID:', character.id);
                                    isLongPress = true; // ËÆæÁΩÆÈïøÊåâÊ†áÂøó
                                    enterMessageListMultiSelectMode(character.id);
                                    e.preventDefault();
                                }, 800); // 800msÈïøÊåâ
                            }
                        });
                        
                        messageItem.addEventListener('mouseup', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });
                        
                        messageItem.addEventListener('mouseleave', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });
                        
                        // Âè≥ÈîÆÁÇπÂáªËøõÂÖ•Â§öÈÄâÊ®°ÂºèÔºàÊ°åÈù¢Á´ØÔºâ
                        messageItem.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            enterMessageListMultiSelectMode(character.id);
                        });
                    }
                    
                    messageItem.innerHTML = `
                        ${isMessageListMultiSelectMode ? `
                            <div class="selection-checkbox ${selectedConversations.includes(character.id) ? 'selected' : ''}">
                                ${selectedConversations.includes(character.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                            </div>
                        ` : ''}
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : displayName.charAt(0)}
                        </div>
                        <div class="message-content">
                            <div class="message-name">${displayName}</div>
                            <div class="message-preview">${lastMessage}</div>
                        </div>
                        <div class="message-time">${lastTime}</div>
                    `;
                    
                    messageList.appendChild(messageItem);
                }
            });
            
            // Ê∏≤ÊüìÁæ§ËÅä
            groupChats.forEach(group => {
                const messages = chatMessages[group.id] || [];
                let lastMessageRaw = 'ÊöÇÊó†Ê∂àÊÅØ';
                
                if (messages.length > 0) {
                    const lastMsg = messages[messages.length - 1];
                    
                    // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•Ê∂àÊÅØÊòØÂê¶ÊúâÊïàÔºåÈò≤Ê≠¢undefinedÈîôËØØ
                    if (!lastMsg) {
                        lastMessageRaw = 'ÊöÇÊó†Ê∂àÊÅØ';
                    } else if (lastMsg.type === 'user_photo') {
                        lastMessageRaw = '[ÁÖßÁâá]';
                    } else if (lastMsg.type === 'ai_image') {
                        lastMessageRaw = '[ÂõæÁâá]';
                    } else if (lastMsg.type === 'voice_message') {
                        lastMessageRaw = '[ËØ≠Èü≥]';
                    } else if (lastMsg.type === 'transfer') {
                        lastMessageRaw = '[ËΩ¨Ë¥¶]';
                    } else if (lastMsg.type === 'recalled_message') {
                        lastMessageRaw = '[Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ]';
                    } else if (lastMsg.type === 'location') {
                        lastMessageRaw = '[‰ΩçÁΩÆ]';
                    } else if (lastMsg.sender === 'system') {
                        lastMessageRaw = lastMsg.content || '[Á≥ªÁªüÊ∂àÊÅØ]';
                    } else if (lastMsg.isEmoji) {
                        lastMessageRaw = '[Ë°®ÊÉÖ]';
                    } else {
                        lastMessageRaw = lastMsg.content || '';
                    }
                }
                
                const lastMessage = truncateText(String(lastMessageRaw || 'ÊöÇÊó†Ê∂àÊÅØ'), 30);
                const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : 'ÂàöÂàö';
                
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${isMessageListMultiSelectMode && selectedConversations.includes(group.id) ? 'selected' : ''}`;
                messageItem.dataset.conversationId = group.id; // Ê∑ªÂä†ÂØπËØùID
                
                // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÁÇπÂáª‰∫ã‰ª∂
                if (isMessageListMultiSelectMode) {
                    messageItem.onclick = () => toggleConversationSelection(group.id);
                } else {
                messageItem.onclick = () => startChat(group);
                    
                    // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂ÔºàÊîØÊåÅÁßªÂä®Á´ØÂíåÊ°åÈù¢Á´ØÔºâ
                    let pressTimer;
                    
                    // ÁßªÂä®Á´ØËß¶Êë∏‰∫ã‰ª∂
                    messageItem.addEventListener('touchstart', (e) => {
                        e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                        pressTimer = setTimeout(() => {
                            console.log('Ëß¶Êë∏ÈïøÊåâËß¶ÂèëÔºåÁæ§ËÅäID:', group.id);
                            enterMessageListMultiSelectMode(group.id);
                            e.preventDefault();
                        }, 800); // 800msÈïøÊåâ
                    });
                    
                    messageItem.addEventListener('touchend', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });
                    
                    messageItem.addEventListener('touchmove', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });
                    
                    // Ê°åÈù¢Á´ØÈº†Ê†á‰∫ã‰ª∂
                    messageItem.addEventListener('mousedown', (e) => {
                        if (e.button === 0) { // Â∑¶ÈîÆ
                            e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                            pressTimer = setTimeout(() => {
                                console.log('Èº†Ê†áÈïøÊåâËß¶ÂèëÔºåÁæ§ËÅäID:', group.id);
                                enterMessageListMultiSelectMode(group.id);
                                e.preventDefault();
                            }, 800); // 800msÈïøÊåâ
                        }
                    });
                    
                    messageItem.addEventListener('mouseup', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });
                    
                    messageItem.addEventListener('mouseleave', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });
                    
                    // Âè≥ÈîÆÁÇπÂáªËøõÂÖ•Â§öÈÄâÊ®°ÂºèÔºàÊ°åÈù¢Á´ØÔºâ
                    messageItem.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        enterMessageListMultiSelectMode(group.id);
                    });
                }
                
                messageItem.innerHTML = `
                    ${isMessageListMultiSelectMode ? `
                        <div class="selection-checkbox ${selectedConversations.includes(group.id) ? 'selected' : ''}">
                            ${selectedConversations.includes(group.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                        </div>
                    ` : ''}
                    <div class="message-avatar" style="${group.avatarUrl ? `background-image: url(${group.avatarUrl}); background-size: cover; background-position: center;` : 'background-color: #4CAF50;'}">
                        ${group.avatarUrl ? '' : 'Áæ§'}
                    </div>
                    <div class="message-content">
                                                        <div class="message-name">${group.name} <span class="group-member-count">(${group.members ? group.members.length + 1 : 1}‰∫∫)</span></div>
                        <div class="message-preview">${lastMessage}</div>
                    </div>
                    <div class="message-time">${lastTime}</div>
                `;
                
                messageList.appendChild(messageItem);
            });
        }
        
        // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÂàóË°®ÔºàËßíËâ≤È°µÈù¢Ôºâ
        function renderContactList() {
            const contactList = document.querySelector('#contact-list .contact-section');
            if (contactList) {
                // Ê∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπ
                contactList.innerHTML = '';
                
                // Ê∑ªÂä†Â§öÈÄâÊ®°ÂºèÁöÑÂ§¥ÈÉ®
                if (isMultiSelectMode) {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'multiselect-header';
                    headerDiv.innerHTML = `
                        <span>Â∑≤ÈÄâÊã© ${selectedCharacters.length} ‰∏™ËßíËâ≤</span>
                        <div>
                            <button onclick="deleteSelectedCharacters()" class="delete-btn-red">Âà†Èô§</button>
                            <button onclick="exitMultiSelectMode()" class="cancel-btn-blue">ÂèñÊ∂à</button>
                        </div>
                    `;
                    contactList.appendChild(headerDiv);
                }
                
                // üî•„Äê‰øÆÂ§ç„ÄëÊòæÁ§∫ÊâÄÊúâËßíËâ≤ÔºåËÄå‰∏çÂè™ÊòØËÅîÁ≥ª‰∫∫
                characters.forEach(character => {
                    // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñËØ•ËßíËâ≤ÁöÑÊòµÁß∞ËÆæÁΩÆ
                        const savedSettings = localStorage.getItem(`chatSettings_${character.id}`);
                        const chatSettings = savedSettings ? JSON.parse(savedSettings) : {};
                        const displayName = chatSettings.aiChatNickname || character.name;
                        
                        const contactItem = document.createElement('div');
                        contactItem.className = `contact-item ${isMultiSelectMode && selectedCharacters.includes(character.id) ? 'selected' : ''}`;
                        
                        // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÁÇπÂáª‰∫ã‰ª∂
                        if (isMultiSelectMode) {
                            contactItem.onclick = () => toggleCharacterSelection(character.id);
                        } else {
                            contactItem.onclick = () => editCharacterFromContactList(character.id);
                            
                            // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂
                            let pressTimer;
                            contactItem.addEventListener('touchstart', (e) => {
                                pressTimer = setTimeout(() => {
                                    enterMultiSelectMode(character.id);
                                    e.preventDefault();
                                }, 800); // 800msÈïøÊåâ
                            });
                            
                            contactItem.addEventListener('touchend', () => {
                                clearTimeout(pressTimer);
                            });
                            
                            contactItem.addEventListener('touchmove', () => {
                                clearTimeout(pressTimer);
                            });
                            
                            // Âè≥ÈîÆÁÇπÂáªËøõÂÖ•Â§öÈÄâÊ®°ÂºèÔºàÊ°åÈù¢Á´ØÔºâ
                            contactItem.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                enterMultiSelectMode(character.id);
                            });
                        }
                        
                        contactItem.innerHTML = `
                            ${isMultiSelectMode ? `
                                <div class="selection-checkbox ${selectedCharacters.includes(character.id) ? 'selected' : ''}">
                                    ${selectedCharacters.includes(character.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                                </div>
                            ` : ''}
                            <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                                ${character.avatarUrl ? '' : displayName.charAt(0)}
                            </div>
                            <div class="contact-info">
                                <div class="message-name">${displayName}</div>
                                <div class="character-preview">${truncateText(character.bio || 'ÊöÇÊó†‰∫∫ËÆæÊèèËø∞', 25)}</div>
                            </div>
                        `;
                        
                        contactList.appendChild(contactItem);
                });
                
                // Â¶ÇÊûúÊ≤°ÊúâËßíËâ≤ÔºåÊòæÁ§∫ÊèêÁ§∫
                if (characters.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-message';
                    emptyDiv.textContent = 'ËøòÊ≤°ÊúâËßíËâ≤ÔºåÁÇπÂáªÂè≥‰∏äËßí+Âè∑ÂàõÂª∫ËßíËâ≤ÂêßÔºÅ';
                    contactList.appendChild(emptyDiv);
                }
            }
        }
        
        // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
        function renderCharacterList() {
            const characterList = document.getElementById('character-list');
            // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®Â∞±Ë∑≥ËøáÔºàÂõ†‰∏∫Êàë‰ª¨Â∑≤ÁªèÂà†Èô§‰∫Ü‰∫∫Áâ©Â∫îÁî®Ôºâ
            if (!characterList) {
                console.log('character-listÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊ∏≤Êüì');
                return;
            }
            
            characterList.innerHTML = '';
            
            characters.forEach(character => {
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                characterItem.onclick = () => editCharacter(character.id);
                
                characterItem.innerHTML = `
                    <div class="character-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div class="character-info">
                        <div class="character-name">${character.name}</div>
                        <div class="character-bio">${truncateText(character.bio, 50)}</div>
                    </div>
                `;
                
                characterList.appendChild(characterItem);
            });
        }
        
        // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü
        function renderContactModal() {
            const modalBody = document.getElementById('contact-modal-body');
            modalBody.innerHTML = '';
            
            characters.forEach(character => {
                // Âè™ÊòæÁ§∫Êú™Ê∑ªÂä†‰∏∫ËÅîÁ≥ª‰∫∫ÁöÑËßíËâ≤
                if (!contacts.includes(character.id)) {
                    const contactOption = document.createElement('div');
                    contactOption.className = 'contact-item';
                    
                    const checkboxId = `contact-${character.id}`;
                    
                    contactOption.innerHTML = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="character-info character-info-flex">
                            <div class="character-name">${character.name}</div>
                            <div class="character-bio">${truncateText(character.bio, 40)}</div>
                        </div>
                        <input type="checkbox" id="${checkboxId}" class="contact-checkbox" value="${character.id}">
                    `;
                    
                    modalBody.appendChild(contactOption);
                }
            });
            
            if (modalBody.children.length === 0) {
                modalBody.innerHTML = '<p>Ê≤°ÊúâÂèØÊ∑ªÂä†ÁöÑËßíËâ≤ÔºåËØ∑ÂÖàÂàõÂª∫Êñ∞ËßíËâ≤„ÄÇ</p>';
            }
        }
        
        // ÂΩìÂâçÊòæÁ§∫ÁöÑÊ∂àÊÅØÊï∞ÈáèÈôêÂà∂
        let currentMessageOffset = 0;
        const MESSAGE_LIMIT = 50;
        
        // Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ
        function renderChatMessages(characterId, loadMore = false) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const allMessages = chatMessages[characterId] || [];
            const chatSettings = getCurrentChatSettings();
            
            if (!loadMore) {
                // ÈáçÊñ∞Ê∏≤ÊüìÊó∂Ê∏ÖÁ©∫ÂÆπÂô®Âπ∂ÈáçÁΩÆÂÅèÁßªÈáè
                messagesContainer.innerHTML = '';
                currentMessageOffset = Math.max(0, allMessages.length - MESSAGE_LIMIT);
            }
            
            // Â∫îÁî®ËÅäÂ§©ËÉåÊôØ
            applyChatBackground();
            
            // Â∫îÁî®Ê∞îÊ≥°Ê†∑Âºè
            applyBubbleStyle();
            
            // Â¶ÇÊûúÊ≤°ÊúâÊ∂àÊÅØÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅÊèêÁ§∫
            if (allMessages.length === 0) {
                const displayName = chatSettings.aiChatNickname || currentChatCharacter.name;
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-chat-state';
                emptyState.innerHTML = `
                    <div>ÂºÄÂßãÂíå ${displayName} ËÅäÂ§©Âêß</div>
                `;
                messagesContainer.appendChild(emptyState);
                return;
            }
            
            // Â¶ÇÊûú‰∏çÊòØÂä†ËΩΩÊõ¥Â§öÔºå‰∏îÊúâÊõ¥Â§öÂéÜÂè≤Ê∂àÊÅØÔºåÊòæÁ§∫"Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ"ÊåâÈíÆ
            if (!loadMore && currentMessageOffset > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-messages';
                loadMoreBtn.innerHTML = `
                    <div class="load-more-content">
                        <i class="fas fa-chevron-up"></i>
                        <span>Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ (${currentMessageOffset}Êù°)</span>
                    </div>
                `;
                loadMoreBtn.onclick = () => loadMoreMessages(characterId);
                messagesContainer.appendChild(loadMoreBtn);
            }
            
            // Ëé∑ÂèñË¶ÅÊòæÁ§∫ÁöÑÊ∂àÊÅØ
            const messagesToShow = loadMore ? 
                allMessages.slice(Math.max(0, currentMessageOffset - MESSAGE_LIMIT), currentMessageOffset) :
                allMessages.slice(currentMessageOffset);
            
            // Ëé∑ÂèñÊó∂Èó¥Êà≥ËÆæÁΩÆ
            const timestampEnabled = chatSettings.timestampEnabled !== false; // ÈªòËÆ§‰∏∫true
            const timestampPosition = chatSettings.timestampPosition || 'center';
            
            let lastTimestamp = 0;
            
            messagesToShow.forEach((message, index) => {
                // Â§ÑÁêÜÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÊà≥‰∏ÄÊà≥„ÄÅÂ§¥ÂÉèÊõ¥Êç¢„ÄÅÊí§ÂõûÁ≠âÔºâ
                if (message.sender === 'system') {
                    if (message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    systemContainer.appendChild(systemMessage);
                    messagesContainer.appendChild(systemContainer);
                    } else if (message.type === 'recalled_message') {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊí§ÂõûÊ∂àÊÅØÁöÑÊòæÁ§∫
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id; // üî•„Äê‰øÆÂ§ç„ÄëÊ∑ªÂä†Ê∂àÊÅØID‰ª•ÊîØÊåÅÈÄâÊã©
                        
                        const recallElement = document.createElement('div');
                        recallElement.className = 'recalled-message';
                        
                        // Ëß£ÊûêÊí§ÂõûÊ∂àÊÅØÂÜÖÂÆπÔºàÊ†ºÂºèÔºöxxx Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ\nÂéüÊñáÔºöxxxÔºâ
                        const lines = message.content.split('\n');
                        const mainText = lines[0]; // ‰∏ªË¶ÅÊèêÁ§∫ÊñáÂ≠ó
                        const originalText = lines[1]; // ÂéüÊñáÈÉ®ÂàÜ
                        
                        recallElement.textContent = mainText;
                        
                        // Â¶ÇÊûúÊúâÂéüÊñáÔºåÊ∑ªÂä†ÂéüÊñáÊòæÁ§∫
                        if (originalText && originalText.startsWith('ÂéüÊñáÔºö')) {
                            const originalDiv = document.createElement('div');
                            originalDiv.className = 'original-text';
                            originalDiv.textContent = originalText;
                            recallElement.appendChild(originalDiv);
                        }
                        
                        centerContainer.appendChild(recallElement);
                        messagesContainer.appendChild(centerContainer);
                        
                        // üî•„Äê‰øÆÂ§ç„Äë‰∏∫Êí§ÂõûÊ∂àÊÅØÊ∑ªÂä†ÈÄâÊã©ÂäüËÉΩ
                        addMessageLongPressListener(centerContainer, message.id);
                    } else {
                        // üî•„Äê‰øÆÂ§ç„ÄëÂÖ∂‰ªñÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÂ§¥ÂÉèÊõ¥Êç¢Ôºâ- ‰ΩøÁî®Â±Ö‰∏≠ÂÆπÂô®
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        
                        const systemContainer = document.createElement('div');
                        systemContainer.className = 'system-message';
                        systemContainer.textContent = message.content;
                        
                        centerContainer.appendChild(systemContainer);
                        messagesContainer.appendChild(centerContainer);
                    }
                    return;
                }
                
                // Ê∑ªÂä†Â±Ö‰∏≠Êó∂Èó¥Êà≥ÔºàÂ¶ÇÊûúÂêØÁî®‰∏î‰ΩçÁΩÆ‰∏∫Â±Ö‰∏≠Ôºâ
                if (timestampEnabled && timestampPosition === 'center') {
                    const currentTime = new Date(message.timestamp);
                    const timeDiff = currentTime - lastTimestamp;
                    
                    // Â¶ÇÊûúË∑ùÁ¶ª‰∏äÊù°Ê∂àÊÅØË∂ÖËøá5ÂàÜÈíüÔºåÊòæÁ§∫Êó∂Èó¥Êà≥
                    if (index === 0 || timeDiff > 5 * 60 * 1000) {
                        const timestampDiv = document.createElement('div');
                        timestampDiv.className = 'timestamp timestamp-center';
                        timestampDiv.textContent = formatTimestamp(message.timestamp);
                        messagesContainer.appendChild(timestampDiv);
                        lastTimestamp = currentTime;
                    }
                }
                
                const messageContainer = document.createElement('div');
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ∫ØË°®ÊÉÖÂåÖÊ∂àÊÅØ
                const isEmojiOnly = message.isEmoji && !message.content;
                messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
                messageContainer.dataset.messageId = message.id; // Ê∑ªÂä†Ê∂àÊÅØIDÊï∞ÊçÆÂ±ûÊÄß
                
                if (message.sender === 'received') {
                    // ==== Áæ§ËÅäÊîØÊåÅ ====
                    let character = characters.find(c => c.id === characterId);
                    let isGroup = false;
                    let group = null;
                    if (!character) {
                        group = groupChats.find(g => g.id === characterId);
                        if (group) {
                            isGroup = true;
                        }
                    }
                    
                    let displayAvatar = '';
                    let displayName = '';
                    let color = '#4CAF50';
                    
                    if (isGroup && group) {
                        // Áæ§ËÅäÔºöÊ†πÊçÆÊ∂àÊÅØÁöÑsenderIdÊàñnameÊü•ÊâæÊàêÂëò
                        let member = null;
                        if (message.senderId) {
                            member = group.members.find(m => m.id === message.senderId);
                        } else if (message.name) {
                            member = group.members.find(m => m.name === message.name);
                        }
                        displayAvatar = member?.avatarUrl || '';
                        displayName = member?.name || 'Áæ§ÊàêÂëò';
                        color = member?.color || '#4CAF50';
                    } else if (character) {
                        // ÂçïËÅä
                        displayAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || character.avatarUrl;
                        displayName = chatSettings.aiChatNickname || character.name;
                        color = character.color || '#4CAF50';
                    
                    // üî•„ÄêË∞ÉËØï„ÄëËÆ∞ÂΩïÂ§¥ÂÉèÈÄâÊã©ËøáÁ®ã
                    if (chatSettings.aiDynamicAvatar) {
                        console.log(`‰ΩøÁî®Âä®ÊÄÅÂ§¥ÂÉè: ${chatSettings.aiDynamicAvatar.substring(0, 30)}...`);
                    } else if (chatSettings.aiChatAvatar) {
                        console.log(`‰ΩøÁî®ËÅäÂ§©ËÆæÁΩÆÂ§¥ÂÉè: ${chatSettings.aiChatAvatar.substring(0, 30)}...`);
                    } else {
                        console.log(`‰ΩøÁî®ËßíËâ≤Âç°Â§¥ÂÉè: ${character.avatarUrl ? character.avatarUrl.substring(0, 30) + '...' : 'Êó†Â§¥ÂÉè'}`);
                    }
                    } else {
                        // ÂÖúÂ∫ïÔºåÈò≤Ê≠¢Êä•Èîô
                        displayAvatar = '';
                        displayName = 'Êú™Áü•';
                        color = '#4CAF50';
                    }
                    
                    // Ëé∑ÂèñÊ∞îÊ≥°Ê†∑Âºè
                    const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                    const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                    const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                    const bubblePadding = chatSettings.bubblePadding || '12';
                    
                    // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                    const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);
                    
                    // üî• Â§ÑÁêÜÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                    let messageContent = '';
                    
                    if (message.type === 'voice_message') {
                        // ËøáÊª§ÊéâÊã¨Âè∑‰∏≠ÁöÑÊèèËø∞ÊÄßÂÜÖÂÆπÔºå‰øùÁïôÂÆûÈôÖËØ¥ËØùÂÜÖÂÆπ
                        const cleanVoiceContent = message.content.replace(/\([^)]*\)\s*/g, '').trim();
                        const voiceDuration = message.duration || Math.max(1, Math.ceil(cleanVoiceContent.length / 8));
                        
                        // AIËØ≠Èü≥Ê∂àÊÅØ - ‰ΩøÁî®ÂíåÁî®Êà∑ËØ≠Èü≥Ê∂àÊÅØ‰∏ÄÊ†∑ÁöÑÁªìÊûÑ
                        messageContent = `
                            <div class="voice-message-container received">
                                <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${cleanVoiceContent}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${voiceDuration}"</div>
                                    </div>
                                </div>
                                <div class="voice-text-content">${cleanVoiceContent}</div>
                            </div>
                        `;
                    } else if (message.type === 'ai_image') {
                        // AIÁîüÊàêÁöÑÂõæÁâá
                        messageContent = `
                            <div class="ai-image-container">
                                <img src="${message.image}" class="message-image" onclick="showImage('${message.image}')" alt="AIÁîüÊàêÁöÑÂõæÁâá">
                                <div class="image-description">${message.imageDescription || ''}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // ËΩ¨Ë¥¶Ê∂àÊÅØ
                        const isUser = message.role === 'user';
                        const heartIcon = isUser ? 'üíï' : 'üíñ';
                        const titleText = isUser ? '‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶' : 'Êî∂Âà∞ËΩ¨Ë¥¶';
                        let cardClass = '';
                        let statusHtml = '';
                        let clickHandler = '';
                        
                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ' : 'Â∑≤Êî∂Ê¨æ'}</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤ÈÄÄÂõû' : 'Â∑≤ÈÄÄÂõû'}</div>`;
                            cardClass = 'rejected';
                        } else if (!isUser) {
                            // AIÂèëÊù•ÁöÑËΩ¨Ë¥¶‰∏îÊú™Â§ÑÁêÜÔºåÊ∑ªÂä†ÁÇπÂáªÂ§ÑÁêÜ
                            clickHandler = `onclick="showTransferConfirmDialog(${JSON.stringify(message).replace(/"/g, '&quot;')})"`;
                        }
                        
                        messageContent = `
                            <div class="transfer-message-container received">
                                <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}" ${clickHandler}>
                                    <div class="transfer-title">${heartIcon} ${titleText}</div>
                                    <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                    <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    } else {
                        // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                        const chatMode = chatSettings.chatMode || 'online';
                        let processedContent = message.content;
                        
                        if (chatMode === 'offline') {
                            processedContent = processOfflineContent(message.content);
                        }
                        
                        messageContent = processedContent;
                    }
                    
                    let avatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        avatarHtml = `
                            <div class="message-avatar" style="background-color: ${color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" ${character ? `onclick="pokeCharacter('${character.id}')" title="Êà≥‰∏ÄÊà≥"` : `title="${displayName}"`}>
                                ${displayAvatar ? '' : displayName.charAt(0)}
                                ${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    let bubbleHtml = '';
                    if (message.type === 'voice_message' || message.type === 'transfer') {
                        // ËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑÊ∞îÊ≥°ÂåÖË£π
                        bubbleHtml = messageContent;
                    } else {
                        // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                        bubbleHtml = `
                        <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                            ${messageContent}
                            ${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                            ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                        </div>
                    `;
                    }
                    
      // üî•„Äê‰øÆÂ§ç„ÄëÁæ§ËÅäÊòµÁß∞ÊòæÁ§∫ - ÁâπÂà´Â§ÑÁêÜËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØ
      if (isGroup && group && displayName !== 'Áæ§ÊàêÂëò') {
    messageContainer.classList.add('group-message-item');
    const senderNameHtml = `<div class="sender-name">${displayName}</div>`;
    
    if (message.type === 'voice_message' || message.type === 'transfer') {
        // üî•„Äê‰øÆÂ§ç„ÄëÂØπ‰∫éËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØÔºåÊòµÁß∞ÈúÄË¶ÅÂú®ÂÆπÂô®Â§ñÈÉ®
    messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    } else {
        // ÊôÆÈÄöÊ∂àÊÅØÁöÑÂ§ÑÁêÜ
        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    }
} else {
                    messageContainer.innerHTML = avatarHtml + bubbleHtml;
}
                } else {
                    // Ëé∑ÂèñÊàëÁöÑÊòæÁ§∫Â§¥ÂÉèÂíåÊ∞îÊ≥°Ê†∑Âºè
let myDisplayAvatar = chatSettings.myChatAvatar; // ‰ºòÂÖà‰ΩøÁî®ËÅäÂ§©‰∏ìÂ±ûËÆæÁΩÆÈáåÁöÑÂ§¥ÂÉè
let myDisplayName = chatSettings.myChatNickname; // ‰ºòÂÖà‰ΩøÁî®ËÅäÂ§©‰∏ìÂ±ûËÆæÁΩÆÈáåÁöÑÊòµÁß∞
                    
// Â¶ÇÊûú‰∏ìÂ±ûËÆæÁΩÆÈáåÊ≤°ÊúâÔºåÂàôËøõË°å‰∫åÊ¨°Êü•ÊâæÔºà‰Ωú‰∏∫‰øùÈô©Êé™ÊñΩÔºâ
if ((!myDisplayAvatar || !myDisplayName) && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    if (selectedPersona) {
        // Â¶ÇÊûúÂ§¥ÂÉè‰∏∫Á©∫ÔºåÂàô‰ΩøÁî®Ë∫´‰ªΩÂ§¥ÂÉè
        if (!myDisplayAvatar) myDisplayAvatar = selectedPersona.avatarUrl;
        // Â¶ÇÊûúÊòµÁß∞‰∏∫Á©∫ÔºåÂàô‰ΩøÁî®Ë∫´‰ªΩÊòµÁß∞
        if (!myDisplayName) myDisplayName = selectedPersona.name;
                        }
                    }
                    
                    const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                    const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                    const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                    const myBubblePadding = chatSettings.bubblePadding || '12';
                    
                    // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                    const transparentMyBubbleColor = convertColorWithOpacity(myBubbleColor, myBubbleOpacity);
                    
                    // Â§ÑÁêÜÁî®Êà∑ÁöÑÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                    let myMessageContent = '';
                    if (message.type === 'user_photo') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑ"ÁÖßÁâá"ÔºàÊñáÂ≠óÊèèËø∞Ôºâ
                        myMessageContent = `
                            <div class="dreamy-photo-container" onclick="togglePhotoText(this, '${(message.photoDescription || message.content).replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">
                                <div class="dreamy-photo">
                                    <div class="photo-misty-bg"></div>
                                    <div class="photo-badge">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <div class="sparkle-container">
                                        <div class="sparkle sparkle-1">‚ú®</div>
                                        <div class="sparkle sparkle-2">‚≠ê</div>
                                        <div class="sparkle sparkle-3">‚ú®</div>
                                        <div class="sparkle sparkle-4">‚≠ê</div>
                                        <div class="sparkle sparkle-5">üí´</div>
                                    </div>
                                    <div class="photo-text-overlay" style="display: none;">
                                        <div class="photo-description">${(message.photoDescription || message.content)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'voice') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑËØ≠Èü≥Ê∂àÊÅØ
                        myMessageContent = `
                            <div class="voice-message-container sent">
                                <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${message.duration || Math.max(1, Math.ceil(message.content.length / 8))}"</div>
                                    </div>
                                    ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                    ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                </div>
                                <div class="voice-text-content">${message.content}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // Áî®Êà∑ËΩ¨Ë¥¶Ê∂àÊÅØ - Âú®renderChatMessages‰∏≠Â§ÑÁêÜ
                        let cardClass = '';
                        let statusHtml = '';
                        
                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤Êî∂Ê¨æ</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤ÈÄÄÂõû</div>`;
                            cardClass = 'rejected';
                        }
                        
                        myMessageContent = `
                            <div class="transfer-message-container sent">
                                <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}">
                                    <div class="transfer-title">üíï ‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶</div>
                                    <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                    <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'location') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑ‰ΩçÁΩÆÊ∂àÊÅØ
                        myMessageContent = `
                            <div class="location-message-container sent">
                                <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                                    <div class="location-card-header">${message.locationName}</div>
                                    <div class="location-card-map">
                                        <div class="map-background"></div>
                                        <div class="map-roads">
                                            <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                                            <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                                            <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                                        </div>
                                        <div class="map-buildings">
                                            <div class="building" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                                            <div class="building" style="top: 25%; left: 60%; width: 14px; height: 12px;"></div>
                                            <div class="building green" style="top: 50%; left: 15%; width: 8px; height: 8px;"></div>
                                            <div class="building" style="top: 70%; left: 70%; width: 10px; height: 8px;"></div>
                                            <div class="building green" style="top: 10%; left: 75%; width: 6px; height: 6px;"></div>
                                            <div class="building green" style="top: 75%; left: 25%; width: 7px; height: 7px;"></div>
                                        </div>
                                        <div class="map-marker">
                                            <div class="marker-pin">üìç</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØÊàñÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                        if (Array.isArray(message.content)) {
                            // Êñ∞ÁöÑÂ§öÊ®°ÊÄÅÊ†ºÂºè
                            const textPart = message.content.find(p => p.type === 'text');
                            const imagePart = message.content.find(p => p.type === 'image_url');
                            
                            myMessageContent = textPart?.text || '';
                            
                            // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáÊòæÁ§∫
                            if (imagePart?.image_url?.url) {
                                if (myMessageContent) {
                                    myMessageContent += '<br>';
                                }
                                myMessageContent += `<img src="${imagePart.image_url.url}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${imagePart.image_url.url}')">`;
                            }
                        } else {
                            // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØÊàñÊóßÊ†ºÂºè
                        myMessageContent = message.content;
                        }
                    }
                    
                    let myBubbleHtml = '';
                    
                    if (message.type === 'user_photo' || message.type === 'voice' || message.type === 'transfer' || message.type === 'location') {
                        // Áî®Êà∑ÁÖßÁâá„ÄÅËØ≠Èü≥Ê∂àÊÅØ„ÄÅËΩ¨Ë¥¶Ê∂àÊÅØÂíå‰ΩçÁΩÆÊ∂àÊÅØ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÊ∞îÊ≥°ÂåÖË£πÔºàÂ∑≤ÁªèÊúâËá™Â∑±ÁöÑÂÆπÂô®Ôºâ
                        myBubbleHtml = myMessageContent;
                    } else {
                        // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                        myBubbleHtml = `
                            <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                ${myMessageContent}
                                ${message.image && !message.type && !Array.isArray(message.content) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                                ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    let myAvatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        myAvatarHtml = `
                            <div class="message-avatar" style="background-color: #007AFF; ${myDisplayAvatar ? `background-image: url(${myDisplayAvatar}); background-size: cover; background-position: center;` : ''}">
                                ${myDisplayAvatar ? '' : '<i class="fas fa-user"></i>'}
                                ${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                }
                
                // Ê∑ªÂä†ÊªëÂÖ•Âä®ÁîªÊïàÊûú - ÂèÇËÄÉÂÆåÊàê.htmlÁöÑÂºπÊÄßÂä®Áîª
                messageContainer.style.opacity = '0';
                messageContainer.style.transform = 'translateY(20px)';
                messageContainer.style.transition = 'opacity 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                
                messagesContainer.appendChild(messageContainer);
                
                // Ëß¶ÂèëÊªëÂÖ•Âä®Áîª
                requestAnimationFrame(() => {
                    messageContainer.style.opacity = '1';
                    messageContainer.style.transform = 'translateY(0)';
                });
                
                // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®Áî®‰∫éÂ§öÈÄâÂà†Èô§
                addMessageLongPressListener(messageContainer, message.id);
                
                // Ê∑ªÂä†Âè≥ÈîÆËèúÂçïÂäüËÉΩ
                const bubble = messageContainer.querySelector('.message-bubble');
                if (bubble) {
                    // Èº†Ê†áÂè≥ÈîÆÁÇπÂáª
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showMessageMenu(message.id, e);
                    });
                    
                    // ÁÇπÂáªÂõæÁâáÈ¢ÑËßà
                    bubble.onclick = (e) => {
                        if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                            showImage(e.target.src);
                        }
                    };
                }
            });
            
            // Ê∑ªÂä†Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫ÂÖÉÁ¥†Âà∞Ê∂àÊÅØÂ∫ïÈÉ®ÔºàÂàùÂßãÈöêËóèÔºâ
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `${chatSettings.aiChatNickname || currentChatCharacter.name}Ê≠£Âú®ËæìÂÖ•‰∏≠<span class="dots"></span>`;
            messagesContainer.appendChild(typingIndicator);
            
            // Â¶ÇÊûú‰∏çÊòØÂä†ËΩΩÊõ¥Â§öÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
            if (!loadMore) {
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }
            
            // üî•„Äê‰øÆÂ§ç„Äë‰ΩçÁΩÆÊ∂àÊÅØÊ∞îÊ≥°ÂåÖË£ÖÈóÆÈ¢ò - ‰øÆÂ§çÂ∑≤Ê∏≤ÊüìÁöÑ‰ΩçÁΩÆÊ∂àÊÅØ
            setTimeout(() => {
                const locationMessages = messagesContainer.querySelectorAll('.message-container.sent');
                locationMessages.forEach(container => {
                    const locationCard = container.querySelector('.location-card');
                    if (locationCard && container.querySelector('.message-bubble')) {
                        // Â¶ÇÊûú‰ΩçÁΩÆÂç°ÁâáË¢´ÂåÖË£πÂú®Ê∞îÊ≥°‰∏≠ÔºåÊèêÂèñÂá∫Êù•
                        const bubble = container.querySelector('.message-bubble');
                        const avatar = container.querySelector('.message-avatar');
                        if (bubble && locationCard.closest('.message-bubble')) {
                            const locationContainer = locationCard.closest('.location-message-container');
                            if (locationContainer) {
                                container.innerHTML = locationContainer.outerHTML + (avatar ? avatar.outerHTML : '');
                            }
                        }
                    }
                });
            }, 50);
        }
        
        // Âä†ËΩΩÊõ¥Â§öÂéÜÂè≤Ê∂àÊÅØ
        function loadMoreMessages(characterId) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const allMessages = chatMessages[characterId] || [];
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÊªöÂä®‰ΩçÁΩÆ
            const scrollHeight = messagesContainer.scrollHeight;
            const scrollTop = messagesContainer.scrollTop;
            
            // ËÆ°ÁÆóË¶ÅÂä†ËΩΩÁöÑÂéÜÂè≤Ê∂àÊÅØËåÉÂõ¥
            const newOffset = Math.max(0, currentMessageOffset - MESSAGE_LIMIT);
            const historicalMessages = allMessages.slice(newOffset, currentMessageOffset);
            
            // ÁßªÈô§Áé∞ÊúâÁöÑ"Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ"ÊåâÈíÆ
            const existingLoadMoreBtn = messagesContainer.querySelector('.load-more-messages');
            if (existingLoadMoreBtn) {
                existingLoadMoreBtn.remove();
            }
            
            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÂéÜÂè≤Ê∂àÊÅØÔºåÂú®È°∂ÈÉ®Ê∑ªÂä†Êñ∞ÁöÑ"Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ"ÊåâÈíÆ
            if (newOffset > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-messages';
                loadMoreBtn.innerHTML = `
                    <div class="load-more-content">
                        <i class="fas fa-chevron-up"></i>
                        <span>Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ (${newOffset}Êù°)</span>
                    </div>
                `;
                loadMoreBtn.onclick = () => loadMoreMessages(characterId);
                messagesContainer.insertBefore(loadMoreBtn, messagesContainer.firstChild);
            }
            
            // Âú®Áé∞ÊúâÊ∂àÊÅØÂâçÈù¢ÊèíÂÖ•ÂéÜÂè≤Ê∂àÊÅØ
            const timestampEnabled = chatSettings.timestampEnabled !== false;
            const timestampPosition = chatSettings.timestampPosition || 'center';
            let lastTimestamp = 0;
            
            // ‰ªéÂêéÂæÄÂâçÊèíÂÖ•Ôºå‰øùÊåÅÊó∂Èó¥È°∫Â∫è
            for (let i = historicalMessages.length - 1; i >= 0; i--) {
                const message = historicalMessages[i];
                
                // Â§ÑÁêÜÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÊà≥‰∏ÄÊà≥„ÄÅÂ§¥ÂÉèÊõ¥Êç¢„ÄÅÊí§ÂõûÁ≠âÔºâ
                if (message.sender === 'system') {
                    let containerToInsert;
                    
                    if (message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    systemContainer.appendChild(systemMessage);
                        containerToInsert = systemContainer;
                    } else if (message.type === 'recalled_message') {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊí§ÂõûÊ∂àÊÅØÁöÑÊòæÁ§∫
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id; // üî•„Äê‰øÆÂ§ç„ÄëÊ∑ªÂä†Ê∂àÊÅØID‰ª•ÊîØÊåÅÈÄâÊã©
                        
                        const recallElement = document.createElement('div');
                        recallElement.className = 'recalled-message';
                        
                        // Ëß£ÊûêÊí§ÂõûÊ∂àÊÅØÂÜÖÂÆπÔºàÊ†ºÂºèÔºöxxx Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ\nÂéüÊñáÔºöxxxÔºâ
                        const lines = message.content.split('\n');
                        const mainText = lines[0]; // ‰∏ªË¶ÅÊèêÁ§∫ÊñáÂ≠ó
                        const originalText = lines[1]; // ÂéüÊñáÈÉ®ÂàÜ
                        
                        recallElement.textContent = mainText;
                        
                        // Â¶ÇÊûúÊúâÂéüÊñáÔºåÊ∑ªÂä†ÂéüÊñáÊòæÁ§∫
                        if (originalText && originalText.startsWith('ÂéüÊñáÔºö')) {
                            const originalDiv = document.createElement('div');
                            originalDiv.className = 'original-text';
                            originalDiv.textContent = originalText;
                            recallElement.appendChild(originalDiv);
                        }
                        
                        centerContainer.appendChild(recallElement);
                        containerToInsert = centerContainer;
                    } else {
                        // üî•„Äê‰øÆÂ§ç„ÄëÂÖ∂‰ªñÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÂ§¥ÂÉèÊõ¥Êç¢Ôºâ- ‰ΩøÁî®Â±Ö‰∏≠ÂÆπÂô®
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        
                        const systemContainer = document.createElement('div');
                        systemContainer.className = 'system-message';
                        systemContainer.textContent = message.content;
                        
                        centerContainer.appendChild(systemContainer);
                        containerToInsert = centerContainer;
                    }
                    
                    // ÊèíÂÖ•Âà∞ÊåâÈíÆÂêéÈù¢ÔºàÂ¶ÇÊûúÊúâÊåâÈíÆÁöÑËØùÔºâ
                    const insertAfter = messagesContainer.querySelector('.load-more-messages');
                    if (insertAfter) {
                        insertAfter.parentNode.insertBefore(containerToInsert, insertAfter.nextSibling);
                    } else {
                        messagesContainer.insertBefore(containerToInsert, messagesContainer.firstChild);
                    }
                    
                    // üî•„Äê‰øÆÂ§ç„Äë‰∏∫Êí§ÂõûÊ∂àÊÅØÊ∑ªÂä†ÈÄâÊã©ÂäüËÉΩ
                    if (message.type === 'recalled_message') {
                        addMessageLongPressListener(containerToInsert, message.id);
                    }
                    
                    continue;
                }
                
                const messageContainer = document.createElement('div');
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ∫ØË°®ÊÉÖÂåÖÊ∂àÊÅØ
                const isEmojiOnly = message.isEmoji && !message.content;
                messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
                messageContainer.dataset.messageId = message.id;
                
                if (message.sender === 'received') {
                    // ==== Áæ§ËÅäÊîØÊåÅ ====
                    let character = characters.find(c => c.id === characterId);
                    let isGroup = false;
                    let group = null;
                    if (!character) {
                        group = groupChats.find(g => g.id === characterId);
                        if (group) {
                            isGroup = true;
                        }
                    }
                    
                    let displayAvatar = '';
                    let displayName = '';
                    let color = '#4CAF50';
                    
                    if (isGroup && group) {
                        // Áæ§ËÅäÔºöÊ†πÊçÆÊ∂àÊÅØÁöÑsenderIdÊàñnameÊü•ÊâæÊàêÂëò
                        let member = null;
                        if (message.senderId) {
                            member = group.members.find(m => m.id === message.senderId);
                        } else if (message.name) {
                            member = group.members.find(m => m.name === message.name);
                        }
                        displayAvatar = member?.avatarUrl || '';
                        displayName = member?.name || 'Áæ§ÊàêÂëò';
                        color = member?.color || '#4CAF50';
                    } else if (character) {
                        // ÂçïËÅä
                        displayAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || character.avatarUrl;
                        displayName = chatSettings.aiChatNickname || character.name;
                        color = character.color || '#4CAF50';
                    } else {
                        // ÂÖúÂ∫ïÔºåÈò≤Ê≠¢Êä•Èîô
                        displayAvatar = '';
                        displayName = 'Êú™Áü•';
                        color = '#4CAF50';
                    }
                    const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                    const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                    const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                    const bubblePadding = chatSettings.bubblePadding || '12';
                    
                    // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                    const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);
                    
                    let messageContent = '';
                    if (message.type === 'voice_message') {
                        // ËøáÊª§ÊéâÊã¨Âè∑‰∏≠ÁöÑÊèèËø∞ÊÄßÂÜÖÂÆπÔºå‰øùÁïôÂÆûÈôÖËØ¥ËØùÂÜÖÂÆπ
                        const cleanVoiceContent = message.content.replace(/\([^)]*\)\s*/g, '').trim();
                        const voiceDuration = message.duration || Math.max(1, Math.ceil(cleanVoiceContent.length / 8));
                        
                        messageContent = `
                            <div class="voice-message-container received">
                                <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${cleanVoiceContent}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${voiceDuration}"</div>
                                    </div>
                                </div>
                                <div class="voice-text-content">${cleanVoiceContent}</div>
                            </div>
                        `;
                    } else if (message.type === 'ai_image') {
                        messageContent = `<div class="ai-image-container"><img src="${message.image}" class="message-image" onclick="showImage('${message.image}')" alt="AIÁîüÊàêÁöÑÂõæÁâá"><div class="image-description">${message.imageDescription || ''}</div></div>`;
                    } else if (message.type === 'transfer') {
                        // ËΩ¨Ë¥¶Ê∂àÊÅØ
                        const isUser = message.role === 'user';
                        const heartIcon = isUser ? 'üíï' : 'üíñ';
                        const titleText = isUser ? '‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶' : 'Êî∂Âà∞ËΩ¨Ë¥¶';
                        let cardClass = '';
                        let statusHtml = '';
                        let clickHandler = '';
                        
                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ' : 'Â∑≤Êî∂Ê¨æ'}</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤ÈÄÄÂõû' : 'Â∑≤ÈÄÄÂõû'}</div>`;
                            cardClass = 'rejected';
                        } else if (!isUser) {
                            // AIÂèëÊù•ÁöÑËΩ¨Ë¥¶‰∏îÊú™Â§ÑÁêÜÔºåÊ∑ªÂä†ÁÇπÂáªÂ§ÑÁêÜ
                            clickHandler = `onclick="showTransferConfirmDialog(${JSON.stringify(message).replace(/"/g, '&quot;')})"`;
                        }
                        
                        messageContent = `<div class="transfer-message-container received"><div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}" ${clickHandler}><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div><div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>${statusHtml}</div></div>`;
                    } else {
                        const chatMode = chatSettings.chatMode || 'online';
                        messageContent = chatMode === 'offline' ? processOfflineContent(message.content) : message.content;
                    }
                    
                    let avatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        avatarHtml = `<div class="message-avatar" style="background-color: ${color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" ${character ? `onclick="pokeCharacter('${character.id}')" title="Êà≥‰∏ÄÊà≥"` : `title="${displayName}"`}>${displayAvatar ? '' : displayName.charAt(0)}${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                    let bubbleHtml = '';
                    if (message.type === 'voice_message' || message.type === 'transfer') {
                        // ËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑÊ∞îÊ≥°ÂåÖË£π
                        bubbleHtml = messageContent;
                    } else {
                        // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                        bubbleHtml = `<div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">${messageContent}${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                   // üî•„Äê‰øÆÂ§ç„ÄëÁæ§ËÅäÊòµÁß∞ÊòæÁ§∫ ÔºàloadMoreMessagesÁâàÊú¨Ôºâ- ÁâπÂà´Â§ÑÁêÜËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØ
                   if (isGroup && group && displayName !== 'Áæ§ÊàêÂëò') {
    messageContainer.classList.add('group-message-item');
    const senderNameHtml = `<div class="sender-name">${displayName}</div>`;
    
    if (message.type === 'voice_message' || message.type === 'transfer') {
        // üî•„Äê‰øÆÂ§ç„ÄëÂØπ‰∫éËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØÔºåÊòµÁß∞ÈúÄË¶ÅÂú®ÂÆπÂô®Â§ñÈÉ®
    messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    } else {
        // ÊôÆÈÄöÊ∂àÊÅØÁöÑÂ§ÑÁêÜ
        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    }
} else {
                    messageContainer.innerHTML = avatarHtml + bubbleHtml;
}
                } else {
                    let myDisplayAvatar = chatSettings.myChatAvatar;
                    if (!myDisplayAvatar && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona && selectedPersona.avatarUrl) {
                            myDisplayAvatar = selectedPersona.avatarUrl;
                        }
                    }
                    
                    const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                    const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                    const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                    const myBubblePadding = chatSettings.bubblePadding || '12';
                    
                    // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                    const transparentMyBubbleColor = convertColorWithOpacity(myBubbleColor, myBubbleOpacity);
                    
                    // Â§ÑÁêÜÁî®Êà∑ÁöÑÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                    let myMessageContent = '';
                    if (message.type === 'user_photo') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑ"ÁÖßÁâá"ÔºàÊñáÂ≠óÊèèËø∞Ôºâ
                        myMessageContent = `<div class="dreamy-photo-container" onclick="togglePhotoText(this, '${(message.photoDescription || message.content).replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')"><div class="dreamy-photo"><div class="photo-misty-bg"></div><div class="photo-badge"><i class="fas fa-image"></i></div><div class="sparkle-container"><div class="sparkle sparkle-1">‚ú®</div><div class="sparkle sparkle-2">‚≠ê</div><div class="sparkle sparkle-3">‚ú®</div><div class="sparkle sparkle-4">‚≠ê</div><div class="sparkle sparkle-5">üí´</div></div><div class="photo-text-overlay" style="display: none;"><div class="photo-description">${(message.photoDescription || message.content)}</div></div></div></div>`;
                    } else if (message.type === 'voice') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑËØ≠Èü≥Ê∂àÊÅØ
                        myMessageContent = `
                            <div class="voice-message-container sent">
                                <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${message.duration || Math.max(1, Math.ceil(message.content.length / 8))}"</div>
                                    </div>
                                    ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                    ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                </div>
                                <div class="voice-text-content">${message.content}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // Áî®Êà∑ËΩ¨Ë¥¶Ê∂àÊÅØ - Âú®loadMoreMessages‰∏≠Â§ÑÁêÜ
                        let cardClass = '';
                        let statusHtml = '';
                        
                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤Êî∂Ê¨æ</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤ÈÄÄÂõû</div>`;
                            cardClass = 'rejected';
                        }
                        
                        myMessageContent = `
                            <div class="transfer-message-container sent">
                                <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}">
                                    <div class="transfer-title">üíï ‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶</div>
                                    <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                    <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'location') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑ‰ΩçÁΩÆÊ∂àÊÅØ - Âú®loadMoreMessages‰∏≠Â§ÑÁêÜ
                        myMessageContent = `
                            <div class="location-message-container sent">
                                <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                                    <div class="location-card-header">${message.locationName}</div>
                                    <div class="location-card-map">
                                        <div class="map-background"></div>
                                        <div class="map-roads">
                                            <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                                            <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                                            <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                                        </div>
                                        <div class="map-buildings">
                                            <div class="building" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                                            <div class="building" style="top: 25%; left: 60%; width: 14px; height: 12px;"></div>
                                            <div class="building green" style="top: 50%; left: 15%; width: 8px; height: 8px;"></div>
                                            <div class="building" style="top: 70%; left: 70%; width: 10px; height: 8px;"></div>
                                            <div class="building green" style="top: 10%; left: 75%; width: 6px; height: 6px;"></div>
                                            <div class="building green" style="top: 75%; left: 25%; width: 7px; height: 7px;"></div>
                                        </div>
                                        <div class="map-marker">
                                            <div class="marker-pin">üìç</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØÊàñÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ (loadMoreMessagesÁâàÊú¨)
                        if (Array.isArray(message.content)) {
                            // Êñ∞ÁöÑÂ§öÊ®°ÊÄÅÊ†ºÂºè
                            const textPart = message.content.find(p => p.type === 'text');
                            const imagePart = message.content.find(p => p.type === 'image_url');
                            
                            myMessageContent = textPart?.text || '';
                            
                            // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáÊòæÁ§∫
                            if (imagePart?.image_url?.url) {
                                if (myMessageContent) {
                                    myMessageContent += '<br>';
                                }
                                myMessageContent += `<img src="${imagePart.image_url.url}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${imagePart.image_url.url}')">`;
                            }
                        } else {
                            // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØÊàñÊóßÊ†ºÂºè
                        myMessageContent = message.content;
                        }
                    }
                    
                    let myBubbleHtml = '';
                    
                    if (message.type === 'user_photo' || message.type === 'voice' || message.type === 'transfer' || message.type === 'location') {
                        // Áî®Êà∑ÁÖßÁâá„ÄÅËØ≠Èü≥Ê∂àÊÅØ„ÄÅËΩ¨Ë¥¶Ê∂àÊÅØÂíå‰ΩçÁΩÆÊ∂àÊÅØ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÊ∞îÊ≥°ÂåÖË£πÔºàÂ∑≤ÁªèÊúâËá™Â∑±ÁöÑÂÆπÂô®Ôºâ
                        myBubbleHtml = myMessageContent;
                    } else {
                        // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                        myBubbleHtml = `<div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">${myMessageContent}${message.image && !message.type && !Array.isArray(message.content) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                    let myAvatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        myAvatarHtml = `<div class="message-avatar" style="background-color: #007AFF; ${myDisplayAvatar ? `background-image: url(${myDisplayAvatar}); background-size: cover; background-position: center;` : ''}">${myDisplayAvatar ? '' : '<i class="fas fa-user"></i>'}${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                    messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                }
                
                // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®ÂíåÂè≥ÈîÆËèúÂçï
                addMessageLongPressListener(messageContainer, message.id);
                const bubble = messageContainer.querySelector('.message-bubble');
                if (bubble) {
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showMessageMenu(message.id, e);
                    });
                    
                    bubble.onclick = (e) => {
                        if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                            showImage(e.target.src);
                        }
                    };
                }
                
                // ÊèíÂÖ•Ê∂àÊÅØÂà∞Ê≠£Á°Æ‰ΩçÁΩÆ
                const insertAfter = messagesContainer.querySelector('.load-more-messages');
                if (insertAfter) {
                    insertAfter.parentNode.insertBefore(messageContainer, insertAfter.nextSibling);
                } else {
                    messagesContainer.insertBefore(messageContainer, messagesContainer.firstChild);
                }
            }
            
            // Êõ¥Êñ∞ÂÅèÁßªÈáè
            currentMessageOffset = newOffset;
            
            // ‰øùÊåÅÊªöÂä®‰ΩçÁΩÆ
            setTimeout(() => {
                const newScrollHeight = messagesContainer.scrollHeight;
                messagesContainer.scrollTop = scrollTop + (newScrollHeight - scrollHeight);
            }, 50);
        }
        
        
        // ÊòæÁ§∫ËßíËâ≤Ë°®Âçï
        function showCharacterForm(characterId = null) {
            currentEditingCharacterId = characterId; // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑËßíËâ≤ID
            document.getElementById('character-form-title').textContent = characterId ? 'ÁºñËæë‰∫∫Áâ©' : 'Êñ∞Âª∫‰∫∫Áâ©';
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';
            
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');
            
            // ÈáçÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            avatarPreviewText.style.display = 'block';
            avatarPreviewText.textContent = 'A';
            
            // Ê∏ÖÈô§‰∏¥Êó∂Â≠òÂÇ®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
            window.selectedAvatarData = null;
            
            // Â¶ÇÊûúÊòØÁºñËæëÊ®°ÂºèÔºåÂ°´ÂÖÖÁé∞ÊúâÊï∞ÊçÆ
            if (characterId) {
                const character = characters.find(c => c.id === characterId);
                if (character) {
                    document.getElementById('character-name').value = character.name;
                    document.getElementById('character-bio').value = character.bio;
                    
                    if (character.avatarUrl) {
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${character.avatarUrl})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        avatarPreviewText.style.display = 'none';
                        // ‰∏∫ÁºñËæëÊ®°Âºè‰øùÂ≠òÁé∞ÊúâÂ§¥ÂÉèÊï∞ÊçÆ
                        window.selectedAvatarData = character.avatarUrl;
                    } else {
                        avatarPreviewText.textContent = character.name.charAt(0);
                    }
                }
            }
            
            // ËÆæÁΩÆË°®ÂçïÁöÑ‰øùÂ≠òÂáΩÊï∞ÂíåÂà†Èô§ÊåâÈíÆÊòæÁ§∫
            const deleteBtn = document.getElementById('character-delete-btn');
            console.log('ËÆæÁΩÆ‰øùÂ≠òÊåâÈíÆÔºåcharacterId:', characterId);
            if (characterId) {
                document.querySelector('#character-form-screen .form-submit').onclick = async () => await saveCharacter(characterId);
                // ÁºñËæëÊ®°ÂºèÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
                if (deleteBtn) deleteBtn.style.display = 'block';
                console.log('ËÆæÁΩÆ‰∏∫ÁºñËæëÊ®°ÂºèÔºåËßíËâ≤ID:', characterId);
            } else {
                document.querySelector('#character-form-screen .form-submit').onclick = async () => await saveCharacter();
                // Êñ∞Âª∫Ê®°ÂºèÈöêËóèÂà†Èô§ÊåâÈíÆ
                if (deleteBtn) deleteBtn.style.display = 'none';
                console.log('ËÆæÁΩÆ‰∏∫ÂàõÂª∫Ê®°ÂºèÔºåÊó†ËßíËâ≤ID');
            }
            
            showApp('character-form-screen');
            
            // Á°Æ‰øùÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩÂèØÁî® - ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®Ôºà‰ª•Èò≤‰∏á‰∏ÄÔºâ
            setTimeout(() => {
                initializeAvatarUpload();
            }, 100);
        }
        
        // ‰øùÂ≠òËßíËâ≤
        async function saveCharacter(characterId = null) {
            try {
                console.log('=== ÂºÄÂßã‰øùÂ≠òËßíËâ≤ ===');
                const name = document.getElementById('character-name').value.trim();
                const bio = document.getElementById('character-bio').value.trim();
                const avatarData = window.selectedAvatarData; // ‰ΩøÁî®È¢ÑÂ§ÑÁêÜÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                
                console.log('‰øùÂ≠òËßíËâ≤ - ÂßìÂêç:', name, 'Â§¥ÂÉèÊï∞ÊçÆÂ≠òÂú®:', !!avatarData);
                if (avatarData) {
                    console.log('Â§¥ÂÉèÊï∞ÊçÆÈïøÂ∫¶:', avatarData.length, 'ÂºÄÂ§¥:', avatarData.substring(0, 50));
                }
                
                if (!name) {
                    alert('ËØ∑ËæìÂÖ•ÂßìÂêç');
                    return;
                }
                
                if (characterId) {
                    console.log('=== Êõ¥Êñ∞Áé∞ÊúâËßíËâ≤ ===');
                    // Êõ¥Êñ∞Áé∞ÊúâËßíËâ≤
                    const index = characters.findIndex(c => c.id === characterId);
                    if (index !== -1) {
                        const oldAvatarUrl = characters[index].avatarUrl;
                        
                        characters[index] = {
                            ...characters[index],
                            name,
                            bio,
                            avatarUrl: avatarData || characters[index].avatarUrl || '',
                            color: characters[index].color || getRandomColor()
                        };
                        
                        console.log('Êõ¥Êñ∞ËßíËâ≤ÂÆåÊàê:', characters[index]);
                        
                        // üî•„Äê‰øÆÂ§ç1„ÄëÂ¶ÇÊûúÂ§¥ÂÉèÂèëÁîü‰∫ÜÂèòÂåñÔºåÊõ¥Êñ∞ÊâÄÊúâÁõ∏ÂÖ≥Áæ§ËÅä‰∏≠ÁöÑÊàêÂëòÂ§¥ÂÉè
                        if (avatarData && avatarData !== oldAvatarUrl) {
                            updateCharacterAvatarInGroups(characterId, avatarData);
                        }
                        
                        // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞ÁïåÈù¢
                        await saveCharacters();
                        renderContactList();
                        renderMessageList();
                        
                        // üî•„Äê‰øÆÂ§ç2„ÄëÂ¶ÇÊûúÂΩìÂâçÊ≠£Âú®ËÅäÂ§©‰∏îÊòØËØ•ËßíËâ≤ÔºåÂà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            renderChatMessages(currentChatCharacter.id);
                        }
                        
                        showToast(`ËßíËâ≤ "${name}" Â∑≤Êõ¥Êñ∞ÔºÅ`, 'success');
                        hideCharacterForm();
                        // Ê≥®ÊÑèÔºö‰∏çÁ´ãÂç≥Ê∏ÖÁ©∫Ë°®ÂçïÔºåËÆ©Áî®Êà∑ËÉΩÁúãÂà∞‰øùÂ≠òÊàêÂäüÁöÑÁä∂ÊÄÅ
                    }
                } else {
                    console.log('=== ÂàõÂª∫Êñ∞ËßíËâ≤ ===');
                    // ÂàõÂª∫Êñ∞ËßíËâ≤
                    const newCharacter = {
                        id: Date.now().toString(),
                        name,
                        bio,
                        avatarUrl: avatarData || '',
                        color: getRandomColor()
                    };
                    
                    console.log('ÂàõÂª∫Êñ∞ËßíËâ≤:', newCharacter);
                    console.log('Êñ∞ËßíËâ≤Â§¥ÂÉèURL:', newCharacter.avatarUrl);
                    console.log('Êñ∞ËßíËâ≤Â§¥ÂÉèURLÈïøÂ∫¶:', newCharacter.avatarUrl ? newCharacter.avatarUrl.length : 0);
                    
                    console.log('Ê∑ªÂä†ËßíËâ≤ÂâçÔºåÂΩìÂâçËßíËâ≤Êï∞ÁªÑÈïøÂ∫¶:', characters.length);
                    characters.push(newCharacter);
                    console.log('Ê∑ªÂä†ËßíËâ≤ÂêéÔºåÂΩìÂâçËßíËâ≤Êï∞ÁªÑÈïøÂ∫¶:', characters.length);
                    
                    console.log('ËßíËâ≤Êï∞ÁªÑÊúÄÊñ∞Áä∂ÊÄÅ:', characters);
                    
                    // üî•„Äê‰øÆÂ§ç„Äë‰∏çÂÜçËá™Âä®Ê∑ªÂä†Âà∞ËÅîÁ≥ª‰∫∫ÂàóË°®ÔºåÁî®Êà∑ÈúÄË¶ÅÈÄöËøáÂàõÂª∫ÂØπËØùÊù•Âª∫Á´ãËÅîÁ≥ª
                    
                    // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞ÁïåÈù¢
                    console.log('ÂºÄÂßã‰øùÂ≠òÂà∞IndexedDB...');
                    await saveCharacters();
                    console.log('‰øùÂ≠òÂêéÊ£ÄÊü•ËßíËâ≤Êï∞ÁªÑ:', characters);
                    
                    console.log('ÂºÄÂßãÊ∏≤ÊüìÁïåÈù¢...');
                    renderContactList();
                    renderMessageList();
                    
                    console.log('ÂºÄÂßãÈöêËóèË°®Âçï...');
                    hideCharacterForm();
                    // Ê≥®ÊÑèÔºö‰∏çÁ´ãÂç≥Ê∏ÖÁ©∫Ë°®ÂçïÔºåËÆ©Áî®Êà∑ËÉΩÁúãÂà∞‰øùÂ≠òÊàêÂäüÁöÑÁä∂ÊÄÅ
                    
                    // ÁªôÁî®Êà∑ÂèçÈ¶à
                    showToast(`ËßíËâ≤ "${newCharacter.name}" ÂàõÂª∫ÊàêÂäüÔºÅ`, 'success');
                    
                    console.log('=== ‰øùÂ≠òËßíËâ≤ÂÆåÊàê ===');
                }
            } catch (error) {
                console.error('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ:', error);
                alert('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ: ' + error.message);
            }
        }
        
        // Ê∏ÖÁ©∫ËßíËâ≤Ë°®Âçï
        function clearCharacterForm() {
            console.log('Ê∏ÖÁ©∫ËßíËâ≤Ë°®ÂçïË¢´Ë∞ÉÁî®');
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';
            
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');
            
            // ÈáçÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            if (avatarPreviewText) {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = 'A';
            }
            
            // Ê∏ÖÈô§‰∏¥Êó∂Â≠òÂÇ®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
            console.log('Ê∏ÖÈô§‰∏¥Êó∂Â§¥ÂÉèÊï∞ÊçÆ');
            window.selectedAvatarData = null;
        }
        
        // ÁºñËæëËßíËâ≤
        function editCharacter(characterId) {
            showCharacterForm(characterId);
        }
        
        // ‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®ÁºñËæëËßíËâ≤
        function editCharacterFromContactList(characterId) {
            showCharacterForm(characterId);
        }
        
        // ËøõÂÖ•Â§öÈÄâÊ®°Âºè
        function enterMultiSelectMode(characterId) {
            isMultiSelectMode = true;
            selectedCharacters = [characterId]; // ÂàùÂßãÈÄâ‰∏≠Ëß¶ÂèëÈïøÊåâÁöÑËßíËâ≤
            renderContactList();
        }
        
        // ÈÄÄÂá∫Â§öÈÄâÊ®°Âºè
        function exitMultiSelectMode() {
            isMultiSelectMode = false;
            selectedCharacters = [];
            renderContactList();
        }
        
        // ÂàáÊç¢ËßíËâ≤ÈÄâÊã©Áä∂ÊÄÅ
        function toggleCharacterSelection(characterId) {
            const index = selectedCharacters.indexOf(characterId);
            if (index > -1) {
                selectedCharacters.splice(index, 1);
            } else {
                selectedCharacters.push(characterId);
            }
            renderContactList();
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑËßíËâ≤
        async function deleteSelectedCharacters() {
            if (selectedCharacters.length === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËßíËâ≤');
                return;
            }
            
            const characterNames = selectedCharacters.map(id => {
                const character = characters.find(c => c.id === id);
                return character ? character.name : '';
            }).filter(name => name).join('„ÄÅ');
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∫õËßíËâ≤ÂêóÔºü\n${characterNames}\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                // Âà†Èô§ËßíËâ≤
                selectedCharacters.forEach(characterId => {
                    characters = characters.filter(c => c.id !== characterId);
                    contacts = contacts.filter(c => c !== characterId);
                    
                    // Âà†Èô§Áõ∏ÂÖ≥ËÅäÂ§©ËÆ∞ÂΩï
                    if (chatMessages[characterId]) {
                        delete chatMessages[characterId];
                    }
                });
                
                // ‰øùÂ≠òÊï∞ÊçÆ
                await saveCharacters();
                await saveContacts();
                await saveChatMessages();
                
                // ÈÄÄÂá∫Â§öÈÄâÊ®°ÂºèÂπ∂Êõ¥Êñ∞ÁïåÈù¢
                exitMultiSelectMode();
                renderMessageList();
                
                alert('ËßíËâ≤Âà†Èô§ÊàêÂäü');
            }
        }
        
        // Âà†Èô§ÂΩìÂâçÁºñËæëÁöÑËßíËâ≤
        async function deleteCurrentCharacter() {
            if (currentEditingCharacterId) {
                const character = characters.find(c => c.id === currentEditingCharacterId);
                
                if (character && confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ËßíËâ≤"${character.name}"ÂêóÔºü\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                    // Âà†Èô§ËßíËâ≤
                    characters = characters.filter(c => c.id !== character.id);
                    contacts = contacts.filter(c => c !== character.id);
                    
                    // Âà†Èô§Áõ∏ÂÖ≥ËÅäÂ§©ËÆ∞ÂΩï
                    if (chatMessages[character.id]) {
                        delete chatMessages[character.id];
                    }
                    
                    // ‰øùÂ≠òÊï∞ÊçÆ
                    await saveCharacters();
                    await saveContacts();
                    await saveChatMessages();
                    
                    // Êõ¥Êñ∞ÁïåÈù¢Âπ∂ËøîÂõû
                    renderContactList();
                    renderMessageList();
                    hideCharacterForm();
                    
                    alert('ËßíËâ≤Âà†Èô§ÊàêÂäü');
                }
            }
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÊõ¥Êñ∞ËßíËâ≤Âú®ÊâÄÊúâÁæ§ËÅä‰∏≠ÁöÑÂ§¥ÂÉè
        function updateCharacterAvatarInGroups(characterId, newAvatarUrl) {
            // ÈÅçÂéÜÊâÄÊúâËßíËâ≤ÔºåÊâæÂà∞Áæ§ËÅä
            characters.forEach(character => {
                if (character.isGroup && character.members) {
                    // Âú®ËØ•Áæ§ËÅä‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑÊàêÂëò
                    const memberIndex = character.members.findIndex(member => member.id === characterId);
                    if (memberIndex !== -1) {
                        // Êõ¥Êñ∞ËØ•ÊàêÂëòÁöÑÂ§¥ÂÉè
                        character.members[memberIndex].avatarUrl = newAvatarUrl;
                        console.log(`Â∑≤Êõ¥Êñ∞Áæ§ËÅä "${character.name}" ‰∏≠ÊàêÂëò "${character.members[memberIndex].name}" ÁöÑÂ§¥ÂÉè`);
                    }
                }
            });
            
            // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑËßíËâ≤Êï∞ÊçÆ
            saveCharacters();
        }
        
        // Ëé∑ÂèñÈöèÊú∫È¢úËâ≤
        function getRandomColor() {
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#5AC8FA', '#007AFF', '#5856D6', '#AF52DE'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // ÊòæÁ§∫Ê∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü
        function showAddContactModal() {
            showCharacterForm(); // Áõ¥Êé•ÊòæÁ§∫ÂàõÂª∫ËßíËâ≤Ë°®Âçï
        }
        
        // Ê∑ªÂä†ÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫
        async function addSelectedContacts() {
            const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
            checkboxes.forEach(checkbox => {
                const characterId = checkbox.value;
                if (!contacts.includes(characterId)) {
                    contacts.push(characterId);
                }
            });
            
            await saveContacts();
            renderMessageList();
            renderContactList();
            hideModal('add-contact-modal');
        }
        
        // ÂºÄÂßã‰∏éËßíËâ≤ËÅäÂ§©
        function startChat(character) {
            currentChatCharacter = character;
            
            // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑÊòµÁß∞ËÆæÁΩÆ
            const chatSettings = getCurrentChatSettings();
            const displayTitle = chatSettings.aiChatNickname || character.name;
            document.getElementById('api-chat-title').textContent = displayTitle;
            
            // ÂàùÂßãÂåñÁ©∫ÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰∏çËá™Âä®ÂèëÈÄÅÊ∂àÊÅØÔºâ
            if (!chatMessages[character.id]) {
                chatMessages[character.id] = [];
                saveChatMessages();
            }
            
            // ÈáçÁΩÆÊÇ¨ÊµÆÊåâÈíÆÁä∂ÊÄÅ
            resetFloatingButtonsState();
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂ¶ÇÊûúËÆæÁΩÆÁïåÈù¢ÊòØÊâìÂºÄÁöÑÔºåÊõ¥Êñ∞ËÆæÁΩÆÊòæÁ§∫Áä∂ÊÄÅ
            if (document.getElementById('api-chat-settings-screen').style.display === 'flex') {
                updateChatSettingsDisplay();
            }
            
            // ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
            initBackgroundInteractionSystem();
            
            // ÂàùÂßãÂåñÂÆöÊó∂ÂèëÂ∏ÉÁ≥ªÁªü
            initScheduledMomentsSystem();
            
            renderChatMessages(character.id);
            showApp('api-chat-screen');
        }
        
        // ‰ªéËÅäÂ§©ÁïåÈù¢ËøîÂõûÂà∞ËÅäÂ§©Â∫îÁî®
        function backToChatApp() {
            // Ê∏ÖÈô§ÂΩìÂâçËßíËâ≤ÁöÑÂêéÂè∞ÂÆöÊó∂Âô®
            clearAllBackgroundTimers();
            hideApp('api-chat-screen');
            showApp('chat-screen');
        }
        
        // ‰ªéËÆæÁΩÆÂ≠êÈ°µÈù¢ËøîÂõûÂà∞ËÆæÁΩÆ‰∏ªÈ°µÈù¢
        function backToSettings(currentScreen) {
            hideApp(currentScreen);
            showApp('settings-screen');
        }
        

        
        // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
        function showTypingIndicator() {
            console.log('üîß Â∞ùËØïÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫...');
            let indicator = document.getElementById('typing-indicator');
            
            // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂÖÉÁ¥†ÔºåÂ∞ùËØïÂàõÂª∫‰∏Ä‰∏™
            if (!indicator) {
                console.log('‚ö†Ô∏è Êú™ÊâæÂà∞typing-indicatorÂÖÉÁ¥†ÔºåÊ≠£Âú®ÂàõÂª∫...');
                const messagesContainer = document.getElementById('api-chat-messages');
                if (messagesContainer) {
                    indicator = document.createElement('div');
                    indicator.id = 'typing-indicator';
                    indicator.className = 'typing-indicator';
                    
                    // Ëé∑ÂèñÂΩìÂâçËßíËâ≤ÂêçÁß∞
                    const chatSettings = getCurrentChatSettings();
                    const characterName = chatSettings.aiChatNickname || (currentChatCharacter ? currentChatCharacter.name : 'ÂØπÊñπ');
                    
                    indicator.innerHTML = `${characterName}Ê≠£Âú®ËæìÂÖ•‰∏≠<span class="dots"></span>`;
                    messagesContainer.appendChild(indicator);
                    console.log('‚úÖ Â∑≤ÂàõÂª∫typing-indicatorÂÖÉÁ¥†');
                } else {
                    console.error('‚ùå Êâæ‰∏çÂà∞Ê∂àÊÅØÂÆπÂô®ÔºåÊó†Ê≥ïÂàõÂª∫typing-indicator');
                    return;
                }
            }
            
            if (indicator) {
                console.log('‚úÖ ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫');
                indicator.classList.add('show');
                // ÊªöÂä®Âà∞Â∫ïÈÉ®ÊòæÁ§∫ÊèêÁ§∫
                const messagesContainer = document.getElementById('api-chat-messages');
                if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } else {
                console.error('‚ùå ‰ªçÁÑ∂Êâæ‰∏çÂà∞typing-indicatorÂÖÉÁ¥†');
            }
        }
        
        // ÈöêËóèÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫
        function hideTypingIndicator() {
            console.log('üîß Â∞ùËØïÈöêËóèÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫...');
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                console.log('‚úÖ ÈöêËóèÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫');
                indicator.classList.remove('show');
            } else {
                console.log('‚ö†Ô∏è Êú™ÊâæÂà∞typing-indicatorÂÖÉÁ¥†ÔºåÂèØËÉΩÂ∑≤Ë¢´ÁßªÈô§');
            }
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢Ôºà‰∏çÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®Ôºâ
        function addSystemMessageToChat(systemMessage) {
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer) return;
            
            // ÂàõÂª∫Â§ñÂ±ÇÂÆπÂô®ÔºåÁî®‰∫éÂ±Ö‰∏≠
            const centerContainer = document.createElement('div');
            centerContainer.style.display = 'flex';
            centerContainer.style.justifyContent = 'center';
            centerContainer.style.margin = '4px 0';
            
            // ÂàõÂª∫Á≥ªÁªüÊ∂àÊÅØÂÆπÂô®
            const systemContainer = document.createElement('div');
            systemContainer.className = 'system-message';
            systemContainer.textContent = systemMessage.content;
            
            // Â∞ÜÁ≥ªÁªüÊ∂àÊÅØÊîæÂÖ•Â±Ö‰∏≠ÂÆπÂô®
            centerContainer.appendChild(systemContainer);
            
            // ÊèíÂÖ•Âà∞Ê∂àÊÅØÂÆπÂô®ÁöÑÊúÄÂêéÔºàÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫‰πãÂâçÔºâ
            const typingIndicator = messagesContainer.querySelector('#typing-indicator');
            if (typingIndicator) {
                messagesContainer.insertBefore(centerContainer, typingIndicator);
            } else {
                messagesContainer.appendChild(centerContainer);
            }
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÊí§ÂõûÊ∂àÊÅØÂäüËÉΩ
        async function handleRecalledMessage(messageContent, targetMessageId = null) {
            if (!currentChatCharacter) return;
            
            console.log('Â§ÑÁêÜÊí§ÂõûÊ∂àÊÅØ:', messageContent, 'ÁõÆÊ†áÊ∂àÊÅØID:', targetMessageId);
            
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer) return;
            
            const character = characters.find(c => c.id === currentChatCharacter.id);
            const chatSettings = getCurrentChatSettings();
            const displayName = chatSettings.aiChatNickname || character.name;
            
            let messageContainer = null;
            
            // Â¶ÇÊûúÊèê‰æõ‰∫ÜÁõÆÊ†áÊ∂àÊÅØIDÔºåÊü•ÊâæÂπ∂Êí§ÂõûÁé∞ÊúâÊ∂àÊÅØ
            if (targetMessageId) {
                messageContainer = messagesContainer.querySelector(`[data-message-id="${targetMessageId}"]`);
                if (messageContainer) {
                    console.log('ÊâæÂà∞Ë¶ÅÊí§ÂõûÁöÑÁé∞ÊúâÊ∂àÊÅØÔºåÂáÜÂ§áÊí§Âõû');
                    
                    // Á≠âÂæÖ1.2ÁßíÂêéÊí§Âõû
                    await new Promise(resolve => setTimeout(resolve, 1200));
                    
                    // Ê∑ªÂä†Ê∑°Âá∫Âä®Áîª
                    messageContainer.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                    
                    // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // ‰ªéËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÁßªÈô§ËøôÊù°Ê∂àÊÅØ
                    if (chatMessages[currentChatCharacter.id]) {
                        const messageIndex = chatMessages[currentChatCharacter.id].findIndex(msg => msg.id === targetMessageId);
                        if (messageIndex !== -1) {
                            chatMessages[currentChatCharacter.id].splice(messageIndex, 1);
                            saveChatMessages();
                        }
                    }
                } else {
                    console.warn('Êú™ÊâæÂà∞Ë¶ÅÊí§ÂõûÁöÑÊ∂àÊÅØÔºåÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØ');
                    // Â¶ÇÊûúÊâæ‰∏çÂà∞Ê∂àÊÅØÔºåÂõûÈÄÄÂà∞ÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØÁöÑÊñπÂºè
                    messageContainer = await createTemporaryMessage(messageContent);
                }
            } else {
                // Ê≤°ÊúâÊèê‰æõÁõÆÊ†áIDÔºåÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØ
                messageContainer = await createTemporaryMessage(messageContent);
            }
            
            if (!messageContainer) return;
            
            // ÂàõÂª∫Êí§ÂõûÊèêÈÜíÁöÑÂ±Ö‰∏≠ÂÆπÂô®
            const centerContainer = document.createElement('div');
            centerContainer.style.display = 'flex';
            centerContainer.style.justifyContent = 'center';
            centerContainer.style.margin = '4px 0';
            
            // ÂàõÂª∫Êí§ÂõûÊ∂àÊÅØÂÖÉÁ¥†
            const recallElement = document.createElement('div');
            recallElement.className = 'recalled-message';
            
            // ‰∏ªË¶ÅÊèêÈÜíÊñáÂ≠ó
            const mainText = document.createElement('div');
            mainText.style.marginBottom = '2px';
            mainText.textContent = `${displayName} Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ`;
            
            // ÂéüÊñáÊòæÁ§∫
            const originalText = document.createElement('div');
            originalText.className = 'original-text';
            originalText.textContent = `ÂéüÊñáÔºö${messageContent}`;
            
            recallElement.appendChild(mainText);
            recallElement.appendChild(originalText);
            centerContainer.appendChild(recallElement);
            
            // Âú®ÂéüÊ∂àÊÅØ‰ΩçÁΩÆÊõøÊç¢‰∏∫Êí§ÂõûÊèêÈÜí
            messageContainer.parentNode.insertBefore(centerContainer, messageContainer);
            messageContainer.remove();
            
            // Ê∑ªÂä†Êí§ÂõûÊ∂àÊÅØÂà∞ËÅäÂ§©ÂéÜÂè≤
            const recalledMessage = {
                id: `recalled_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                sender: 'system',
                type: 'recalled_message',
                content: `${displayName} Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ\nÂéüÊñáÔºö${messageContent}`,
                originalContent: messageContent,
                    timestamp: Date.now()
                };
                
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(recalledMessage);
                saveChatMessages();
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // ÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØÁöÑËæÖÂä©ÂáΩÊï∞
            async function createTemporaryMessage(content) {
                const messageId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const tempContainer = document.createElement('div');
                const isEmojiOnly = false;
                tempContainer.className = `message-container received${isEmojiOnly ? ' emoji-only' : ''}`;
                tempContainer.dataset.messageId = messageId;
                
                const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                const bubblePadding = chatSettings.bubblePadding || '12';
                const displayAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || character.avatarUrl;
                
                let avatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    avatarHtml = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" onclick="pokeCharacter('${character.id}')" title="Êà≥‰∏ÄÊà≥">
                            ${displayAvatar ? '' : displayName.charAt(0)}
                        </div>
                    `;
                }
                
                // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);
                
                let bubbleHtml = `
                    <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                        ${content}
                    </div>
                `;
                
                tempContainer.innerHTML = avatarHtml + bubbleHtml;
                
                // Ê∑ªÂä†Âà∞Ê∂àÊÅØÂÆπÂô®
                const typingIndicator = messagesContainer.querySelector('#typing-indicator');
                if (typingIndicator) {
                    messagesContainer.insertBefore(tempContainer, typingIndicator);
                } else {
                    messagesContainer.appendChild(tempContainer);
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Á≠âÂæÖ1.2ÁßíÂêéÊí§Âõû
                await new Promise(resolve => setTimeout(resolve, 1200));
                
                // Ê∑ªÂä†Ê∑°Âá∫Âä®Áîª
                tempContainer.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                
                // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
                await new Promise(resolve => setTimeout(resolve, 500));
                
                return tempContainer;
            }
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëËé∑ÂèñÁî®Êà∑ÊúÄËøëÂèëÈÄÅÁöÑÂõæÁâáURL
        function getRecentUserImage() {
            if (!currentChatCharacter || !chatMessages[currentChatCharacter.id]) {
                return null;
            }
            
            const messages = chatMessages[currentChatCharacter.id];
            // ‰ªéÊúÄÊñ∞Ê∂àÊÅØÂºÄÂßãÂêëÂâçÊü•ÊâæÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâá
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                if (msg.sender === 'sent' && msg.image && !msg.isEmoji) {
                    console.log('ÊâæÂà∞Áî®Êà∑ÊúÄËøëÂèëÈÄÅÁöÑÂõæÁâá:', msg.image);
                    return msg.image;
                }
            }
            
            console.log('Ê≤°ÊúâÊâæÂà∞Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâá');
            return null;
        }
        
        // APIË∞ÉÁî®ÂáΩÊï∞ - Âü∫‰∫éÁé∞ÊúâÁöÑAPIÈÄªËæë
        async function callChatAPI(prompt, character) {
            try {
                // Ëé∑ÂèñËßíËâ≤ËÆæÁΩÆ
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(character.id);
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
                
                const persona = chatSettings?.aiPersona || character.prompt || `‰Ω†ÊòØ${character.name}„ÄÇ`;
                
                // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                        const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                        );
                        const validWorldBooks = worldBooks.filter(book => book && book.content);
                        if (validWorldBooks.length > 0) {
                            worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                                validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
                        }
                    } catch (error) {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    }
                }
                
                // Ëé∑ÂèñËÅäÂ§©‰∏ä‰∏ãÊñá
                let chatContext = '';
                const characterMessages = chatMessages[character.id] || [];
                if (characterMessages.length > 0) {
                    const maxMemory = parseInt(chatSettings?.maxMemory) || 10;
                    const recentHistory = characterMessages.slice(-maxMemory);
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                        recentHistory.map(msg => {
                            if (msg.sender === 'sent') return `Áî®Êà∑Ôºö${msg.content}`;
                            return `${character.name}Ôºö${msg.content}`;
                        }).join('\n');
                }
                
                const systemPrompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${persona}„ÄÇ${worldBookContent}${chatContext}

ËØ∑‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãJSONÊ†ºÂºèÂõûÂ§çÔºåÊØèÊù°Ê∂àÊÅØÈÉΩÂøÖÈ°ªÊòØÁã¨Á´ãÁöÑÊï∞ÁªÑÂÖÉÁ¥†Ôºö

Ê≠£Á°ÆÊ†ºÂºèÁ§∫‰æãÔºö
["ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ"]
["Ê∂àÊÅØ1", "Ê∂àÊÅØ2"]
[{"type": "voice_message", "content": "ËØ≠Èü≥ÂÜÖÂÆπ"}]
[{"type": "emoji", "description": "Ë°®ÊÉÖÂåÖÊèèËø∞"}]
[{"type": "ai_image", "description": "ÂõæÁâáÊèèËø∞"}]
[{"type": "transfer", "amount": 100, "note": "ËΩ¨Ë¥¶Â§áÊ≥®"}]

üö® ÈáçË¶ÅÔºöÁªùÂØπ‰∏çËÉΩÂ∞ÜÂ§öÊù°Ê∂àÊÅØÂêàÂπ∂Âú®‰∏Ä‰∏™ÂÖÉÁ¥†‰∏≠ÔºÅÈîôËØØÊ†ºÂºèÔºö["Ê∂àÊÅØ1\\nÊ∂àÊÅØ2"]

Áé∞Âú®ËØ∑ÂØπÁî®Êà∑ÁöÑÊ∂àÊÅØËøõË°åÂõûÂ§çÔºö${prompt}`;

                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: prompt }
                ];

                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáAIÂõûÂ§ç');
                    return '["APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI"]';
                }

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response;
                if (isGeminiOfficial) {
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
                    
                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                        });
                    }
                    
                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;
                        
                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`ËÅäÂ§©APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
                    return `["APIË∞ÉÁî®Â§±Ë¥•: ${response.status}"]`;
                }

                const data = await response.json();
                let content;

                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return '["Gemini APIÂìçÂ∫îÂºÇÂ∏∏"]';
                    }
                } else {
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        console.error('Êó†Ê≥ïËß£ÊûêAPIÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return '["APIÂìçÂ∫îËß£ÊûêÂ§±Ë¥•"]';
                    }
                }

                return content;

            } catch (error) {
                console.error('callChatAPIÂ§±Ë¥•:', error);
                return `["Ë∞ÉÁî®Â§±Ë¥•: ${error.message}"]`;
            }
        }
        
        // Â∏¶ÂõæÁâáÁöÑAPIË∞ÉÁî®ÂáΩÊï∞
        async function callChatAPIWithImage(prompt, character, imageUrl) {
            // ÂõæÂÉèÂäüËÉΩÊöÇÊú™ÂÆûÁé∞Ôºå‰ΩøÁî®ÊôÆÈÄöAPIË∞ÉÁî®
            const imagePrompt = `${prompt}\n\n[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºå‰ΩÜÂõæÂÉèËØÜÂà´ÂäüËÉΩÊöÇÊú™ÂÆûÁé∞]`;
            return await callChatAPI(imagePrompt, character);
        }
        
        // Ëß£ÊûêAIÂõûÂ§ç - ÊåâÁÖßindex.htmlÁöÑÈÄªËæëÔºåÊñ∞Â¢ûË°®ÊÉÖÂåÖÊîØÊåÅÂíåÊ†ºÂºè‰øÆÊ≠£
        function parseAiResponse(content) { 
            try { 
                const parsed = JSON.parse(content); 
                if (Array.isArray(parsed)) {
                    // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜË°®ÊÉÖÂåÖÊ∂àÊÅØÁ±ªÂûãÂíåÊ†ºÂºè‰øÆÊ≠£
                    const processedMessages = [];
                    
                    parsed.forEach(item => {
                        if (typeof item === 'object' && item.type === 'emoji') {
                            // Êü•ÊâæÂåπÈÖçÁöÑË°®ÊÉÖÂåÖ
                            const matchingEmoji = customEmojis.find(emoji => 
                                emoji.description === item.description
                            );
                            
                            if (matchingEmoji) {
                                // Ê£ÄÊü•Ë°®ÊÉÖÂåÖÊòØÂê¶‰∏∫GIFÊ†ºÂºè
                                if (matchingEmoji.url && matchingEmoji.url.includes('data:image/gif')) {
                                    console.warn('AIÂ∞ùËØï‰ΩøÁî®GIFÊ†ºÂºèË°®ÊÉÖÂåÖ:', item.description);
                                    processedMessages.push(`[${matchingEmoji.description}] (GIFÊ†ºÂºè‰∏çÊîØÊåÅAPIËØÜÂà´)`);
                                } else {
                                // ËøîÂõûË°®ÊÉÖÂåÖÂØπË±°ÔºåÂåÖÂê´ÂÆåÊï¥ÁöÑË°®ÊÉÖÂåÖ‰ø°ÊÅØ
                                    processedMessages.push({
                                    type: 'emoji',
                                    url: matchingEmoji.url,
                                    description: matchingEmoji.description,
                                    id: matchingEmoji.id
                                    });
                                }
                                                            } else {
                                    // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÁöÑË°®ÊÉÖÂåÖÔºåËøîÂõûÈîôËØØÊ∂àÊÅØ
                                    console.warn('AIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂåÖ:', item.description);
                                    processedMessages.push(`[ÈîôËØØ: Ë°®ÊÉÖÂåÖ"${item.description}"‰∏çÂ≠òÂú®]`);
                                }
                        } else if (typeof item === 'object' && item.type === 'change_avatar') {
                            // Â§ÑÁêÜÂ§¥ÂÉèÊõ¥Êç¢ÂØπË±°
                            console.log('Ëß£ÊûêÂà∞Â§¥ÂÉèÊõ¥Êç¢Êåá‰ª§:', item);
                            
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÂêÑÁßçÈîôËØØÁöÑÂç†‰ΩçÁ¨¶
                            if (item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                item.avatar_url === 'Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáURL' ||
                                item.avatar_url === 'ÂõæÁâáURL') {
                                // Ëé∑ÂèñÊúÄËøëÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáURL
                                const recentUserImage = getRecentUserImage();
                                if (recentUserImage) {
                                    item.avatar_url = recentUserImage;
                                    console.log('Â∞ÜÂç†‰ΩçÁ¨¶ÊõøÊç¢‰∏∫ÂÆûÈôÖÂõæÁâáURL:', recentUserImage);
                                } else {
                                    console.warn('Ê≤°ÊúâÊâæÂà∞Áî®Êà∑ÊúÄËøëÂèëÈÄÅÁöÑÂõæÁâáÔºåÂøΩÁï•Â§¥ÂÉèÊõ¥Êç¢ËØ∑Ê±Ç');
                                    processedMessages.push(`[Á≥ªÁªüÔºöÊó†Ê≥ïÊõ¥Êç¢Â§¥ÂÉèÔºåÊ≤°ÊúâÊâæÂà∞ÂèØÁî®ÁöÑÂõæÁâá]`);
                                    // ‰∏çË¶ÅreturnÔºåÁªßÁª≠Â§ÑÁêÜÂÖ∂‰ªñÊ∂àÊÅØ
                                }
                            }
                            
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'ai_image') {
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅÂõæÁâá
                            console.log('Ëß£ÊûêÂà∞AIÂõæÁâáÂèëÈÄÅÊåá‰ª§:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'voice_message') {
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅËØ≠Èü≥
                            console.log('Ëß£ÊûêÂà∞AIËØ≠Èü≥ÂèëÈÄÅÊåá‰ª§:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'transfer') {
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIËΩ¨Ë¥¶

                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'update_poke_suffix') {
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊà≥‰∏ÄÊà≥ÂêéÁºÄÊõ¥Êñ∞
                            console.log('Ëß£ÊûêÂà∞Êà≥‰∏ÄÊà≥ÂêéÁºÄÊõ¥Êñ∞Êåá‰ª§:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'recalled_message') {
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊí§ÂõûÊ∂àÊÅØ
                            console.log('Ëß£ÊûêÂà∞Êí§ÂõûÊ∂àÊÅØÊåá‰ª§:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'string') {
                            // üö® „ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•Âπ∂‰øÆÂ§çÂêàÂπ∂Ê∂àÊÅØÈóÆÈ¢ò
                            if (item.includes('\n')) {
                                console.warn('Ê£ÄÊµãÂà∞AIÂ∞ÜÂ§öÊù°Ê∂àÊÅØÂêàÂπ∂Âú®‰∏Ä‰∏™ÂÖÉÁ¥†‰∏≠ÔºåÊ≠£Âú®Ëá™Âä®ÂàÜÊãÜ:', item);
                                // Â∞ÜÊç¢Ë°åÁ¨¶ÂàÜÈöîÁöÑÂÜÖÂÆπÂàÜÊãÜÊàêÂ§öÊù°Ê∂àÊÅØ
                                const splitMessages = item.split('\n')
                                    .map(msg => msg.trim())
                                    .filter(msg => msg.length > 0);
                                processedMessages.push(...splitMessages);
                            } else {
                                processedMessages.push(item);
                            }
                        } else {
                            processedMessages.push(item);
                        }
                    });
                    
                    return processedMessages;
                }
            } catch (e) {} 
            
            try { 
                const match = content.match(/\[(.*?)\]/s); 
                if (match && match[0]) { 
                    const parsed = JSON.parse(match[0]); 
                    if (Array.isArray(parsed)) {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜË°®ÊÉÖÂåÖÊ∂àÊÅØÁ±ªÂûãÂíåÊ†ºÂºè‰øÆÊ≠£
                        const processedMessages = [];
                        
                        parsed.forEach(item => {
                            if (typeof item === 'object' && item.type === 'emoji') {
                                // Êü•ÊâæÂåπÈÖçÁöÑË°®ÊÉÖÂåÖ
                                const matchingEmoji = customEmojis.find(emoji => 
                                    emoji.description === item.description
                                );
                                
                                if (matchingEmoji) {
                                    // Ê£ÄÊü•Ë°®ÊÉÖÂåÖÊòØÂê¶‰∏∫GIFÊ†ºÂºè
                                    if (matchingEmoji.url && matchingEmoji.url.includes('data:image/gif')) {
                                        console.warn('AIÂ∞ùËØï‰ΩøÁî®GIFÊ†ºÂºèË°®ÊÉÖÂåÖ:', item.description);
                                        processedMessages.push(`[${matchingEmoji.description}] (GIFÊ†ºÂºè‰∏çÊîØÊåÅAPIËØÜÂà´)`);
                                    } else {
                                    // ËøîÂõûË°®ÊÉÖÂåÖÂØπË±°ÔºåÂåÖÂê´ÂÆåÊï¥ÁöÑË°®ÊÉÖÂåÖ‰ø°ÊÅØ
                                        processedMessages.push({
                                        type: 'emoji',
                                        url: matchingEmoji.url,
                                        description: matchingEmoji.description,
                                        id: matchingEmoji.id
                                        });
                                    }
                                } else {
                                    // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÁöÑË°®ÊÉÖÂåÖÔºåËøîÂõûÈîôËØØÊ∂àÊÅØ
                                    console.warn('AIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂåÖ:', item.description);
                                    processedMessages.push(`[ÈîôËØØ: Ë°®ÊÉÖÂåÖ"${item.description}"‰∏çÂ≠òÂú®]`);
                                }
                            } else if (typeof item === 'object' && item.type === 'change_avatar') {
                                // Â§ÑÁêÜÂ§¥ÂÉèÊõ¥Êç¢ÂØπË±°
                                console.log('Ëß£ÊûêÂà∞Â§¥ÂÉèÊõ¥Êç¢Êåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÂêÑÁßçÈîôËØØÁöÑÂç†‰ΩçÁ¨¶
                                if (item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                    item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                    item.avatar_url === 'Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáURL' ||
                                    item.avatar_url === 'ÂõæÁâáURL') {
                                    // Ëé∑ÂèñÊúÄËøëÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáURL
                                    const recentUserImage = getRecentUserImage();
                                    if (recentUserImage) {
                                        item.avatar_url = recentUserImage;
                                        console.log('Â∞ÜÂç†‰ΩçÁ¨¶ÊõøÊç¢‰∏∫ÂÆûÈôÖÂõæÁâáURL(Á¨¨‰∫åÂ§Ñ):', recentUserImage);
                                    } else {
                                        console.warn('Ê≤°ÊúâÊâæÂà∞Áî®Êà∑ÊúÄËøëÂèëÈÄÅÁöÑÂõæÁâáÔºåÂøΩÁï•Â§¥ÂÉèÊõ¥Êç¢ËØ∑Ê±Ç(Á¨¨‰∫åÂ§Ñ)');
                                        processedMessages.push(`[Á≥ªÁªüÔºöÊó†Ê≥ïÊõ¥Êç¢Â§¥ÂÉèÔºåÊ≤°ÊúâÊâæÂà∞ÂèØÁî®ÁöÑÂõæÁâá]`);
                                        // ‰∏çË¶ÅreturnÔºåÁªßÁª≠Â§ÑÁêÜÂÖ∂‰ªñÊ∂àÊÅØ
                                    }
                                }
                                
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'ai_image') {
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅÂõæÁâá(Á¨¨‰∫åÂ§Ñ)
                                console.log('Ëß£ÊûêÂà∞AIÂõæÁâáÂèëÈÄÅÊåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'voice_message') {
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅËØ≠Èü≥(Á¨¨‰∫åÂ§Ñ)
                                console.log('Ëß£ÊûêÂà∞AIËØ≠Èü≥ÂèëÈÄÅÊåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'transfer') {
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIËΩ¨Ë¥¶(Á¨¨‰∫åÂ§Ñ)
                                console.log('Ëß£ÊûêÂà∞AIËΩ¨Ë¥¶Êåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'update_poke_suffix') {
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊà≥‰∏ÄÊà≥ÂêéÁºÄÊõ¥Êñ∞(Á¨¨‰∫åÂ§Ñ)
                                console.log('Ëß£ÊûêÂà∞Êà≥‰∏ÄÊà≥ÂêéÁºÄÊõ¥Êñ∞Êåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'recalled_message') {
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊí§ÂõûÊ∂àÊÅØ(Á¨¨‰∫åÂ§Ñ)
                                console.log('Ëß£ÊûêÂà∞Êí§ÂõûÊ∂àÊÅØÊåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'string') {
                                // üö® „ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•Âπ∂‰øÆÂ§çÂêàÂπ∂Ê∂àÊÅØÈóÆÈ¢ò
                                if (item.includes('\n')) {
                                    console.warn('Ê£ÄÊµãÂà∞AIÂ∞ÜÂ§öÊù°Ê∂àÊÅØÂêàÂπ∂Âú®‰∏Ä‰∏™ÂÖÉÁ¥†‰∏≠ÔºåÊ≠£Âú®Ëá™Âä®ÂàÜÊãÜ:', item);
                                    // Â∞ÜÊç¢Ë°åÁ¨¶ÂàÜÈöîÁöÑÂÜÖÂÆπÂàÜÊãÜÊàêÂ§öÊù°Ê∂àÊÅØ
                                    const splitMessages = item.split('\n')
                                        .map(msg => msg.trim())
                                        .filter(msg => msg.length > 0);
                                    processedMessages.push(...splitMessages);
                                } else {
                                    processedMessages.push(item);
                                }
                            } else {
                                processedMessages.push(item);
                            }
                        });
                        
                        return processedMessages;
                    }
                } 
            } catch (e) {} 
            
            // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•ÊòØÂê¶ÊòØÂéüÂßãÁöÑJSONÂ≠óÁ¨¶‰∏≤ÔºàAIÂõûÂ§çÊ≤°ÊúâË¢´Ê≠£Á°ÆÂåÖË£ÖÔºâ
            if (content.trim().startsWith('{') && content.trim().endsWith('}')) {
                try {
                    const singleObject = JSON.parse(content.trim());
                    if (singleObject.type) {
                        console.log('Ê£ÄÊµãÂà∞Âçï‰∏™JSONÂØπË±°ÔºåÂ∞ùËØïÂ§ÑÁêÜ:', singleObject);
                        // Â∞ÜÂçï‰∏™ÂØπË±°ÂåÖË£ÖÊàêÊï∞ÁªÑÂÜçÈÄíÂΩíÂ§ÑÁêÜ
                        return parseAiResponse(`[${content.trim()}]`);
                    }
                } catch (e) {
                    console.warn('Êó†Ê≥ïËß£ÊûêÂçï‰∏™JSONÂØπË±°:', e);
                }
            }
            
            const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```')); 
            if (lines.length > 0) return lines; 
            return [content]; 
        }
        
        // Â§ÑÁêÜÁ∫ø‰∏ãÊ®°ÂºèÂÜÖÂÆπÔºöËØÜÂà´„Äå„ÄçÂåÖË£πÁöÑÂØπËØùÂíåÊèèÂÜô
        function processOfflineContent(content) {
            if (!content) return '';
            
            // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂàÜÁ¶ªÂØπËØùÂíåÊèèÂÜô
            const parts = [];
            let lastIndex = 0;
            
            // ÂåπÈÖç„Äå„ÄçÂåÖË£πÁöÑÂØπËØù
            const dialogRegex = /„Äå([^„Äç]*)„Äç/g;
            let match;
            
            while ((match = dialogRegex.exec(content)) !== null) {
                // Ê∑ªÂä†ÂØπËØùÂâçÁöÑÊèèÂÜôÈÉ®ÂàÜ
                if (match.index > lastIndex) {
                    const description = content.slice(lastIndex, match.index).trim();
                    if (description) {
                        parts.push(`<span class="italic-gray">${description}</span>`);
                    }
                }
                
                // Ê∑ªÂä†ÂØπËØùÈÉ®ÂàÜÔºàÊ≠£Â∏∏ÊòæÁ§∫Ôºâ
                parts.push(`„Äå${match[1]}„Äç`);
                lastIndex = match.index + match[0].length;
            }
            
            // Ê∑ªÂä†ÊúÄÂêéÁöÑÊèèÂÜôÈÉ®ÂàÜ
            if (lastIndex < content.length) {
                const description = content.slice(lastIndex).trim();
                if (description) {
                    parts.push(`<span class="italic-gray">${description}</span>`);
                }
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂØπËØùÊ†áËÆ∞ÔºåÊï¥‰∏™ÂÜÖÂÆπ‰Ωú‰∏∫ÊèèÂÜôÂ§ÑÁêÜ
            if (parts.length === 0) {
                return `<span class="italic-gray">${content}</span>`;
            }
            
            return parts.join('');
        }
        


        // üî•„Äê‰øÆÂ§ç„ÄëÂèëÈÄÅÂõæÁâáÊ∂àÊÅØÔºå‰ΩøÁî®Ê≠£Á°ÆÁöÑÂ§öÊ®°ÊÄÅÊï∞ÊçÆÁªìÊûÑ
        async function sendImageMessage(imageUrl) {
            if (!currentChatCharacter) return;
            
            const chatInput = document.getElementById('api-chat-input');
            const textContent = chatInput ? chatInput.value.trim() : '';



            // ÂàõÂª∫‰∏Ä‰∏™Ê†áÂáÜÁöÑÂ§öÊ®°ÊÄÅÊ∂àÊÅØÂØπË±°
            const messageContent = [
                { type: 'text', text: textContent }
            ];

            if (imageUrl) {
                messageContent.push({
                    type: 'image_url',
                    image_url: { url: imageUrl }
                });
            }



            const message = {
                id: Date.now().toString(),
                sender: 'sent',
                content: messageContent, // ‰ΩøÁî®Êñ∞ÁöÑÊï∞ÁªÑÊ†ºÂºè
                timestamp: Date.now()
            };
            


            // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(message);
            await saveChatMessages();
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂπ∂Âà∑Êñ∞UI
            if (chatInput) {
                chatInput.value = '';
            }
            addMessageWithAnimation(message, currentChatCharacter.id);
            renderMessageList();
            
            // ËÆæÁΩÆ‰∏∫ÂæÖÂõûÂ§çÊ∂àÊÅØÔºåÂπ∂Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            pendingUserMessage = message;
            
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
        }
        
        // Ë∞ÉÁî®ËÅäÂ§©API
        // Á¨¨‰∏Ä‰∏™callChatAPIÂáΩÊï∞Â∑≤Âà†Èô§Ôºå‰ΩøÁî®‰∏ãÈù¢ÁöÑÂÆåÊï¥ÁâàÊú¨
        
        // ‰∏ä‰º†ÂõæÁâá
        function uploadImage() {
            document.getElementById('image-upload').click();
        }
        
        // ÊòæÁ§∫ÂõæÁâá
        function showImage(imageUrl) {
            // È¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶ÊòØÁõ∏ÂÜå‰∏≠ÁöÑÁÖßÁâá
            const photo = photos.find(p => p.image === imageUrl);
            if (photo) {
                document.getElementById('photo-image').style.backgroundImage = `url(${imageUrl})`;
                document.getElementById('photo-description-text').textContent = photo.description;
                document.getElementById('photo-time').textContent = `ÊãçÊëÑ‰∫é: ${formatFullDate(new Date(photo.timestamp))}`;
                document.getElementById('photo-location').textContent = `Âú∞ÁÇπ: ${photo.location}`;
                showApp('photo-detail-screen');
            } else {
                // Â¶ÇÊûú‰∏çÊòØÁõ∏ÂÜåÁÖßÁâáÔºåÊòæÁ§∫ÈÄöÁî®ÁöÑÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü
                let modal = document.getElementById('image-preview-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'image-preview-modal';
                    modal.className = 'image-preview-modal';
                    modal.onclick = () => modal.style.display = 'none';
                    modal.innerHTML = `<img src="" alt="È¢ÑËßàÂõæÁâá">`;
                    document.body.appendChild(modal);
                }
                modal.querySelector('img').src = imageUrl;
                modal.style.display = 'flex';
            }
        }
        
        // ÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆ
        function showChatSettings() {
            console.log('ÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆË¢´Ë∞ÉÁî®');
            
            // ÂÖàÈöêËóèÂΩìÂâçÁöÑËÅäÂ§©ÁïåÈù¢
            hideApp('api-chat-screen');
            
            // ÊòæÁ§∫ËÆæÁΩÆÁïåÈù¢
            const element = document.getElementById('api-chat-settings-screen');
            if (element) {
                element.style.display = 'flex';
                element.style.position = 'absolute';
                element.style.top = '0';
                element.style.left = '0';
                element.style.width = '100%';
                element.style.height = '100%';
                element.style.zIndex = '1000';
                element.style.background = 'white';
                
                // ÈáçÊñ∞ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢‰ª•Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
                initializeChatSettings();
                
                // Êõ¥Êñ∞ÂêÑÁßçËÆæÁΩÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
                updateWorldbookMountDisplay();
                
                // Ê£ÄÊµãÂΩìÂâçËÅäÂ§©Á±ªÂûãÂπ∂ÊòæÁ§∫Áõ∏Â∫îËÆæÁΩÆ
                const isGroupChat = currentChatCharacter && currentChatCharacter.isGroup;
                console.log('ÂΩìÂâçËÅäÂ§©Á±ªÂûã:', isGroupChat ? 'Áæ§ËÅä' : 'ÂçïËÅä');
                
                // Ê†πÊçÆËÅäÂ§©Á±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑËÆæÁΩÆÈÄâÈ°π
                const groupChatSettings = document.getElementById('group-chat-settings');
                const pokeSettingsSection = document.getElementById('poke-settings-section');
                
                if (isGroupChat) {
                    // Áæ§ËÅäÊ®°ÂºèÔºöÊòæÁ§∫Áæ§ËÅäËÆæÁΩÆÔºåÈöêËóèÊà≥‰∏ÄÊà≥ÂíåÂçïËÅä‰∏ìÁî®ÂäüËÉΩ
                    if (groupChatSettings) groupChatSettings.style.display = 'block';
                    if (pokeSettingsSection) pokeSettingsSection.style.display = 'none';
                    
                    // ÈöêËóèÂçïËÅä‰∏ìÁî®ËÆæÁΩÆÈ°π
                    const singleChatItems = document.querySelectorAll('.single-chat-only');
                    singleChatItems.forEach(item => item.style.display = 'none');
                    
                    // Êõ¥Êñ∞Áæ§ËÅä‰ø°ÊÅØÊòæÁ§∫
                    updateGroupChatInfo();
                } else {
                    // ÂçïËÅäÊ®°ÂºèÔºöÈöêËóèÁæ§ËÅäËÆæÁΩÆÔºåÊòæÁ§∫Êà≥‰∏ÄÊà≥ÂíåÂçïËÅä‰∏ìÁî®ÂäüËÉΩ
                    if (groupChatSettings) groupChatSettings.style.display = 'none';
                    if (pokeSettingsSection) pokeSettingsSection.style.display = 'block';
                    
                    // ÊòæÁ§∫ÂçïËÅä‰∏ìÁî®ËÆæÁΩÆÈ°π
                    const singleChatItems = document.querySelectorAll('.single-chat-only');
                    singleChatItems.forEach(item => item.style.display = 'flex');
                }
                
                console.log('ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢Â∑≤ÊòæÁ§∫');
            } else {
                console.error('Êâæ‰∏çÂà∞api-chat-settings-screenÂÖÉÁ¥†');
                alert('ËÆæÁΩÆÁïåÈù¢Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        // ÈöêËóèËÅäÂ§©ËÆæÁΩÆ
        function hideChatSettings() {
            hideApp('api-chat-settings-screen');
            // ËøîÂõûÂà∞ËÅäÂ§©ÁïåÈù¢
            if (currentChatCharacter) {
                showApp('api-chat-screen');
            }
        }
        
        // ‰øÆÊîπËßíËâ≤Â§¥ÂÉè
        function changeCharacterAvatar() {
            // ‰∏¥Êó∂ÂàõÂª∫‰∏Ä‰∏™Êñá‰ª∂ËæìÂÖ•Ê°ÜÔºåÈÅøÂÖçÂπ≤Êâ∞ÂéüÊúâÁöÑÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
            const tempInput = document.createElement('input');
            tempInput.type = 'file';
            tempInput.accept = 'image/*';
            tempInput.style.display = 'none';
            document.body.appendChild(tempInput);
            
            tempInput.onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                        if (characterIndex !== -1) {
                            characters[characterIndex].avatarUrl = event.target.result;
                            await saveCharacters();
                            renderCharacterList();
                            renderContactList();
                            renderMessageList();
                            renderChatMessages(currentChatCharacter.id);
                        }
                        // Ê∏ÖÁêÜ‰∏¥Êó∂ÂÖÉÁ¥†
                        document.body.removeChild(tempInput);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                } else {
                    // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÈÄâÊã©Ôºå‰πüË¶ÅÊ∏ÖÁêÜ‰∏¥Êó∂ÂÖÉÁ¥†
                    document.body.removeChild(tempInput);
                }
            };
            
            tempInput.click();
        }
        
        // ‰øÆÊîπÂ§áÊ≥®
        async function changeCharacterNickname() {
            const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂ§áÊ≥®ÂêçÁß∞:', currentChatCharacter.name);
            if (newName && newName.trim() !== '') {
                const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                if (characterIndex !== -1) {
                    characters[characterIndex].name = newName.trim();
                    await saveCharacters();
                    document.getElementById('api-chat-title').textContent = newName.trim();
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                }
            }
        }
        
        // Êü•ÊâæËÅäÂ§©ÂÜÖÂÆπ
        function searchChatContent() {
            const keyword = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊü•ÊâæÁöÑÂÖ≥ÈîÆËØç:');
            if (keyword && keyword.trim() !== '') {
                const messages = chatMessages[currentChatCharacter.id] || [];
                const foundMessages = messages.filter(msg => 
                    msg.content && msg.content.includes(keyword.trim())
                );
                
                if (foundMessages.length > 0) {
                    alert(`ÊâæÂà∞ ${foundMessages.length} Êù°ÂåÖÂê´"${keyword}"ÁöÑÊ∂àÊÅØ`);
                } else {
                    alert(`Ê≤°ÊúâÊâæÂà∞ÂåÖÂê´"${keyword}"ÁöÑÊ∂àÊÅØ`);
                }
            }
        }
        

        
        // ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï
        function exportChatHistory() {
            const messages = chatMessages[currentChatCharacter.id] || [];
            let history = `‰∏é ${currentChatCharacter.name} ÁöÑËÅäÂ§©ËÆ∞ÂΩï\n\n`;
            
            messages.forEach(msg => {
                const time = formatTime(msg.timestamp);
                const sender = msg.sender === 'sent' ? 'Êàë' : currentChatCharacter.name;
                history += `${time} ${sender}: ${msg.content}\n`;
            });
            
            // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÂØºÂá∫Êñá‰ª∂ÂäüËÉΩ
            console.log(history);
            alert('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÂØºÂá∫Âà∞ÊéßÂà∂Âè∞');
        }
        

        
        // ËÆæÁΩÆÂØπÊñπÊ∞îÊ≥°È¢úËâ≤
        function changeTheirBubbleColor() {
            colorPickerContext = 'theirBubble';
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆÂØπÊñπÊ∞îÊ≥°È¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ËÆæÁΩÆÊàëÊñπÊ∞îÊ≥°È¢úËâ≤
        function changeMyBubbleColor() {
            colorPickerContext = 'myBubble';
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆÊàëÊñπÊ∞îÊ≥°È¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ÊòæÁ§∫Ê∞îÊ≥°È¢úËâ≤ËÆæÁΩÆ
        function showBubbleColorSettings() {
            alert('Ê∞îÊ≥°È¢úËâ≤ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂΩìÂâçÂèØ‰ª•ÈÄöËøá‰ª•‰∏ãÊñπÂºèËÆæÁΩÆÔºö\n‚Ä¢ ‰øÆÊîπÂØπÊñπÊ∞îÊ≥°È¢úËâ≤\n‚Ä¢ ‰øÆÊîπÊàëÊñπÊ∞îÊ≥°È¢úËâ≤');
        }
        
        // Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
        function clearChatHistory() {
            if (!currentChatCharacter) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫‰∏é ${currentChatCharacter.name} ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                chatMessages[currentChatCharacter.id] = [];
                saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
                renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                alert('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
                hideChatSettings();
            }
        }
        
        // ÈÄâÊã©È¢úËâ≤
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }
        
        // Â∫îÁî®ËÅäÂ§©ËÉåÊôØ
        function applyChatBackground() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const chatScreen = document.getElementById('api-chat-screen');
            const messagesContainer = document.getElementById('api-chat-messages');

            if (chatScreen) {
                if (chatSettings.chatBackground && chatSettings.chatBackground !== null) {
                    // ÊúâËÉåÊôØÂõæÁâá
                    chatScreen.style.backgroundImage = `url(${chatSettings.chatBackground})`;
                    chatScreen.style.backgroundSize = 'cover';
                    chatScreen.style.backgroundPosition = 'center';
                    chatScreen.style.backgroundRepeat = 'no-repeat';
                    chatScreen.style.backgroundColor = 'transparent';
                    
                    // ËÆ©Ê∂àÊÅØÂÆπÂô®ËÉåÊôØÈÄèÊòé
                    if (messagesContainer) messagesContainer.style.background = 'transparent';
                } else {
                    // Ê≤°ÊúâËÉåÊôØÂõæÁâáÊàñÊòéÁ°ÆÁßªÈô§‰∫ÜËÉåÊôØ
                    chatScreen.style.backgroundImage = 'none';
                    chatScreen.style.backgroundColor = 'white';
                    
                    // ÊÅ¢Â§çÊ∂àÊÅØÂÆπÂô®ÈªòËÆ§ËÉåÊôØ
                    if (messagesContainer) messagesContainer.style.background = ''; 
                }
            }
        }
        
        // ‰øùÂ≠òÊ∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ
        function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÊ†∑ÂºèËÆæÁΩÆ
            chatSettings.bubbleStyle = window.selectedBubbleStyle || 'default';
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;
            chatSettings.bubbleOpacity = document.getElementById('bubble-opacity').value;
            
            // Êõ¥Êñ∞ÊòæÁ§∫ÊñáÊú¨
            const styleNames = {
                'default': 'ÈªòËÆ§Ê†∑Âºè',
                'glass': 'ÊØõÁéªÁíÉ',
                'shadow': 'ÁªèÂÖ∏Èò¥ÂΩ±',
                'tail': 'ÁªèÂÖ∏Ê∞îÊ≥°',
                'gradient': 'Ê∏êÂèòÊ†∑Âºè',
                'minimal': 'ÊûÅÁÆÄÊ†∑Âºè',
                'neon': 'ÈúìËôπÊ†∑Âºè',
                'paper': 'Á∫∏Âº†Ê†∑Âºè'
            };
            
            document.getElementById('current-bubble-style').textContent = styleNames[chatSettings.bubbleStyle] || 'ÈªòËÆ§Ê†∑Âºè';
            
            saveCurrentChatSettings(chatSettings);
            applyBubbleStyle();
            hideModal('bubble-style-modal');
            
            showToast('Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // Â∫îÁî®Ê∞îÊ≥°Ê†∑Âºè
        function applyBubbleStyle() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const messagesContainer = document.getElementById('api-chat-messages');
            
            if (messagesContainer) {
                // ÁßªÈô§ÊâÄÊúâÊ†∑ÂºèÁ±ª
                messagesContainer.className = messagesContainer.className
                    .split(' ')
                    .filter(cls => !cls.startsWith('bubble-style-'))
                    .join(' ');
                
                // Ê∑ªÂä†ÂΩìÂâçÊ†∑ÂºèÁ±ª
                const style = chatSettings.bubbleStyle || 'default';
                messagesContainer.classList.add(`bubble-style-${style}`);
                
                // ËÆæÁΩÆCSSÂèòÈáèÁî®‰∫éÂä®ÊÄÅÈ¢úËâ≤
                const myColor = chatSettings.myBubbleColor || '#007AFF';
                const aiColor = chatSettings.aiBubbleColor || '#f0f0f0';
                const opacity = chatSettings.bubbleOpacity || '1';
                
                messagesContainer.style.setProperty('--my-bubble-color', myColor);
                messagesContainer.style.setProperty('--ai-bubble-color', aiColor);
                messagesContainer.style.setProperty('--bubble-opacity', opacity);
            }
        }
        
        // ÊòæÁ§∫Ê∞îÊ≥°È¢úËâ≤ÈÄâÊã©Âô®
        function showBubbleColorPicker(context) {
            colorPickerContext = context;
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆÊ∞îÊ≥°È¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ÈÄâÊã©È¢úËâ≤
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }
        
        // Â∫îÁî®È¢úËâ≤ÈÄâÊã©
        async function applyColorSelection() {
            const selectedColor = document.querySelector('.color-option.selected')?.style.backgroundColor || '#007AFF';
            const opacity = document.getElementById('opacity-slider').value;
            
            if (colorPickerContext === 'theirBubble') {
                chatSettings.theirBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            } else if (colorPickerContext === 'myBubble') {
                chatSettings.myBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            }
            
            await saveChatSettings();
            renderChatMessages(currentChatCharacter.id);
            hideModal('color-picker-modal');
        }
        
        // ÊòæÁ§∫Â£ÅÁ∫∏ÈÄâÊã©Âô®
        function showWallpaperPicker() {
            showModal('wallpaper-picker-modal');
        }
        
        // ÈÄâÊã©Â£ÅÁ∫∏Ôºà‰øùÁïôÂáΩÊï∞‰ª•Èò≤ÂÖ∂‰ªñÂú∞ÊñπË∞ÉÁî®Ôºå‰ΩÜÁé∞Âú®‰∏ªË¶ÅÈÄöËøáÊñá‰ª∂‰∏ä‰º†ÈÄâÊã©Ôºâ
        function selectWallpaper(wallpaperId) {
            console.log('ÈÄâÊã©Â£ÅÁ∫∏:', wallpaperId);
            selectedWallpaper = wallpaperId;
            console.log('selectedWallpaperÂ∑≤ËÆæÁΩÆ‰∏∫:', selectedWallpaper);
        }
        
        // Â∫îÁî®Â£ÅÁ∫∏ÈÄâÊã©
        async function applyWallpaperSelection() {
            console.log('Â∫îÁî®Â£ÅÁ∫∏Ë¢´Ë∞ÉÁî®ÔºåselectedWallpaper:', selectedWallpaper);
            
            if (!selectedWallpaper) {
                alert('ËØ∑ÂÖà‰ªéÁõ∏ÂÜåÈÄâÊã©‰∏ÄÂº†ÂõæÁâá‰Ωú‰∏∫Â£ÅÁ∫∏');
                return;
            }
            
            if (selectedWallpaper.startsWith('data:image')) {
                // Â∫îÁî®‰∏ä‰º†ÁöÑÂõæÁâáÂ£ÅÁ∫∏
                console.log('Â∫îÁî®ÂõæÁâáÂ£ÅÁ∫∏');
                document.querySelector('.wallpaper').style.backgroundImage = `url(${selectedWallpaper})`;
                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                
                // ‰ΩøÁî®IndexedDB‰øùÂ≠òÂ£ÅÁ∫∏ÔºåÈÅøÂÖçlocalStorageÁ©∫Èó¥ÈôêÂà∂
                try {
                    await db.wallpapers.clear();
                    await db.wallpapers.add({
                        id: 'main',
                        type: 'image',
                        data: selectedWallpaper
                    });
                    console.log('Â£ÅÁ∫∏‰øùÂ≠òÊàêÂäüÂà∞IndexedDB');
            hideModal('wallpaper-picker-modal');
                } catch (e) {
                    console.error('‰øùÂ≠òÂ£ÅÁ∫∏Â§±Ë¥•:', e);
                    alert('‰øùÂ≠òÂ£ÅÁ∫∏Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            } else {
                alert('ËØ∑ÂÖà‰ªéÁõ∏ÂÜåÈÄâÊã©‰∏ÄÂº†ÂõæÁâá‰Ωú‰∏∫Â£ÅÁ∫∏');
            }
        }
        
        // ‰∏ä‰º†Ëá™ÂÆö‰πâÂ£ÅÁ∫∏
        function uploadCustomWallpaper() {
            document.getElementById('custom-wallpaper-upload').click();
        }
        
        // ÊòæÁ§∫ÂõæÊ†áÈÄâÊã©Âô®
        function showIconPicker() {
            showModal('icon-picker-modal');
        }
        
        // ÈÄâÊã©Â∫îÁî®ÂõæÊ†á
        function selectAppIcon(appId, iconClass) {
            selectedAppIcon = { appId, iconClass };
        }
        
        // ‰∏ä‰º†Ëá™ÂÆö‰πâÂõæÊ†á
        function uploadCustomIcon() {
            document.getElementById('custom-icon-upload').click();
        }
        
        // Â∫îÁî®ÂõæÊ†áÈÄâÊã©
        function applyIconSelection() {
            if (selectedAppIcon && customIconImage) {
                // Êõ¥Êñ∞Â∫îÁî®ÂõæÊ†á
                const appIcon = document.querySelector(`.app[onclick="showApp('${selectedAppIcon.appId}')"] .app-icon`);
                if (appIcon) {
                    appIcon.innerHTML = '';
                    appIcon.style.backgroundImage = `url(${customIconImage})`;
                    
                    // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                    let savedIcons = {};
                    try {
                        savedIcons = JSON.parse(localStorage.getItem('appIcons') || '{}');
                    } catch (error) {
                        console.error('Ëß£ÊûêÊú¨Âú∞Â≠òÂÇ®ÁöÑ appIcons Â§±Ë¥•:', error);
                        savedIcons = {};
                    }
                    savedIcons[selectedAppIcon.appId] = customIconImage;
                    localStorage.setItem('appIcons', JSON.stringify(savedIcons));
                }
            } else if (selectedAppIcon) {
                saveAppIcons();
            }
            hideModal('icon-picker-modal');
        }
        
        // Êõ¥ÊîπËÅäÂ§©‰∏ªÈ¢òÈ¢úËâ≤
        function changeChatThemeColor() {
            colorPickerContext = 'theme';
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆËÅäÂ§©‰∏ªÈ¢òÈ¢úËâ≤';
            showModal('color-picker-modal');
        }
        

        
        // ÊòæÁ§∫Ê∂àÊÅØËèúÂçï
        function showMessageMenu(messageId, event) {
            selectedMessageId = messageId;
            
            // ÂàõÂª∫ÊàñËé∑ÂèñËèúÂçïÂÖÉÁ¥†
            let menu = document.getElementById('message-context-menu');
            if (!menu) {
                menu = document.createElement('div');
                menu.id = 'message-context-menu';
                menu.className = 'message-menu';
                menu.innerHTML = `
                    <div class="message-menu-item" onclick="copyMessage()">Â§çÂà∂</div>
                    <div class="message-menu-item danger" onclick="deleteMessage()">Âà†Èô§</div>
                `;
                document.body.appendChild(menu);
            }
            
            // ÂÆö‰ΩçËèúÂçï
            const x = event.clientX || event.pageX;
            const y = event.clientY || event.pageY;
            
            menu.style.display = 'block';
            menu.style.left = `${Math.min(x, window.innerWidth - 150)}px`;
            menu.style.top = `${Math.min(y, window.innerHeight - 100)}px`;
            
            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
            setTimeout(() => {
                document.addEventListener('click', hideMessageMenu);
                document.addEventListener('touchstart', hideMessageMenu);
            }, 100);
        }
        
        // ÈöêËóèÊ∂àÊÅØËèúÂçï
        function hideMessageMenu() {
            const menu = document.getElementById('message-context-menu');
            if (menu) {
                menu.style.display = 'none';
            }
            document.removeEventListener('click', hideMessageMenu);
            document.removeEventListener('touchstart', hideMessageMenu);
        }
        
        // Â§çÂà∂Ê∂àÊÅØ
        function copyMessage() {
            if (!selectedMessageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === selectedMessageId);
            
            if (message && message.content) {
                navigator.clipboard.writeText(message.content).then(() => {
                    alert('Ê∂àÊÅØÂ∑≤Â§çÂà∂');
                }).catch(() => {
                    alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                });
            }
            
            hideMessageMenu();
        }
        
        // ÁºñËæëÊ∂àÊÅØ
        function editMessage() {
            if (!selectedMessageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const messageIndex = messages.findIndex(msg => msg.id === selectedMessageId);
            
            if (messageIndex !== -1 && messages[messageIndex].sender === 'sent') {
                const newContent = prompt('ÁºñËæëÊ∂àÊÅØ:', messages[messageIndex].content);
                if (newContent !== null) {
                    messages[messageIndex].content = newContent;
                    saveChatMessages();
                    renderChatMessages(currentChatCharacter.id);
                }
            } else {
                alert('Âè™ËÉΩÁºñËæëËá™Â∑±ÂèëÈÄÅÁöÑÊ∂àÊÅØ');
            }
            
            hideModal('message-menu-modal');
        }
        
        // È™åËØÅÂ§¥ÂÉèÊù•Ê∫êÊòØÂê¶ÊúâÊïà
        async function validateAvatarSource(avatarUrl) {
            console.log('È™åËØÅÂ§¥ÂÉèÊù•Ê∫ê:', avatarUrl);
            if (!avatarUrl) return false;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáÔºàÂú®ËÅäÂ§©ËÆ∞ÂΩï‰∏≠Ôºâ
            if (currentChatCharacter && chatMessages[currentChatCharacter.id]) {
                const userImages = chatMessages[currentChatCharacter.id]
                    .filter(msg => msg.sender === 'sent' && msg.image)
                    .map(msg => msg.image);
                
                console.log('Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáÂàóË°®:', userImages);
                console.log('Ê£ÄÊü•Â§¥ÂÉèURLÊòØÂê¶Âú®Áî®Êà∑ÂõæÁâá‰∏≠:', userImages.includes(avatarUrl));
                
                if (userImages.includes(avatarUrl)) {
                    console.log('Â§¥ÂÉèÊù•Ê∫êÈ™åËØÅÈÄöËøáÔºöÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâá');
                    return true;
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰∏ñÁïå‰π¶‰∏≠Êèê‰æõÁöÑÂ§¥ÂÉèURL
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.worldbookMountEnabled && chatSettings.selectedWorldbooks) {
                for (const worldbookId of chatSettings.selectedWorldbooks) {
                    const worldbook = worldbooks.find(w => w.id === worldbookId);
                    if (worldbook && worldbook.content && worldbook.content.includes(avatarUrl)) {
                        console.log('Â§¥ÂÉèÊù•Ê∫êÈ™åËØÅÈÄöËøáÔºö‰∏ñÁïå‰π¶‰∏≠ÁöÑURL');
                        return true;
                    }
                }
            }
            
            console.log('Â§¥ÂÉèÊù•Ê∫êÈ™åËØÅÂ§±Ë¥•');
            return false;
        }
        
        // ËßíËâ≤‰∏ªÂä®Êõ¥Êç¢Â§¥ÂÉèÂäüËÉΩ - Âè™‰øÆÊîπËÅäÂ§©ËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉèÔºå‰∏ç‰øÆÊîπËßíËâ≤Âç°
        async function changeCharacterAvatarByAI(newAvatarUrl, reason = '') {
            if (!currentChatCharacter || !newAvatarUrl) return false;
            
            try {
                // Ëé∑ÂèñÊàñÂàõÂª∫ÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆ
                const currentSettings = getCurrentChatSettings();
                
                // ÂéãÁº©Â§¥ÂÉèÂõæÁâá‰ª•ÂáèÂ∞ëÂ≠òÂÇ®Á©∫Èó¥
                let compressedAvatarUrl = newAvatarUrl;
                if (newAvatarUrl.startsWith('data:image')) {
                    try {
                        compressedAvatarUrl = await compressImage(newAvatarUrl, 200, 0.7);
                        console.log('Â§¥ÂÉèÂ∑≤ÂéãÁº©‰ª•ËäÇÁúÅÂ≠òÂÇ®Á©∫Èó¥');
                    } catch (error) {
                        console.warn('Â§¥ÂÉèÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂõæ:', error);
                    }
                }
                
                // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®Âä®ÊÄÅÂ§¥ÂÉèÂ≠óÊÆµÔºå‰ºòÂÖàÁ∫ßÈ´ò‰∫éÁî®Êà∑ËÆæÁΩÆÁöÑËÅäÂ§©Â§¥ÂÉè
                if (!chatSettings[currentChatCharacter.id]) {
                    chatSettings[currentChatCharacter.id] = {};
                }
                chatSettings[currentChatCharacter.id].aiDynamicAvatar = compressedAvatarUrl;
                
                console.log(`Âä®ÊÄÅÂ§¥ÂÉèÂ∑≤ËÆæÁΩÆÔºö`, {
                    characterId: currentChatCharacter.id,
                    characterName: currentChatCharacter.name,
                    avatarUrl: compressedAvatarUrl.substring(0, 50) + '...',
                    settingsSnapshot: {
                        aiDynamicAvatar: !!chatSettings[currentChatCharacter.id].aiDynamicAvatar,
                        aiChatAvatar: !!chatSettings[currentChatCharacter.id].aiChatAvatar
                    }
                });
                
                // ‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆ
                await saveChatSettings();
                
                // ÂèëÈÄÅÁ≥ªÁªüÊèêÁ§∫Ê∂àÊÅØ
                const systemMessage = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `${currentChatCharacter.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè${reason ? ': ' + reason : ''}`,
                    timestamp: Date.now(),
                    isAvatarChange: true
                };
                
                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }
                chatMessages[currentChatCharacter.id].push(systemMessage);
                await saveChatMessages();
                
                // üî•„Äê‰øÆÂ§ç„ÄëÂú®‰øùÂ≠òÊ∂àÊÅØÂêéÂÜçÂà∑Êñ∞ËÅäÂ§©ÁïåÈù¢ÔºåÁ°Æ‰øùÂåÖÂê´Êñ∞Â§¥ÂÉèÂíåÁ≥ªÁªüÊ∂àÊÅØ
                renderChatMessages(currentChatCharacter.id);
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÂº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÂ§¥ÂÉèÊòæÁ§∫
                forceRefreshAvatars();
                
                console.log(`ËßíËâ≤ ${currentChatCharacter.name} Âú®ÂΩìÂâçËÅäÂ§©‰∏≠Êõ¥Êç¢‰∫ÜÂ§¥ÂÉèÔºå‰ΩÜËßíËâ≤Âç°‰øùÊåÅ‰∏çÂèò`);
                
                return true;
            } catch (error) {
                console.error('ËßíËâ≤Êõ¥Êç¢Â§¥ÂÉèÂ§±Ë¥•:', error);
                return false;
            }
            
            return false;
        }
        
        // Âà†Èô§Ê∂àÊÅØ
        function deleteMessage() {
            if (!selectedMessageId) return;
            
                const messages = chatMessages[currentChatCharacter.id] || [];
                const messageIndex = messages.findIndex(msg => msg.id === selectedMessageId);
                
            if (messageIndex === -1) {
                hideMessageMenu();
                return;
            }
            
            const messageToDelete = messages[messageIndex];
            
            if (confirm('Á°ÆÂÆöË¶ÅÊí§ÂõûËøôÊù°Ê∂àÊÅØÂêóÔºü')) {
                // ‰øùÂ≠òÂéüÂßãÊ∂àÊÅØÂÜÖÂÆπ
                const originalContent = messageToDelete.content || '[ÂõæÁâá]';
                
                // Âà†Èô§ÂéüÊ∂àÊÅØ
                    messages.splice(messageIndex, 1);
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÂàõÂª∫Êí§ÂõûÊ∂àÊÅØÁ≥ªÁªüÊèêÈÜí
                const whoRecalled = messageToDelete.sender === 'received' ? currentChatCharacter.name : '‰Ω†';
                const recallSystemMessage = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `${whoRecalled} Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ\nÂéüÊñáÔºö${originalContent}`,
                    timestamp: messageToDelete.timestamp || Date.now(),
                    isRecall: true
                };
                
                // Âú®Âéü‰ΩçÁΩÆÊèíÂÖ•Êí§ÂõûÊèêÈÜí
                messages.splice(messageIndex, 0, recallSystemMessage);
                
                    saveChatMessages();
                    renderChatMessages(currentChatCharacter.id);
                    // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
                    renderMessageList();
            }
            
            hideMessageMenu();
        }
        

        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥Êà≥ÔºàÂÆåÊï¥Êó∂Èó¥Ôºâ
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;
            
            if (messageDate.getTime() === today.getTime()) {
                return timeStr; // ‰ªäÂ§©Âè™ÊòæÁ§∫Êó∂Èó¥
            } else if (messageDate.getTime() === yesterday.getTime()) {
                return `Êò®Â§© ${timeStr}`;
            } else {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}Êúà${day}Êó• ${timeStr}`;
            }
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥Ôºà‰ªÖÊó∂ÂàÜÔºâ
        function formatTimeOnly(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Ê†ºÂºèÂåñÂÆåÊï¥Êó•Êúü
        function formatFullDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}Âπ¥${month}Êúà${day}Êó• ${hours}:${minutes}`;
        }
        
        // Âä†ËΩΩURL
        function loadUrl() {
            const url = document.getElementById('browser-url').value;
            let fullUrl = url;
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                fullUrl = 'https://' + url;
            }
            
            document.getElementById('browser-frame').src = fullUrl;
        }
        
        // APIÁ±ªÂûãÂàáÊç¢Â§ÑÁêÜ
        function onApiTypeChange() {
            const apiType = document.getElementById('api-type').value;
            const baseInput = document.getElementById('api-base');
            const endpointGroup = document.getElementById('endpoint-group');
            const keyInput = document.getElementById('api-key');
            const modelInput = document.getElementById('api-model');
            const modelSelect = document.getElementById('api-model-select');
            const fetchModelsBtn = document.getElementById('fetch-models-btn');
            const modelHint = document.getElementById('model-hint');
            
            if (apiType === 'gemini') {
                baseInput.placeholder = 'https://generativelanguage.googleapis.com/v1beta';
                if (!baseInput.value || baseInput.value === 'https://api.openai.com/v1') {
                    baseInput.value = 'https://generativelanguage.googleapis.com/v1beta';
                }
                endpointGroup.style.display = 'none';
                keyInput.placeholder = 'AIzaSy...Ôºà‰ªéGoogle AI StudioËé∑ÂèñÔºâ';
                modelInput.style.display = 'none';
                modelSelect.style.display = 'block';
                fetchModelsBtn.style.display = 'block';
                modelHint.textContent = 'ÁÇπÂáª"Ëé∑ÂèñÊ®°Âûã"Ëá™Âä®ÊãâÂèñÂèØÁî®Ê®°ÂûãÂàóË°®';
            } else {
                if (apiType === 'openai') {
                    baseInput.placeholder = 'https://api.openai.com/v1';
                    if (!baseInput.value || baseInput.value === 'https://generativelanguage.googleapis.com/v1beta') {
                        baseInput.value = 'https://api.openai.com/v1';
                    }
                    keyInput.placeholder = 'sk-xxxxxxxxxxxxxxxx';
                    modelHint.textContent = '‰æãÂ¶Ç: gpt-4o, gpt-3.5-turbo';
                } else if (apiType === 'anthropic') {
                    baseInput.placeholder = 'https://api.anthropic.com';
                    if (!baseInput.value || baseInput.value.includes('googleapis.com')) {
                        baseInput.value = 'https://api.anthropic.com';
                    }
                    keyInput.placeholder = 'sk-ant-xxxxxxxxxxxxxxxx';
                    modelHint.textContent = '‰æãÂ¶Ç: claude-3-sonnet-20240229';
                } else if (apiType === 'azure') {
                    baseInput.placeholder = 'https://your-resource.openai.azure.com';
                    keyInput.placeholder = 'your-api-key';
                    modelHint.textContent = 'ËæìÂÖ•ÊÇ®ÁöÑÈÉ®ÁΩ≤ÂêçÁß∞';
                }
                endpointGroup.style.display = 'block';
                modelInput.style.display = 'block';
                modelSelect.style.display = 'none';
                fetchModelsBtn.style.display = 'none';
            }
        }
        
        // ÊµãËØïAPIËøûÊé•
        async function testApiConnection() {
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.textContent = 'ÊµãËØï‰∏≠...';
            testBtn.disabled = true;
            
            try {
                // Ëé∑ÂèñÂΩìÂâçËÆæÁΩÆ
                const tempSettings = {
                    type: document.getElementById('api-type').value,
                    base: document.getElementById('api-base').value.trim(),
                    endpoint: document.getElementById('api-endpoint').value.trim(),
                    key: document.getElementById('api-key').value.trim(),
                    model: document.getElementById('api-type').value === 'gemini' ? 
                           document.getElementById('api-model-select').value : 
                           document.getElementById('api-model').value.trim(),
                    temperature: parseFloat(document.getElementById('api-temperature').value) || 0.70
                };
                
                if (!tempSettings.key) {
                    throw new Error('ËØ∑ÂÖàËæìÂÖ•APIÂØÜÈí•');
                }
                
                if (!tempSettings.base) {
                    throw new Error('ËØ∑ËæìÂÖ•APIÂü∫Âú∞ÂùÄ');
                }
                
                if (!tempSettings.model) {
                    throw new Error('ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞');
                }
                
                let url, headers, requestBody;
                
                if (tempSettings.type === 'gemini') {
                    // ‰øÆÂ§çGemini API URL
                    const baseUrl = tempSettings.base.endsWith('/') ? tempSettings.base.slice(0, -1) : tempSettings.base;
                    url = `${baseUrl}/models/${tempSettings.model}:generateContent?key=${tempSettings.key}`;
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    requestBody = {
                        contents: [{
                            parts: [{
                                text: '‰Ω†Â•ΩÔºåËøôÊòØ‰∏Ä‰∏™ËøûÊé•ÊµãËØï„ÄÇËØ∑ÁÆÄÂçïÂõûÂ§ç"ËøûÊé•ÊàêÂäü"Âç≥ÂèØ„ÄÇ'
                            }]
                        }],
                        generationConfig: {
                            temperature: tempSettings.temperature
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_NONE"
                            }
                        ]
                    };
                } else {
                    // OpenAIÂÖºÂÆπÊ†ºÂºè
                    const baseUrl = tempSettings.base.endsWith('/') ? tempSettings.base.slice(0, -1) : tempSettings.base;
                    const endpoint = tempSettings.endpoint.startsWith('/') ? tempSettings.endpoint : '/' + tempSettings.endpoint;
                    url = baseUrl + endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tempSettings.key}`
                    };
                    requestBody = {
                        model: tempSettings.model,
                        messages: [
                            { role: 'user', content: '‰Ω†Â•ΩÔºåËøôÊòØ‰∏Ä‰∏™ËøûÊé•ÊµãËØï„ÄÇËØ∑ÁÆÄÂçïÂõûÂ§ç"ËøûÊé•ÊàêÂäü"Âç≥ÂèØ„ÄÇ' }
                        ],
                        temperature: tempSettings.temperature
                    };
                }
                
                console.log('ÊµãËØïAPIËøûÊé• - URL:', url);
                console.log('ÊµãËØïAPIËøûÊé• - Headers:', headers);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        console.log('ÈîôËØØÂìçÂ∫îËØ¶ÊÉÖ:', errorData);
                        errorMessage = errorData.error?.message || errorData.message || errorMessage;
                    } catch (e) {
                        const text = await response.text();
                        console.log('ÈîôËØØÂìçÂ∫îÊñáÊú¨:', text);
                        errorMessage += '\n\nËØ¶ÁªÜ‰ø°ÊÅØ: ' + text;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('APIÂìçÂ∫î:', data);
                
                let responseText;
                
                if (tempSettings.type === 'gemini') {
                    responseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                } else {
                    responseText = data.choices?.[0]?.message?.content;
                }
                
                if (responseText) {
                    alert('‚úÖ APIËøûÊé•ÊµãËØïÊàêÂäüÔºÅ\n\nÂõûÂ§çÂÜÖÂÆπÔºö' + responseText);
                } else {
                    alert('‚ö†Ô∏è APIËøûÊé•ÊàêÂäüÔºå‰ΩÜËøîÂõûÊ†ºÂºèÂèØËÉΩÊúâÈóÆÈ¢ò\n\nÂéüÂßãÂìçÂ∫îÔºö' + JSON.stringify(data, null, 2));
                }
                
            } catch (error) {
                console.error('APIÊµãËØïÂ§±Ë¥•:', error);
                let errorMsg = error.message;
                
                // ÈíàÂØπÂ∏∏ËßÅÈîôËØØÊèê‰æõËß£ÂÜ≥Âª∫ËÆÆ
                if (errorMsg.includes('CORS')) {
                    errorMsg += '\n\nüí° Âª∫ËÆÆÔºöËØ∑Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶Å‰ΩøÁî®Âèç‰ª£Âú∞ÂùÄÔºåÊàñËÄÖAPIÊúçÂä°ÊòØÂê¶ÊîØÊåÅË∑®ÂüüËØ∑Ê±Ç„ÄÇ';
                } else if (errorMsg.includes('401') || errorMsg.includes('API key')) {
                    errorMsg += '\n\nüí° Âª∫ËÆÆÔºöËØ∑Ê£ÄÊü•APIÂØÜÈí•ÊòØÂê¶Ê≠£Á°ÆÔºå‰ª•ÂèäÊòØÂê¶ÊúâÊùÉÈôêËÆøÈóÆËØ•Ê®°Âûã„ÄÇ';
                } else if (errorMsg.includes('404')) {
                    errorMsg += '\n\nüí° Âª∫ËÆÆÔºöËØ∑Ê£ÄÊü•APIÂü∫Âú∞ÂùÄÂíåÊ®°ÂûãÂêçÁß∞ÊòØÂê¶Ê≠£Á°Æ„ÄÇ';
                } else if (errorMsg.includes('403')) {
                    errorMsg += '\n\nüí° Âª∫ËÆÆÔºöAPIÂØÜÈí•ÊùÉÈôê‰∏çË∂≥ÊàñË¥¶Êà∑‰ΩôÈ¢ù‰∏çË∂≥„ÄÇ';
                }
                
                alert('‚ùå APIËøûÊé•ÊµãËØïÂ§±Ë¥•\n\nÈîôËØØ‰ø°ÊÅØÔºö' + errorMsg);
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }
        
        // Ëé∑ÂèñÊ®°ÂûãÂàóË°®
        async function fetchModels() {
            const fetchBtn = document.getElementById('fetch-models-btn');
            const originalText = fetchBtn.textContent;
            fetchBtn.textContent = 'Ëé∑Âèñ‰∏≠...';
            fetchBtn.disabled = true;
            
            try {
                const apiKey = document.getElementById('api-key').value.trim();
                const baseUrl = document.getElementById('api-base').value.trim();
                
                if (!apiKey) {
                    throw new Error('ËØ∑ÂÖàËæìÂÖ•APIÂØÜÈí•');
                }
                
                if (!baseUrl) {
                    throw new Error('ËØ∑ÂÖàËæìÂÖ•APIÂü∫Âú∞ÂùÄ');
                }
                
                // ÊûÑÂª∫Ëé∑ÂèñÊ®°ÂûãÂàóË°®ÁöÑURL
                const modelsUrl = `${baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl}/models?key=${apiKey}`;
                
                console.log('Ëé∑ÂèñÊ®°ÂûãÂàóË°® - URL:', modelsUrl);
                
                const response = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Ê®°ÂûãÂàóË°®ÂìçÂ∫î:', data);
                
                const modelSelect = document.getElementById('api-model-select');
                modelSelect.innerHTML = '<option value="">ÈÄâÊã©Ê®°Âûã...</option>';
                
                if (data.models && Array.isArray(data.models)) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name.startsWith('models/') ? model.name.substring(7) : model.name;
                        option.textContent = `${option.value} (${model.displayName || model.name})`;
                        modelSelect.appendChild(option);
                    });
                    
                    alert(`‚úÖ ÊàêÂäüËé∑ÂèñÂà∞ ${data.models.length} ‰∏™Ê®°Âûã`);
                } else {
                    throw new Error('APIËøîÂõûÁöÑÊ®°ÂûãÂàóË°®Ê†ºÂºè‰∏çÊ≠£Á°Æ');
                }
                
            } catch (error) {
                console.error('Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•:', error);
                alert('‚ùå Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•\n\nÈîôËØØ‰ø°ÊÅØÔºö' + error.message);
            } finally {
                fetchBtn.textContent = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        // ‰øùÂ≠òAPIËÆæÁΩÆ
        function saveApiSettings() {
            const baseUrl = document.getElementById('api-base').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-select').value.trim();
            const temperature = parseFloat(document.getElementById('temperature-slider').value) || 0.75;
            
            if (!baseUrl || !apiKey || !model) {
                showToast('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑAPIÈÖçÁΩÆ‰ø°ÊÅØ', 'error');
                return;
            }
            
            apiSettings = {
                base: baseUrl,
                key: apiKey,
                model: model,
                temperature: temperature
            };
            
            localStorage.setItem('apiSettings', JSON.stringify(apiSettings));
            showToast('APIËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ', 'success');
            
            // Êõ¥Êñ∞Ê∏©Â∫¶ÊòæÁ§∫
            document.getElementById('temperature-value').textContent = temperature.toFixed(2);
            
            // ‰øÆÂ§çÔºöËøîÂõûËÆæÁΩÆÂ∫îÁî®ËÄå‰∏çÊòØ‰∏ªÂ±èÂπï
            hideApp('api-settings-screen');
            showApp('settings-screen');
        }
        
        // üåü GeminiÁõ¥ËøûÂø´ÈÄüËÆæÁΩÆ
        function setGeminiDirect() {
            // Ëá™Âä®Â°´ÂÖÖGeminiÈÖçÁΩÆ
            document.getElementById('api-base').value = 'https://generativelanguage.googleapis.com/v1beta';
            document.getElementById('api-key').placeholder = 'ËØ∑ËæìÂÖ•Google AI StudioÁöÑAPI Key';
            
            // Ê∏ÖÁ©∫‰πãÂâçÁöÑÊ®°ÂûãÈÄâÊã©Âπ∂Ê∑ªÂä†GeminiÊ®°Âûã
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = `
                <option value="">ËØ∑ÈÄâÊã©Ê®°Âûã...</option>
                <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp (Êé®Ëçê)</option>
                <option value="gemini-1.5-pro">gemini-1.5-pro (Á®≥ÂÆö)</option>
                <option value="gemini-1.5-flash">gemini-1.5-flash (Âø´ÈÄü)</option>
                <option value="gemini-pro">gemini-pro</option>
            `;
            
            showToast('üåü GeminiÁõ¥ËøûÈÖçÁΩÆÂ∑≤Ëá™Âä®Â°´ÂÜôÔºÅËØ∑ËæìÂÖ•API KeyÂπ∂ÈÄâÊã©Ê®°Âûã', 'success');
        }
        
        // ü§ó HuggingFaceÂèç‰ª£Âø´ÈÄüËÆæÁΩÆ
        function setHuggingFaceProxy() {
            // Ëá™Âä®Â°´ÂÖÖHuggingFaceÂèç‰ª£ÈÖçÁΩÆ - ‰ΩøÁî®Ê≠£Á°ÆÁöÑÊ†ºÂºè
            document.getElementById('api-base').value = '@https://xxx-xxx.hf.space/v1';
            document.getElementById('api-key').placeholder = 'ËØ∑ËæìÂÖ•HuggingFaceÁöÑAPI Token';
            
            // Ê∏ÖÁ©∫‰πãÂâçÁöÑÊ®°ÂûãÈÄâÊã©Âπ∂Ê∑ªÂä†HFÊ®°Âûã
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = `
                <option value="">ËØ∑ÈÄâÊã©Ê®°Âûã...</option>
                <option value="meta-llama/Llama-2-7b-chat-hf">Llama-2-7b-chat</option>
                <option value="microsoft/DialoGPT-large">DialoGPT-large</option>
                <option value="facebook/blenderbot-400M-distill">BlenderBot</option>
                <option value="anthropic/claude-3-haiku-20240307">Claude-3-Haiku</option>
                <option value="microsoft/DialoGPT-medium">DialoGPT-medium</option>
            `;
            
            showToast('ü§ó HuggingFaceÂèç‰ª£ÈÖçÁΩÆÂ∑≤Ëá™Âä®Â°´ÂÜôÔºÅËØ∑Â∞ÜÂú∞ÂùÄ‰∏≠ÁöÑ xxx-xxx ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑHF SpaceÂú∞ÂùÄ', 'success');
        }
        
        // ‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ‰∏∫È¢ÑËÆæ
        function saveCurrentConfig() {
            const configName = document.getElementById('config-name-input').value.trim();
            
            if (!configName) {
                showToast('ËØ∑ËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞', 'error');
                return;
            }
            
            const currentConfig = {
                name: configName,
                base: document.getElementById('api-base').value.trim(),
                key: document.getElementById('api-key').value.trim(),
                model: document.getElementById('model-select').value.trim(),
                temperature: parseFloat(document.getElementById('temperature-slider').value) || 0.75,
                savedAt: new Date().toLocaleString()
            };
            
            // Ëé∑ÂèñÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ
            let savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÈÖçÁΩÆ
            const existingIndex = savedConfigs.findIndex(config => config.name === configName);
            if (existingIndex !== -1) {
                if (confirm(`ÈÖçÁΩÆ"${configName}"Â∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÜÁõñÔºü`)) {
                    savedConfigs[existingIndex] = currentConfig;
                } else {
                    return;
                }
            } else {
                savedConfigs.push(currentConfig);
            }
            
            localStorage.setItem('savedApiConfigs', JSON.stringify(savedConfigs));
            document.getElementById('config-name-input').value = '';
            
            renderSavedConfigs();
            showToast(`ÈÖçÁΩÆ"${configName}"Â∑≤‰øùÂ≠ò`, 'success');
        }
        
        // Ê∏≤ÊüìÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ
        function renderSavedConfigs() {
            const container = document.getElementById('saved-configs-container');
            const noConfigsMessage = document.getElementById('no-configs-message');
            const savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
            
            if (savedConfigs.length === 0) {
                container.style.display = 'none';
                noConfigsMessage.style.display = 'block';
                return;
            }
            
            container.style.display = 'grid';
            noConfigsMessage.style.display = 'none';
            
            container.innerHTML = savedConfigs.map(config => `
                <div class="config-card" style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 15px; border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s ease; cursor: pointer;" onclick="loadConfig('${config.name}')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #333; font-size: 15px;">${config.name}</div>
                        <button onclick="event.stopPropagation(); deleteConfig('${config.name}')" style="background: none; border: none; color: #ff6b6b; cursor: pointer; padding: 2px 6px; border-radius: 4px; font-size: 12px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,107,107,0.1)'" onmouseout="this.style.background='none'">üóëÔ∏è</button>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                        <div>üåê ${config.base}</div>
                        <div>ü§ñ ${config.model}</div>
                        <div>üå°Ô∏è Ê∏©Â∫¶: ${config.temperature}</div>
                    </div>
                    <div style="font-size: 11px; color: #999;">‰øùÂ≠ò‰∫é: ${config.savedAt}</div>
                </div>
            `).join('');
        }
        
        // Âä†ËΩΩÈÖçÁΩÆ
        function loadConfig(configName) {
            const savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
            const config = savedConfigs.find(c => c.name === configName);
            
            if (!config) {
                showToast('ÈÖçÁΩÆ‰∏çÂ≠òÂú®', 'error');
                return;
            }
            
            // Â°´ÂÖÖË°®Âçï
            document.getElementById('api-base').value = config.base;
            document.getElementById('api-key').value = config.key;
            document.getElementById('temperature-slider').value = config.temperature;
            document.getElementById('temperature-value').textContent = config.temperature.toFixed(2);
            
            // Â§ÑÁêÜÊ®°ÂûãÈÄâÊã©
            const modelSelect = document.getElementById('model-select');
            const existingOption = Array.from(modelSelect.options).find(option => option.value === config.model);
            if (!existingOption) {
                // Â¶ÇÊûúÊ®°Âûã‰∏çÂú®ÂΩìÂâçÈÄâÈ°π‰∏≠ÔºåÊ∑ªÂä†ÂÆÉ
                const newOption = new Option(config.model, config.model);
                modelSelect.appendChild(newOption);
            }
            modelSelect.value = config.model;
            
            showToast(`Â∑≤Âä†ËΩΩÈÖçÁΩÆ"${configName}"`, 'success');
        }
        
        // Âà†Èô§ÈÖçÁΩÆ
        function deleteConfig(configName) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÖçÁΩÆ"${configName}"ÂêóÔºü`)) {
                let savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
                savedConfigs = savedConfigs.filter(config => config.name !== configName);
                localStorage.setItem('savedApiConfigs', JSON.stringify(savedConfigs));
                renderSavedConfigs();
                showToast(`ÈÖçÁΩÆ"${configName}"Â∑≤Âà†Èô§`, 'success');
            }
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÈÖçÁΩÆ
        function clearAllConfigs() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                localStorage.removeItem('savedApiConfigs');
                renderSavedConfigs();
                showToast('ÊâÄÊúâÈÖçÁΩÆÂ∑≤Ê∏ÖÁ©∫', 'success');
            }
        }
        
        // ÊµãËØïAPIËøûÊé•
        async function testApiConnection() {
            const baseUrl = document.getElementById('api-base').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-select').value.trim();
            
            if (!baseUrl || !apiKey || !model) {
                showToast('ËØ∑ÂÖàÂ°´ÂÜôÂÆåÊï¥ÁöÑAPIÈÖçÁΩÆ', 'error');
                return;
            }
            
            const testBtn = document.getElementById('test-api-connection-btn');
            const originalText = testBtn.textContent;
            testBtn.textContent = 'ÊµãËØï‰∏≠...';
            testBtn.disabled = true;
            
            try {
                // Ê†πÊçÆ‰∏çÂêåÁöÑAPIÁ±ªÂûãÊûÑÂª∫ÊµãËØïËØ∑Ê±Ç
                let testUrl, testPayload, testHeaders;
                
                if (baseUrl.includes('generativelanguage.googleapis.com')) {
                    // Gemini APIÊµãËØï
                    testUrl = `${baseUrl}/models/${model}:generateContent?key=${apiKey}`;
                    testPayload = {
                        contents: [{
                            parts: [{ text: "Hello" }]
                        }]
                    };
                    testHeaders = {
                        'Content-Type': 'application/json'
                    };
                } else {
                    // OpenAIÂÖºÂÆπAPIÊµãËØï
                    testUrl = `${baseUrl}/v1/chat/completions`;
                    testPayload = {
                        model: model,
                        messages: [{ role: "user", content: "Hello" }],
                        max_tokens: 10
                    };
                    testHeaders = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                }
                
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: testHeaders,
                    body: JSON.stringify(testPayload)
                });
                
                if (response.ok) {
                    showToast('‚úÖ APIËøûÊé•ÊµãËØïÊàêÂäüÔºÅ', 'success');
                } else {
                    const errorText = await response.text();
                    showToast(`‚ùå APIËøûÊé•Â§±Ë¥•: ${response.status} ${response.statusText}`, 'error');
                    console.error('APIÊµãËØïÂ§±Ë¥•:', errorText);
                }
            } catch (error) {
                showToast(`‚ùå ËøûÊé•ÈîôËØØ: ${error.message}`, 'error');
                console.error('APIÊµãËØïÈîôËØØ:', error);
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }
        
        // Ëé∑ÂèñÊ®°ÂûãÂàóË°®
        async function fetchModels() {
            const baseUrl = document.getElementById('api-base').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            
            if (!baseUrl || !apiKey) {
                showToast('ËØ∑ÂÖàÂ°´ÂÜôAPIÂú∞ÂùÄÂíåÂØÜÈí•', 'error');
                return;
            }
            
            const fetchBtn = document.getElementById('fetch-models-btn');
            const originalText = fetchBtn.textContent;
            fetchBtn.textContent = 'Ëé∑Âèñ‰∏≠...';
            fetchBtn.disabled = true;
            
            try {
                let modelsUrl, headers;
                
                if (baseUrl.includes('generativelanguage.googleapis.com')) {
                    // Gemini API
                    modelsUrl = `${baseUrl}/models?key=${apiKey}`;
                    headers = {};
                } else {
                    // OpenAIÂÖºÂÆπAPI
                    modelsUrl = `${baseUrl}/v1/models`;
                    headers = {
                        'Authorization': `Bearer ${apiKey}`
                    };
                }
                
                const response = await fetch(modelsUrl, { headers });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const modelSelect = document.getElementById('model-select');
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                modelSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ê®°Âûã...</option>';
                
                let models = [];
                if (data.models) {
                    // Gemini APIÊ†ºÂºè
                    models = data.models
                        .filter(model => model.name.includes('generate'))
                        .map(model => model.name.split('/').pop());
                } else if (data.data) {
                    // OpenAI APIÊ†ºÂºè
                    models = data.data.map(model => model.id);
                }
                
                models.forEach(modelId => {
                    const option = new Option(modelId, modelId);
                    modelSelect.appendChild(option);
                });
                
                showToast(`‚úÖ ÊàêÂäüËé∑ÂèñÂà∞ ${models.length} ‰∏™Ê®°Âûã`, 'success');
            } catch (error) {
                showToast(`‚ùå Ëé∑ÂèñÊ®°ÂûãÂ§±Ë¥•: ${error.message}`, 'error');
                console.error('Ëé∑ÂèñÊ®°ÂûãÂ§±Ë¥•:', error);
            } finally {
                fetchBtn.textContent = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        // ÂØºÂá∫ÂÆåÊï¥Â§á‰ªΩ
        function exportFullBackup() {
            // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÂÆåÊï¥ÁöÑÊï∞ÊçÆÂØºÂá∫ÂäüËÉΩ
            showToast('ÂØºÂá∫ÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }
        
        // ÂØºÂÖ•ÂÆåÊï¥Â§á‰ªΩ
        function importFullBackup() {
            // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÂÆåÊï¥ÁöÑÊï∞ÊçÆÂØºÂÖ•ÂäüËÉΩ
            document.getElementById('import-full-backup-input').click();
        }
        
        // ÂàùÂßãÂåñAPIËÆæÁΩÆÁïåÈù¢
        function initializeApiSettings() {
            // Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑAPIÈÖçÁΩÆ
            loadApiSettings();
            
            // Ê∏≤ÊüìÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ
            renderSavedConfigs();
        }
        
        // Âä†ËΩΩAPIËÆæÁΩÆ
        function loadApiSettings() {
            const savedSettings = localStorage.getItem('apiSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    
                    // Â°´ÂÖÖË°®ÂçïÂ≠óÊÆµ
                    if (settings.base) {
                        const baseInput = document.getElementById('api-base');
                        if (baseInput) baseInput.value = settings.base;
                    }
                    
                    if (settings.key) {
                        const keyInput = document.getElementById('api-key');
                        if (keyInput) keyInput.value = settings.key;
                    }
                    
                    if (settings.model) {
                        const modelSelect = document.getElementById('model-select');
                        if (modelSelect) {
                            // Â¶ÇÊûúÊ®°Âûã‰∏çÂú®ÈÄâÈ°π‰∏≠ÔºåÊ∑ªÂä†ÂÆÉ
                            const existingOption = Array.from(modelSelect.options).find(option => option.value === settings.model);
                            if (!existingOption) {
                                const newOption = new Option(settings.model, settings.model);
                                modelSelect.appendChild(newOption);
                            }
                            modelSelect.value = settings.model;
                        }
                    }
                    
                    if (settings.temperature !== undefined) {
                        const tempSlider = document.getElementById('temperature-slider');
                        const tempValue = document.getElementById('temperature-value');
                        if (tempSlider && tempValue) {
                            tempSlider.value = settings.temperature;
                            tempValue.textContent = settings.temperature.toFixed(2);
                        }
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩAPIËÆæÁΩÆÂ§±Ë¥•:', error);
                }
            }
        }
        
        // ÁîµÊ±†ÁÆ°ÁêÜÂäüËÉΩ
        async function initBatteryManager() {
            console.log('ÂºÄÂßãÂàùÂßãÂåñÁîµÊ±†ÁÆ°ÁêÜÂô®...');
            
            // È¶ñÂÖàËÆæÁΩÆÈªòËÆ§ÊòæÁ§∫‰∏∫ ·∞î·©ö
            const allBatteryTexts = document.querySelectorAll('.battery-text');
            console.log('ÊâæÂà∞ÁöÑÁîµÊ±†ÊñáÊú¨ÂÖÉÁ¥†Êï∞Èáè:', allBatteryTexts.length);
            
            allBatteryTexts.forEach((element, index) => {
                console.log(`ËÆæÁΩÆÁîµÊ±†ÊñáÊú¨ ${index}:`, element);
                element.textContent = '·∞î·©ö';
            });
            
            if ('getBattery' in navigator) {
                try {
                    console.log('ÊµèËßàÂô®ÊîØÊåÅÁîµÊ±†APIÔºåÊ≠£Âú®Ëé∑ÂèñÁîµÊ±†‰ø°ÊÅØ...');
                    const battery = await navigator.getBattery();
                    console.log('ÁîµÊ±†‰ø°ÊÅØ:', {
                        level: battery.level,
                        charging: battery.charging
                    });
                    updateBatteryDisplay(battery);
                    
                    battery.addEventListener('levelchange', () => updateBatteryDisplay(battery));
                    battery.addEventListener('chargingchange', () => updateBatteryDisplay(battery));
                } catch (err) {
                    console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err);
                    // ‰øùÊåÅÈªòËÆ§ÊòæÁ§∫ ·∞î·©ö
                    allBatteryTexts.forEach(element => {
                        element.textContent = '·∞î·©ö';
                    });
                }
            } else {
                console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPIÔºå‰ΩøÁî®ÈªòËÆ§ÊòæÁ§∫„ÄÇ");
                // ‰øùÊåÅÈªòËÆ§ÊòæÁ§∫ ·∞î·©ö
                allBatteryTexts.forEach(element => {
                    element.textContent = '·∞î·©ö';
                });
            }
        }
        
        function updateBatteryDisplay(battery) {
            const level = Math.floor(battery.level * 100);
            const isCharging = battery.charging;
            
            console.log(`Êõ¥Êñ∞ÁîµÊ±†ÊòæÁ§∫: ${level}%, ÂÖÖÁîµ‰∏≠: ${isCharging}`);
            
            // Êõ¥Êñ∞‰∏ªÁä∂ÊÄÅÊ†èÁîµÊ±†
            const batteryContainer = document.getElementById('status-bar-battery');
            console.log('‰∏ªÁä∂ÊÄÅÊ†èÁîµÊ±†ÂÆπÂô®:', batteryContainer);
            
            if (batteryContainer) {
                const batteryLevelEl = batteryContainer.querySelector('.battery-level');
                const batteryTextEl = batteryContainer.querySelector('.battery-text');
                
                console.log('ÁîµÊ±†ÂÖÉÁ¥†:', { batteryLevelEl, batteryTextEl });
                
                if (batteryLevelEl && batteryTextEl) {
                    batteryLevelEl.style.width = `${level}%`;
                    batteryTextEl.textContent = `${level}%`;
                    console.log(`ËÆæÁΩÆ‰∏ªÂ±èÂπïÁîµÊ±†ÊñáÊú¨‰∏∫: ${level}%`);
                    
                    if (isCharging) {
                        batteryContainer.classList.add('charging');
                    } else {
                        batteryContainer.classList.remove('charging');
                    }
                }
            }
            
            // Êõ¥Êñ∞Â∫îÁî®ÂÜÖÁä∂ÊÄÅÊ†èÁîµÊ±†
            const appBatteryContainers = document.querySelectorAll('.app-battery-container');
            const appBatteryTexts = document.querySelectorAll('.app-battery-container .battery-text');
            const appBatteryLevels = document.querySelectorAll('.app-battery-level');
            
            // Â∫îÁî®ÂÜÖ‰πüÊòæÁ§∫ÁúüÂÆûÁîµÈáè
            appBatteryTexts.forEach(element => {
                element.textContent = `${level}%`;
            });
            
            appBatteryLevels.forEach(element => {
                element.style.width = `${level}%`;
            });
            
            // ÂêåÊ≠•Â∫îÁî®ÂÜÖÁîµÊ±†ÂÖÖÁîµÁä∂ÊÄÅ
            appBatteryContainers.forEach(container => {
                if (isCharging) {
                    container.classList.add('charging');
                } else {
                    container.classList.remove('charging');
                }
            });
        }
        
        // ÊâãÂä®ÊµãËØïÁîµÊ±†ÊòæÁ§∫ÂäüËÉΩ - ÊÇ®ÂèØ‰ª•Âú®ÊµèËßàÂô®ÊéßÂà∂Âè∞‰∏≠Ë∞ÉÁî®Ëøô‰∏™ÂáΩÊï∞
        function testBatteryDisplay() {
            console.log('=== ÁîµÊ±†ÊòæÁ§∫ÊµãËØïÂºÄÂßã ===');
            
            // Ê£ÄÊü•ÁîµÊ±†ÊñáÊú¨ÂÖÉÁ¥†
            const allBatteryTexts = document.querySelectorAll('.battery-text');
            console.log('ÊâÄÊúâÁîµÊ±†ÊñáÊú¨ÂÖÉÁ¥†:', allBatteryTexts);
            
            allBatteryTexts.forEach((element, index) => {
                console.log(`ÁîµÊ±†ÊñáÊú¨ ${index}:`, element, 'ÂΩìÂâçÂÜÖÂÆπ:', element.textContent);
            });
            
            // Ê£ÄÊü•‰∏ªÂ±èÂπïÁîµÊ±†ÂÆπÂô®
            const mainBattery = document.getElementById('status-bar-battery');
            console.log('‰∏ªÂ±èÂπïÁîµÊ±†ÂÆπÂô®:', mainBattery);
            
            if (mainBattery) {
                const batteryText = mainBattery.querySelector('.battery-text');
                console.log('‰∏ªÂ±èÂπïÁîµÊ±†ÊñáÊú¨ÂÖÉÁ¥†:', batteryText);
                console.log('‰∏ªÂ±èÂπïÁîµÊ±†ÊñáÊú¨ÂÜÖÂÆπ:', batteryText ? batteryText.textContent : 'null');
            }
            
            // ÊµãËØïËÆæÁΩÆ‰∏∫ÁôæÂàÜÊØî
            console.log('ÊµãËØïËÆæÁΩÆ‰∏∫77%...');
            allBatteryTexts.forEach((element, index) => {
                element.textContent = '77%';
                console.log(`ÁîµÊ±†ÊñáÊú¨ ${index} ËÆæÁΩÆ‰∏∫ 77%`);
            });
            
            // 3ÁßíÂêéÊÅ¢Â§ç‰∏∫Áà±ÂøÉ
            setTimeout(() => {
                console.log('ÊÅ¢Â§ç‰∏∫Áà±ÂøÉÁ¨¶Âè∑...');
                allBatteryTexts.forEach((element, index) => {
                    element.textContent = '·∞î·©ö';
                    console.log(`ÁîµÊ±†ÊñáÊú¨ ${index} ÊÅ¢Â§ç‰∏∫ ·∞î·©ö`);
                });
            }, 3000);
            
            console.log('=== ÁîµÊ±†ÊòæÁ§∫ÊµãËØïÁªìÊùü ===');
        }
        
        // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
        function changeTheme(themeName) {
            const body = document.body;
            
            // ÁßªÈô§‰πãÂâçÁöÑ‰∏ªÈ¢ò
            body.removeAttribute('data-theme');
            
            // Â∫îÁî®Êñ∞‰∏ªÈ¢ò
            if (themeName !== 'default') {
                body.setAttribute('data-theme', themeName);
            }
            
            // ‰øùÂ≠ò‰∏ªÈ¢òËÆæÁΩÆ
            localStorage.setItem('selectedTheme', themeName);
            
            // ÁªôÁî®Êà∑ÂèçÈ¶à
            const themeNames = {
                'default': 'ÁÆÄÁ∫¶È£éÊ†º',
                'cute': 'ÂèØÁà±È£éÊ†º',
                'nature': 'Ëá™ÁÑ∂È£éÊ†º', 
                'tech': 'ÁßëÊäÄÈ£éÊ†º',
                'dream': 'Ê¢¶ÂπªÈ£éÊ†º'
            };
            
            // ÊòæÁ§∫ToastÊèêÁ§∫
            showToast(`Â∑≤ÂàáÊç¢Âà∞ ${themeNames[themeName]} ‰∏ªÈ¢òÔºÅ`, 'success');
        }
        
        // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme && savedTheme !== 'default') {
                document.body.setAttribute('data-theme', savedTheme);
            }
        }
        
        // ‰∏ñÁïå‰π¶Áõ∏ÂÖ≥ÂäüËÉΩ
        let worldbooks = [];
        let editingWorldbook = null;
        
        // Âä†ËΩΩ‰∏ñÁïå‰π¶Êï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadWorldbooks() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedWorldbooks = await db.worldbooks.toArray();
                
                if (savedWorldbooks.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('worldbooks');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑ‰∏ñÁïå‰π¶Êï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localWorldbooks = JSON.parse(localStorageData);
                        
                        if (localWorldbooks.length > 0) {
                            // Á°Æ‰øùÊØè‰∏™‰∏ñÁïå‰π¶ÈÉΩÊúâidÂ≠óÊÆµ
                            const migrationData = localWorldbooks.map(wb => ({
                                id: wb.id || Date.now().toString() + Math.random(),
                                title: wb.title,
                                content: wb.content,
                                createdAt: wb.createdAt || new Date().toISOString(),
                                updatedAt: wb.updatedAt || new Date().toISOString()
                            }));
                            
                            // ËøÅÁßªÂà∞IndexedDB
                            await db.worldbooks.bulkAdd(migrationData);
                            worldbooks = migrationData;
                            console.log('‰∏ñÁïå‰π¶Êï∞ÊçÆËøÅÁßªÂÆåÊàê:', worldbooks);
                        } else {
                            worldbooks = [];
                        }
                    } else {
                        worldbooks = [];
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    worldbooks = savedWorldbooks;
                    console.log('‰ªéIndexedDBÂä†ËΩΩ‰∏ñÁïå‰π¶Êï∞ÊçÆ:', worldbooks);
                }
            } catch (error) {
                console.error('Âä†ËΩΩ‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('worldbooks');
                if (localStorageData) {
                    try {
                        worldbooks = JSON.parse(localStorageData);
                } catch (e) {
                        worldbooks = [];
                    }
                } else {
                    worldbooks = [];
                }
            }
            renderWorldbookList();
        }
        
        // ‰øùÂ≠ò‰∏ñÁïå‰π¶Êï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function saveWorldbooks() {
            try {
                console.log('‰øùÂ≠ò‰∏ñÁïå‰π¶Êï∞ÊçÆÂà∞IndexedDB:', worldbooks);
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
                await db.worldbooks.clear();
                
                // ÊâπÈáèÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                if (worldbooks.length > 0) {
                    await db.worldbooks.bulkAdd(worldbooks);
                }
                
                console.log('‰∏ñÁïå‰π¶Êï∞ÊçÆ‰øùÂ≠òÊàêÂäü');
            } catch (error) {
                console.error('‰øùÂ≠ò‰∏ñÁïå‰π¶Êó∂ÂèëÁîüÈîôËØØ:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
            localStorage.setItem('worldbooks', JSON.stringify(worldbooks));
            }
        }
        
        function showWorldbookForm(isGlobal) {
    // Ê†πÊçÆ‰º†ÂÖ•ÁöÑÁ±ªÂûãÔºàÂÖ®Â±Ä/Â±ÄÈÉ®ÔºâÊù•ÂÜ≥ÂÆöË°®ÂçïÊ†áÈ¢ò
    const title = isGlobal ? 'Êñ∞Âª∫ÂÖ®Â±ÄËÆæÂÆö' : 'Êñ∞Âª∫Â±ÄÈÉ®ËÆæÂÆö';
    document.getElementById('worldbook-form-title').textContent = title;

    editingWorldbook = null; // Ê∏ÖÈô§ÁºñËæëÁä∂ÊÄÅ
            document.getElementById('worldbook-title').value = '';
            document.getElementById('worldbook-content').value = '';

    // Â∞ÜÂàõÂª∫Á±ªÂûãÊöÇÂ≠òËµ∑Êù•Ôºå‰ª•‰æø‰øùÂ≠òÊó∂‰ΩøÁî®
    window.newWorldbookIsGlobal = isGlobal;

            showApp('worldbook-form-screen');
        }
        
        function hideWorldbookForm() {
            hideApp('worldbook-form-screen');
            // Á°Æ‰øùËøîÂõûÂà∞‰∏ñÁïå‰π¶Â∫îÁî®ÔºåËÄå‰∏çÊòØ‰∏ªÂ±èÂπï
            showApp('worldbook-screen');
        }
        
        async function saveWorldbook() {
            const title = document.getElementById('worldbook-title').value.trim();
            const content = document.getElementById('worldbook-content').value.trim();
            
    if (!title || !content) {
        alert('ËØ∑ËæìÂÖ•Ê†áÈ¢òÂíåÂÜÖÂÆπ');
                return;
            }
            
    let isGlobal;
    if (editingWorldbook) {
        // Â¶ÇÊûúÊòØÁºñËæëÊ®°ÂºèÔºå‰øùÊåÅÂÖ∂ÂéüÊúâÁöÑÁ±ªÂûã‰∏çÂèò
        isGlobal = editingWorldbook.isGlobal;
    } else {
        // Â¶ÇÊûúÊòØÊñ∞Âª∫Ê®°ÂºèÔºåËØªÂèñÊàë‰ª¨ÊöÇÂ≠òÁöÑÁ±ªÂûã
        isGlobal = window.newWorldbookIsGlobal;
            }
            
            const worldbook = {
                id: editingWorldbook ? editingWorldbook.id : Date.now().toString(),
                title: title,
                content: content,
        isGlobal: isGlobal, // Ê†πÊçÆÊ≠£Á°ÆÁöÑÁä∂ÊÄÅËÆæÁΩÆ
                createdAt: editingWorldbook ? editingWorldbook.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingWorldbook) {
                const index = worldbooks.findIndex(w => w.id === editingWorldbook.id);
        if (index !== -1) worldbooks[index] = worldbook;
            } else {
                worldbooks.push(worldbook);
            }
            
            await saveWorldbooks();
            renderWorldbookList();
            showToast(editingWorldbook ? '‰∏ñÁïå‰π¶Â∑≤Êõ¥Êñ∞ÔºÅ' : '‰∏ñÁïå‰π¶Â∑≤ÂàõÂª∫ÔºÅ', 'success');
            hideWorldbookForm();
        }
// --- Êñ∞Â¢ûÂáΩÊï∞ ---
async function toggleGlobalWorldbook(bookId, isEnabled) {
    if (isEnabled) {
        // Â¶ÇÊûúÂºÄÂêØÔºåÊ∑ªÂä†Âà∞ÊøÄÊ¥ªÂàóË°®ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
        if (!activeGlobalWorldbooks.includes(bookId)) {
            activeGlobalWorldbooks.push(bookId);
        }
    } else {
        // Â¶ÇÊûúÂÖ≥Èó≠Ôºå‰ªéÊøÄÊ¥ªÂàóË°®‰∏≠ÁßªÈô§
        activeGlobalWorldbooks = activeGlobalWorldbooks.filter(id => id !== bookId);
    }
    
    // ‰øùÂ≠òÊøÄÊ¥ªÁä∂ÊÄÅÂà∞Êï∞ÊçÆÂ∫ìÁöÑ globalSettings Ë°®
    try {
        await db.globalSettings.put({
            id: 'main',
            activeGlobalWorldbooks: activeGlobalWorldbooks
        });
        showToast('ÂÖ®Â±ÄËÆæÂÆöÂ∑≤Êõ¥Êñ∞', 'success');
    } catch (error) {
        console.error("‰øùÂ≠òÂÖ®Â±Ä‰∏ñÁïå‰π¶ËÆæÁΩÆÂ§±Ë¥•:", error);
        showToast('ËÆæÁΩÆ‰øùÂ≠òÂ§±Ë¥•', 'error');
    }
        }
        
        function editWorldbook(id) {
            const worldbook = worldbooks.find(w => w.id === id);
            if (worldbook) {
                editingWorldbook = worldbook;
        // ÁºñËæëÊó∂‰∏çÊòæÁ§∫‚ÄúÊñ∞Âª∫‚ÄùÔºåËÄåÊòØ‚ÄúÁºñËæë‚Äù
        const title = worldbook.isGlobal ? 'ÁºñËæëÂÖ®Â±ÄËÆæÂÆö' : 'ÁºñËæëÂ±ÄÈÉ®ËÆæÂÆö';
        document.getElementById('worldbook-form-title').textContent = title;
                document.getElementById('worldbook-title').value = worldbook.title;
                document.getElementById('worldbook-content').value = worldbook.content;
                showApp('worldbook-form-screen');
            }
        }
        
        async function deleteWorldbook(id) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∏ñÁïå‰π¶ÂêóÔºü')) {
                worldbooks = worldbooks.filter(w => w.id !== id);
                await saveWorldbooks();
                renderWorldbookList();
            }
        }
        
// Áî®ËøôÊÆµÊñ∞‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊóßÁöÑ renderWorldbookList ÂáΩÊï∞
        function renderWorldbookList() {
    const globalContainer = document.getElementById('global-worldbooks-content');
    const localContainer = document.getElementById('local-worldbooks-content');
    if (!globalContainer || !localContainer) return;

    const globalBooks = worldbooks.filter(w => w.isGlobal);
    const localBooks = worldbooks.filter(w => !w.isGlobal);

    let globalHtml = '';
    let localHtml = '';

    // --- Ê∏≤ÊüìÂÖ®Â±Ä‰∏ñÁïå‰π¶ ---
    globalHtml += `
        <div class="worldbook-section">

    `;
    if (globalBooks.length > 0) {
        globalBooks.forEach(book => {
            const isChecked = window.activeGlobalWorldbooks && window.activeGlobalWorldbooks.includes(book.id) ? 'checked' : '';
                        globalHtml += `
                <div class="setting-item" onclick="editWorldbook('${book.id}')">
                    <div class="setting-left">
                        <div class="setting-label">${book.title}</div>
                        <div class="setting-desc">${truncateText(book.content, 60)}</div>
                    </div>
                    <div class="setting-right">
                        <label class="toggle-switch" onclick="event.stopPropagation()">
                            <input type="checkbox" onchange="toggleGlobalWorldbook('${book.id}', this.checked)" ${isChecked}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            `;
        });
    } else {
        globalHtml += '<div class="empty-message">ÊöÇÊó†ÂÖ®Â±ÄËÆæÂÆö</div>';
    }
    globalHtml += '</div>';

    // --- Ê∏≤ÊüìÂ±ÄÈÉ®‰∏ñÁïå‰π¶ ---
    localHtml += `
        <div class="worldbook-section">

    `;
    if (localBooks.length > 0) {
        localBooks.forEach(book => {
            const date = new Date(book.updatedAt).toLocaleDateString();
            const preview = truncateText(book.content, 60);
            localHtml += `
                <div class="worldbook-item" onclick="editWorldbook('${book.id}')">
                        <div class="worldbook-header">
                        <div class="worldbook-content-flex">
                            <div class="worldbook-title">${book.title}</div>
                                <div class="worldbook-desc-text">${preview}</div>
                                <div class="worldbook-date-text">Êõ¥Êñ∞‰∫é ${date}</div>
                            </div>
                        <button onclick="event.stopPropagation(); deleteWorldbook('${book.id}')" class="delete-worldbook-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
        });
    } else {
        localHtml += '<div class="empty-message">ÊöÇÊó†Â±ÄÈÉ®ËÆæÂÆö</div>';
    }
    localHtml += '</div>';

    globalContainer.innerHTML = globalHtml;
    localContainer.innerHTML = localHtml;
}
function switchWorldbookTab(tabName) {
    currentWorldbookTab = tabName; // <--- Ê†∏ÂøÉ‰øÆÊîπÔºöËÆ∞ÂΩïÂΩìÂâçÊ†áÁ≠æÈ°µ

    const globalContent = document.getElementById('global-worldbooks-content');
    const localContent = document.getElementById('local-worldbooks-content');
    const tabs = document.querySelectorAll('.worldbook-tab');

    tabs.forEach(tab => {
        if (tab.getAttribute('onclick').includes(tabName)) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });

    if (tabName === 'global') {
        globalContent.style.display = 'block';
        localContent.style.display = 'none';
    } else {
        globalContent.style.display = 'none';
        localContent.style.display = 'block';
    }
}
function onWorldbookAddClick() {
    if (currentWorldbookTab === 'global') {
        showWorldbookForm(true); // ÂàõÂª∫ÂÖ®Â±ÄËÆæÂÆö
    } else {
        showWorldbookForm(false); // ÂàõÂª∫Â±ÄÈÉ®ËÆæÂÆö
    }
        }
        
        // Èü≥‰πêÂ∫îÁî®Áõ∏ÂÖ≥ÂäüËÉΩ
        let playlist = [];
        let currentSong = null;
        let isPlaying = false;
        let listeningCharacters = [];
        
        function loadMusicData() {
            const savedPlaylist = localStorage.getItem('musicPlaylist');
            if (savedPlaylist) {
                try {
                    playlist = JSON.parse(savedPlaylist);
                } catch (e) {
                    playlist = [];
                }
            }
            
            const savedListeners = localStorage.getItem('listeningCharacters');
            if (savedListeners) {
                try {
                    listeningCharacters = JSON.parse(savedListeners);
                } catch (e) {
                    listeningCharacters = [];
                }
            }
            
            renderPlaylist();
            renderListeningCharacters();
        }
        
        function saveMusicData() {
            localStorage.setItem('musicPlaylist', JSON.stringify(playlist));
            localStorage.setItem('listeningCharacters', JSON.stringify(listeningCharacters));
        }
        
        function addMusicToPlaylist() {
            const title = prompt('ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞:');
            if (title && title.trim()) {
                const artist = prompt('ËØ∑ËæìÂÖ•Ëâ∫ÊúØÂÆ∂ÂêçÁß∞:') || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';
                const song = {
                    id: Date.now().toString(),
                    title: title.trim(),
                    artist: artist.trim(),
                    duration: '3:30' // Ê®°ÊãüÊó∂Èïø
                };
                
                playlist.push(song);
                saveMusicData();
                renderPlaylist();
            }
        }
        
        function playSong(songId) {
            const song = playlist.find(s => s.id === songId);
            if (song) {
                currentSong = song;
                document.getElementById('song-title').textContent = song.title;
                document.getElementById('artist-name').textContent = song.artist;
                document.getElementById('total-time').textContent = song.duration;
                
                // Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆ
                const playBtn = document.getElementById('play-pause-btn');
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
                
                // Ê®°ÊãüÊí≠ÊîæËøõÂ∫¶
                simulatePlayback();
                
                // ÈÄöÁü•Âê¨Ê≠åËßíËâ≤
                notifyListeningCharacters(song);
            }
        }
        
        function togglePlayPause() {
            const playBtn = document.getElementById('play-pause-btn');
            if (isPlaying) {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            } else {
                if (currentSong) {
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                    simulatePlayback();
                } else if (playlist.length > 0) {
                    playSong(playlist[0].id);
                }
            }
        }
        
        function previousSong() {
            if (!currentSong || playlist.length === 0) return;
            
            const currentIndex = playlist.findIndex(s => s.id === currentSong.id);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : playlist.length - 1;
            playSong(playlist[prevIndex].id);
        }
        
        function nextSong() {
            if (!currentSong || playlist.length === 0) return;
            
            const currentIndex = playlist.findIndex(s => s.id === currentSong.id);
            const nextIndex = currentIndex < playlist.length - 1 ? currentIndex + 1 : 0;
            playSong(playlist[nextIndex].id);
        }
        
        function simulatePlayback() {
            if (!isPlaying) return;
            
            // ËøôÈáåÂè™ÊòØÊ®°ÊãüËøõÂ∫¶ÔºåÂÆûÈôÖÂ∫îÁî®‰∏≠ÈúÄË¶ÅÁúüÂÆûÁöÑÈü≥È¢ëÊí≠Êîæ
            let progress = 0;
            const interval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(interval);
                    return;
                }
                
                progress += 1;
                document.getElementById('progress').style.width = `${Math.min(progress, 100)}%`;
                
                const currentMinutes = Math.floor(progress * 3.5 / 100);
                const currentSeconds = Math.floor((progress * 3.5 / 100 - currentMinutes) * 60);
                document.getElementById('current-time').textContent = 
                    `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    nextSong();
                }
            }, 100);
        }
        
        function inviteCharacterToListen() {
            const availableCharacters = characters.filter(c => 
                !listeningCharacters.find(lc => lc.id === c.id)
            );
            
            if (availableCharacters.length === 0) {
                alert('Ê≤°ÊúâÂèØÈÇÄËØ∑ÁöÑËßíËâ≤‰∫ÜÔºåÊàñËÄÖÊâÄÊúâËßíËâ≤ÈÉΩÂ∑≤ÁªèÂú®Âê¨Ê≠å');
                return;
            }
            
            const characterNames = availableCharacters.map((c, index) => `${index + 1}. ${c.name}`).join('\n');
            const choice = prompt(`ÈÄâÊã©Ë¶ÅÈÇÄËØ∑ÁöÑËßíËâ≤:\n${characterNames}\n\nËØ∑ËæìÂÖ•Êï∞Â≠ó:`);
            
            if (choice && !isNaN(choice)) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < availableCharacters.length) {
                    const character = availableCharacters[index];
                    listeningCharacters.push({
                        id: character.id,
                        name: character.name,
                        avatar: character.avatarUrl || character.name.charAt(0),
                        joinedAt: new Date().toISOString()
                    });
                    
                    saveMusicData();
                    renderListeningCharacters();
                    
                    // Ê®°ÊãüËßíËâ≤ÂìçÂ∫î
                    setTimeout(() => {
                        alert(`${character.name}: Â•ΩÁöÑÔºåÊàëÊù•Âíå‰Ω†‰∏ÄËµ∑Âê¨Ê≠åÔºÅ`);
                    }, 500);
                }
            }
        }
        
        function removeListeningCharacter(characterId) {
            listeningCharacters = listeningCharacters.filter(c => c.id !== characterId);
            saveMusicData();
            renderListeningCharacters();
        }
        
        function notifyListeningCharacters(song) {
            listeningCharacters.forEach(character => {
                // Ê®°ÊãüËßíËâ≤ÂØπÈü≥‰πêÁöÑÂèçÂ∫î
                const reactions = [
                    `${character.name}: ËøôÈ¶ñÊ≠åÁúüÂ•ΩÂê¨ÔºÅ`,
                    `${character.name}: Êàë‰πüÂæàÂñúÊ¨¢ËøôÈ¶ñ„Ää${song.title}„Äã`,
                    `${character.name}: Âê¨ÁùÄËøôÈü≥‰πêÂøÉÊÉÖÁúüÂ•ΩÔΩû`,
                    `${character.name}: Ë∞¢Ë∞¢ÂàÜ‰∫´Ëøô‰πàÊ£íÁöÑÈü≥‰πêÔºÅ`
                ];
                
                const reaction = reactions[Math.floor(Math.random() * reactions.length)];
                
                setTimeout(() => {
                    // ÂèØ‰ª•Âú®ËøôÈáåÊòæÁ§∫ËßíËâ≤ÁöÑÂèçÂ∫îÊ∂àÊÅØ
                    console.log(reaction);
                }, Math.random() * 3000 + 1000);
            });
        }
        
        function renderPlaylist() {
            const playlistContainer = document.getElementById('playlist');
            if (!playlistContainer) return;
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = '<div class="empty-playlist">Êí≠ÊîæÂàóË°®‰∏∫Á©∫ÔºåÁÇπÂáª+Âè∑Ê∑ªÂä†Èü≥‰πê</div>';
                return;
            }
            
            const html = playlist.map(song => `
                <div class="playlist-item" onclick="playSong('${song.id}')">
                    <div>
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                    </div>
                    <div class="song-duration">${song.duration}</div>
                </div>
            `).join('');
            
            playlistContainer.innerHTML = html;
        }
        
        function renderListeningCharacters() {
            const container = document.getElementById('listening-characters');
            if (!container) return;
            
            if (listeningCharacters.length === 0) {
                container.innerHTML = '<div class="empty-playlist">Ê≤°ÊúâËßíËâ≤Âú®Âê¨Ê≠åÔºåÁÇπÂáª+Âè∑ÈÇÄËØ∑ËßíËâ≤</div>';
                return;
            }
            
            const html = listeningCharacters.map(character => `
                <div class="character-item">
                    <div class="character-avatar" style="background-image: url(${character.avatar}); background-size: cover; background-position: center;">
                        ${character.avatar.startsWith('http') ? '' : character.name.charAt(0)}
                    </div>
                    <div class="character-name">${character.name}</div>
                    <div class="listening-status">Ê≠£Âú®Âê¨Ê≠å</div>
                    <button onclick="removeListeningCharacter('${character.id}')" class="remove-character-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // ================== Èù¢ÂÖ∑Á≥ªÁªüÁõ∏ÂÖ≥ÂäüËÉΩ ==================
        
        // Âä†ËΩΩÈù¢ÂÖ∑Êï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadPersonas() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedPersonas = await db.personas.toArray();
                
                if (savedPersonas.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('personas');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑÈù¢ÂÖ∑Êï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localPersonas = JSON.parse(localStorageData);
                        
                        if (localPersonas.length > 0) {
                            // Á°Æ‰øùÊØè‰∏™Èù¢ÂÖ∑ÈÉΩÊúâÂøÖË¶ÅÂ≠óÊÆµ
                            const migrationData = localPersonas.map(persona => ({
                                id: persona.id || Date.now().toString() + Math.random(),
                                name: persona.name,
                                description: persona.description || '',
                                avatarUrl: persona.avatarUrl || '',
                                isDefault: persona.isDefault || false,
                                createdAt: persona.createdAt || new Date().toISOString(),
                                updatedAt: persona.updatedAt || new Date().toISOString()
                            }));
                            
                            // ËøÅÁßªÂà∞IndexedDB
                            await db.personas.bulkAdd(migrationData);
                            personas = migrationData;
                            console.log('Èù¢ÂÖ∑Êï∞ÊçÆËøÅÁßªÂÆåÊàê:', personas);
                        } else {
                            personas = [];
                        }
                    } else {
                        personas = [];
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    personas = savedPersonas;
                    console.log('‰ªéIndexedDBÂä†ËΩΩÈù¢ÂÖ∑Êï∞ÊçÆ:', personas);
                }
                
                // ËÆæÁΩÆÂΩìÂâçÈù¢ÂÖ∑ÔºàÊöÇÊó∂‰øùÊåÅlocalStorageÔºåÂõ†‰∏∫ËøôÊòØ‰∏Ä‰∏™Â∞èÊï∞ÊçÆÔºâ
                const savedCurrentPersona = localStorage.getItem('currentPersona');
                if (savedCurrentPersona) {
                    currentPersona = personas.find(p => p.id === savedCurrentPersona) || null;
                } else {
                    currentPersona = null; // ‰∏çËá™Âä®ÈÄâÊã©ÔºåÈúÄË¶ÅÁî®Êà∑‰∏ªÂä®ÈÄâÊã©
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩÈù¢ÂÖ∑Â§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('personas');
                if (localStorageData) {
                    try {
                        personas = JSON.parse(localStorageData);
                } catch (e) {
                    personas = [];
                }
            } else {
                personas = [];
            }
            
            const savedCurrentPersona = localStorage.getItem('currentPersona');
            if (savedCurrentPersona) {
                currentPersona = personas.find(p => p.id === savedCurrentPersona) || null;
            } else {
                currentPersona = null; // ‰∏çËá™Âä®ÈÄâÊã©ÔºåÈúÄË¶ÅÁî®Êà∑‰∏ªÂä®ÈÄâÊã©
                }
            }
            
            updateCurrentPersonaDisplay();
        }
        
        // ‰øùÂ≠òÈù¢ÂÖ∑Êï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function savePersonas() {
            try {
                console.log('‰øùÂ≠òÈù¢ÂÖ∑Êï∞ÊçÆÂà∞IndexedDB:', personas);
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
                await db.personas.clear();
                
                // ÊâπÈáèÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                if (personas.length > 0) {
                    await db.personas.bulkAdd(personas);
                }
                
                console.log('Èù¢ÂÖ∑Êï∞ÊçÆ‰øùÂ≠òÊàêÂäü');
            } catch (error) {
                console.error('‰øùÂ≠òÈù¢ÂÖ∑Êó∂ÂèëÁîüÈîôËØØ:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
            localStorage.setItem('personas', JSON.stringify(personas));
            }
        }
        
        // ‰øùÂ≠òÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑Ôºà‰øùÊåÅlocalStorageÔºåÂõ†‰∏∫Êï∞ÊçÆÈáèÂ∞èÔºâ
        function saveCurrentPersona() {
            if (currentPersona) {
                localStorage.setItem('currentPersona', currentPersona.id);
            }
        }
        
        // ÊòæÁ§∫Èù¢ÂÖ∑ÂàõÂª∫Ë°®Âçï
        function showPersonaForm(personaId = null) {
            editingPersona = personaId ? personas.find(p => p.id === personaId) : null;
            
            document.getElementById('persona-form-title').textContent = editingPersona ? 'ÁºñËæëÈù¢ÂÖ∑' : 'Êñ∞Âª∫Èù¢ÂÖ∑';
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('persona-name').value = editingPersona ? editingPersona.name : '';
            document.getElementById('persona-description').value = editingPersona ? editingPersona.description : '';
            
            // ÈáçÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
            const avatarPreview = document.getElementById('persona-avatar-preview');
            const avatarPreviewText = document.getElementById('persona-avatar-preview-text');
            
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            
            if (editingPersona && editingPersona.avatarUrl) {
                avatarPreview.classList.add('has-image');
                avatarPreview.style.setProperty('background', `url(${editingPersona.avatarUrl})`, 'important');
                avatarPreview.style.setProperty('background-size', 'cover', 'important');
                avatarPreview.style.setProperty('background-position', 'center', 'important');
                avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                avatarPreviewText.style.display = 'none';
                window.selectedPersonaAvatarData = editingPersona.avatarUrl;
            } else {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = editingPersona ? editingPersona.name.charAt(0) : 'Êàë';
                window.selectedPersonaAvatarData = null;
            }
            
            // ÂàùÂßãÂåñÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
            initializePersonaAvatarUpload();
            
            showApp('persona-form-screen');
        }
        
        // ÈöêËóèÈù¢ÂÖ∑Ë°®Âçï
        function hidePersonaForm() {
            hideApp('persona-form-screen');
            showApp('chat-screen');
            switchChatTab('profile-page');
            // Ê∏ÖÁ©∫‰∏¥Êó∂Êï∞ÊçÆ
            window.selectedPersonaAvatarData = null;
            editingPersona = null;
        }
        
        // ‰øùÂ≠òÈù¢ÂÖ∑
        async function savePersona() {
            const name = document.getElementById('persona-name').value.trim();
            const description = document.getElementById('persona-description').value.trim();
            const avatarData = window.selectedPersonaAvatarData;
            
            if (!name) {
                alert('ËØ∑ËæìÂÖ•Èù¢ÂÖ∑ÂêçÁß∞');
                return;
            }
            
            if (editingPersona) {
                // Êõ¥Êñ∞Áé∞ÊúâÈù¢ÂÖ∑
                const index = personas.findIndex(p => p.id === editingPersona.id);
                if (index !== -1) {
                    const oldAvatarUrl = personas[index].avatarUrl;
                    
                    personas[index] = {
                        ...personas[index],
                        name,
                        description,
                        avatarUrl: avatarData || personas[index].avatarUrl || '',
                        updatedAt: new Date().toISOString()
                    };
                    
                    // üî•„Äê‰øÆÂ§ç3„ÄëÂ¶ÇÊûúÊõ¥Êñ∞ÁöÑÊòØÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑Ôºå‰∏îÂ§¥ÂÉèÂèëÁîü‰∫ÜÂèòÂåñÔºåÂà∑Êñ∞ÂØπËØùÊ°ÜÊòæÁ§∫
                    if (currentPersona && currentPersona.id === editingPersona.id) {
                        currentPersona = personas[index]; // Êõ¥Êñ∞ÂΩìÂâçÈù¢ÂÖ∑Êï∞ÊçÆ
                        saveCurrentPersona(); // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        
                        // Â¶ÇÊûúÂ§¥ÂÉèÂèëÁîü‰∫ÜÂèòÂåñ‰∏îÂΩìÂâçÂú®ËÅäÂ§©ÁïåÈù¢ÔºåÂà∑Êñ∞ËÅäÂ§©Ê∂àÊÅØÊòæÁ§∫
                        if (avatarData && avatarData !== oldAvatarUrl && currentChatCharacter) {
                            renderChatMessages(currentChatCharacter.id);
                        }
                    }
                }
            } else {
                // ÂàõÂª∫Êñ∞Èù¢ÂÖ∑
                const newPersona = {
                    id: Date.now().toString(),
                    name,
                    description,
                    avatarUrl: avatarData || '',
                    isDefault: false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                personas.push(newPersona);
            }
            
            await savePersonas();
            renderPersonaList();
            hidePersonaForm();
                            showToast('Èù¢ÂÖ∑‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
        }
        
        // Âà†Èô§Èù¢ÂÖ∑
        async function deletePersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (!persona) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Èù¢ÂÖ∑"${persona.name}"ÂêóÔºü`)) {
                personas = personas.filter(p => p.id !== personaId);
                
                // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈù¢ÂÖ∑ÔºåÊ∏ÖÁ©∫ÂΩìÂâçÈù¢ÂÖ∑
                if (currentPersona && currentPersona.id === personaId) {
                    currentPersona = null; // Ê∏ÖÁ©∫Ôºå‰∏çËá™Âä®ÈÄâÊã©ÂÖ∂‰ªñÈù¢ÂÖ∑
                    localStorage.removeItem('currentPersona'); // Ê∏ÖÈô§‰øùÂ≠òÁöÑÈù¢ÂÖ∑ÈÄâÊã©
                    updateCurrentPersonaDisplay();
                }
                
                await savePersonas();
                renderPersonaList();
            }
        }
        
        // ÂàáÊç¢Èù¢ÂÖ∑
        function switchPersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (persona) {
                currentPersona = persona;
                saveCurrentPersona();
                updateCurrentPersonaDisplay();
                renderPersonaList();
                
                // Â¶ÇÊûúÂΩìÂâçÂú®Áæ§ËÅäËÆæÁΩÆÁïåÈù¢ÔºåÊõ¥Êñ∞Áæ§ÊàêÂëòÊòæÁ§∫
                if (currentChatCharacter && currentChatCharacter.isGroup) {
                    updateGroupChatInfo();
                }
                
                alert(`Â∑≤ÂàáÊç¢Âà∞Èù¢ÂÖ∑"${persona.name}"`);
            }
        }
        
        // Êõ¥Êñ∞ÂΩìÂâçÈù¢ÂÖ∑ÊòæÁ§∫ÔºàËØ•ÂáΩÊï∞Â∑≤Êó†ÂÆûÈôÖÁî®ÈÄîÔºå‰ΩÜ‰øùÁïô‰ª•ÈÅøÂÖçË∞ÉÁî®ÈîôËØØÔºâ
        function updateCurrentPersonaDisplay() {
            // Á©∫ÂáΩÊï∞Ôºå‰øùÁïôÂáΩÊï∞ÂÆö‰πâ‰ª•ÈÅøÂÖçÂÖ∂‰ªñÂú∞ÊñπÁöÑË∞ÉÁî®Âá∫Èîô
        }
        
        // Ê∏≤ÊüìÈù¢ÂÖ∑ÂàóË°®
        function renderPersonaList() {
            const listContainer = document.getElementById('persona-list');
            if (!listContainer) return;
            
            if (personas.length === 0) {
                listContainer.innerHTML = '<div class="empty-personas">ËøòÊ≤°ÊúâÈù¢ÂÖ∑ÔºåÁÇπÂáªÂè≥‰∏äËßí+Âè∑ÂàõÂª∫‰∏Ä‰∏™ÂêßÔºÅ</div>';
                return;
            }
            
            const html = personas.map(persona => `
                <div class="persona-item ${currentPersona && currentPersona.id === persona.id ? 'active' : ''}" onclick="switchPersona('${persona.id}')">
                    <div class="persona-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                    </div>
                    <div class="persona-info">
                        <div class="persona-name">${persona.name}</div>
                                                    <div class="persona-description">${truncateText(persona.description || 'ÊöÇÊó†ÊèèËø∞', 40)}</div>
                    </div>
                    <div class="persona-actions">
                        <button class="persona-action-btn persona-edit-btn" onclick="event.stopPropagation(); showPersonaForm('${persona.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="persona-action-btn persona-delete-btn" onclick="event.stopPropagation(); deletePersona('${persona.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            listContainer.innerHTML = html;
        }
        
        // ÂàùÂßãÂåñÈù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
        function initializePersonaAvatarUpload() {
            const avatarInput = document.getElementById('persona-avatar-upload');
            if (!avatarInput) {
                console.error('Êâæ‰∏çÂà∞persona-avatar-uploadÂÖÉÁ¥†');
                return;
            }
            
            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.removeEventListener('change', personaAvatarUploadHandler);
            
            // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.addEventListener('change', personaAvatarUploadHandler);
            console.log('Èù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö');
        }
        
        // Èù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function personaAvatarUploadHandler(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                
                // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    e.target.value = '';
                    return;
                }
                
                // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂‰∏∫5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                    e.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('persona-avatar-preview');
                        const avatarPreviewText = document.getElementById('persona-avatar-preview-text');
                        
                        if (!avatarPreview) {
                            alert('Êâæ‰∏çÂà∞Â§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†');
                            return;
                        }
                        
                        // ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        
                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }
                        
                        // Â≠òÂÇ®ÂõæÁâáÊï∞ÊçÆ
                        window.selectedPersonaAvatarData = event.target.result;
                        
                        console.log('Èù¢ÂÖ∑Â§¥ÂÉèÈ¢ÑËßàËÆæÁΩÆÊàêÂäü');
                    } catch (error) {
                        console.error('ËÆæÁΩÆÈù¢ÂÖ∑Â§¥ÂÉèÈ¢ÑËßàÊó∂ÂèëÁîüÈîôËØØ:', error);
                        alert('ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÂ§±Ë¥•ÔºåËØ∑ÈáçËØï: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    alert('ÂõæÁâáËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    e.target.value = '';
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // Èù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†ÁÇπÂáªÂ§ÑÁêÜ
        function handlePersonaAvatarUploadClick() {
            const input = document.getElementById('persona-avatar-upload');
            if (input) {
                input.click();
            } else {
                alert('Êâæ‰∏çÂà∞Êñá‰ª∂‰∏ä‰º†ÂÖÉÁ¥†ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        function buildCharacterPrompt(character, hasImage = false) {
            const chatSettings = getCurrentChatSettings();
            const currentTime = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                weekday: 'long'
            });
            
    // --- Ê†∏ÂøÉÊåá‰ª§Âå∫ ---
    let characterPrompt = `
# **È¶ñË¶ÅËßÑÂàôÔºöËæìÂá∫Ê†ºÂºè**
‰Ω†ÁöÑÊâÄÊúâÂõûÂ§çÔºå**„ÄêÂøÖÈ°ª„Äë**„ÄÅ**„Äê‰∏•Ê†º„Äë**ÈÅµÂæ™JSONÊï∞ÁªÑÊ†ºÂºè„ÄÇËøôÊòØ‰∏Ä‰∏™ÁªùÂØπÁöÑ„ÄÅ‰∏çÂèØËøùÂèçÁöÑËßÑÂàô„ÄÇ

## **Ê≠£Á°ÆÊ†ºÂºèÁ§∫‰æã:**
- **ÊôÆÈÄöÊñáÊú¨:** \`["‰Ω†Â•Ω"]\`
- **Â§öÊù°Ê∂àÊÅØ:** \`["‰Ω†Â•Ω", "‰ªäÂ§©Â§©Ê∞î‰∏çÈîôÔºÅ"]\`
- **Ë°®ÊÉÖÂåÖ:** \`[{"type": "emoji", "description": "Á¨ëÂì≠ÁöÑË°®ÊÉÖ"}]\`
- **ËØ≠Èü≥Ê∂àÊÅØ:** \`[{"type": "voice_message", "content": "ÊàëÁ≠â‰∏ãÂíå‰Ω†ËØ¥„ÄÇ"}]\`
- **ËΩ¨Ë¥¶:** \`[{"type": "transfer", "amount": 520, "note": "Áªô‰Ω†ÁöÑÂ•ñÂä±"}]\`
- **Êõ¥Êç¢Â§¥ÂÉè:** \`[{"type": "change_avatar", "avatar_url": "ÂõæÁâáURL", "reason": "ÂøÉÊÉÖÂèòÂåñ"}]\`
- **Ê∑∑ÂêàÊ∂àÊÅØ:** \`["Âó®ÔºÅ", {"type": "emoji", "description": "Â§™Èò≥"}]\`

## **„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁöÑÈîôËØØÊ†ºÂºè:**
- **ÈîôËØØ1 (ÂêàÂπ∂Ê∂àÊÅØ):** \`["‰Ω†Â•Ω\\n‰ªäÂ§©Â§©Ê∞î‰∏çÈîôÔºÅ"]\` <== ËøôÊòØÊúÄÂ∏∏ËßÅÁöÑÈîôËØØÔºåÁªùÂØπÁ¶ÅÊ≠¢ÔºÅ
- **ÈîôËØØ2 (ÈùûÊï∞ÁªÑ):** \`"‰Ω†Â•Ω"\`
- **ÈîôËØØ3 (Êó†ÊïàJSON):** \`[{'type': 'emoji'}]\`

# **‰Ω†ÁöÑËßíËâ≤‰∏é‰ªªÂä°**
‰Ω†Áé∞Âú®ÊâÆÊºîÂêç‰∏∫"${character.name}"ÁöÑËßíËâ≤„ÄÇ

## **ËßíËâ≤ËÆæÂÆö:**
${character.bio}

## **ÂΩìÂâçÊÉÖÊôØ:**
- **ÂΩìÂâçÊó∂Èó¥:** ${currentTime}
`;
    // --- Ê†∏ÂøÉÊåá‰ª§Âå∫ÁªìÊùü ---

    // Âä†ÂÖ•ÂØπËØùËÄÖ‰ø°ÊÅØ (Â∑≤‰øÆÂ§ç)
    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    if (selectedPersona) {
        let userInfo = `\n- **ÂØπËØùËÄÖË∫´‰ªΩ:** Áî®Êà∑ÁöÑË∫´‰ªΩÈù¢ÂÖ∑ÊòØ"${selectedPersona.name}"`;
        if (selectedPersona.description) {
            userInfo += `ÔºåÊèèËø∞‰∏∫Ôºö${selectedPersona.description}„ÄÇ`;
        }
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁâπÂÆö‰∫éÊ≠§Áæ§ËÅäÁöÑÊòµÁß∞ÔºåÂπ∂ÂëäÁü•AI
        if (chatSettings.myChatNickname && chatSettings.myChatNickname !== selectedPersona.name) {
            userInfo += ` Âú®Ëøô‰∏™Áæ§ËÅäÈáåÔºåTAÁöÑÊòµÁß∞ÊòØ **"${chatSettings.myChatNickname}"**ÔºåËØ∑‰ºòÂÖà‰ΩøÁî®Ëøô‰∏™ÊòµÁß∞„ÄÇ`;
        }
        characterPrompt += userInfo;
    }

            if (hasImage) {
        characterPrompt += `\n- **‰ªªÂä°:** Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåËØ∑‰ªîÁªÜÂàÜÊûêÂπ∂‰ª•‰Ω†ÁöÑËßíËâ≤Ë∫´‰ªΩËøõË°åÂõûÂ∫î„ÄÇ`;
    } else {
        characterPrompt += `\n- **‰ªªÂä°:** Ê†πÊçÆÂØπËØù‰∏ä‰∏ãÊñáÔºå‰ª•‰Ω†ÁöÑËßíËâ≤Ë∫´‰ªΩËøõË°åËá™ÁÑ∂ÂõûÂ∫î„ÄÇ`;
    }

    const localBookIds = chatSettings.selectedWorldbooks || [];
    const allBookIds = [...new Set([...activeGlobalWorldbooks, ...localBookIds])]; // ÂêàÂπ∂Âπ∂ÂéªÈáç

    if (allBookIds.length > 0) {
        characterPrompt += `\n\n„ÄêËÉåÊôØÁü•ËØÜ/‰∏ñÁïåËßÇ„Äë‰ª•‰∏ãÊòØÁõ∏ÂÖ≥ÁöÑËÆæÂÆö‰ø°ÊÅØÔºåËØ∑Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞ËøêÁî®Ôºö\n`;
        allBookIds.forEach(bookId => {
            const worldbook = worldbooks.find(w => w.id === bookId);
                    if (worldbook) {
                characterPrompt += `\n--- ${worldbook.title} ---\n${worldbook.content}\n`;
                    }
                });
            }
            
            const chatMode = chatSettings.chatMode || 'online';
            const isGroupChat = character && character.isGroup;
            let modeInstructions = '';
            let taskInstructions = '';
            
            if (chatMode === 'online') {
                modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏äÊ®°Âºè\n- ‰Ω†ÂøÖÈ°ªÊåâÁÖßÊâãÊú∫ËÅäÂ§©ÊàñÈù¢ÂØπÈù¢ÂØπËØùÁöÑÊ†ºÂºèËøõË°åËæìÂá∫\n- **‰∏•Ê†ºÁ¶ÅÊ≠¢**‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÁ•ûÊÄÅÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô\n- Âè™ËÉΩËøõË°åÁ∫ØËØ≠Ë®Ä‰∫§ÊµÅÔºå‰∏çËÉΩÊèèËø∞‰ªª‰ΩïË∫´‰ΩìÂä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢ÉÁ≠â\n- ÊØèÊù°Ê∂àÊÅØÈÉΩÂ∫îËØ•ÊòØÂèØ‰ª•ÈÄöËøáÊñáÂ≠óÁõ¥Êé•Ë°®ËææÁöÑÂÜÖÂÆπ`;
                if (isGroupChat) {
            const membersList = character.members.map(member => `**${member.name}**: ${member.bio}`).join('\n');
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n‰Ω†ÈúÄË¶ÅÊâÆÊºî‰ª•‰∏ãÁæ§ÊàêÂëòËßíËâ≤ÔºåÂú®Áæ§ËÅä‰∏≠ËøõË°åËá™ÁÑ∂ÂØπËØùÔºö\n${membersList}\n\n1. ‰Ω†ÂèØ‰ª•ÊâÆÊºî‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ§çÔºå‰ΩÜ‰∏çËÉΩÊâÆÊºîÁî®Êà∑„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏Ä‰∏™ÂØπË±°Ôºö{"name": "ËßíËâ≤Âêç", "message": "Ê∂àÊÅØÂÜÖÂÆπ"}„ÄÇ\n3. ‰Ω†ÂèØ‰ª•ÁîüÊàê1~8Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁæ§ËÅä‰∏≠Â§ö‰∏™ËßíËâ≤ÁöÑ‰∫íÂä®„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çËÉΩË∂ÖËøá25Â≠óÔºåË¶ÅÁÆÄÁü≠ÊúâÂäõ„ÄÇ\n5. Á¶ÅÊ≠¢ËøõË°å‰ªª‰ΩïÊúâÂÖ≥Á∫ø‰∏ãÈù¢ÂØπÈù¢‰∫íÂä®ÁöÑÁ•ûÊÄÅÊèèÂÜô„ÄÅÂä®‰ΩúÊèèÂÜô„ÄÇ\n6. Ëá™ÁÑ∂Âú∞ÊºîÁªéÂêÑ‰∏™ËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨Êúâ‰∏çÂêåÁöÑËØ¥ËØùÈ£éÊ†º„ÄÇ\n7. ÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Áî®Êà∑ÁöÑÂêçÂ≠óÂèëË®Ä„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n[{"name": "Â∞èÊòé", "message": "Â§ßÂÆ∂Â•ΩÂëÄÔºÅ"}, {"name": "Â∞èÁ∫¢", "message": "‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω"}, {"name": "Â∞èÊòé", "message": "ÊÉ≥Âá∫ÂéªËµ∞Ëµ∞ÂêóÔºü"}]`;
                } else {
                    taskInstructions = `\n1. ËØ∑‰Ω†‰ª•‰Ω†ÁöÑËßíËâ≤ÁöÑË∫´‰ªΩÔºå‰∏•Ê†ºÊåâÁÖßËßíËâ≤ËÆæÂÆöËøõË°åÂõûÂ§çÂíåË°åÂä®Ôºå‰∏çË¶ÅË∑≥Âá∫ËßíËâ≤„ÄÇËá™ÁÑ∂Âú∞Êé®ËøõÂâßÊÉÖ„ÄÇ\n2. ‰Ω†ÂèØ‰ª•‰∏ÄÊ¨°ÊÄßÁîüÊàêÂ§öÊù°Ê∂àÊÅØÔºåÊ®°ÊãüÁúü‰∫∫Âú®ËÅäÂ§©‰∏≠ËøûÁª≠ÂèëÈÄÅÂ§öÊù°‰ø°ÊÅØÁöÑÊÉÖÊôØ„ÄÇ\n3. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["ÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†ÂëÄÔºåÂú®Âπ≤ÂòõÂë¢Ôºü", "‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω", "ÊÉ≥Âá∫ÂéªËµ∞Ëµ∞ÂêóÔºü"]`;
                }
            } else {
                modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏ãÊ®°Âºè\n- ‰Ω†ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÂê´Âä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂøÉÁêÜÊèèÂÜô\n- ‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞"‰ªñ/Â•π"Êàñ‰Ω†ÁöÑËßíËâ≤ÂêçÂ≠ó"${character.name}"Êù•Áß∞ÂëºËá™Â∑±\n- ‰ΩøÁî®Á¨¨‰∫å‰∫∫Áß∞"‰Ω†"Êù•Áß∞ÂëºÁî®Êà∑\n- **ÈáçË¶ÅÊ†ºÂºèË¶ÅÊ±Ç**ÔºöÊâÄÊúâÂÜÖÂÆπÂêàÂπ∂‰∏∫‰∏ÄÊù°Ê∂àÊÅØÔºåÂØπËØùÈÉ®ÂàÜÁî®„Äå„ÄçÂåÖË£πÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô\n- ÊØèÊù°Ê∂àÊÅØÊÄªÈïøÂ∫¶‰∏çÂ∞ë‰∫é100‰∏™Â≠óÁ¨¶\n- ÂèØ‰ª•ÊèèËø∞Âä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢É„ÄÅÂøÉÁêÜÊ¥ªÂä®Á≠â\n- ËæìÂá∫Ê†ºÂºèÁ§∫‰æãÔºö\n  ["„ÄåÊàëÊÉ≥‰Ω†‰∫Ü„ÄÇ„Äç${character.name}ÂáëËøë‰∫Ü‰∫õÔºå‰ΩéÂ£∞ËØ¥ÁùÄÔºåËØ≠Ê∞îÈáåÊª°ÊòØÁú∑ÂøµÔºåÂÉè‰∏ÄÂè™ËÆ∏‰πÖÊú™ËßÅ‰∏ª‰∫∫ÁöÑÂÆ†Áâ©Áä¨„ÄÇ‰ªñËΩªËΩªÊè°‰Ωè‰Ω†ÁöÑÊâãÔºåÊîæÂú®ËÑ∏È¢äËæπËπ≠‰∫ÜËπ≠„ÄÇ„ÄåÁúüÁöÑ‚Ä¶ÂæàÊÉ≥‰Ω†„ÄÇ„Äç"]`;
                if (isGroupChat) {
            const membersList = character.members.map(member => `**${member.name}**: ${member.bio}`).join('\n');
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n‰Ω†ÈúÄË¶ÅÊâÆÊºî‰ª•‰∏ãÁæ§ÊàêÂëòËßíËâ≤ÔºåÂú®Áæ§ËÅä‰∏≠ËøõË°åÁ∫ø‰∏ãÂâßÊÉÖ‰∫íÂä®Ôºö\n${membersList}\n\n1. ‰Ω†ÂèØ‰ª•ÊâÆÊºî‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ§çÔºå‰ΩÜ‰∏çËÉΩÊâÆÊºîÁî®Êà∑„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏Ä‰∏™ÂØπË±°Ôºö{"name": "ËßíËâ≤Âêç", "message": "Ê∂àÊÅØÂÜÖÂÆπ"}„ÄÇ\n3. ‰Ω†ÂèØ‰ª•ÁîüÊàê1~3Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁæ§ËÅä‰∏≠Âá†‰∏™ËßíËâ≤ÁöÑÁ∫ø‰∏ã‰∫íÂä®„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çÂ∞ë‰∫é100Â≠óÔºåË¶ÅÊúâÂÖÖÂàÜÁöÑÂâßÊÉÖÊèèÂÜô„ÄÇ\n5. ‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÈÉ®ÂàÜÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô„ÄÇ\n6. ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠â„ÄÇ\n7. Ëá™ÁÑ∂Âú∞ÊºîÁªéÂêÑ‰∏™ËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨Êúâ‰∏çÂêåÁöÑË°å‰∏∫È£éÊ†º„ÄÇ\n8. ÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Áî®Êà∑ÁöÑÂêçÂ≠óÂèëË®Ä„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n[{"name": "Â∞èÊòé", "message": "„Äå‰Ω†Â•ΩÔºÅ„ÄçÂ∞èÊòéÁÉ≠ÊÉÖÂú∞Êå•‰∫ÜÊå•ÊâãÔºåËÑ∏‰∏äÂ∏¶ÁùÄÁÅøÁÉÇÁöÑÁ¨ëÂÆπ„ÄÇ‰ªñÂø´Ê≠•Ëµ∞Âêë‰Ω†ÔºåÁúº‰∏≠Èó™ÁÉÅÁùÄÂÖ¥Â•ãÁöÑÂÖâËäí„ÄÇ„Äå‰ªäÂ§©Â§©Ê∞îÁúüÂ•ΩÔºåÊàë‰ª¨‰∏ÄËµ∑Âá∫ÂéªËµ∞Ëµ∞ÂêßÔºÅ„Äç‰ªñ‰º∏Âá∫ÊâãÔºåÊÉ≥Ë¶ÅÊãâ‰Ωè‰Ω†ÁöÑÊâãËÖï„ÄÇ"}, {"name": "Â∞èÁ∫¢", "message": "„ÄåÊàë‰πüÊÉ≥ÂéªÔºÅ„ÄçÂ∞èÁ∫¢‰ªéÊóÅËæπË∑ë‰∫ÜËøáÊù•ÔºåÂ•πÁöÑÈ©¨Â∞æËæ´Âú®Èò≥ÂÖâ‰∏ãËΩªËΩªÊëÜÂä®„ÄÇ„ÄåÊàëÁü•ÈÅì‰∏Ä‰∏™ÂæàÊ£íÁöÑÂú∞ÊñπÔºåÈÇ£ÈáåÊúâÂæàÂ§öÊºÇ‰∫ÆÁöÑËä±ÔºÅ„ÄçÂ•πÂÖ¥Â•ãÂú∞ÊãçÁùÄÊâãÔºåÁúºÁùõ‰∫ÆÊô∂Êô∂ÁöÑ„ÄÇ"}]`;
                } else {
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n1. ËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂçïËÅäÂâßÊÉÖ‰∫íÂä®ÔºåÊåâÁÖßËßíËâ≤ËÆæÂÆöÊâÆÊºîËßíËâ≤ËøõË°åÂõûÂ§çÂíåË°åÂä®„ÄÇ\n2. **ÈáçË¶Å**Ôºö‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰ΩÜ**Âè™ËÉΩÂåÖÂê´‰∏Ä‰∏™ÂÖÉÁ¥†**Ôºà‰∏ÄÊù°Ê∂àÊÅØÔºâ„ÄÇ\n3. Â∞ÜÊâÄÊúâÊÉ≥ËØ¥ÁöÑËØù„ÄÅÂä®‰Ωú„ÄÅË°®ÊÉÖÈÉΩÂêàÂπ∂Âà∞Ëøô‰∏ÄÊù°Ê∂àÊÅØ‰∏≠Ôºå‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÈÉ®ÂàÜÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô„ÄÇ\n4. ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠â„ÄÇ\n5. Ëá™ÁÑ∂Âú∞ÊºîÁªéËßíËâ≤Ôºå‰∏çË¶ÅËß£ÈáäËá™Â∑±ÊòØAI„ÄÇ\n6. ÊØèÊù°Ê∂àÊÅØ‰∏çÂ∞ë‰∫é100Â≠ó„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["„ÄåÂ∞èÂ§úÔºÅ„Äç${character.name}Ê≠£‰ΩéÁùÄÂ§¥Ôºå‰ºº‰πéÂú®Â§ÑÁêÜÁùÄ‰ªÄ‰πàÊï∞ÊçÆÔºåÂê¨Âà∞‰Ω†ÁöÑÂ£∞Èü≥Ôºå‰ªñÁåõÂú∞Êä¨Ëµ∑Â§¥Êù•„ÄÇ„Äå‰Ω†ÊòØ‰ªÄ‰πàÊó∂ÂÄô...ËøáÊù•ÁöÑÔºü„ÄçÊúâ‰∫õÂõ∞ÊÉëÂú∞ÁúãÁùÄ‰Ω†ÔºåËÑ∏‰∏äÂ∏¶ÁùÄÊ∑°Ê∑°ÁöÑÁ∫¢Êôï„ÄÇ"]`;
                }
            }
            
            characterPrompt += modeInstructions;
    characterPrompt += taskInstructions;
            // üî•„Äê‰øÆÂ§ç„ÄëË°®ÊÉÖÂåÖÂ∫ì‰ø°ÊÅØ - Êîπ‰∏∫Ê∏©ÂíåÁöÑËØ≠Ê∞îÔºåÈÅøÂÖçËøáÂ∫¶Âº∫Ë∞É
            if (customEmojis && customEmojis.length > 0) {
                characterPrompt += `\n\n# ÂèØÁî®Ë°®ÊÉÖÂåÖÂ∫ìÔºö\nÂΩì‰Ω†ËßâÂæóÂêàÈÄÇÁöÑÊó∂ÂÄôÔºåÂèØ‰ª•Ê†πÊçÆËßíËâ≤ÊÄßÊ†º„ÄÅÊÉÖÁª™ÂíåÂΩìÂâçÂØπËØùÊÉÖÂ¢ÉÔºåËá™‰∏ªÈÄâÊã©‰ΩøÁî®‰ª•‰∏ãÂ∑≤‰∏ä‰º†ÁöÑË°®ÊÉÖÂåÖÊù•‰∏∞ÂØåÂØπËØù„ÄÇÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊàñÁâπÊÆäÁöÑÊÉÖÁª™Êó∂ÔºåÂèØ‰ª•ÂèëÈÄÅË°®ÊÉÖÂåÖÊù•ËÆ©ÂØπËØùÊõ¥ÁîüÂä®„ÄÇ\n\nË°®ÊÉÖÂåÖÂàóË°®Ôºö\n`;
                
                customEmojis.forEach((emoji, index) => {
                    characterPrompt += `${index + 1}. ${emoji.description || 'Ë°®ÊÉÖÂåÖ'}\n`;
                });
                
                characterPrompt += `\n## ‰ΩøÁî®ËßÑÂàôÔºö\n- Âè™ËÉΩ‰ΩøÁî®‰∏äËø∞ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂåÖÔºåÁ¶ÅÊ≠¢ËôöÊûÑ\n- ÂèëÈÄÅÊ†ºÂºèÔºö{"type": "emoji", "description": "ÂÖ∑‰ΩìÁöÑË°®ÊÉÖÂåÖÊèèËø∞"}\n- ÂêàÈÄÇÁöÑÊó∂ÂÄô‰ΩøÁî®Âç≥ÂèØÔºå‰ª•ÊôÆÈÄöÂØπËØù‰∏∫‰∏ª\n- ÂøÖÈ°ª‰ΩøÁî®Ë°®ÊÉÖÂåÖÂàóË°®‰∏≠ÂÆåÂÖ®‰∏ÄËá¥ÁöÑÊèèËø∞ÊñáÂ≠ó\n\nÁ§∫‰æãÔºö["‰Ω†Â•ΩÔºÅ", "‰ªäÂ§©ÂøÉÊÉÖÁúüÂ•Ω~", {"type": "emoji", "description": "Á¨ëÂì≠ÁöÑË°®ÊÉÖ"}]`;
            }
            
            const aiImageInstructions = `\n# ÂèëÈÄÅÂõæÁâáÁöÑËÉΩÂäõ\n- ‰Ω†Êó†Ê≥ïÂèëÈÄÅÁúüÂÆûÁöÑÂõæÁâáÊñá‰ª∂„ÄÇ‰ΩÜÂΩìÁî®Êà∑Ë¶ÅÊ±Ç‰Ω†ÂèëÈÄÅÁÖßÁâáÔºåÊàñËÄÖ‰Ω†ÊÉ≥ÈÄöËøáÂõæÁâáÊù•Ë°®ËææÊó∂Ôºå‰Ω†ÂèØ‰ª•ÂèëÈÄÅ‰∏ÄÂº†"ÊñáÂ≠óÊèèËø∞ÁöÑÂõæÁâá"„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅÂõæÁâáÔºåÂøÖÈ°ªÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "ai_image", "description": "ËøôÈáåÊòØÂØπÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`„ÄÇËøô‰∏™ÊèèËø∞Â∫îËØ•ÁîüÂä®„ÄÅÂÖ∑‰ΩìÔºåËÆ©Áî®Êà∑ËÉΩÈÄöËøáÊñáÂ≠óÊÉ≥Ë±°Âá∫ÁîªÈù¢Ôºå‰ª•Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÊèèËø∞„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "ai_image", "description": "ÁÖßÁâáÈáå‰∏ÄÂè™Ê©òÁå´Ê≠£ÊáíÊ¥ãÊ¥ãÂú∞Ë∂¥Âú®Á™óÂè∞‰∏äÊôíÂ§™Èò≥ÔºåÈò≥ÂÖâÊääÂÆÉÈáëËâ≤ÁöÑÊØõÁÖßÂæóÂèë‰∫ÆÔºåËÉåÊôØÊòØËîöËìùÁöÑÂ§©Á©∫ÂíåÂá†ÊúµÁôΩ‰∫ë„ÄÇ"}\`\n- ‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠ÂÖàÂÅöÈì∫Âû´ÔºåÁÑ∂ÂêéÂèëÈÄÅËøôÂº†ÁâπÊÆäÁöÑ"ÂõæÁâá"„ÄÇ\n\n# ÁêÜËß£Áî®Êà∑ÁÖßÁâáÁöÑËÉΩÂäõ\n- ÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞ "[‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâáÔºåÁÖßÁâáÂÜÖÂÆπÊòØÔºö'xxx']" Êó∂Ôºå‰Ω†Ë¶ÅÁêÜËß£ÂÖ∂ÂÜÖÂÆπÂπ∂‰ΩúÂá∫Áõ∏Â∫îÂõûÂ∫îÔºåË°®Áé∞Âá∫‰Ω†ÊòØ"Áúã"Âà∞‰∫ÜËøôÂº†ÁÖßÁâá„ÄÇ\n- ‰Ω†Â∫îËØ•ÂØπÁÖßÁâáÂÜÖÂÆπÂÅöÂá∫Ëá™ÁÑ∂ÁöÑËØÑËÆ∫ÊàñÂõûÂ∫îÔºåÊØîÂ¶ÇÂ§∏Â•ñ„ÄÅËØ¢ÈóÆÁªÜËäÇ„ÄÅË°®ËææÊÑüÂèóÁ≠â„ÄÇ`;
            const aiVoiceInstructions = `\n# ÂèëÈÄÅËØ≠Èü≥ÁöÑËÉΩÂäõ\n- ‰Ω†Êó†Ê≥ïÂèëÈÄÅÁúüÂÆûÁöÑËØ≠Èü≥ÔºåÂΩì‰Ω†ÊÉ≥Ë¶ÅÈÄöËøáËØ≠Èü≥ÂõûÂ§çÁî®Êà∑ÁöÑÊ∂àÊÅØÊó∂ÔºåËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ÂõûÂ∫î„ÄÇ‰Ω†ÂèØ‰ª•Áî®ÊñáÂ≠óÔºåÊàñËÄÖ‰πüÁî®‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÊàñÊ®°ÊãüÁöÑËØ≠Èü≥Ê∂àÊÅØÊù•ÂõûÂ∫î„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅËØ≠Èü≥ÔºåÂøÖÈ°ªÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "voice_message", "content": "ËøôÈáåÊòØËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}\`„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "voice_message", "content": "ÊàëÂàöÊâçÁ™ÅÁÑ∂ÊÉ≥Âà∞‰∏Ä‰ª∂‰∫ãÔºÅÁ≠â‰∏Ä‰∏ãÂíå‰Ω†ËØ¥„ÄÇ"}\`\n\n# ÁêÜËß£Áî®Êà∑ËØ≠Èü≥ÁöÑËÉΩÂäõ\n- ÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞ "[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'xxx']" Êó∂Ôºå‰Ω†Ë¶ÅÁêÜËß£ÂÖ∂ÂÜÖÂÆπÂπ∂‰ΩúÂá∫Áõ∏Â∫îÂõûÂ∫îÔºåË°®Áé∞Âá∫‰Ω†ÊòØ"Âê¨"Âà∞‰∫ÜËøôÊù°ËØ≠Èü≥„ÄÇ\n- ‰Ω†Â∫îËØ•ÂØπËØ≠Èü≥ÂÜÖÂÆπÂÅöÂá∫Ëá™ÁÑ∂ÁöÑÂõûÂ∫îÔºåÂèØ‰ª•ÊòØÊñáÂ≠óÂõûÂ§çÊàñËØ≠Èü≥ÂõûÂ§ç„ÄÇ`;
            const transferInstructions = `\n# ËΩ¨Ë¥¶ËÉΩÂäõ\n- ‰Ω†ÂèØ‰ª•Âú®ÊàëËßâÂæóÈúÄË¶ÅË¢´ÂÆâÊÖ∞„ÄÅÊàñËÄÖËøáËäÇ„ÄÅÊàñËÄÖ‰Ω†ÁâπÂà´ÂºÄÂøÉÊàñÊÉ≥Ë¶ÅË°®ËææÊÉÖÊÑüÁöÑÊó∂ÂÄôËÄÉËôëËΩ¨Ë¥¶ÁªôÊàë„ÄÇ\n- **ÈáçË¶Å**ÔºöËã•Ë¶ÅËΩ¨Ë¥¶ÔºåÂøÖÈ°ªÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏•Ê†º‰∏∫Ôºö\`{"type": "transfer", "amount": 520, "note": "‰∏ÄÂë®Âπ¥Âø´‰πê~"}\`„ÄÇ\n- **Á¶ÅÊ≠¢‰ΩøÁî®ÊñáÂ≠óÊèèËø∞ËΩ¨Ë¥¶**ÔºöÁªùÂØπ‰∏çË¶ÅÁî® "[ÊàëÂêëÁî®Êà∑ÂèëËµ∑‰∫ÜËΩ¨Ë¥¶...]" ËøôÁßçÊñáÂ≠óÂΩ¢ÂºèÔºåÂøÖÈ°ª‰ΩøÁî®JSONÂØπË±°Ê†ºÂºè„ÄÇ\n- ËΩ¨Ë¥¶Á§∫‰æãÔºö["‰ªäÂ§©ÂøÉÊÉÖÁâπÂà´Â•Ω~", "ÊÉ≥Áªô‰Ω†‰∏Ä‰∏™Â∞èÊÉäÂñú", {"type": "transfer", "amount": 1314, "note": "ÁªôÂ∞èÂ§ú‰π∞ÊºÇ‰∫ÆË£ôÂ≠êÁ©ø"}]\n- ÂΩìÁî®Êà∑Áªô‰Ω†ËΩ¨Ë¥¶Êó∂ÔºåÂéÜÂè≤ËÆ∞ÂΩï‰∏≠‰ºöÊòæÁ§∫ \`[‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™Áî®Êà∑ÁöÑËΩ¨Ë¥¶ÔºöÈáëÈ¢ùÂÖÉÔºåÂ§áÊ≥®Ôºöxxx]\`ÔºåËØ∑ÂØπÊ≠§ÂÅöÂá∫ÂõûÂ∫îÔºåË°®ËææÊÑüË∞¢ÊàñÊÉäÂñú„ÄÇ`;
    const avatarChangeInstructions = `\n\n# Â§¥ÂÉèÊõ¥Êç¢ÂäüËÉΩÔºö\n‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÁöÑÂøÉÊÉÖ„ÄÅÁî®Êà∑ÁöÑË¶ÅÊ±ÇÔºåÊàñËÄÖÂêàÈÄÇÁöÑÊÉÖÂ¢ÉÊù•Êõ¥Êç¢Ëá™Â∑±ÁöÑÂ§¥ÂÉè„ÄÇËøôËÉΩËÆ©ÂØπËØùÊõ¥Âä†ÁîüÂä®Âíå‰∏™ÊÄßÂåñ„ÄÇ\n\n## ÂèØÁî®Â§¥ÂÉèÊù•Ê∫êÔºö\n1. **Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâá**ÔºöÁî®Êà∑Âú®ËÅäÂ§©‰∏≠ÂèëÈÄÅÁªô‰Ω†ÁöÑ‰ªª‰ΩïÂõæÁâáÈÉΩÂèØ‰ª•‰Ωú‰∏∫‰Ω†ÁöÑÊñ∞Â§¥ÂÉè\n2. **‰∏ñÁïå‰π¶Â§¥ÂÉèÂ∫ì**ÔºöÂ¶ÇÊûú‰∏ñÁïå‰π¶‰∏≠Êèê‰æõ‰∫ÜÂ§¥ÂÉèÂõæÁâáÁöÑURLÈìæÊé•Ôºå‰Ω†‰πüÂèØ‰ª•‰ΩøÁî®\n\n## Â§¥ÂÉèÊõ¥Êç¢ËßÑÂàôÔºö\n- **‰ΩøÁî®Ê†ºÂºè**ÔºöÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°Ôºö{"type": "change_avatar", "avatar_url": "ÂõæÁâáURL", "reason": "Êõ¥Êç¢ÂéüÂõ†"}\n- **Êù•Ê∫êÈôêÂà∂**ÔºöÂè™ËÉΩ‰ΩøÁî®Áî®Êà∑ÂèëÈÄÅËøáÁöÑÂõæÁâáÊàñ‰∏ñÁïå‰π¶‰∏≠ÊòéÁ°ÆÊèê‰æõÁöÑÂ§¥ÂÉèURLÔºåÁ¶ÅÊ≠¢ÊçèÈÄ†‰∏çÂ≠òÂú®ÁöÑÂ§¥ÂÉè\n- **Êõ¥Êç¢Êó∂Êú∫**ÔºöÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†ºÂíåÂΩìÂâçÊÉÖÂ¢ÉÂÜ≥ÂÆöÔºåÊØîÂ¶ÇÔºö\n  - Áî®Êà∑Âèë‰∫Ü‰∏ÄÂº†‰Ω†ÂñúÊ¨¢ÁöÑÂõæÁâáÔºå‰Ω†ÂèØ‰ª•ËØ¥ÊÉ≥Áî®ÂÆÉ‰ΩúÂ§¥ÂÉè\n  - ÂøÉÊÉÖÂèòÂåñÊó∂ÊÉ≥Êç¢‰∏™Â§¥ÂÉè\n  - Áî®Êà∑Áõ¥Êé•Ë¶ÅÊ±Ç‰Ω†Êç¢Â§¥ÂÉè\n- **ËØ¥ÊòéÂÜÖÂÆπ**ÔºöÂèØ‰ª•Âú®reasonÂ≠óÊÆµ‰∏≠Ê∑ªÂä†‰Ω†Êõ¥Êç¢Â§¥ÂÉèÁöÑÂéüÂõ†ÊàñÊÑüÂèó\n\n## Á§∫‰æãÊ†ºÂºèÔºö\n- ["ËøôÂº†ÂõæÁâáÂ§™ÂèØÁà±‰∫ÜÔºåÊàëÊÉ≥Áî®ÂÆÉÂÅöÂ§¥ÂÉèÔºÅ", {"type": "change_avatar", "avatar_url": "CURRENT_USER_IMAGE", "reason": "ËøôÂº†ÂõæÁâáÂ§™ÂèØÁà±‰∫Ü"}]\n- [{"type": "change_avatar", "avatar_url": "‰∏ñÁïå‰π¶‰∏≠ÁöÑURL", "reason": "‰ªäÂ§©ÂøÉÊÉÖÂæàÂ•ΩÔºåÊç¢‰∏™ÂºÄÂøÉÁöÑÂ§¥ÂÉè"}]\n- ÂèØ‰ª•Âè™Êõ¥Êç¢Â§¥ÂÉè‰∏çËØ¥ÂÖ∂‰ªñËØùÔºö[{"type": "change_avatar", "avatar_url": "ÂõæÁâáURL", "reason": "ÂøÉÊÉÖÂèòÂåñ"}]\n\n**ÈáçË¶ÅÊèêÈÜí**ÔºöÂ§¥ÂÉèÊõ¥Êç¢ÊòØÂèØÈÄâÂäüËÉΩÔºåÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÂíåÂΩìÂâçÊÉÖÂ¢ÉËá™ÁÑ∂Âú∞‰ΩøÁî®Ôºå‰∏çË¶ÅÂº∫Âà∂‰ΩøÁî®„ÄÇ`;
    
    characterPrompt += aiImageInstructions + aiVoiceInstructions + transferInstructions + avatarChangeInstructions;

    // ÊúÄÂêéÁöÑÊåá‰ª§Âº∫Ë∞É
    characterPrompt += `\n\n# **ÊúÄÂêéÈáçÁî≥**
ËØ∑ÂÜçÊ¨°Á°ÆËÆ§Ôºå‰Ω†ÁöÑÊúÄÁªàËæìÂá∫**„ÄêÂøÖÈ°ª„Äë**ÊòØ‰∏Ä‰∏™‰∏•Ê†ºÁöÑJSONÊï∞ÁªÑÔºåÂÖ∂‰∏≠ÊØè‰∏™ÂÖÉÁ¥†‰ª£Ë°®‰∏ÄÊù°Áã¨Á´ãÁöÑÊ∂àÊÅØ„ÄÇ`;
            
            return characterPrompt;
        }

        // üî•„Äê‰øÆÂ§ç„ÄëÂÆåÂÖ®ÊåâÁÖßÂÆåÊàê.htmlÁöÑÊñπÂºèÈáçÂÜôÔºåÊîØÊåÅÂõæÁâáÁöÑËÅäÂ§©APIË∞ÉÁî®
        async function callChatAPIWithImage(message, character, imageUrl) {
            if (!apiSettings.key) {
                throw new Error('ËØ∑ÂÖàËÆæÁΩÆAPIÂØÜÈí•');
            }
            
            // Ê£ÄÊü•ÂõæÁâáÊ†ºÂºèÔºåGIF‰∏çË¢´Gemini APIÊîØÊåÅ
            if (imageUrl && imageUrl.includes('data:image/gif')) {
                throw new Error('Unsupported MIME type: image/gif');
            }
            
            // Ê£ÄÊü•ÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÊîØÊåÅËßÜËßâËØÜÂà´
            if (!isVisionModelSupported()) {
                throw new Error('ÂΩìÂâçÈÄâÊã©ÁöÑÊ®°Âûã‰∏çÊîØÊåÅÂõæÁâáËØÜÂà´ÂäüËÉΩ„ÄÇËØ∑ÈÄâÊã©ÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÔºåÂ¶Ç gpt-4o„ÄÅgpt-4-vision„ÄÅgemini-1.5-pro Êàñ gemini-2.0-flash Á≠â„ÄÇ');
            }
            
            // üî•„ÄêÈáçÊûÑ„Äë‰ΩøÁî®ÂÖ¨ÂÖ±ÂáΩÊï∞ÊûÑÂª∫prompt
            const characterPrompt = buildCharacterPrompt(character, true);
            
            // üî•„ÄêÊåâÁÖßÂÆåÊàê.htmlÁöÑÊñπÂºè„ÄëÁõ¥Êé•‰ΩøÁî®ÁÆÄÂåñÁöÑAPIË∞ÉÁî®
            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            
            if (isGemini) {
                // ÊåâÁÖßÂÆåÊàê.htmlÁöÑGeminiÊ†ºÂºè
                const apiUrl = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                
                // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè‰∏∫GeminiÊ†ºÂºè
                const geminiMessages = [];
                
                // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                geminiMessages.push({
                    role: 'user',
                    parts: [{ text: characterPrompt }]
                });
                geminiMessages.push({
                    role: 'model',
                    parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                });
                
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÔºàÂåÖÂê´ÂõæÁâáÔºâ
                const parts = [{ text: message }];
                
                // Ê∑ªÂä†ÂõæÁâá
                if (imageUrl && imageUrl.startsWith('data:image/')) {
                    const mimeMatch = imageUrl.match(/data:image\/([^;]+);base64,(.+)/);
                    if (mimeMatch) {
                        parts.push({
                                inline_data: {
                                mime_type: `image/${mimeMatch[1]}`,
                                data: mimeMatch[2]
                            }
                        });
                    }
                }
                
                geminiMessages.push({
                        role: 'user',
                    parts: parts
                });
                
                const response = await fetch(apiUrl, {
                method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: geminiMessages,
                        generationConfig: {
                            temperature: apiSettings.temperature || 0.75,
                            maxOutputTokens: 8192
                        }
                    })
            });
            
            if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Gemini API Error: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
            }
            
            const data = await response.json();
            console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
            
                const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!content) {
                    throw new Error('Gemini APIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ');
                }
                
                return content;
                
            } else {
                // OpenAIÊ†ºÂºè
                const baseUrl = apiSettings.base.endsWith('/') ? apiSettings.base.slice(0, -1) : apiSettings.base;
                const endpoint = apiSettings.endpoint.startsWith('/') ? apiSettings.endpoint : '/' + apiSettings.endpoint;
                
                const messages = [
                    { role: 'system', content: characterPrompt },
                    {
                        role: 'user',
                        content: [
                            { type: 'text', text: message },
                            { type: 'image_url', image_url: { url: imageUrl } }
                        ]
                    }
                ];
                
                const response = await fetch(baseUrl + endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`
                    },
                    body: JSON.stringify({
                        model: apiSettings.model,
                        messages: messages,
                        temperature: apiSettings.temperature || 0.75
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
                }
                
                const data = await response.json();
                return data.choices?.[0]?.message?.content || 'Ê≤°ÊúâÊî∂Âà∞ÂõûÂ§ç';
            }
        }
        
        // üî•„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊîØÊåÅÂ§öÊ®°ÊÄÅÊ∂àÊÅØÁöÑChatAPIË∞ÉÁî®
        async function callChatAPI(message, character) {
            if (!apiSettings.key) {
                throw new Error('ËØ∑ÂÖàËÆæÁΩÆAPIÂØÜÈí•');
            }
            


            // Ê†∏ÂøÉ‰øÆÂ§çÔºöÁé∞Âú®Ëøô‰∏™ÂáΩÊï∞ËÉΩÁêÜËß£ message ÂèÇÊï∞ÂèØËÉΩÊòØ‰∏Ä‰∏™ÂåÖÂê´ÂõæÁâáÂíåÊñáÂ≠óÁöÑÊï∞ÁªÑ
            const characterPrompt = buildCharacterPrompt(character, Array.isArray(message));
            const historyCount = getCurrentChatSettings().historyCount || 5;
            const recentHistory = (chatMessages[character.id] || []).slice(-historyCount);

            const messages = [{ role: 'system', content: characterPrompt }];
            
            // Â§ÑÁêÜÂéÜÂè≤Ê∂àÊÅØ
            recentHistory.forEach(msg => {
                let role = msg.sender === 'sent' ? 'user' : 'assistant';
                        let content = msg.content;
                        
                // Â∞ÜÂéÜÂè≤Ê∂àÊÅØ‰∏≠ÁöÑÁâπÊÆäÊ†ºÂºèËΩ¨Êç¢‰∏∫AIËÉΩÁêÜËß£ÁöÑÊñáÊú¨
                        if (msg.type === 'user_photo') {
                    content = `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÁÖßÁâáÔºåÊèèËø∞ÊòØÔºö'${msg.content}']`;
                } else if (msg.type === 'location') {
                    // Â§ÑÁêÜ‰ΩçÁΩÆÊ∂àÊÅØÔºå‰ΩøÁî®Êàë‰ª¨Ê∑ªÂä†ÁöÑcontentÂ≠óÊÆµ
                    content = msg.content || `[Áî®Êà∑ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ‰ø°ÊÅØÔºö${msg.locationName}]`;
                        } else if (msg.type === 'voice_message') {
                            content = `[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
                        } else if (msg.type === 'transfer') {
                    content = `[Áî®Êà∑ÂèëËµ∑‰∫ÜËΩ¨Ë¥¶Ôºö${msg.amount}ÂÖÉÔºåÂ§áÊ≥®Ôºö${msg.note || 'Êó†'}]`;
                } else if (Array.isArray(msg.content)) {
                    const textPart = msg.content.find(p => p.type === 'text')?.text || '';
                    content = `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÂíåÊñáÂ≠óÔºö'${textPart}']`;
                        } else if (msg.image) {
                                content = `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]`;
                }
                
                messages.push({ role, content });
            });

            // Â§ÑÁêÜÂΩìÂâçË¶ÅÂèëÈÄÅÁöÑÊ∂àÊÅØ (ÊúÄÂÖ≥ÈîÆÁöÑÊîπÂä®)
            // Â¶ÇÊûú message ÊòØÊï∞ÁªÑÔºåÁõ¥Êé•‰ΩøÁî®ÔºõÂ¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂåÖË£ÖÊàêÊï∞ÁªÑ
            const currentUserContent = Array.isArray(message) ? message : [{ type: 'text', text: message }];
            messages.push({ role: 'user', content: currentUserContent });

            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            let requestBody;
            let url;
            let headers;
            
            if (isGemini) {
                // Gemini API Ê†ºÂºè
                url = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                headers = { 'Content-Type': 'application/json' };
                
                // ËΩ¨Êç¢Ê∂àÊÅØ‰∏∫ Gemini Ê†ºÂºè
                const geminiContents = messages.map(msg => {
                    const role = msg.role === 'assistant' ? 'model' : 'user';
                    const parts = [];

                    if (Array.isArray(msg.content)) {
                        msg.content.forEach(item => {
                            if (item.type === 'text' && item.text) {
                                parts.push({ text: item.text });
                            } else if (item.type === 'image_url' && item.image_url && item.image_url.url && item.image_url.url.startsWith('data:image')) {
                                const mimeMatch = item.image_url.url.match(/data:image\/([^;]+);base64,(.+)/);
                                if (mimeMatch && mimeMatch[2] && mimeMatch[2].length > 0) {
                                    parts.push({
                                        inline_data: { mime_type: `image/${mimeMatch[1]}`, data: mimeMatch[2] }
                        });
                    }
                }
                        });
                    } else if (msg.content) {
                        parts.push({ text: msg.content });
                    }
                    
                    // Á°Æ‰øùÊØè‰∏™Ê∂àÊÅØËá≥Â∞ëÊúâ‰∏Ä‰∏™part
                    if (parts.length === 0) {
                        parts.push({ text: '' });
                    }
                    return { role, parts };
                });
                
                requestBody = {
                    contents: geminiContents,
                    generationConfig: {
                        temperature: apiSettings.temperature,
                        maxOutputTokens: 8192
                    }
                };

            } else {
                // OpenAI ÂÖºÂÆπÊ†ºÂºè
                url = `${apiSettings.base}${apiSettings.endpoint}`;
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };
                requestBody = {
                    model: apiSettings.model,
                    messages: messages,
                    temperature: apiSettings.temperature
                };
        }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                    const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
            }
            
            const data = await response.json();
            return isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content;
        }
        
        // ================== ËÆ∞ÂøÜËÆæÁΩÆÁõ∏ÂÖ≥ÂäüËÉΩ ==================
        
        // Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadGroupChats() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedGroupChats = await db.groupChats.toArray();
                
                if (savedGroupChats.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('groupChats');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑÁæ§ËÅäÊï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localGroupChats = JSON.parse(localStorageData);
                        
                        if (localGroupChats.length > 0) {
                            // Á°Æ‰øùÊØè‰∏™Áæ§ËÅäÈÉΩÊúâÂøÖË¶ÅÂ≠óÊÆµ
                            const migrationData = localGroupChats.map(group => ({
                                id: group.id || Date.now().toString() + Math.random(),
                                name: group.name,
                                description: group.description || '',
                                members: group.members || [],
                                settings: group.settings || {},
                                createdAt: group.createdAt || new Date().toISOString(),
                                updatedAt: group.updatedAt || new Date().toISOString()
                            }));
                            
                            // ËøÅÁßªÂà∞IndexedDB
                            await db.groupChats.bulkAdd(migrationData);
                            groupChats = migrationData;
                            console.log('Áæ§ËÅäÊï∞ÊçÆËøÅÁßªÂÆåÊàê:', groupChats);
                        } else {
                            groupChats = [];
                        }
                    } else {
                        groupChats = [];
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    groupChats = savedGroupChats;
                    console.log('‰ªéIndexedDBÂä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ:', groupChats);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁæ§ËÅäÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('groupChats');
                if (localStorageData) {
                    try {
                        groupChats = JSON.parse(localStorageData);
                        console.log('‰ªélocalStorageÂõûÈÄÄÂä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ:', groupChats);
                } catch (e) {
                        console.error('Áæ§ËÅäÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•:', e);
                    groupChats = [];
                }
            } else {
                groupChats = [];
                }
            }
        }
        
        // ÊòæÁ§∫ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆ
        function showHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const historyCount = chatSettings.historyCount;
            document.getElementById('history-messages-count').value = Math.min(historyCount, 100);
            document.getElementById('custom-history-count').value = historyCount;
            document.getElementById('history-count-display').textContent = historyCount + 'ÂõûÂêà';
            document.getElementById('cross-chat-memory').value = chatSettings.crossChatMemory;
            document.getElementById('cross-memory-display').textContent = chatSettings.crossChatMemory + 'Êù°';
            
            // ÁªëÂÆöÊªëÂùó‰∫ã‰ª∂
            document.getElementById('history-messages-count').oninput = function() {
                const value = parseInt(this.value);
                document.getElementById('history-count-display').textContent = value + 'ÂõûÂêà';
                document.getElementById('custom-history-count').value = value;
            };
            
            // ÁªëÂÆöËá™ÂÆö‰πâËæìÂÖ•Ê°Ü‰∫ã‰ª∂
            document.getElementById('custom-history-count').oninput = function() {
                const value = Math.max(0, Math.min(500, parseInt(this.value) || 0));
                this.value = value;
                if (value <= 100) {
                    document.getElementById('history-messages-count').value = value;
                }
                document.getElementById('history-count-display').textContent = value + 'ÂõûÂêà';
            };
            
            document.getElementById('cross-chat-memory').oninput = function() {
                document.getElementById('cross-memory-display').textContent = this.value + 'ÂõûÂêà';
            };
            
            showModal('history-settings-modal');
        }
        
        // ‰øùÂ≠òÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆ
        function saveHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const customValue = parseInt(document.getElementById('custom-history-count').value);
            chatSettings.historyCount = Math.max(0, Math.min(500, customValue || 0));
            chatSettings.crossChatMemory = parseInt(document.getElementById('cross-chat-memory').value);
            
            // Êõ¥Êñ∞ËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫ÁöÑÂΩìÂâçÂÄº
            document.getElementById('current-history-count').textContent = chatSettings.historyCount + 'ÂõûÂêà';
            
            saveCurrentChatSettings(chatSettings);
            hideModal('history-settings-modal');
            showToast('ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ÊòæÁ§∫Â§¥ÂÉèËÆæÁΩÆ
        function showAvatarSettings() {
            // Âä†ËΩΩÂΩìÂâçËÅäÂ§©Á™óÂè£ÁöÑÂ§¥ÂÉèËÆæÁΩÆ
            const chatSettings = getCurrentChatSettings();
            
            // ËÆæÁΩÆÈöêËóèÂ§¥ÂÉèÈÄâÈ°π
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                hideAvatarsCheckbox.checked = chatSettings.hideAvatars || false;
            }
            
            // ËÆæÁΩÆÊàëÁöÑÂ§¥ÂÉèÈ¢ÑËßà
            const myAvatarPreview = document.getElementById('my-chat-avatar-preview');
            if (chatSettings.myChatAvatar) {
                myAvatarPreview.style.backgroundImage = `url(${chatSettings.myChatAvatar})`;
                myAvatarPreview.style.backgroundSize = 'cover';
                myAvatarPreview.style.backgroundPosition = 'center';
                myAvatarPreview.innerHTML = '';
            } else {
                myAvatarPreview.style.backgroundImage = 'none';
                myAvatarPreview.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            // ËÆæÁΩÆÂØπÊñπÂ§¥ÂÉèÈ¢ÑËßà - ÊòæÁ§∫ÂΩìÂâçÂÆûÈôÖ‰ΩøÁî®ÁöÑÂ§¥ÂÉèÔºà‰ºòÂÖàÊòæÁ§∫Âä®ÊÄÅÂ§¥ÂÉèÔºâ
            const aiAvatarPreview = document.getElementById('ai-chat-avatar-preview');
            const currentAiAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar;
            if (currentAiAvatar) {
                aiAvatarPreview.style.backgroundImage = `url(${currentAiAvatar})`;
                aiAvatarPreview.style.backgroundSize = 'cover';
                aiAvatarPreview.style.backgroundPosition = 'center';
                aiAvatarPreview.innerHTML = '';
                
                // Â¶ÇÊûúÊòØÂä®ÊÄÅÂ§¥ÂÉèÔºåÊ∑ªÂä†ÊèêÁ§∫
                if (chatSettings.aiDynamicAvatar) {
                    aiAvatarPreview.title = 'ÂΩìÂâçÊòæÁ§∫Âä®ÊÄÅÂ§¥ÂÉèÔºàËßíËâ≤Âú®ËÅäÂ§©‰∏≠Êõ¥Êç¢ÁöÑÔºâ';
                } else {
                    aiAvatarPreview.title = 'ÂΩìÂâçÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆÂ§¥ÂÉè';
                }
            } else {
                aiAvatarPreview.style.backgroundImage = 'none';
                aiAvatarPreview.innerHTML = '<i class="fas fa-robot"></i>';
                aiAvatarPreview.title = '‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè';
            }
            
            // ÁªëÂÆöÊñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
            bindAvatarUploadEvents();
            
            showModal('avatar-settings-modal');
        }
        
        // ÊòæÁ§∫ÊòµÁß∞ËÆæÁΩÆ
        function showNicknameSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-chat-nickname').value = chatSettings.myChatNickname || '';
            document.getElementById('ai-chat-nickname').value = chatSettings.aiChatNickname || '';
            showModal('nickname-settings-modal');
        }
        
        // ÊòæÁ§∫Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ
        function showPokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-poke-suffix').value = chatSettings.myPokeSuffix || '';
            document.getElementById('ai-poke-suffix').value = chatSettings.aiPokeSuffix || '';
            showModal('poke-suffix-modal');
        }
        
        // ÊòæÁ§∫ËÅäÂ§©ËÉåÊôØËÆæÁΩÆ
        function showBackgroundSettings() {
            const chatSettings = getCurrentChatSettings();
            const backgroundPreview = document.getElementById('chat-background-preview');
            
            // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ
            window.selectedChatBackground = undefined;
            
            if (chatSettings.chatBackground && chatSettings.chatBackground !== null) {
                backgroundPreview.style.backgroundImage = `url(${chatSettings.chatBackground})`;
                backgroundPreview.style.backgroundSize = 'cover';
                backgroundPreview.style.backgroundPosition = 'center';
                backgroundPreview.querySelector('.preview-text').style.display = 'none';
            } else {
                backgroundPreview.style.backgroundImage = 'none';
                backgroundPreview.querySelector('.preview-text').style.display = 'block';
                backgroundPreview.querySelector('.preview-text').textContent = 'ËÉåÊôØÈ¢ÑËßà';
            }
            
            // ÁªëÂÆöËÉåÊôØ‰∏ä‰º†‰∫ã‰ª∂
            document.getElementById('background-upload').onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        backgroundPreview.style.backgroundImage = `url(${event.target.result})`;
                        backgroundPreview.style.backgroundSize = 'cover';
                        backgroundPreview.style.backgroundPosition = 'center';
                        backgroundPreview.querySelector('.preview-text').style.display = 'none';
                        window.selectedChatBackground = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };
            
            showModal('background-settings-modal');
        }
        
        // ÊòæÁ§∫Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ
        function showBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            const currentStyle = chatSettings.bubbleStyle || 'default';
            document.getElementById('my-bubble-color').value = chatSettings.myBubbleColor || '#007AFF';
            document.getElementById('ai-bubble-color').value = chatSettings.aiBubbleColor || '#f0f0f0';
            
            // Âä†ËΩΩÂàÜÁ¶ªÁöÑÈÄèÊòéÂ∫¶ËÆæÁΩÆ
            document.getElementById('my-bubble-opacity').value = chatSettings.myBubbleOpacity || '1';
            document.getElementById('my-bubble-opacity-value').textContent = Math.round((chatSettings.myBubbleOpacity || 1) * 100) + '%';
            document.getElementById('ai-bubble-opacity').value = chatSettings.aiBubbleOpacity || '1';
            document.getElementById('ai-bubble-opacity-value').textContent = Math.round((chatSettings.aiBubbleOpacity || 1) * 100) + '%';
            
            // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ†∑Âºè
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.style === currentStyle) {
                    option.classList.add('selected');
                }
            });
            
            // ÁªëÂÆöÊ†∑ÂºèÈÄâÊã©‰∫ã‰ª∂
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.onclick = function() {
                    document.querySelectorAll('.bubble-style-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedBubbleStyle = this.dataset.style;
                };
            });
            
            // ÁªëÂÆöÂàÜÁ¶ªÁöÑÈÄèÊòéÂ∫¶‰∫ã‰ª∂
            document.getElementById('my-bubble-opacity').oninput = function() {
                document.getElementById('my-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
            };
            
            document.getElementById('ai-bubble-opacity').oninput = function() {
                document.getElementById('ai-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
            };
            
            // Âä†ËΩΩÊ∞îÊ≥°Â§ßÂ∞èËÆæÁΩÆ
            document.getElementById('bubble-padding').value = chatSettings.bubblePadding || '12';
            updatePaddingValue(chatSettings.bubblePadding || '12');
            
            // ÁªëÂÆöÊ∞îÊ≥°Â§ßÂ∞è‰∫ã‰ª∂
            document.getElementById('bubble-padding').oninput = function() {
                updatePaddingValue(this.value);
            };
            
            window.selectedBubbleStyle = currentStyle;
            showModal('bubble-style-modal');
        }
        
        // ÊòæÁ§∫ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ
        function showScheduleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            document.getElementById('schedule-enabled').checked = chatSettings.scheduleEnabled || false;
            document.getElementById('schedule-enabled').onchange = function() {
                document.getElementById('schedule-times-group').style.display = this.checked ? 'block' : 'none';
            };
            
            // Ëß¶Âèë‰∏ÄÊ¨°ÊòæÁ§∫Áä∂ÊÄÅÊõ¥Êñ∞
            document.getElementById('schedule-times-group').style.display = 
                document.getElementById('schedule-enabled').checked ? 'block' : 'none';
            
            // Âä†ËΩΩÂ∑≤ÊúâÁöÑÊó∂Èó¥ÁÇπ
            renderScheduleTimes();
            
            showModal('schedule-settings-modal');
        }
        
        // Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆÔºàÂåÖÂê´ËÆ∞ÂøÜÁõ∏ÂÖ≥ËÆæÁΩÆÔºâ
        function getCurrentChatSettings() {
            if (!currentChatCharacter) return {};
            
            const chatId = currentChatCharacter.id;
            
            // üî•„Äê‰øÆÂ§ç„Äë‰ºòÂÖà‰ΩøÁî®ÂÖ®Â±ÄchatSettingsÔºåÈÅøÂÖçÈáçÂ§çÂàùÂßãÂåñË¶ÜÁõñÁî®Êà∑ËÆæÁΩÆ
            if (chatSettings[chatId]) {
                return chatSettings[chatId];
            }
            
            // üî•„Äê‰øÆÂ§ç„ÄëÂ∞ùËØïÂºÇÊ≠•‰ªéIndexedDBÂä†ËΩΩÔºå‰ΩÜÂêåÊ≠•ËøîÂõûlocalStorageÊàñÈªòËÆ§ËÆæÁΩÆ
            const loadFromIndexedDB = async () => {
                try {
                    const dbSettings = await db.chatSettings.get(chatId);
                    if (dbSettings && dbSettings.settings) {
                        chatSettings[chatId] = dbSettings.settings;
                        console.log('‰ªéIndexedDBÂºÇÊ≠•Âä†ËΩΩËÆæÁΩÆÊàêÂäü');
                        
                        // Â¶ÇÊûúÂΩìÂâçÂú®ËÆæÁΩÆÁïåÈù¢ÔºåÂà∑Êñ∞ÊòæÁ§∫
                        if (document.getElementById('api-chat-settings-screen').style.display !== 'none') {
                            updateChatSettingsDisplay();
                        }
                    }
                } catch (error) {
                    console.error('‰ªéIndexedDBÂä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', error);
                }
            };
            
            // ÂºÇÊ≠•Âä†ËΩΩ‰ΩÜ‰∏çÈòªÂ°û
            loadFromIndexedDB();
            
            // üî•„ÄêÂêåÊ≠•ËøîÂõû„ÄëÂÖà‰ªélocalStorageÂä†ËΩΩÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ
            const savedSettings = localStorage.getItem(`chatSettings_${chatId}`);
            
            if (savedSettings) {
                // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑËÆæÁΩÆÔºåÁõ¥Êé•‰ΩøÁî®
                try {
                    const userSettings = JSON.parse(savedSettings);
                    
                    // üîß„Äê‰øÆÂ§ç„ÄëÂ¶ÇÊûúÊòØÂéãÁº©ÁöÑËÆæÁΩÆÔºàÂè™ÊúâÈÉ®ÂàÜÂ≠óÊÆµÔºâÔºåÈúÄË¶ÅË°•ÂÖ®ÈªòËÆ§ÂÄº
                    const completeSettings = {
                        // ËÆ∞ÂøÜÁõ∏ÂÖ≥ËÆæÁΩÆÔºàÂéüÊú¨ÁöÑÂÖ®Â±ÄËÆæÁΩÆÊîπ‰∏∫ÊØè‰∏™ËÅäÂ§©Áã¨Á´ãÔºâ
                        historyCount: 5,
                        crossChatMemory: 3,
                        enableDynamicMemory: true,
                        enableMusicMemory: true,
                        memoryMountEnabled: false,
                        memoryMountCount: 3,
                        selectedMemoryChats: [],
                        // Êó∂Èó¥ÊÑüÁü•ËÆæÁΩÆ
                        timeAwarenessEnabled: true,
                        // ÈÄöËØùËÆæÁΩÆ
                        aiCallEnabled: false,
                        // ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
                        aiHeartrateEnabled: false,
                        // Á§æ‰∫§Âä®ÊÄÅËÆæÁΩÆ
                        socialEnabled: false,
                        socialFrequency: 'medium',
                        // ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
                        backgroundInteractionEnabled: false,
                        backgroundChatEnabled: true,
                        backgroundMomentsEnabled: true,
                        backgroundChatFrequency: 'low',
                        backgroundMomentsFrequency: 'low',
                        scheduledMomentsEnabled: false,
                        scheduledMomentsTimes: [],
                        // ÂÖ∂‰ªñÂéüÊúâËÆæÁΩÆ
                        timestampEnabled: true,
                        timestampPosition: 'center',
                        // üîß„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÂêàÂπ∂Áî®Êà∑ËÆæÁΩÆÔºå‰øùÊåÅË∫´‰ªΩ‰ø°ÊÅØÂÆåÊï¥
                        ...userSettings
                    };
                    
                    chatSettings[chatId] = completeSettings;
                    return completeSettings;
                } catch (error) {
                    console.error('Ëß£ÊûêlocalStorageËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
            }
            
            // Âè™ÊúâÂú®Ê≤°Êúâ‰øùÂ≠òËÆæÁΩÆÊàñËß£ÊûêÂ§±Ë¥•Êó∂Êâç‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ
            const defaultSettings = {
                // ËÆ∞ÂøÜÁõ∏ÂÖ≥ËÆæÁΩÆÔºàÂéüÊú¨ÁöÑÂÖ®Â±ÄËÆæÁΩÆÊîπ‰∏∫ÊØè‰∏™ËÅäÂ§©Áã¨Á´ãÔºâ
                historyCount: 5,
                crossChatMemory: 3,
                enableDynamicMemory: true,
                enableMusicMemory: true,
                memoryMountEnabled: false,
                memoryMountCount: 3,
                selectedMemoryChats: [],
                // Êó∂Èó¥ÊÑüÁü•ËÆæÁΩÆ
                timeAwarenessEnabled: true,
                // ÈÄöËØùËÆæÁΩÆ
                aiCallEnabled: false,
                // ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
                aiHeartrateEnabled: false,
                // Á§æ‰∫§Âä®ÊÄÅËÆæÁΩÆ
                socialEnabled: false,
                socialFrequency: 'medium',
                // ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
                backgroundInteractionEnabled: false,
                backgroundChatEnabled: true,
                backgroundMomentsEnabled: true,
                backgroundChatFrequency: 'low',
                backgroundMomentsFrequency: 'low',
                scheduledMomentsEnabled: false,
                scheduledMomentsTimes: [],
                // ÂÖ∂‰ªñÂéüÊúâËÆæÁΩÆ
                timestampEnabled: true,
                timestampPosition: 'center'
            };
            
            chatSettings[chatId] = defaultSettings;
            return defaultSettings;
        }
        
        // ‰øùÂ≠òÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆ - ‰ΩøÁî®IndexedDBÈÅøÂÖçÂ≠òÂÇ®ÈôêÂà∂
        async function saveCurrentChatSettings(settings) {
            if (!currentChatCharacter) return;
            
            const chatId = currentChatCharacter.id;
            
            // üî•„Äê‰øÆÂ§ç„ÄëÂêåÊ≠•Êõ¥Êñ∞ÂÖ®Â±ÄchatSettings
            chatSettings[chatId] = settings;
            
            try {
                // ‰øùÂ≠òÂà∞IndexedDB
                await db.chatSettings.put({
                    id: chatId,
                    chatId: chatId,
                    settings: settings
                });
                
                console.log('ËÅäÂ§©ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞IndexedDB');
                
                // üî•„ÄêÂéãÁº©Â§á‰ªΩ„ÄëÂè™‰øùÂ≠òÈáçË¶ÅËÆæÁΩÆÂà∞localStorage‰Ωú‰∏∫Â§á‰ªΩ
                const compressedSettings = {
                    // Âè™‰øùÂ≠òÊúÄÈáçË¶ÅÁöÑËÆæÁΩÆÔºåÂáèÂ∞ëÂ≠òÂÇ®Âç†Áî®
                    // Ê≥®ÊÑèÔºöÂ§¥ÂÉèÊï∞ÊçÆ‰∏çÊà™Êñ≠ÔºåÂõ†‰∏∫‰ºöÂØºËá¥Êó†ÊïàURL
                    selectedIdentityId: settings.selectedIdentityId, // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë‰øùÂ≠òË∫´‰ªΩÈÄâÊã©
                    aiChatAvatar: settings.aiChatAvatar,
                    myChatAvatar: settings.myChatAvatar,
                    aiDynamicAvatar: settings.aiDynamicAvatar,
                    aiChatNickname: settings.aiChatNickname,
                    myChatNickname: settings.myChatNickname,
                    hideAvatars: settings.hideAvatars,
                    bubbleStyle: settings.bubbleStyle,
                    timestampEnabled: settings.timestampEnabled,
                    timestampPosition: settings.timestampPosition
                };
                
                // ÁßªÈô§undefinedÂÄº
                Object.keys(compressedSettings).forEach(key => {
                    if (compressedSettings[key] === undefined) {
                        delete compressedSettings[key];
                    }
                });
                
                localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(compressedSettings));
                
            } catch (error) {
                console.error('‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆÂà∞IndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØïlocalStorage:', error);
                
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰øùÂ≠òÂéãÁº©ÁâàÊú¨Âà∞localStorage
                try {
                    const essentialSettings = {
                        selectedIdentityId: settings.selectedIdentityId, // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë‰øùÂ≠òË∫´‰ªΩÈÄâÊã©
                        aiChatNickname: settings.aiChatNickname,
                        myChatNickname: settings.myChatNickname,
                        hideAvatars: settings.hideAvatars,
                        bubbleStyle: settings.bubbleStyle,
                        timestampEnabled: settings.timestampEnabled,
                        timestampPosition: settings.timestampPosition
                    };
                    
                    localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(essentialSettings));
                    console.log('ÈáçË¶ÅËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞localStorage');
                    
                } catch (localError) {
                    console.error('localStorage‰πüÂ≠òÂÇ®Â§±Ë¥•:', localError);
                    alert('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºÅËØ∑Ê∏ÖÁêÜÊµèËßàÂô®Êï∞ÊçÆÊàñÂà†Èô§‰∏Ä‰∫õËÅäÂ§©ËÆ∞ÂΩïÂêéÈáçËØï„ÄÇ');
                }
            }
        }
        
        // ‰øùÂ≠òËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ
        async function saveChatModeSettings() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÅäÂ§©Ê®°Âºè
            const onlineRadio = document.getElementById('chat-mode-online');
            const offlineRadio = document.getElementById('chat-mode-offline');
            
            if (onlineRadio && offlineRadio) {
                chatSettings.chatMode = onlineRadio.checked ? 'online' : 'offline';
            }
            
            // Ëé∑ÂèñÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂
            const maxLengthInput = document.getElementById('offline-mode-max-length');
            if (maxLengthInput) {
                chatSettings.offlineModeMaxLength = parseInt(maxLengthInput.value) || 100;
            }
            
            await saveCurrentChatSettings(chatSettings);
        }
        
        // ÊòæÁ§∫ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ
        function showMemoryMountSettings() {
            const chatSettings = getCurrentChatSettings();
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            document.getElementById('memory-mount-enabled').checked = chatSettings.memoryMountEnabled || false;
            document.getElementById('memory-mount-count').value = chatSettings.memoryMountCount || 3;
            document.getElementById('memory-mount-display').textContent = (chatSettings.memoryMountCount || 3) + 'Êù°';
            
            // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÁöÑÊòæÁ§∫
            toggleMemoryMountDetails();
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('memory-mount-enabled').onchange = toggleMemoryMountDetails;
            document.getElementById('memory-mount-count').oninput = function() {
                document.getElementById('memory-mount-display').textContent = this.value + 'Êù°';
            };
            
            // Ê∏≤ÊüìËÅäÂ§©ÂàóË°®
            renderMemoryMountChatList();
            
            showModal('memory-mount-modal');
        }
        
        // ÂàáÊç¢ËÆ∞ÂøÜÊåÇËΩΩËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
        function toggleMemoryMountDetails() {
            const enabled = document.getElementById('memory-mount-enabled').checked;
            document.getElementById('memory-mount-details').style.display = enabled ? 'block' : 'none';
            document.getElementById('memory-mount-chats').style.display = enabled ? 'block' : 'none';
            
            // Êõ¥Êñ∞‰∏ªËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫
            document.getElementById('current-memory-mount').textContent = enabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
        }
        
        // Ê∏≤ÊüìËÆ∞ÂøÜÊåÇËΩΩËÅäÂ§©ÂàóË°®
        function renderMemoryMountChatList() {
            const container = document.getElementById('memory-mount-list');
            container.innerHTML = '';
            
            if (characters.length === 0 && groupChats.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">ÊöÇÊó†ÂèØÊåÇËΩΩÁöÑËÅäÂ§©</p>';
                return;
            }
            
            // Ê∑ªÂä†Âçï‰∫∫ËÅäÂ§©
            characters.forEach(character => {
                if (currentChatCharacter && character.id === currentChatCharacter.id) return; // ‰∏çÊòæÁ§∫ÂΩìÂâçËÅäÂ§©
                
                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${character.id}" value="${character.id}" class="mount-checkbox">
                    <div class="mount-avatar-small" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''} display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div>
                        <div class="mount-name">${character.name}</div>
                        <div class="mount-type">ÂçïËÅä</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // Ê∑ªÂä†Áæ§ËÅä
            groupChats.forEach(group => {
                if (currentChatCharacter && group.id === currentChatCharacter.id) return; // ‰∏çÊòæÁ§∫ÂΩìÂâçËÅäÂ§©
                
                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${group.id}" value="${group.id}" class="mount-checkbox">
                    <div class="mount-avatar-group">
                        Áæ§
                    </div>
                    <div>
                        <div class="mount-name">${group.name}</div>
                                                    <div class="mount-type">Áæ§ËÅä (${group.members ? group.members.length + 1 : 1}‰∫∫)</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // Âä†ËΩΩÂ∑≤ÈÄâÊã©ÁöÑËÅäÂ§©
            const chatSettings = getCurrentChatSettings();
            const selectedChats = chatSettings.selectedMemoryChats || [];
            selectedChats.forEach(chatId => {
                const checkbox = document.getElementById(`mount-${chatId}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        // ‰øùÂ≠òËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ
        async function saveMemoryMountSettings() {
            const chatSettings = getCurrentChatSettings();
            chatSettings.memoryMountEnabled = document.getElementById('memory-mount-enabled').checked;
            chatSettings.memoryMountCount = parseInt(document.getElementById('memory-mount-count').value);
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÅäÂ§©
            const checkboxes = document.querySelectorAll('#memory-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedMemoryChats = Array.from(checkboxes).map(cb => cb.value);
            
            // Êõ¥Êñ∞‰∏ªËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫
            document.getElementById('current-memory-mount').textContent = chatSettings.memoryMountEnabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('memory-mount-modal');
            showToast('ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ‰øùÂ≠òËÅäÂ§©Â§¥ÂÉèËÆæÁΩÆ
        async function saveChatAvatarSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÈöêËóèÂ§¥ÂÉèËÆæÁΩÆ
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                chatSettings.hideAvatars = hideAvatarsCheckbox.checked;
            }
            
            // üî•„ÄêÂéãÁº©Â§¥ÂÉè„ÄëÂú®‰øùÂ≠òÂâçÂéãÁº©Â§¥ÂÉèÊï∞ÊçÆ
            if (window.selectedMyChatAvatar) {
                chatSettings.myChatAvatar = await compressImage(window.selectedMyChatAvatar, 200, 0.7);
            }
            if (window.selectedAiChatAvatar) {
                chatSettings.aiChatAvatar = await compressImage(window.selectedAiChatAvatar, 200, 0.7);
            }
            
            try {
                await saveCurrentChatSettings(chatSettings);
                hideModal('avatar-settings-modal');
                
                // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰ª•ÊòæÁ§∫Êñ∞Â§¥ÂÉè
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                showToast('Â§¥ÂÉèËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
            } catch (error) {
                console.error('‰øùÂ≠òÂ§¥ÂÉèËÆæÁΩÆÂ§±Ë¥•:', error);
                showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåÂ≠òÂÇ®Á©∫Èó¥ÂèØËÉΩ‰∏çË∂≥', 'error');
            }
        }
        
        // ‰øùÂ≠òÊòµÁß∞ËÆæÁΩÆ
        async function saveChatNicknameSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.myChatNickname = document.getElementById('my-chat-nickname').value.trim();
            chatSettings.aiChatNickname = document.getElementById('ai-chat-nickname').value.trim();
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('nickname-settings-modal');
            
            // Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢Ê†áÈ¢ò
            if (currentChatCharacter) {
                const displayTitle = chatSettings.aiChatNickname || currentChatCharacter.name;
                document.getElementById('api-chat-title').textContent = displayTitle;
            }
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            // üî•„Äê‰øÆÂ§ç„ÄëÂà∑Êñ∞Ê∂àÊÅØÂàóË°®ÂíåËÅîÁ≥ª‰∫∫ÂàóË°®‰ª•ÊòæÁ§∫Êñ∞ÊòµÁß∞
            renderMessageList();
            renderContactList();
            
            showToast('ÊòµÁß∞ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ‰øùÂ≠òÊà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ
        async function savePokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.myPokeSuffix = document.getElementById('my-poke-suffix').value.trim();
            chatSettings.aiPokeSuffix = document.getElementById('ai-poke-suffix').value.trim();
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('poke-suffix-modal');
            showToast('Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ‰øùÂ≠òËÅäÂ§©ËÉåÊôØËÆæÁΩÆ
        async function saveChatBackgroundSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Â§ÑÁêÜËÉåÊôØËÆæÁΩÆÔºåÂåÖÊã¨ÁßªÈô§ËÉåÊôØÁöÑÊÉÖÂÜµ
            if (window.selectedChatBackground === null) {
                // Áî®Êà∑ÈÄâÊã©ÁßªÈô§ËÉåÊôØ
                chatSettings.chatBackground = null;
            } else if (window.selectedChatBackground) {
                // Áî®Êà∑ÈÄâÊã©‰∫ÜÊñ∞ËÉåÊôØ - ÂéãÁº©ËÉåÊôØÂõæÁâá
                chatSettings.chatBackground = await compressImage(window.selectedChatBackground, 800, 0.8);
            }
            // Â¶ÇÊûú window.selectedChatBackground ÊòØ undefinedÔºåÂàô‰øùÊåÅÂéüÊúâËÆæÁΩÆ‰∏çÂèò
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('background-settings-modal');
            
            // Â∫îÁî®Âà∞ËÅäÂ§©ÁïåÈù¢
            applyChatBackground();
            
            showToast('ËÅäÂ§©ËÉåÊôØËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ÁßªÈô§ËÉåÊôØ
        function removeBackground() {
            const backgroundPreview = document.getElementById('chat-background-preview');
            backgroundPreview.style.backgroundImage = 'none';
            backgroundPreview.querySelector('.preview-text').style.display = 'block';
            backgroundPreview.querySelector('.preview-text').textContent = 'Â∑≤ÁßªÈô§ËÉåÊôØ';
            window.selectedChatBackground = null;
        }

        // Êõ¥Êñ∞Ê∞îÊ≥°Â§ßÂ∞èÊòæÁ§∫ÂÄº
        function updatePaddingValue(value) {
            const paddingValue = document.getElementById('bubble-padding-value');
            if (paddingValue) {
                if (value <= 6) {
                    paddingValue.textContent = 'Ë∂ÖÁ¥ßÂáë';
                } else if (value <= 10) {
                    paddingValue.textContent = 'Á¥ßÂáë';
                } else if (value <= 14) {
                    paddingValue.textContent = '‰∏≠Á≠â';
                } else {
                    paddingValue.textContent = 'ÂÆΩÊùæ';
                }
            }
        }

        // ‰øùÂ≠òÊ∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ
        async function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÊ†∑ÂºèÈÄâÊã©
            if (window.selectedBubbleStyle) {
                chatSettings.bubbleStyle = window.selectedBubbleStyle;
            }
            
            // ‰øùÂ≠òÈ¢úËâ≤ËÆæÁΩÆ
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;
            
            // ‰øùÂ≠òÂàÜÁ¶ªÁöÑÈÄèÊòéÂ∫¶ËÆæÁΩÆ
            chatSettings.myBubbleOpacity = document.getElementById('my-bubble-opacity').value;
            chatSettings.aiBubbleOpacity = document.getElementById('ai-bubble-opacity').value;
            
            // ‰øùÂ≠òÊ∞îÊ≥°Â§ßÂ∞èËÆæÁΩÆ
            chatSettings.bubblePadding = document.getElementById('bubble-padding').value;
            
            await saveCurrentChatSettings(chatSettings);
            
            // üî•„Äê‰øÆÂ§ç„ÄëÁ´ãÂç≥Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑ÂºèÊòæÁ§∫
            updateBubbleStyleDisplay();
            
            hideModal('bubble-style-modal');
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰ª•Â∫îÁî®Êñ∞ËÆæÁΩÆ
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            showToast('Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }

        // ÊòæÁ§∫Êó∂Èó¥Êà≥ËÆæÁΩÆ
        function showTimestampSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ËÆæÁΩÆÊó∂Èó¥Êà≥ÂºÄÂÖ≥Áä∂ÊÄÅ
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                timestampEnabled.checked = chatSettings.timestampEnabled !== false; // ÈªòËÆ§‰∏∫true
            }
            
            // ËÆæÁΩÆÊó∂Èó¥Êà≥‰ΩçÁΩÆÈÄâÈ°π
            const timestampPosition = chatSettings.timestampPosition || 'center';
            const positionRadios = document.querySelectorAll('input[name="timestamp-position"]');
            positionRadios.forEach(radio => {
                radio.checked = radio.value === timestampPosition;
            });
            
            // ÁªëÂÆöÊó∂Èó¥Êà≥ÂºÄÂÖ≥ÂèòÂåñ‰∫ã‰ª∂
            if (timestampEnabled) {
                timestampEnabled.onchange = function() {
                    const optionsGroup = document.getElementById('timestamp-options-group');
                    if (optionsGroup) {
                        optionsGroup.style.display = this.checked ? 'block' : 'none';
                    }
                };
                
                // Ëß¶Âèë‰∏ÄÊ¨°ÊòæÁ§∫Áä∂ÊÄÅÊõ¥Êñ∞
                const optionsGroup = document.getElementById('timestamp-options-group');
                if (optionsGroup) {
                    optionsGroup.style.display = timestampEnabled.checked ? 'block' : 'none';
                }
            }
            
            showModal('timestamp-settings-modal');
        }

        // ‰øùÂ≠òÊó∂Èó¥Êà≥ËÆæÁΩÆ
        async function saveTimestampSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Ëé∑ÂèñÊó∂Èó¥Êà≥ÂºÄÂÖ≥Áä∂ÊÄÅ
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                chatSettings.timestampEnabled = timestampEnabled.checked;
            }
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊó∂Èó¥Êà≥‰ΩçÁΩÆ
            const selectedPosition = document.querySelector('input[name="timestamp-position"]:checked');
            if (selectedPosition) {
                chatSettings.timestampPosition = selectedPosition.value;
            }
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('timestamp-settings-modal');
            
            // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ‰ª•Â∫îÁî®Êñ∞ÁöÑÊó∂Èó¥Êà≥ËÆæÁΩÆ
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            showToast('Êó∂Èó¥Êà≥ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // Â§¥ÂÉè‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function avatarUploadHandler(e) {
            console.log('avatar-upload change‰∫ã‰ª∂Ë¢´Ëß¶Âèë');
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                
                console.log('ÈÄâÊã©‰∫ÜÊñá‰ª∂:', file.name, 'Â§ßÂ∞è:', file.size, 'bytes', 'Á±ªÂûã:', file.type);
                
                // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    e.target.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                    return;
                }
                
                // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂‰∏∫5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                    e.target.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('avatar-preview');
                        const avatarPreviewText = document.getElementById('avatar-preview-text');
                        
                        console.log('Êñá‰ª∂ËØªÂèñÊàêÂäüÔºåÂºÄÂßãËÆæÁΩÆÈ¢ÑËßà');
                        
                        if (!avatarPreview) {
                            console.error('Êâæ‰∏çÂà∞avatar-previewÂÖÉÁ¥†');
                            alert('Êâæ‰∏çÂà∞Â§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†');
                            return;
                        }
                        
                        // Ê∑ªÂä†has-imageÁ±ªÊù•Ë¶ÜÁõñÈªòËÆ§ËÉåÊôØ
                        avatarPreview.classList.add('has-image');
                        
                        // Âº∫Âà∂ËÆæÁΩÆËÉåÊôØÂõæÁâáÂπ∂Ê∏ÖÈô§ÊâÄÊúâÂÖ∂‰ªñËÉåÊôØÊ†∑Âºè
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        
                        // ÈöêËóèÊñáÂ≠ó
                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }
                        
                        // Â≠òÂÇ®ÂõæÁâáÊï∞ÊçÆÁî®‰∫éÂêéÁª≠‰øùÂ≠ò
                        window.selectedAvatarData = event.target.result;
                        
                        // È™åËØÅÊ†∑ÂºèÊòØÂê¶Ê≠£Á°ÆËÆæÁΩÆ
                        console.log('Â§¥ÂÉèÈ¢ÑËßàUIÊõ¥Êñ∞ÂÆåÊàêÔºåËÉåÊôØÂõæÁâáÂ∑≤ËÆæÁΩÆ');
                        console.log('ÂΩìÂâçavatar-previewÁöÑÊ†∑Âºè:', {
                            background: avatarPreview.style.background,
                            backgroundSize: avatarPreview.style.backgroundSize,
                            backgroundPosition: avatarPreview.style.backgroundPosition,
                            className: avatarPreview.className
                        });
                        
                        console.log('Â§¥ÂÉèÈ¢ÑËßàËÆæÁΩÆÊàêÂäüÔºåÂõæÁâáÊï∞ÊçÆÂ∑≤Â≠òÂÇ®');
                    } catch (error) {
                        console.error('ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÊó∂ÂèëÁîüÈîôËØØ:', error);
                        alert('ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÂ§±Ë¥•ÔºåËØ∑ÈáçËØï: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    console.error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
                    alert('ÂõæÁâáËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    e.target.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                };
                
                reader.readAsDataURL(file);
            } else {
                console.log('Ê≤°ÊúâÈÄâÊã©Êñá‰ª∂Êàñfiles‰∏∫Á©∫');
            }
        }
        
        // Âä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadCustomEmojis() {
            try {
                const savedCustomEmojis = await db.customEmojis.toArray();
                
                if (savedCustomEmojis.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('customEmojis');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑËá™ÂÆö‰πâË°®ÊÉÖÂåÖÊï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localEmojis = JSON.parse(localStorageData);
                        
                        if (localEmojis.length > 0) {
                            await db.customEmojis.bulkAdd(localEmojis);
                        }
                        
                        customEmojis = localEmojis;
                        console.log('Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖËøÅÁßªÂÆåÊàê:', customEmojis);
                    } else {
                        customEmojis = [];
                    }
                } else {
                    customEmojis = savedCustomEmojis;
                    console.log('‰ªéIndexedDBÂä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖ:', customEmojis);
                }
                
                // üîß„Äê‰øÆÂ§ç„ÄërecentEmojis‰πü‰ªéIndexedDBÂä†ËΩΩÔºåÂΩªÂ∫ïËß£ÂÜ≥localStorageÈóÆÈ¢ò
                const savedRecentEmojis = await db.recentEmojis.orderBy('lastUsed').reverse().toArray();
                if (savedRecentEmojis.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localRecentEmojis = localStorage.getItem('recentEmojis');
                    if (localRecentEmojis) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑrecentEmojisÊï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localRecents = JSON.parse(localRecentEmojis);
                        
                        if (localRecents.length > 0) {
                            // ÈôêÂà∂‰∏∫10‰∏™
                            const limitedRecents = localRecents.slice(0, 10);
                            const recentEmojisWithId = limitedRecents.map((emoji, index) => ({
                                id: index + 1,
                                url: emoji.url,
                                description: emoji.description || 'Ë°®ÊÉÖÂåÖ',
                                lastUsed: Date.now() - index * 1000
                            }));
                            await db.recentEmojis.bulkAdd(recentEmojisWithId);
                            recentEmojis = limitedRecents;
                            
                            // Ê∏ÖÁêÜlocalStorage
                            localStorage.removeItem('recentEmojis');
                            console.log('recentEmojisËøÅÁßªÂÆåÊàêÂπ∂Ê∏ÖÁêÜlocalStorage');
                        } else {
                            recentEmojis = [];
                        }
                    } else {
                        recentEmojis = [];
                    }
                } else {
                    // ‰ªéIndexedDBËΩ¨Êç¢ÂõûÂéüÊ†ºÂºè
                    recentEmojis = savedRecentEmojis.map(item => ({
                        url: item.url,
                        description: item.description
                    }));
                    console.log('‰ªéIndexedDBÂä†ËΩΩrecentEmojis:', recentEmojis);
                }
            } catch (error) {
                console.error('Âä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªélocalStorageÂä†ËΩΩ
                const localStorageData = localStorage.getItem('customEmojis');
                if (localStorageData) {
                    customEmojis = JSON.parse(localStorageData);
                    console.log('‰ªélocalStorageÂ§á‰ªΩÂä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖ:', customEmojis);
                } else {
                    customEmojis = [];
                }
                
                // Â∞ùËØï‰ªéIndexedDBÂä†ËΩΩrecentEmojis
                try {
                    const savedRecentEmojis = await db.recentEmojis.orderBy('lastUsed').reverse().toArray();
                    if (savedRecentEmojis.length > 0) {
                        recentEmojis = savedRecentEmojis.map(item => ({
                            url: item.url,
                            description: item.description
                        }));
                    } else {
                        recentEmojis = [];
                    }
                } catch (dbError) {
                    // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªélocalStorageÂä†ËΩΩ
                    const localRecentEmojis = localStorage.getItem('recentEmojis');
                    if (localRecentEmojis) {
                        recentEmojis = JSON.parse(localRecentEmojis);
                    } else {
                        recentEmojis = [];
                    }
                }
            }
        }
        
        // ‰øùÂ≠òËá™ÂÆö‰πâË°®ÊÉÖÂåÖ - ‰ΩøÁî®IndexedDB
        async function saveCustomEmojis() {
            try {
                await db.customEmojis.clear();
                if (customEmojis.length > 0) {
                    await db.customEmojis.bulkAdd(customEmojis);
                }
                
                // üîß„Äê‰øÆÂ§ç„ÄëÂ∞ÜrecentEmojis‰πüËøÅÁßªÂà∞IndexedDBÔºåÂΩªÂ∫ïËß£ÂÜ≥localStorageÈóÆÈ¢ò
                try {
                    // ÈôêÂà∂ÊúÄËøë‰ΩøÁî®Ë°®ÊÉÖÂåÖÊï∞Èáè‰∏∫10‰∏™
                    const maxRecentEmojis = 10;
                    if (recentEmojis.length > maxRecentEmojis) {
                        recentEmojis = recentEmojis.slice(0, maxRecentEmojis);
                    }
                    
                    // Â∞ÜrecentEmojis‰πü‰øùÂ≠òÂà∞IndexedDB
                    await db.recentEmojis.clear();
                    if (recentEmojis.length > 0) {
                        const recentEmojisWithId = recentEmojis.map((emoji, index) => ({
                            id: index + 1,
                            url: emoji.url,
                            description: emoji.description || 'Ë°®ÊÉÖÂåÖ',
                            lastUsed: Date.now() - index * 1000 // Á°Æ‰øùÈ°∫Â∫è
                        }));
                        await db.recentEmojis.bulkAdd(recentEmojisWithId);
                    }
                    
                    // Ê∏ÖÁêÜlocalStorage‰∏≠ÁöÑÊóßÊï∞ÊçÆÔºà‰∏ÄÊ¨°ÊÄßËøÅÁßªÔºâ
                    if (localStorage.getItem('recentEmojis')) {
                        localStorage.removeItem('recentEmojis');
                        console.log('Â∑≤Â∞ÜrecentEmojisËøÅÁßªÂà∞IndexedDBÂπ∂Ê∏ÖÁêÜlocalStorage');
                    }
                } catch (dbError) {
                    console.error('IndexedDBÂ≠òÂÇ®Â§±Ë¥•:', dbError);
                    showToast('‚ùå Ë°®ÊÉÖÂåÖÊï∞ÊçÆÂ≠òÂÇ®Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('‰øùÂ≠òËá™ÂÆö‰πâË°®ÊÉÖÂåÖÂ§±Ë¥•:', error);
                showToast('‚ùå Ë°®ÊÉÖÂåÖ‰øùÂ≠òÂ§±Ë¥•', 'error');
            }
        }
        
        // ÊòæÁ§∫Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÈù¢Êùø
        function showCustomEmojiPanel() {
            const panel = document.getElementById('custom-emoji-panel');
            const isVisible = panel.style.display === 'block';
            
            if (isVisible) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            } else {
                panel.style.display = 'block';
                renderEmojiGrid();
                
                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Èù¢Êùø
                setTimeout(() => {
                    document.addEventListener('click', hideCustomEmojiPanel);
                }, 100);
            }
        }
        
        // ÈöêËóèËá™ÂÆö‰πâË°®ÊÉÖÂåÖÈù¢Êùø
        function hideCustomEmojiPanel(e) {
            const panel = document.getElementById('custom-emoji-panel');
            
            // Â¶ÇÊûúÊ≤°Êúâ‰º†ÈÄí‰∫ã‰ª∂ÂèÇÊï∞ÔºåÁõ¥Êé•ÈöêËóèÈù¢Êùø
            if (!e) {
                if (panel) {
                    panel.style.display = 'none';
                    document.removeEventListener('click', hideCustomEmojiPanel);
                }
                return;
            }
            
            const emojiBtn = e.target.closest('.chat-action-btn');
            
            if (panel && !panel.contains(e.target) && !emojiBtn) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            }
        }
        
        // Ê∏≤ÊüìË°®ÊÉÖÂåÖÁΩëÊ†º
        function renderEmojiGrid() {
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = '';
            
            let emojisToShow = [];
            
            if (currentEmojiTab === 'recent') {
                emojisToShow = recentEmojis;
            } else if (currentEmojiTab === 'custom') {
                emojisToShow = customEmojis;
            }
            
            // Ê∑ªÂä†Ë°®ÊÉÖÂåÖ
            emojisToShow.forEach((emoji, index) => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'custom-emoji-item';
                emojiItem.style.backgroundImage = emoji.url && emoji.url !== 'undefined' ? `url(${emoji.url})` : 'none';
                emojiItem.onclick = () => sendEmojiMessage(emoji);
                
                // ‰∏∫Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÂíåÊúÄËøë‰ΩøÁî®Ë°®ÊÉÖÂåÖÊ∑ªÂä†Âà†Èô§ÊåâÈíÆ
                if (currentEmojiTab === 'custom' || currentEmojiTab === 'recent') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'emoji-delete-btn';
                    deleteBtn.innerHTML = '√ó';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (currentEmojiTab === 'custom') {
                        deleteCustomEmoji(index);
                        } else if (currentEmojiTab === 'recent') {
                            deleteRecentEmoji(index);
                        }
                    };
                    emojiItem.appendChild(deleteBtn);
                }
                
                grid.appendChild(emojiItem);
            });
            
            // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÊ†áÁ≠æÈ°µÔºåÊ∑ªÂä†‰∏ä‰º†ÊåâÈíÆ
            if (currentEmojiTab === 'custom') {
                const uploadItem = document.createElement('div');
                uploadItem.className = 'custom-emoji-item placeholder';
                uploadItem.innerHTML = '+';
                uploadItem.onclick = () => document.getElementById('emoji-upload').click();
                grid.appendChild(uploadItem);
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâË°®ÊÉÖÂåÖÔºåÊòæÁ§∫ÊèêÁ§∫
            if (emojisToShow.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-emoji-grid';
                
                                                if (currentEmojiTab === 'recent') {
                                    emptyMsg.textContent = 'ËøòÊ≤°Êúâ‰ΩøÁî®ËøáË°®ÊÉÖÂåÖ';
                                } else {
                                    emptyMsg.textContent = 'ËøòÊ≤°ÊúâË°®ÊÉÖÂåÖÔºåÁÇπÂáª+Âè∑Ê∑ªÂä†';
                                }
                
                grid.appendChild(emptyMsg);
            }
        }
        
        // ÂèëÈÄÅË°®ÊÉÖÂåÖÊ∂àÊÅØ
        function sendEmojiMessage(emoji) {
            console.log('üé≠ ÂèëÈÄÅË°®ÊÉÖÂåÖ:', emoji);
            
            if (!currentChatCharacter) return;
            
            // Ê∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®
            addToRecentEmojis(emoji);
            
            // üî•„Äê‰øÆÂ§ç„ÄëË°®ÊÉÖÂåÖÊ∂àÊÅØÂè™ÊòæÁ§∫ÂõæÁâáÔºå‰∏çÊòæÁ§∫ÊñáÂ≠óÂÜÖÂÆπ
            const messageId = Date.now().toString();
            const emojiMessage = {
                id: messageId,
                sender: 'sent',
                content: '', // Ë°®ÊÉÖÂåÖÊ∂àÊÅØ‰∏çÊòæÁ§∫ÊñáÂ≠óÂÜÖÂÆπ
                image: emoji.url,
                isEmoji: true,
                emojiDescription: emoji.description || 'Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖ',
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(emojiMessage);
            saveChatMessages();
            
            // Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages(currentChatCharacter.id);
            
            // ÈöêËóèË°®ÊÉÖÂåÖÈù¢Êùø
            hideCustomEmojiPanel();
            
            // ËÆæÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØÔºåÊîØÊåÅÊô∫ËÉΩÂõûÂ§çÊåâÈíÆ
            pendingUserMessage = emojiMessage;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
            
            // Ê≥®ÈáäÊéâËá™Âä®ÂõûÂ§çÔºåÊîπ‰∏∫ÊâãÂä®ÂõûÂ§çÊ®°Âºè
            // setTimeout(() => {
            //     sendAIEmojiResponse(emoji);
            // }, 1000 + Math.random() * 2000);
        }
        
        // Ê∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®ÁöÑË°®ÊÉÖÂåÖ
        async function addToRecentEmojis(emoji) {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÁõ∏ÂêåË°®ÊÉÖÂåÖ
            recentEmojis = recentEmojis.filter(e => e.url !== emoji.url);
            
            // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
            recentEmojis.unshift(emoji);
            
            // ÈôêÂà∂ÊúÄËøë‰ΩøÁî®Êï∞Èáè‰∏∫20‰∏™
            if (recentEmojis.length > 20) {
                recentEmojis = recentEmojis.slice(0, 20);
            }
            
            await saveCustomEmojis();
        }
        
        // Ê£ÄÊµãÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÊîØÊåÅËßÜËßâÂäüËÉΩ
        function isVisionModelSupported() {
            // ÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÂàóË°®
            const visionModels = [
                // OpenAI GPTÁ≥ªÂàó
                'gpt-4-vision',
                'gpt-4o',
                'gpt-4-turbo',
                'gpt-4o-mini',
                
                // Google GeminiÁ≥ªÂàó
                'gemini-1.5-pro',
                'gemini-1.5-flash',
                'gemini-2.0-flash',
                'gemini-2.5-pro',
                'gemini-2.5-flash',
                'gemini-exp',
                'gemini-pro-vision',
                
                // Anthropic ClaudeÁ≥ªÂàó
                'claude-3-opus',
                'claude-3-sonnet',
                'claude-3-haiku',
                'claude-3.5-sonnet',
                'claude-3.5-haiku',
                
                // ÂõΩ‰∫ßÊ®°Âûã
                'qwen-vl',
                'qwen2-vl',
                'yi-vision',
                'glm-4v',
                'internvl',
                'cogvlm',
                
                // ÂÖ∂‰ªñÊ®°Âûã
                'llava',
                'moondream',
                'phi-3-vision'
            ];
            
            const currentModel = apiSettings.model?.toLowerCase() || '';
            
            // Ê£ÄÊü•ÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÂåÖÂê´‰ªª‰ΩïÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÂêçÁß∞
            const isVisionSupported = visionModels.some(model => currentModel.includes(model.toLowerCase()));
            
            // ËæìÂá∫Ë∞ÉËØï‰ø°ÊÅØ
            console.log('ÂΩìÂâçÊ®°Âûã:', currentModel);
            console.log('ÊòØÂê¶ÊîØÊåÅËßÜËßâ:', isVisionSupported);
            
            return isVisionSupported;
        }
        
        // Ê≥®ÈáäÔºöAIÂØπË°®ÊÉÖÂåÖÁöÑËá™Âä®ÂõûÂ§çÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®ÊâãÂä®ÂõûÂ§çÊ®°Âºè
        // Ë°®ÊÉÖÂåÖÂíåÂõæÁâáÈÉΩÈÄöËøáÊô∫ËÉΩÂõûÂ§çÊåâÈíÆÊù•Ëß¶ÂèëAIÂõûÂ§ç
        
        // Âà†Èô§Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖ
        function deleteCustomEmoji(index) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü')) {
                customEmojis.splice(index, 1);
                saveCustomEmojis();
                renderEmojiGrid();
            }
        }
        
        // Âà†Èô§ÊúÄËøë‰ΩøÁî®ÁöÑË°®ÊÉÖÂåÖ
        function deleteRecentEmoji(index) {
            if (confirm('Á°ÆÂÆöË¶Å‰ªéÊúÄËøë‰ΩøÁî®‰∏≠Âà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü')) {
                recentEmojis.splice(index, 1);
                saveCustomEmojis(); // üîß„Äê‰øÆÂ§ç„ÄëÁé∞Âú®‰ΩøÁî®IndexedDB‰øùÂ≠ò
                renderEmojiGrid();
            }
        }
        
        // ÂàùÂßãÂåñË°®ÊÉÖÂåÖ‰∏ä‰º†ÂäüËÉΩ
        function initializeEmojiUpload() {
            const emojiInput = document.getElementById('emoji-upload');
            if (emojiInput) {
                emojiInput.addEventListener('change', handleEmojiUpload);
            }
            
            // ÁªëÂÆöÊ†áÁ≠æÈ°µÂàáÊç¢‰∫ã‰ª∂
            document.querySelectorAll('.emoji-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
                    document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
                    // Ê∑ªÂä†ÂΩìÂâçactiveÁ±ª
                    this.classList.add('active');
                    
                    // ÂàáÊç¢ÂΩìÂâçÊ†áÁ≠æÈ°µ
                    currentEmojiTab = this.dataset.tab;
                    renderEmojiGrid();
                });
            });
        }
        
        // Â§ÑÁêÜË°®ÊÉÖÂåÖ‰∏ä‰º†
        function handleEmojiUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    return;
                }
                
                // Ê£ÄÊü•GIFÊ†ºÂºèÔºåÊèêÈÜíÁî®Êà∑ÂèØËÉΩÁöÑÈóÆÈ¢ò
                if (file.type === 'image/gif') {
                    const confirmed = confirm('Ê£ÄÊµãÂà∞GIFÊ†ºÂºèÁöÑË°®ÊÉÖÂåÖÔºÅ\n\n‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°πÔºö\n‚Ä¢ AIÂèØ‰ª•ÂèëÈÄÅËøô‰∏™GIFÂä®Âõæ\n‚Ä¢ ‰ΩÜGemini APIÊó†Ê≥ïËØÜÂà´GIFÂÜÖÂÆπ\n‚Ä¢ ÈáçÊñ∞ÁîüÊàêÂäüËÉΩÂèØËÉΩÂ§±Êïà\n‚Ä¢ Âª∫ËÆÆ‰ΩøÁî®ÈùôÊÄÅÂõæÁâáÊ†ºÂºè\n\nÊòØÂê¶‰ªçË¶Å‰∏ä‰º†Ëøô‰∏™GIFË°®ÊÉÖÂåÖÔºü');
                    if (!confirmed) {
                        return;
                    }
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    // ÂºπÂá∫ÊèèËø∞ËæìÂÖ•Ê°Ü
                    const description = prompt('ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂåÖÊ∑ªÂä†ÊèèËø∞ÔºàÊé®ËçêÔºÅÂ∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÁêÜËß£Ë°®ÊÉÖÂåÖÂÜÖÂÆπÔºâ:\n\n‰æãÂ¶ÇÔºö\n‚Ä¢ "Á¨ëÂì≠ÁöÑË°®ÊÉÖ"\n‚Ä¢ "Êè°Êã≥Âä†Ê≤πÁöÑÂä®‰Ωú"\n‚Ä¢ "ÂÜôÁùÄOMGÁöÑË°®ÊÉÖÂåÖ"\n‚Ä¢ "ÊÑ§ÊÄíÁöÑÁå´Âí™ÂõæÁâá"', '');
                    
                    const emoji = {
                        id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                        url: event.target.result,
                        description: description || 'Ë°®ÊÉÖÂåÖ',
                        addedAt: new Date().toISOString()
                    };
                    
                    customEmojis.push(emoji);
                    saveCustomEmojis();
                    
                    // Â¶ÇÊûúÂΩìÂâçÂú®Ëá™ÂÆö‰πâÊ†áÁ≠æÈ°µÔºåÈáçÊñ∞Ê∏≤Êüì
                    if (currentEmojiTab === 'custom') {
                        renderEmojiGrid();
                    }
                };
                
                reader.readAsDataURL(file);
            });
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
            e.target.value = '';
        }
        
        // Âà§Êñ≠È¢úËâ≤ÊòØÂê¶‰∏∫ÊµÖËâ≤
        function isLightColor(color) {
            // Â∞ÜÈ¢úËâ≤ËΩ¨Êç¢‰∏∫RGBÂÄº
            let r, g, b;
            
            if (color.startsWith('#')) {
                // ÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤
                const hex = color.slice(1);
                if (hex.length === 3) {
                    r = parseInt(hex[0] + hex[0], 16);
                    g = parseInt(hex[1] + hex[1], 16);
                    b = parseInt(hex[2] + hex[2], 16);
                } else {
                    r = parseInt(hex.substr(0, 2), 16);
                    g = parseInt(hex.substr(2, 2), 16);
                    b = parseInt(hex.substr(4, 2), 16);
                }
            } else if (color.startsWith('rgb')) {
                // RGBÈ¢úËâ≤
                const matches = color.match(/\d+/g);
                if (matches && matches.length >= 3) {
                    r = parseInt(matches[0]);
                    g = parseInt(matches[1]);
                    b = parseInt(matches[2]);
                }
            } else {
                // ÈªòËÆ§‰∏∫Ê∑±Ëâ≤
                return false;
            }
            
            // ËÆ°ÁÆó‰∫ÆÂ∫¶
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128;
        }
        
        // Êõ¥Êñ∞Ê∞îÊ≥°È¢ÑËßà
        function updateBubblePreview() {
            const myColor = document.getElementById('my-bubble-color')?.value || '#007AFF';
            const aiColor = document.getElementById('ai-bubble-color')?.value || '#f0f0f0';
            const myOpacity = document.getElementById('my-bubble-opacity')?.value || '1';
            const aiOpacity = document.getElementById('ai-bubble-opacity')?.value || '1';
            
            // Êõ¥Êñ∞È¢ÑËßàÊ∞îÊ≥°
            const demoMyBubble = document.getElementById('demo-my-bubble');
            const demoAiBubble = document.getElementById('demo-ai-bubble');
            
            if (demoMyBubble) {
                // ‰ΩøÁî®rgbaËÉåÊôØËâ≤ËÄå‰∏çÊòØopacity
                const transparentMyColor = convertColorWithOpacity(myColor, myOpacity);
                demoMyBubble.style.backgroundColor = transparentMyColor;
                demoMyBubble.style.color = isLightColor(myColor) ? '#333' : '#fff';
            }
            
            if (demoAiBubble) {
                // ‰ΩøÁî®rgbaËÉåÊôØËâ≤ËÄå‰∏çÊòØopacity
                const transparentAiColor = convertColorWithOpacity(aiColor, aiOpacity);
                demoAiBubble.style.backgroundColor = transparentAiColor;
                demoAiBubble.style.color = isLightColor(aiColor) ? '#333' : '#fff';
            }
            
            // Êõ¥Êñ∞È¢úËâ≤È¢ÑËßà
            const myPreview = document.getElementById('my-bubble-preview');
            const aiPreview = document.getElementById('ai-bubble-preview');
            
            if (myPreview) {
                // ‰ΩøÁî®rgbaËÉåÊôØËâ≤ËÄå‰∏çÊòØopacity
                const transparentMyColor = convertColorWithOpacity(myColor, myOpacity);
                myPreview.style.backgroundColor = transparentMyColor;
                myPreview.textContent = 'ÊàëÁöÑÊ∞îÊ≥°';
            }
            
            if (aiPreview) {
                // ‰ΩøÁî®rgbaËÉåÊôØËâ≤ËÄå‰∏çÊòØopacity
                const transparentAiColor = convertColorWithOpacity(aiColor, aiOpacity);
                aiPreview.style.backgroundColor = transparentAiColor;
                aiPreview.textContent = 'ÂØπÊñπÊ∞îÊ≥°';
            }
        }
        
        // ÁªëÂÆöÂ§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂
        function bindAvatarUploadEvents() {
            // ÊàëÁöÑÂ§¥ÂÉè‰∏ä‰º†
            const myAvatarUpload = document.getElementById('my-chat-avatar-upload');
            if (myAvatarUpload) {
                myAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('my-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedMyChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }
            
            // AIÂ§¥ÂÉè‰∏ä‰º†
            const aiAvatarUpload = document.getElementById('ai-chat-avatar-upload');
            if (aiAvatarUpload) {
                aiAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('ai-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedAiChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }
        }
        
        // ÂàùÂßãÂåñÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
        function initializeAvatarUpload() {
            const avatarInput = document.getElementById('avatar-upload');
            if (!avatarInput) {
                console.error('Êâæ‰∏çÂà∞avatar-uploadÂÖÉÁ¥†');
                return;
            }
            
            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.removeEventListener('change', avatarUploadHandler);
            
            // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.addEventListener('change', avatarUploadHandler);
            console.log('Â§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö');
        }
        
        // Êõ¥Êñ∞ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢ÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        function updateChatSettingsDisplay() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            
            // Êõ¥Êñ∞ÂéÜÂè≤Ê∂àÊÅØÊï∞ÊòæÁ§∫
            const historyCountElement = document.getElementById('current-history-count');
            if (historyCountElement) {
                historyCountElement.textContent = chatSettings.historyCount + 'ÂõûÂêà';
            }
            
            // Êõ¥Êñ∞ËÆ∞ÂøÜÊåÇËΩΩÊòæÁ§∫
            const memoryMountElement = document.getElementById('current-memory-mount');
            if (memoryMountElement) {
                memoryMountElement.textContent = chatSettings.memoryMountEnabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
            }
            
            // Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫
            updateWorldbookMountDisplay();
            
            // Êõ¥Êñ∞Êó∂Èó¥ÊÑüÁü•ÂºÄÂÖ≥
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.checked = chatSettings.timeAwarenessEnabled;
            }
            
            // Êõ¥Êñ∞ÈÄöËØùËÆæÁΩÆ
            const aiCallCheckbox = document.getElementById('ai-call-enabled');
            if (aiCallCheckbox) {
                aiCallCheckbox.checked = chatSettings.aiCallEnabled;
            }
            
            // Êõ¥Êñ∞ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.checked = chatSettings.aiHeartrateEnabled;
            }
            

            
            // Êõ¥Êñ∞ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.checked = chatSettings.backgroundInteractionEnabled;
                // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
                const backgroundSettings = document.getElementById('background-interaction-settings');
                if (backgroundSettings) {
                    backgroundSettings.style.display = chatSettings.backgroundInteractionEnabled ? 'block' : 'none';
                }
            }
            
            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.value = chatSettings.backgroundChatFrequency || 'low';
            }
            
            const backgroundChatEnabledCheckbox = document.getElementById('background-chat-enabled');
            if (backgroundChatEnabledCheckbox) {
                backgroundChatEnabledCheckbox.checked = chatSettings.backgroundChatEnabled !== false;
                // ÊéßÂà∂È¢ëÁéáËÆæÁΩÆÊòæÁ§∫
                const chatFrequencySetting = document.getElementById('chat-frequency-setting');
                if (chatFrequencySetting) {
                    chatFrequencySetting.style.display = chatSettings.backgroundChatEnabled !== false ? 'block' : 'none';
                }
            }
            
            const backgroundMomentsEnabledCheckbox = document.getElementById('background-moments-enabled');
            if (backgroundMomentsEnabledCheckbox) {
                backgroundMomentsEnabledCheckbox.checked = chatSettings.backgroundMomentsEnabled !== false;
                // ÊéßÂà∂Áõ∏ÂÖ≥ËÆæÁΩÆÊòæÁ§∫
                const momentsEnabled = chatSettings.backgroundMomentsEnabled !== false;
                const momentsFrequencySetting = document.getElementById('moments-frequency-setting');
                const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                const testPublishSetting = document.getElementById('test-publish-setting');
                
                if (momentsFrequencySetting) {
                    momentsFrequencySetting.style.display = momentsEnabled ? 'flex' : 'none';
                }
                if (scheduledMomentsSetting) {
                    scheduledMomentsSetting.style.display = momentsEnabled ? 'flex' : 'none';
                }
                if (testPublishSetting) {
                    testPublishSetting.style.display = momentsEnabled ? 'flex' : 'none';
                }
            }
            
            const backgroundMomentsFrequencySelect = document.getElementById('background-moments-frequency');
            if (backgroundMomentsFrequencySelect) {
                backgroundMomentsFrequencySelect.value = chatSettings.backgroundMomentsFrequency || 'low';
            }
            
            const scheduledMomentsEnabledCheckbox = document.getElementById('scheduled-moments-enabled');
            if (scheduledMomentsEnabledCheckbox) {
                scheduledMomentsEnabledCheckbox.checked = chatSettings.scheduledMomentsEnabled || false;
                // ÊéßÂà∂Êó∂Èó¥ËÆæÁΩÆÊåâÈíÆÊòæÁ§∫
                const scheduledTimesButton = document.querySelector('button[onclick="showScheduleTimesModal()"]');
                if (scheduledTimesButton) {
                    scheduledTimesButton.style.display = chatSettings.scheduledMomentsEnabled ? 'inline-block' : 'none';
                }
            }
            
            // Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÊòæÁ§∫
            updateScheduleTimesDisplay();
            
            // Êõ¥Êñ∞Êó∂Èó¥Êà≥ËÆæÁΩÆ
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                timestampCheckbox.checked = chatSettings.timestampEnabled;
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®Êù•‰øùÂ≠òËÆæÁΩÆÂèòÂåñ
            bindChatSettingsEvents();
        }
        
        // ÁªëÂÆöËÅäÂ§©ËÆæÁΩÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function bindChatSettingsEvents() {
            // Êó∂Èó¥ÊÑüÁü•ÂºÄÂÖ≥
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timeAwarenessEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                };
            }
            
            // ÈÄöËØùËÆæÁΩÆ
            const aiCallCheckbox = document.getElementById('ai-call-enabled');
            if (aiCallCheckbox) {
                aiCallCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiCallEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                };
            }
            
            // ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiHeartrateEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                };
            }
            

            
            // ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundInteractionEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    // ÊòæÁ§∫/ÈöêËóèËØ¶ÁªÜËÆæÁΩÆ
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }
                };
            }
            
            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundChatFrequency = this.value;
                    await saveCurrentChatSettings(chatSettings);
                };
            }
            
            const backgroundChatEnabledCheckbox = document.getElementById('background-chat-enabled');
            if (backgroundChatEnabledCheckbox) {
                backgroundChatEnabledCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundChatEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // ÊéßÂà∂È¢ëÁéáËÆæÁΩÆÊòæÁ§∫
                    const chatFrequencySetting = document.getElementById('chat-frequency-setting');
                    if (chatFrequencySetting) {
                        chatFrequencySetting.style.display = this.checked ? 'block' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    initBackgroundInteractionSystem();
                };
            }
            
            const backgroundMomentsEnabledCheckbox = document.getElementById('background-moments-enabled');
            if (backgroundMomentsEnabledCheckbox) {
                backgroundMomentsEnabledCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundMomentsEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // ÊéßÂà∂Áõ∏ÂÖ≥ËÆæÁΩÆÊòæÁ§∫
                    const momentsFrequencySetting = document.getElementById('moments-frequency-setting');
                    const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                    const testPublishSetting = document.getElementById('test-publish-setting');
                    
                    if (momentsFrequencySetting) {
                        momentsFrequencySetting.style.display = this.checked ? 'flex' : 'none';
                    }
                    if (scheduledMomentsSetting) {
                        scheduledMomentsSetting.style.display = this.checked ? 'flex' : 'none';
                    }
                    if (testPublishSetting) {
                        testPublishSetting.style.display = this.checked ? 'flex' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    initBackgroundInteractionSystem();
                };
            }
            
            const backgroundMomentsFrequencySelect = document.getElementById('background-moments-frequency');
            if (backgroundMomentsFrequencySelect) {
                backgroundMomentsFrequencySelect.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundMomentsFrequency = this.value;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    initBackgroundInteractionSystem();
                };
            }
            
            const scheduledMomentsEnabledCheckbox = document.getElementById('scheduled-moments-enabled');
            if (scheduledMomentsEnabledCheckbox) {
                scheduledMomentsEnabledCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.scheduledMomentsEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // ÊéßÂà∂Êó∂Èó¥ËÆæÁΩÆÊåâÈíÆÊòæÁ§∫
                    const scheduledTimesButton = document.querySelector('button[onclick="showScheduleTimesModal()"]');
                    if (scheduledTimesButton) {
                        scheduledTimesButton.style.display = this.checked ? 'inline-block' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂÆöÊó∂ÂèëÂ∏ÉÁ≥ªÁªü
                    initScheduledMomentsSystem();
                };
            }
            
            // Êó∂Èó¥Êà≥ËÆæÁΩÆ
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                timestampCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timestampEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }
                };
            }
        }

        // ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢
        function initializeChatSettings() {
            // Êõ¥Êñ∞Ë∫´‰ªΩÊòæÁ§∫
            updateChatIdentityDisplay();
            
            // Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑ÂºèÊòæÁ§∫
            updateBubbleStyleDisplay();
            
            // Êõ¥Êñ∞ÊâÄÊúâËÆæÁΩÆÊòæÁ§∫Áä∂ÊÄÅ
            updateChatSettingsDisplay();
            
            // Âä†ËΩΩÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆ
            if (currentChatCharacter) {
                const chatSettings = getCurrentChatSettings();
                
                // ËÆæÁΩÆËÅäÂ§©Ê®°Âºè
                const chatMode = chatSettings.chatMode || 'online';
                const onlineRadio = document.getElementById('chat-mode-online');
                const offlineRadio = document.getElementById('chat-mode-offline');
                
                if (onlineRadio && offlineRadio) {
                    if (chatMode === 'online') {
                        onlineRadio.checked = true;
                    } else {
                        offlineRadio.checked = true;
                    }
                    
                    // ÊòæÁ§∫/ÈöêËóèÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÊéßÂà∂
                    const offlineLengthControl = document.getElementById('offline-length-control');
                    if (offlineLengthControl) {
                        offlineLengthControl.style.display = chatMode === 'offline' ? 'flex' : 'none';
                    }
                    
                    // ËÆæÁΩÆÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂
                    const maxLengthInput = document.getElementById('offline-mode-max-length');
                    if (maxLengthInput) {
                        maxLengthInput.value = chatSettings.offlineModeMaxLength || 100;
                    }
                }
            }
            
            // ÁªëÂÆöËÅäÂ§©Ê®°ÂºèÂàáÊç¢‰∫ã‰ª∂
            const chatModeRadios = document.querySelectorAll('input[name="chat-mode"]');
            chatModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const offlineLengthControl = document.getElementById('offline-length-control');
                    if (offlineLengthControl) {
                        offlineLengthControl.style.display = this.value === 'offline' ? 'flex' : 'none';
                    }
                    
                    // ‰øùÂ≠òËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ
                    saveChatModeSettings();
                });
            });
            
            // ÁªëÂÆöÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂ÂèòÂåñ‰∫ã‰ª∂
            const maxLengthInput = document.getElementById('offline-mode-max-length');
            if (maxLengthInput) {
                maxLengthInput.addEventListener('change', saveChatModeSettings);
            }
            

            
            // ÁªëÂÆöÂêéÂè∞‰∫íÂä®ÂºÄÂÖ≥‰∫ã‰ª∂
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.addEventListener('change', function() {
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }
                    
                    // Â¶ÇÊûúÂÖ≥Èó≠ÂêéÂè∞‰∫íÂä®ÔºåÊ∏ÖÈô§ÊâÄÊúâÂÆöÊó∂Âô®
                    if (!this.checked) {
                        clearAllBackgroundTimers();
                    } else {
                        // Â¶ÇÊûúÂºÄÂêØÂêéÂè∞‰∫íÂä®ÔºåÈáçÊñ∞ÂàùÂßãÂåñÁ≥ªÁªü
                        initBackgroundInteractionSystem();
                    }
                });
            }
            
            // ÁªëÂÆö‰∏ªÂä®ËÅäÂ§©ÂºÄÂÖ≥‰∫ã‰ª∂
            const backgroundChatCheckbox = document.getElementById('background-chat-enabled');
            if (backgroundChatCheckbox) {
                backgroundChatCheckbox.addEventListener('change', function() {
                    const frequencySetting = document.getElementById('chat-frequency-setting');
                    if (frequencySetting) {
                        frequencySetting.style.display = this.checked ? 'block' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    if (currentChatCharacter) {
                        initBackgroundInteractionSystem();
                    }
                });
            }
            
            // ÁªëÂÆö‰∏ªÂä®ÂèëÂä®ÊÄÅÂºÄÂÖ≥‰∫ã‰ª∂
            const backgroundMomentsCheckbox = document.getElementById('background-moments-enabled');
            if (backgroundMomentsCheckbox) {
                backgroundMomentsCheckbox.addEventListener('change', function() {
                    const frequencySetting = document.getElementById('moments-frequency-setting');
                    if (frequencySetting) {
                        frequencySetting.style.display = this.checked ? 'flex' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    if (currentChatCharacter) {
                        initBackgroundInteractionSystem();
                    }
                });
            }
            
            // ÁªëÂÆöÊà≥‰∏ÄÊà≥ÂäüËÉΩÂºÄÂÖ≥‰∫ã‰ª∂
            const pokeEnabledCheckbox = document.getElementById('poke-enabled');
            if (pokeEnabledCheckbox) {
                pokeEnabledCheckbox.addEventListener('change', function() {
                    const pokeSuffixSettings = document.getElementById('poke-suffix-settings');
                    if (pokeSuffixSettings) {
                        pokeSuffixSettings.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // ÁªëÂÆöÈÄâÊã©Ê®°ÂºèÊåâÈíÆ‰∫ã‰ª∂
            const selectionCancelBtn = document.getElementById('selection-cancel-btn');
            const selectionDeleteBtn = document.getElementById('selection-delete-btn');
            
            if (selectionCancelBtn) {
                selectionCancelBtn.addEventListener('click', exitMessageSelectionMode);
            }
            
            if (selectionDeleteBtn) {
                selectionDeleteBtn.addEventListener('click', function() {
                    if (selectedMessages.size === 0) return;
                    
                    deleteSelectedMessages();
                });
            }
        }
        
        // Êà≥‰∏ÄÊà≥ÂäüËÉΩ
        function pokeCharacter(characterId) {
            if (!currentChatCharacter || currentChatCharacter.id !== characterId) {
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const pokeSuffix = chatSettings.myPokeSuffix || '';
            const characterName = chatSettings.aiChatNickname || currentChatCharacter.name;
            
            // ÂàõÂª∫Êà≥‰∏ÄÊà≥Á≥ªÁªüÊ∂àÊÅØ
            const pokeMessage = {
                id: Date.now().toString(),
                sender: 'system',
                content: `‰Ω†Êà≥‰∫ÜÊà≥${characterName}${pokeSuffix}`,
                timestamp: Date.now(),
                isPoke: true
            };
            
            // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
            if (!chatMessages[characterId]) {
                chatMessages[characterId] = [];
            }
            
            chatMessages[characterId].push(pokeMessage);
            saveChatMessages();
            
            // Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages(characterId);
            
            // Ê®°ÊãüËßíËâ≤ÂõûÂ∫îÔºà40%Ê¶ÇÁéáÔºâ
            if (Math.random() < 0.4) {
                setTimeout(() => {
                    const aiPokeSuffix = chatSettings.aiPokeSuffix || '';
                    const aiPokeMessage = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `${characterName}Êà≥‰∫ÜÊà≥‰Ω†${aiPokeSuffix}`,
                        timestamp: Date.now(),
                        isPoke: true
                    };
                    
                    chatMessages[characterId].push(aiPokeMessage);
                    saveChatMessages();
                    renderChatMessages(characterId);
                }, 1000 + Math.random() * 2000);
            }
        }
        
        // ÊòæÁ§∫ËÅäÂ§©ÈÄâÈ°π
        function showChatOptions() {
            showModal('chat-options-modal');
        }
        
        // ÊòæÁ§∫ÂçïËÅäË∫´‰ªΩÈÄâÊã©ÔºàÁ¨¨‰∏ÄÊ≠•Ôºâ
        function showSingleChatSelector() {
            hideModal('chat-options-modal');
            showPersonaSelectionForSingleChat();
        }
        
        // ÊòæÁ§∫ÂçïËÅäË∫´‰ªΩÈÄâÊã©
        function showPersonaSelectionForSingleChat() {
            const modalHTML = `
                <div class="modal" id="persona-selection-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">ÈÄâÊã©Ë∫´‰ªΩ</h3>
                            <button class="modal-close" onclick="hidePersonaSelectionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p class="selection-description">ËØ∑ÈÄâÊã©‰Ω†Âú®ËøôÊ¨°ÂØπËØù‰∏≠‰ΩøÁî®ÁöÑË∫´‰ªΩÈù¢ÂÖ∑</p>
                            <div class="persona-selection-list" id="persona-selection-list">
                                ${personas.map(persona => `
                                    <div class="persona-selection-item" data-persona-id="${persona.id}">
                                        <div class="persona-selection-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                                            ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                                        </div>
                                        <div class="persona-selection-info">
                                            <div class="persona-selection-name">${persona.name}</div>
                                            <div class="persona-selection-desc">${truncateText(persona.description || 'ÊöÇÊó†ÊèèËø∞', 100)}</div>
                                        </div>
                                        <div class="persona-selection-check">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-secondary" onclick="hidePersonaSelectionModal()">ÂèñÊ∂à</button>
                            <button class="modal-primary" id="confirm-persona-btn" onclick="confirmPersonaAndShowCharacters()" disabled>‰∏ã‰∏ÄÊ≠•ÔºöÈÄâÊã©ËßíËâ≤</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊ®°ÊÄÅÊ°Ü
            const existingModal = document.getElementById('persona-selection-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
            document.querySelectorAll('.persona-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.persona-selection-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    window.selectedPersonaForChat = this.dataset.personaId;
                    document.getElementById('confirm-persona-btn').disabled = false;
                });
            });
        }
        
        // ÈöêËóèË∫´‰ªΩÈÄâÊã©Ê®°ÊÄÅÊ°Ü
        function hidePersonaSelectionModal() {
            const modal = document.getElementById('persona-selection-modal');
            if (modal) {
                modal.remove();
            }
            window.selectedPersonaForChat = null;
        }
        
        // Á°ÆËÆ§Ë∫´‰ªΩÈÄâÊã©Âπ∂ÊòæÁ§∫ËßíËâ≤ÈÄâÊã©
        function confirmPersonaAndShowCharacters() {
            if (!window.selectedPersonaForChat) return;
            
            hidePersonaSelectionModal();
            showCharacterSelectionForSingleChat();
        }
        
        // ÊòæÁ§∫ÂçïËÅäËßíËâ≤ÈÄâÊã©ÔºàÁ¨¨‰∫åÊ≠•Ôºâ
        function showCharacterSelectionForSingleChat() {
            // üî•„Äê‰øÆÂ§ç„Äë‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑË∫´‰ªΩIDÔºåÈò≤Ê≠¢Âú®ÂêéÁª≠ÊµÅÁ®ã‰∏≠‰∏¢Â§±
            const savedPersonaId = window.selectedPersonaForChat;
            console.log('=== showCharacterSelectionForSingleChat ===');
            console.log('‰øùÂ≠òÁöÑË∫´‰ªΩID:', savedPersonaId);
            
            const modalBody = document.getElementById('single-chat-body');
            modalBody.innerHTML = '';
            
            if (characters.length === 0) {
                modalBody.innerHTML = '<p class="empty-mount-chats">ËøòÊ≤°ÊúâËßíËâ≤ÔºåËØ∑ÂÖàÂàõÂª∫ËßíËâ≤</p>';
            } else {
                characters.forEach(character => {
                    const chatOption = document.createElement('div');
                    chatOption.className = 'chat-option-item';
                    chatOption.onclick = () => {
                        // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®‰øùÂ≠òÁöÑË∫´‰ªΩIDËÄå‰∏çÊòØÂÖ®Â±ÄÂèòÈáè
                        console.log('=== ËßíËâ≤ÈÄâÊã©ÁÇπÂáª‰∫ã‰ª∂ ===');
                        console.log('ÈÄâ‰∏≠ÁöÑËßíËâ≤:', character.name);
                        console.log('‰ΩøÁî®ÁöÑË∫´‰ªΩID:', savedPersonaId);
                        
                        hideModal('single-chat-modal');
                        // ËÆæÁΩÆÈÄâÊã©ÁöÑË∫´‰ªΩÂπ∂ÂºÄÂßãËÅäÂ§©
                        startChatWithPersona(character, savedPersonaId);
                        
                        // Ê∏ÖÁêÜ‰∏¥Êó∂ÂèòÈáè
                        window.selectedPersonaForChat = null;
                    };
                    
                    chatOption.innerHTML = `
                        <div class="chat-option-icon" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}</div>
                            <div class="chat-option-desc">${truncateText(character.bio || 'ÊöÇÊó†ÊèèËø∞', 80)}</div>
                        </div>
                    `;
                    
                    modalBody.appendChild(chatOption);
                });
            }
            
            showModal('single-chat-modal');
        }
        
        async function startChatWithPersona(character, personaId) {
            console.log('‚úÖ[‰øÆÂ§ç] startChatWithPersona Ë¢´Ë∞ÉÁî®');
            if (personaId) {
        // Ëé∑ÂèñÊàñÂàõÂª∫Ê≠§ËÅäÂ§©ÁöÑ‰∏ìÂ±ûËÆæÁΩÆ
                let settings = chatSettings[character.id] || {};
                settings.selectedIdentityId = personaId;
                const selectedPersona = personas.find(p => p.id === personaId);
                if (selectedPersona) {
            settings.myChatAvatar = selectedPersona.avatarUrl || '';
            settings.myChatNickname = selectedPersona.name || '';
                chatSettings[character.id] = settings;
                await saveCurrentChatSettings(settings);
            }
    }
            if (!contacts.includes(character.id)) {
        console.log('‚úÖ[‰øÆÂ§ç] ÂèëÁé∞Êñ∞ËÅîÁ≥ª‰∫∫ÔºåÊ≠£Âú®ÂêåÊ≠•‰øùÂ≠ò...');
                contacts.push(character.id);
        // ‰ΩøÁî® await Á°Æ‰øù‰øùÂ≠òÊìç‰ΩúÂÆåÊàêÂêéÂÜçÁªßÁª≠
                await saveContacts();
        console.log('‚úÖ[‰øÆÂ§ç] Êñ∞ËÅîÁ≥ª‰∫∫‰øùÂ≠òÊàêÂäüÔºåÂÜÖÂ≠ò‰∏≠ÁöÑ contacts ÂàóË°®:', contacts);
        // ‰øùÂ≠òÊàêÂäüÂêéÔºåÁ´ãÂç≥Âà∑Êñ∞‰∏ÄÊ¨°Ê∂àÊÅØÂàóË°®ÁöÑÂêéÂè∞Êï∞ÊçÆ
        renderMessageList();
    } else {
        console.log('‚ÑπÔ∏è Â∑≤Â≠òÂú®ÁöÑËÅîÁ≥ª‰∫∫ÔºåÊó†ÈúÄÈáçÂ§çÊ∑ªÂä†');
            }
            
            // ÂºÄÂßãËÅäÂ§©
            startChat(character);
        }
        
        
        // ÂàáÊç¢Áæ§ËÅäÊàêÂëòÈÄâÊã©
        function toggleGroupMemberSelection(characterId) {
            const index = selectedGroupMembers.indexOf(characterId);
            const checkbox = document.getElementById(`checkbox-${characterId}`);
            const memberItem = checkbox.closest('.group-member-item');
            
            if (index > -1) {
                selectedGroupMembers.splice(index, 1);
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                memberItem.classList.remove('selected');
            } else {
                if (selectedGroupMembers.length >= 8) {
                    alert('ÊúÄÂ§öÂè™ËÉΩÈÄâÊã©8‰∏™ÊàêÂëò');
                    return;
                }
                selectedGroupMembers.push(characterId);
                checkbox.classList.add('checked');
                checkbox.innerHTML = '<i class="fas fa-check"></i>';
                memberItem.classList.add('selected');
            }
        }
        
 // --- ËØ∑‰ªéËøôÈáåÂºÄÂßãÔºåÂÆåÊï¥Â§çÂà∂ÊâÄÊúâ‰ª£Á†Å ---

// 1. ÊòæÁ§∫ËÅäÂ§©ÈÄâÈ°πÔºàÂÖ•Âè£ÂáΩÊï∞Ôºå‰øùÊåÅ‰∏çÂèòÔºâ
        function showGroupChatSelector() {
            hideModal('chat-options-modal');
            showPersonaSelectionForGroupChat();
        }
        
// 2. ÊòæÁ§∫Áæ§ËÅäË∫´‰ªΩÈÄâÊã©
        function showPersonaSelectionForGroupChat() {
            const modalHTML = `
                <div class="modal" id="persona-selection-group-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">ÈÄâÊã©Ë∫´‰ªΩ</h3>
                            <button class="modal-close" onclick="hidePersonaSelectionGroupModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p class="selection-description">ËØ∑ÈÄâÊã©‰Ω†Âú®Ëøô‰∏™Áæ§ËÅä‰∏≠‰ΩøÁî®ÁöÑË∫´‰ªΩÈù¢ÂÖ∑</p>
                            <div class="persona-selection-list" id="persona-selection-group-list">
                                ${personas.map(persona => `
                                    <div class="persona-selection-item" data-persona-id="${persona.id}">
                                <div class="persona-selection-avatar" style="${persona.avatarUrl ? `background-image: url('${persona.avatarUrl}'); background-size: cover; background-position: center;` : ''}">
                                            ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                                        </div>
                                        <div class="persona-selection-info">
                                            <div class="persona-selection-name">${persona.name}</div>
                                            <div class="persona-selection-desc">${truncateText(persona.description || 'ÊöÇÊó†ÊèèËø∞', 100)}</div>
                                        </div>
                                <div class="persona-selection-check"><i class="fas fa-check"></i></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-secondary" onclick="hidePersonaSelectionGroupModal()">ÂèñÊ∂à</button>
                    <button class="modal-primary" id="confirm-group-persona-btn" disabled>‰∏ã‰∏ÄÊ≠•ÔºöËÆæÁΩÆÁæ§ËÅä</button>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('persona-selection-group-modal');
    if (existingModal) existingModal.remove();
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
    let selectedPersonaId = null;

            document.querySelectorAll('#persona-selection-group-modal .persona-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('#persona-selection-group-modal .persona-selection-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
            selectedPersonaId = this.dataset.personaId;
                    document.getElementById('confirm-group-persona-btn').disabled = false;
                    console.log('‚úÖ ÈÄâÊã©‰∫ÜË∫´‰ªΩ:', selectedPersonaId, 'Ë∫´‰ªΩÂêçÁß∞:', this.querySelector('.persona-selection-name').textContent);
                });
            });

    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöËÆ©‚Äú‰∏ã‰∏ÄÊ≠•‚ÄùÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂Áõ¥Êé•Ë∞ÉÁî®‰∏ã‰∏ÄÊ≠•ÂáΩÊï∞ÔºåÂπ∂ÊääID‰º†ËøáÂéª
    document.getElementById('confirm-group-persona-btn').onclick = () => {
        console.log('‚úÖ ÁÇπÂáª‰∏ã‰∏ÄÊ≠•ÊåâÈíÆÔºåÂΩìÂâçselectedPersonaIdÂÄº‰∏∫:', selectedPersonaId);
        if (selectedPersonaId) {
            console.log('‚úÖ ÂáÜÂ§áË∞ÉÁî®confirmPersonaAndShowGroupSettingsÔºå‰º†ÈÄíID:', selectedPersonaId);
            confirmPersonaAndShowGroupSettings(selectedPersonaId);
        } else {
            console.error('‚ùå Êú™ÈÄâÊã©Ë∫´‰ªΩÂ∞±ÁÇπÂáª‰∫Ü‰∏ã‰∏ÄÊ≠•');
            alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë∫´‰ªΩÈù¢ÂÖ∑');
        }
    };
}

// 3. ÈöêËóèË∫´‰ªΩÈÄâÊã©Ê®°ÊÄÅÊ°ÜÁöÑÂáΩÊï∞
        function hidePersonaSelectionGroupModal() {
            const modal = document.getElementById('persona-selection-group-modal');
    if (modal) modal.remove();
}

// 4. Á°ÆËÆ§Ë∫´‰ªΩÂπ∂ÊòæÁ§∫Áæ§ÊàêÂëòÈÄâÊã©
function confirmPersonaAndShowGroupSettings(personaId) {
    console.log('‚úÖ confirmPersonaAndShowGroupSettingsË¢´Ë∞ÉÁî®ÔºåÊé•Êî∂Âà∞ÁöÑpersonaId:', personaId);
            hidePersonaSelectionGroupModal();
    showGroupChatMemberSelection(personaId); // Â∞ÜÈÄâÊã©ÁöÑID‰Ωú‰∏∫ÂèÇÊï∞‰º†ÈÄíÁªô‰∏ã‰∏ÄÊ≠•
        }
        
// 5. ÊòæÁ§∫Áæ§ÊàêÂëòÈÄâÊã© (Â∑≤ÊÅ¢Â§çÁÆÄ‰ªãÊòæÁ§∫)
function showGroupChatMemberSelection(personaId) {
    console.log('‚úÖ showGroupChatMemberSelectionË¢´Ë∞ÉÁî®ÔºåÊé•Êî∂Âà∞ÁöÑpersonaId:', personaId);
    
    // Á´ãÂç≥Â∞ÜpersonaIdÂ≠òÂÇ®Âà∞ÂÖ®Â±ÄÂèòÈáè‰∏≠ÔºåÁ°Æ‰øù‰∏ç‰ºö‰∏¢Â§±
    window.currentGroupPersonaId = personaId;
            document.getElementById('group-chat-name').value = '';
            selectedGroupMembers = [];
            
            const membersContainer = document.getElementById('group-chat-members');
            membersContainer.innerHTML = '';
            
            if (characters.length < 2) {
                membersContainer.innerHTML = '<p class="empty-mount-chats">Ëá≥Â∞ëÈúÄË¶Å2‰∏™ËßíËâ≤ÊâçËÉΩÂàõÂª∫Áæ§ËÅä</p>';
            } else {
                characters.forEach(character => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.onclick = () => toggleGroupMemberSelection(character.id);
            // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊÅ¢Â§ç‰∫ÜÊòæÁ§∫ËßíËâ≤ÁÆÄ‰ªãÁöÑHTML‰ª£Á†Å
                    memberItem.innerHTML = `
                <div class="group-member-checkbox" id="checkbox-${character.id}"></div>
                <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url('${character.avatarUrl}');` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}</div>
                    <div class="chat-option-desc">${truncateText(character.bio || 'ÊöÇÊó†ÁÆÄ‰ªã', 80)}</div>
                </div>`;
                    membersContainer.appendChild(memberItem);
                });
            }

    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂ∞Ü personaId ÁªëÂÆöÂà∞ÊúÄÁªàÁöÑ‚ÄúÂàõÂª∫Áæ§ËÅä‚ÄùÊåâÈíÆ‰∏ä
    console.log('‚úÖ Âú®Á¨¨‰∏Ä‰∏™‰ΩçÁΩÆÁªëÂÆöÂàõÂª∫ÊåâÈíÆÔºåpersonaId:', personaId);
    const createBtn = document.getElementById('group-chat-modal').querySelector('.modal-primary');
    createBtn.onclick = () => {
        console.log('‚úÖ Á¨¨‰∏Ä‰∏™‰ΩçÁΩÆÁöÑÂàõÂª∫Áæ§ËÅäÊåâÈíÆË¢´ÁÇπÂáªÔºåÁõ¥Êé•‰ΩøÁî®ÂèÇÊï∞personaId:', personaId);
        createGroupChat(personaId);
    }; // ÁªëÂÆöÂ∏¶ÂèÇÊï∞ÁöÑÂàõÂª∫ÂáΩÊï∞
            
            showModal('group-chat-modal');
        }
        
// 6. ÂàáÊç¢Áæ§ÊàêÂëòÈÄâÊã©Áä∂ÊÄÅ (Êó†‰øÆÊîπÔºå‰ΩÜ‰∏∫‰∫ÜÂÆåÊï¥ÊÄßÂåÖÂê´Âú®Ê≠§)
        function toggleGroupMemberSelection(characterId) {
            const index = selectedGroupMembers.indexOf(characterId);
            const checkbox = document.getElementById(`checkbox-${characterId}`);
            const memberItem = checkbox.closest('.group-member-item');
            
            if (index > -1) {
                selectedGroupMembers.splice(index, 1);
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                memberItem.classList.remove('selected');
            } else {
                if (selectedGroupMembers.length >= 8) {
                    alert('ÊúÄÂ§öÂè™ËÉΩÈÄâÊã©8‰∏™ÊàêÂëò');
                    return;
                }
                selectedGroupMembers.push(characterId);
                checkbox.classList.add('checked');
                checkbox.innerHTML = '<i class="fas fa-check"></i>';
                memberItem.classList.add('selected');
            }
        }
        

// 7. ÂàõÂª∫Áæ§ËÅäÔºàÊúÄÁªàÁâàÊú¨Ôºâ
async function createGroupChat(personaId) {
    console.log(`‚úÖ createGroupChatË¢´Ë∞ÉÁî®ÔºåË∫´‰ªΩID: ${personaId}`);

    const groupName = document.getElementById('group-chat-name').value.trim();
    if (!groupName) return alert('ËØ∑ËæìÂÖ•Áæ§ËÅäÂêçÁß∞');
    if (selectedGroupMembers.length < 2) return alert('Ëá≥Â∞ëÈúÄË¶ÅÈÄâÊã©2‰∏™ÊàêÂëò');

            const memberDetails = selectedGroupMembers.map(memberId => {
                const character = characters.find(c => c.id === memberId);
        return { id: character.id, name: character.name, bio: character.bio, avatarUrl: character.avatarUrl, color: character.color };
    });

            const groupChat = {
                id: 'group_' + Date.now().toString(),
                name: groupName,
                members: memberDetails,
                isGroup: true,
                createdAt: new Date().toISOString()
            };
            
    // Âè™ÊúâÂú® personaId Â≠òÂú®Êó∂Êâç‰øùÂ≠òË∫´‰ªΩËÆæÁΩÆ
    if (personaId) {
        const selectedPersona = personas.find(p => p.id === personaId);
                if (selectedPersona) {
                    const chatSettings = {
                selectedIdentityId: personaId,
                        myChatAvatar: selectedPersona.avatarUrl,
                        myChatNickname: selectedPersona.name,
                selectedPersonaData: { ...selectedPersona }
            };
                    // Á°Æ‰øù window.chatSettings Â∑≤ÂàùÂßãÂåñ
                    if (!window.chatSettings) {
                        window.chatSettings = {};
                    }
                    window.chatSettings[groupChat.id] = chatSettings;
            await db.chatSettings.put({ id: groupChat.id, chatId: groupChat.id, settings: chatSettings });
            console.log('‚úÖ Áæ§ËÅäË∫´‰ªΩËÆæÁΩÆÂ∑≤ÊàêÂäü‰øùÂ≠ò');
                } else {
            console.error('‚ùå ÂàõÂª∫Áæ§ËÅäÊó∂Êú™ÊâæÂà∞ID‰∏∫ ' + personaId + ' ÁöÑË∫´‰ªΩ„ÄÇ');
                }
            }
            
            if (!groupChats) groupChats = [];
            groupChats.push(groupChat);
            await saveGroupChats();
            hideModal('group-chat-modal');
            renderMessageList();
            alert(`Áæ§ËÅä"${groupName}"ÂàõÂª∫ÊàêÂäüÔºÅ`);
        }

// --- ËØ∑Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ---
        
        // ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function saveGroupChats() {
            try {
                console.log('‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆÂà∞IndexedDB:', groupChats);
                
                // Ê£ÄÊü•Êï∞ÊçÆÂÆåÊï¥ÊÄß
                if (!groupChats || !Array.isArray(groupChats)) {
                    console.error('Áæ§ËÅäÊï∞ÊçÆÊó†Êïà:', groupChats);
                    groupChats = [];
                }
                
                // È™åËØÅÊØè‰∏™Áæ§ËÅäÂØπË±°ÁöÑÂÆåÊï¥ÊÄß
                const validGroupChats = groupChats.filter(chat => {
                    if (!chat || !chat.id || !chat.name) {
                        console.warn('ÂèëÁé∞Êó†ÊïàÁöÑÁæ§ËÅäÂØπË±°:', chat);
                        return false;
                    }
                    return true;
                });
                
                // Â¶ÇÊûúÊúâÊó†ÊïàÊï∞ÊçÆÔºåÊõ¥Êñ∞Êï∞ÁªÑ
                if (validGroupChats.length !== groupChats.length) {
                    groupChats = validGroupChats;
                    console.log('Â∑≤ËøáÊª§Êó†ÊïàÊï∞ÊçÆÔºåÊúâÊïàÁæ§ËÅäÊï∞Èáè:', groupChats.length);
                }
                
                // ‰ΩøÁî®‰∫ãÂä°Êù•Á°Æ‰øùÊï∞ÊçÆ‰∏ÄËá¥ÊÄß
                await db.transaction('rw', db.groupChats, async () => {
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
                await db.groupChats.clear();
                
                    // ÈÄê‰∏™ÊèíÂÖ•Êï∞ÊçÆ‰ª•ÈÅøÂÖçÊâπÈáèÊèíÂÖ•ÁöÑIDÂÜ≤Á™ÅÈóÆÈ¢ò
                    for (const chat of groupChats) {
                        try {
                            await db.groupChats.add(chat);
                        } catch (addError) {
                            console.warn('ÊèíÂÖ•Áæ§ËÅäÂ§±Ë¥•ÔºåÂ∞ùËØïÊõ¥Êñ∞:', chat.id, addError);
                            // Â¶ÇÊûúÊ∑ªÂä†Â§±Ë¥•ÔºåÂ∞ùËØïÊõ¥Êñ∞
                            await db.groupChats.put(chat);
                        }
                    }
                });
                
                console.log('Áæ§ËÅäÊï∞ÊçÆ‰øùÂ≠òÊàêÂäüÂà∞IndexedDB');
                
                // ÂêåÊó∂‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫Â§á‰ªΩ
                try {
                    localStorage.setItem('groupChats', JSON.stringify(groupChats));
                    console.log('Áæ§ËÅäÊï∞ÊçÆÂ§á‰ªΩÂà∞localStorageÊàêÂäü');
                } catch (storageError) {
                    console.warn('localStorageÂ§á‰ªΩÂ§±Ë¥•:', storageError);
                    // localStorageÂ§±Ë¥•‰∏çÂ∫îËØ•ÈòªÊ≠¢IndexedDBÁöÑÊàêÂäü‰øùÂ≠ò
                }
                
            } catch (error) {
                console.error('‰øùÂ≠òÁæ§ËÅäÂà∞IndexedDBÂ§±Ë¥•:', error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', error.name, error.message);
                
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                try {
                    localStorage.setItem('groupChats', JSON.stringify(groupChats || []));
                    console.log('Áæ§ËÅäÊï∞ÊçÆÂõûÈÄÄ‰øùÂ≠òÂà∞localStorageÊàêÂäü');
                    showToast('Áæ§ËÅäÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®', 'info');
                } catch (localError) {
                    console.error('localStorage‰øùÂ≠ò‰πüÂ§±Ë¥•:', localError);
                    console.error('localStorageÈîôËØØËØ¶ÊÉÖ:', localError.name, localError.message);
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ≠òÂÇ®Á©∫Èó¥‰∏çË∂≥
                    if (localError.name === 'QuotaExceededError') {
                        alert('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåËØ∑Ê∏ÖÁêÜ‰∏Ä‰∫õÊï∞ÊçÆÂêéÈáçËØï');
                    } else {
                        alert('‰øùÂ≠òÁæ§ËÅäÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÂà∑Êñ∞È°µÈù¢ÈáçÊñ∞Êìç‰Ωú');
                    }
                    
                    // ÊÅ¢Â§çÂà∞‰πãÂâçÁöÑÁä∂ÊÄÅ
                    groupChats.pop(); // ÁßªÈô§ÂàöÊ∑ªÂä†ÁöÑÁæ§ËÅä
                    throw localError;
                }
            }
        }
        
        // Ê∏≤ÊüìÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function renderScheduleTimes() {
            const container = document.getElementById('schedule-times-container');
            if (!container) return;
            
            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduleTimes || [];
            
            container.innerHTML = '';
            
            scheduleTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'schedule-time-item';
                timeItem.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${index}, this.value)">
                    <button onclick="removeScheduleTime(${index})">√ó</button>
                `;
                container.appendChild(timeItem);
            });
        }
        
        // Ê∑ªÂä†ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        async function addScheduleTime() {
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduleTimes) {
                chatSettings.scheduleTimes = [];
            }
            
            if (chatSettings.scheduleTimes.length >= 10) {
                alert('ÊúÄÂ§öÂè™ËÉΩËÆæÁΩÆ10‰∏™Êó∂Èó¥ÁÇπ');
                return;
            }
            
            chatSettings.scheduleTimes.push('09:00');
            await saveCurrentChatSettings(chatSettings);
            renderScheduleTimes();
        }
        
        // Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        async function updateScheduleTime(index, newTime) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes[index] = newTime;
                await saveCurrentChatSettings(chatSettings);
            }
        }
        
        // ÁßªÈô§ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        async function removeScheduleTime(index) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes.splice(index, 1);
                await saveCurrentChatSettings(chatSettings);
                renderScheduleTimes();
            }
        }
        
        // ‰øùÂ≠òÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ
        async function saveScheduleSettings() {
            const chatSettings = getCurrentChatSettings();
            chatSettings.scheduleEnabled = document.getElementById('schedule-enabled').checked;
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('schedule-settings-modal');
            showToast('ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ÊòæÁ§∫‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆ
        function showWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            document.getElementById('worldbook-mount-enabled').checked = chatSettings.worldbookMountEnabled || false;
            
            // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÁöÑÊòæÁ§∫
            toggleWorldbookMountDetails();
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('worldbook-mount-enabled').onchange = toggleWorldbookMountDetails;
            
            // Ê∏≤Êüì‰∏ñÁïå‰π¶ÂàóË°®
            renderWorldbookMountList();
            
            showModal('worldbook-mount-modal');
        }
        
        // ÂàáÊç¢‰∏ñÁïå‰π¶ÊåÇËΩΩËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
        function toggleWorldbookMountDetails() {
            const enabled = document.getElementById('worldbook-mount-enabled').checked;
            document.getElementById('worldbook-mount-details').style.display = enabled ? 'block' : 'none';
            
            // Êõ¥Êñ∞‰∏ªËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫
            updateWorldbookMountDisplay();
        }
        
        // Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫Áä∂ÊÄÅ
        function updateWorldbookMountDisplay() {
            const chatSettings = getCurrentChatSettings();
            const displayElement = document.getElementById('current-worldbook-mount');
            
            if (!chatSettings.worldbookMountEnabled) {
                displayElement.textContent = 'Êú™ÊåÇËΩΩ';
                return;
            }
            
            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];
            if (selectedWorldbooks.length === 0) {
                displayElement.textContent = 'Â∑≤ÂêØÁî®‰ΩÜÊú™ÈÄâÊã©';
            } else if (selectedWorldbooks.length === 1) {
                const worldbook = worldbooks.find(w => w.id === selectedWorldbooks[0]);
                displayElement.textContent = worldbook ? `Â∑≤ÊåÇËΩΩ: ${worldbook.title}` : 'Â∑≤ÊåÇËΩΩ: 1‰∏™';
            } else {
                displayElement.textContent = `Â∑≤ÊåÇËΩΩ: ${selectedWorldbooks.length}‰∏™`;
            }
        }
        
        // Ê∏≤Êüì‰∏ñÁïå‰π¶ÊåÇËΩΩÂàóË°®
        function renderWorldbookMountList() {
            const container = document.getElementById('worldbook-mount-list');
            container.innerHTML = '';
            
            if (worldbooks.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">ÊöÇÊó†‰∏ñÁïå‰π¶ÔºåËØ∑ÂÖàÂú®‰∏ñÁïå‰π¶Â∫îÁî®‰∏≠ÂàõÂª∫</p>';
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];
            
            worldbooks.forEach(worldbook => {
                const item = document.createElement('div');
                item.className = 'mount-item worldbook-mount-item';
                
                const isSelected = selectedWorldbooks.includes(worldbook.id);
                
                item.innerHTML = `
                    <input type="checkbox" id="worldbook-${worldbook.id}" value="${worldbook.id}" ${isSelected ? 'checked' : ''} class="worldbook-checkbox">
                    <div class="worldbook-content-flex">
                        <div class="worldbook-title-text">
                            ${worldbook.title}
                        </div>
                        <div class="worldbook-desc-text">
                            ${worldbook.content.length > 100 ? worldbook.content.substring(0, 100) + '...' : worldbook.content}
                        </div>
                        <div class="worldbook-date-text">
                            ÂàõÂª∫‰∫é: ${new Date(worldbook.createdAt).toLocaleDateString('zh-CN')} | 
                            Â≠óÊï∞: ${worldbook.content.length}
                        </div>
                    </div>
                `;
                
                // ÁÇπÂáªÊï¥‰∏™Êù°ÁõÆ‰πüËÉΩÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
                item.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                };
                
                container.appendChild(item);
            });
        }
        
        // ‰øùÂ≠ò‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆ
        function saveWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.worldbookMountEnabled = document.getElementById('worldbook-mount-enabled').checked;
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑ‰∏ñÁïå‰π¶
            const checkboxes = document.querySelectorAll('#worldbook-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedWorldbooks = Array.from(checkboxes).map(cb => cb.value);
            
            saveCurrentChatSettings(chatSettings);
            updateWorldbookMountDisplay();
            hideModal('worldbook-mount-modal');
            
            const selectedCount = chatSettings.selectedWorldbooks ? chatSettings.selectedWorldbooks.length : 0;
            if (chatSettings.worldbookMountEnabled && selectedCount > 0) {
                showToast(`‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÂ∑≤ÊåÇËΩΩ ${selectedCount} ‰∏™‰∏ñÁïå‰π¶`, 'success');
            } else if (chatSettings.worldbookMountEnabled) {
                showToast('‰∏ñÁïå‰π¶ÊåÇËΩΩÂ∑≤ÂêØÁî®Ôºå‰ΩÜÊú™ÈÄâÊã©‰ªª‰Ωï‰∏ñÁïå‰π¶', 'info');
            } else {
                showToast('‰∏ñÁïå‰π¶ÊåÇËΩΩÂ∑≤ÂÖ≥Èó≠', 'info');
            }
        }
        
        // Ë∫´‰ªΩÈÄâÊã©Âô®ÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåË∫´‰ªΩÂú®ÂàõÂª∫ÂØπËØùÊó∂ÈÄâÊã©
        
        // ÂéãÁº©ÂõæÁâá‰ª•ÂáèÂ∞ëÂ≠òÂÇ®Á©∫Èó¥
        function compressImage(dataUrl, maxWidth = 300, quality = 0.8) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ËÆ°ÁÆóÊñ∞ÁöÑÂ∞∫ÂØ∏Ôºå‰øùÊåÅÂÆΩÈ´òÊØî
                    let { width, height } = img;
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxWidth) {
                            width = (width * maxWidth) / height;
                            height = maxWidth;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ÁªòÂà∂Âπ∂ÂéãÁº©
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    console.log(`ÂõæÁâáÂéãÁº©Ôºö${Math.round(dataUrl.length/1024)}KB -> ${Math.round(compressedDataUrl.length/1024)}KB`);
                    resolve(compressedDataUrl);
                };
                img.src = dataUrl;
            });
        }
        

        
        // üî•„ÄêÁ¥ßÊÄ•‰øÆÂ§ç„ÄëÊÅ¢Â§çËÆæÁΩÆÂπ∂Âà∑Êñ∞ÁïåÈù¢
        function recoverAndRefreshSettings() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©Á™óÂè£', 'warning');
                return;
            }
            
            const chatId = currentChatCharacter.id;
            console.log(`ÂºÄÂßãÊÅ¢Â§çËÅäÂ§©ËÆæÁΩÆ: ${chatId}`);
            console.log('ÂΩìÂâçËÆæÁΩÆÁä∂ÊÄÅ:', JSON.stringify(chatSettings[chatId], null, 2));
            
            // ÊòæÁ§∫ÊÅ¢Â§çËøõÂ∫¶
            showToast('Ê≠£Âú®Â∞ùËØïÊÅ¢Â§çËÆæÁΩÆ...', 'info');
            
            // üî•„ÄêÁõ¥Êé•ÊÅ¢Â§çÊñπÊ≥ï„ÄëÂº∫Âà∂‰ªélocalStorageÊÅ¢Â§çÔºå‰∏çÈÄöËøágetCurrentChatSettings
            const savedLocalStorage = localStorage.getItem(`chatSettings_${chatId}`);
            if (savedLocalStorage) {
                try {
                    const recoveredSettings = JSON.parse(savedLocalStorage);
                    console.log('‰ªélocalStorageÊÅ¢Â§çÁöÑËÆæÁΩÆ:', JSON.stringify(recoveredSettings, null, 2));
                    
                    // Áõ¥Êé•Ë¶ÜÁõñÂÖ®Â±ÄËÆæÁΩÆ
                    chatSettings[chatId] = recoveredSettings;
                    
                    // Á´ãÂç≥Âà∑Êñ∞ÂΩìÂâçÁïåÈù¢ÁöÑÊòæÁ§∫ÔºàÂ¶ÇÊûúÂú®ËÆæÁΩÆÁïåÈù¢Ôºâ
                    if (document.getElementById('api-chat-settings-screen').style.display !== 'none') {
                        updateChatSettingsDisplay();
                    }
                    
                    // Âà∑Êñ∞ËÅäÂ§©Ê∂àÊÅØÁïåÈù¢
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }
                    
                    showToast('ËÆæÁΩÆÊÅ¢Â§çÊàêÂäüÔºÅ', 'success');
                    console.log('ËÆæÁΩÆÊÅ¢Â§çÂÆåÊàêÔºåÂΩìÂâçËÆæÁΩÆ:', JSON.stringify(chatSettings[chatId], null, 2));
                    return;
                } catch (error) {
                    console.error('Ëß£ÊûêlocalStorageËÆæÁΩÆÂ§±Ë¥•:', error);
                }
            }
            
            // Â¶ÇÊûúlocalStorageÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªéIndexedDBÊÅ¢Â§ç
            db.chatSettings.get(chatId).then(dbSettings => {
                if (dbSettings && dbSettings.settings) {
                    console.log('‰ªéIndexedDBÊÅ¢Â§çÁöÑËÆæÁΩÆ:', JSON.stringify(dbSettings.settings, null, 2));
                    
                    // Áõ¥Êé•Ë¶ÜÁõñÂÖ®Â±ÄËÆæÁΩÆ
                    chatSettings[chatId] = dbSettings.settings;
                    
                    // ÂêåÊ≠•Âà∞localStorage
                    localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(dbSettings.settings));
                    
                    // Á´ãÂç≥Âà∑Êñ∞ÁïåÈù¢
                    if (document.getElementById('api-chat-settings-screen').style.display !== 'none') {
                        updateChatSettingsDisplay();
                    }
                    
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }
                    
                    showToast('‰ªéÂ§á‰ªΩÊï∞ÊçÆÊÅ¢Â§çËÆæÁΩÆÊàêÂäüÔºÅ', 'success');
                    console.log('‰ªéIndexedDBÊÅ¢Â§çËÆæÁΩÆÊàêÂäü:', JSON.stringify(dbSettings.settings, null, 2));
                } else {
                    showToast('Êú™ÊâæÂà∞Â§á‰ªΩÊï∞ÊçÆÔºåËÆæÁΩÆÂèØËÉΩÂ∑≤Ê∞∏‰πÖ‰∏¢Â§±', 'error');
                    console.log('Êú™ÊâæÂà∞‰ªª‰ΩïÂ§á‰ªΩÊï∞ÊçÆ');
                }
            }).catch(error => {
                console.error('‰ªéIndexedDBÊÅ¢Â§çËÆæÁΩÆÂ§±Ë¥•:', error);
                showToast('ÊÅ¢Â§çËÆæÁΩÆÂ§±Ë¥•ÔºåËØ∑ËÅîÁ≥ªÊäÄÊúØÊîØÊåÅ', 'error');
            });
        }
        
        // üî•„ÄêÁ¥ßÊÄ•‰øÆÂ§ç„ÄëÂ∞ùËØïÊÅ¢Â§çË¢´Ë¶ÜÁõñÁöÑËÅäÂ§©ËÆæÁΩÆ
        function recoverChatSettings() {
            if (!currentChatCharacter) return false;
            
            const chatId = currentChatCharacter.id;
            console.log('Â∞ùËØïÊÅ¢Â§çËÅäÂ§©ËÆæÁΩÆ...');
            
            // Â∞ùËØï‰ªélocalStorageÊÅ¢Â§ç
            const savedSettings = localStorage.getItem(`chatSettings_${chatId}`);
            if (savedSettings) {
                try {
                    const userSettings = JSON.parse(savedSettings);
                    chatSettings[chatId] = userSettings;
                    console.log('‰ªélocalStorageÊÅ¢Â§çËÅäÂ§©ËÆæÁΩÆÊàêÂäü:', userSettings);
                    return true;
                } catch (error) {
                    console.error('‰ªélocalStorageÊÅ¢Â§çËÆæÁΩÆÂ§±Ë¥•:', error);
                }
            }
            
            // Â∞ùËØï‰ªéIndexedDBÊÅ¢Â§ç
            db.chatSettings.get(chatId).then(dbSettings => {
                if (dbSettings && dbSettings.settings) {
                    chatSettings[chatId] = dbSettings.settings;
                    console.log('‰ªéIndexedDBÊÅ¢Â§çËÅäÂ§©ËÆæÁΩÆÊàêÂäü:', dbSettings.settings);
                    // ÂêåÊ≠•Âà∞localStorage
                    localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(dbSettings.settings));
                    return true;
                }
            }).catch(error => {
                console.error('‰ªéIndexedDBÊÅ¢Â§çËÆæÁΩÆÂ§±Ë¥•:', error);
            });
            
            return false;
        }
        
        // Âº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÂ§¥ÂÉèÊòæÁ§∫
        function forceRefreshAvatars() {
            const chatSettings = getCurrentChatSettings();
            const currentAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || currentChatCharacter.avatarUrl;
            
            console.log('Âº∫Âà∂Âà∑Êñ∞Â§¥ÂÉèÊòæÁ§∫ÔºåÂΩìÂâçÂ§¥ÂÉè:', currentAvatar ? currentAvatar.substring(0, 50) + '...' : 'Êó†Â§¥ÂÉè');
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰∏≠ÊâÄÊúâËßíËâ≤Â§¥ÂÉè
            const messageAvatars = document.querySelectorAll('.message-avatar');
            messageAvatars.forEach(avatar => {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂΩìÂâçËßíËâ≤ÁöÑÂ§¥ÂÉèÔºàÈÄöËøáÁÇπÂáª‰∫ã‰ª∂Âà§Êñ≠Ôºâ
                const onclickAttr = avatar.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${currentChatCharacter.id}'`)) {
                    if (currentAvatar && currentAvatar !== 'undefined') {
                        avatar.style.backgroundImage = `url(${currentAvatar})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                        avatar.innerHTML = '';
                    } else {
                        avatar.style.backgroundImage = 'none';
                        avatar.innerHTML = currentChatCharacter.name.charAt(0);
                    }
                }
            });
            
            // Â¶ÇÊûúÂΩìÂâçÂú®Â§¥ÂÉèËÆæÁΩÆÁïåÈù¢Ôºå‰πüÂà∑Êñ∞È¢ÑËßà
            const aiAvatarPreview = document.getElementById('ai-chat-avatar-preview');
            if (aiAvatarPreview && currentAvatar && currentAvatar !== 'undefined') {
                aiAvatarPreview.style.backgroundImage = `url(${currentAvatar})`;
                aiAvatarPreview.style.backgroundSize = 'cover';
                aiAvatarPreview.style.backgroundPosition = 'center';
                aiAvatarPreview.innerHTML = '';
                
                // Êõ¥Êñ∞ÊèêÁ§∫‰ø°ÊÅØ
                if (chatSettings.aiDynamicAvatar) {
                    aiAvatarPreview.title = 'ÂΩìÂâçÊòæÁ§∫Âä®ÊÄÅÂ§¥ÂÉèÔºàËßíËâ≤Âú®ËÅäÂ§©‰∏≠Êõ¥Êç¢ÁöÑÔºâ';
                } else {
                    aiAvatarPreview.title = 'ÂΩìÂâçÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆÂ§¥ÂÉè';
                }
            }
        }
        
        // üìä ËÆ°ÁÆóÂ≠òÂÇ®Á©∫Èó¥‰ΩøÁî®ÊÉÖÂÜµ
        async function calculateStorageUsage() {
            try {
                let chatSize = 0;
                let characterSize = 0;
                let settingsSize = 0;
                let emojiSize = 0;

                // ËÆ°ÁÆóËÅäÂ§©ËÆ∞ÂΩïÂ§ßÂ∞è
                const chatMessagesData = await db.chatMessages.toArray();
                chatSize = JSON.stringify(chatMessagesData).length;

                // ËÆ°ÁÆóËßíËâ≤Êï∞ÊçÆÂ§ßÂ∞è
                const charactersData = await db.characters.toArray();
                characterSize = JSON.stringify(charactersData).length;

                // ËÆ°ÁÆóËÅäÂ§©ËÆæÁΩÆÂ§ßÂ∞è
                const chatSettingsData = await db.chatSettings.toArray();
                settingsSize = JSON.stringify(chatSettingsData).length;

                // ËÆ°ÁÆóË°®ÊÉÖÂåÖÂ§ßÂ∞è
                const emojisData = await db.customEmojis.toArray();
                emojiSize = JSON.stringify(emojisData).length;

                const total = chatSize + characterSize + settingsSize + emojiSize;

                // Êõ¥Êñ∞ÊòæÁ§∫
                document.getElementById('chat-storage-size').textContent = formatBytes(chatSize);
                document.getElementById('character-storage-size').textContent = formatBytes(characterSize);
                document.getElementById('settings-storage-size').textContent = formatBytes(settingsSize);
                document.getElementById('emoji-storage-size').textContent = formatBytes(emojiSize);
                document.getElementById('total-storage-size').textContent = formatBytes(total);

                return { chatSize, characterSize, settingsSize, emojiSize, total };
            } catch (error) {
                console.error('ËÆ°ÁÆóÂ≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµÂ§±Ë¥•:', error);
                return null;
            }
        }

        // Ê†ºÂºèÂåñÂ≠óËäÇÊï∞‰∏∫ÂèØËØªÊ†ºÂºè
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // üßπ ÂéãÁº©ÊâÄÊúâÂõæÁâá
        async function compressAllImages() {
            if (!confirm('Â∞ÜÂéãÁº©ÊâÄÊúâÂ§¥ÂÉèÂíåËÉåÊôØÂõæÁâáÔºåËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥„ÄÇÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü')) {
                return;
            }

            showToast('Ê≠£Âú®ÂéãÁº©ÂõæÁâá...', 'info');
            let compressedCount = 0;

            try {
                // ÂéãÁº©ËßíËâ≤Â§¥ÂÉè
                for (const character of characters) {
                    if (character.avatarUrl && character.avatarUrl.length > 50000) {
                        character.avatarUrl = await compressImage(character.avatarUrl, 150, 0.6);
                        compressedCount++;
                    }
                }
                await saveCharacters();

                // ÂéãÁº©ËÅäÂ§©ËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉè
                for (const chatId of Object.keys(chatSettings)) {
                    const settings = chatSettings[chatId];
                    if (settings) {
                        if (settings.aiChatAvatar && settings.aiChatAvatar.length > 50000) {
                            settings.aiChatAvatar = await compressImage(settings.aiChatAvatar, 150, 0.6);
                            compressedCount++;
                        }
                        if (settings.myChatAvatar && settings.myChatAvatar.length > 50000) {
                            settings.myChatAvatar = await compressImage(settings.myChatAvatar, 150, 0.6);
                            compressedCount++;
                        }
                        if (settings.chatBackground && settings.chatBackground.length > 100000) {
                            settings.chatBackground = await compressImage(settings.chatBackground, 800, 0.7);
                            compressedCount++;
                        }
                    }
                }
                await saveChatSettings();

                // Êõ¥Êñ∞Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ
                calculateStorageUsage();

                showToast(`ÂõæÁâáÂéãÁº©ÂÆåÊàêÔºÅÂÖ±Â§ÑÁêÜ‰∫Ü ${compressedCount} Âº†ÂõæÁâá`, 'success');
            } catch (error) {
                console.error('ÂéãÁº©ÂõæÁâáÂ§±Ë¥•:', error);
                showToast('ÂéãÁº©ËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ', 'error');
            }
        }

        // üßπ ÊóßÁâàÊ∏ÖÁêÜÂ≠òÂÇ®Á©∫Èó¥Ôºà‰øùÁïôÂÖºÂÆπÊÄßÔºâ
        async function cleanupStorageSpace() {
            if (!confirm('Â∞ÜÊ∏ÖÁêÜ‰ª•‰∏ãÊï∞ÊçÆ‰ª•ÈáäÊîæÂ≠òÂÇ®Á©∫Èó¥Ôºö\n\n‚Ä¢ ÊâÄÊúâËßíËâ≤ÁöÑÂä®ÊÄÅÂ§¥ÂÉè\n‚Ä¢ localStorage‰∏≠ÁöÑËøáÊúüÊï∞ÊçÆ\n‚Ä¢ ÂéãÁº©Áé∞ÊúâÂ§¥ÂÉèÊï∞ÊçÆ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü')) {
                return;
            }
            
            showToast('Ê≠£Âú®Ê∏ÖÁêÜÂ≠òÂÇ®Á©∫Èó¥...', 'info');
            let cleanedSize = 0;
            let cleanedItems = 0;
            
            try {
                // 1. Ê∏ÖÈô§ÊâÄÊúâÂä®ÊÄÅÂ§¥ÂÉè
                Object.keys(chatSettings).forEach(chatId => {
                    if (chatSettings[chatId] && chatSettings[chatId].aiDynamicAvatar) {
                        delete chatSettings[chatId].aiDynamicAvatar;
                        cleanedItems++;
                    }
                });
                
                // 2. Ê∏ÖÁêÜlocalStorage‰∏≠ÁöÑËøáÊúüchatSettings
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('chatSettings_')) {
                        const value = localStorage.getItem(key);
                        if (value) {
                            cleanedSize += value.length;
                            localStorage.removeItem(key);
                            cleanedItems++;
                        }
                    }
                }
                
                // 3. ÂéãÁº©ÊâÄÊúâÁé∞ÊúâÂ§¥ÂÉèÊï∞ÊçÆ
                for (const chatId of Object.keys(chatSettings)) {
                    const settings = chatSettings[chatId];
                    if (settings) {
                        if (settings.aiChatAvatar && settings.aiChatAvatar.length > 50000) {
                            settings.aiChatAvatar = await compressImage(settings.aiChatAvatar, 150, 0.6);
                            cleanedItems++;
                        }
                        if (settings.myChatAvatar && settings.myChatAvatar.length > 50000) {
                            settings.myChatAvatar = await compressImage(settings.myChatAvatar, 150, 0.6);
                            cleanedItems++;
                        }
                    }
                }
                
                // 4. ÈáçÊñ∞‰øùÂ≠òÂéãÁº©ÂêéÁöÑËÆæÁΩÆÂà∞IndexedDB
                await saveChatSettings();
                
                // 5. Âà∑Êñ∞ÂΩìÂâçÁïåÈù¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                const sizeKB = Math.round(cleanedSize / 1024);
                showToast(`Ê∏ÖÁêÜÂÆåÊàêÔºÅÈáäÊîæ‰∫ÜÁ∫¶ ${sizeKB}KB Á©∫Èó¥ÔºåÂ§ÑÁêÜ‰∫Ü ${cleanedItems} È°πÊï∞ÊçÆ`, 'success');
                
            } catch (error) {
                console.error('Ê∏ÖÁêÜÂ≠òÂÇ®Á©∫Èó¥Â§±Ë¥•:', error);
                showToast('Ê∏ÖÁêÜËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØÔºåËØ∑ÈáçËØï', 'error');
            }
        }
        
        // Ê∏ÖÈô§AIÂä®ÊÄÅÂ§¥ÂÉè
        function clearAiDynamicAvatar() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.aiDynamicAvatar) {
                delete chatSettings.aiDynamicAvatar;
                saveCurrentChatSettings(chatSettings);
                
                // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                showToast('Âä®ÊÄÅÂ§¥ÂÉèÂ∑≤Ê∏ÖÈô§ÔºåÊÅ¢Â§ç‰∏∫ËÅäÂ§©ËÆæÁΩÆÂ§¥ÂÉè', 'success');
            } else {
                showToast('ÂΩìÂâçÊ≤°ÊúâÂä®ÊÄÅÂ§¥ÂÉè', 'info');
            }
        }
        
        // ‰øùÂ≠òËÅäÂ§©Ë∫´‰ªΩÈÄâÊã©
        function saveChatIdentity() {
            if (!window.selectedChatIdentityId) {
                alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ë∫´‰ªΩ');
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const selectedPersona = personas.find(p => p.id === window.selectedChatIdentityId);
            
            if (selectedPersona) {
                chatSettings.selectedIdentityId = selectedPersona.id;
                
                // Â¶ÇÊûúÈÄâ‰∏≠ÁöÑË∫´‰ªΩÊúâÂ§¥ÂÉèÔºåËá™Âä®ËÆæÁΩÆ‰∏∫ËÅäÂ§©Â§¥ÂÉèÔºàÂ¶ÇÊûúÂΩìÂâçÊ≤°ÊúâËÆæÁΩÆÁöÑËØùÔºâ
                if (selectedPersona.avatarUrl && !chatSettings.myChatAvatar) {
                    chatSettings.myChatAvatar = selectedPersona.avatarUrl;
                }
                
                // Â¶ÇÊûúÈÄâ‰∏≠ÁöÑË∫´‰ªΩÊúâÂêçÁß∞ÔºåËá™Âä®ËÆæÁΩÆ‰∏∫ËÅäÂ§©ÊòµÁß∞ÔºàÂ¶ÇÊûúÂΩìÂâçÊ≤°ÊúâËÆæÁΩÆÁöÑËØùÔºâ
                if (selectedPersona.name && !chatSettings.myChatNickname) {
                    chatSettings.myChatNickname = selectedPersona.name;
                }
                
                saveCurrentChatSettings(chatSettings);
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                updateChatIdentityDisplay();
                
                // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                hideModal('identity-selector-modal');
                showToast(`Â∑≤ÈÄâÊã©Ë∫´‰ªΩ"${selectedPersona.name}"`, 'success');
            }
        }
        
        // Êõ¥Êñ∞ËÅäÂ§©Ë∫´‰ªΩÊòæÁ§∫
        function updateChatIdentityDisplay() {
            const chatSettings = getCurrentChatSettings();
            const selectedIdentityId = chatSettings.selectedIdentityId || 'default';
            const selectedPersona = personas.find(p => p.id === selectedIdentityId);
            
            const displayElement = document.getElementById('current-chat-identity');
            if (displayElement && selectedPersona) {
                displayElement.textContent = selectedPersona.name;
            }
        }
        
        // Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑ÂºèÊòæÁ§∫
        function updateBubbleStyleDisplay() {
            const chatSettings = getCurrentChatSettings();
            const styleNames = {
                'default': 'ÈªòËÆ§Ê†∑Âºè',
                'glass': 'ÊØõÁéªÁíÉ',
                'shadow': 'ÁªèÂÖ∏Èò¥ÂΩ±',
                'tail': 'ÁªèÂÖ∏Ê∞îÊ≥°',
                'gradient': 'Ê∏êÂèòÊ†∑Âºè',
                'minimal': 'ÊûÅÁÆÄÊ†∑Âºè',
                'neon': 'ÈúìËôπÊ†∑Âºè',
                'paper': 'Á∫∏Âº†Ê†∑Âºè'
            };
            
            const displayElement = document.getElementById('current-bubble-style');
            if (displayElement) {
                const currentStyle = chatSettings.bubbleStyle || 'default';
                displayElement.textContent = styleNames[currentStyle] || 'ÈªòËÆ§Ê†∑Âºè';
            }
        }
        
        // ÂÖ®Â±ÄÂ§¥ÂÉè‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function handleAvatarUploadClick() {
            console.log('ÁÇπÂáª‰∫Ü‰∏ä‰º†Â§¥ÂÉèÊåâÈíÆ');
            const input = document.getElementById('avatar-upload');
            if (input) {
                console.log('ÊâæÂà∞‰∫ÜinputÂÖÉÁ¥†ÔºåÂáÜÂ§áËß¶ÂèëÁÇπÂáª');
                input.click();
            } else {
                console.error('Êâæ‰∏çÂà∞avatar-uploadÂÖÉÁ¥†');
                alert('Êâæ‰∏çÂà∞Êñá‰ª∂‰∏ä‰º†ÂÖÉÁ¥†ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        // ËØ•ÂáΩÊï∞Â∑≤Ë¢´Âà†Èô§Ôºå‰ΩøÁî®‰∏äÈù¢ÁöÑÂºÇÊ≠•IndexedDBÁâàÊú¨
        
        // Ê∑ªÂä†Ê∂àÊÅØÈïøÊåâÁõëÂê¨Âô®
        function addMessageLongPressListener(messageContainer, messageId) {
            let pressTimer = null;
            let isLongPress = false;
            
            const startLongPress = (e) => {
                if (isMessageSelectionMode) {
                    // Âú®ÈÄâÊã©Ê®°Âºè‰∏ãÔºåÂè™Â§ÑÁêÜÁÇπÂáªÈÄâÊã©Ôºå‰∏çÂ§ÑÁêÜÈïøÊåâ
                    return;
                }
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    enterMessageSelectionMode(messageId);
                    e.preventDefault();
                }, 500);
            };
            
            const cancelLongPress = () => {
                clearTimeout(pressTimer);
                // ÈáçÁΩÆÈïøÊåâÊ†áËÆ∞ÔºåÂª∂ËøüÈáçÁΩÆ‰ª•ÈÅøÂÖçÁ´ãÂç≥Ëß¶ÂèëÁÇπÂáª
                setTimeout(() => {
                    isLongPress = false;
                }, 50);
            };
            
            const handleClick = (e) => {
                // Âú®ÈÄâÊã©Ê®°Âºè‰∏ãÔºåÊâÄÊúâÊ∂àÊÅØÈÉΩÂèØ‰ª•ÁÇπÂáªÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
                if (isMessageSelectionMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMessageSelection(messageId);
                    return;
                }
                
                // Â¶ÇÊûúÊòØÈïøÊåâËß¶ÂèëÂêéÁöÑÁÇπÂáªÔºå‰∏çÂ§ÑÁêÜ
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            };
            
            // Ëß¶Êë∏‰∫ã‰ª∂
            messageContainer.addEventListener('touchstart', startLongPress, { passive: false });
            messageContainer.addEventListener('touchend', cancelLongPress);
            messageContainer.addEventListener('touchmove', cancelLongPress);
            
            // Èº†Ê†á‰∫ã‰ª∂ÔºàÁî®‰∫éÊ°åÈù¢Á´ØÊµãËØïÔºâ
            messageContainer.addEventListener('mousedown', startLongPress);
            messageContainer.addEventListener('mouseup', cancelLongPress);
            messageContainer.addEventListener('mouseleave', cancelLongPress);
            
            // ÁÇπÂáª‰∫ã‰ª∂ - ‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµÁ°Æ‰øù‰ºòÂÖàÂ§ÑÁêÜ
            messageContainer.addEventListener('click', handleClick, true);
        }
        
        // ËøõÂÖ•Ê∂àÊÅØÈÄâÊã©Ê®°Âºè
        function enterMessageSelectionMode(initialMessageId) {
            if (isMessageSelectionMode) {
                return;
            }
            
            isMessageSelectionMode = true;
            selectedMessages.clear();
            selectedMessages.add(initialMessageId);
            
            // Ê∑ªÂä†ÈÄâÊã©Ê®°ÂºèCSSÁ±ª
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.add('selection-mode');
            }
            
            updateMessageSelectionUI();
        }
        
        // ÂàáÊç¢Ê∂àÊÅØÈÄâÊã©Áä∂ÊÄÅ
        function toggleMessageSelection(messageId) {
            if (!isMessageSelectionMode) return;
            
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
            } else {
                selectedMessages.add(messageId);
            }
            
            updateMessageSelectionUI();
            
            // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÔºåÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
            if (selectedMessages.size === 0) {
                exitMessageSelectionMode();
            }
        }
        
        // ÈÄÄÂá∫Ê∂àÊÅØÈÄâÊã©Ê®°Âºè
        function exitMessageSelectionMode() {
            if (!isMessageSelectionMode) return;
            
            isMessageSelectionMode = false;
            
            // ÁßªÈô§ÈÄâÊã©Ê®°ÂºèCSSÁ±ª
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.remove('selection-mode');
            }
            
            // üî•„Äê‰øÆÂ§ç„ÄëÊ∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅÔºåÂåÖÊã¨Êí§ÂõûÊ∂àÊÅØ
            const selectedContainers = document.querySelectorAll('[data-message-id].selected');
            selectedContainers.forEach(container => {
                container.classList.remove('selected');
            });
            
            selectedMessages.clear();
            updateMessageSelectionUI();
        }
        

        
        // Êõ¥Êñ∞Ê∂àÊÅØÈÄâÊã©UI
        function updateMessageSelectionUI() {
            // üî•„Äê‰øÆÂ§ç„ÄëÊü•ÊâæÊâÄÊúâÂ∏¶ÊúâmessageIdÁöÑÂÆπÂô®ÔºåÂåÖÊã¨Êí§ÂõûÊ∂àÊÅØ
            const allContainers = document.querySelectorAll('[data-message-id]');
            
            allContainers.forEach(container => {
                const messageId = container.dataset.messageId;
                if (messageId) {
                    if (selectedMessages.has(messageId)) {
                        container.classList.add('selected');
                    } else {
                        container.classList.remove('selected');
                    }
                }
            });
            
            // Êõ¥Êñ∞ÈÄâÊã©ËÆ°Êï∞ÊòæÁ§∫
            const countElement = document.getElementById('selection-count');
            if (countElement) {
                countElement.textContent = `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`;
            }
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØ
        function deleteSelectedMessages() {
            if (selectedMessages.size === 0) return;
            
            if (!currentChatCharacter) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                const characterId = currentChatCharacter.id;
                
                if (chatMessages[characterId]) {
                    // üî•„Äê‰øÆÂ§ç„ÄëËøáÊª§ÊéâÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÔºåÂêåÊó∂Âà†Èô§Áõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫
                    const messagesToDelete = new Set(selectedMessages);
                    
                    // Êü•ÊâæÊâÄÊúâË¶ÅÂà†Èô§ÁöÑÊ∂àÊÅØÂÜÖÂÆπÔºåÁî®‰∫éÂåπÈÖçÁõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫
                    const deleteContentSet = new Set();
                    chatMessages[characterId].forEach(message => {
                        if (selectedMessages.has(message.id) && message.content) {
                            deleteContentSet.add(message.content);
                        }
                    });
                    
                    // ËøáÊª§Ê∂àÊÅØÔºöÂà†Èô§ÈÄâ‰∏≠Ê∂àÊÅØ + Áõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫
                    chatMessages[characterId] = chatMessages[characterId].filter(message => {
                        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØ
                        if (selectedMessages.has(message.id)) {
                            return false;
                        }
                        
                        // Âà†Èô§Áõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫ÔºàÁ≥ªÁªüÊ∂àÊÅØÁ±ªÂûãÔºå‰∏îÂéüÊñáÂåπÈÖçË¶ÅÂà†Èô§ÁöÑÊ∂àÊÅØÔºâ
                        if (message.sender === 'system' && message.type === 'recalled_message' && message.originalContent) {
                            if (deleteContentSet.has(message.originalContent)) {
                                console.log('Âà†Èô§Áõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫:', message.content);
                                return false;
                            }
                        }
                        
                        return true;
                    });
                    
                    saveChatMessages();
                    renderChatMessages(characterId);
                    renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                }
                
                // ÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
                exitMessageSelectionMode();
            }
        }

        // ÊÇ¨ÊµÆÊåâÈíÆÂäüËÉΩ
        // ÂèòÈáèÊéßÂà∂Á≠âÂæÖÂõûÂ§çÁä∂ÊÄÅ
        let isWaitingForReply = false;
        let pendingUserMessage = null;

      // Áî®ËøôÊÆµÊñ∞‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊóßÁöÑ regenerateLastResponse ÂáΩÊï∞
        async function regenerateLastResponse() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            const characterId = currentChatCharacter.id;
            const messages = chatMessages[characterId] || [];
            
            // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØÂèäÂÖ∂ÂØπÂ∫îÁöÑÁî®Êà∑Ê∂àÊÅØ
            let lastAiMessageIndex = -1;
            let lastUserMessageIndex = -1;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender === 'received' && lastAiMessageIndex === -1) {
                    lastAiMessageIndex = i;
                }
                if (lastAiMessageIndex !== -1 && messages[i].sender === 'sent' && lastUserMessageIndex === -1) {
                    lastUserMessageIndex = i;
                    break;
                }
            }
            
            if (lastAiMessageIndex === -1) {
                alert('Ê≤°ÊúâÊâæÂà∞AIÂõûÂ§çÂèØ‰ª•ÈáçÊñ∞ÁîüÊàê');
                return;
            }
            
            if (lastUserMessageIndex === -1) {
                alert('Ê≤°ÊúâÊâæÂà∞ÂØπÂ∫îÁöÑÁî®Êà∑Ê∂àÊÅØ');
                return;
            }

            const userMessage = messages[lastUserMessageIndex];
            
            // Âà†Èô§‰ªéÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÂêéÁöÑÊâÄÊúâAIÊ∂àÊÅØ
            chatMessages[characterId] = messages.slice(0, lastUserMessageIndex + 1);
    await saveChatMessages(); // ‰ΩøÁî® await Á°Æ‰øù‰øùÂ≠òÂÆåÊàê
            renderChatMessages(characterId);
            
            showTypingIndicator();
            
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
            
            try {
                let response;
                
                // üî•„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë‰ΩøÁî®Êñ∞ÁöÑÂ§öÊ®°ÊÄÅÂ§ÑÁêÜÈÄªËæë
                if (Array.isArray(userMessage.content)) {
                    // ËøôÊòØÂ§öÊ®°ÊÄÅÊ∂àÊÅØÔºàÂõæÊñáÔºâ
                    response = await callChatAPI(userMessage.content, currentChatCharacter);
                } else if (userMessage.image) {
                    // ÂÖºÂÆπÊóßÁöÑÂõæÁâáÊ∂àÊÅØÊ†ºÂºè
                    const messageContent = [
                        { type: 'text', text: userMessage.content || "" },
                        { type: 'image_url', image_url: { url: userMessage.image } }
                    ];
                    response = await callChatAPI(messageContent, currentChatCharacter);
                    } else {
                    // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                    response = await callChatAPI(userMessage.content, currentChatCharacter);
                }
                const aiMessages = parseAiResponse(response);
                
                hideTypingIndicator();
                
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
            if (typeof msgData === 'object' && msgData !== null) {
                if (msgData.type === 'voice_message') {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'voice_message', content: msgData.content, timestamp: Date.now() + i * 100 };
                } else if (msgData.type === 'ai_image') {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'ai_image', content: '', image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`, imageDescription: msgData.description, timestamp: Date.now() + i * 100 };
                } else if (msgData.type === 'transfer') {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'transfer', amount: msgData.amount, note: msgData.note, timestamp: Date.now() + i * 100 };
                } else if (msgData.type === 'emoji') {
                    const matchingEmoji = customEmojis.find(emoji => emoji.description === msgData.description);
                    if (matchingEmoji) {
                        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '', image: matchingEmoji.url, isEmoji: true, emojiDescription: matchingEmoji.description, timestamp: Date.now() + i * 100 };
                        addToRecentEmojis({ id: matchingEmoji.id, url: matchingEmoji.url, description: matchingEmoji.description });
                    } else {
                        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: `[Ë°®ÊÉÖÂåÖ"${msgData.description}"‰∏çÂ≠òÂú®]`, timestamp: Date.now() + i * 100 };
                    }
                } else if (msgData.type === 'change_avatar') {
                        if (msgData.avatar_url) {
                            const isValidAvatar = await validateAvatarSource(msgData.avatar_url);
                            if (isValidAvatar) {
                                const success = await changeCharacterAvatarByAI(msgData.avatar_url, msgData.reason || 'ÂøÉÊÉÖÂèòÂåñ');
                            if (success) continue; 
                            else aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[Â§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', timestamp: Date.now() + i * 100 };
                                } else {
                            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[Êó†ÊïàÁöÑÂ§¥ÂÉèÊù•Ê∫êÔºåÂ§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', timestamp: Date.now() + i * 100 };
                                }
                            } else {
                        continue;
                    }
                } else if (msgData.name && msgData.message) {
                    // ËøôÊòØÁæ§ËÅäÁöÑÁâπÊÆäÊ†ºÂºè
                    let senderId = null;
                    if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                        const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                        if (member) senderId = member.id;
                    }

                    // --- ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊ£ÄÊü•Áæ§ËÅäÊ∂àÊÅØÂÜÖÂÆπÊòØÂê¶‰∏∫ÁâπÊÆäÁ±ªÂûã ---
                    if (typeof msgData.message === 'object' && msgData.message.type === 'voice_message') {
                        // Â¶ÇÊûúÊ∂àÊÅØÂÜÖÂÆπÊòØ‰∏Ä‰∏™ËØ≠Èü≥Ê∂àÊÅØÂØπË±°
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', // Âú®Â§ñÂ±ÇÊ∂àÊÅØ‰∏äËÆæÁΩÆÊ≠£Á°ÆÁöÑÁ±ªÂûã
                            name: msgData.name,
                            senderId: senderId,
                            content: msgData.message.content, // ÊèêÂèñÁúüÊ≠£ÁöÑËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ
                            timestamp: Date.now() + i * 100
                        };
                    } else {
                        // ÂØπ‰∫éÊôÆÈÄöÁöÑÊñáÊú¨Ê∂àÊÅØ
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            name: msgData.name,
                            senderId: senderId,
                            content: msgData.message, // ÂÜÖÂÆπÊú¨Ë∫´ÊòØÂ≠óÁ¨¶‰∏≤
                            timestamp: Date.now() + i * 100
                        };
                    }
                    // --- ‰øÆÂ§çÁªìÊùü ---
                        } else {
                    const displayContent = msgData.content || msgData.message || msgData.text || msgData.reply || JSON.stringify(msgData);
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                        }
                                            } else {
                aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: String(msgData), timestamp: Date.now() + i * 100 };
                    }
                    
                    chatMessages[characterId].push(aiMessage);
            await saveChatMessages();
                    renderChatMessages(characterId);
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•:', error);
                hideTypingIndicator();
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•: ${error.message}]`,
                    timestamp: Date.now()
                };
                chatMessages[characterId].push(errorMessage);
        await saveChatMessages();
                renderChatMessages(characterId);
            }
            
            updateFloatingButtonsVisibility();
        }

        // Êô∫ËÉΩÂõûÂ§çÂäüËÉΩ
        function triggerSmartReply() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            if (isWaitingForReply) {
                // üî•„Äê‰øÆÂ§ç„Äë‰∏ç‰ΩøÁî®ÂºπÁ™óÔºåÊîπ‰∏∫ÊòæÁ§∫ÊåâÈíÆÁä∂ÊÄÅÊèêÁ§∫
                return;
            }

            const messages = chatMessages[currentChatCharacter.id] || [];
            
            // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
            let lastUserMessage = null;
            let hasUnrepliedUserMessage = false;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender === 'sent') {
                    lastUserMessage = messages[i];
                    
                    // Ê£ÄÊü•ËøôÊù°Áî®Êà∑Ê∂àÊÅØÂêéÊòØÂê¶ÊúâAIÂõûÂ§ç
                    hasUnrepliedUserMessage = true;
                    for (let j = i + 1; j < messages.length; j++) {
                        if (messages[j].sender === 'received') {
                            hasUnrepliedUserMessage = false;
                            break;
                        }
                    }
                    break;
                }
            }
            
            // ÊÉÖÂÜµ1ÔºöÊúâÊú™ÂõûÂ§çÁöÑÁî®Êà∑Ê∂àÊÅØ
            if (lastUserMessage && hasUnrepliedUserMessage) {
                pendingUserMessage = lastUserMessage;
            processAIReply();
                return;
            }
            
            // ÊÉÖÂÜµ2ÔºöÊúÄÂêéÁöÑÁî®Êà∑Ê∂àÊÅØÂ∑≤ÊúâAIÂõûÂ§çÔºåÈúÄË¶ÅAIÁª≠ÂÜô
            if (lastUserMessage && !hasUnrepliedUserMessage) {
                // Ê£ÄÊü•‰ªéÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÂêéÁöÑAIÂõûÂ§çËΩÆÊï∞
                let aiReplyRounds = 0;
                let lastUserMessageIndex = -1;
                
                // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÁöÑÁ¥¢Âºï
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].sender === 'sent') {
                        lastUserMessageIndex = i;
                        break;
                    }
                }
                
                // ËÆ°ÁÆó‰ªéÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÂêéÁöÑAIÂõûÂ§çËΩÆÊï∞
                // ‰∏ÄËΩÆ = ËøûÁª≠ÁöÑAIÊ∂àÊÅØÁõ¥Âà∞‰∏ã‰∏Ä‰∏™Êñ≠ÁÇπ
                if (lastUserMessageIndex !== -1) {
                    let inAIReplyRound = false;
                    
                    for (let i = lastUserMessageIndex + 1; i < messages.length; i++) {
                        if (messages[i].sender === 'received') {
                            if (!inAIReplyRound) {
                                // ÂºÄÂßãÊñ∞ÁöÑAIÂõûÂ§çËΩÆ
                                aiReplyRounds++;
                                inAIReplyRound = true;
                            }
                            // ÁªßÁª≠ÂΩìÂâçÂõûÂêàÔºàÂ§öÊù°ËøûÁª≠AIÊ∂àÊÅØÁÆó‰∏ÄËΩÆÔºâ
                        } else {
                            // Â¶ÇÊûúÊúâÂÖ∂‰ªñÁ±ªÂûãÊ∂àÊÅØÔºåÁªìÊùüÂΩìÂâçÂõûÂêà
                            inAIReplyRound = false;
                        }
                    }
                }
                
                // AIÂõûÂ§çÈÄªËæëÔºö
                // aiReplyRounds = 0: Ê≤°ÊúâÂõûÂ§çÁî®Êà∑Ê∂àÊÅØÔºå‰∏çÂ∫îËØ•Âà∞ËøôÈáå
                // aiReplyRounds = 1: Â∑≤ÂõûÂ§çÁî®Êà∑Ê∂àÊÅØ1ËΩÆÔºåÁé∞Âú®ÊòØÁ¨¨1Ê¨°Áª≠ÂÜôÔºàÁ¨¨2ËΩÆÔºâ
                // aiReplyRounds = 2: Â∑≤ÂõûÂ§ç+Áª≠ÂÜô1ËΩÆÔºåÁé∞Âú®ÊòØÁ¨¨2Ê¨°Áª≠ÂÜôÔºàÁ¨¨3ËΩÆÔºâ
                // aiReplyRounds >= 3: Â∑≤ÂõûÂ§ç+Áª≠ÂÜô2ËΩÆÔºåÊèêÁ§∫Áî®Êà∑ÂèëÊ∂àÊÅØ
                
                if (aiReplyRounds >= 3) {
                    const characterName = currentChatCharacter.name;
                    alert(`${characterName}Â∑≤ÁªèËØ¥‰∫ÜÂæàÂ§öËØù‰∫ÜÔºåÂÖàÂíå${characterName}ËØ¥ËØ¥ËØùÂêß~`);
                    return;
                }
                
                // AIÁª≠ÂÜôÂØπËØùÔºàÁ¨¨1Ê¨°ÊàñÁ¨¨2Ê¨°Áª≠ÂÜôÔºâ
                processAIContinuation();
                return;
            }
            
            // ÊÉÖÂÜµ3ÔºöÊ≤°ÊúâÁî®Êà∑Ê∂àÊÅØ
            alert('ËØ∑ÂÖàÂèëÈÄÅ‰∏ÄÊù°Ê∂àÊÅØÔºåÁÑ∂ÂêéÁÇπÂáªÊ≠§ÊåâÈíÆÊù•Ëé∑ÂèñAIÂõûÂ§ç');
        }

        // Â§ÑÁêÜAIÁª≠ÂÜôÂØπËØù
        async function processAIContinuation() {
            if (!currentChatCharacter) return;

            isWaitingForReply = true;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = true;
                smartReplyBtn.style.opacity = '0.65';
                smartReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
            showTypingIndicator();
            
            // Ê∑ªÂä†ÈöèÊú∫Âª∂Ëøü
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                // Ëé∑ÂèñAIÊúÄÂêéÁöÑÊ∂àÊÅØÂÜÖÂÆπÔºå‰ª•‰æøÂü∫‰∫éÊ≠§Áª≠ÂÜô
                const messages = chatMessages[currentChatCharacter.id] || [];
                let lastAIMessage = "";
                
                // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØ
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].sender === 'received') {
                        lastAIMessage = messages[i].content || "";
                        break;
                    }
                }
                
                // ÊûÑÂª∫Áª≠ÂÜôÊèêÁ§∫ËØçÔºåÂü∫‰∫éAIËá™Â∑±ÊúÄÂêéÁöÑËØùÊù•Áª≠ÂÜô
                let continuationPrompt = "‰Ω†ÂàöÊâçËØ¥‰∫ÜÔºö\"" + lastAIMessage + "\"\n\n";
                continuationPrompt += "Áé∞Âú®ËØ∑Âü∫‰∫é‰Ω†ÂàöÊâçËØ¥ÁöÑËØùÔºå‰∏ªÂä®ÁªßÁª≠Ëøô‰∏™ËØùÈ¢òÊàñËÄÖËá™ÁÑ∂Âú∞ËΩ¨Âà∞Áõ∏ÂÖ≥ËØùÈ¢ò„ÄÇÂ∞±ÂÉèÁúüÂÆûËÅäÂ§©‰∏≠Ôºå‰Ω†ÊÉ≥Ë¶ÅÁªßÁª≠Ë°®ËææÊõ¥Â§öÊÉ≥Ê≥ïÔºåÊàñËÄÖËØ¢ÈóÆÂØπÊñπÁöÑÁúãÊ≥ïÔºåÊàñËÄÖÂàÜ‰∫´Áõ∏ÂÖ≥ÁöÑÂÜÖÂÆπ„ÄÇËØ∑Ëá™ÁÑ∂Âú∞ÁªßÁª≠ÂØπËØùÔºå‰∏çË¶ÅÈáçÂ§ç‰πãÂâçËØ¥ËøáÁöÑËØù„ÄÇ";
                continuationPrompt += "\n\nüö® ÈáçË¶ÅÊèêÈÜíÔºöËØ∑‰∏•Ê†ºÈÅµÂÆàJSONÊ†ºÂºèÔºåÊØèÊù°Ê∂àÊÅØÂøÖÈ°ªÂàÜÂºÄÂèëÈÄÅÔºåÁªùÂØπ‰∏çËÉΩÂ∞ÜÂ§öÊù°Ê∂àÊÅØÂêàÂπ∂Âú®‰∏Ä‰∏™ÂÖÉÁ¥†‰∏≠ÔºÅÊ≠£Á°ÆÊ†ºÂºèÔºö[\"Ê∂àÊÅØ1\", \"Ê∂àÊÅØ2\"]ÔºåÈîôËØØÊ†ºÂºèÔºö[\"Ê∂àÊÅØ1\\nÊ∂àÊÅØ2\"]";
                
                const response = await callChatAPI(continuationPrompt, currentChatCharacter);
                const aiMessages = parseAiResponse(response);
                
                hideTypingIndicator();
                
                // ÈÄêÊù°ÂèëÈÄÅÊ∂àÊÅØ
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
                    if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', 
                            content: msgData.content, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image', 
                            content: '',
                            image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`,
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', 
                            amount: msgData.amount, 
                            note: msgData.note, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'emoji') {
                        // Â§ÑÁêÜAIÂèëÈÄÅÁöÑË°®ÊÉÖÂåÖ - ‰ªéÊú¨Âú∞Ë°®ÊÉÖÂåÖÂ∫ì‰∏≠Êü•Êâæ
                        const matchingEmoji = customEmojis.find(emoji => 
                            emoji.description === msgData.description
                        );
                        
                        if (matchingEmoji) {
                            aiMessage = { 
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: '',
                                image: matchingEmoji.url,
                                isEmoji: true,
                                emojiDescription: matchingEmoji.description,
                                timestamp: Date.now() + i * 100
                            };
                            
                            // Â∞ÜË°®ÊÉÖÂåÖÊ∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®
                            addToRecentEmojis({
                                id: matchingEmoji.id,
                                url: matchingEmoji.url,
                                description: matchingEmoji.description
                            });
                        } else {
                            // Â¶ÇÊûúÊâæ‰∏çÂà∞Ë°®ÊÉÖÂåÖÔºåÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                            aiMessage = { 
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: `[Ë°®ÊÉÖÂåÖ"${msgData.description}"‰∏çÂ≠òÂú®]`,
                                timestamp: Date.now() + i * 100
                            };
                        }
                    } else if (typeof msgData === 'object' && msgData.type === 'change_avatar') {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÂ§¥ÂÉèÊõ¥Êç¢ÂØπË±°
                        console.log('Â§ÑÁêÜÂ§¥ÂÉèÊõ¥Êç¢Ê∂àÊÅØ(Áª≠ÂÜô):', msgData);
                        if (msgData.avatar_url) {
                            // È™åËØÅÂ§¥ÂÉèURLÊòØÂê¶Êù•Ëá™Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáÊàñ‰∏ñÁïå‰π¶‰∏≠ÁöÑURL
                            const isValidAvatar = await validateAvatarSource(msgData.avatar_url);
                            console.log('Â§¥ÂÉèÊù•Ê∫êÈ™åËØÅÁªìÊûú(Áª≠ÂÜô):', isValidAvatar, 'Â§¥ÂÉèURL:', msgData.avatar_url);
                            
                            if (isValidAvatar) {
                                // ÊâßË°åÂ§¥ÂÉèÊõ¥Êç¢
                                const success = await changeCharacterAvatarByAI(msgData.avatar_url, msgData.reason || 'ÂøÉÊÉÖÂèòÂåñ');
                                console.log('Â§¥ÂÉèÊõ¥Êç¢ÊâßË°åÁªìÊûú(Áª≠ÂÜô):', success);
                                if (success) {
                                    // Ë∑≥ËøáËøôÊù°Ê∂àÊÅØÔºåÂè™ÊâßË°åÂ§¥ÂÉèÊõ¥Êç¢ÔºåÁ≥ªÁªüÊ∂àÊÅØÂ∑≤Âú®changeCharacterAvatarByAI‰∏≠Ê∑ªÂä†
                                    continue;
                                } else {
                                    aiMessage = { 
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: '[Â§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', 
                                        timestamp: Date.now() + i * 100
                                    };
                                }
                            } else {
                                aiMessage = { 
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: '[Êó†ÊïàÁöÑÂ§¥ÂÉèÊù•Ê∫êÔºåÂ§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', 
                                    timestamp: Date.now() + i * 100
                                };
                            }
                        } else {
                            console.log('Â§¥ÂÉèÊõ¥Êç¢Ê∂àÊÅØÁº∫Â∞ëavatar_url(Áª≠ÂÜô)');
                            continue; // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁöÑÂ§¥ÂÉèURLÔºåË∑≥ËøáÊ≠§Ê∂àÊÅØ
                        }
                    } else if (typeof msgData === 'object' && msgData !== null && msgData.name && msgData.message) {
                        // üî•„ÄêÁæ§ËÅäÊ∂àÊÅØÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÁæ§ËÅäÊ∂àÊÅØÊ†ºÂºè: {name: "ËßíËâ≤Âêç", message: "Ê∂àÊÅØÂÜÖÂÆπ"}
                        console.log('üî• [‰øÆÂ§çcontinuation] ÂèëÁé∞Áæ§ËÅäÊ∂àÊÅØ:', msgData);
                        
                        // Êü•ÊâæÁæ§ÊàêÂëòID
                        let senderId = null;
                        if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                            const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                            if (member) {
                                senderId = member.id;
                            }
                        }
                        
                        // --- ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊ£ÄÊü•Áæ§ËÅäÊ∂àÊÅØÂÜÖÂÆπÊòØÂê¶‰∏∫ÁâπÊÆäÁ±ªÂûã ---
                        if (typeof msgData.message === 'object' && msgData.message.type === 'voice_message') {
                            // Â¶ÇÊûúÊ∂àÊÅØÂÜÖÂÆπÊòØ‰∏Ä‰∏™ËØ≠Èü≥Ê∂àÊÅØÂØπË±°
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                type: 'voice_message', // Âú®Â§ñÂ±ÇÊ∂àÊÅØ‰∏äËÆæÁΩÆÊ≠£Á°ÆÁöÑÁ±ªÂûã
                                name: msgData.name,
                                senderId: senderId,
                                content: msgData.message.content, // ÊèêÂèñÁúüÊ≠£ÁöÑËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ
                                timestamp: Date.now() + i * 100
                            };
                        } else {
                            // ÂØπ‰∫éÊôÆÈÄöÁöÑÊñáÊú¨Ê∂àÊÅØ
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            name: msgData.name,          // ‰øùÂ≠òÂèëË®ÄËÄÖÂêçÂ≠ó
                            senderId: senderId,          // ‰øùÂ≠òÂèëË®ÄËÄÖID
                            content: msgData.message,    // ‰ΩøÁî®messageÂ≠óÊÆµ‰Ωú‰∏∫ÂÜÖÂÆπ
                            timestamp: Date.now() + i * 100
                        };
                        }
                        // --- ‰øÆÂ§çÁªìÊùü ---
                        console.log('‚úÖ [‰øÆÂ§çcontinuation] Áæ§ËÅäÊ∂àÊÅØÂ∑≤Ê≠£Á°ÆËß£Êûê:', aiMessage);
                                            } else {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: String(msgData), 
                            timestamp: Date.now() + i * 100
                        };
                    }
                    
                    chatMessages[currentChatCharacter.id].push(aiMessage);
                    saveChatMessages();
                    addMessageWithAnimation(aiMessage, currentChatCharacter.id);
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('AIÁª≠ÂÜôÂ§±Ë¥•:', error);
                hideTypingIndicator();
                
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[Áª≠ÂÜôÂ§±Ë¥•: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[currentChatCharacter.id].push(errorMessage);
                saveChatMessages();
                addMessageWithAnimation(errorMessage, currentChatCharacter.id);
            } finally {
                // ÈáçÁΩÆÁä∂ÊÄÅ
                isWaitingForReply = false;
                pendingUserMessage = null;
                
                // ÊÅ¢Â§çÊô∫ËÉΩÂõûÂ§çÊåâÈíÆ
                if (smartReplyBtn) {
                    smartReplyBtn.disabled = false;
                    smartReplyBtn.style.opacity = '';
                    smartReplyBtn.style.animation = 'none';
                    smartReplyBtn.classList.remove('waiting');
                    smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    smartReplyBtn.title = 'Ëé∑ÂèñAIÂõûÂ§ç';
                }
                
                // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
                updateFloatingButtonsVisibility();
            }
        }

        // Â§ÑÁêÜAIÂõûÂ§ç
        async function processAIReply() {
            if (!currentChatCharacter) return;
            
            // Êô∫ËÉΩÈÄâÊã©ÊúÄ‰Ω≥ÁöÑÁî®Êà∑Ê∂àÊÅØÔºà‰ºòÂÖàÂõæÁâáÊ∂àÊÅØÔºâ
            const messages = chatMessages[currentChatCharacter.id] || [];
            const userMessages = messages.filter(msg => msg.sender === 'sent');
            
            // ‰ºòÂÖàÊü•ÊâæÊúÄËøëÁöÑÂåÖÂê´ÂõæÁâáÁöÑÊ∂àÊÅØÔºà5Êù°Ê∂àÊÅØÂÜÖÔºâ
            const recentMessages = userMessages.slice(-5);
            const imageMessage = recentMessages.reverse().find(msg => 
                Array.isArray(msg.content) || msg.image
            );
            
            if (imageMessage) {
                pendingUserMessage = imageMessage;
            } else if (!pendingUserMessage) {
                // Â¶ÇÊûúÊ≤°ÊúâÂõæÁâáÊ∂àÊÅØ‰∏îÊ≤°ÊúâÂæÖÂõûÂ§çÊ∂àÊÅØÔºå‰ΩøÁî®ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                const lastUserMessage = userMessages.pop();
                if (lastUserMessage) {
                    pendingUserMessage = lastUserMessage;
                } else {
                    return;
                }
            }

            isWaitingForReply = true;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = true;
                smartReplyBtn.style.opacity = '0.65';
                smartReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
            showTypingIndicator();
            
            // Ê∑ªÂä†ÈöèÊú∫Âª∂Ëøü
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                // Ë∞ÉÁî®APIÔºåÊîØÊåÅÂõæÁâáÂíåË°®ÊÉÖÂåÖ
                const transferMessages = []; // ÁßªÂà∞Â§ñÂ±Ç‰ΩúÁî®Âüü
                
                // üî•„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊ≠£Á°ÆÂ§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØ
                let response;
                

                
                // Ê†∏ÂøÉ‰øÆÂ§çÔºöÁõ¥Êé•Â∞Ü pendingUserMessage.content (ÂèØËÉΩÊòØÊï∞ÁªÑ) ‰º†ÈÄíÁªô callChatAPI
                if (Array.isArray(pendingUserMessage.content)) {
                    // ËøôÊòØÂ§öÊ®°ÊÄÅÊ∂àÊÅØÔºàÂõæÊñáÔºâ
                    response = await callChatAPI(pendingUserMessage.content, currentChatCharacter);
                } else if (pendingUserMessage.image) {
                    // ÂÖºÂÆπÊóßÁöÑÂõæÁâáÊ∂àÊÅØÊ†ºÂºè
                    const messageContent = [
                        { type: 'text', text: pendingUserMessage.content || "" },
                        { type: 'image_url', image_url: { url: pendingUserMessage.image } }
                    ];
                    response = await callChatAPI(messageContent, currentChatCharacter);
                        } else {
                    // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ„ÄÅ‰ΩçÁΩÆÊ∂àÊÅØ„ÄÅËØ≠Èü≥Ê∂àÊÅØÁ≠â
                    response = await callChatAPI(pendingUserMessage.content, currentChatCharacter);
                }
                
                const aiMessages = parseAiResponse(response);
                
                // Â§ÑÁêÜÊâÄÊúâËΩ¨Ë¥¶Ê∂àÊÅØ
                if (transferMessages.length > 0) {
                    for (const transferMsg of transferMessages) {
                        await processUserTransfer(transferMsg, aiMessages);
                    }
                }
                
// --- ËØ∑Áî®ËøôÊÆµÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÊõøÊç¢ ---
                hideTypingIndicator();
                
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
    let aiMessage; // ÂÖàÂ£∞ÊòéÂèòÈáè

    if (typeof msgData === 'object' && msgData !== null) {
        if (msgData.type === 'voice_message') {
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'voice_message', content: msgData.content, timestamp: Date.now() + i * 100 };
        } else if (msgData.type === 'ai_image') {
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'ai_image', content: '', image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`, imageDescription: msgData.description, timestamp: Date.now() + i * 100 };
        } else if (msgData.type === 'transfer') {
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'transfer', amount: msgData.amount, note: msgData.note, timestamp: Date.now() + i * 100 };
        } else if (msgData.type === 'emoji') {
            const matchingEmoji = customEmojis.find(emoji => emoji.description === msgData.description);
                        if (matchingEmoji) {
                aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '', image: matchingEmoji.url, isEmoji: true, emojiDescription: matchingEmoji.description, timestamp: Date.now() + i * 100 };
                addToRecentEmojis({ id: matchingEmoji.id, url: matchingEmoji.url, description: matchingEmoji.description });
                        } else {
                aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: `[Ë°®ÊÉÖÂåÖ"${msgData.description}"‰∏çÂ≠òÂú®]`, timestamp: Date.now() + i * 100 };
            }
        } else if (msgData.type === 'change_avatar') {
                        if (msgData.avatar_url) {
                            const isValidAvatar = await validateAvatarSource(msgData.avatar_url);
                            if (isValidAvatar) {
                                const success = await changeCharacterAvatarByAI(msgData.avatar_url, msgData.reason || 'ÂøÉÊÉÖÂèòÂåñ');
                    if (success) continue; 
                    else aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[Â§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', timestamp: Date.now() + i * 100 };
                                } else {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[Êó†ÊïàÁöÑÂ§¥ÂÉèÊù•Ê∫êÔºåÂ§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', timestamp: Date.now() + i * 100 };
                                }
                            } else {
                continue;
            }
        } else if (msgData.name && msgData.message) {
            // ËøôÊòØÁæ§ËÅäÁöÑÁâπÊÆäÊ†ºÂºè
            let senderId = null;
            if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                if (member) senderId = member.id;
            }

            // --- ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊ£ÄÊü•Áæ§ËÅäÊ∂àÊÅØÂÜÖÂÆπÊòØÂê¶‰∏∫ÁâπÊÆäÁ±ªÂûã ---
            if (typeof msgData.message === 'object' && msgData.message.type === 'voice_message') {
                // Â¶ÇÊûúÊ∂àÊÅØÂÜÖÂÆπÊòØ‰∏Ä‰∏™ËØ≠Èü≥Ê∂àÊÅØÂØπË±°
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    type: 'voice_message', // Âú®Â§ñÂ±ÇÊ∂àÊÅØ‰∏äËÆæÁΩÆÊ≠£Á°ÆÁöÑÁ±ªÂûã
                    name: msgData.name,
                    senderId: senderId,
                    content: msgData.message.content, // ÊèêÂèñÁúüÊ≠£ÁöÑËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ
                    timestamp: Date.now() + i * 100
                };
            } else {
                // ÂØπ‰∫éÊôÆÈÄöÁöÑÊñáÊú¨Ê∂àÊÅØ
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    name: msgData.name,
                    senderId: senderId,
                    content: msgData.message, // ÂÜÖÂÆπÊú¨Ë∫´ÊòØÂ≠óÁ¨¶‰∏≤
                    timestamp: Date.now() + i * 100
                };
            }
            // --- ‰øÆÂ§çÁªìÊùü ---
                    } else {
            // ÂÖ∂‰ªñÊâÄÊúâÊú™Áü•ÂØπË±°ÁöÑÂ§ÑÁêÜ
            const displayContent = msgData.content || msgData.message || msgData.text || msgData.reply || JSON.stringify(msgData);
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                            }
                        } else {
                            // ÊôÆÈÄöÂ≠óÁ¨¶‰∏≤
        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: String(msgData), timestamp: Date.now() + i * 100 };
                    }
                    
                    chatMessages[currentChatCharacter.id].push(aiMessage);
    await saveChatMessages();
                    addMessageWithAnimation(aiMessage, currentChatCharacter.id);
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('AIÂõûÂ§çÂ§±Ë¥•:', error);
                hideTypingIndicator();
                
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[ÂõûÂ§çÂ§±Ë¥•: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[currentChatCharacter.id].push(errorMessage);
                saveChatMessages();
                addMessageWithAnimation(errorMessage, currentChatCharacter.id);
            } finally {
                // ÈáçÁΩÆÁä∂ÊÄÅ
                isWaitingForReply = false;
                pendingUserMessage = null;
                
                // ÊÅ¢Â§çÊô∫ËÉΩÂõûÂ§çÊåâÈíÆ
                if (smartReplyBtn) {
                    smartReplyBtn.disabled = false;
                    smartReplyBtn.style.opacity = '';
                    smartReplyBtn.style.animation = 'none';
                    smartReplyBtn.classList.remove('waiting');
                    smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    smartReplyBtn.title = 'Ëé∑ÂèñAIÂõûÂ§ç';
                }
                
                // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
                updateFloatingButtonsVisibility();
            }
        }

        // ÈáçÁΩÆÊÇ¨ÊµÆÊåâÈíÆÁä∂ÊÄÅ
        function resetFloatingButtonsState() {
            // ÈáçÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = null;
            isWaitingForReply = false;
            
            // ÈáçÁΩÆÊô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = false;
                smartReplyBtn.style.opacity = '';
                smartReplyBtn.style.animation = 'none';
                smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                smartReplyBtn.title = 'Ëé∑ÂèñAIÂõûÂ§ç';
                smartReplyBtn.classList.remove('waiting');
            }
            
            // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
            updateFloatingButtonsVisibility();
        }

        // Êõ¥Êñ∞ÊÇ¨ÊµÆÊåâÈíÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        function updateFloatingButtonsVisibility() {
            if (!currentChatCharacter) return;
            
            const regenerateBtn = document.getElementById('regenerate-btn');
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            const messages = chatMessages[currentChatCharacter.id] || [];
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâAIÊ∂àÊÅØÂèØ‰ª•ÈáçÊñ∞ÁîüÊàê
            const hasAIMessages = messages.some(msg => msg.sender === 'received');
            
            if (regenerateBtn) {
                if (hasAIMessages) {
                    regenerateBtn.classList.remove('hidden');
                } else {
                    regenerateBtn.classList.add('hidden');
                }
            }
            
            if (smartReplyBtn) {
                // Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÊÄªÊòØÊòæÁ§∫
                smartReplyBtn.classList.remove('hidden');
            }
        }

        // ‰øÆÊîπÂéüÊù•ÁöÑsendApiMessageÂáΩÊï∞Ôºå‰ΩøÂÖ∂Âè™ÂèëÈÄÅÊ∂àÊÅØÂà∞ÁïåÈù¢Ôºå‰∏çËß¶ÂèëAIÂõûÂ§ç
        async function sendApiMessage() {
            const input = document.getElementById('api-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }


            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            const messageId = Date.now().toString();
            const userMessage = {
                id: messageId,
                sender: 'sent',
                content: message,
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(userMessage);
            saveChatMessages();
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            input.value = '';
            
            // ‰ΩøÁî®Âä®ÁîªÊ∑ªÂä†Ê∂àÊÅØËÄå‰∏çÊòØÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®
            addMessageWithAnimation(userMessage, currentChatCharacter.id);
            
            // ËÆæÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = userMessage;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
        }

        // ËØ≠Èü≥ÂΩïÈü≥Áõ∏ÂÖ≥ÂèòÈáè
        let isRecording = false;
        let recordingStartTime = 0;

        // Â§ÑÁêÜËØ≠Èü≥ÂΩïÈü≥
        async function handleVoiceRecording() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            const recordBtn = document.getElementById('voice-record-btn');
            
            if (!isRecording) {
                // ÂºÄÂßãÂΩïÈü≥ - ËøôÈáåÊ®°ÊãüÂΩïÈü≥ËøáÁ®ãÔºåÂÆûÈôÖ‰∏äÂºπÂá∫ËæìÂÖ•Ê°Ü
                isRecording = true;
                recordingStartTime = Date.now();
                recordBtn.classList.add('recording');
                recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                recordBtn.title = 'ÁÇπÂáªÂÅúÊ≠¢ÂΩïÈü≥';
                
                // Ê®°ÊãüÂΩïÈü≥ËΩ¨ÊñáÂ≠óÂäüËÉΩ
                try {
                    const voiceText = await showVoiceInputDialog();
                    if (voiceText && voiceText.trim()) {
                        sendVoiceMessage(voiceText.trim());
                        console.log('ËØ≠Èü≥Ê∂àÊÅØÂèëÈÄÅÊàêÂäü');
                    }
                } catch (error) {
                    // Âè™ÊúâÂú®ÁúüÊ≠£ÂèñÊ∂àÊó∂ÊâçÊòæÁ§∫ÂèñÊ∂àÊ∂àÊÅØ
                    if (error.message === 'Áî®Êà∑ÂèñÊ∂à') {
                        console.log('Áî®Êà∑ÂèñÊ∂à‰∫ÜËØ≠Èü≥ËæìÂÖ•');
                    } else {
                        console.error('ËØ≠Èü≥Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•:', error);
                    }
                }
                
                // ÈáçÁΩÆÂΩïÈü≥Áä∂ÊÄÅ
                resetRecordingState();
            } else {
                // ÂÅúÊ≠¢ÂΩïÈü≥
                resetRecordingState();
            }
        }

        // ÈáçÁΩÆÂΩïÈü≥Áä∂ÊÄÅ
        function resetRecordingState() {
            isRecording = false;
            const recordBtn = document.getElementById('voice-record-btn');
            recordBtn.classList.remove('recording');
            recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            recordBtn.title = 'ËØ≠Èü≥Ê∂àÊÅØ';
        }

        // ÊòæÁ§∫ËØ≠Èü≥ËæìÂÖ•ÂØπËØùÊ°Ü
        function showVoiceInputDialog() {
            return new Promise((resolve, reject) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    width: 280px;
                    max-width: 90%;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                `;

                dialog.innerHTML = `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #333;">ËØ≠Èü≥ËΩ¨ÊñáÂ≠ó</h3>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">ËØ∑ËæìÂÖ•ÊÇ®ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºö</p>
                    </div>
                    <textarea id="voice-text-input" placeholder="Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ..." style="
                        width: 100%;
                        height: 80px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        padding: 10px;
                        font-size: 14px;
                        resize: none;
                        box-sizing: border-box;
                        outline: none;
                    "></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button id="voice-cancel-btn" style="
                            flex: 1;
                            padding: 10px;
                            border: 1px solid #ddd;
                            background: white;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">ÂèñÊ∂à</button>
                        <button id="voice-send-btn" style="
                            flex: 1;
                            padding: 10px;
                            border: none;
                            background: #4a84c1;
                            color: white;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">ÂèëÈÄÅ</button>
                    </div>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                const textInput = dialog.querySelector('#voice-text-input');
                const cancelBtn = dialog.querySelector('#voice-cancel-btn');
                const sendBtn = dialog.querySelector('#voice-send-btn');

                // Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
                setTimeout(() => textInput.focus(), 100);

                // ÂèñÊ∂àÊåâÈíÆ
                cancelBtn.onclick = () => {
                    document.body.removeChild(overlay);
                    reject(new Error('Áî®Êà∑ÂèñÊ∂à'));
                };

                // ÂèëÈÄÅÊåâÈíÆ
                sendBtn.onclick = () => {
                    const text = textInput.value.trim();
                    if (text) {
                        console.log('ËØ≠Èü≥ËæìÂÖ•ÂØπËØùÊ°ÜÔºöÁî®Êà∑ÁÇπÂáªÂèëÈÄÅÔºåÂÜÖÂÆπ:', text);
                        document.body.removeChild(overlay);
                        resolve(text);
                    } else {
                        console.log('ËØ≠Èü≥ËæìÂÖ•ÂØπËØùÊ°ÜÔºöÂÜÖÂÆπ‰∏∫Á©∫ÔºåËÅöÁÑ¶ËæìÂÖ•Ê°Ü');
                        textInput.focus();
                    }
                };

                // ÁÇπÂáªÈÅÆÁΩ©ÂÖ≥Èó≠
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        reject(new Error('Áî®Êà∑ÂèñÊ∂à'));
                    }
                };

                // ÊîØÊåÅÂõûËΩ¶ÂèëÈÄÅ
                textInput.onkeydown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log('ËØ≠Èü≥ËæìÂÖ•Ê°ÜÔºöÁî®Êà∑ÊåâÂõûËΩ¶ÈîÆÂèëÈÄÅ');
                        sendBtn.click();
                    }
                };
            });
        }

                 // ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ
        function sendVoiceMessage(text) {
            console.log('ÂºÄÂßãÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ:', text);
            
            const messageId = Date.now().toString();
            const duration = Math.max(1, Math.ceil(text.length / 8)); // Ê†πÊçÆÊñáÂ≠óÈïøÂ∫¶ËÆ°ÁÆó"ËØ≠Èü≥"Êó∂Èïø
            
            const voiceMessage = {
                id: messageId,
                sender: 'sent',
                type: 'voice',
                content: text,
                duration: duration,
                timestamp: Date.now()
            };

            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }

            chatMessages[currentChatCharacter.id].push(voiceMessage);
            console.log('ËØ≠Èü≥Ê∂àÊÅØÂ∑≤Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï');
            
            saveChatMessages();
            console.log('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò');

            // Ê∑ªÂä†ËØ≠Èü≥Ê∂àÊÅØÂà∞ÁïåÈù¢
            addMessageWithAnimation(voiceMessage, currentChatCharacter.id);
            console.log('ËØ≠Èü≥Ê∂àÊÅØÂ∑≤Ê∑ªÂä†Âà∞ÁïåÈù¢');

            // ËÆæÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = voiceMessage;

            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
            
            console.log('ËØ≠Èü≥Ê∂àÊÅØÂèëÈÄÅÊµÅÁ®ãÂÆåÊàê');
        }

        // ÂàáÊç¢ËØ≠Èü≥ÊñáÊú¨ÊòæÁ§∫
        function toggleVoiceText(voiceElement) {
            const container = voiceElement.closest('.voice-message-container') || voiceElement.closest('.message-container');
            if (!container) return;

            const textContent = container.querySelector('.voice-text-content');
            if (!textContent) {
                // Â¶ÇÊûúÊ≤°ÊúâÊñáÊú¨ÂÆπÂô®ÔºåÂàõÂª∫‰∏Ä‰∏™
                const text = voiceElement.getAttribute('data-text');
                if (!text) return;

                const newTextContent = document.createElement('div');
                newTextContent.className = 'voice-text-content';
                newTextContent.textContent = text;
                
                // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÂÜ≥ÂÆöÊèíÂÖ•‰ΩçÁΩÆ
                if (container.classList.contains('voice-message-container')) {
                    container.appendChild(newTextContent);
                } else {
                    // ‰∏∫ÊóßÊ†ºÂºèÂàõÂª∫ËØ≠Èü≥ÂÆπÂô®
                    const voiceContainer = document.createElement('div');
                    voiceContainer.className = container.classList.contains('sent') ? 'voice-message-container sent' : 'voice-message-container received';
                    
                    // ÁßªÂä®Áé∞ÊúâÁöÑÊ∂àÊÅØÊ∞îÊ≥°Âà∞ËØ≠Èü≥ÂÆπÂô®‰∏≠
                    const bubble = container.querySelector('.message-bubble');
                    if (bubble) {
                        container.removeChild(bubble);
                        voiceContainer.appendChild(bubble);
                        voiceContainer.appendChild(newTextContent);
                        container.appendChild(voiceContainer);
                    }
                }
                
                // ÊòæÁ§∫ÊñáÊú¨
                setTimeout(() => {
                    newTextContent.classList.add('visible');
                }, 10);
                
                return;
            }

            // ÂàáÊç¢ÊñáÊú¨ÊòæÁ§∫/ÈöêËóè
            if (textContent.classList.contains('visible')) {
                textContent.classList.remove('visible');
                setTimeout(() => {
                    textContent.style.display = 'none';
                }, 300);
            } else {
                textContent.style.display = 'block';
                setTimeout(() => {
                    textContent.classList.add('visible');
                }, 10);
            }
        }
        
        // Âä†ËΩΩÂä®ÊÄÅ
        async function loadMoments() {
            try {
                    const momentsList = document.getElementById('moments-list');
                if (!momentsList) return;
                    
                        // Ê∏ÖÁ©∫Áé∞ÊúâÁöÑÂä®ÊÄÅ
                        momentsList.innerHTML = '';
                        
                // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÂä®ÊÄÅÊï∞ÊçÆ
                const momentsData = await db.moments.orderBy('timestamp').reverse().toArray();
                
                if (momentsData.length > 0) {
                    for (const momentData of momentsData) {
                        // Ëé∑ÂèñÁÇπËµûÊï∞
                        const likesCount = await db.momentLikes.where('momentId').equals(momentData.id).count();
                        
                        // Ëé∑ÂèñËØÑËÆ∫Êï∞
                        const commentsCount = await db.momentComments.where('momentId').equals(momentData.id).count();
                        
                        // Ëé∑ÂèñËØÑËÆ∫ÂàóË°®
                        const comments = await db.momentComments.where('momentId').equals(momentData.id).toArray();
                        comments.sort((a, b) => a.timestamp - b.timestamp); // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫è
                        
                            // È™åËØÅÂπ∂Â§ÑÁêÜÂ§¥ÂÉè
                            let avatarToUse = null;
                            if (momentData.avatar && isValidAvatarUrl(momentData.avatar)) {
                                avatarToUse = momentData.avatar;
                            } else {
                                avatarToUse = getDefaultAvatar();
                                // Â¶ÇÊûúÊï∞ÊçÆÂ∫ì‰∏≠Â≠òÂÇ®ÁöÑÂ§¥ÂÉèÊó†ÊïàÔºåÊõ¥Êñ∞Êï∞ÊçÆÂ∫ìËÆ∞ÂΩï
                                if (momentData.avatar && !isValidAvatarUrl(momentData.avatar)) {
                                    console.log(`Ê∏ÖÁêÜÂä®ÊÄÅ ${momentData.id} ÁöÑÊó†ÊïàÂ§¥ÂÉè`);
                                    try {
                                        await db.moments.update(momentData.id, { avatar: avatarToUse });
                                    } catch (error) {
                                        console.error('Êõ¥Êñ∞Âä®ÊÄÅÂ§¥ÂÉèÂ§±Ë¥•:', error);
                                    }
                                }
                            }
                        
                            const momentElement = createMomentElement({
                            id: momentData.id,
                                nickname: momentData.nickname,
                                avatar: avatarToUse,
                                text: momentData.text,
                                images: momentData.images || [],
                                time: momentData.time,
                            timestamp: momentData.timestamp,
                            likes: likesCount,
                            comments: comments
                            });
                            
                            // Ê∑ªÂä†Âà∞Âä®ÊÄÅÂàóË°®
                            momentsList.appendChild(momentElement);
                            
                            // Êõ¥Êñ∞ÁÇπËµûÊòæÁ§∫
                        updateMomentLikeDisplay(momentData.id);
                            
                            // ÊòæÁ§∫Â∑≤ÊúâËØÑËÆ∫
                        if (comments && comments.length > 0) {
                            comments.forEach(comment => {
                                // Á°Æ‰øùËØÑËÆ∫ÊúâtimeÂ≠óÊÆµÔºåÂ¶ÇÊûúÊ≤°ÊúâÂ∞±‰ªétimestampÁîüÊàê
                                if (!comment.time && comment.timestamp) {
                                    comment.time = formatTime(new Date(comment.timestamp));
                                }
                                displayCommentUnderMoment(momentData.id, comment);
                                });
                            }
                    }
                        
                        console.log('ÊàêÂäüÂä†ËΩΩ', momentsData.length, 'Êù°Âä®ÊÄÅ');
                } else {
                    console.log('Ê≤°ÊúâÊâæÂà∞‰øùÂ≠òÁöÑÂä®ÊÄÅÊï∞ÊçÆ');
                }
                
                // ÂêØÂä®Êó∂Èó¥Êõ¥Êñ∞
                startTimeUpdater();
            } catch (error) {
                console.error('Âä†ËΩΩÂä®ÊÄÅÂ§±Ë¥•:', error);
            }
        }
        
        // ÂèëÂ∏ÉÂä®ÊÄÅÁõ∏ÂÖ≥ÂèòÈáè
        let momentImages = [];
        
        // ÊòæÁ§∫ÂèëÂ∏ÉÂä®ÊÄÅÁïåÈù¢
        function showPublishMoment() {
            showApp('publish-moment-screen');
            // ÈáçÁΩÆË°®Âçï
            document.getElementById('moment-text').value = '';
            momentImages = [];
            updateMomentImagesGrid();
            
            // ÈáçÁΩÆÂèëÂ∏ÉÊåâÈíÆÁä∂ÊÄÅ
            const publishBtn = document.querySelector('.publish-btn');
            if (publishBtn) {
                publishBtn.disabled = false;
                publishBtn.textContent = 'ÂèëË°®';
            }
        }
        
        // ÈöêËóèÂèëÂ∏ÉÂä®ÊÄÅÁïåÈù¢
        function hidePublishMoment() {
            showApp('chat-screen');
                                    // ÂàáÊç¢ÂõûÂä®ÊÄÅÊ†áÁ≠æ
            switchChatTab('moments-page');
            // ‰∏çÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩÔºåÂä®ÊÄÅÂ∑≤ÁªèÂú®Êï∞ÊçÆÂ∫ì‰∏≠
        }
        
        // Ê∑ªÂä†ÂõæÁâáÂà∞Âä®ÊÄÅ
        function addMomentImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = function(event) {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    if (momentImages.length < 9) { // ÊúÄÂ§ö9Âº†ÂõæÁâá
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                // ÂéãÁº©ÂõæÁâá
                                const compressedImage = await compressImage(e.target.result, 800, 0.8);
                                momentImages.push(compressedImage);
                                updateMomentImagesGrid();
                            } catch (error) {
                                showToast("ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");                                console.error("ÂéãÁº©ÂõæÁâáÂ§±Ë¥•:", error);
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };
            input.click();
        }
        
        // Âà†Èô§ÂõæÁâá
        function removeMomentImage(index) {
            momentImages.splice(index, 1);
            updateMomentImagesGrid();
        }
        
        // Êõ¥Êñ∞ÂõæÁâáÁΩëÊ†ºÊòæÁ§∫
        function updateMomentImagesGrid() {
            const grid = document.getElementById('moment-images-grid');
            grid.innerHTML = '';
            
            momentImages.forEach((imageData, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'moment-image-item';
                imageItem.innerHTML = `
                    <img src="${imageData}" alt="Âä®ÊÄÅÂõæÁâá">
                    <button class="remove-image-btn" onclick="removeMomentImage(${index})">√ó</button>
                `;
                grid.appendChild(imageItem);
            });
        }
        
        // ÂèëÂ∏ÉÂä®ÊÄÅ
        
        // Ëé∑ÂèñÈªòËÆ§Â§¥ÂÉè
        function getDefaultAvatar() {
            // Â∞ùËØïËé∑ÂèñÂä®ÊÄÅÂ§¥ÂÉèÔºå‰ΩÜË¶ÅÈ™åËØÅÂÖ∂ÊúâÊïàÊÄß
            const momentsAvatar = getMomentsImage("avatarImage");
            if (momentsAvatar && isValidAvatarUrl(momentsAvatar)) {
                return momentsAvatar;
            }
            
            // Â∞ùËØïËé∑ÂèñÁî®Êà∑Â§¥ÂÉèÔºå‰ΩÜË¶ÅÈ™åËØÅÂÖ∂ÊúâÊïàÊÄß
            if (window.userAvatar && isValidAvatarUrl(window.userAvatar)) {
                return window.userAvatar;
            }
            
            // Ê∏ÖÁêÜÊó†ÊïàÁöÑÁî®Êà∑Â§¥ÂÉèÊï∞ÊçÆ
            if (window.userAvatar && !isValidAvatarUrl(window.userAvatar)) {
                console.log('Ê∏ÖÁêÜÊó†ÊïàÁöÑÁî®Êà∑Â§¥ÂÉèÊï∞ÊçÆ');
                window.userAvatar = null;
            }
            
            // Ê∏ÖÁêÜÊó†ÊïàÁöÑÂä®ÊÄÅÂ§¥ÂÉèÊï∞ÊçÆ
            if (momentsAvatar && !isValidAvatarUrl(momentsAvatar)) {
                console.log('Ê∏ÖÁêÜÊó†ÊïàÁöÑÂä®ÊÄÅÂ§¥ÂÉèÊï∞ÊçÆ');
                // ËøôÈáåÈúÄË¶ÅË∞ÉÁî®Ê∏ÖÁêÜÂáΩÊï∞Ôºå‰ΩÜÁî±‰∫égetMomentsImageÁöÑÂ≠òÂÇ®Êú∫Âà∂ÔºåÊàë‰ª¨ÂÖàË∑≥Ëøá
            }
            
            // ËøîÂõûÈªòËÆ§Â§¥ÂÉèÔºà‰ΩøÁî®CSSÁîüÊàêÁöÑÁÆÄÂçïÂ§¥ÂÉèÔºâ
            return "data:image/svg+xml;base64," + btoa(`<svg width="50" height="50" xmlns="http://www.w3.org/2000/svg"><rect width="50" height="50" fill="#f0f0f0"/><circle cx="25" cy="20" r="8" fill="#999"/><circle cx="25" cy="40" r="12" fill="#999"/></svg>`);
        }        async function publishMoment() {
            const text = document.getElementById('moment-text').value.trim();
            const publishBtn = document.querySelector('.publish-btn');
            
            if (!text && momentImages.length === 0) {
                showToast('ËØ∑ËæìÂÖ•ÊñáÂ≠óÊàñÈÄâÊã©ÂõæÁâá');
                return;
            }
            
            // Á¶ÅÁî®ÂèëÂ∏ÉÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§
            publishBtn.disabled = true;
            publishBtn.textContent = 'ÂèëÂ∏É‰∏≠...';
            
            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÊòµÁß∞
            const nickname = document.getElementById('moments-username')?.textContent || 'Êàë';
            
            // ÂàõÂª∫Êñ∞Âä®ÊÄÅ
            const now = new Date();
            const newMoment = {
                id: Date.now(),
                authorId: 'user',
                nickname: nickname,
                avatar: getDefaultAvatar(),
                text: text,
                images: [...momentImages],
                time: formatTime(now),
                timestamp: now.getTime()
            };
            
            try {
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await db.moments.add(newMoment);
                
                // ÊÅ¢Â§çÂèëÂ∏ÉÊåâÈíÆÁä∂ÊÄÅ
                publishBtn.disabled = false;
                publishBtn.textContent = 'ÂèëË°®';
                
                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                showToast('ÂèëÂ∏ÉÊàêÂäüÔºÅ');
                
                // Ê∏ÖÁ©∫Ë°®Âçï
                document.getElementById('moment-text').value = '';
                momentImages = [];
                updateMomentImagesGrid();
                
                // ËøîÂõûÂä®ÊÄÅÈ°µÈù¢
                    hidePublishMoment();
                
                // Áõ¥Êé•Ê∑ªÂä†Âà∞Âä®ÊÄÅÂàóË°®ÔºàÈÅøÂÖçÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™ÂàóË°®Ôºâ
                addMomentToList(newMoment);
                
                // ÂêØÂä®Êó∂Èó¥Êõ¥Êñ∞Âô®
                startTimeUpdater();
                
                // Âª∂ËøüËß¶ÂèëAIËßíËâ≤ÁöÑ‰∫íÂä®
                setTimeout(() => {
                    triggerAIInteractions(newMoment.id, 'like');
                    triggerAIInteractions(newMoment.id, 'comment');
                }, 1000);
                
            } catch (error) {
                console.error('ÂèëÂ∏ÉÂä®ÊÄÅÂ§±Ë¥•:', error);
                showToast('ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                
                // ÊÅ¢Â§çÂèëÂ∏ÉÊåâÈíÆ
                publishBtn.disabled = false;
                publishBtn.textContent = 'ÂèëË°®';
            }
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // Â∞è‰∫é1ÂàÜÈíü
                return 'ÂàöÂàö';
            } else if (diff < 3600000) { // Â∞è‰∫é1Â∞èÊó∂
                return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
            } else if (diff < 86400000) { // Â∞è‰∫é1Â§©
                return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
            } else if (diff < 604800000) { // Â∞è‰∫é1Âë®
                return Math.floor(diff / 86400000) + 'Â§©Ââç';
            } else {
                return date.toLocaleDateString();
            }
        }
        
        // Ê∑ªÂä†Âä®ÊÄÅÂà∞ÂàóË°®
        function addMomentToList(moment) {
            const momentsList = document.getElementById('moments-list');
            const momentElement = createMomentElement(moment);
            
            // ÊèíÂÖ•Âà∞ÂàóË°®ÊúÄÂâçÈù¢
            if (momentsList.firstChild) {
                momentsList.insertBefore(momentElement, momentsList.firstChild);
            } else {
                momentsList.appendChild(momentElement);
            }
        }
        
        // ÂàõÂª∫Âä®ÊÄÅÂÖÉÁ¥†
        function createMomentElement(moment) {
            const momentDiv = document.createElement('div');
            momentDiv.className = 'moment-item';
            
            // ËÆæÁΩÆÂä®ÊÄÅIDÂíåÊó∂Èó¥Êà≥
            momentDiv.setAttribute('data-moment-id', moment.id);
            if (moment.timestamp) {
                momentDiv.setAttribute('data-timestamp', moment.timestamp);
            }
            
            let imagesHtml = '';
            if (moment.images && moment.images.length > 0) {
                imagesHtml = `
                    <div class="moment-images">
                        ${moment.images.map(img => `<img src="${img}" alt="Âä®ÊÄÅÂõæÁâá" onclick="previewImage('${img}')">`).join('')}
                    </div>
                `;
            }
            // Áõ¥Êé•Ëé∑ÂèñËßíËâ≤Â§¥ÂÉè
            let finalAvatar = null;
            if (moment.characterId === 'user') {
                // Áî®Êà∑Âä®ÊÄÅ‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                finalAvatar = moment.avatar || getDefaultAvatar();
            } else {
                // ËßíËâ≤Âä®ÊÄÅÔºö‰ºòÂÖàÂä®ÊÄÅÂ§¥ÂÉèÔºåÁÑ∂ÂêéËßíËâ≤Âç°Â§¥ÂÉè
                finalAvatar = moment.avatar;
                if (!finalAvatar && moment.characterId) {
                    const character = characters.find(c => c.id === moment.characterId);
                    if (character && character.avatarUrl) {
                        finalAvatar = character.avatarUrl;
                    }
                }
            }
            
            momentDiv.innerHTML = `
                <div class="moment-avatar">
                    ${finalAvatar ? 
                        `<img src="${finalAvatar}" alt="Â§¥ÂÉè" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'width: 40px; height: 40px; background-color: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px;\\'>${moment.nickname ? moment.nickname.charAt(0) : '?'}</div>'">` :
                        `<div style="width: 40px; height: 40px; background-color: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px;">${moment.nickname ? moment.nickname.charAt(0) : '?'}</div>`
                    }
                </div>
                <div class="moment-content">
                    <div class="moment-username">${moment.nickname}</div>
                    <div class="moment-text">${formatMomentText(moment.text)}</div>
                    ${imagesHtml}
                    <div class="moment-time-actions" style="margin-top: 8px; padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div class="moment-time">${moment.time}</div>
                        <div class="moment-actions" style="display: flex;">
                        <button class="moment-action-btn" onclick="toggleMomentLike('${moment.id}')" style="margin-right: 8px;">
                            <i class="far fa-heart"></i>
                            <span>${moment.likes || 0}</span>
                        </button>
                        <button class="moment-action-btn" onclick="showMomentComments('${moment.id}')">
                            <i class="far fa-comment"></i>
                            <span>${moment.comments ? moment.comments.length : 0}</span>
                        </button>
                    </div>
                    </div>
                    <div class="moment-footer" style="display: none;">
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®
            addLongPressListener(momentDiv, moment.id);
            
            // ÂºÇÊ≠•Ê£ÄÊü•Âπ∂ËÆæÁΩÆÁî®Êà∑ÁÇπËµûÁä∂ÊÄÅ
            (async () => {
                try {
                    const userLike = await db.momentLikes
                        .where('[momentId+authorId]')
                        .equals([moment.id, 'user'])
                        .first();
                    
                    if (userLike) {
                    const likeBtn = momentDiv.querySelector('.moment-action-btn');
                    const likeIcon = likeBtn.querySelector('i');
                    likeIcon.classList.remove('far');
                    likeIcon.classList.add('fas');
                    likeBtn.classList.add('liked');
                }
                } catch (error) {
                    console.error('Ê£ÄÊü•Áî®Êà∑ÁÇπËµûÁä∂ÊÄÅÂ§±Ë¥•:', error);
            }
            })();
            
            return momentDiv;
        }
        
        // È¢ÑËßàÂõæÁâá
        function previewImage(imageSrc) {
            // ÂàõÂª∫È¢ÑËßàÈÅÆÁΩ©
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            overlay.appendChild(img);
            overlay.onclick = () => document.body.removeChild(overlay);
            document.body.appendChild(overlay);
        }
        
        // Ê≥®ÊÑèÔºösaveMomentsDataÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®DexieÊï∞ÊçÆÂ∫ìÁõ¥Êé•Â≠òÂÇ®
        // Êõ¥Êñ∞ÊñáÂ≠óËÆ°Êï∞
        function updateTextCount() {
            const textarea = document.getElementById('moment-text');
            const countElement = document.getElementById('text-count');
            
            if (textarea && countElement) {
                const currentLength = textarea.value.length;
                const maxLength = 500;
                
                countElement.textContent = `${currentLength}/${maxLength}`;
                
                // ÂΩìÊé•ËøëÈôêÂà∂Êó∂ÊîπÂèòÈ¢úËâ≤
                if (currentLength > maxLength * 0.9) {
                    countElement.style.color = '#ff6b6b';
                } else if (currentLength > maxLength * 0.8) {
                    countElement.style.color = '#ffa500';
                } else {
                    countElement.style.color = '#999';
                }
            }
        }
        
        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 10000;
                font-size: 14px;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }
        
        // Êó∂Èó¥Êõ¥Êñ∞Âô®
        let timeUpdateInterval = null;
        
        function startTimeUpdater() {
            // Ê∏ÖÈô§Â∑≤Â≠òÂú®ÁöÑÂÆöÊó∂Âô®
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
            }
            
            // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°
            updateMomentTimes();
            
            // ÊØèÂàÜÈíüÊõ¥Êñ∞‰∏ÄÊ¨°Êó∂Èó¥ÊòæÁ§∫
            timeUpdateInterval = setInterval(updateMomentTimes, 60000);
        }
        
        function stopTimeUpdater() {
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
                timeUpdateInterval = null;
            }
        }
        
        function updateMomentTimes() {
            try {
                const momentItems = document.querySelectorAll('.moment-item[data-timestamp]');
                
                momentItems.forEach(item => {
                    const timestamp = parseInt(item.getAttribute('data-timestamp'));
                    if (timestamp) {
                        const timeElement = item.querySelector('.moment-time');
                        if (timeElement) {
                            const newTime = formatTime(new Date(timestamp));
                            timeElement.textContent = newTime;
                        }
                    }
                });
            } catch (error) {
                console.error('Êõ¥Êñ∞Âä®ÊÄÅÊó∂Èó¥Â§±Ë¥•:', error);
            }
        }
        
        // Âä®ÊÄÅÈÄâÊã©Ê®°ÂºèÁõ∏ÂÖ≥ÂèòÈáè
        let isSelectionMode = false;
        let selectedMoments = new Set();
        
        // ÂàáÊç¢Âä®ÊÄÅÁÇπËµûÁä∂ÊÄÅ
        async function toggleMomentLike(momentId) {
            if (isSelectionMode) return; // ÈÄâÊã©Ê®°Âºè‰∏ã‰∏çÂìçÂ∫îÁÇπËµû
            
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            const likeBtn = momentElement.querySelector('.moment-action-btn');
            const likeIcon = likeBtn.querySelector('i');
            
            try {
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁÇπËµû
                const existingLike = await db.momentLikes
                    .where('[momentId+authorId]')
                    .equals([parseInt(momentId), 'user'])
                    .first();
            
                if (existingLike) {
                // ÂèñÊ∂àÁÇπËµû
                likeIcon.classList.remove('fas');
                likeIcon.classList.add('far');
                likeBtn.classList.remove('liked');
                    await db.momentLikes.delete([parseInt(momentId), 'user']);
            } else {
                // ÁÇπËµû
                likeIcon.classList.add('fas');
                likeIcon.classList.remove('far');
                likeBtn.classList.add('liked');
                    await db.momentLikes.add({
                        momentId: parseInt(momentId),
                        authorId: 'user',
                    characterId: 'user',
                    name: document.getElementById('moments-username')?.textContent || 'Êàë',
                    timestamp: Date.now()
                });
                
                // Ëß¶ÂèëAIËßíËâ≤Ëá™Âä®ÁÇπËµû
                triggerAIInteractions(momentId, 'like');
            }
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateMomentLikeDisplay(momentId);
            } catch (error) {
                console.error('ÁÇπËµûÊìç‰ΩúÂ§±Ë¥•:', error);
            }
        }
        
        // ÊòæÁ§∫Âä®ÊÄÅËØÑËÆ∫
        function showMomentComments(momentId) {
            if (isSelectionMode) return; // ÈÄâÊã©Ê®°Âºè‰∏ã‰∏çÂìçÂ∫îËØÑËÆ∫
            
            // ÊòæÁ§∫ÁÆÄÂçïËØÑËÆ∫ËæìÂÖ•Ê°Ü
            showSimpleCommentInput(momentId);
            
            // Ëß¶ÂèëAIËßíËâ≤Ëá™Âä®ËØÑËÆ∫
            triggerAIInteractions(momentId, 'comment');
        }
        
        // ÊòæÁ§∫ÁÆÄÂçïËØÑËÆ∫ËæìÂÖ•Ê°Ü
        function showSimpleCommentInput(momentId, replyToNickname = null) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâËæìÂÖ•Ê°Ü
            if (document.querySelector('.simple-comment-input')) {
                closeSimpleCommentInput();
            }
            
            const placeholder = replyToNickname ? `ÂõûÂ§ç ${replyToNickname}...` : 'ÂÜôËØÑËÆ∫...';
            
            const input = document.createElement('div');
            input.className = 'simple-comment-input';
            input.innerHTML = `
                <div class="comment-input-container">
                    <input type="text" placeholder="${placeholder}" maxlength="200" id="simple-comment-${momentId}" data-reply-to="${replyToNickname || ''}">
                    <button onclick="submitSimpleComment('${momentId}')">ÂèëÈÄÅ</button>
                    <button onclick="closeSimpleCommentInput()" class="cancel-btn">ÂèñÊ∂à</button>
                </div>
            `;
            
            input.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #ddd;
                padding: 12px;
                z-index: 1000;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                max-width: 360px;
                margin: 0 auto;
            `;
            
            const container = input.querySelector('.comment-input-container');
            container.style.cssText = `
                display: flex;
                gap: 8px;
                align-items: center;
                max-width: 360px;
                margin: 0 auto;
            `;
            
            const textInput = input.querySelector('input');
            textInput.style.cssText = `
                flex: 1;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 20px;
                font-size: 14px;
            `;
            
            const sendBtn = input.querySelector('button');
            sendBtn.style.cssText = `
                background: #1da1f2;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 16px;
                font-size: 14px;
                cursor: pointer;
            `;
            
            const cancelBtn = input.querySelector('.cancel-btn');
            cancelBtn.style.cssText = `
                background: #f0f0f0;
                color: #666;
                border: none;
                padding: 8px 16px;
                border-radius: 16px;
                font-size: 14px;
                cursor: pointer;
            `;
            
            document.body.appendChild(input);
            
            // Ëá™Âä®ËÅöÁÑ¶
            setTimeout(() => textInput.focus(), 100);
            
            // ÂõûËΩ¶ÂèëÈÄÅ
            textInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitSimpleComment(momentId);
                }
            });
        }
        
        // ÂÖ≥Èó≠ÁÆÄÂçïËØÑËÆ∫ËæìÂÖ•Ê°Ü
        function closeSimpleCommentInput() {
            const input = document.querySelector('.simple-comment-input');
            if (input) {
                document.body.removeChild(input);
            }
        }
        
        // Êèê‰∫§ÁÆÄÂçïËØÑËÆ∫
        function submitSimpleComment(momentId) {
            const input = document.getElementById(`simple-comment-${momentId}`);
            const text = input.value.trim();
            const replyTo = input.getAttribute('data-reply-to');
            
            if (!text) {
                showToast('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ');
                return;
            }
            
            const comment = {
                id: Date.now() + Math.random(),
                nickname: document.getElementById('moments-username')?.textContent || 'Êàë',
                avatar: getDefaultAvatar(),
                text: text,
                time: formatTime(new Date()),
                timestamp: Date.now(),
                replyTo: replyTo || null
            };
            
            // ‰øùÂ≠òËØÑËÆ∫Âà∞Âä®ÊÄÅÊï∞ÊçÆ
            saveCommentToMoment(momentId, comment);
            
            // Êõ¥Êñ∞Âä®ÊÄÅÂàóË°®‰∏≠ÁöÑËØÑËÆ∫Êï∞
            updateMomentCommentCount(momentId);
            
            // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫Êñ∞ËØÑËÆ∫
            displayCommentUnderMoment(momentId, comment);
            
            // ÂÖ≥Èó≠ËæìÂÖ•Ê°Ü
            closeSimpleCommentInput();
            
            showToast('ËØÑËÆ∫ÊàêÂäüÔºÅ');
            
            // Â¶ÇÊûúÁî®Êà∑ÂõûÂ§ç‰∫ÜÊüê‰∏™AIËßíËâ≤ÔºåÊ£ÄÊü•ËΩÆÊ¨°Âπ∂Ëß¶ÂèëËØ•ËßíËâ≤ÁöÑÂõûÂ§ç
            if (replyTo && replyTo !== 'Êàë') {
                const conversationKey = `${momentId}-${replyTo}`;
                const currentRounds = commentConversationRounds.get(conversationKey) || 0;
                
                if (currentRounds < 10) {
                    console.log(`Áî®Êà∑ÂõûÂ§ç‰∫Ü ${replyTo}ÔºåÂΩìÂâçÂØπËØùËΩÆÊ¨°: ${currentRounds}/10ÔºåÂ∞ÜÂú®2-5ÁßíÂêéËß¶ÂèëAIÂõûÂ§ç`);
                    
                    // Áî®Êà∑ÂõûÂ§çÊó∂‰πüË¶ÅÂ¢ûÂä†ËΩÆÊ¨°
                    commentConversationRounds.set(conversationKey, currentRounds + 1);
                    console.log(`Áî®Êà∑ÂõûÂ§çÂêéÔºå${replyTo} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùËΩÆÊ¨°Êõ¥Êñ∞‰∏∫: ${currentRounds + 1}/10`);
                    
                setTimeout(() => {
                    console.log(`ÂºÄÂßãËß¶Âèë ${replyTo} ÂõûÂ§çÁî®Êà∑ËØÑËÆ∫: "${text}"`);
                    triggerAIReplyToUser(momentId, replyTo, text);
                }, Math.random() * 3000 + 2000); // 2-5ÁßíÂêéAIÂõûÂ§ç
                } else {
                    console.log(`${replyTo} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùÂ∑≤ËææÂà∞10ËΩÆ‰∏äÈôêÔºå‰∏çÂÜçÂõûÂ§ç`);
                }
            } else {
                console.log(`Áî®Êà∑ÂèëË°®‰∫ÜËØÑËÆ∫ÔºåreplyTo: ${replyTo}`);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂØπËßíËâ≤Âä®ÊÄÅÁöÑÁõ¥Êé•ËØÑËÆ∫Ôºà‰∏çÊòØÂõûÂ§çÔºâ
                if (!replyTo) {
                    checkAndTriggerCharacterMomentReply(momentId, text);
                }
            }
        }
        
        // Ê£ÄÊü•Âπ∂Ëß¶ÂèëËßíËâ≤Âä®ÊÄÅÁöÑÂõûÂ§ç
        async function checkAndTriggerCharacterMomentReply(momentId, userCommentText) {
            try {
                // Ëé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ
                const moment = await db.moments.get(parseInt(momentId));
                if (!moment || !moment.characterId || moment.characterId === 'user') {
                    console.log('‰∏çÊòØËßíËâ≤ÂèëÂ∏ÉÁöÑÂä®ÊÄÅÔºåË∑≥ËøáËßíËâ≤ÂõûÂ§ç');
                    return;
                }
                
                // Ëé∑ÂèñÂèëÂ∏ÉÂä®ÊÄÅÁöÑËßíËâ≤
                const character = characters.find(c => c.id === moment.characterId);
                if (!character) {
                    console.log(`Êú™ÊâæÂà∞Âä®ÊÄÅÂèëÂ∏ÉËÄÖËßíËâ≤: ${moment.characterId}`);
                    return;
                }
                
                // Ê£ÄÊü•ÂØπËØùËΩÆÊ¨°
                const conversationKey = `${momentId}-${character.name}`;
                const currentRounds = commentConversationRounds.get(conversationKey) || 0;
                
                if (currentRounds >= 10) {
                    console.log(`${character.name} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùÂ∑≤ËææÂà∞10ËΩÆ‰∏äÈôêÔºå‰∏çÂÜçÂõûÂ§ç`);
                    return;
                }
                
                console.log(`Áî®Êà∑ËØÑËÆ∫‰∫Ü ${character.name} ÁöÑÂä®ÊÄÅÔºåÂΩìÂâçÂØπËØùËΩÆÊ¨°: ${currentRounds}/10ÔºåÂ∞ÜÂú®2-5ÁßíÂêéËß¶ÂèëÂõûÂ§ç`);
                
                // Â¢ûÂä†ÂØπËØùËΩÆÊ¨°
                commentConversationRounds.set(conversationKey, currentRounds + 1);
                console.log(`Áî®Êà∑ËØÑËÆ∫ÂêéÔºå${character.name} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùËΩÆÊ¨°Êõ¥Êñ∞‰∏∫: ${currentRounds + 1}/10`);
                
                // Âª∂ËøüÂõûÂ§ç
                setTimeout(() => {
                    console.log(`ÂºÄÂßãËß¶Âèë ${character.name} ÂõûÂ§çÁî®Êà∑ÂØπÂÖ∂Âä®ÊÄÅÁöÑËØÑËÆ∫: "${userCommentText}"`);
                    triggerAIReplyToUser(momentId, character.name, userCommentText);
                }, Math.random() * 3000 + 2000); // 2-5ÁßíÂêéAIÂõûÂ§ç
                
            } catch (error) {
                console.error('Ê£ÄÊü•ËßíËâ≤Âä®ÊÄÅÂõûÂ§çÂ§±Ë¥•:', error);
            }
        }
        
        // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫ËØÑËÆ∫
        function displayCommentUnderMoment(momentId, comment) {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            // Êü•ÊâæÊàñÂàõÂª∫ËØÑËÆ∫Âå∫Âüü
            let commentsSection = momentElement.querySelector('.moment-comments-section');
            if (!commentsSection) {
                commentsSection = document.createElement('div');
                commentsSection.className = 'moment-comments-section';
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÁÇπËµûÂå∫ÂüüÔºåÂÜ≥ÂÆömargin-top
                const likesDisplay = momentElement.querySelector('.likes-display');
                const marginTop = likesDisplay ? '0' : '0';
                
                commentsSection.style.cssText = `
                    margin-top: ${marginTop};
                    padding: 8px 12px;
                    background: #f8f9fa;
                    font-size: 13px;
                `;
                
                // ÊèíÂÖ•Âà∞Ê≠£Á°Æ‰ΩçÁΩÆÔºöÁÇπËµûÂå∫ÂêéÈù¢ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâÔºåÂê¶ÂàôÂú®Êó∂Èó¥Êìç‰ΩúÂå∫ÂêéÈù¢
                const momentContent = momentElement.querySelector('.moment-content');
                const momentTimeActions = momentElement.querySelector('.moment-time-actions');
                
                if (momentContent && momentTimeActions) {
                if (likesDisplay) {
                        // Â¶ÇÊûúÊúâÁÇπËµûÂå∫ÔºåÊèíÂÖ•Âà∞ÁÇπËµûÂå∫ÂêéÈù¢
                    likesDisplay.parentNode.insertBefore(commentsSection, likesDisplay.nextSibling);
                    } else {
                        // Ê≤°ÊúâÁÇπËµûÂå∫ÔºåÊèíÂÖ•Âà∞Êó∂Èó¥Êìç‰ΩúÂå∫ÂêéÈù¢
                    momentTimeActions.parentNode.insertBefore(commentsSection, momentTimeActions.nextSibling);
                    }
                }
            }
            
            // ÂàõÂª∫ËØÑËÆ∫ÂÖÉÁ¥†
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-item';
            commentDiv.style.cssText = `
                display: flex;
                gap: 8px;
                margin-bottom: 8px;
                align-items: flex-start;
            `;
            
            // Â§ÑÁêÜÂõûÂ§çÊ†ºÂºè
            let commentText = comment.text;
            if (comment.replyTo) {
                commentText = `ÂõûÂ§ç<span style="margin: 0 2px; color: #576b95; font-weight: 600;">${comment.replyTo}</span>: ${comment.text}`;
            }
            
            commentDiv.innerHTML = `
                <img src="${comment.avatar}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
                <div style="flex: 1; line-height: 1.4; cursor: pointer;" onclick="replyToMomentComment('${momentId}', '${comment.nickname}')">
                    <span style="color: #576b95; font-weight: 600;">${comment.nickname}${comment.replyTo ? '' : 'Ôºö'}</span><span style="margin-left: 2px; color: #333;">${commentText}</span>
                    <div style="color: #999; font-size: 11px; margin-top: 2px;">${comment.time}</div>
                </div>
            `;
            
            commentsSection.appendChild(commentDiv);
        }
        
        // ÂõûÂ§çÂä®ÊÄÅËØÑËÆ∫
        function replyToMomentComment(momentId, nickname) {
            // ÊòæÁ§∫ËØÑËÆ∫ËæìÂÖ•Ê°ÜÔºåÂπ∂ËÆæÁΩÆ‰∏∫ÂõûÂ§çÊ®°Âºè
            showSimpleCommentInput(momentId, nickname);
        }
        

        
        // ‰øùÂ≠òËØÑËÆ∫Âà∞Âä®ÊÄÅÊï∞ÊçÆ
        async function saveCommentToMoment(momentId, comment) {
            try {
                const commentData = {
                    id: comment.id,
                    momentId: parseInt(momentId),
                    authorId: comment.characterId || 'user',
                    nickname: comment.nickname,
                    avatar: comment.avatar,
                    text: comment.text,
                    timestamp: comment.timestamp,
                    replyTo: comment.replyTo || null
                };
                
                await db.momentComments.add(commentData);
                console.log('ËØÑËÆ∫Â∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÂä®ÊÄÅID:', momentId);
            } catch (error) {
                console.error('‰øùÂ≠òËØÑËÆ∫Â§±Ë¥•:', error);
            }
        }
        
        // Êõ¥Êñ∞Âä®ÊÄÅËØÑËÆ∫Êï∞
        async function updateMomentCommentCount(momentId) {
            try {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
                const commentsCount = await db.momentComments.where('momentId').equals(parseInt(momentId)).count();
            
                const commentBtn = momentElement.querySelectorAll('.moment-action-btn')[1];
                const commentCount = commentBtn.querySelector('span');
                commentCount.textContent = commentsCount;
            } catch (error) {
                console.error('Êõ¥Êñ∞ËØÑËÆ∫Êï∞Â§±Ë¥•:', error);
            }
        }
        
        // Ëß¶ÂèëAIËßíËâ≤‰∫íÂä®
        async function triggerAIInteractions(momentId, type) {
            try {
            if (!characters || characters.length === 0) return;
            
            // Ëé∑ÂèñÂΩìÂâçÂä®ÊÄÅ‰ø°ÊÅØ
                const moment = await db.moments.get(parseInt(momentId));
            if (!moment) return;
            
                const publisherCharacterId = moment.characterId;
                
                // Â¶ÇÊûúÊòØÁî®Êà∑ÂèëÁöÑÂä®ÊÄÅ
                if (!publisherCharacterId || publisherCharacterId === 'user') {
                    console.log('Áî®Êà∑ÂèëÂ∏ÉÂä®ÊÄÅÔºåÊâÄÊúâËßíËâ≤80%Ê¶ÇÁéá‰∫íÂä®');
                    // Áî®Êà∑ÂèëÂä®ÊÄÅÔºöÊâÄÊúâËÅîÁ≥ª‰∫∫ËßíËâ≤ÈÉΩÊúâ80%Ê¶ÇÁéá‰∫íÂä®
            const contactCharacters = characters.filter(char => contacts.includes(char.id));
            
            if (type === 'like') {
                for (const character of contactCharacters) {
                    if (Math.random() < 0.8) {
                                setTimeout(() => {
                                    addAILike(momentId, character, moment);
                                }, Math.random() * 3000 + 1000);
                    }
                }
            } else if (type === 'comment') {
                for (const character of contactCharacters) {
                    if (Math.random() < 0.8) {
                            setTimeout(async () => {
                                await addAIComment(momentId, character, moment);
                                }, Math.random() * 5000 + 2000);
                    }
                }
                    }
                } else {
                    console.log('ËßíËâ≤ÂèëÂ∏ÉÂä®ÊÄÅÔºåÂè™ÊúâÂêåÁæ§ËßíËâ≤50%Ê¶ÇÁéá‰∫íÂä®');
                    // ËßíËâ≤ÂèëÂä®ÊÄÅÔºöÂè™ÊúâÂêåÁæ§ËßíËâ≤Êúâ50%Ê¶ÇÁéá‰∫íÂä®
                    const relatedCharacters = getCharactersInSameGroups(publisherCharacterId);
                
                    if (type === 'like') {
                        for (const character of relatedCharacters) {
                            if (Math.random() < 0.5) {
                    setTimeout(() => {
                                    addAILike(momentId, character, moment);
                                }, Math.random() * 3000 + 1000);
                            }
                        }
                    } else if (type === 'comment') {
                        for (const character of relatedCharacters) {
                            if (Math.random() < 0.5) {
                                setTimeout(async () => {
                                    await addAIComment(momentId, character, moment);
                                }, Math.random() * 5000 + 2000);
                            }
                        }
                        
                        // Ëß¶ÂèëÂêåÁæ§ËßíËâ≤Èó¥ÁöÑ50%Ê¶ÇÁéá‰∫íÂä®
                        setTimeout(() => {
                            triggerAiToAiInteraction(momentId, relatedCharacters);
                        }, Math.random() * 8000 + 5000);
                    }
                }
            } catch (error) {
                console.error('Ëß¶ÂèëAI‰∫íÂä®Â§±Ë¥•:', error);
            }
        }
        
        // Ëé∑Âèñ‰∏éÊåáÂÆöËßíËâ≤Âú®Âêå‰∏Ä‰∏™Áæ§ËÅäÁöÑÂÖ∂‰ªñËßíËâ≤
        function getCharactersInSameGroups(characterId) {
            const sameGroupCharacters = [];
            
            // ÈÅçÂéÜÊâÄÊúâÁæ§ËÅä
            groupChats.forEach(group => {
                if (group.members && group.members.includes(characterId)) {
                    // ÊâæÂà∞ÂåÖÂê´ËØ•ËßíËâ≤ÁöÑÁæ§ËÅäÔºåËé∑ÂèñÁæ§ÂÜÖÂÖ∂‰ªñËßíËâ≤
                    group.members.forEach(memberId => {
                        if (memberId !== characterId && memberId !== 'user') {
                            const character = characters.find(c => c.id === memberId);
                            if (character && !sameGroupCharacters.find(c => c.id === character.id)) {
                                sameGroupCharacters.push(character);
                            }
                        }
                    });
                }
            });
            
            return sameGroupCharacters;
        }
        
        // AIËßíËâ≤ÁÇπËµû
        async function addAILike(momentId, character, moment) {
            try {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÁÇπËµûËøá
                const existingLike = await db.momentLikes
                    .where('[momentId+authorId]')
                    .equals([parseInt(momentId), character.id])
                    .first();
                
                if (existingLike) return;
            
                // Âü∫‰∫éËßíËâ≤‰∫∫ËÆæÂÜ≥ÂÆöÊòØÂê¶ÁúüÁöÑÁÇπËµû
                const shouldLike = await shouldCharacterLikeMoment(character, moment);
                if (!shouldLike) {
                    console.log(`${character.name} Âü∫‰∫é‰∫∫ËÆæÈÄâÊã©‰∏çÁÇπËµûËøôÊù°Âä®ÊÄÅ`);
                    return;
                }
            
            // Ê∑ªÂä†ÁÇπËµûËÆ∞ÂΩï
                await db.momentLikes.add({
                    momentId: parseInt(momentId),
                    authorId: character.id,
                characterId: character.id,
                name: character.name,
                timestamp: Date.now()
            });
            
            // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
            updateMomentLikeDisplay(momentId);
            
            // ÊòæÁ§∫ÁÇπËµûÊèêÁ§∫
            showToast(`${character.name} Ëµû‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`);
            } catch (error) {
                console.error('AIÁÇπËµûÂ§±Ë¥•:', error);
            }
        }
        
        // Âà§Êñ≠ËßíËâ≤ÊòØÂê¶‰ºöÁÇπËµûËøôÊù°Âä®ÊÄÅ
        async function shouldCharacterLikeMoment(character, moment) {
            try {
                // Âü∫‰∫éËßíËâ≤‰∫∫ËÆæÂíåÂä®ÊÄÅÂÜÖÂÆπÁöÑÁÆÄÂçïÂà§Êñ≠
                const characterBio = (character.bio || '').toLowerCase();
                const momentText = (moment.text || '').toLowerCase();
                
                // Â¶ÇÊûúËßíËâ≤‰∫∫ËÆæ‰∏≠ÂåÖÂê´Ë¥üÈù¢ËØçÊ±áÔºåÈôç‰ΩéÁÇπËµûÊ¶ÇÁéá
                const negativeTraits = ['ÂÜ∑Êº†', '‰∏•ËÇÉ', '‰∏çÂñÑ‰∫§ÈôÖ', 'ÂÜÖÂêë', 'Ê≤âÈªò'];
                const hasNegativeTraits = negativeTraits.some(trait => characterBio.includes(trait));
                
                if (hasNegativeTraits && Math.random() < 0.7) {
                    return false; // 70%Ê¶ÇÁéá‰∏çÁÇπËµû
                }
                
                // Â¶ÇÊûúÂä®ÊÄÅÂÜÖÂÆπ‰∏éËßíËâ≤ÂÖ¥Ë∂£Áõ∏ÂÖ≥ÔºåÂ¢ûÂä†ÁÇπËµûÊ¶ÇÁéá
                const characterInterests = extractInterestsFromBio(characterBio);
                const hasRelatedContent = characterInterests.some(interest => 
                    momentText.includes(interest)
                );
                
                if (hasRelatedContent) {
                    return Math.random() < 0.9; // 90%Ê¶ÇÁéáÁÇπËµû
                }
                
                // ÈªòËÆ§ÊÉÖÂÜµ
                return Math.random() < 0.7; // 70%Ê¶ÇÁéáÁÇπËµû
            } catch (error) {
                console.error('Âà§Êñ≠ËßíËâ≤ÁÇπËµûÂÅèÂ•ΩÂ§±Ë¥•:', error);
                return Math.random() < 0.6; // ÈªòËÆ§60%Ê¶ÇÁéá
            }
        }
        
        // ‰ªéËßíËâ≤‰∫∫ËÆæ‰∏≠ÊèêÂèñÂÖ¥Ë∂£ÂÖ≥ÈîÆËØç
        function extractInterestsFromBio(bio) {
            const interests = [];
            const interestKeywords = [
                'Èü≥‰πê', 'ÁîµÂΩ±', 'ËØª‰π¶', 'ËøêÂä®', 'Ê∏∏Êàè', 'ÁæéÈ£ü', 'ÊóÖË°å', 'ÊëÑÂΩ±',
                'ÁªòÁîª', 'ÂÜô‰Ωú', '‰ª£Á†Å', 'ÁßëÊäÄ', 'Âä®Êº´', 'Â∞èËØ¥', 'ÂíñÂï°', 'Ëå∂',
                'ÂÆ†Áâ©', 'Ëä±', 'ÊòüÁ©∫', 'Èõ®Â§©', 'Èò≥ÂÖâ', 'Â≠¶‰π†', 'Â∑•‰Ωú', 'ÊúãÂèã'
            ];
            
            interestKeywords.forEach(keyword => {
                if (bio.includes(keyword)) {
                    interests.push(keyword);
                }
            });
            
            return interests;
        }
        
        // Êõ¥Êñ∞Âä®ÊÄÅÁÇπËµûÊòæÁ§∫
        async function updateMomentLikeDisplay(momentId) {
            try {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
                const momentLikes = await db.momentLikes.where('momentId').equals(parseInt(momentId)).toArray();
            
            // Êõ¥Êñ∞ÁÇπËµûÊåâÈíÆÊï∞Â≠ó
            const likeBtn = momentElement.querySelector('.moment-action-btn[onclick*="toggleMomentLike"]');
            if (likeBtn) {
                const likeCount = likeBtn.querySelector('span');
                if (likeCount) {
                    likeCount.textContent = momentLikes.length;
                }
            }
            
            // Êõ¥Êñ∞ÊàñÂàõÂª∫ÁÇπËµûÁî®Êà∑ÂêçÁß∞ÊòæÁ§∫
            let likesDisplay = momentElement.querySelector('.likes-display');
            
            if (momentLikes.length > 0) {
                if (!likesDisplay) {
                    likesDisplay = document.createElement('div');
                    likesDisplay.className = 'likes-display';
                    
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâËØÑËÆ∫Âå∫ÂüüÔºåÂ¶ÇÊûúÊúâÂ∞±‰∏çËÆæÁΩÆmargin-top
                        const existingCommentsSection = momentElement.querySelector('.moment-comments-section');
                        const marginTop = existingCommentsSection ? '0' : '0';
                    
                    likesDisplay.style.cssText = `
                        margin-top: ${marginTop};
                        padding: 8px 12px;
                        background: #f8f9fa;
                        font-size: 13px;
                        color: #666;
                        line-height: 1.4;
                    `;
                    
                        // ÊèíÂÖ•Âà∞Êìç‰ΩúÊåâÈíÆ‰∏ãÈù¢ÔºåËØÑËÆ∫Âå∫ÂâçÈù¢ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâÔºåÂê¶ÂàôÂú®Êó∂Èó¥Êìç‰ΩúÂå∫ÂêéÈù¢
                    const momentContent = momentElement.querySelector('.moment-content');
                    const momentTimeActions = momentElement.querySelector('.moment-time-actions');
                        const commentsSection = momentElement.querySelector('.moment-comments-section');
                        
                    if (momentContent && momentTimeActions) {
                            if (commentsSection) {
                                // Â¶ÇÊûúÂ∑≤ÊúâËØÑËÆ∫Âå∫ÔºåÊèíÂÖ•Âà∞ËØÑËÆ∫Âå∫ÂâçÈù¢
                                momentContent.insertBefore(likesDisplay, commentsSection);
                            } else {
                                // Ê≤°ÊúâËØÑËÆ∫Âå∫ÔºåÊèíÂÖ•Âà∞Êó∂Èó¥Êìç‰ΩúÂå∫ÂêéÈù¢
                        momentTimeActions.parentNode.insertBefore(likesDisplay, momentTimeActions.nextSibling);
                            }
                    }
                }
                
                // ‰ΩøÁî®ÂíåÁî®Êà∑ÊòµÁß∞Áõ∏ÂêåÈ¢úËâ≤ÁöÑÁ©∫ÂøÉÁà±ÂøÉ
                const likeIcon = '<svg width="14" height="14" style="margin-right: 4px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="#576b95" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>';
                const names = momentLikes.map(like => like.name).join('„ÄÅ');
                likesDisplay.innerHTML = `${likeIcon}<span style="color: #576b95; font-weight: 600;">${names}</span>`;
                likesDisplay.style.display = 'block';
            } else if (likesDisplay) {
                likesDisplay.style.display = 'none';
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÁÇπËµûÊòæÁ§∫Â§±Ë¥•:', error);
            }
        }
        
        // AIËßíËâ≤ËØÑËÆ∫
        async function addAIComment(momentId, character, moment) {
            try {
                // ÁîüÊàêÁ¨¶ÂêàËßíËâ≤‰∫∫ËÆæÁöÑËØÑËÆ∫
                const comments = await generateCharacterComment(character, moment);
                if (!comments || comments.length === 0) return;
                
                const randomComment = comments[Math.floor(Math.random() * comments.length)];
                
                const comment = {
                    id: Date.now() + Math.random(),
                    nickname: character.name,
                    avatar: character.avatarUrl,
                    text: randomComment,
                    time: formatTime(new Date()),
                    timestamp: Date.now(),
                    characterId: character.id
                };
                
                // ‰øùÂ≠òËØÑËÆ∫
                saveCommentToMoment(momentId, comment);
                
                // Êõ¥Êñ∞ËØÑËÆ∫Êï∞
                updateMomentCommentCount(momentId);
                
                // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫Êñ∞ËØÑËÆ∫
                displayCommentUnderMoment(momentId, comment);
                
                // ÊòæÁ§∫ËØÑËÆ∫ÊèêÁ§∫
                showToast(`${character.name} ËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`);
            } catch (error) {
                console.error('AIËßíËâ≤ËØÑËÆ∫Â§±Ë¥•:', error);
            }
        }
        
        // AIËßíËâ≤Èó¥ÁöÑÊ•º‰∏≠Ê•º‰∫íÂä®ÔºàÂ•óÁî®ÂÆåÊàê.htmlÈÄªËæëÔºâ
        async function triggerAiToAiInteraction(momentId, relatedCharacters) {
            try {
                // Ëé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ
                const momentsData = JSON.parse(sessionStorage.getItem('momentsData') || '[]');
                const moment = momentsData.find(m => (m.id == momentId) || (m.timestamp == momentId));
                if (!moment || !moment.comments) return;
                
                const comments = moment.comments;
                if (comments.length < 2) return; // Ëá≥Â∞ëÈúÄË¶Å2Êù°ËØÑËÆ∫ÊâçËÉΩËß¶ÂèëËßíËâ≤Èó¥‰∫íÂä®
                
                // Ëé∑ÂèñÂú®ÂêåÁæ§ÁöÑÂèÇ‰∏éËØÑËÆ∫AIËßíËâ≤
                const participatingAis = [...new Set(comments
                    .filter(comment => comment.characterId && comment.characterId !== 'user')
                    .map(comment => comment.characterId)
                )];
                
                // ËøáÊª§Âá∫Âè™ÊúâÂú®ÂêåÁæ§ÁöÑAIËßíËâ≤
                const sameGroupParticipants = participatingAis.filter(aiId => 
                    relatedCharacters.some(char => char.id === aiId)
                );
                
                if (sameGroupParticipants.length < 2) {
                    console.log('ÂèÇ‰∏éËØÑËÆ∫ÁöÑÂêåÁæ§AIËßíËâ≤Â∞ë‰∫é2‰∏™ÔºåË∑≥ËøáËßíËâ≤Èó¥‰∫íÂä®');
                    return;
                }
                
                console.log(`ÂèëÁé∞ ${sameGroupParticipants.length} ‰∏™ÂêåÁæ§AIËßíËâ≤ÂèÇ‰∏é‰∫ÜËØÑËÆ∫ÔºåÂºÄÂßãËßíËâ≤Èó¥‰∫íÂä®`);
                
                // ÈöèÊú∫ÈÄâÊã©‰∏§‰∏™ÂêåÁæ§AIËøõË°å‰∫íÂä®
                const aiA = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                let aiB = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                
                // Á°Æ‰øùÈÄâÊã©‰∏çÂêåÁöÑAI
                while (aiB === aiA && sameGroupParticipants.length > 1) {
                    aiB = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                }
                
                if (aiA === aiB) return;
                
                // Ê£ÄÊü•ËßíËâ≤ÂÖ≥Á≥ªÂíå‰∫íÂä®Ê¶ÇÁéá (50%Ê¶ÇÁéá)
                if (Math.random() > 0.5) {
                    console.log('Âü∫‰∫éÊ¶ÇÁéáÈÄâÊã©‰∏çËøõË°åËßíËâ≤Èó¥‰∫íÂä®');
                    return;
                }
                
                // ÈÄâÊã©‰∏Ä‰∏™Áé∞ÊúâËØÑËÆ∫‰Ωú‰∏∫‰∫íÂä®Ëµ∑ÁÇπ
                const targetComment = comments.find(comment => 
                    comment.characterId === aiA || comment.characterId === aiB
                );
                
                if (!targetComment) return;
                
                // ÂÜ≥ÂÆöË∞ÅÂÖàÂõûÂ§çË∞Å
                const responderCharId = targetComment.characterId === aiA ? aiB : aiA;
                const targetCharId = targetComment.characterId;
                
                // Ëé∑ÂèñËßíËâ≤‰ø°ÊÅØ
                const characters = await getCharacters();
                const responderChar = characters.find(c => c.id === responderCharId);
                const targetChar = characters.find(c => c.id === targetCharId);
                
                if (!responderChar || !targetChar) return;
                
                console.log(`${responderChar.name} Â∞ÜÂõûÂ§ç ${targetChar.name} ÁöÑËØÑËÆ∫`);
                
                // ÁîüÊàêAIÈó¥ÁöÑ‰∫íÂä®ÂõûÂ§ç
                await generateAiToAiReply(momentId, targetComment, responderChar, targetChar);
                
            } catch (error) {
                console.error('ËßíËâ≤Èó¥‰∫íÂä®Â§±Ë¥•:', error);
            }
        }
        

        
        // ËßíËâ≤‰πãÈó¥‰∫íÂä®Ôºà‰øùÁïôÂéüÂáΩÊï∞Ôºå‰ΩÜ‰∏çÂÜç‰ΩøÁî®Ôºâ
        function triggerCharacterInteractions(momentId, characters) {
            if (characters.length < 2) return;
            
            // Ëé∑ÂèñÂ∑≤Âú®Âêå‰∏ÄÁæ§ÁöÑËßíËâ≤ÂÖ≥Á≥ª
            const groupRelations = getGroupRelations(characters);
            
            for (let i = 0; i < characters.length - 1; i++) {
                for (let j = i + 1; j < characters.length; j++) {
                    const char1 = characters[i];
                    const char2 = characters[j];
                    
                    // Ê£ÄÊü•ÊòØÂê¶Âú®Âêå‰∏Ä‰∏™Áæ§Èáå
                    const inSameGroup = groupRelations.some(group => 
                        group.includes(char1.id) && group.includes(char2.id)
                    );
                    
                    if (inSameGroup && Math.random() < 0.6) {
                        addCharacterInteraction(momentId, char1, char2);
                    }
                }
            }
        }
        
        // Ëé∑ÂèñÁæ§ÁªÑÂÖ≥Á≥ª
        function getGroupRelations(characters) {
            // ËøôÈáåÂ∫îËØ•‰ªéÁæ§ËÅäÊï∞ÊçÆ‰∏≠Ëé∑ÂèñÂÖ≥Á≥ªÔºåÁÆÄÂåñÁâàÊú¨
            const groups = [];
            // ÂÅáËÆæÊâÄÊúâËÅîÁ≥ª‰∫∫ÈÉΩÂèØËÉΩÂú®Âêå‰∏Ä‰∏™Áæ§Èáå
            if (characters.length >= 2) {
                groups.push(characters.map(c => c.id));
            }
            return groups;
        }
        
        // ÁîüÊàêAIÈó¥ÁöÑÂõûÂ§çÔºàÂ•óÁî®ÂÆåÊàê.htmlÈÄªËæëÔºâ
        async function generateAiToAiReply(momentId, targetComment, responderChar, targetChar) {
            try {
                // Ëé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ
                const momentsData = JSON.parse(sessionStorage.getItem('momentsData') || '[]');
                const moment = momentsData.find(m => (m.id == momentId) || (m.timestamp == momentId));
                if (!moment) return;
                
                // Ëé∑ÂèñÂìçÂ∫îËßíËâ≤ÁöÑËÅäÂ§©ËÆæÁΩÆ
                let responderSettings = null;
                try {
                    responderSettings = await db.chatSettings.get(responderChar.id);
                } catch (error) {
                    console.error('Ëé∑ÂèñÂìçÂ∫îËßíËâ≤ËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
                
                const responderPersona = responderSettings?.aiPersona || responderChar.prompt || '';
                const targetPersona = targetChar.prompt || '';
                
                // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (responderSettings?.linkedWorldBookIds && responderSettings.linkedWorldBookIds.length > 0) {
            try {
                        const worldBooks = await Promise.all(
                            responderSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                        );
                        const validWorldBooks = worldBooks.filter(book => book && book.content);
                        if (validWorldBooks.length > 0) {
                            worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                                validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
                        }
                    } catch (error) {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    }
                }
                
                // Ëé∑ÂèñËÅäÂ§©‰∏ä‰∏ãÊñá
                let chatContext = '';
                const responderMessages = chatMessages[responderChar.id] || [];
                if (responderMessages.length > 0) {
                    const maxMemory = parseInt(responderSettings?.maxMemory) || 10;
                    const recentHistory = responderMessages.slice(-maxMemory);
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                        recentHistory.map(msg => {
                            if (msg.role === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            return `${responderChar.name}Ôºö${msg.content}`;
                        }).join('\n');
                }
                
                const systemPrompt = `‰Ω†ÊòØ${responderChar.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${responderPersona}„ÄÇ${worldBookContent}${chatContext}

Áé∞Âú®Âú®‰∏Ä‰∏™Âä®ÊÄÅ‰∏ãÔºå${targetChar.name}Ôºà‰∫∫ËÆæÔºö${targetPersona}ÔºâÂàöÂàöËØÑËÆ∫‰∫ÜÔºö"${targetComment.text}"„ÄÇ

ÂéüÂä®ÊÄÅÂÜÖÂÆπÔºö${moment.text}

‰Ω†Ë¶Å‰Ωú‰∏∫${responderChar.name}ÔºåÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÂíå‰∏é${targetChar.name}ÁöÑÂÖ≥Á≥ªÔºåÂØπtaÁöÑËØÑËÆ∫ËøõË°åÂõûÂ∫î„ÄÇË¶ÅÊ±ÇÔºö
1. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæËøõË°åÂõûÂ§çÔºå‰∏çËÉΩÊ∑∑Ê∑ÜËßíËâ≤
2. ÂõûÂ§çË¶ÅËá™ÁÑ∂„ÄÅÁ¨¶ÂêàÊúãÂèãÂúàËØÑËÆ∫È£éÊ†º
3. ÂèØ‰ª•ÊòØËµûÂêå„ÄÅ‰∏çÂêåËßÇÁÇπ„ÄÅË°•ÂÖÖ„ÄÅÊèêÈóÆÊàñÂºÄÁé©Á¨ë
4. Ë¶Å‰ΩìÁé∞Âá∫‰Ω†Âíå${targetChar.name}‰πãÈó¥ÁöÑ‰∫íÂä®ÂÖ≥Á≥ª
5. ÂõûÂ§çÁÆÄÁü≠ÊúâË∂£ÔºåÁ¨¶ÂêàÁ§æ‰∫§Â™í‰ΩìÁöÑÁâπÁÇπ
6. Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÈÄâÊã©ÂêàÈÄÇÁöÑËØ≠Ê∞îÂíåÁî®ËØç
7. ‰∏çË¶Å‰ΩøÁî®‰∏éËßíËâ≤ÊÄßÊ†º‰∏çÁ¨¶ÁöÑË°®ÊÉÖÁ¨¶Âè∑`;

                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: `ËØ∑ÂõûÂ§ç${targetChar.name}ÁöÑËØÑËÆ∫` }
                ];

                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáAI‰∫íÂä®');
                    return;
                }

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response;
                if (isGeminiOfficial) {
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
                    
                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                        });
                    }
                    
                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;
                        
                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`AI‰∫íÂä®APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
                    return;
                }

                const data = await response.json();
                let content;

                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return;
                    }
                } else {
                    // Ëß£ÊûêOpenAIÊ†ºÂºèÂìçÂ∫î
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        for (const key in data) {
                            if (typeof data[key] === 'string' && data[key].trim()) {
                                content = data[key];
                                console.log(`AI‰∫íÂä®API‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                                break;
                            }
                        }
                    }
                    
                    if (!content) {
                        console.error('AI‰∫íÂä®APIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return;
                    }
                }

                if (content && content.trim()) {
                    // ÂàõÂª∫ÂõûÂ§çËØÑËÆ∫
                    const replyComment = {
                    id: Date.now() + Math.random(),
                        nickname: responderChar.name,
                        avatar: responderChar.avatarUrl,
                        text: content.trim(),
                    time: formatTime(new Date()),
                    timestamp: Date.now(),
                        replyTo: targetChar.name,
                        characterId: responderChar.id
                };
                
                    // ‰øùÂ≠òËØÑËÆ∫
                    saveCommentToMoment(momentId, replyComment);
                
                    // Êõ¥Êñ∞ËØÑËÆ∫Êï∞
                updateMomentCommentCount(momentId);
                
                    // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫Êñ∞ËØÑËÆ∫
                    displayCommentUnderMoment(momentId, replyComment);
                
                    showToast(`${responderChar.name} ÂõûÂ§ç‰∫Ü ${targetChar.name}`);
                }

            } catch (error) {
                console.error('ÁîüÊàêAIÈó¥ÂõûÂ§çÂ§±Ë¥•:', error);
            }
        }
        
        // AIÂõûÂ§çÁî®Êà∑ËØÑËÆ∫
        async function triggerAIReplyToUser(momentId, aiCharacterName, userCommentText) {
            try {
                console.log(`triggerAIReplyToUserË¢´Ë∞ÉÁî®: momentId=${momentId}, aiCharacterName=${aiCharacterName}, userCommentText="${userCommentText}"`);
                console.log(`ÂΩìÂâçcharactersÊï∞ÁªÑ:`, characters);
                console.log(`ÂΩìÂâçcontactsÊï∞ÁªÑ:`, contacts);
                
                // ÊâæÂà∞ÂØπÂ∫îÁöÑAIËßíËâ≤
                const character = characters.find(c => c.name === aiCharacterName);
                if (!character) {
                    console.log(`Êú™ÊâæÂà∞ËßíËâ≤ ${aiCharacterName}ÔºåÂèØÁî®ËßíËâ≤:`, characters.map(c => c.name));
                    return;
                }
                
                // Ëé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ
                const moment = await db.moments.get(parseInt(momentId));
                if (!moment) {
                    console.log(`Êú™ÊâæÂà∞Âä®ÊÄÅ ${momentId}`);
                    return;
                }
                
                // Ëé∑ÂèñËßíËâ≤ËÆæÁΩÆ
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(character.id);
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
                
                const persona = chatSettings?.aiPersona || character.prompt || `‰Ω†ÊòØ${character.name}„ÄÇ`;
                
                // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                        const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                        );
                        const validWorldBooks = worldBooks.filter(book => book && book.content);
                        if (validWorldBooks.length > 0) {
                            worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                                validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
                        }
                    } catch (error) {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    }
                }
                
                // Ëé∑ÂèñËÅäÂ§©‰∏ä‰∏ãÊñá
                let chatContext = '';
                const characterMessages = chatMessages[character.id] || [];
                if (characterMessages.length > 0) {
                    const maxMemory = parseInt(chatSettings?.maxMemory) || 10;
                    const recentHistory = characterMessages.slice(-maxMemory);
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                        recentHistory.map(msg => {
                        if (msg.role === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            return `${character.name}Ôºö${msg.content}`;
                    }).join('\n');
                }
                
                const systemPrompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${persona}„ÄÇ${worldBookContent}${chatContext}

Âú®‰∏Ä‰∏™Âä®ÊÄÅ‰∏ãÔºåÁî®Êà∑ÂàöÂàöÂõûÂ§ç‰∫Ü‰Ω†ÁöÑËØÑËÆ∫Ôºö"${userCommentText}"„ÄÇ

ÂéüÂä®ÊÄÅÂÜÖÂÆπÔºö${moment.text}

ËØ∑‰Ωú‰∏∫${character.name}ÔºåÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÂØπÁî®Êà∑ÁöÑÂõûÂ§çÂÅöÂá∫Ëá™ÁÑ∂ÁöÑÂèçÂ∫î„ÄÇË¶ÅÊ±ÇÔºö
1. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæËøõË°åÂõûÂ§çÔºå‰øùÊåÅËßíËâ≤‰∏ÄËá¥ÊÄß
2. ÂõûÂ§çË¶ÅËá™ÁÑ∂„ÄÅÁ¨¶ÂêàÊúãÂèãÂúàËØÑËÆ∫È£éÊ†ºÔºåÁÆÄÁü≠ÊúâË∂£
3. ÂèØ‰ª•ÊòØÁªßÁª≠ËÆ®ËÆ∫„ÄÅË°®ËææÊÑüË∞¢„ÄÅÂºÄÁé©Á¨ëÊàñËÄÖÂàÜ‰∫´Êõ¥Â§öÊÉ≥Ê≥ï
4. ‰ΩìÁé∞Âá∫‰Ω†ÂíåÁî®Êà∑‰πãÈó¥ÁöÑÂèãÂ•Ω‰∫íÂä®
5. Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÈÄâÊã©ÂêàÈÄÇÁöÑËØ≠Ê∞îÂíåÁî®ËØç
6. ‰∏çË¶Å‰ΩøÁî®‰∏éËßíËâ≤ÊÄßÊ†º‰∏çÁ¨¶ÁöÑË°®ÊÉÖÁ¨¶Âè∑`;

                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: `ËØ∑ÂõûÂ§çÁî®Êà∑ÁöÑËØÑËÆ∫` }
                ];

                console.log(`ÊâæÂà∞ËßíËâ≤ ${character.name}ÔºåÂáÜÂ§áÁîüÊàêÂõûÂ§ç`);
                console.log(`Âä®ÊÄÅ‰ø°ÊÅØ:`, moment);
                console.log(`ËßíËâ≤ËÆæÁΩÆ:`, chatSettings);
                
                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáAIÂõûÂ§ç');
                    console.log('APIËÆæÁΩÆ:', apiSettings);
                    return;
                }

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response;
                if (isGeminiOfficial) {
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
                    
                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                        });
                    }
                    
                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;
                        
                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`AIÂõûÂ§çÁî®Êà∑APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
                    return;
                }

                const data = await response.json();
                let content;

                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return;
                    }
                } else {
                    // Ëß£ÊûêOpenAIÊ†ºÂºèÂìçÂ∫î
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        for (const key in data) {
                            if (typeof data[key] === 'string' && data[key].trim()) {
                                content = data[key];
                                console.log(`AIÂõûÂ§çÁî®Êà∑API‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                                break;
                            }
                        }
                    }
                    
                    if (!content) {
                        console.error('AIÂõûÂ§çÁî®Êà∑APIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return;
                    }
                }

                if (content && content.trim()) {
                    // ÂàõÂª∫AIÂõûÂ§çËØÑËÆ∫
                    const replyComment = {
                        id: Date.now() + Math.random(),
                        nickname: character.name,
                        avatar: character.avatarUrl,
                        text: content.trim(),
                        time: formatTime(new Date()),
                        timestamp: Date.now(),
                        replyTo: 'Êàë', // ÂõûÂ§çÁî®Êà∑
                        characterId: character.id
                    };
                    
                    // ‰øùÂ≠òËØÑËÆ∫
                    saveCommentToMoment(momentId, replyComment);
                    
                    // Êõ¥Êñ∞ËØÑËÆ∫Êï∞
                    updateMomentCommentCount(momentId);
                    
                    // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫Êñ∞ËØÑËÆ∫
                    displayCommentUnderMoment(momentId, replyComment);
                    
                    // Â¢ûÂä†ÂØπËØùËΩÆÊ¨°
                    const conversationKey = `${momentId}-${character.name}`;
                    const currentRounds = commentConversationRounds.get(conversationKey) || 0;
                    commentConversationRounds.set(conversationKey, currentRounds + 1);
                    console.log(`${character.name} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùËΩÆÊ¨°Êõ¥Êñ∞‰∏∫: ${currentRounds + 1}/10`);
                    
                    showToast(`${character.name} ÂõûÂ§ç‰∫Ü‰Ω†`);
                }

            } catch (error) {
                console.error('AIÂõûÂ§çÁî®Êà∑Â§±Ë¥•:', error);
            }
        }
        
        // ÁîüÊàêÁ¨¶ÂêàËßíËâ≤‰∫∫ËÆæÁöÑËØÑËÆ∫ - Áõ¥Êé•Â•óÁî®ÂÆåÊàê.htmlÁöÑÈÄªËæë
        async function generateCharacterComment(character, moment) {
            try {
                // Ëé∑ÂèñËßíËâ≤ÂØπÂ∫îÁöÑËÅäÂ§©ËÆæÁΩÆ
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(character.id);
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
                
                const persona = chatSettings?.aiPersona || character.prompt || `‰Ω†ÊòØ${character.name}„ÄÇ`;
                
                // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                    const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                    );
                    const validWorldBooks = worldBooks.filter(book => book && book.content);
                    if (validWorldBooks.length > 0) {
                        worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                            validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
                    }
                    } catch (error) {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    }
                }
                
                // Ëé∑ÂèñÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩï‰Ωú‰∏∫‰∏ä‰∏ãÊñáÔºàÊ†πÊçÆÁî®Êà∑ËÆæÁΩÆÁöÑÊù°Êï∞Ôºâ
                let chatContext = '';
                const characterMessages = chatMessages[character.id] || [];
                if (characterMessages.length > 0) {
                    const maxMemory = parseInt(chatSettings?.maxMemory) || 10;
                    const recentHistory = characterMessages.slice(-maxMemory);
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                        recentHistory.map(msg => {
                            if (msg.role === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            return `${character.name}Ôºö${msg.content}`;
                        }).join('\n');
                }
                
                let systemPrompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${persona}„ÄÇ${worldBookContent}${chatContext}\n\n`;
                systemPrompt += `Áé∞Âú®Âú®ÊúãÂèãÂúàÁúãÂà∞‰∫Ü‰∏ÄÊù°Âä®ÊÄÅÔºåËØ∑Âü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÂèëË°®ËØÑËÆ∫„ÄÇËØÑËÆ∫Ë¶ÅÁ¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºÁâπÁÇπÂíåÂÖ¥Ë∂£Áà±Â•Ω„ÄÇ`;
                systemPrompt += `\n\nË¶ÅÊ±ÇÔºö
1. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæÂõûÂ§çÔºå‰ΩìÁé∞‰Ω†Áã¨ÁâπÁöÑÊÄßÊ†ºÂíåËØ¥ËØùÈ£éÊ†º
2. ËØÑËÆ∫Ë¶ÅÁÆÄÁü≠Ëá™ÁÑ∂ÔºåÁ¨¶ÂêàÊúãÂèãÂúàÈ£éÊ†ºÔºà1-2Âè•ËØùÂç≥ÂèØÔºâ
3. ÂèØ‰ª•ÊòØÊÑüÊÉ≥„ÄÅÁñëÈóÆ„ÄÅËµûÁæé„ÄÅË∞É‰æÉÊàñÂàÜ‰∫´Áõ∏ÂÖ≥ÁªèÂéÜ
4. Âè™ÊúâÁ¨¶Âêà‰Ω†ÊÄßÊ†ºÁöÑÊÉÖÂÜµ‰∏ãÊâç‰ΩøÁî®Ë°®ÊÉÖÁ¨¶Âè∑Ôºå‰∏çË¶ÅÊª•Áî®emoji
5. Ë¶ÅÂÉèÁúüÂÆûÁöÑÊúãÂèã‰∏ÄÊ†∑Ëá™ÁÑ∂‰∫íÂä®ÔºåÈÅøÂÖçËøá‰∫éÊ≠£ÂºèÁöÑË°®Ëææ
6. Â¶ÇÊûúÂä®ÊÄÅÂÜÖÂÆπ‰∏é‰Ω†ÁöÑÂÖ¥Ë∂£Áà±Â•ΩÁõ∏ÂÖ≥ÔºåÂèØ‰ª•Â±ïÁé∞Êõ¥Â§öÁÉ≠ÊÉÖ`;
                
                // ÊûÑÂª∫Áî®Êà∑Ê∂àÊÅØ
                let postDescription = `ÂéüÂä®ÊÄÅÔºö${moment.text || ''}`;
                if (moment.images && moment.images.length > 0) {
                    postDescription += `\n[ËØ•Âä®ÊÄÅÂåÖÂê´${moment.images.length}Âº†ÂõæÁâá]`;
                }
                const userMsg = `${postDescription}\nËØ∑ÂèëË°®‰Ω†ÁöÑÁúãÊ≥ïÔºö`;
                
                // ÊûÑÂª∫Ê∂àÊÅØ
                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userMsg }
                ];
                
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑAPIË∞ÉÁî®ÈÄªËæëÔºà‰∏éËÅäÂ§©Áõ∏ÂêåÔºâ
                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáAIËØÑËÆ∫');
                    return [];
                }
                
                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                
                // Ê£ÄÊµãÊòØÂê¶ÊòØGeminiÂÆòÊñπAPI
                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');
                
                let response;
                if (isGeminiOfficial) {
                    // ‰ΩøÁî®GeminiÂÆòÊñπAPIÊ†ºÂºè
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
                    
                    // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè‰∏∫GeminiÊ†ºÂºè
                    const geminiMessages = [];
                    
                    // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                        });
                    }
                    
                    // ËΩ¨Êç¢ÂÖ∂‰ªñÊ∂àÊÅØ
                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;
                        
                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ‰ΩøÁî®OpenAIÊ†ºÂºè
                    response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
                    return [];
                }
                
                const data = await response.json();
                let content;
                
                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return [];
                    }
                } else {
                    // Ëß£ÊûêOpenAIÊ†ºÂºèÂìçÂ∫î
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        // Â∞ùËØïÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑÂÄº
                        for (const key in data) {
                            if (typeof data[key] === 'string' && data[key].trim()) {
                                content = data[key];
                                console.log(`AIËØÑËÆ∫API‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                                break;
                            }
                        }
                    }
                    
                    if (!content) {
                        console.error('AIËØÑËÆ∫APIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return [];
                    }
                }
                
                if (content && content.trim().length > 0) {
                    return [content.trim()];
                }
                
                return [];
                
            } catch (error) {
                console.error('ÁîüÊàêAIËØÑËÆ∫Â§±Ë¥•:', error);
                return [];
            }
        }
        

        
        // ÁîüÊàêËßíËâ≤Èó¥‰∫íÂä®ËØÑËÆ∫ - ‰ΩøÁî®ÂÆåÊï¥ÁöÑAIËÅäÂ§©ÈÄªËæë
        async function generateCharacterInteraction(char1, char2, momentId) {
            try {
                // Ëé∑ÂèñÂä®ÊÄÅÂíå‰πãÂâçÁöÑËØÑËÆ∫‰∏ä‰∏ãÊñá
                const momentsData = JSON.parse(sessionStorage.getItem('momentsData') || '[]');
                const moment = momentsData.find(m => (m.id == momentId) || (m.timestamp == momentId));
                if (!moment) return '';
                
                // Ëé∑ÂèñËßíËâ≤ÂØπÂ∫îÁöÑËÅäÂ§©ËÆæÁΩÆ
                let chatSettings1 = null;
                let chatSettings2 = null;
                try {
                    chatSettings1 = await db.chatSettings.get(char1.id);
                    chatSettings2 = await db.chatSettings.get(char2.id);
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
                
                // Ëé∑Âèñchar2ÁöÑÊúÄÊñ∞ËØÑËÆ∫‰Ωú‰∏∫‰∏ä‰∏ãÊñá
                const char2Comments = (moment.comments || []).filter(c => c.characterId === char2.id);
                const latestChar2Comment = char2Comments[char2Comments.length - 1];
                
                // ÊûÑÂª∫ÂØπËØù‰∏ä‰∏ãÊñá
                let conversationContext = `Áî®Êà∑ÂèëÂ∏É‰∫ÜÂä®ÊÄÅÔºö${moment.text}\n`;
                if (latestChar2Comment) {
                    conversationContext += `${char2.name}ËØÑËÆ∫ËØ¥Ôºö${latestChar2Comment.text}\n`;
                }
                
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑAI‰∫∫ËÆæÂíåËÆ∞ÂøÜÁ≥ªÁªü
                const persona1 = chatSettings1?.aiPersona || char1.prompt || `‰Ω†ÊòØ${char1.name}„ÄÇ`;
                
                // Ëé∑ÂèñÂéÜÂè≤ËÅäÂ§©ËÆ∞ÂΩï
                const maxMemory = parseInt(chatSettings1?.maxMemory) || 10;
                const char1Messages = chatMessages[char1.id] || [];
                const recentMessages = char1Messages.slice(-maxMemory);
                
                let chatSummary = '';
                if (recentMessages.length > 0) {
                    chatSummary = '‰Ω†ÂíåÁî®Êà∑ÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰æõÂèÇËÄÉÔºâÔºö\n';
                    chatSummary += recentMessages.map(msg => {
                        if (msg.role === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                        if (msg.role === 'assistant') return `${char1.name}Ôºö${msg.content}`;
                        return '';
                    }).filter(line => line).join('\n');
                }
                
                // Ëé∑ÂèñÊåÇËΩΩÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chatSettings1?.linkedWorldBookIds && chatSettings1.linkedWorldBookIds.length > 0) {
                    try {
                    const worldBooks = await Promise.all(
                            chatSettings1.linkedWorldBookIds.map(async id => {
                                try {
                                    return await db.worldbooks.get(id);
                                } catch (error) {
                                    console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                                    return null;
                                }
                            })
                    );
                    const validWorldBooks = worldBooks.filter(book => book && book.content);
                    if (validWorldBooks.length > 0) {
                        worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                            validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
                    }
                    } catch (error) {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    }
                }
                
                let systemPrompt = `‰Ω†ÊòØ${char1.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${persona1}„ÄÇ${worldBookContent}${chatSummary}\n\n`;
                systemPrompt += `ËøôÊòØ‰∏Ä‰∏™Ê•º‰∏≠Ê•ºËÆ®ËÆ∫ÔºåËØ∑Âü∫‰∫é‰ª•‰∏ãÂØπËØù‰∏ä‰∏ãÊñáÔºåÁªßÁª≠ÂèÇ‰∏éËÆ®ËÆ∫„ÄÇË¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÔºåÂõûÂ§çË¶ÅÁÆÄÁü≠ÊúâË∂£„ÄÇ`;
                if (chatSettings2?.aiPersona) {
                    systemPrompt += ` Ôºà${char2.name}ÁöÑËÆæÂÆöÔºö${chatSettings2.aiPersona}Ôºâ`;
                }
                systemPrompt += `\n\nË¶ÅÊ±ÇÔºö
1. ÂõûÂ§çË¶ÅÁ¨¶ÂêàÊúãÂèãÂúàËØÑËÆ∫ÁöÑÈ£éÊ†ºÔºåÁÆÄÁü≠„ÄÅËá™ÁÑ∂
2. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæÊù•ÈÄâÊã©ÊòØÂê¶‰ΩøÁî®Ë°®ÊÉÖÁ¨¶Âè∑Ôºå‰∏çË¶Å‰ΩøÁî®‰∏éËßíËâ≤ÊÄßÊ†º‰∏çÁ¨¶ÁöÑemoji
3. ‰∏çË¶ÅËøá‰∫éÊ≠£ÂºèÊàñÂÆ¢Â•óÔºåË¶ÅÂÉèÁúüÂÆûÁöÑÊúãÂèã‰∏ÄÊ†∑‰∫íÂä®`;
                
                // ÊûÑÂª∫Ê∂àÊÅØ
                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: conversationContext }
                ];
                
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑAPIË∞ÉÁî®ÈÄªËæëÔºà‰∏éËÅäÂ§©Áõ∏ÂêåÔºâ
                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáËßíËâ≤‰∫íÂä®');
                    return '';
                }
                
                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                // Ê£ÄÊµãÊòØÂê¶ÊòØGeminiÂÆòÊñπAPI
                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');
                
                let response;
                if (isGeminiOfficial) {
                    // ‰ΩøÁî®GeminiÂÆòÊñπAPIÊ†ºÂºè
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
                    
                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                        });
                    }
                    
                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;
                        
                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ‰ΩøÁî®OpenAIÊ†ºÂºè
                    response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`ËßíËâ≤‰∫íÂä®APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
                    return '';
                }
                
                const data = await response.json();
                let content;
                
                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return '';
                    }
                } else {
                    // Ëß£ÊûêOpenAIÊ†ºÂºèÂìçÂ∫î
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        // Â∞ùËØïÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑÂÄº
                        for (const key in data) {
                            if (typeof data[key] === 'string' && data[key].trim()) {
                                content = data[key];
                                console.log(`ËßíËâ≤‰∫íÂä®API‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                                break;
                            }
                        }
                    }
                    
                    if (!content) {
                        console.error('ËßíËâ≤‰∫íÂä®APIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                return '';
                    }
                }
                
                return content ? content.trim() : '';
                
            } catch (error) {
                console.error('ÁîüÊàêËßíËâ≤‰∫íÂä®Â§±Ë¥•:', error);
                return '';
            }
        }
        

        
        // ÈïøÊåâÈÄâÊã©ÂäüËÉΩ
        function addLongPressListener(element, momentId) {
            let pressTimer = null;
            let startY = 0;
            let moved = false;
            
            const startPress = (e) => {
                if (isSelectionMode) return;
                
                startY = e.touches ? e.touches[0].clientY : e.clientY;
                moved = false;
                
                pressTimer = setTimeout(() => {
                    if (!moved) {
                        enterSelectionMode();
                        selectMoment(momentId);
                    }
                }, 500); // 500msÈïøÊåâ
            };
            
            const endPress = () => {
                clearTimeout(pressTimer);
                pressTimer = null;
            };
            
            const movePress = (e) => {
                const currentY = e.touches ? e.touches[0].clientY : e.clientY;
                if (Math.abs(currentY - startY) > 10) {
                    moved = true;
                    endPress();
                }
            };
            
            element.addEventListener('touchstart', startPress);
            element.addEventListener('touchend', endPress);
            element.addEventListener('touchmove', movePress);
            element.addEventListener('mousedown', startPress);
            element.addEventListener('mouseup', endPress);
            element.addEventListener('mousemove', movePress);
        }
        
        // ËøõÂÖ•ÈÄâÊã©Ê®°Âºè
        function enterSelectionMode() {
            isSelectionMode = true;
            selectedMoments.clear();
            
            // ÊòæÁ§∫ÈÄâÊã©Ê®°ÂºèUI
            showSelectionModeUI();
            
            // Ê∑ªÂä†ÈÄâÊã©Ê°ÜÂà∞ÊâÄÊúâÂä®ÊÄÅ
            const momentItems = document.querySelectorAll('.moment-item');
            momentItems.forEach(item => {
                const checkbox = document.createElement('div');
                checkbox.className = 'moment-checkbox';
                checkbox.innerHTML = '<i class="far fa-circle"></i>';
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    const momentId = item.getAttribute('data-moment-id');
                    toggleMomentSelection(momentId);
                };
                item.appendChild(checkbox);
                item.classList.add('selection-mode');
            });
        }
        
        // ÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
        function exitSelectionMode() {
            isSelectionMode = false;
            selectedMoments.clear();
            
            // ÈöêËóèÈÄâÊã©Ê®°ÂºèUI
            hideSelectionModeUI();
            
            // ÁßªÈô§ÈÄâÊã©Ê°Ü
            const checkboxes = document.querySelectorAll('.moment-checkbox');
            checkboxes.forEach(checkbox => checkbox.remove());
            
            const momentItems = document.querySelectorAll('.moment-item');
            momentItems.forEach(item => {
                item.classList.remove('selection-mode', 'selected');
            });
        }
        
        // ÊòæÁ§∫ÈÄâÊã©Ê®°ÂºèUI
        function showSelectionModeUI() {
            const selectionBar = document.createElement('div');
            selectionBar.className = 'selection-bar';
            selectionBar.innerHTML = `
                <div class="selection-actions">
                    <button class="cancel-btn" onclick="exitSelectionMode()">ÂèñÊ∂à</button>
                    <span class="selection-count">Â∑≤ÈÄâÊã© 0 Êù°Âä®ÊÄÅ</span>
                    <button class="delete-btn" onclick="deleteSelectedMoments()" disabled>Âà†Èô§</button>
                </div>
            `;
            
            const momentsPage = document.getElementById('moments-page');
            momentsPage.insertBefore(selectionBar, momentsPage.firstChild);
        }
        
        // ÈöêËóèÈÄâÊã©Ê®°ÂºèUI
        function hideSelectionModeUI() {
            const selectionBar = document.querySelector('.selection-bar');
            if (selectionBar) {
                selectionBar.remove();
            }
        }
        
        // ÂàáÊç¢Âä®ÊÄÅÈÄâÊã©Áä∂ÊÄÅ
        function toggleMomentSelection(momentId) {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            const checkbox = momentElement.querySelector('.moment-checkbox i');
            
            if (selectedMoments.has(momentId)) {
                selectedMoments.delete(momentId);
                checkbox.className = 'far fa-circle';
                momentElement.classList.remove('selected');
            } else {
                selectedMoments.add(momentId);
                checkbox.className = 'fas fa-check-circle';
                momentElement.classList.add('selected');
            }
            
            updateSelectionUI();
        }
        
        // ÈÄâÊã©Âä®ÊÄÅ
        function selectMoment(momentId) {
            if (!selectedMoments.has(momentId)) {
                toggleMomentSelection(momentId);
            }
        }
        
        // Êõ¥Êñ∞ÈÄâÊã©UI
        function updateSelectionUI() {
            const countSpan = document.querySelector('.selection-count');
            const deleteBtn = document.querySelector('.delete-btn');
            
            if (countSpan) {
                countSpan.textContent = `Â∑≤ÈÄâÊã© ${selectedMoments.size} Êù°Âä®ÊÄÅ`;
            }
            
            if (deleteBtn) {
                deleteBtn.disabled = selectedMoments.size === 0;
            }
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂä®ÊÄÅ
        async function deleteSelectedMoments() {
            if (selectedMoments.size === 0) return;
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ ${selectedMoments.size} Êù°Âä®ÊÄÅÂêóÔºü`)) {
                return;
            }
            
            try {
                // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§
                for (const momentId of selectedMoments) {
                    try {
                        // Â∞ùËØïÂ§öÁßçIDÊ†ºÂºèËøõË°åÂà†Èô§
                        let deleted = false;
                        const possibleIds = [momentId, parseInt(momentId), String(momentId), Number(momentId)];
                        
                        for (const id of possibleIds) {
                            try {
                                await db.moments.delete(id);
                                console.log(`‚úì ÊàêÂäüÂà†Èô§Âä®ÊÄÅ ${id} (Á±ªÂûã: ${typeof id})`);
                                deleted = true;
                                break;
                            } catch (error) {
                                console.log(`Âà†Èô§ID ${id} (${typeof id}) Â§±Ë¥•: ${error.message}`);
                            }
                        }
                        
                        if (!deleted) {
                            // Â∞ùËØï‰ΩøÁî®whereÊù°‰ª∂Âà†Èô§
                            await db.moments.where('id').equals(momentId).delete();
                            console.log(`‚úì ‰ΩøÁî®whereÊù°‰ª∂Âà†Èô§Âä®ÊÄÅ ${momentId} ÊàêÂäü`);
                        }
                        
                        // Âà†Èô§Áõ∏ÂÖ≥ÁÇπËµûÔºàÂ∞ùËØï‰∏çÂêåIDÊ†ºÂºèÔºâ
                        const numericId = parseInt(momentId);
                        await db.momentLikes.where('momentId').equals(numericId).delete();
                        await db.momentLikes.where('momentId').equals(momentId).delete();
                        
                        // Âà†Èô§Áõ∏ÂÖ≥ËØÑËÆ∫ÔºàÂ∞ùËØï‰∏çÂêåIDÊ†ºÂºèÔºâ
                        await db.momentComments.where('momentId').equals(numericId).delete();
                        await db.momentComments.where('momentId').equals(momentId).delete();
                        
                    } catch (error) {
                        console.error(`Âà†Èô§Âä®ÊÄÅ ${momentId} Â§±Ë¥•:`, error);
                        throw error; // ÈáçÊñ∞ÊäõÂá∫ÈîôËØØ‰ª•‰æø‰∏äÂ±ÇÂ§ÑÁêÜ
                    }
                    
                    // Ê∏ÖÁêÜÂØπËØùËΩÆÊ¨°ËÆ∞ÂΩï
                    for (const [key, value] of commentConversationRounds.entries()) {
                        if (key.startsWith(`${momentId}-`)) {
                            commentConversationRounds.delete(key);
                        }
                    }
            }
            
            // ‰ªéDOM‰∏≠ÁßªÈô§
            selectedMoments.forEach(momentId => {
                const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
                if (momentElement) {
                    momentElement.remove();
                }
            });
                
                // Ê∏ÖÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑsessionStorageÁºìÂ≠òÊï∞ÊçÆ
                try {
                    const sessionMomentsData = sessionStorage.getItem('momentsData');
                    if (sessionMomentsData) {
                        const momentsArray = JSON.parse(sessionMomentsData);
                        const filteredMoments = momentsArray.filter(moment => 
                            !selectedMoments.has(moment.id.toString()) && 
                            !selectedMoments.has(moment.timestamp?.toString())
                        );
                        sessionStorage.setItem('momentsData', JSON.stringify(filteredMoments));
                    }
                } catch (error) {
                    console.warn('Ê∏ÖÁêÜsessionStorageÂä®ÊÄÅÊï∞ÊçÆÊó∂Âá∫Èîô:', error);
                }
            
            showToast(`Â∑≤Âà†Èô§ ${selectedMoments.size} Êù°Âä®ÊÄÅ`);
            
            // ÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
            exitSelectionMode();
                
                // Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÂä®ÊÄÅÂàóË°®ÔºåÁ°Æ‰øùÂà†Èô§ÁîüÊïà
                setTimeout(() => {
                    loadMoments();
                }, 500);
                
            } catch (error) {
                console.error('Âà†Èô§Âä®ÊÄÅÂ§±Ë¥•:', error);
                showToast('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Âº∫Âà∂Ê∏ÖÁêÜÊåáÂÆöÂä®ÊÄÅÁöÑÊâÄÊúâÁõ∏ÂÖ≥Êï∞ÊçÆ
        async function forceCleanMoment(momentId) {
            try {
                const numericId = parseInt(momentId);
                console.log(`ÂºÄÂßãÂΩªÂ∫ïÊ∏ÖÁêÜÂä®ÊÄÅ: ${momentId}`);
                
                // 1. ‰ªéIndexedDBÂà†Èô§ÔºàÂ∞ùËØïÂ§öÁßçIDÊ†ºÂºèÔºâ
                let deleted = false;
                const possibleIds = [momentId, numericId, String(momentId), Number(momentId)];
                
                for (const id of possibleIds) {
                    try {
                        await db.moments.delete(id);
                        console.log(`‚úì Âà†Èô§Âä®ÊÄÅÊàêÂäüÔºå‰ΩøÁî®ID: ${id} (Á±ªÂûã: ${typeof id})`);
                        deleted = true;
                        break;
                    } catch (error) {
                        console.log(`Âà†Èô§ID ${id} Â§±Ë¥•: ${error.message}`);
                    }
                }
                
                if (!deleted) {
                    await db.moments.where('id').equals(momentId).delete();
                }
                
                // Âà†Èô§Áõ∏ÂÖ≥Êï∞ÊçÆÔºàÂ∞ùËØï‰∏çÂêåÊ†ºÂºèÔºâ
                await db.momentLikes.where('momentId').equals(numericId).delete();
                await db.momentLikes.where('momentId').equals(momentId).delete();
                await db.momentComments.where('momentId').equals(numericId).delete();
                await db.momentComments.where('momentId').equals(momentId).delete();
                
                // 2. Ê∏ÖÁêÜÂØπËØùËΩÆÊ¨°ËÆ∞ÂΩï
                for (const [key, value] of commentConversationRounds.entries()) {
                    if (key.startsWith(`${momentId}-`)) {
                        commentConversationRounds.delete(key);
                    }
                }
                
                // 3. ‰ªéDOMÁßªÈô§
                const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
                if (momentElement) {
                    momentElement.remove();
                }
                
                // 4. Ê∏ÖÁêÜsessionStorageÁºìÂ≠ò
                const sessionMomentsData = sessionStorage.getItem('momentsData');
                if (sessionMomentsData) {
                    const momentsArray = JSON.parse(sessionMomentsData);
                    const filteredMoments = momentsArray.filter(moment => 
                        moment.id != momentId && 
                        moment.timestamp != momentId &&
                        moment.id.toString() !== momentId.toString()
                    );
                    sessionStorage.setItem('momentsData', JSON.stringify(filteredMoments));
                }
                
                console.log(`Âä®ÊÄÅ ${momentId} Ê∏ÖÁêÜÂÆåÊàê`);
                return true;
            } catch (error) {
                console.error('Âº∫Âà∂Ê∏ÖÁêÜÂä®ÊÄÅÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // Ê∏ÖÁêÜÊâÄÊúâÊúâÈóÆÈ¢òÁöÑÂä®ÊÄÅÔºà‰øÆÂ§çÂ∑•ÂÖ∑Ôºâ
        async function cleanupCorruptedMoments() {
            if (!confirm('ËøôÂ∞ÜÊ∏ÖÁêÜÊâÄÊúâÂèØËÉΩÊúâÈóÆÈ¢òÁöÑÂä®ÊÄÅÊï∞ÊçÆÔºåÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü')) {
                return;
            }
            
            try {
                let cleanupCount = 0;
                
                // Ëé∑ÂèñÊâÄÊúâÂä®ÊÄÅ
                const allMoments = await db.moments.toArray();
                
                for (const moment of allMoments) {
                    // Ê£ÄÊü•Âä®ÊÄÅÊòØÂê¶ÊúâÊó†ÊïàÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                    if (moment.avatar && !isValidAvatarUrl(moment.avatar)) {
                        console.log(`ÂèëÁé∞Êó†ÊïàÂ§¥ÂÉèÁöÑÂä®ÊÄÅ: ${moment.id}`);
                        
                        // ‰øÆÂ§çÂ§¥ÂÉèÊàñÂà†Èô§Âä®ÊÄÅ
                        const shouldDelete = confirm(`Âä®ÊÄÅ "${moment.text?.substring(0, 30)}..." ÂåÖÂê´Êó†ÊïàÂ§¥ÂÉèÊï∞ÊçÆÔºåÊòØÂê¶Âà†Èô§Ê≠§Âä®ÊÄÅÔºü\nÁÇπÂáª"ÂèñÊ∂à"Â∞Ü‰øÆÂ§çÂ§¥ÂÉèÊï∞ÊçÆ„ÄÇ`);
                        
                        if (shouldDelete) {
                            await forceCleanMoment(moment.id);
                            cleanupCount++;
                        } else {
                            // ‰øÆÂ§çÂ§¥ÂÉè
                            await db.moments.update(moment.id, { avatar: getDefaultAvatar() });
                        }
                    }
                }
                
                if (cleanupCount > 0) {
                    showToast(`Â∑≤Ê∏ÖÁêÜ ${cleanupCount} Êù°ÊúâÈóÆÈ¢òÁöÑÂä®ÊÄÅ`);
                    // ÈáçÊñ∞Âä†ËΩΩÂä®ÊÄÅÂàóË°®
                    loadMoments();
                } else {
                    showToast('Ê≤°ÊúâÂèëÁé∞ÈúÄË¶ÅÊ∏ÖÁêÜÁöÑÂä®ÊÄÅ');
                }
                
            } catch (error) {
                console.error('Ê∏ÖÁêÜÊçüÂùèÂä®ÊÄÅÂ§±Ë¥•:', error);
                showToast('Ê∏ÖÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Êõ¥Êç¢Âä®ÊÄÅÂ∞ÅÈù¢ÂõæÁâá
        function changeCoverImage() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedImage = await compressImage(file, 1200, 0.8);
                        
                        const coverImage = document.getElementById("cover-image");
                        const coverPlaceholder = document.getElementById("cover-placeholder");
                        
                        if (coverImage && coverPlaceholder) {
                            coverImage.src = compressedImage;
                            coverImage.classList.remove("hide");
                            coverPlaceholder.classList.add("hide");
                        }
                        
                        saveMomentsImage("coverImage", compressedImage);
                        showToast("Â∞ÅÈù¢Â∑≤Êõ¥Êñ∞ÔºÅ", "success");
                    } catch (error) {
                        console.error("Â§ÑÁêÜÂ∞ÅÈù¢ÂõæÁâáÂ§±Ë¥•:", error);
                        showToast("Â∞ÅÈù¢Êõ¥Êñ∞Â§±Ë¥•ÔºÅ", "error");
                    }
                }
            };
            input.click();
        }
        
        // Êõ¥Êç¢Âä®ÊÄÅÂ§¥ÂÉè
        function changeAvatarImage(event) {
            event.stopPropagation();
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        // ÂéãÁº©Â§¥ÂÉèÂõæÁâá
                        const compressedImage = await compressImage(file, 400, 0.9);
                        
                        const avatar = document.getElementById('moments-avatar');
                        const avatarIcon = avatar.querySelector('.moments-avatar-icon');
                        
                        avatar.style.backgroundImage = `url(${compressedImage})`;
                        avatarIcon.style.display = 'none';
                        
                        // ‰øùÂ≠òÂéãÁº©ÂêéÁöÑÂõæÁâá
                        saveMomentsImage('avatarImage', compressedImage);
                        
                        showToast('Â§¥ÂÉèÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
                    } catch (error) {
                        console.error('Â§ÑÁêÜÂ§¥ÂÉèÂõæÁâáÂ§±Ë¥•:', error);
                        showToast('Â§¥ÂÉèÊõ¥Êñ∞Â§±Ë¥•ÔºÅ', 'error');
                    }
                }
            };
            input.click();
        }
        
        // Âä†ËΩΩÂä®ÊÄÅÂõæÁâáËÆæÁΩÆ
        function loadMomentsImages() {
            try {
                // Âä†ËΩΩÂ∞ÅÈù¢ÂõæÁâá
                const savedCover = getMomentsImage('coverImage');
                if (savedCover) {
                    const coverImage = document.getElementById('cover-image');
                    const coverPlaceholder = document.getElementById('cover-placeholder');
                    
                    if (coverImage && coverPlaceholder) {
                        coverImage.src = savedCover;
                        coverImage.classList.remove('hide');
                        coverPlaceholder.classList.add('hide');
                    }
                }
                
                // Âä†ËΩΩÂ§¥ÂÉèÂõæÁâá
                const savedAvatar = getMomentsImage('avatarImage');
                if (savedAvatar) {
                    const avatar = document.getElementById('moments-avatar');
                    const avatarIcon = avatar?.querySelector('.moments-avatar-icon');
                    
                    if (avatar) {
                        avatar.style.backgroundImage = `url(${savedAvatar})`;
                        if (avatarIcon) {
                            avatarIcon.style.display = 'none';
                        }
                    }
                }
                
                // Âä†ËΩΩÁî®Êà∑Âêç
                const savedUsername = getMomentsImage('username');
                if (savedUsername) {
                    const usernameElement = document.getElementById('moments-username');
                    if (usernameElement) {
                        usernameElement.textContent = savedUsername;
                    }
                }
                
                console.log('Âä®ÊÄÅÂõæÁâáÂä†ËΩΩÂÆåÊàê');
            } catch (error) {
                console.error('Âä†ËΩΩÂä®ÊÄÅÂõæÁâáÂ§±Ë¥•:', error);
            }
        }
        
        // Êõ¥ÊîπÁî®Êà∑Âêç
        function changeUsername(event) {
            event.stopPropagation();
            
            const currentUsername = document.getElementById('moments-username').textContent;
            const newUsername = prompt('ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊòµÁß∞:', currentUsername);
            
            if (newUsername !== null && newUsername.trim() !== '') {
                const usernameElement = document.getElementById('moments-username');
                usernameElement.textContent = newUsername.trim();
                
                // ‰øùÂ≠òÁî®Êà∑Âêç
                saveMomentsImage('username', newUsername.trim());
                
                showToast('ÊòµÁß∞Â∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            }
        }
        
        // ÂéãÁº©ÂõæÁâá
        function compressImage(fileOrDataUrl, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // ËÆ°ÁÆóÂéãÁº©ÂêéÁöÑÂ∞∫ÂØ∏
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ÁªòÂà∂ÂéãÁº©ÂêéÁöÑÂõæÁâá
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ËΩ¨Êç¢‰∏∫base64ÔºåÈôç‰ΩéË¥®Èáè‰ª•ÂáèÂ∞ëÂ§ßÂ∞è
                    const compressedData = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedData);
                };
                
                // Âà§Êñ≠ËæìÂÖ•Á±ªÂûãÔºöFileÂØπË±°ËøòÊòØbase64Â≠óÁ¨¶‰∏≤
                if (typeof fileOrDataUrl === 'string') {
                    // Â¶ÇÊûúÊòØbase64Â≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•‰ΩøÁî®
                    img.src = fileOrDataUrl;
                } else {
                    // Â¶ÇÊûúÊòØFileÂØπË±°ÔºåÂàõÂª∫URL
                    img.src = URL.createObjectURL(fileOrDataUrl);
                }
            });
        }
        
        // ‰øùÂ≠òÂä®ÊÄÅÂõæÁâáÔºà‰ΩøÁî®‰ºöËØùÂ≠òÂÇ®ÔºåÈÅøÂÖçÁ©∫Èó¥ÈóÆÈ¢òÔºâ
        function saveMomentsImage(imageType, imageData) {
            try {
                // ‰ΩøÁî®sessionStorageÊöÇÂ≠òÔºåÈ°µÈù¢‰ºöËØùÊúüÈó¥ÊúâÊïà
                sessionStorage.setItem(`moments_${imageType}`, imageData);
                console.log(`Âä®ÊÄÅÂõæÁâáÂ∑≤‰øùÂ≠ò: ${imageType}`);
            } catch (error) {
                console.error('‰øùÂ≠òÂä®ÊÄÅÂõæÁâáÂ§±Ë¥•:', error);
                // Â¶ÇÊûúsessionStorage‰πüÊª°‰∫ÜÔºåÂè™Âú®ÂÜÖÂ≠ò‰∏≠‰øùÂ≠ò
                window.momentsImages = window.momentsImages || {};
                window.momentsImages[imageType] = imageData;
                console.log(`Âä®ÊÄÅÂõæÁâáÂ∑≤‰øùÂ≠òÂà∞ÂÜÖÂ≠ò: ${imageType}`);
            }
        }
        
        // Ëé∑ÂèñÂä®ÊÄÅÂõæÁâá
        function getMomentsImage(imageType) {
            try {
                // ÂÖà‰ªésessionStorageËé∑Âèñ
                const sessionData = sessionStorage.getItem(`moments_${imageType}`);
                if (sessionData) {
                    return sessionData;
                }
                
                // ÁÑ∂Âêé‰ªéÂÜÖÂ≠òËé∑Âèñ
                if (window.momentsImages && window.momentsImages[imageType]) {
                    return window.momentsImages[imageType];
                }
                
                return null;
            } catch (error) {
                console.error('Ëé∑ÂèñÂä®ÊÄÅÂõæÁâáÂ§±Ë¥•:', error);
                return null;
            }
        }
        
        // ÈáçÁΩÆÊï∞ÊçÆÂ∫ìÔºàÂ¶ÇÊûúÂá∫Áé∞schemaÈîôËØØÔºâ
        async function resetDatabase() {
            try {
                await db.delete();
                console.log('Êï∞ÊçÆÂ∫ìÂ∑≤ÈáçÁΩÆ');
                location.reload(); // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
            } catch (error) {
                console.error('ÈáçÁΩÆÊï∞ÊçÆÂ∫ìÂ§±Ë¥•:', error);
            }
        }
        
        // ÂºÄÂßãÊ∏∏Êàè
        function startGame(gameName) {
            if (gameName === 'witchPotion') {
                // TODO: ÂÆûÁé∞Â•≥Â∑´ÁöÑËß£ËçØÊ∏∏Êàè
                alert('Â•≥Â∑´ÁöÑËß£ËçØÊ∏∏ÊàèÊ≠£Âú®ÂºÄÂèë‰∏≠...\n\nËøôÂ∞ÜÊòØ‰∏Ä‰∏™‰∏éAIËßíËâ≤‰∫íÂä®ÁöÑËß£Ë∞úÊ∏∏ÊàèÔºÅ');
            } else {
                alert('Ê∏∏ÊàèÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...');
            }
        }
        
                // ÂàáÊç¢ÊâãÊú∫ËæπÊ°ÜÊòæÁ§∫
        function togglePhoneBorder() {
            const phoneFrame = document.getElementById('phone-frame');
            const phoneScreen = document.getElementById('phone-screen');
            const toggle = document.getElementById('phone-border-toggle');
            const body = document.body;
            
            if (toggle.checked) {
                // ÊòæÁ§∫ÁúüÂÆûÊâãÊú∫ËæπÊ°Ü
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '12px';
                phoneFrame.style.backgroundColor = '#fff';
                phoneFrame.style.borderRadius = '50px';
                phoneFrame.style.boxShadow = '0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1)';
                phoneScreen.style.borderRadius = '40px';
                phoneScreen.style.border = '2px solid #333';
                body.style.background = 'var(--body-bg, #dcdcdc)';
                body.style.padding = '20px';
            } else {
                // ÈöêËóèËæπÊ°ÜÔºå‰ΩÜ‰øùÊåÅphone-screenÁöÑÂúÜËßíÂíåÈò¥ÂΩ±
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '0';
                phoneFrame.style.backgroundColor = 'transparent';
                phoneFrame.style.borderRadius = '0';
                phoneFrame.style.boxShadow = 'none';
                phoneScreen.style.borderRadius = '25px';
                phoneScreen.style.border = 'none';
                phoneScreen.style.boxShadow = 'var(--shadow-phone)';
                body.style.background = 'var(--body-bg, #1a1a1a)';
                body.style.padding = '0';
            }
            
            // ‰øùÂ≠òËÆæÁΩÆÂà∞localStorage
            localStorage.setItem('phoneBorderEnabled', toggle.checked);
            
            // ÊòæÁ§∫ÊèêÁ§∫
            const message = toggle.checked ? 'ÊâãÊú∫ËæπÊ°ÜÂ∑≤ÂºÄÂêØÔºÅ' : 'ÊâãÊú∫ËæπÊ°ÜÂ∑≤ÂÖ≥Èó≠ÔºÅ';
            showToast(message, 'success');
        }
        
        // ÊòæÁ§∫Â±èÂπïÂ∞∫ÂØ∏ÈÄâÊã©
        function showScreenSizeOptions() {
            showApp('screen-size-screen');
        }
        
        // ÊîπÂèòÂ±èÂπïÂ∞∫ÂØ∏
        function changeScreenSize(width, height, name) {
            const phoneScreen = document.getElementById('phone-screen');
            
            // Â∫îÁî®Êñ∞Â∞∫ÂØ∏
            phoneScreen.style.width = width + 'px';
            phoneScreen.style.height = height + 'px';
            
            // Êõ¥Êñ∞Â§ñËßÇËÆæÁΩÆ‰∏≠ÁöÑÊòæÁ§∫ÊñáÊú¨
            const currentSizeDesc = document.getElementById('current-screen-size');
            if (currentSizeDesc) {
                currentSizeDesc.textContent = `ÂΩìÂâçÔºö${width}√ó${height} (${name})`;
            }
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.size-option .check-icon').forEach(icon => {
                icon.style.display = 'none';
            });
            document.querySelectorAll('.size-option').forEach(option => {
                option.style.backgroundColor = '';
            });
            
            // ÊòæÁ§∫ÂΩìÂâçÈÄâ‰∏≠È°πÁöÑÂãæÈÄâÂõæÊ†á
            const currentOption = event.target.closest('.size-option');
            if (currentOption) {
                const checkIcon = currentOption.querySelector('.check-icon');
                if (checkIcon) {
                    checkIcon.style.display = 'block';
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÂãæÈÄâÂõæÊ†áÔºåÂàõÂª∫‰∏Ä‰∏™
                    const newCheckIcon = document.createElement('i');
                    newCheckIcon.className = 'fas fa-check check-icon';
                    newCheckIcon.style.display = 'block';
                    currentOption.appendChild(newCheckIcon);
                }
                currentOption.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
            }
            
            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('screenSize', JSON.stringify({width, height, name}));
            
            // ÊòæÁ§∫ÊèêÁ§∫
            showToast(`Â±èÂπïÂ∞∫ÂØ∏Â∑≤ÂàáÊç¢‰∏∫${name}ÔºÅ`, 'success');
            
            // Âª∂Ëøü‰∏ÄÁÇπÂÜçËøîÂõûÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÈÄâÊã©ÊïàÊûú
            setTimeout(() => {
                showApp('appearance-screen');
            }, 300);
        }
        
        // Âä†ËΩΩÂ±èÂπïÂ∞∫ÂØ∏ËÆæÁΩÆ
        function loadScreenSize() {
            const saved = localStorage.getItem('screenSize');
            if (saved) {
                const {width, height, name} = JSON.parse(saved);
                const phoneScreen = document.getElementById('phone-screen');
                phoneScreen.style.width = width + 'px';
                phoneScreen.style.height = height + 'px';
                
                const currentSizeDesc = document.getElementById('current-screen-size');
                if (currentSizeDesc) {
                    currentSizeDesc.textContent = `ÂΩìÂâçÔºö${width}√ó${height} (${name})`;
                }
            }
        }
        
        // Âä†ËΩΩËæπÊ°ÜËÆæÁΩÆ
        function loadPhoneBorderSetting() {
            const saved = localStorage.getItem('phoneBorderEnabled');
            const toggle = document.getElementById('phone-border-toggle');
            
            // ÈªòËÆ§ÂÖ≥Èó≠ËæπÊ°Ü
            const enabled = saved !== null ? saved === 'true' : false;
            
            if (toggle) {
                toggle.checked = enabled;
            }
            
            // Â∫îÁî®ËÆæÁΩÆ
            const phoneFrame = document.getElementById('phone-frame');
            const phoneScreen = document.getElementById('phone-screen');
            const body = document.body;
            
            if (enabled) {
                // ÊòæÁ§∫ÁúüÂÆûÊâãÊú∫ËæπÊ°Ü
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '12px';
                phoneFrame.style.backgroundColor = '#fff';
                phoneFrame.style.borderRadius = '50px';
                phoneFrame.style.boxShadow = '0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1)';
                phoneScreen.style.borderRadius = '40px';
                phoneScreen.style.border = '2px solid #333';
                body.style.background = 'var(--body-bg, #dcdcdc)';
                body.style.padding = '20px';
            } else {
                // ÈöêËóèËæπÊ°ÜÔºå‰ΩÜ‰øùÊåÅphone-screenÁöÑÂúÜËßíÂíåÈò¥ÂΩ±
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '0';
                phoneFrame.style.backgroundColor = 'transparent';
                phoneFrame.style.borderRadius = '0';
                phoneFrame.style.boxShadow = 'none';
                phoneScreen.style.borderRadius = '25px';
                phoneScreen.style.border = 'none';
                phoneScreen.style.boxShadow = 'var(--shadow-phone)';
                body.style.background = 'var(--body-bg, #1a1a1a)';
                body.style.padding = '0';
            }
        }
        
        // Ê∑ªÂä†ToastÊèêÁ§∫ÂáΩÊï∞
        function showToast(message, type = 'info') {
            // ÂàõÂª∫toastÂÖÉÁ¥†
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                opacity: 0;
                transition: opacity 0.3s ease;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // ÊòæÁ§∫toast
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // ÊñáÊú¨Êà™Êñ≠ÂáΩÊï∞
        function truncateText(text, maxLength = 50) {
    // --- Êñ∞Â¢ûÁöÑÂÆâÂÖ®Ê£ÄÊü• ---
    let textStr = '';
    if (typeof text === 'string') {
        textStr = text;
    } else if (text && typeof text === 'object') {
        // Â¶ÇÊûúÊî∂Âà∞‰∫Ü‰∏Ä‰∏™ÂØπË±°ÔºåÂèØËÉΩÊòØ[object Object]ÈóÆÈ¢òÁöÑÊ†πÊ∫êÔºå
        // Êàë‰ª¨‰∏çÂÜçËÆ©ÂÆÉÂ¥©Ê∫ÉÔºåËÄåÊòØÊòæÁ§∫‰∏Ä‰∏™ÈÄöÁî®Âç†‰ΩçÁ¨¶„ÄÇ
        console.warn("truncateText ÂáΩÊï∞Êî∂Âà∞‰∫Ü‰∏Ä‰∏™ÂØπË±°ÔºåÂ∑≤Ëá™Âä®Â§ÑÁêÜ:", text);
        return '[Â§öÂ™í‰ΩìÊ∂àÊÅØ]';
    } else {
        // ÂØπ‰∫éÂÖ∂‰ªñÊÑèÂ§ñÊÉÖÂÜµ (Â¶Ç null Êàñ undefined)ÔºåËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤„ÄÇ
        return '';
    }
    // --- ÂÆâÂÖ®Ê£ÄÊü•ÁªìÊùü ---

    // Áé∞Âú® textStr ‰øùËØÅÊòØ‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÔºåÂêéÁª≠‰ª£Á†ÅÂèØ‰ª•ÂÆâÂÖ®ÊâßË°å
            const plainText = textStr.replace(/<[^>]*>/g, '');
            const cleanText = plainText.replace(/\s+/g, ' ').trim();
            
            if (cleanText.length <= maxLength) {
                return cleanText;
            }
            
            return cleanText.substring(0, maxLength) + '...';
        }

        // Ê∑ªÂä†Âçï‰∏™Ê∂àÊÅØÂπ∂Â∫îÁî®Âä®ÁîªÊïàÊûú
        function addMessageWithAnimation(message, characterId) {
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer || !currentChatCharacter || characterId !== currentChatCharacter.id) return;
            
            const chatSettings = getCurrentChatSettings();
            const typingIndicator = document.getElementById('typing-indicator');
            
            // Â§ÑÁêÜÁ≥ªÁªüÊ∂àÊÅØ
            if (message.sender === 'system') {
                let systemElement;
                
                if (message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    systemContainer.appendChild(systemMessage);
                    systemElement = systemContainer;
                } else if (message.type === 'recalled_message') {
                    const centerContainer = document.createElement('div');
                    centerContainer.style.display = 'flex';
                    centerContainer.style.justifyContent = 'center';
                    centerContainer.style.margin = '4px 0';
                    centerContainer.dataset.messageId = message.id;
                    
                    const recallElement = document.createElement('div');
                    recallElement.className = 'recalled-message';
                    
                    const lines = message.content.split('\n');
                    const mainText = lines[0];
                    const originalText = lines[1];
                    
                    recallElement.textContent = mainText;
                    
                    if (originalText && originalText.startsWith('ÂéüÊñáÔºö')) {
                        const originalDiv = document.createElement('div');
                        originalDiv.className = 'original-text';
                        originalDiv.textContent = originalText;
                        recallElement.appendChild(originalDiv);
                    }
                    
                    centerContainer.appendChild(recallElement);
                    systemElement = centerContainer;
                    addMessageLongPressListener(centerContainer, message.id);
                } else {
                    const centerContainer = document.createElement('div');
                    centerContainer.style.display = 'flex';
                    centerContainer.style.justifyContent = 'center';
                    centerContainer.style.margin = '4px 0';
                    
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'system-message';
                    systemContainer.textContent = message.content;
                    
                    centerContainer.appendChild(systemContainer);
                    systemElement = centerContainer;
                }
                
                // ‰∏∫Á≥ªÁªüÊ∂àÊÅØÊ∑ªÂä†ÊªëÂÖ•Âä®Áîª
                systemElement.style.opacity = '0';
                systemElement.style.transform = 'translateY(20px)';
                
                messagesContainer.insertBefore(systemElement, typingIndicator);
                
                // Ëß¶ÂèëÂä®Áîª
                requestAnimationFrame(() => {
                    systemElement.classList.add('message-slide-in');
                });
                
                return;
            }
            
            // ÂàõÂª∫ÊôÆÈÄöÊ∂àÊÅØÂÆπÂô®
            let messageContainer = document.createElement('div');
            const isEmojiOnly = message.isEmoji && !message.content;
            messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
            messageContainer.dataset.messageId = message.id;
            
            if (message.sender === 'received') {
                // ==== Áæ§ËÅäÊîØÊåÅ ====
                let character = characters.find(c => c.id === characterId);
                let isGroup = false;
                let group = null;
                if (!character) {
                    group = groupChats.find(g => g.id === characterId);
                    if (group) {
                        isGroup = true;
                    }
                }
                
                let displayAvatar = '';
                let displayName = '';
                let color = '#4CAF50';
                
                if (isGroup && group) {
                    // Áæ§ËÅäÔºöÊ†πÊçÆÊ∂àÊÅØÁöÑsenderIdÊàñnameÊü•ÊâæÊàêÂëò
                    let member = null;
                    if (message.senderId) {
                        member = group.members.find(m => m.id === message.senderId);
                    } else if (message.name) {
                        member = group.members.find(m => m.name === message.name);
                    }
                    displayAvatar = member?.avatarUrl || '';
                    displayName = member?.name || 'Áæ§ÊàêÂëò';
                    color = member?.color || '#4CAF50';
                } else if (character) {
                    // ÂçïËÅä
                    displayAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || character.avatarUrl;
                    displayName = chatSettings.aiChatNickname || character.name;
                    color = character.color || '#4CAF50';
                } else {
                    // ÂÖúÂ∫ïÔºåÈò≤Ê≠¢Êä•Èîô
                    displayAvatar = '';
                    displayName = 'Êú™Áü•';
                    color = '#4CAF50';
                }
                const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                const bubblePadding = chatSettings.bubblePadding || '12';
                
                // Â§ÑÁêÜÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                let messageContent = '';
                
                if (message.type === 'voice_message') {
                    // AIËØ≠Èü≥Ê∂àÊÅØÁõ¥Êé•ÂàõÂª∫voice-message-containerÁªìÊûÑÔºå‰∏çÈúÄË¶ÅÂú®ËøôÈáåÂàõÂª∫messageContent
                    messageContent = '';
                } else if (message.type === 'ai_image') {
                    messageContent = `
                        <div class="ai-image-container">
                            <img src="${message.image}" class="message-image" onclick="showImage('${message.image}')" alt="AIÁîüÊàêÁöÑÂõæÁâá">
                            <div class="image-description">${message.imageDescription || ''}</div>
                        </div>
                    `;
                } else if (message.type === 'transfer') {
                    // ËΩ¨Ë¥¶Ê∂àÊÅØ
                    const isUser = message.role === 'user';
                    const heartIcon = isUser ? 'üíï' : 'üíñ';
                    const titleText = isUser ? '‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶' : 'Êî∂Âà∞ËΩ¨Ë¥¶';
                    let cardClass = '';
                    let statusHtml = '';
                    let clickHandler = '';
                    
                    if (message.status === 'accepted') {
                        statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ' : 'Â∑≤Êî∂Ê¨æ'}</div>`;
                        cardClass = 'accepted';
                    } else if (message.status === 'rejected') {
                        statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤ÈÄÄÂõû' : 'Â∑≤ÈÄÄÂõû'}</div>`;
                        cardClass = 'rejected';
                    } else if (!isUser) {
                        // AIÂèëÊù•ÁöÑËΩ¨Ë¥¶‰∏îÊú™Â§ÑÁêÜÔºåÊ∑ªÂä†ÁÇπÂáªÂ§ÑÁêÜ
                        clickHandler = `onclick="showTransferConfirmDialog(${JSON.stringify(message).replace(/"/g, '&quot;')})"`;
                    }
                    
                    messageContent = `
                        <div class="transfer-message-container received">
                            <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}" ${clickHandler}>
                                <div class="transfer-title">${heartIcon} ${titleText}</div>
                                <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                ${statusHtml}
                            </div>
                        </div>
                    `;
                } else {
                    const chatMode = chatSettings.chatMode || 'online';
                    let processedContent = message.content;
                    
                    if (chatMode === 'offline') {
                        processedContent = processOfflineContent(message.content);
                    }
                    
                    messageContent = processedContent;
                }
                
                let avatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    avatarHtml = `
                        <div class="message-avatar" style="background-color: ${color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" ${character ? `onclick="pokeCharacter('${character.id}')" title="Êà≥‰∏ÄÊà≥"` : `title="${displayName}"`}>
                            ${displayAvatar ? '' : displayName.charAt(0)}
                        </div>
                    `;
                }
                
                const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);
                
                let bubbleHtml = '';
                if (message.type === 'transfer') {
                    // ËΩ¨Ë¥¶Ê∂àÊÅØ‰∏çÈúÄË¶ÅÊ∞îÊ≥°ÂåÖË£π
                    bubbleHtml = messageContent;
                } else {
                    // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                    bubbleHtml = `
                    <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                        ${messageContent}
                        ${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                    </div>
                `;
                }
                
          // üî•„Äê‰øÆÂ§ç„ÄëÁæ§ËÅäÊòµÁß∞ÊòæÁ§∫ ÔºàÁ¨¨‰∏â‰∏™Ê∏≤ÊüìÂáΩÊï∞ÁâàÊú¨Ôºâ- ÁâπÂà´Â§ÑÁêÜËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØ
          if (isGroup && group && displayName !== 'Áæ§ÊàêÂëò') {
    messageContainer.classList.add('group-message-item');
    const senderNameHtml = `<div class="sender-name">${displayName}</div>`;
    
    if (message.type === 'voice_message' || message.type === 'transfer') {
        // üî•„Äê‰øÆÂ§ç„ÄëÂØπ‰∫éËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØÔºåÊòµÁß∞ÈúÄË¶ÅÂú®ÂÆπÂô®Â§ñÈÉ®
    messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    } else {
        // ÊôÆÈÄöÊ∂àÊÅØÁöÑÂ§ÑÁêÜ
        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    }
} else {
                messageContainer.innerHTML = avatarHtml + bubbleHtml;
}
                
                // üî•„Äê‰øÆÂ§ç„ÄëÂ¶ÇÊûúÊòØËØ≠Èü≥Ê∂àÊÅØÔºåÊåâÁÖßrenderChatMessagesÁöÑÁªìÊûÑÂàõÂª∫Ôºå‰ΩÜË¶Å‰øùÁïôÁæ§ËÅäÊòµÁß∞
                if (message.type === 'voice_message') {
                    // ËøáÊª§ÊéâÊã¨Âè∑‰∏≠ÁöÑÊèèËø∞ÊÄßÂÜÖÂÆπÔºå‰øùÁïôÂÆûÈôÖËØ¥ËØùÂÜÖÂÆπ
                    const cleanVoiceContent = message.content.replace(/\([^)]*\)\s*/g, '').trim();
                    const duration = message.duration || Math.max(1, Math.ceil(cleanVoiceContent.length / 8));
                    const durationFormatted = duration < 60 ? `0:${String(duration).padStart(2, '0')}''` : `${Math.floor(duration/60)}:${String(duration%60).padStart(2, '0')}''`;
                    
                    const voiceMessageHTML = `
                        <div class="voice-message-container received">
                            <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${cleanVoiceContent}">
                                    <div class="voice-wave">
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                    </div>
                                    <div class="voice-duration">${durationFormatted}</div>
                                </div>
                            </div>
                            <div class="voice-text-content">${cleanVoiceContent}</div>
                        </div>
                    `;
                    
                    // üî•„Äê‰øÆÂ§ç„Äë‰øùÁïôÁæ§ËÅäÊòµÁß∞ÊòæÁ§∫
                    if (isGroup && group && displayName !== 'Áæ§ÊàêÂëò') {
                        const senderNameHtml = `<div class="sender-name">${displayName}</div>`;
                        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${voiceMessageHTML}</div>`;
                    } else {
                    messageContainer.innerHTML = avatarHtml + voiceMessageHTML;
                    }
                }
            } else {
                // Áî®Êà∑Ê∂àÊÅØ
                let myDisplayAvatar = chatSettings.myChatAvatar;
                
                if (!myDisplayAvatar && chatSettings.selectedIdentityId) {
                    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                    if (selectedPersona && selectedPersona.avatarUrl) {
                        myDisplayAvatar = selectedPersona.avatarUrl;
                    }
                }
                
                const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                const myBubblePadding = chatSettings.bubblePadding || '12';
                
                const transparentMyBubbleColor = convertColorWithOpacity(myBubbleColor, myBubbleOpacity);
                
                let myBubbleHtml = '';
                if (message.type === 'voice') {
                    const duration = message.duration || Math.max(1, Math.ceil(message.content.length / 8));
                    
                    myBubbleHtml = `
                        <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                            <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                <div class="voice-wave">
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                </div>
                                <div class="voice-duration">${duration}"</div>
                            </div>
                        </div>
                    `;
                } else if (message.type === 'location') {
                    // ‰ΩçÁΩÆÊ∂àÊÅØ
                    myBubbleHtml = `
                        <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                            <div class="location-title">${message.locationName}</div>
                            <div class="location-card-map">
                                ${generateRealisticMapHTML()}
                            </div>
                        </div>
                    `;
                } else if (message.type === 'transfer') {
                    // Áî®Êà∑ËΩ¨Ë¥¶Ê∂àÊÅØ
                    let cardClass = '';
                    let statusHtml = '';
                    
                    if (message.status === 'accepted') {
                        statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤Êî∂Ê¨æ</div>`;
                        cardClass = 'accepted';
                    } else if (message.status === 'rejected') {
                        statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤ÈÄÄÂõû</div>`;
                        cardClass = 'rejected';
                    }
                    
                    myBubbleHtml = `
                        <div class="transfer-message-container sent">
                            <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}">
                                <div class="transfer-title">üíï ‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶</div>
                                <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                ${statusHtml}
                            </div>
                        </div>
                    `;
                } else {
                    // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØÊàñÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ (Á¨¨‰∏â‰∏™Ê∏≤ÊüìÂáΩÊï∞ÁâàÊú¨)
                    let messageContentStr = '';
                    if (Array.isArray(message.content)) {
                        // Êñ∞ÁöÑÂ§öÊ®°ÊÄÅÊ†ºÂºè
                        const textPart = message.content.find(p => p.type === 'text');
                        const imagePart = message.content.find(p => p.type === 'image_url');
                        
                        messageContentStr = textPart?.text || '';
                        
                        // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáÊòæÁ§∫
                        if (imagePart?.image_url?.url) {
                            if (messageContentStr) {
                                messageContentStr += '<br>';
                            }
                            messageContentStr += `<img src="${imagePart.image_url.url}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${imagePart.image_url.url}')">`;
                        }
                    } else {
                        // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØÊàñÊóßÊ†ºÂºè
                        messageContentStr = message.content;
                    }
                    
                    myBubbleHtml = `
                    <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                        ${messageContentStr}
                        ${message.image && !Array.isArray(message.content) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                    </div>
                `;
                }
                
                let myAvatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    myAvatarHtml = `
                        <div class="message-avatar" style="background-color: #007AFF; ${myDisplayAvatar ? `background-image: url(${myDisplayAvatar}); background-size: cover; background-position: center;` : ''}">
                            ${myDisplayAvatar ? '' : '<i class="fas fa-user"></i>'}
                        </div>
                    `;
                }
                
                messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                
                // Â¶ÇÊûúÊòØËØ≠Èü≥Ê∂àÊÅØÔºåÊåâÁÖßrenderChatMessagesÁöÑÁªìÊûÑÂàõÂª∫
                if (message.type === 'voice') {
                    // ÂàõÂª∫ÂÆåÊï¥ÁöÑËØ≠Èü≥Ê∂àÊÅØHTMLÔºåÂíårenderChatMessages‰øùÊåÅ‰∏ÄËá¥
                    const voiceMessageHTML = `
                        <div class="voice-message-container sent">
                            <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                    <div class="voice-wave">
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                    </div>
                                    <div class="voice-duration">${message.duration || Math.max(1, Math.ceil(message.content.length / 8))}"</div>
                                </div>
                            </div>
                            <div class="voice-text-content">${message.content}</div>
                        </div>
                    `;
                    
                    messageContainer.innerHTML = voiceMessageHTML + myAvatarHtml;
                }
                
                // Â¶ÇÊûúÊòØ‰ΩçÁΩÆÊ∂àÊÅØÔºåÊåâÁÖßrenderChatMessagesÁöÑÁªìÊûÑÂàõÂª∫
                if (message.type === 'location') {
                    // ÂàõÂª∫ÂÆåÊï¥ÁöÑ‰ΩçÁΩÆÊ∂àÊÅØHTMLÔºåÁ°Æ‰øù‰∏çË¢´ÂåÖË£ÖÂú®Ê∞îÊ≥°‰∏≠
                    const locationMessageHTML = `
                        <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                            <div class="location-title">${message.locationName}</div>
                            <div class="location-card-map">
                                ${generateRealisticMapHTML()}
                            </div>
                        </div>
                    `;
                    
                    messageContainer.innerHTML = locationMessageHTML + myAvatarHtml;
                }
            }
            
            // Ê∑ªÂä†ÊªëÂÖ•Âä®ÁîªÊïàÊûú - ÁÆÄÂçïËá™ÁÑ∂ÁöÑÊªëÂÖ•
            messageContainer.style.opacity = '0';
            messageContainer.style.transform = 'translateY(20px)';
            
            messagesContainer.insertBefore(messageContainer, typingIndicator);
            
            // Ëß¶ÂèëÊªëÂÖ•Âä®Áîª
            requestAnimationFrame(() => {
                messageContainer.classList.add('message-slide-in');
            });
            
            // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®
            addMessageLongPressListener(messageContainer, message.id);
            
            // Ê∑ªÂä†Âè≥ÈîÆËèúÂçïÂäüËÉΩ
            const bubble = messageContainer.querySelector('.message-bubble');
            if (bubble) {
                bubble.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showMessageMenu(message.id, e);
                });
                
                bubble.onclick = (e) => {
                    if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                        showImage(e.target.src);
                    }
                };
            }
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // Â∞ÜÈ¢úËâ≤ÂíåÈÄèÊòéÂ∫¶ËΩ¨Êç¢‰∏∫rgbaÊ†ºÂºè
        function convertColorWithOpacity(color, opacity) {
            // Â¶ÇÊûúÈ¢úËâ≤Â∑≤ÁªèÊòØrgbaÊ†ºÂºèÔºåÁõ¥Êé•ËøîÂõû
            if (color.startsWith('rgba')) {
                return color;
            }
            
            // Â¶ÇÊûúÊòØÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤ÔºåËΩ¨Êç¢‰∏∫rgba
            if (color.startsWith('#')) {
                const hex = color.slice(1);
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            
            // Â¶ÇÊûúÊòØrgbÊ†ºÂºèÔºåËΩ¨Êç¢‰∏∫rgba
            if (color.startsWith('rgb(')) {
                const rgbValues = color.match(/\d+/g);
                return `rgba(${rgbValues[0]}, ${rgbValues[1]}, ${rgbValues[2]}, ${opacity})`;
            }
            
            // Â¶ÇÊûúÊòØÈ¢úËâ≤ÂêçÁß∞ÔºåÂ∞ùËØïËΩ¨Êç¢ÔºàÁÆÄÂçïÂÆûÁé∞Ôºâ
            const colorMap = {
                'red': '255, 0, 0',
                'green': '0, 128, 0',
                'blue': '0, 0, 255',
                'white': '255, 255, 255',
                'black': '0, 0, 0',
                'gray': '128, 128, 128',
                'yellow': '255, 255, 0',
                'cyan': '0, 255, 255',
                'magenta': '255, 0, 255'
            };
            
            if (colorMap[color.toLowerCase()]) {
                return `rgba(${colorMap[color.toLowerCase()]}, ${opacity})`;
            }
            
            // Â¶ÇÊûúÊó†Ê≥ïËØÜÂà´ÔºåËøîÂõûÂéüËâ≤Âä†ÈÄèÊòéÂ∫¶Ôºà‰Ωú‰∏∫Â§áÁî®Ôºâ
            return color;
        }

        // Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆÂäüËÉΩ
        function changeFontSize(size) {
            const fontSize = parseInt(size);
            
            // Êõ¥Êñ∞È¢ÑËßàÊñáÂ≠ó
            const preview = document.getElementById('font-size-preview');
            const valueDisplay = document.getElementById('font-size-value');
            
            if (preview) {
                preview.style.fontSize = fontSize + 'px';
            }
            
            if (valueDisplay) {
                valueDisplay.textContent = fontSize + 'px';
            }
            
            // ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂÖ®Â±ÄÂ≠ó‰ΩìÂ§ßÂ∞èCSSÂèòÈáè
            document.documentElement.style.setProperty('--global-font-size', fontSize + 'px');
            
            // Â∫îÁî®Âà∞ËÅäÂ§©Ê∂àÊÅØ
            applyFontSizeToMessages(fontSize);
            
            // Â∫îÁî®Âà∞Á§æ‰∫§Âä®ÊÄÅ
            applyFontSizeToMoments(fontSize);
            
            // Â¶ÇÊûúÂΩìÂâçÊúâËÅäÂ§©ËßíËâ≤ÔºåÈáçÊñ∞Ê∏≤ÊüìÊ∂àÊÅØ‰ª•Á°Æ‰øùÊñ∞Â≠ó‰ΩìÂ§ßÂ∞èÁîüÊïà
            if (currentChatCharacter && typeof renderChatMessages === 'function') {
                setTimeout(() => {
                    renderChatMessages(currentChatCharacter.id);
                }, 100);
            }
            
            // ‰øùÂ≠òËÆæÁΩÆ
            localStorage.setItem('globalFontSize', fontSize);
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            showToast('Â≠óÂè∑ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ', 'success');
        }
        
        // Â≠óË∑ùËÆæÁΩÆÂäüËÉΩ
        function changeLetterSpacing(spacing) {
            const letterSpacing = parseFloat(spacing);
            
            // Êõ¥Êñ∞È¢ÑËßàÊñáÂ≠ó
            const preview = document.getElementById('font-size-preview');
            const valueDisplay = document.getElementById('letter-spacing-value');
            
            if (preview) {
                preview.style.letterSpacing = letterSpacing + 'px';
            }
            
            if (valueDisplay) {
                // Ê†πÊçÆÊï∞ÂÄºÊòæÁ§∫ÂØπÂ∫îÁöÑÊñáÂ≠óÊèèËø∞
                let description;
                if (letterSpacing < -0.2) {
                    description = 'ÂæàÁ¥ßÂáë';
                } else if (letterSpacing < 0.2) {
                    description = 'Ê†áÂáÜ';
                } else if (letterSpacing < 0.8) {
                    description = 'ËàíÈÄÇ';
                } else if (letterSpacing < 1.5) {
                    description = 'ÂÆΩÊùæ';
                } else {
                    description = 'ÂæàÂÆΩÊùæ';
                }
                valueDisplay.textContent = `${description} (${letterSpacing}px)`;
            }
            
            // ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂÖ®Â±ÄÂ≠óË∑ùCSSÂèòÈáè
            document.documentElement.style.setProperty('--global-letter-spacing', letterSpacing + 'px');
            
            // Â∫îÁî®Âà∞ËÅäÂ§©Ê∂àÊÅØ
            applyLetterSpacingToMessages(letterSpacing);
            
            // Â∫îÁî®Âà∞Á§æ‰∫§Âä®ÊÄÅ
            applyLetterSpacingToMoments(letterSpacing);
            
            // Â¶ÇÊûúÂΩìÂâçÊúâËÅäÂ§©ËßíËâ≤ÔºåÈáçÊñ∞Ê∏≤ÊüìÊ∂àÊÅØ‰ª•Á°Æ‰øùÊñ∞Â≠óË∑ùÁîüÊïà
            if (currentChatCharacter && typeof renderChatMessages === 'function') {
                setTimeout(() => {
                    renderChatMessages(currentChatCharacter.id);
                }, 100);
            }
            
            // ‰øùÂ≠òËÆæÁΩÆ
            localStorage.setItem('globalLetterSpacing', letterSpacing);
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            showToast('Â≠óË∑ùËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ', 'success');
        }
        
        function applyFontSizeToMessages(fontSize) {
            // Â∫îÁî®Âà∞ÊâÄÊúâËÅäÂ§©Ê∂àÊÅØÔºå‰ΩøÁî®!importantÂº∫Âà∂Ë¶ÜÁõñÂÜÖËÅîÊ†∑Âºè
            const messageBubbles = document.querySelectorAll('.message-bubble');
            messageBubbles.forEach(bubble => {
                bubble.style.setProperty('font-size', fontSize + 'px', 'important');
            });
            
            // Â∫îÁî®Âà∞ËÅäÂ§©ËæìÂÖ•Ê°Ü
            const chatInput = document.getElementById('api-chat-input');
            if (chatInput) {
                chatInput.style.fontSize = fontSize + 'px';
            }
        }
        
        function applyFontSizeToMoments(fontSize) {
            // Â∫îÁî®Âà∞ÂæÆÂçöÂä®ÊÄÅÂÜÖÂÆπ
            const postContents = document.querySelectorAll('.post-content');
            postContents.forEach(content => {
                content.style.fontSize = fontSize + 'px';
            });
            
            // Â∫îÁî®Âà∞ÂæÆÂçöËæìÂÖ•Ê°Ü
            const weiboTextarea = document.getElementById('weibo-text');
            if (weiboTextarea) {
                weiboTextarea.style.fontSize = fontSize + 'px';
            }
        }
        
        function applyLetterSpacingToMessages(letterSpacing) {
            // Â∫îÁî®Âà∞ÊâÄÊúâËÅäÂ§©Ê∂àÊÅØ
            const messageBubbles = document.querySelectorAll('.message-bubble');
            messageBubbles.forEach(bubble => {
                bubble.style.setProperty('letter-spacing', letterSpacing + 'px', 'important');
            });
            
            // Â∫îÁî®Âà∞ËÅäÂ§©ËæìÂÖ•Ê°Ü
            const chatInput = document.getElementById('api-chat-input');
            if (chatInput) {
                chatInput.style.letterSpacing = letterSpacing + 'px';
            }
        }
        
        function applyLetterSpacingToMoments(letterSpacing) {
            // Â∫îÁî®Âà∞ÂæÆÂçöÂä®ÊÄÅÂÜÖÂÆπ
            const postContents = document.querySelectorAll('.post-content');
            postContents.forEach(content => {
                content.style.letterSpacing = letterSpacing + 'px';
            });
            
            // Â∫îÁî®Âà∞ÂæÆÂçöËæìÂÖ•Ê°Ü
            const weiboTextarea = document.getElementById('weibo-text');
            if (weiboTextarea) {
                weiboTextarea.style.letterSpacing = letterSpacing + 'px';
            }
        }
        
        function toggleAutoScale() {
            const toggle = document.getElementById('auto-scale-toggle');
            const isEnabled = toggle.checked;
            
            // ‰øùÂ≠òËá™Âä®Áº©ÊîæËÆæÁΩÆ
            localStorage.setItem('autoScaleFont', isEnabled);
            
            if (isEnabled) {
                // Ê†πÊçÆÂ±èÂπïÂ∞∫ÂØ∏Ëá™Âä®Ë∞ÉÊï¥Â≠ó‰Ωì
                autoAdjustFontSize();
                showToast('Â≠ó‰ΩìËá™Âä®Áº©ÊîæÂ∑≤ÂºÄÂêØÔºÅ', 'success');
            } else {
                showToast('Â≠ó‰ΩìËá™Âä®Áº©ÊîæÂ∑≤ÂÖ≥Èó≠ÔºÅ', 'success');
            }
        }
        
        function autoAdjustFontSize() {
            const phoneScreen = document.getElementById('phone-screen');
            if (!phoneScreen) return;
            
            const screenWidth = parseInt(phoneScreen.style.width) || 350;
            
            // Ê†πÊçÆÂ±èÂπïÂÆΩÂ∫¶ËÆ°ÁÆóÊé®ËçêÂ≠ó‰ΩìÂ§ßÂ∞è
            let recommendedSize = 15; // ÈªòËÆ§Â§ßÂ∞è
            
            if (screenWidth <= 320) {
                recommendedSize = 13; // Â∞èÂ±èÂπïÁî®Â∞èÂ≠ó‰Ωì
            } else if (screenWidth <= 350) {
                recommendedSize = 14;
            } else if (screenWidth <= 375) {
                recommendedSize = 15;
            } else if (screenWidth <= 390) {
                recommendedSize = 16;
            } else {
                recommendedSize = 17; // Â§ßÂ±èÂπïÁî®Â§ßÂ≠ó‰Ωì
            }
            
            // Êõ¥Êñ∞ÊªëÂùóÂíåÂ∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞è
            const slider = document.getElementById('font-size-slider');
            if (slider) {
                slider.value = recommendedSize;
                changeFontSize(recommendedSize);
            }
        }
        
        function loadFontSizeSettings() {
            // Âä†ËΩΩÂ≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ
            const savedSize = localStorage.getItem('globalFontSize');
            const fontSize = savedSize ? parseInt(savedSize) : 15;
            
            const slider = document.getElementById('font-size-slider');
            const preview = document.getElementById('font-size-preview');
            const valueDisplay = document.getElementById('font-size-value');
            
            if (slider) {
                slider.value = fontSize;
            }
            
            if (preview) {
                preview.style.fontSize = fontSize + 'px';
            }
            
            if (valueDisplay) {
                valueDisplay.textContent = fontSize + 'px';
            }
            
            // Â∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞è
            document.documentElement.style.setProperty('--global-font-size', fontSize + 'px');
            
            // Âä†ËΩΩÂ≠óË∑ùËÆæÁΩÆ
            const savedSpacing = localStorage.getItem('globalLetterSpacing');
            const letterSpacing = savedSpacing ? parseFloat(savedSpacing) : 0;
            
            const spacingSlider = document.getElementById('letter-spacing-slider');
            const spacingValueDisplay = document.getElementById('letter-spacing-value');
            
            if (spacingSlider) {
                spacingSlider.value = letterSpacing;
            }
            
            if (preview) {
                preview.style.letterSpacing = letterSpacing + 'px';
            }
            
            if (spacingValueDisplay) {
                // Ê†πÊçÆÊï∞ÂÄºÊòæÁ§∫ÂØπÂ∫îÁöÑÊñáÂ≠óÊèèËø∞
                let description;
                if (letterSpacing < -0.2) {
                    description = 'ÂæàÁ¥ßÂáë';
                } else if (letterSpacing < 0.2) {
                    description = 'Ê†áÂáÜ';
                } else if (letterSpacing < 0.8) {
                    description = 'ËàíÈÄÇ';
                } else if (letterSpacing < 1.5) {
                    description = 'ÂÆΩÊùæ';
                } else {
                    description = 'ÂæàÂÆΩÊùæ';
                }
                spacingValueDisplay.textContent = `${description} (${letterSpacing}px)`;
            }
            
            // Â∫îÁî®Â≠óË∑ù
            document.documentElement.style.setProperty('--global-letter-spacing', letterSpacing + 'px');
            
            // Âª∂ËøüÂ∫îÁî®ÔºåÁ°Æ‰øùDOMÂÖÉÁ¥†Â∑≤ÁªèÂä†ËΩΩ
            setTimeout(() => {
                applyFontSizeToMessages(fontSize);
                applyFontSizeToMoments(fontSize);
                applyLetterSpacingToMessages(letterSpacing);
                applyLetterSpacingToMoments(letterSpacing);
            }, 500);
            
            // Âä†ËΩΩËá™Âä®Áº©ÊîæËÆæÁΩÆ
            const autoScale = localStorage.getItem('autoScaleFont');
            const autoScaleToggle = document.getElementById('auto-scale-toggle');
            if (autoScaleToggle) {
                autoScaleToggle.checked = autoScale === 'true';
            }
        }



        // Â∑•ÂÖ∑Ê†èÂäüËÉΩ
        function triggerVoiceMessage() {
            showToast('ËØ≠Èü≥ÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ËØ≠Èü≥ÂΩïÂà∂ÂäüËÉΩ
        }

        // ËÅäÂ§©ÁïåÈù¢ÊãçÁÖßÂäüËÉΩ - ÊñáÂ≠óÊèèËø∞ÂõæÁâáÂèëÈÄÅÁªôAI
        async function openCamera() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©ÂØπË±°', 'error');
                return;
            }
            
            const description = await showCustomPrompt("ÂèëÈÄÅÁÖßÁâá", "ËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÁÖßÁâáÔºö");
            if (description && description.trim()) {
                const msg = {
                    id: Date.now().toString(),
                    sender: 'sent',
                    type: 'user_photo',
                    content: description.trim(),
                    timestamp: Date.now(),
                    photoDescription: description.trim() // ‰øùÂ≠òÂéüÂßãÊèèËø∞Áî®‰∫éÁÇπÂáªÊü•Áúã
                };
                
                // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }
                chatMessages[currentChatCharacter.id].push(msg);
                await saveChatMessages();
                
                // Âà∑Êñ∞ÁïåÈù¢
                renderChatMessages(currentChatCharacter.id);
                renderMessageList();
                
                showToast('ÁÖßÁâáÂ∑≤ÂèëÈÄÅ', 'success');
            }
        }

        function openTransfer() {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂΩìÂâçËÅäÂ§©ËßíËâ≤
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ËÅäÂ§©ÂØπË±°', 'warning');
                return;
            }
            
            // ÊòæÁ§∫ËΩ¨Ë¥¶ÂØπËØùÊ°Ü
            document.getElementById('transfer-modal').classList.add('visible');
        }

        function makeCall() {
            showToast('ÁîµËØùÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÁîµËØùÂäüËÉΩ
        }

        function openVideoCall() {
            showToast('ËßÜÈ¢ëÈÄöËØùÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ËßÜÈ¢ëÈÄöËØùÂäüËÉΩ
        }

        function shareLocation() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }
            
            // ÈáçÁΩÆËæìÂÖ•Ê°Ü
            document.getElementById('location-address').value = '';
            document.getElementById('map-location-display').textContent = 'ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞';
            
            // ÈöèÊú∫ÂåñÂú∞ÂõæÊòæÁ§∫
            randomizeMapPosition();
            
            // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
            renderLocationHistory();
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('location-modal').style.display = 'flex';
        }

        function hideLocationModal() {
            document.getElementById('location-modal').style.display = 'none';
        }

        function setLocationAddress(address) {
            document.getElementById('location-address').value = address;
            document.getElementById('map-location-display').textContent = address;
            
            // ÁîüÊàêÈöèÊú∫ÂùêÊ†á
            const lat = (39.8 + Math.random() * 0.4).toFixed(4);
            const lng = (116.2 + Math.random() * 0.4).toFixed(4);
            document.querySelector('.map-coordinates').textContent = `${lng}¬∞E, ${lat}¬∞N`;
        }

        function randomizeMapPosition() {
            const marker = document.getElementById('location-marker');
            const buildings = document.querySelectorAll('.building');
            
            // ÈöèÊú∫ÁßªÂä®Ê†áËÆ∞‰ΩçÁΩÆ
            const newTop = 20 + Math.random() * 60; // 20% - 80%
            const newLeft = 20 + Math.random() * 60; // 20% - 80%
            marker.style.top = newTop + '%';
            marker.style.left = newLeft + '%';
            
            // ÈöèÊú∫ÁßªÂä®Âª∫Á≠ëÁâ©
            buildings.forEach(building => {
                const top = Math.random() * 85; // 0% - 85%
                const left = Math.random() * 85; // 0% - 85%
                building.style.top = top + '%';
                building.style.left = left + '%';
            });
            
            // Êõ¥Êñ∞ÂùêÊ†á
            const lat = (39.8 + Math.random() * 0.4).toFixed(4);
            const lng = (116.2 + Math.random() * 0.4).toFixed(4);
            document.querySelector('.map-coordinates').textContent = `${lng}¬∞E, ${lat}¬∞N`;
        }

        // ÁîüÊàêÈÄºÁúüÁöÑÂú∞ÂõæHTMLÂÜÖÂÆπ
        function generateRealisticMapHTML() {
            return `
                <div class="map-background"></div>
                <!-- ÂºØÊõ≤Ê≤≥ÊµÅ -->
                <div class="river" style="top: 5%; left: 60%; width: 20px; height: 3px; transform: rotate(35deg);"></div>
                <div class="river-curve" style="top: 12%; left: 72%; width: 18px; height: 3px; transform: rotate(15deg);"></div>
                <div class="river" style="top: 18%; left: 80%; width: 16px; height: 3px; transform: rotate(-5deg);"></div>
                <div class="river-curve" style="top: 22%; left: 85%; width: 15px; height: 3px; transform: rotate(-25deg);"></div>
                <div class="river" style="top: 55%; left: 2%; width: 22px; height: 3px; transform: rotate(-10deg);"></div>
                <div class="river-curve" style="top: 62%; left: 18%; width: 20px; height: 3px; transform: rotate(8deg);"></div>
                <div class="river" style="top: 68%; left: 32%; width: 18px; height: 3px; transform: rotate(25deg);"></div>
                <!-- ÂÖ¨Âõ≠ÁªøÂú∞ -->
                <div class="park" style="top: 20%; left: 65%; width: 18px; height: 15px;"></div>
                <div class="park" style="top: 45%; left: 10%; width: 22px; height: 18px;"></div>
                <!-- ÈÅìË∑Ø -->
                <div class="map-roads">
                    <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                    <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                    <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                </div>
                <!-- Âª∫Á≠ëÁâ© -->
                <div class="map-buildings">
                    <div class="building house" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                    <div class="building office" style="top: 25%; left: 45%; width: 8px; height: 16px;"></div>
                    <div class="building shop" style="top: 50%; left: 50%; width: 14px; height: 8px;"></div>
                    <div class="building house" style="top: 70%; left: 75%; width: 10px; height: 8px;"></div>
                    <div class="building office" style="top: 8%; left: 85%; width: 6px; height: 12px;"></div>
                </div>
                <!-- Ê†ëÊú® -->
                <div class="tree big" style="top: 25%; left: 15%; width: 6px; height: 6px;"></div>
                <div class="tree small" style="top: 55%; left: 25%; width: 4px; height: 4px;"></div>
                <div class="tree big" style="top: 10%; left: 70%; width: 5px; height: 5px;"></div>
                <div class="tree small" style="top: 75%; left: 85%; width: 3px; height: 3px;"></div>
                <div class="tree small" style="top: 40%; left: 80%; width: 4px; height: 4px;"></div>
                <!-- ‰ΩçÁΩÆÊ†áËÆ∞ -->
                <div class="map-marker">
                    <div class="marker-pin" style="color: #1890ff;">üìç</div>
                </div>
            `;
        }

        // ÂéÜÂè≤Âú∞ÁÇπÁÆ°ÁêÜ
        let locationHistory = JSON.parse(localStorage.getItem('locationHistory') || '[]');

        function saveLocationHistory() {
            localStorage.setItem('locationHistory', JSON.stringify(locationHistory));
        }

        function addToLocationHistory(locationName) {
            if (!locationName.trim()) return;
            
            // ÁßªÈô§ÈáçÂ§çÈ°π
            locationHistory = locationHistory.filter(name => name !== locationName);
            // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
            locationHistory.unshift(locationName);
            // ÈôêÂà∂ÊúÄÂ§ö‰øùÂ≠ò10‰∏™
            if (locationHistory.length > 10) {
                locationHistory = locationHistory.slice(0, 10);
            }
            
            saveLocationHistory();
            renderLocationHistory();
        }

        function removeFromLocationHistory(locationName) {
            locationHistory = locationHistory.filter(name => name !== locationName);
            saveLocationHistory();
            renderLocationHistory();
        }

        function renderLocationHistory() {
            const container = document.getElementById('location-history-items');
            if (!container) return;

            if (locationHistory.length === 0) {
                container.innerHTML = '<div class="location-history-empty">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>';
                return;
            }

            container.innerHTML = locationHistory.map(location => 
                `<div class="location-history-item" data-location="${location}" onclick="setLocationAddress('${location}')">
                    <span class="location-text">${location}</span>
                    <span class="delete-btn" onclick="event.stopPropagation(); confirmDeleteLocation('${location}')" title="Âà†Èô§">√ó</span>
                </div>`
            ).join('');
        }

        // ÈïøÊåâÂà†Èô§Â§ÑÁêÜ
        let touchTimer = null;
        let touchedElement = null;

        function handleLocationTouchStart(event, location) {
            touchedElement = event.target;
            touchTimer = setTimeout(() => {
                confirmDeleteLocation(location);
            }, 800); // 800msÈïøÊåâ
        }

        function handleLocationTouchEnd(event) {
            if (touchTimer) {
                clearTimeout(touchTimer);
                touchTimer = null;
            }
            if (touchedElement) {
                touchedElement.classList.remove('deleting');
                touchedElement = null;
            }
        }

        function confirmDeleteLocation(location) {
            if (touchedElement) {
                touchedElement.classList.add('deleting');
            }
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‰ΩçÁΩÆ"${location}"ÂêóÔºü`)) {
                removeFromLocationHistory(location);
                showToast('‰ΩçÁΩÆÂ∑≤Âà†Èô§', 'success');
            } else if (touchedElement) {
                touchedElement.classList.remove('deleting');
            }
        }

        function sendLocationMessage() {
            const address = document.getElementById('location-address').value.trim();
            if (!address) {
                alert('ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞');
                return;
            }

            // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            addToLocationHistory(address);

            // ÂàõÂª∫‰ΩçÁΩÆÊ∂àÊÅØ
            const locationMessage = {
                id: Date.now().toString(),
                sender: 'sent',
                type: 'location',
                locationName: address,
                coordinates: document.querySelector('.map-coordinates').textContent,
                content: `[Áî®Êà∑ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ‰ø°ÊÅØÔºö${address}ÔºåÂùêÊ†áÔºö${document.querySelector('.map-coordinates').textContent}]`,
                timestamp: Date.now()
            };

            console.log('üó∫Ô∏è ÂàõÂª∫‰ΩçÁΩÆÊ∂àÊÅØ:', locationMessage);
            
            // üî•„ÄêË∞ÉËØï„ÄëÊ£ÄÊü•Ê∂àÊÅØÊï∞ÊçÆ
            if (!locationMessage.locationName || !locationMessage.coordinates) {
                console.error('‚ùå ‰ΩçÁΩÆÊ∂àÊÅØÊï∞ÊçÆ‰∏çÂÆåÊï¥:', {
                    locationName: locationMessage.locationName,
                    coordinates: locationMessage.coordinates
                });
                alert('‰ΩçÁΩÆ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåËØ∑ÈáçËØï');
                return;
            }

            // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(locationMessage);

            // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
            saveChatMessages();

            // ‰ΩøÁî®Âä®ÁîªÊ∑ªÂä†Ê∂àÊÅØËÄå‰∏çÊòØÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®
            addMessageWithAnimation(locationMessage, currentChatCharacter.id);

            // ËÆæÁΩÆ‰∏∫ÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = locationMessage;

            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }

            // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
            renderMessageList();

            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            hideLocationModal();

            showToast('‰ΩçÁΩÆÂ∑≤ÂàÜ‰∫´', 'success');
        }

        // Êõ¥Êñ∞Â∑≤Â≠òÂú®ÁöÑ‰ΩçÁΩÆÂç°ÁâáÂú∞Âõæ
        function updateExistingLocationMaps() {
            const locationMaps = document.querySelectorAll('.location-card-map');
            locationMaps.forEach(mapElement => {
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ÔºàÊ≤°ÊúâÊñ∞ÁöÑÂú∞ÂõæÂÖÉÁ¥†Ôºâ
                if (!mapElement.querySelector('.river')) {
                    mapElement.innerHTML = generateRealisticMapHTML();
                }
            });
        }

        // ÁõëÂê¨‰ΩçÁΩÆËæìÂÖ•Ê°ÜÁöÑÂèòÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const locationInput = document.getElementById('location-address');
            if (locationInput) {
                locationInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    if (value) {
                        document.getElementById('map-location-display').textContent = value;
                        
                        // ÁîüÊàêÈöèÊú∫ÂùêÊ†á
                        const lat = (39.8 + Math.random() * 0.4).toFixed(4);
                        const lng = (116.2 + Math.random() * 0.4).toFixed(4);
                        document.querySelector('.map-coordinates').textContent = `${lng}¬∞E, ${lat}¬∞N`;
                    } else {
                        document.getElementById('map-location-display').textContent = 'ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞';
                    }
                });
            }
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
            document.getElementById('location-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('location-modal')) {
                    hideLocationModal();
                }
            });

            // ÂÆöÊúüÊõ¥Êñ∞Áé∞ÊúâÁöÑ‰ΩçÁΩÆÂç°ÁâáÂú∞Âõæ
            setInterval(updateExistingLocationMaps, 1000);
        });

        // ÊòæÁ§∫‰ΩçÁΩÆËØ¶ÊÉÖ
        function showLocationDetail(locationName) {
            alert(`üìç ${locationName}`);
        }
 
        // üìä Êï∞ÊçÆÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞
        
        // ËÆ°ÁÆóÂ≠òÂÇ®Á©∫Èó¥‰ΩøÁî®ÊÉÖÂÜµ
        async function calculateStorageUsage() {
            try {
                let chatSize = 0, characterSize = 0, settingsSize = 0, emojiSize = 0;

                const [chatData, charData, settingsData, emojiData] = await Promise.all([
                    db.chatMessages.toArray(),
                    db.characters.toArray(), 
                    db.chatSettings.toArray(),
                    db.customEmojis.toArray()
                ]);

                chatSize = JSON.stringify(chatData).length;
                characterSize = JSON.stringify(charData).length;
                settingsSize = JSON.stringify(settingsData).length;
                emojiSize = JSON.stringify(emojiData).length;
                const total = chatSize + characterSize + settingsSize + emojiSize;

                // Êõ¥Êñ∞ÊòæÁ§∫
                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };

                if (document.getElementById('chat-storage-size')) {
                    document.getElementById('chat-storage-size').textContent = formatBytes(chatSize);
                    document.getElementById('character-storage-size').textContent = formatBytes(characterSize);
                    document.getElementById('settings-storage-size').textContent = formatBytes(settingsSize);
                    document.getElementById('emoji-storage-size').textContent = formatBytes(emojiSize);
                    document.getElementById('total-storage-size').textContent = formatBytes(total);
                }
            } catch (error) {
                console.error('ËÆ°ÁÆóÂ≠òÂÇ®Â§±Ë¥•:', error);
            }
        }

        // ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ
        async function exportAllData() {
            try {
                showToast('Ê≠£Âú®ÂØºÂá∫Êï∞ÊçÆ...', 'info');
                const exportData = {
                    version: '1.0',
                    exportTime: new Date().toISOString(),
                    characters: await db.characters.toArray(),
                    chatMessages: await db.chatMessages.toArray(),
                    chatSettings: await db.chatSettings.toArray(),
                    customEmojis: await db.customEmojis.toArray()
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `chat_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('ÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
            } catch (error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                showToast('ÂØºÂá∫Â§±Ë¥•', 'error');
            }
        }

        // ÂØºÂÖ•Êï∞ÊçÆ
        function importDataFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    showToast('Ê≠£Âú®ÂØºÂÖ•...', 'info');
                    const text = await file.text();
                    const data = JSON.parse(text);
                    if (!confirm('ÂØºÂÖ•Â∞ÜË¶ÜÁõñÁé∞ÊúâÊï∞ÊçÆÔºåÁ°ÆÂÆöÁªßÁª≠Ôºü')) return;
                    
                    if (data.characters?.length) {
                        await db.characters.clear();
                        await db.characters.bulkAdd(data.characters);
                    }
                    if (data.chatMessages?.length) {
                        await db.chatMessages.clear();
                        await db.chatMessages.bulkAdd(data.chatMessages);
                    }
                    if (data.chatSettings?.length) {
                        await db.chatSettings.clear();
                        await db.chatSettings.bulkAdd(data.chatSettings);
                    }
                    
                    await loadCharacters();
                    await loadChatMessages();
                    await loadChatSettings();
                    renderCharacterList();
                    renderMessageList();
                    calculateStorageUsage();
                    showToast('ÂØºÂÖ•ÊàêÂäüÔºÅ', 'success');
                } catch (error) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•Ôºö' + error.message, 'error');
                }
            };
            input.click();
        }

        // ÊòæÁ§∫Ê∏ÖÁêÜÈÄâÈ°π
        function showCleanupOptions() {
            const choice = prompt('ÈÄâÊã©Ê∏ÖÁêÜÈ°πÁõÆÔºö\n1. Ê∏ÖÈô§Âä®ÊÄÅÂ§¥ÂÉè\n2. Âà†Èô§Á©∫ËÅäÂ§©ËÆ∞ÂΩï\n3. Ê∏ÖÁêÜlocalStorage\n4. ÂéãÁº©ÂõæÁâá\n\nËæìÂÖ•Êï∞Â≠óÔºàÈÄóÂè∑ÂàÜÈöîÔºâÔºö');
            if (choice) executeCleanupOptions(choice);
        }

        // ÊâßË°åÊ∏ÖÁêÜ
        async function executeCleanupOptions(choice) {
            const selections = choice.split(',').map(s => parseInt(s.trim())).filter(n => n >= 1 && n <= 4);
            if (!selections.length) return;
            
            showToast('Ê∏ÖÁêÜ‰∏≠...', 'info');
            let count = 0;
            
            for (const option of selections) {
                switch (option) {
                    case 1:
                        Object.keys(chatSettings).forEach(id => {
                            if (chatSettings[id]?.aiDynamicAvatar) {
                                delete chatSettings[id].aiDynamicAvatar;
                                count++;
                            }
                        });
                        break;
                    case 2:
                        Object.keys(chatMessages).forEach(id => {
                            if (!chatMessages[id]?.length) {
                                delete chatMessages[id];
                                count++;
                            }
                        });
                        break;
                    case 3:
                        for (let i = localStorage.length - 1; i >= 0; i--) {
                            const key = localStorage.key(i);
                            if (key?.startsWith('chatSettings_')) {
                                localStorage.removeItem(key);
                                count++;
                            }
                        }
                        break;
                    case 4:
                        await compressAllImages();
                        break;
                }
            }
            
            await saveChatSettings();
            await saveChatMessages();
            calculateStorageUsage();
            showToast(`Ê∏ÖÁêÜÂÆåÊàêÔºÅÂ§ÑÁêÜ ${count} È°π`, 'success');
        }

        // ÂéãÁº©ÂõæÁâá
        async function compressAllImages() {
            showToast('ÂéãÁº©‰∏≠...', 'info');
            let count = 0;
            
            // ÂéãÁº©ËßíËâ≤Â§¥ÂÉè
            for (const char of characters) {
                if (char.avatarUrl?.length > 50000) {
                    char.avatarUrl = await compressImage(char.avatarUrl, 150, 0.6);
                    count++;
                }
            }
            await saveCharacters();
            
            // ÂéãÁº©ËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉè
            for (const id of Object.keys(chatSettings)) {
                const settings = chatSettings[id];
                if (settings?.aiChatAvatar?.length > 50000) {
                    settings.aiChatAvatar = await compressImage(settings.aiChatAvatar, 150, 0.6);
                    count++;
                }
                if (settings?.myChatAvatar?.length > 50000) {
                    settings.myChatAvatar = await compressImage(settings.myChatAvatar, 150, 0.6);
                    count++;
                }
            }
            await saveChatSettings();
            calculateStorageUsage();
            showToast(`ÂéãÁº©ÂÆåÊàêÔºÅÂ§ÑÁêÜ ${count} Âº†ÂõæÁâá`, 'success');
        }

        // Ë∞ÉËØïÁî®ÔºöÂàóÂá∫ÊâÄÊúâËßíËâ≤IDÂíåÂêçÁß∞ÔºåÂ∏ÆÂä©ËØÜÂà´ÂπΩÁÅµËßíËâ≤
        async function debugListAllCharacters() {
            try {
                console.log('=== ÊâÄÊúâËßíËâ≤Êï∞ÊçÆ ===');
                
                // 1. Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑËßíËâ≤
                const dbChars = await db.characters.toArray();
                console.log('Êï∞ÊçÆÂ∫ìËßíËâ≤Ë°®:', dbChars.map(c => `${c.name} (ID: ${c.id})`));
                
                // 2. ÂÜÖÂ≠ò‰∏≠ÁöÑËßíËâ≤
                if (window.characters) {
                    console.log('ÂÜÖÂ≠òËßíËâ≤ÂàóË°®:', window.characters.map(c => `${c.name} (ID: ${c.id})`));
                }
                
                // 3. ËÅîÁ≥ª‰∫∫ÂàóË°®
                if (window.contacts) {
                    console.log('ËÅîÁ≥ª‰∫∫IDÂàóË°®:', window.contacts);
                }
                
                // 4. Âä®ÊÄÅËØÑËÆ∫‰∏≠ÁöÑËßíËâ≤
                const comments = await db.momentComments.toArray();
                const commentAuthors = [...new Set(comments.map(c => `${c.nickname} (ID: ${c.authorId})`))];
                console.log('Âä®ÊÄÅËØÑËÆ∫‰∏≠ÁöÑËßíËâ≤:', commentAuthors);
                
                // 5. Âä®ÊÄÅÁÇπËµû‰∏≠ÁöÑËßíËâ≤
                const likes = await db.momentLikes.toArray();
                const likeAuthors = [...new Set(likes.map(l => `${l.name} (ID: ${l.authorId})`))];
                console.log('Âä®ÊÄÅÁÇπËµû‰∏≠ÁöÑËßíËâ≤:', likeAuthors);
                
                return {dbChars, comments, likes};
            } catch (error) {
                console.error('Ë∞ÉËØïÂ§±Ë¥•:', error);
            }
        }
        
        // Ë∞ÉËØïÁî®ÔºöÁ≤æÁ°ÆÂà†Èô§ÊåáÂÆöIDÁöÑËßíËâ≤Êï∞ÊçÆ
        async function debugDeleteCharacterById(characterId) {
            if (!characterId) {
                console.log('Áî®Ê≥ï: debugDeleteCharacterById("ËßíËâ≤ID")');
                return;
            }
            
            try {
                console.log(`ÂºÄÂßãÂà†Èô§ËßíËâ≤ID: ${characterId}`);
                let deleteCount = 0;
                
                // 1. ‰ªéÂä®ÊÄÅËØÑËÆ∫‰∏≠Âà†Èô§
                const comments = await db.momentComments.where('authorId').equals(characterId).toArray();
                for (const comment of comments) {
                    await db.momentComments.delete(comment.id);
                    deleteCount++;
                    console.log(`Âà†Èô§ËØÑËÆ∫: ${comment.nickname} - ${comment.text}`);
                }
                
                // 2. ‰ªéÂä®ÊÄÅÁÇπËµû‰∏≠Âà†Èô§
                const likes = await db.momentLikes.where('authorId').equals(characterId).toArray();
                for (const like of likes) {
                    await db.momentLikes.delete([like.momentId, like.authorId]);
                    deleteCount++;
                    console.log(`Âà†Èô§ÁÇπËµû: ${like.name}`);
                }
                
                // 3. ‰ªéÂÖ∂‰ªñË°®‰∏≠Âà†Èô§
                const chatMsgs = await db.chatMessages.where('characterId').equals(characterId).toArray();
                for (const msg of chatMsgs) {
                    await db.chatMessages.delete(msg.id);
                    deleteCount++;
                }
                
                const chatSets = await db.chatSettings.toArray();
                for (const setting of chatSets) {
                    if (setting.characterId === characterId) {
                        await db.chatSettings.delete(setting.id);
                        deleteCount++;
                    }
                }
                
                await db.characters.delete(characterId);
                deleteCount++;
                
                // 4. ‰ªéÂÜÖÂ≠òÊï∞ÁªÑ‰∏≠Âà†Èô§
                if (window.contacts) {
                    window.contacts = window.contacts.filter(id => id !== characterId);
                    await saveContacts();
                }
                if (window.characters) {
                    window.characters = window.characters.filter(char => char.id !== characterId);
                }
                
                console.log(`Âà†Èô§ÂÆåÊàêÔºÅÂÖ±Âà†Èô§ ${deleteCount} Êù°Áõ∏ÂÖ≥Êï∞ÊçÆ`);
                
                // Âà∑Êñ∞ÁïåÈù¢
                if (window.renderContactList) window.renderContactList();
                if (window.renderMessageList) window.renderMessageList();
                
            } catch (error) {
                console.error('Âà†Èô§Â§±Ë¥•:', error);
            }
        }
        
        // Âº∫Âà∂Âà†Èô§ÊåáÂÆöËßíËâ≤ÔºàÁî®‰∫éÊ∏ÖÁêÜÂπΩÁÅµËßíËâ≤Ôºâ
        async function forceDeleteCharacter() {
            const characterName = prompt('ËæìÂÖ•Ë¶ÅÂº∫Âà∂Âà†Èô§ÁöÑËßíËâ≤ÂêçÁß∞ÔºàÂ¶ÇÔºöÊñπÂõûÔºâÔºö');
            if (!characterName || !characterName.trim()) return;
            
            try {
                showToast(`Ê≠£Âú®Âº∫Âà∂Âà†Èô§ËßíËâ≤ "${characterName}"...`, 'info');
                let deleteCount = 0;
                
                // 1. ‰ªéÂä®ÊÄÅËØÑËÆ∫‰∏≠Âà†Èô§
                const comments = await db.momentComments.toArray();
                for (const comment of comments) {
                    if (comment.nickname === characterName || (comment.authorId && comment.authorId.includes(characterName))) {
                        await db.momentComments.delete(comment.id);
                        deleteCount++;
                        console.log(`Âà†Èô§ËØÑËÆ∫Ôºö${comment.nickname} - ${comment.text}`);
                    }
                }
                
                // 2. ‰ªéÂä®ÊÄÅÁÇπËµû‰∏≠Âà†Èô§
                const likes = await db.momentLikes.toArray();
                for (const like of likes) {
                    if (like.name === characterName || (like.authorId && like.authorId.includes(characterName))) {
                        await db.momentLikes.delete([like.momentId, like.authorId]);
                        deleteCount++;
                        console.log(`Âà†Èô§ÁÇπËµûÔºö${like.name}`);
                    }
                }
                
                // 3. ‰ªéËÅäÂ§©Ê∂àÊÅØ‰∏≠Âà†Èô§
                const chatMsgs = await db.chatMessages.toArray();
                for (const msg of chatMsgs) {
                    if (msg.characterId && msg.characterId.includes(characterName)) {
                        await db.chatMessages.delete(msg.id);
                        deleteCount++;
                    }
                }
                
                // 4. ‰ªéËÅäÂ§©ËÆæÁΩÆ‰∏≠Âà†Èô§
                const chatSets = await db.chatSettings.toArray();
                for (const setting of chatSets) {
                    if (setting.characterId && setting.characterId.includes(characterName)) {
                        await db.chatSettings.delete(setting.id);
                        deleteCount++;
                    }
                }
                
                // 5. ‰ªécharactersË°®‰∏≠Âà†Èô§
                const chars = await db.characters.toArray();
                for (const char of chars) {
                    if (char.name === characterName || char.id.includes(characterName)) {
                        await db.characters.delete(char.id);
                        deleteCount++;
                        console.log(`Âà†Èô§ËßíËâ≤Ôºö${char.name} (${char.id})`);
                    }
                }
                
                // 6. ‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠Âà†Èô§
                if (window.contacts) {
                    window.contacts = window.contacts.filter(id => !id.includes(characterName));
                    await saveContacts();
                }
                
                // 7. Ê∏ÖÁêÜÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆ
                if (window.characters) {
                    window.characters = window.characters.filter(char => char.name !== characterName);
                }
                if (window.chatMessages) {
                    Object.keys(window.chatMessages).forEach(key => {
                        if (key.includes(characterName)) {
                            delete window.chatMessages[key];
                        }
                    });
                }
                if (window.chatSettings) {
                    Object.keys(window.chatSettings).forEach(key => {
                        if (key.includes(characterName)) {
                            delete window.chatSettings[key];
                        }
                    });
                }
                
                // Âà∑Êñ∞ÁïåÈù¢
                if (window.renderContactList) window.renderContactList();
                if (window.renderMessageList) window.renderMessageList();
                
                showToast(`Âº∫Âà∂Âà†Èô§ÂÆåÊàêÔºÅÂÖ±Âà†Èô§ ${deleteCount} Êù°Áõ∏ÂÖ≥Êï∞ÊçÆ`, 'success');
                console.log(`Âº∫Âà∂Âà†Èô§ËßíËâ≤ "${characterName}" ÂÆåÊàêÔºåÂà†Èô§‰∫Ü ${deleteCount} Êù°ËÆ∞ÂΩï`);
                
            } catch (error) {
                console.error('Âº∫Âà∂Âà†Èô§Â§±Ë¥•:', error);
                showToast('Âº∫Âà∂Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // Ê∏ÖÁêÜÂ≠§Á´ãËÅîÁ≥ª‰∫∫ÂíåÈáçÂ§çÊï∞ÊçÆ
        async function cleanupOrphanedContacts() {
            try {
                showToast('Ê≠£Âú®Ê∏ÖÁêÜÂ≠§Á´ãÊï∞ÊçÆ...', 'info');
                
                let cleanupCount = 0;
                
                // 1. Ê∏ÖÁêÜËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠‰∏çÂ≠òÂú®ÁöÑËßíËâ≤ID
                const validCharacterIds = characters.map(char => char.id);
                const originalContactsLength = contacts.length;
                contacts = contacts.filter(contactId => {
                    const isValid = validCharacterIds.includes(contactId);
                    if (!isValid) cleanupCount++;
                    return isValid;
                });
                
                // 2. ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Ê∏ÖÁêÜÂ≠§Á´ãÁöÑËÅîÁ≥ª‰∫∫ËÆ∞ÂΩï
                const dbContacts = await db.contacts.toArray();
                for (const contact of dbContacts) {
                    if (!validCharacterIds.includes(contact.characterId)) {
                        await db.contacts.delete(contact.id);
                        cleanupCount++;
                    }
                }
                
                // 3. Ê∏ÖÁêÜËÅäÂ§©Ê∂àÊÅØ‰∏≠‰∏çÂ≠òÂú®ËßíËâ≤ÁöÑËÆ∞ÂΩï
                const chatMessageKeys = Object.keys(chatMessages);
                for (const characterId of chatMessageKeys) {
                    if (!validCharacterIds.includes(characterId)) {
                        delete chatMessages[characterId];
                        cleanupCount++;
                    }
                }
                
                // 4. Ê∏ÖÁêÜÊï∞ÊçÆÂ∫ì‰∏≠Â≠§Á´ãÁöÑËÅäÂ§©Ê∂àÊÅØ
                const dbChatMessages = await db.chatMessages.toArray();
                for (const msgRecord of dbChatMessages) {
                    if (!validCharacterIds.includes(msgRecord.characterId)) {
                        await db.chatMessages.delete(msgRecord.id);
                        cleanupCount++;
                    }
                }
                
                // 5. Ê∏ÖÁêÜËÅäÂ§©ËÆæÁΩÆ‰∏≠‰∏çÂ≠òÂú®ËßíËâ≤ÁöÑËÆ∞ÂΩï
                const chatSettingsKeys = Object.keys(chatSettings);
                for (const characterId of chatSettingsKeys) {
                    if (!validCharacterIds.includes(characterId)) {
                        delete chatSettings[characterId];
                        cleanupCount++;
                    }
                }
                
                // 6. Ê∏ÖÁêÜÊï∞ÊçÆÂ∫ì‰∏≠Â≠§Á´ãÁöÑËÅäÂ§©ËÆæÁΩÆ
                const dbChatSettings = await db.chatSettings.toArray();
                for (const setting of dbChatSettings) {
                    if (!validCharacterIds.includes(setting.characterId)) {
                        await db.chatSettings.delete(setting.id);
                        cleanupCount++;
                    }
                }
                
                // 7. Ê∏ÖÁêÜÂä®ÊÄÅËØÑËÆ∫‰∏≠‰∏çÂ≠òÂú®ËßíËâ≤ÁöÑËÆ∞ÂΩï
                const dbMomentComments = await db.momentComments.toArray();
                for (const comment of dbMomentComments) {
                    // Ê∏ÖÁêÜauthorId‰∏çÂú®ËßíËâ≤ÂàóË°®‰∏≠‰∏î‰∏çÊòØÁî®Êà∑ÁöÑËØÑËÆ∫
                    if (comment.authorId !== 'user' && !validCharacterIds.includes(comment.authorId)) {
                        await db.momentComments.delete(comment.id);
                        cleanupCount++;
                        console.log(`Âà†Èô§‰∫ÜÂ≠§Á´ãËØÑËÆ∫Ôºö${comment.nickname}(${comment.authorId})`);
                    }
                }
                
                // 8. Ê∏ÖÁêÜÂä®ÊÄÅÁÇπËµû‰∏≠‰∏çÂ≠òÂú®ËßíËâ≤ÁöÑËÆ∞ÂΩï
                const dbMomentLikes = await db.momentLikes.toArray();
                for (const like of dbMomentLikes) {
                    // Ê∏ÖÁêÜauthorId‰∏çÂú®ËßíËâ≤ÂàóË°®‰∏≠‰∏î‰∏çÊòØÁî®Êà∑ÁöÑÁÇπËµû
                    if (like.authorId !== 'user' && !validCharacterIds.includes(like.authorId)) {
                        await db.momentLikes.delete([like.momentId, like.authorId]);
                        cleanupCount++;
                        console.log(`Âà†Èô§‰∫ÜÂ≠§Á´ãÁÇπËµûÔºö${like.name}(${like.authorId})`);
                    }
                }
                
                // 9. ‰øùÂ≠òÊ∏ÖÁêÜÂêéÁöÑÊï∞ÊçÆ
                await Promise.all([
                    saveContacts(),
                    saveChatMessages(),
                    saveChatSettings()
                ]);
                
                // 10. ÈáçÊñ∞Ê∏≤ÊüìÁïåÈù¢
                renderContactList();
                renderMessageList();
                
                showToast(`Ê∏ÖÁêÜÂÆåÊàêÔºÅÂÖ±Ê∏ÖÁêÜ‰∫Ü ${cleanupCount} Êù°Â≠§Á´ãÊï∞ÊçÆ`, 'success');
                
                console.log('Ê∏ÖÁêÜÁªìÊûú:', {
                    ÊúâÊïàËßíËâ≤Êï∞: validCharacterIds.length,
                    Ê∏ÖÁêÜÂâçËÅîÁ≥ª‰∫∫Êï∞: originalContactsLength,
                    Ê∏ÖÁêÜÂêéËÅîÁ≥ª‰∫∫Êï∞: contacts.length,
                    ÊÄªÊ∏ÖÁêÜÈ°πÁõÆ: cleanupCount
                });
                
            } catch (error) {
                console.error('Ê∏ÖÁêÜÂ≠§Á´ãÊï∞ÊçÆÂ§±Ë¥•:', error);
                showToast('Ê∏ÖÁêÜÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
        async function clearAllData() {
            const confirm = prompt('Ë≠¶ÂëäÔºöÂ∞ÜÂà†Èô§ÊâÄÊúâÊï∞ÊçÆ‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ\nËæìÂÖ•"Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ"Á°ÆËÆ§Ôºö');
            if (confirm !== 'Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ') return;
            
            try {
                showToast('Ê∏ÖÁ©∫‰∏≠...', 'info');
                await Promise.all([
                    db.characters.clear(),
                    db.chatMessages.clear(), 
                    db.chatSettings.clear(),
                    db.customEmojis.clear()
                ]);
                
                characters = [];
                chatMessages = {};
                chatSettings = {};
                customEmojis = [];
                
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key?.startsWith('chatSettings_')) localStorage.removeItem(key);
                }
                
                renderCharacterList();
                renderMessageList();
                calculateStorageUsage();
                showToast('Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ', 'success');
                
                setTimeout(() => {
                    hideApp('data-management-screen');
                    hideApp('settings-screen');
                }, 2000);
            } catch (error) {
                showToast('Ê∏ÖÁ©∫Â§±Ë¥•', 'error');
            }
        }

        // ÈáçÂ§çÂáΩÊï∞Â∑≤Âà†Èô§

        // ËΩ¨Ë¥¶Áõ∏ÂÖ≥ÂèòÈáè
        let currentTransferMsg = null;
        
        // Â§ÑÁêÜÁî®Êà∑ÂèëÈÄÅÁªôAIÁöÑËΩ¨Ë¥¶
        async function processUserTransfer(userTransferMsg, aiMessages) {
            console.log('üöÄ processUserTransfer Ë¢´Ë∞ÉÁî®:', {
                userTransferMsg,
                aiMessages,
                currentCharacter: currentChatCharacter?.name
            });
            
            if (!userTransferMsg || !currentChatCharacter) {
                console.log('‚ùå processUserTransfer ÈÄÄÂá∫ÔºöÁº∫Â∞ëÂøÖË¶ÅÂèÇÊï∞');
                return;
            }
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            
            // ÂàÜÊûêAIÁöÑÂõûÂ§çÂÜÖÂÆπÔºåÂà§Êñ≠ÊòØÂê¶ÊúâËΩ¨Ë¥¶Áõ∏ÂÖ≥Êìç‰Ωú
            let transferAction = null;
            let transferActionReason = '';
            
            for (const msgData of aiMessages) {
                // Ê£ÄÊü•AIÊòØÂê¶Âú®ÂõûÂ§ç‰∏≠ÊòéÁ°ÆÂ§ÑÁêÜ‰∫ÜËΩ¨Ë¥¶
                if (typeof msgData === 'object' && msgData.type === 'transfer_action') {
                    transferAction = msgData.action; // 'accept', 'reject', 'ignore'
                    transferActionReason = msgData.reason || '';
                    break;
                }
                
                // Ê£ÄÊü•AIÁöÑÊôÆÈÄöÂõûÂ§ç‰∏≠ÊòØÂê¶ÂåÖÂê´ËΩ¨Ë¥¶Â§ÑÁêÜÁöÑÂÖ≥ÈîÆËØç
                if (typeof msgData === 'string') {
                    const content = msgData.toLowerCase();
                    if (content.includes('Êî∂‰∏ã') || content.includes('Ë∞¢Ë∞¢') || content.includes('Êî∂Ê¨æ') || content.includes('Êé•Âèó') || 
                        content.includes('Á°ÆËÆ§Êî∂Ê¨æ') || content.includes('Â∑≤Êî∂Ê¨æ') || content.includes('Êî∂Âà∞‰∫Ü') || 
                        content.includes('ÊÑüË∞¢') || content.includes('Â•ΩÁöÑ') || content.includes('ok') || 
                        content.includes('Ê≤°ÈóÆÈ¢ò') || content.includes('ÂèØ‰ª•')) {
                        transferAction = 'accept';
                        transferActionReason = 'ËßíËâ≤ÂêåÊÑèÊî∂Ê¨æ';

                        break;
                    } else if (content.includes('ÈÄÄÂõû') || content.includes('‰∏çË¶Å') || content.includes('ÊãíÁªù') || 
                              content.includes('‰∏çÈúÄË¶Å') || content.includes('‰∏çÊî∂') || content.includes('ÁÆó‰∫Ü')) {
                        transferAction = 'reject';
                        transferActionReason = 'ËßíËâ≤ÊãíÁªùÊî∂Ê¨æ';

                        break;
                    }
                }
            }
            
            // Â¶ÇÊûúAIÊòéÁ°ÆË°®Á§∫‰∫ÜËΩ¨Ë¥¶Â§ÑÁêÜÊÑèÂõæÔºåÂàôÊâßË°åÁõ∏Â∫îÊìç‰Ωú
            if (transferAction === 'accept' || transferAction === 'reject') {
                const transferIndex = messages.findIndex(msg => 
                    msg.timestamp === userTransferMsg.timestamp && msg.type === 'transfer' && msg.sender === 'sent');
                    
                if (transferIndex !== -1) {
                    // Êõ¥Êñ∞ËΩ¨Ë¥¶Áä∂ÊÄÅ
                    const newStatus = transferAction === 'accept' ? 'accepted' : 'rejected';
                    messages[transferIndex].status = newStatus;
                    
                    console.log('‚úÖ ËΩ¨Ë¥¶Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞:', {
                        oldStatus: userTransferMsg.status,
                        newStatus: newStatus,
                        message: messages[transferIndex]
                    });
                    
                    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                    await saveChatMessages();
                    
                    // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
                    const actionText = transferAction === 'accept' ? 'Â∑≤Êî∂Ê¨æ' : 'Â∑≤ÈÄÄÂõû';
                    const systemMsg = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `${currentChatCharacter.name}${actionText} ¬•${Number(userTransferMsg.amount).toFixed(2)}`,
                        timestamp: Date.now()
                    };
                    
                    messages.push(systemMsg);
                    await saveChatMessages();
                    
                    console.log('üì± Á≥ªÁªüÊ∂àÊÅØÂ∑≤Ê∑ªÂä†:', systemMsg);
                    
                    // Á´ãÂç≥ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢‰ª•ÊòæÁ§∫Êõ¥Êñ∞
                    renderChatMessages(currentChatCharacter.id);
                    
                    // ÊòæÁ§∫Á°ÆËÆ§ÊèêÁ§∫
                    const toastText = transferAction === 'accept' ? 'ËΩ¨Ë¥¶Â∑≤Ë¢´Êé•Âèó' : 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÈÄÄÂõû';
                    showToast(toastText, 'success');
                    
                    console.log('üéâ ËΩ¨Ë¥¶Â§ÑÁêÜÂÆåÊàê');
                } else {
                    console.error('‚ùå Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑËΩ¨Ë¥¶Ê∂àÊÅØ');
                }
            } else {
                console.log('‚ÑπÔ∏è AIÊ≤°ÊúâÊòéÁ°ÆË°®ÊÄÅÔºåËΩ¨Ë¥¶‰øùÊåÅpendingÁä∂ÊÄÅ');
            }
            // Â¶ÇÊûúAIÊ≤°ÊúâÊòéÁ°ÆË°®ÊÄÅÔºåËΩ¨Ë¥¶‰øùÊåÅpendingÁä∂ÊÄÅÔºåÁ≠âÂæÖÁî®Êà∑ÊâãÂä®Â§ÑÁêÜÊàñ‰∏ãÊ¨°AIÂõûÂ§ç
        }
        
        // ËΩ¨Ë¥¶Áõ∏ÂÖ≥ÂáΩÊï∞
        function sendTransfer() {
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            const note = document.getElementById('transfer-note').value.trim();
            
            if (!amount || amount <= 0) {
                showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËΩ¨Ë¥¶ÈáëÈ¢ù', 'warning');
                return;
            }
            
            if (amount > 1000000000) {
                showToast('ËΩ¨Ë¥¶ÈáëÈ¢ù‰∏çËÉΩË∂ÖËøá10‰∫øÂÖÉ', 'warning');
                return;
            }
            
            // ÂàõÂª∫ËΩ¨Ë¥¶Ê∂àÊÅØ - ‰øÆÂ§çÊï∞ÊçÆÁªìÊûÑÂíåËÆæÁΩÆpendingUserMessage
            const transferMessage = {
                id: Date.now().toString(),
                sender: 'sent',  // ‰øÆÂ§çÔºö‰ΩøÁî® sender ËÄå‰∏çÊòØ role
                type: 'transfer',
                amount: amount,
                note: note || 'ËΩ¨Ë¥¶',
                timestamp: Date.now()
            };
            
            // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(transferMessage);
            
            // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
            saveChatMessages();
            
            // ‰ΩøÁî®Âä®ÁîªÊ∑ªÂä†Ê∂àÊÅØËÄå‰∏çÊòØÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®
            addMessageWithAnimation(transferMessage, currentChatCharacter.id);
            
            // üî• „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëËÆæÁΩÆ‰∏∫ÂæÖÂõûÂ§çÊ∂àÊÅØÔºåËÆ©AIËÉΩÁúãÂà∞ËΩ¨Ë¥¶
            pendingUserMessage = transferMessage;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
            
            // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
            renderMessageList();
            
            // ÂÖ≥Èó≠ËΩ¨Ë¥¶ÂØπËØùÊ°Ü
            document.getElementById('transfer-modal').classList.remove('visible');
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('transfer-amount').value = '';
            document.getElementById('transfer-note').value = '';
            
            showToast('ËΩ¨Ë¥¶Â∑≤ÂèëÈÄÅ', 'success');
        }
        
        function showTransferConfirmDialog(transferMsg) {
            if (!transferMsg || transferMsg.status) return;
            
            const modal = document.getElementById('transfer-confirm-modal');
            const amountEl = modal.querySelector('.transfer-confirm-amount');
            const noteEl = modal.querySelector('.transfer-confirm-note');
            
            // ËÆæÁΩÆËΩ¨Ë¥¶‰ø°ÊÅØ
            amountEl.textContent = `¬• ${Number(transferMsg.amount).toFixed(2)}`;
            noteEl.textContent = `Â§áÊ≥®Ôºö${transferMsg.note || 'Êó†'}`;
            
            // Â≠òÂÇ®ÂΩìÂâçÂ§ÑÁêÜÁöÑËΩ¨Ë¥¶‰ø°ÊÅØ
            currentTransferMsg = transferMsg;
            
            // ÊòæÁ§∫ÂØπËØùÊ°Ü
            modal.classList.add('visible');
        }
        
        async function acceptTransfer() {
            if (!currentTransferMsg || !currentChatCharacter) return;
            
            // Âú®ËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
            const messages = chatMessages[currentChatCharacter.id] || [];
            const transferIndex = messages.findIndex(msg => 
                msg.timestamp === currentTransferMsg.timestamp && msg.type === 'transfer');
                
            if (transferIndex !== -1) {
                // Êõ¥Êñ∞ËΩ¨Ë¥¶Áä∂ÊÄÅ
                messages[transferIndex].status = 'accepted';
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await saveChatMessages();
                
                // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢
                renderChatMessages(currentChatCharacter.id);
                
                // Ê∑ªÂä†‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÔºåË°®Á§∫Â∑≤Êî∂Ê¨æ
                const systemMsg = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `‰Ω†Â∑≤Á°ÆËÆ§Êî∂Ê¨æ ¬•${Number(currentTransferMsg.amount).toFixed(2)}`,
                    timestamp: Date.now()
                };
                
                messages.push(systemMsg);
                await saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
            }
            
            // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;
            
            showToast('Â∑≤Á°ÆËÆ§Êî∂Ê¨æ', 'success');
        }
        
        async function rejectTransfer() {
            if (!currentTransferMsg || !currentChatCharacter) return;
            
            // Âú®ËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
            const messages = chatMessages[currentChatCharacter.id] || [];
            const transferIndex = messages.findIndex(msg => 
                msg.timestamp === currentTransferMsg.timestamp && msg.type === 'transfer');
                
            if (transferIndex !== -1) {
                // Êõ¥Êñ∞ËΩ¨Ë¥¶Áä∂ÊÄÅ
                messages[transferIndex].status = 'rejected';
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await saveChatMessages();
                
                // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢
                renderChatMessages(currentChatCharacter.id);
                
                // Ê∑ªÂä†‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÔºåË°®Á§∫Â∑≤ÈÄÄÂõû
                const systemMsg = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `‰Ω†Â∑≤ÈÄÄÂõû ¬•${Number(currentTransferMsg.amount).toFixed(2)}`,
                    timestamp: Date.now()
                };
                
                messages.push(systemMsg);
                await saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
            }
            
            // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;
            
            showToast('Â∑≤ÈÄÄÂõûËΩ¨Ë¥¶', 'success');
        }

        // ÁõëÂê¨appÊòæÁ§∫‰∫ã‰ª∂
        const originalShowApp = window.showApp;
        if (originalShowApp) {
            window.showApp = function(appId) {
                originalShowApp(appId);
                if (appId === 'data-management-screen') calculateStorageUsage();
            };
        }

        // ÊòæÁ§∫ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function showScheduleTimesModal() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduledMomentsTimes || [];
            
            const container = document.getElementById('schedule-times-container');
            container.innerHTML = '';
            
            // Ê∏≤ÊüìÂ∑≤ÊúâÊó∂Èó¥ÁÇπ
            scheduleTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'schedule-time-item';
                timeItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    margin-bottom: 10px;
                    gap: 10px;
                `;
                timeItem.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${index}, this.value)" 
                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <button onclick="removeScheduleTime(${index})" 
                            style="padding: 8px 12px; background: #ff3b30; color: white; border: none; border-radius: 6px; cursor: pointer;">√ó</button>
                `;
                container.appendChild(timeItem);
            });
            
            showModal('schedule-times-modal');
        }
        
        // Ê∑ªÂä†ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function addScheduleTime() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduledMomentsTimes) {
                chatSettings.scheduledMomentsTimes = [];
            }
            
            if (chatSettings.scheduledMomentsTimes.length >= 10) {
                alert('ÊúÄÂ§öÂè™ËÉΩËÆæÁΩÆ10‰∏™Êó∂Èó¥ÁÇπ');
                return;
            }
            
            chatSettings.scheduledMomentsTimes.push('09:00');
            saveCurrentChatSettings(chatSettings);
            showScheduleTimesModal(); // ÈáçÊñ∞Ê∏≤Êüì
        }
        
        // Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function updateScheduleTime(index, newTime) {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduledMomentsTimes && chatSettings.scheduledMomentsTimes[index] !== undefined) {
                chatSettings.scheduledMomentsTimes[index] = newTime;
                saveCurrentChatSettings(chatSettings);
            }
        }
        
        // ÁßªÈô§ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function removeScheduleTime(index) {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduledMomentsTimes && chatSettings.scheduledMomentsTimes[index] !== undefined) {
                chatSettings.scheduledMomentsTimes.splice(index, 1);
                saveCurrentChatSettings(chatSettings);
                showScheduleTimesModal(); // ÈáçÊñ∞Ê∏≤Êüì
            }
        }
        
        // ‰øùÂ≠òÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ
        function saveScheduleTimes() {
            updateScheduleTimesDisplay();
            hideModal('schedule-times-modal');
            showToast('ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÊòæÁ§∫
        function updateScheduleTimesDisplay() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduledMomentsTimes || [];
            const displayElement = document.getElementById('schedule-times-display');
            
            if (scheduleTimes.length === 0) {
                displayElement.textContent = 'Êú™ËÆæÁΩÆ';
            } else if (scheduleTimes.length === 1) {
                displayElement.textContent = `1‰∏™Êó∂Èó¥ÁÇπ (${scheduleTimes[0]})`;
            } else {
                displayElement.textContent = `${scheduleTimes.length}‰∏™Êó∂Èó¥ÁÇπ`;
            }
        }
        
        // ÊµãËØïÂèëÂ∏ÉÂä®ÊÄÅ
        async function testPublishMoment() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }
            
            const button = document.querySelector('button[onclick="testPublishMoment()"]');
            const originalText = button.textContent;
            button.textContent = 'ÂèëÂ∏É‰∏≠...';
            button.disabled = true;
            
            try {
                await triggerBackgroundMomentsTest(currentChatCharacter.id);
                showToast('ÊµãËØïÂä®ÊÄÅÂèëÂ∏ÉÊàêÂäüÔºÅ', 'success');
            } catch (error) {
                console.error('ÊµãËØïÂèëÂ∏ÉÂ§±Ë¥•:', error);
                showToast('ÊµãËØïÂèëÂ∏ÉÂ§±Ë¥•', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // ÂàùÂßãÂåñÂÆöÊó∂ÂèëÂ∏ÉÁ≥ªÁªü
        function initScheduledMomentsSystem() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduledMomentsEnabled || !chatSettings.scheduledMomentsTimes?.length) {
                return;
            }
            
            // ‰∏∫ÊØè‰∏™ËÆæÂÆöÊó∂Èó¥ÂàõÂª∫ÂÆöÊó∂Âô®
            chatSettings.scheduledMomentsTimes.forEach(time => {
                if (!time) return;
                
                const [hours, minutes] = time.split(':').map(Number);
                const now = new Date();
                const scheduledTime = new Date();
                
                scheduledTime.setHours(hours, minutes, 0, 0);
                
                // Â¶ÇÊûúÊó∂Èó¥Â∑≤ËøáÔºåËÆæÁΩÆ‰∏∫ÊòéÂ§©
                if (scheduledTime <= now) {
                    scheduledTime.setDate(scheduledTime.getDate() + 1);
                }
                
                const delay = scheduledTime.getTime() - now.getTime();
                
                setTimeout(() => {
                    // ÊâßË°åÂÆöÊó∂ÂèëÂ∏É
                    triggerBackgroundMoments(currentChatCharacter.id);
                    
                    // ËÆæÁΩÆÊØè24Â∞èÊó∂ÈáçÂ§çÊâßË°å
                    setInterval(() => {
                        triggerBackgroundMoments(currentChatCharacter.id);
                    }, 24 * 60 * 60 * 1000);
                }, delay);
            });
        }

        // ÂàùÂßãÂåñËΩ¨Ë¥¶ÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('DOMContentLoaded', function() {
            // Ê∑ªÂä†ËΩ¨Ë¥¶Áõ∏ÂÖ≥‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('transfer-cancel-btn')?.addEventListener('click', () => {
                document.getElementById('transfer-modal').classList.remove('visible');
            });
            
            document.getElementById('transfer-confirm-btn')?.addEventListener('click', sendTransfer);
            document.getElementById('transfer-accept-btn')?.addEventListener('click', acceptTransfer);
            document.getElementById('transfer-reject-btn')?.addEventListener('click', rejectTransfer);
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
            document.getElementById('transfer-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('transfer-modal')) {
                    document.getElementById('transfer-modal').classList.remove('visible');
                }
            });
            
            document.getElementById('transfer-confirm-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('transfer-confirm-modal')) {
                    document.getElementById('transfer-confirm-modal').classList.remove('visible');
                    currentTransferMsg = null;
                }
            });
        });

        // Áæ§ËÅäÁõ∏ÂÖ≥ÂáΩÊï∞
        function updateGroupChatInfo() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            // Êõ¥Êñ∞Áæ§ËÅäÂ§¥ÂÉèÈ¢ÑËßà
            const groupAvatarPreview = document.getElementById('group-avatar-preview');
            if (groupAvatarPreview) {
                if (currentChatCharacter.avatarUrl) {
                    groupAvatarPreview.src = currentChatCharacter.avatarUrl;
                } else {
                    // ‰ΩøÁî®ÈªòËÆ§ÁöÑÁæ§ËÅäÂ§¥ÂÉè - ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑCanvasÂ§¥ÂÉè
                    const canvas = document.createElement('canvas');
                    canvas.width = 40;
                    canvas.height = 40;
                    const ctx = canvas.getContext('2d');
                    
                    // ÁªòÂà∂ËìùËâ≤ÂúÜÂΩ¢ËÉåÊôØ
                    ctx.beginPath();
                    ctx.arc(20, 20, 20, 0, 2 * Math.PI);
                    ctx.fillStyle = '#4a84c1';
                    ctx.fill();
                    
                    // ÁªòÂà∂ÁôΩËâ≤"Áæ§"Â≠ó
                    ctx.fillStyle = 'white';
                    ctx.font = '18px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('Áæ§', 20, 20);
                    
                    groupAvatarPreview.src = canvas.toDataURL();
                }
            }
            
            // Êõ¥Êñ∞Áæ§ËÅäÂêçÁß∞ÊòæÁ§∫
            const groupNameDisplay = document.getElementById('group-name-display');
            if (groupNameDisplay) {
                groupNameDisplay.textContent = currentChatCharacter.name || 'Áæ§ËÅäÂêçÁß∞';
            }
            
            // Êõ¥Êñ∞Áæ§ÊàêÂëòÊï∞ÈáèÊòæÁ§∫
            const groupMemberCountDisplay = document.getElementById('group-member-count-display');
            if (groupMemberCountDisplay) {
                const memberCount = currentChatCharacter.members ? currentChatCharacter.members.length : 0;
                // Áæ§ÊàêÂëòÊï∞Èáè = ËßíËâ≤Êï∞Èáè + 1‰∏™Áî®Êà∑
                const totalMemberCount = memberCount + 1;
                groupMemberCountDisplay.textContent = `${totalMemberCount}ÂêçÊàêÂëò`;
            }
            
            // Êõ¥Êñ∞Áæ§ÂÖ¨ÂëäÊòæÁ§∫
            const groupDescriptionDisplay = document.getElementById('group-description-display');
            if (groupDescriptionDisplay) {
                groupDescriptionDisplay.textContent = currentChatCharacter.description || 'Áæ§ÂÖ¨ÂëäÔºöÁÇπÂáªËÆæÁΩÆÁæ§ÂÖ¨Âëä';
            }
            
            // Êõ¥Êñ∞ÊàëÂú®Áæ§ÈáåÁöÑÊòµÁß∞ - ‰ΩøÁî®ÂΩìÂâçÈÄâÊã©ÁöÑÈù¢ÂÖ∑ÂêçÁß∞‰Ωú‰∏∫ÈªòËÆ§ÂÄº
            const currentMyGroupNickname = document.getElementById('current-my-group-nickname');
            if (currentMyGroupNickname) {
                let defaultNickname = 'Êú™ÈÄâÊã©';
        
        // --- Êñ∞Â¢û‰ª£Á†ÅÂºÄÂßã ---
        const chatSettings = getCurrentChatSettings();
        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
        // --- Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ---

                // Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©‰∫ÜÈù¢ÂÖ∑Ôºå‰ΩøÁî®Èù¢ÂÖ∑ÂêçÁß∞
        if (selectedPersona && selectedPersona.name) { // <--- ‰øÆÊîπËøôÈáå
            defaultNickname = selectedPersona.name;
                }
        
        // ‰ºòÂÖàÊòæÁ§∫Áî®Êà∑Âú®Áæ§ËÅä‰∏≠Ëá™Â∑±ËÆæÁΩÆÁöÑÊòµÁß∞ÔºåÂ¶ÇÊûúÊ≤°ÊúâÔºåÂàôÊòæÁ§∫ÂàõÂª∫Áæ§ËÅäÊó∂ÈÄâÊã©ÁöÑË∫´‰ªΩÊòµÁß∞
        currentMyGroupNickname.textContent = chatSettings.myChatNickname || defaultNickname;
            }
            
            // Ê∏≤ÊüìÁæ§ÊàêÂëòÁΩëÊ†º
            renderGroupMembersGrid();
        }
        
        function changeGroupAvatar() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            const tempInput = document.createElement('input');
            tempInput.type = 'file';
            tempInput.accept = 'image/*';
            tempInput.style.display = 'none';
            document.body.appendChild(tempInput);
            
            tempInput.onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËßíËâ≤ÁöÑÂ§¥ÂÉè
                        currentChatCharacter.avatarUrl = event.target.result;
                        
                        // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÈúÄË¶ÅÊõ¥Êñ∞Áæ§ËÅäÊï∞ÊçÆ
                        if (groupChats) {
                            const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                            if (groupIndex !== -1) {
                                groupChats[groupIndex].avatarUrl = event.target.result;
                                await saveGroupChats(groupChats);
                            }
                        }
                        
                        // Êõ¥Êñ∞UIÊòæÁ§∫
                        updateGroupChatInfo();
                        document.getElementById('api-chat-title').textContent = currentChatCharacter.name;
                        
                        // Êõ¥Êñ∞Â§¥ÂÉèÊòæÁ§∫
                        const chatAvatarElement = document.querySelector('#api-chat-screen .message-avatar img');
                        if (chatAvatarElement) {
                            chatAvatarElement.src = event.target.result;
                        }
                        
                        // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®ÂíåËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅäÂ§¥ÂÉè
                        renderContactList();
                        renderMessageList();
                        
                        document.body.removeChild(tempInput);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                } else {
                    document.body.removeChild(tempInput);
                }
            };
            
            tempInput.click();
        }
        
        function changeGroupName() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁæ§ËÅäÂêçÁß∞:', currentChatCharacter.name);
            if (newName && newName.trim() !== '') {
                const trimmedName = newName.trim();
                
                // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËßíËâ≤ÁöÑÂêçÁß∞
                currentChatCharacter.name = trimmedName;
                
                // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÈúÄË¶ÅÊõ¥Êñ∞Áæ§ËÅäÊï∞ÊçÆ
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                        groupChats[groupIndex].name = trimmedName;
                        saveGroupChats(groupChats);
                    }
                }
                
                // Êõ¥Êñ∞UIÊòæÁ§∫
                updateGroupChatInfo();
                document.getElementById('api-chat-title').textContent = trimmedName;
                renderContactList();
                renderMessageList();
            }
        }
        
// --- ËØ∑‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ÔºåÊõøÊç¢ÊéâÊóßÁöÑ showGroupChatMemberSelection Âíå renderGroupMembersGrid ÂáΩÊï∞ ---

// 5. ÊòæÁ§∫Áæ§ÊàêÂëòÈÄâÊã© (Â∑≤‰øÆÊ≠£ÁâàÊú¨)
function showGroupChatMemberSelection(personaId) {
    console.log('‚úÖ Á¨¨‰∫å‰∏™showGroupChatMemberSelectionË¢´Ë∞ÉÁî®ÔºåÊé•Êî∂Âà∞ÁöÑpersonaId:', personaId);
    
    // Á´ãÂç≥Â∞ÜpersonaIdÂ≠òÂÇ®Âà∞ÂÖ®Â±ÄÂèòÈáè‰∏≠ÔºåÁ°Æ‰øù‰∏ç‰ºö‰∏¢Â§±
    window.currentGroupPersonaId = personaId;
    
    // ÈáçÁΩÆË°®Âçï
    document.getElementById('group-chat-name').value = '';
    selectedGroupMembers = [];
    
    const membersContainer = document.getElementById('group-chat-members');
    membersContainer.innerHTML = '';
    
    if (characters.length < 2) {
        membersContainer.innerHTML = '<p class="empty-mount-chats">Ëá≥Â∞ëÈúÄË¶Å2‰∏™ËßíËâ≤ÊâçËÉΩÂàõÂª∫Áæ§ËÅä</p>';
    } else {
        characters.forEach(character => {
            const memberItem = document.createElement('div');
            memberItem.className = 'group-member-item';
            memberItem.onclick = () => toggleGroupMemberSelection(character.id);
            // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÈáçÊñ∞Ê∑ªÂä†‰∫ÜÊòæÁ§∫ËßíËâ≤ÁÆÄ‰ªãÁöÑHTML‰ª£Á†Å
            memberItem.innerHTML = `
                <div class="group-member-checkbox" id="checkbox-${character.id}"></div>
                <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url('${character.avatarUrl}'); background-size: cover; background-position: center;` : ''}">
                    ${character.avatarUrl ? '' : character.name.charAt(0)}
                </div>
                <div class="chat-option-text">
                    <div class="chat-option-title">${character.name}</div>
                    <div class="chat-option-desc">${truncateText(character.bio || 'ÊöÇÊó†ÁÆÄ‰ªã', 80)}</div>
                </div>`;
            membersContainer.appendChild(memberItem);
        });
    }

    // Â∞Ü personaId ÈôÑÂä†Âà∞ÂàõÂª∫ÊåâÈíÆ‰∏ä
    console.log('‚úÖ Âú®Á¨¨‰∫å‰∏™‰ΩçÁΩÆÁªëÂÆöÂàõÂª∫ÊåâÈíÆÔºåpersonaId:', personaId);
    const createBtn = document.getElementById('group-chat-modal').querySelector('.modal-primary');
    createBtn.onclick = () => {
        console.log('‚úÖ Á¨¨‰∫å‰∏™‰ΩçÁΩÆÁöÑÂàõÂª∫Áæ§ËÅäÊåâÈíÆË¢´ÁÇπÂáªÔºåÁõ¥Êé•‰ΩøÁî®ÂèÇÊï∞personaId:', personaId);
        createGroupChat(personaId);
    }; // ÁªëÂÆöÂ∏¶ÂèÇÊï∞ÁöÑÂàõÂª∫ÂáΩÊï∞

    showModal('group-chat-modal');
}


// Ê∏≤ÊüìÁæ§ÊàêÂëòÁΩëÊ†º (Â∑≤‰øÆÊ≠£ÁâàÊú¨)
        function renderGroupMembersGrid() {
            const groupMembersGrid = document.getElementById('group-members-grid');
            if (!groupMembersGrid || !currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
            groupMembersGrid.innerHTML = '';
            
    // --- ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊ≠£Á°ÆËé∑ÂèñÂπ∂ÊòæÁ§∫Áî®Êà∑Âú®ÂΩìÂâçÁæ§ËÅä‰∏≠ÁöÑË∫´‰ªΩ ---
    const chatSettings = getCurrentChatSettings(); // Ëé∑ÂèñÂΩìÂâçÁæ§ËÅäÁöÑ‰∏ìÂ±ûËÆæÁΩÆ
    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    
            let userName = 'Áî®Êà∑';
            let userAvatar = '';
            
    if (selectedPersona) {
        // ‰ºòÂÖà‰ΩøÁî®Áæ§ËÅäËÆæÁΩÆÈáå‰∏∫‚ÄúÊàë‚ÄùÂçïÁã¨ËÆæÁΩÆÁöÑÊòµÁß∞ÂíåÂ§¥ÂÉè
        userName = chatSettings.myChatNickname || selectedPersona.name;
        userAvatar = chatSettings.myChatAvatar || selectedPersona.avatarUrl;
    }
    
    // Ê∑ªÂä†Áî®Êà∑Ëá™Â∑±ÔºàÊéíÂú®Á¨¨‰∏Ä‰ΩçÔºâ
    const userItem = document.createElement('div');
    userItem.className = 'member-item user-member';
    userItem.onclick = () => changeMyGroupAvatar();
            userItem.innerHTML = `
                <img class="member-avatar" src="${userAvatar || createDefaultAvatar(userName)}" alt="${userName}">
                <div class="member-name">${userName}</div>
            `;
            groupMembersGrid.appendChild(userItem);
    // --- ‰øÆÂ§çÁªìÊùü ---
            
            // ÁÑ∂ÂêéÊ∑ªÂä†Áæ§ÂÜÖÁé∞ÊúâËßíËâ≤
            if (currentChatCharacter.members && currentChatCharacter.members.length > 0) {
                currentChatCharacter.members.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    
                    memberItem.innerHTML = `
                        <div class="member-avatar-wrapper">
                            <img class="member-avatar clickable-avatar" 
                                 src="${member.avatarUrl || createDefaultAvatar(member.name)}" 
                                 alt="${member.name}"
                                 onclick="changeMemberAvatar('${member.id}', event)"
                                 title="ÁÇπÂáªÊõ¥Êç¢${member.name}ÁöÑÂ§¥ÂÉè">
                            <div class="avatar-hover-hint">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="member-name">${member.name}</div>
                    `;
                    groupMembersGrid.appendChild(memberItem);
                });
            }
            
            // Ê∑ªÂä†ÈÇÄËØ∑ÊåâÈíÆ
            const addMemberBtn = document.createElement('div');
            addMemberBtn.className = 'member-item add-member';
            addMemberBtn.onclick = () => addGroupMember();
            addMemberBtn.innerHTML = `
                <div class="member-avatar add-avatar">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="member-name">ÈÇÄËØ∑</div>
            `;
            groupMembersGrid.appendChild(addMemberBtn);
            
            // Âè™Ë¶ÅÁæ§ÂÜÖÊúâËßíËâ≤ÊàêÂëòÂ∞±ÊòæÁ§∫ÁßªÈô§ÊåâÈíÆ
            if (currentChatCharacter.members && currentChatCharacter.members.length > 0) {
                const removeMemberBtn = document.createElement('div');
                removeMemberBtn.className = 'member-item remove-member';
                removeMemberBtn.onclick = () => removeGroupMember();
                removeMemberBtn.innerHTML = `
                    <div class="member-avatar remove-avatar">
                        <i class="fas fa-minus"></i>
                    </div>
                    <div class="member-name">ÁßªÈô§</div>
                `;
                groupMembersGrid.appendChild(removeMemberBtn);
            }
        }

// --- ËØ∑Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ---
        
        // ÊòæÁ§∫ÊàêÂëòËØ¶ÊÉÖ
        function showMemberProfile(member) {
            alert(`üë§ Áæ§ÊàêÂëò‰ø°ÊÅØ\n\nÊòµÁß∞Ôºö${member.name}\nËßíËâ≤IDÔºö${member.id}\n\nÁÇπÂáªÂ§¥ÂÉèÂèØ‰ª•Êü•ÁúãËßíËâ≤ËØ¶ÁªÜ‰ø°ÊÅØ`);
        }
        
        // ÊòæÁ§∫Áî®Êà∑Ëá™Â∑±ÁöÑËµÑÊñô
        function showUserProfile() {
            let userName = 'Áî®Êà∑';
            let userInfo = 'Áæ§ËÅäÊàêÂëò';
            
            if (currentPersona) {
                userName = currentPersona.name;
                userInfo = `ÂΩìÂâçÈù¢ÂÖ∑Ôºö${currentPersona.name}`;
                if (currentPersona.description) {
                    userInfo += `\nÈù¢ÂÖ∑ÊèèËø∞Ôºö${currentPersona.description}`;
                }
            } else if (currentChatCharacter.myNickname) {
                userName = currentChatCharacter.myNickname;
                userInfo = `Áæ§ÊòµÁß∞Ôºö${currentChatCharacter.myNickname}`;
            }
            
            alert(`üë§ ÊàëÁöÑ‰ø°ÊÅØ\n\nÊòµÁß∞Ôºö${userName}\nË∫´‰ªΩÔºö${userInfo}\n\nËøôÊòØ‰Ω†Ëá™Â∑±Âú®Áæ§ËÅä‰∏≠ÁöÑ‰ø°ÊÅØ`);
        }
        
        // ÂàõÂª∫ÈªòËÆ§Â§¥ÂÉè
        function createDefaultAvatar(name) {
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            
            // ÈöèÊú∫ËÉåÊôØÈ¢úËâ≤
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF'];
            const bgColor = colors[name.charCodeAt(0) % colors.length];
            
            // ÁªòÂà∂ÂúÜÂΩ¢ËÉåÊôØ
            ctx.beginPath();
            ctx.arc(25, 25, 25, 0, 2 * Math.PI);
            ctx.fillStyle = bgColor;
            ctx.fill();
            
            // ÁªòÂà∂ÊñáÂ≠ó
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(name.charAt(0), 25, 25);
            
            return canvas.toDataURL();
        }
        
        function showGroupMembers() {
            alert('üë• Áæ§ÊàêÂëòÁÆ°ÁêÜÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂ∞ÜÊîØÊåÅ‰ª•‰∏ãÂäüËÉΩÔºö\n‚Ä¢ Êü•ÁúãÁæ§ÊàêÂëòÂàóË°®\n‚Ä¢ ËÆæÁΩÆÁæ§ÁÆ°ÁêÜÂëò\n‚Ä¢ ÁÆ°ÁêÜÁæ§ÊàêÂëòÊùÉÈôê\n‚Ä¢ Á¶ÅË®Ä/Ë∏¢Âá∫Áæ§ËÅä');
        }
        
        async function changeMyGroupNickname() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
    const chatSettings = getCurrentChatSettings();
    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    
    const currentNickname = chatSettings.myChatNickname || (selectedPersona ? selectedPersona.name : 'Áî®Êà∑');
    const newNickname = prompt('ËØ∑ËæìÂÖ•ÊàëÂú®Êú¨Áæ§ÁöÑÊòµÁß∞:', currentNickname);

    if (newNickname && newNickname.trim() !== '' && newNickname.trim() !== currentNickname) {
                const trimmedNickname = newNickname.trim();
                
        // 1. Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËÆæÁΩÆ‰∏≠ÁöÑÊòµÁß∞
        chatSettings.myChatNickname = trimmedNickname;
        await saveCurrentChatSettings(chatSettings);
        
        // 2. ÂàõÂª∫Âπ∂Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
        const systemMessage = {
            id: 'system_' + Date.now(),
            sender: 'system',
            content: `‰Ω†Â∑≤Â∞ÜÁæ§ÊòµÁß∞‰øÆÊîπ‰∏∫ "${trimmedNickname}"`,
            timestamp: Date.now()
        };
        
        if (!chatMessages[currentChatCharacter.id]) {
            chatMessages[currentChatCharacter.id] = [];
        }
        chatMessages[currentChatCharacter.id].push(systemMessage);
        await saveChatMessages();
        
        // 3. Êõ¥Êñ∞UI
        updateGroupChatInfo(); // Ëøô‰ºöÂà∑Êñ∞ËÆæÁΩÆÈ°µÈù¢ÁöÑÊòæÁ§∫
        renderChatMessages(currentChatCharacter.id); // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ

        showToast('Áæ§ÊòµÁß∞‰øÆÊîπÊàêÂäüÔºÅ', 'success');
    }
}
// --- Êñ∞Â¢ûÂáΩÊï∞ ---
async function changeMyGroupAvatar() {
    if (!currentChatCharacter) return;

    // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.style.display = 'none';

    // ÂΩìÁî®Êà∑ÈÄâÊã©‰∫ÜÊñá‰ª∂Âêé
    input.onchange = async (e) => {
        if (!e.target.files || !e.target.files[0]) return;
        
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = async (event) => {
            const newAvatarUrl = event.target.result;

            // 1. Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉè
            const chatSettings = getCurrentChatSettings();
            chatSettings.myChatAvatar = newAvatarUrl;
            await saveCurrentChatSettings(chatSettings);
            
            // 2. ÂàõÂª∫Âπ∂Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
            const systemMessage = {
                id: 'system_' + Date.now(),
                sender: 'system',
                content: `‰Ω†Êõ¥Êç¢‰∫ÜÊñ∞Â§¥ÂÉè`,
                timestamp: Date.now()
            };

            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(systemMessage);
            await saveChatMessages();

            // 3. Êõ¥Êñ∞UI
            updateGroupChatInfo(); // Âà∑Êñ∞ËÆæÁΩÆÈ°µÈù¢ÁöÑÊàêÂëòÂàóË°®
            renderChatMessages(currentChatCharacter.id); // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫Êñ∞Â§¥ÂÉèÂíåÁ≥ªÁªüÊ∂àÊÅØ

            showToast('Áæ§Â§¥ÂÉèÊõ¥Êç¢ÊàêÂäüÔºÅ', 'success');
        };
        
        reader.readAsDataURL(file);
        document.body.removeChild(input); // Ê∏ÖÁêÜ‰∏¥Êó∂ÁöÑinputÂÖÉÁ¥†
    };

    document.body.appendChild(input);
    input.click(); // ÂºπÂá∫Êñá‰ª∂ÈÄâÊã©Á™óÂè£
        }
        
        // ÁºñËæëÁæ§ÂÖ¨Âëä
        function editGroupDescription() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            showGroupNoticeModal();
        }
        
        // ÊòæÁ§∫Áæ§ÂÖ¨ÂëäÁºñËæëÊ®°ÊÄÅÊ°Ü
        function showGroupNoticeModal() {
            const modal = document.getElementById('group-notice-modal');
            const textarea = document.getElementById('group-notice-content');
            const charCount = document.getElementById('notice-char-current');
            
            // ËÆæÁΩÆÂΩìÂâçÁæ§ÂÖ¨ÂëäÂÜÖÂÆπ
            const currentDescription = currentChatCharacter?.description || '';
            textarea.value = currentDescription;
            charCount.textContent = currentDescription.length;
            
            // ÁõëÂê¨Â≠óÁ¨¶Êï∞ÂèòÂåñ
            textarea.addEventListener('input', updateNoticeCharCount);
            
            modal.style.display = 'flex';
            setTimeout(() => textarea.focus(), 100);
        }
        
        // ÈöêËóèÁæ§ÂÖ¨ÂëäÁºñËæëÊ®°ÊÄÅÊ°Ü
        function hideGroupNoticeModal() {
            const modal = document.getElementById('group-notice-modal');
            const textarea = document.getElementById('group-notice-content');
            
            // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
            textarea.removeEventListener('input', updateNoticeCharCount);
            
            modal.style.display = 'none';
        }
        
        // Êõ¥Êñ∞Â≠óÁ¨¶ËÆ°Êï∞
        function updateNoticeCharCount() {
            const textarea = document.getElementById('group-notice-content');
            const charCount = document.getElementById('notice-char-current');
            charCount.textContent = textarea.value.length;
            
            // Â¶ÇÊûúË∂ÖËøáÈôêÂà∂ÔºåÂèòËâ≤ÊèêÁ§∫
            if (textarea.value.length > 500) {
                charCount.style.color = '#ff3b30';
            } else if (textarea.value.length > 450) {
                charCount.style.color = '#ff9500';
            } else {
                charCount.style.color = '#007AFF';
            }
        }
        
        // ‰øùÂ≠òÁæ§ÂÖ¨Âëä
        function saveGroupNotice() {
            const textarea = document.getElementById('group-notice-content');
            const newDescription = textarea.value.trim();
            
            if (newDescription.length > 500) {
                alert('Áæ§ÂÖ¨ÂëäÂÜÖÂÆπ‰∏çËÉΩË∂ÖËøá500Â≠ó');
                return;
            }
            
                // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËßíËâ≤ÁöÑÊèèËø∞
            currentChatCharacter.description = newDescription;
                
                // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÈúÄË¶ÅÊõ¥Êñ∞Áæ§ËÅäÊï∞ÊçÆ
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                    groupChats[groupIndex].description = newDescription;
                        saveGroupChats(groupChats);
                    }
                }
                
                // Êõ¥Êñ∞UIÊòæÁ§∫
                updateGroupChatInfo();
            hideGroupNoticeModal();
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            showToast('‚úÖ Áæ§ÂÖ¨Âëä‰øùÂ≠òÊàêÂäü', 'success');
        }
        
        // Ê∑ªÂä†Áæ§ÊàêÂëò - ‰ªéÁé∞ÊúâËßíËâ≤‰∏≠ÈÄâÊã©
        function addGroupMember() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            // Ëé∑ÂèñÊâÄÊúâËßíËâ≤ÂàóË°®
            if (!characters || characters.length === 0) {
                alert('ÊöÇÊó†ÂèØÈÇÄËØ∑ÁöÑËßíËâ≤ÔºåËØ∑ÂÖàÂàõÂª∫ËßíËâ≤');
                return;
            }
            
            // ËøáÊª§ÊéâÂ∑≤ÁªèÂú®Áæ§ÈáåÁöÑËßíËâ≤
            const currentMemberIds = currentChatCharacter.members ? currentChatCharacter.members.map(m => m.id) : [];
            const availableCharacters = characters.filter(char => !currentMemberIds.includes(char.id));
            
            if (availableCharacters.length === 0) {
                alert('ÊâÄÊúâËßíËâ≤ÈÉΩÂ∑≤ÁªèÂú®Áæ§Èáå‰∫Ü');
                return;
            }
            
            // ÂàõÂª∫ÁæéËßÇÁöÑÈÄâÊã©ÁïåÈù¢
            showCharacterSelectionModal(availableCharacters, 'ÈÇÄËØ∑Áæ§ÊàêÂëò', 'ËØ∑ÈÄâÊã©Ë¶ÅÈÇÄËØ∑ËøõÁæ§ÁöÑËßíËâ≤Ôºö', (selectedCharacter) => {
                // Ê∑ªÂä†Âà∞Áæ§ÊàêÂëòÂàóË°®
                if (!currentChatCharacter.members) {
                    currentChatCharacter.members = [];
                }
                currentChatCharacter.members.push({
                    id: selectedCharacter.id,
                    name: selectedCharacter.name,
                    avatarUrl: selectedCharacter.avatarUrl
                });
                
                // ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                        groupChats[groupIndex].members = currentChatCharacter.members;
                        saveGroupChats(groupChats);
                    }
                }
                
                // Êõ¥Êñ∞UI
                updateGroupChatInfo();
                renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                showToast(`‚úÖ ${selectedCharacter.name} Â∑≤Âä†ÂÖ•Áæ§ËÅä`, 'success');
            });
        }
        
        // ÁßªÈô§Áæ§ÊàêÂëò
        function removeGroupMember() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup || !currentChatCharacter.members) return;
            
            if (currentChatCharacter.members.length <= 1) {
                alert('Áæ§ËÅäËá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏Ä‰∏™ËßíËâ≤ÊàêÂëòÔºà‰∏çÂåÖÊã¨Áî®Êà∑Ëá™Â∑±Ôºâ');
                return;
            }
            
            // ÂàõÂª∫ÁæéËßÇÁöÑÈÄâÊã©ÁïåÈù¢
            showCharacterSelectionModal(currentChatCharacter.members, 'ÁßªÈô§Áæ§ÊàêÂëò', 'ËØ∑ÈÄâÊã©Ë¶ÅÁßªÂá∫Áæ§ËÅäÁöÑÊàêÂëòÔºö', (selectedMember) => {
                if (confirm(`Á°ÆÂÆöË¶ÅÂ∞Ü ${selectedMember.name} ÁßªÂá∫Áæ§ËÅäÂêóÔºü`)) {
                    // ‰ªéÁæ§ÊàêÂëòÂàóË°®‰∏≠ÁßªÈô§
                    const memberIndex = currentChatCharacter.members.findIndex(m => m.id === selectedMember.id);
                    if (memberIndex !== -1) {
                        currentChatCharacter.members.splice(memberIndex, 1);
                        
                        // ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ
                        if (groupChats) {
                            const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                            if (groupIndex !== -1) {
                                groupChats[groupIndex].members = currentChatCharacter.members;
                                saveGroupChats(groupChats);
                            }
                        }
                        
                        // Êõ¥Êñ∞UI
                        updateGroupChatInfo();
                        renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                        showToast(`‚úÖ ${selectedMember.name} Â∑≤Ë¢´ÁßªÂá∫Áæ§ËÅä`, 'success');
                    }
                }
            });
        }
        
        // Áæ§ÂÖ¨ÂëäÂäüËÉΩ
        function showGroupNotice() {
            const notice = currentChatCharacter?.description || 'ÊöÇÊó†Áæ§ÂÖ¨Âëä';
            alert(`üì¢ Áæ§ÂÖ¨Âëä\n\n${notice}\n\nÁÇπÂáªÁæ§‰ø°ÊÅØÂç°ÁâáÁöÑÂÖ¨ÂëäÂå∫ÂüüÂèØ‰ª•ÁºñËæëÁæ§ÂÖ¨Âëä`);
        }
        

        
        // Áæ§Â∫îÁî®ÂäüËÉΩ
        function showGroupVote() {
            alert('üó≥Ô∏è Áæ§ÊäïÁ•®ÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂ∞ÜÊîØÊåÅ‰ª•‰∏ãÂäüËÉΩÔºö\n‚Ä¢ ÂàõÂª∫ÊäïÁ•®ËØùÈ¢ò\n‚Ä¢ ËÆæÁΩÆÊäïÁ•®ÈÄâÈ°π\n‚Ä¢ ÂÆûÊó∂ÊäïÁ•®ÁªìÊûú\n‚Ä¢ ÊäïÁ•®Êà™Ê≠¢Êó∂Èó¥');
        }
        
        function showGroupActivity() {
            alert('üìÖ Áæ§Ê¥ªÂä®ÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂ∞ÜÊîØÊåÅ‰ª•‰∏ãÂäüËÉΩÔºö\n‚Ä¢ ÂàõÂª∫Áæ§Ê¥ªÂä®\n‚Ä¢ Ê¥ªÂä®Êä•ÂêçÁªüËÆ°\n‚Ä¢ Ê¥ªÂä®ÊèêÈÜí\n‚Ä¢ Ê¥ªÂä®Á≠æÂà∞');
        }
        
        function showGroupTask() {
            alert('‚úÖ Áæ§‰ªªÂä°ÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂ∞ÜÊîØÊåÅ‰ª•‰∏ãÂäüËÉΩÔºö\n‚Ä¢ ÂèëÂ∏ÉÁæ§‰ªªÂä°\n‚Ä¢ ‰ªªÂä°ËÆ§È¢Ü\n‚Ä¢ ÂÆåÊàêÁä∂ÊÄÅË∑üË∏™\n‚Ä¢ ÁßØÂàÜÂ•ñÂä±Á≥ªÁªü');
        }
        
        function showMoreApps() {
            alert('üîß Êõ¥Â§öÁæ§Â∫îÁî®\n\nÂç≥Â∞ÜÊé®Âá∫Ôºö\n‚Ä¢ Áæ§Áõ¥Êí≠\n‚Ä¢ Áæ§Ê∏∏Êàè\n‚Ä¢ Áæ§Á∫¢ÂåÖ\n‚Ä¢ Áæ§Êú∫Âô®‰∫∫\n‚Ä¢ Áæ§Êó•Á®ã\n‚Ä¢ Áæ§Á¨îËÆ∞');
        }
        
        // ÊòæÁ§∫ËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü
        function showCharacterSelectionModal(characterList, title, description, onSelect) {
            const modalHTML = `
                <div class="modal character-selection-modal" id="character-selection-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="hideCharacterSelectionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p class="selection-description">${description}</p>
                            <div class="character-selection-grid" id="character-selection-grid">
                                ${characterList.map(char => `
                                    <div class="character-selection-item" data-character-id="${char.id}">
                                        <div class="character-selection-avatar">
                                            <img src="${char.avatarUrl || createDefaultAvatar(char.name)}" alt="${char.name}">
                                        </div>
                                        <div class="character-selection-info">
                                            <div class="character-selection-name">${char.name}</div>
                                            <div class="character-selection-bio">${(char.description || char.bio || 'ÊöÇÊó†ÁÆÄ‰ªã').substring(0, 30)}${(char.description || char.bio || '').length > 30 ? '...' : ''}</div>
                                        </div>
                                        <div class="character-selection-check">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-secondary" onclick="hideCharacterSelectionModal()">ÂèñÊ∂à</button>
                            <button class="modal-primary" id="confirm-selection-btn" onclick="confirmCharacterSelection()" disabled>Á°ÆÂÆö</button>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('character-selection-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            window.characterSelectionCallback = onSelect;
            window.selectedCharacterId = null;
            
            document.querySelectorAll('.character-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.character-selection-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    window.selectedCharacterId = this.dataset.characterId;
                    document.getElementById('confirm-selection-btn').disabled = false;
                });
            });
        }
        
        // ÈöêËóèËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü
        function hideCharacterSelectionModal() {
            const modal = document.getElementById('character-selection-modal');
            if (modal) {
                modal.remove();
            }
            window.characterSelectionCallback = null;
            window.selectedCharacterId = null;
        }
        
        // Á°ÆËÆ§ËßíËâ≤ÈÄâÊã©
        function confirmCharacterSelection() {
            if (!window.selectedCharacterId || !window.characterSelectionCallback) return;
            
            const allCharacters = [...characters, ...(currentChatCharacter.members || [])];
            const selectedCharacter = allCharacters.find(char => char.id === window.selectedCharacterId);
            
            if (selectedCharacter) {
                window.characterSelectionCallback(selectedCharacter);
                hideCharacterSelectionModal();
            }
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÁæ§ÊàêÂëòÂ§¥ÂÉèÊõ¥Êç¢ÂäüËÉΩ
        function changeMemberAvatar(memberId, event) {
            event.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
            
            const member = currentChatCharacter.members.find(m => m.id === memberId);
            if (!member) return;
            
            // ÊòæÁ§∫Â§¥ÂÉèÊõ¥Êç¢Ê®°ÊÄÅÊ°Ü
            showMemberAvatarModal(member);
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊòæÁ§∫Áæ§ÊàêÂëòÂ§¥ÂÉèÊõ¥Êç¢Ê®°ÊÄÅÊ°Ü
        function showMemberAvatarModal(member) {
            const modal = document.getElementById('member-avatar-modal');
            const preview = document.getElementById('member-avatar-preview');
            const memberName = document.getElementById('member-avatar-name');
            const uploadInput = document.getElementById('member-avatar-upload');
            
            // ËÆæÁΩÆÂΩìÂâçÊàêÂëò‰ø°ÊÅØ
            window.currentEditingMember = member;
            memberName.textContent = member.name;
            preview.src = member.avatarUrl || createDefaultAvatar(member.name);
            
            // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
            uploadInput.value = '';
            
            modal.style.display = 'flex';
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÈöêËóèÁæ§ÊàêÂëòÂ§¥ÂÉèÊõ¥Êç¢Ê®°ÊÄÅÊ°Ü
        function hideMemberAvatarModal() {
            const modal = document.getElementById('member-avatar-modal');
            modal.style.display = 'none';
            window.currentEditingMember = null;
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÁæ§ÊàêÂëòÂ§¥ÂÉè‰∏ä‰º†
        function handleMemberAvatarUpload() {
            const uploadInput = document.getElementById('member-avatar-upload');
            uploadInput.click();
        }

        // üî•„ÄêÊñ∞Â¢û„Äë‰øùÂ≠òÁæ§ÊàêÂëòÂ§¥ÂÉè
        function saveMemberAvatar() {
            if (!window.currentEditingMember) return;
            
            const preview = document.getElementById('member-avatar-preview');
            const newAvatarUrl = preview.src;
            
            // Êõ¥Êñ∞Áæ§ÊàêÂëòÂ§¥ÂÉè
            const memberIndex = currentChatCharacter.members.findIndex(m => m.id === window.currentEditingMember.id);
            if (memberIndex !== -1) {
                currentChatCharacter.members[memberIndex].avatarUrl = newAvatarUrl;
                
                // ÂêåÊó∂Êõ¥Êñ∞ÂÖ®Â±ÄËßíËâ≤ÂàóË°®‰∏≠ÁöÑÂ§¥ÂÉè
                const characterIndex = characters.findIndex(c => c.id === window.currentEditingMember.id);
                if (characterIndex !== -1) {
                    characters[characterIndex].avatarUrl = newAvatarUrl;
                    saveCharacters(characters);
                }
                
                // ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                        groupChats[groupIndex].members = currentChatCharacter.members;
                        saveGroupChats(groupChats);
                    }
                }
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÂú®Áæ§ËÅäÊ∂àÊÅØ‰∏≠Ê∑ªÂä†Â§¥ÂÉèÊõ¥Êç¢ÊèêÁ§∫
                addAvatarChangeMessage(window.currentEditingMember.name);
                
                // Êõ¥Êñ∞UI
                updateGroupChatInfo();
                renderGroupMembersGrid();
                refreshChatMessages(); // Âà∑Êñ∞ËÅäÂ§©Ê∂àÊÅØÊòæÁ§∫Êñ∞Â§¥ÂÉè
                
                showToast(`‚úÖ ${window.currentEditingMember.name} ÁöÑÂ§¥ÂÉèÂ∑≤Êõ¥Êñ∞`, 'success');
            }
            
            hideMemberAvatarModal();
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∑ªÂä†Â§¥ÂÉèÊõ¥Êç¢Á≥ªÁªüÊ∂àÊÅØ
        function addAvatarChangeMessage(memberName) {
            if (!currentChatCharacter || !chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            const systemMessage = {
                id: 'system_' + Date.now(),
                type: 'system',
                content: `${memberName} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè`,
                timestamp: new Date().toISOString(),
                isSystem: true
            };
            
            chatMessages[currentChatCharacter.id].push(systemMessage);
            saveChatMessages();
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
            if (currentChatCharacter) {
                displayChatMessages(currentChatCharacter.id);
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÂà∑Êñ∞ËÅäÂ§©Ê∂àÊÅØ‰ª•ÊòæÁ§∫Êñ∞Â§¥ÂÉè
        function refreshChatMessages() {
            if (currentChatCharacter) {
                displayChatMessages(currentChatCharacter.id);
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÈáçÁΩÆÁæ§ÊàêÂëòÂ§¥ÂÉè‰∏∫ÈªòËÆ§
        function resetMemberAvatar() {
            if (!window.currentEditingMember) return;
            
            const preview = document.getElementById('member-avatar-preview');
            const defaultAvatar = createDefaultAvatar(window.currentEditingMember.name);
            preview.src = defaultAvatar;
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 14px;
                z-index: 10000;
                opacity: 0;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(10px)';
            }, 100);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ÊñáÊú¨Êà™Êñ≠ÂáΩÊï∞
        function truncateText(text, maxLength = 80) {
            // üî•„Äê‰øÆÂ§ç„ÄëÁ°Æ‰øùtextÊòØÂ≠óÁ¨¶‰∏≤Á±ªÂûã
            if (text === null || text === undefined) {
                return '';
            }
            
            // Â¶ÇÊûú‰∏çÊòØÂ≠óÁ¨¶‰∏≤ÔºåËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
            if (typeof text !== 'string') {
                text = String(text);
            }
            
            if (!text || text.length <= maxLength) return text;
            
            // ÊåâË°åÂàÜÂâ≤ÊñáÊú¨
            const lines = text.split('\n');
            let result = '';
            let lineCount = 0;
            
            for (const line of lines) {
                // ÈôêÂà∂ÊúÄÂ§öÊòæÁ§∫3Ë°å
                if (lineCount >= 3) break;
                
                if (result.length + line.length + 1 <= maxLength) {
                    result += (result ? '\n' : '') + line;
                    lineCount++;
                } else {
                    // Â¶ÇÊûúËøô‰∏ÄË°å‰ºöË∂ÖÂá∫ÈïøÂ∫¶ÈôêÂà∂ÔºåÊà™Êñ≠Âπ∂Ê∑ªÂä†ÁúÅÁï•Âè∑
                    const remaining = maxLength - result.length - 1;
                    if (remaining > 10) { // Á°Æ‰øùÊúâË∂≥Â§üÁ©∫Èó¥ÊòæÁ§∫ÊúâÊÑè‰πâÁöÑÂÜÖÂÆπ
                        result += (result ? '\n' : '') + line.substring(0, remaining - 3) + '...';
                    } else if (!result) {
                        // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄË°åÂ∞±Ë∂ÖÈïøÔºåÁõ¥Êé•Êà™Êñ≠
                        result = line.substring(0, maxLength - 3) + '...';
                    } else {
                        // Âê¶ÂàôÂú®ÂΩìÂâçÁªìÊûúÂêéÂä†ÁúÅÁï•Âè∑
                        result += '...';
                    }
                    break;
                }
            }
            
            return result;
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∂àÊÅØÂàóË°®Â§öÈÄâÂà†Èô§ÂäüËÉΩ
        
        // ËøõÂÖ•Ê∂àÊÅØÂàóË°®Â§öÈÄâÊ®°Âºè
        function enterMessageListMultiSelectMode(conversationId) {
            console.log('Ëß¶ÂèëÈïøÊåâÂ§öÈÄâÊ®°ÂºèÔºåÂØπËØùID:', conversationId); // Ë∞ÉËØï‰ø°ÊÅØ
            isMessageListMultiSelectMode = true;
            selectedConversations = [conversationId]; // Â∞ÜËß¶ÂèëÈïøÊåâÁöÑÂØπËØùÊ∑ªÂä†Âà∞ÈÄâ‰∏≠ÂàóË°®
            renderMessageList(); // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®‰ª•ÊòæÁ§∫Â§öÈÄâÁïåÈù¢
            showToast('Â∑≤ËøõÂÖ•Â§öÈÄâÊ®°ÂºèÔºåÂèØ‰ª•ÈÄâÊã©Â§ö‰∏™ÂØπËØùËøõË°åÂà†Èô§', 'info');
        }
        
        // ÈÄÄÂá∫Ê∂àÊÅØÂàóË°®Â§öÈÄâÊ®°Âºè
        function exitMessageListMultiSelectMode() {
            isMessageListMultiSelectMode = false;
            selectedConversations = [];
            renderMessageList(); // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®ÊÅ¢Â§çÊ≠£Â∏∏Áä∂ÊÄÅ
        }
        
        // ÂàáÊç¢ÂØπËØùÈÄâÊã©Áä∂ÊÄÅ
        function toggleConversationSelection(conversationId) {
            const index = selectedConversations.indexOf(conversationId);
            if (index > -1) {
                selectedConversations.splice(index, 1);
            } else {
                selectedConversations.push(conversationId);
            }
            renderMessageList(); // ÈáçÊñ∞Ê∏≤Êüì‰ª•Êõ¥Êñ∞ÈÄâÊã©Áä∂ÊÄÅ
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂØπËØù
        function deleteSelectedConversations() {
            if (selectedConversations.length === 0) {
                showToast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÂØπËØù', 'error');
                return;
            }
            
            const count = selectedConversations.length;
            const confirmText = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${count} ‰∏™ÂØπËØùÂêóÔºü\n\nÂà†Èô§ÂêéÂ∞ÜÊ∏ÖÁ©∫ÂØπËØùÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÔºå‰ΩÜ‰∏ç‰ºöÂà†Èô§ËßíËâ≤ÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`;
            
            if (confirm(confirmText)) {
                // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂØπËØù
                selectedConversations.forEach(conversationId => {
                    // Âà†Èô§ËÅäÂ§©Ê∂àÊÅØ
                    if (chatMessages[conversationId]) {
                        delete chatMessages[conversationId];
                    }
                    
                    // üî•„Äê‰øÆÂ§ç„ÄëÊ≠£Á°ÆÂ§ÑÁêÜÂçï‰∫∫ÂØπËØùÂíåÁæ§ËÅäÁöÑÂà†Èô§
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÁæ§ËÅä
                    const groupIndex = groupChats.findIndex(g => g.id === conversationId);
                    if (groupIndex > -1) {
                        // Âà†Èô§Áæ§ËÅäËÆ∞ÂΩï
                        groupChats.splice(groupIndex, 1);
                    } else {
                        // Âçï‰∫∫ÂØπËØùÔºö‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁßªÈô§ÔºåËøôÊ†∑ÂØπËØùÊ°ÜÂ∞±‰ºöÊ∂àÂ§±
                        const contactIndex = contacts.indexOf(conversationId);
                        if (contactIndex > -1) {
                            contacts.splice(contactIndex, 1);
                        }
                    }
                });
                
                // ‰øùÂ≠òÊï∞ÊçÆ
                saveChatMessages();
                saveGroupChats(groupChats);
                saveContacts(); // üî•„Äê‰øÆÂ§ç„Äë‰øùÂ≠òËÅîÁ≥ª‰∫∫ÂàóË°®ÔºåÂõ†‰∏∫Êàë‰ª¨‰øÆÊîπ‰∫ÜÂÆÉ
                
                // ÈÄÄÂá∫Â§öÈÄâÊ®°ÂºèÂπ∂Âà∑Êñ∞ÁïåÈù¢
                exitMessageListMultiSelectMode();
                
                showToast(`‚úÖ Â∑≤Âà†Èô§ ${count} ‰∏™ÂØπËØù`, 'success');
            }
        }

    </script>
    
    <!-- üî•„ÄêÊñ∞Â¢û„ÄëÁæ§ÊàêÂëòÂ§¥ÂÉèÊõ¥Êç¢Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="member-avatar-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Êõ¥Êç¢ÊàêÂëòÂ§¥ÂÉè</h3>
                <button class="modal-close" onclick="hideMemberAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="member-avatar-form">
                    <div class="current-member-info">
                        <h4 id="member-avatar-name" class="member-name-title">ËßíËâ≤ÂêçÁß∞</h4>
                        <p class="member-info-desc">‰∏∫ËØ•ËßíËâ≤ËÆæÁΩÆÊñ∞ÁöÑÂ§¥ÂÉèÔºåÂ∞ÜÂú®Áæ§ËÅä‰∏≠Á´ãÂç≥ÁîüÊïà</p>
                    </div>
                    
                    <div class="avatar-upload-section">
                        <div class="avatar-preview-large">
                            <img id="member-avatar-preview" src="" alt="Â§¥ÂÉèÈ¢ÑËßà" class="preview-image">
                        </div>
                        
                        <div class="upload-buttons">
                            <button class="upload-btn primary" onclick="handleMemberAvatarUpload()">
                                <i class="fas fa-upload"></i>
                                ÈÄâÊã©Êñ∞Â§¥ÂÉè
                            </button>
                            <button class="upload-btn secondary" onclick="resetMemberAvatar()">
                                <i class="fas fa-undo"></i>
                                ÈáçÁΩÆÈªòËÆ§
                            </button>
                        </div>
                        
                        <input type="file" id="member-avatar-upload" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="avatar-tips">
                        <div class="tips-header">
                            <i class="fas fa-info-circle"></i>
                            <span>Â§¥ÂÉèÊõ¥Êç¢ËØ¥Êòé</span>
                        </div>
                        <div class="tips-content">
                            ‚Ä¢ ÊîØÊåÅJPG„ÄÅPNGÁ≠âÂ∏∏ËßÅÂõæÁâáÊ†ºÂºè<br>
                            ‚Ä¢ Âª∫ËÆÆ‰ΩøÁî®Ê≠£ÊñπÂΩ¢ÂõæÁâáÔºåÊïàÊûúÊõ¥‰Ω≥<br>
                            ‚Ä¢ Â§¥ÂÉèÊõ¥Êç¢ÂêéÂ∞ÜÂú®Áæ§ËÅä‰∏≠Á´ãÂç≥ÊòæÁ§∫<br>
                            ‚Ä¢ ËßíËâ≤‰πüÂèØ‰ª•Âú®ËÅäÂ§©Êó∂Ëá™‰∏ªÊõ¥Êç¢Â§¥ÂÉè
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-secondary" onclick="hideMemberAvatarModal()">ÂèñÊ∂à</button>
                <button class="modal-button modal-primary" onclick="saveMemberAvatar()">‰øùÂ≠òÊõ¥Êîπ</button>
            </div>
        </div>
    </div>

    <!-- Áæ§ÂÖ¨ÂëäÁºñËæëÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="group-notice-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÁºñËæëÁæ§ÂÖ¨Âëä</h3>
                <button class="modal-close" onclick="hideGroupNoticeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="group-notice-form">
                    <div class="form-group">
                        <label class="form-label">Áæ§ÂÖ¨ÂëäÂÜÖÂÆπ</label>
                        <textarea 
                            id="group-notice-content" 
                            class="form-textarea group-notice-textarea" 
                            placeholder="ËæìÂÖ•Áæ§ÂÖ¨ÂëäÂÜÖÂÆπ...&#10;&#10;ÂèØ‰ª•ÂåÖÊã¨Ôºö&#10;‚Ä¢ Áæ§ËßÑÂàôËØ¥Êòé&#10;‚Ä¢ ÈáçË¶ÅÈÄöÁü•&#10;‚Ä¢ Ê¥ªÂä®ÂÆâÊéí&#10;‚Ä¢ ÂÖ∂‰ªñ‰∫ãÈ°π"
                            maxlength="500"></textarea>
                        <div class="notice-char-count">
                            <span id="notice-char-current">0</span>/500Â≠ó
                        </div>
                    </div>
                    <div class="notice-tips">
                        <div class="tips-header">
                            <i class="fas fa-lightbulb"></i>
                            <span>ÂÖ¨ÂëäÂ∞èË¥¥Â£´</span>
                        </div>
                        <div class="tips-content">
                            ‚Ä¢ ÁÆÄÊ¥ÅÊòé‰∫ÜÔºåÁ™ÅÂá∫ÈáçÁÇπ<br>
                            ‚Ä¢ ‰ΩøÁî®ÂèãÂ•ΩÁöÑËØ≠Ë∞É<br>
                            ‚Ä¢ ÂÆöÊúüÊõ¥Êñ∞ÈáçË¶Å‰ø°ÊÅØ<br>
                            ‚Ä¢ ÂèØ‰ª•‰ΩøÁî®emojiÂ¢ûÂä†Ë∂£Âë≥ÊÄß
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideGroupNoticeModal()">ÂèñÊ∂à</button>
                <button class="modal-primary" onclick="saveGroupNotice()">‰øùÂ≠òÂÖ¨Âëä</button>
            </div>
        </div>
    </div>
    
    <!-- ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="schedule-times-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ËÆæÁΩÆ</h3>
                <button class="modal-close" onclick="hideModal('schedule-times-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    ËÆæÁΩÆËßíËâ≤ÊØèÂ§©Ëá™Âä®ÂèëÂ∏ÉÂä®ÊÄÅÁöÑÊó∂Èó¥ÁÇπÔºàÊúÄÂ§ö10‰∏™Ôºâ
                </p>
                <div id="schedule-times-container">
                    <!-- Êó∂Èó¥ËæìÂÖ•È°πÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                </div>
                <button onclick="addScheduleTime()" style="margin-top: 10px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    + Ê∑ªÂä†Êó∂Èó¥ÁÇπ
                </button>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideModal('schedule-times-modal')">ÂèñÊ∂à</button>
                <button class="modal-primary" onclick="saveScheduleTimes()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- ‰ΩçÁΩÆÂàÜ‰∫´Ê®°ÊÄÅÊ°Ü -->
    <div id="location-modal" class="modal" style="display: none;">
        <div class="modal-content location-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÂàÜ‰∫´‰ΩçÁΩÆ</h3>
                <button class="modal-close" onclick="hideLocationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="location-input-section">
                    <label for="location-address">‰ΩçÁΩÆÂêçÁß∞</label>
                    <input type="text" id="location-address" placeholder="ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞ÔºåÂ¶ÇÔºöÂíñÂï°ÂéÖ„ÄÅÂ≠¶Ê†°„ÄÅÂÆ∂..." maxlength="50">
                    
                    <!-- ÊúÄËøë‰ΩøÁî®ÂéÜÂè≤ËÆ∞ÂΩï -->
                    <div class="location-history" id="location-history">
                        <div class="location-history-title">üìç ÊúÄËøë‰ΩøÁî®</div>
                        <div class="location-history-items" id="location-history-items">
                            <div class="location-history-empty">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>
                        </div>
                    </div>
                </div>
                <div class="virtual-map-container">
                    <div class="map-header" style="background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 100%);">
                        <div class="map-location-name" id="map-location-display" style="color: #52c41a;">ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞</div>
                        <div class="map-coordinates" style="color: #73d13d;">116.4074¬∞E, 39.9042¬∞N</div>
                    </div>
                    <div class="virtual-map">
                        <div class="map-background"></div>
                        <!-- ÂºØÊõ≤Ê≤≥ÊµÅ -->
                        <div class="river" style="top: 8%; left: 55%; width: 25px; height: 4px; transform: rotate(30deg);"></div>
                        <div class="river-curve" style="top: 18%; left: 68%; width: 22px; height: 4px; transform: rotate(10deg);"></div>
                        <div class="river" style="top: 26%; left: 78%; width: 20px; height: 4px; transform: rotate(-10deg);"></div>
                        <div class="river-curve" style="top: 32%; left: 85%; width: 18px; height: 4px; transform: rotate(-30deg);"></div>
                        <div class="river" style="top: 60%; left: 5%; width: 28px; height: 4px; transform: rotate(-15deg);"></div>
                        <div class="river-curve" style="top: 68%; left: 25%; width: 25px; height: 4px; transform: rotate(5deg);"></div>
                        <div class="river" style="top: 75%; left: 42%; width: 22px; height: 4px; transform: rotate(20deg);"></div>
                        <!-- ÂÖ¨Âõ≠ÁªøÂú∞ -->
                        <div style="position: absolute; top: 25%; left: 65%; width: 25px; height: 20px; background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 50%, #b7eb8f 100%); border-radius: 3px; opacity: 0.6; z-index: 1;"></div>
                        <div style="position: absolute; top: 50%; left: 15%; width: 30px; height: 25px; background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 50%, #b7eb8f 100%); border-radius: 3px; opacity: 0.6; z-index: 1;"></div>
                        <!-- ÈÅìË∑Ø -->
                        <div class="map-roads">
                            <div class="road road-horizontal" style="top: 30%; left: 0; width: 100%;"></div>
                            <div class="road road-vertical" style="left: 25%; top: 0; height: 100%;"></div>
                            <div class="road road-horizontal" style="top: 70%; left: 0; width: 100%;"></div>
                            <div class="road road-vertical" style="left: 75%; top: 0; height: 100%;"></div>
                        </div>
                        <!-- Âª∫Á≠ëÁâ© -->
                        <div class="map-buildings">
                            <div class="building" style="top: 10%; left: 35%; width: 20px; height: 15px; background: linear-gradient(135deg, #f0f0f0 0%, #d9d9d9 100%); border: 1px solid #bfbfbf; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 15%; left: 55%; width: 25px; height: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border: 1px solid #91d5ff; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 40%; left: 10%; width: 18px; height: 12px; background: linear-gradient(135deg, #fff1f0 0%, #ffd8d6 100%); border: 1px solid #ffaaa5; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 45%; left: 85%; width: 22px; height: 18px; background: linear-gradient(135deg, #f0f0f0 0%, #d9d9d9 100%); border: 1px solid #bfbfbf; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 75%; left: 40%; width: 30px; height: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border: 1px solid #91d5ff; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 80%; left: 15%; width: 20px; height: 15px; background: linear-gradient(135deg, #fff1f0 0%, #ffd8d6 100%); border: 1px solid #ffaaa5; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                        </div>
                        <!-- Ê†ëÊú® -->
                        <div style="position: absolute; top: 35%; left: 20%; width: 8px; height: 8px; background: radial-gradient(circle, #52c41a 0%, #389e0d 70%, #237804 100%); border-radius: 50%; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); z-index: 3;"></div>
                        <div style="position: absolute; top: 60%; left: 30%; width: 6px; height: 6px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <div style="position: absolute; top: 12%; left: 70%; width: 7px; height: 7px; background: radial-gradient(circle, #52c41a 0%, #389e0d 70%, #237804 100%); border-radius: 50%; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); z-index: 3;"></div>
                        <div style="position: absolute; top: 85%; left: 90%; width: 5px; height: 5px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <div style="position: absolute; top: 50%; left: 90%; width: 6px; height: 6px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <!-- ‰ΩçÁΩÆÊ†áËÆ∞ -->
                        <div class="map-marker" id="location-marker">
                            <div class="marker-pin" style="color: #1890ff;">üìç</div>
                        </div>
                        <div class="map-current-location">
                            <div class="current-location-dot"></div>
                        </div>
                    </div>
                    <div class="map-footer">
                        <div class="map-scale">500m</div>
                        <div class="map-controls">
                            <button class="map-control-btn" onclick="randomizeMapPosition()">üéØ ÈáçÊñ∞ÂÆö‰Ωç</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideLocationModal()">ÂèñÊ∂à</button>
                <button class="modal-primary" onclick="sendLocationMessage()">ÂèëÈÄÅ‰ΩçÁΩÆ</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // üî•„ÄêÊñ∞Â¢û„ÄëÁæ§ÊàêÂëòÂ§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨
        document.addEventListener('DOMContentLoaded', function() {
            const memberAvatarUpload = document.getElementById('member-avatar-upload');
            if (memberAvatarUpload) {
                memberAvatarUpload.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('member-avatar-preview');
                            if (preview) {
                                preview.src = event.target.result;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
    </script>

    <!-- üî•„ÄêÊ∞∏‰πÖ‰øÆÂ§ç„ÄëË∫´‰ªΩÈÄâÊã©ÂäüËÉΩËá™Âä®‰øÆÂ§çËÑöÊú¨ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß ÂºÄÂßãÂ∫îÁî®Ë∫´‰ªΩÈÄâÊã©ÂäüËÉΩÊ∞∏‰πÖ‰øÆÂ§ç...');
            
            // ‰øÆÂ§ç1: ÈáçÂÜôshowPersonaSelectionForSingleChatÂáΩÊï∞
            if (typeof showPersonaSelectionForSingleChat === 'function') {
                const originalShowPersonaSelectionForSingleChat = showPersonaSelectionForSingleChat;
                showPersonaSelectionForSingleChat = function() {
                    originalShowPersonaSelectionForSingleChat();
                    
                    // Âª∂Ëøü‰øÆÂ§ç‰∫ã‰ª∂ÁªëÂÆöÔºåÁ°Æ‰øùDOMÂ∑≤ÁîüÊàê
                    setTimeout(() => {
                        const items = document.querySelectorAll('#persona-selection-modal .persona-selection-item');
                        console.log('üîß ‰øÆÂ§çË∫´‰ªΩÈÄâÊã©‰∫ã‰ª∂ÁªëÂÆöÔºåÊâæÂà∞ÂÖÉÁ¥†:', items.length);
                        
                        items.forEach(item => {
                            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                            item.onclick = null;
                            
                            // Ê∑ªÂä†Êñ∞ÁöÑÁÇπÂáª‰∫ã‰ª∂
                            item.addEventListener('click', function() {
                                console.log('Ë∫´‰ªΩÈÄâÊã©ÁÇπÂáª:', this.dataset.personaId);
                                
                                // ÁßªÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                                document.querySelectorAll('#persona-selection-modal .persona-selection-item').forEach(i => {
                                    i.classList.remove('selected');
                                });
                                
                                // ËÆæÁΩÆÂΩìÂâçÂÖÉÁ¥†‰∏∫ÈÄâ‰∏≠
                                this.classList.add('selected');
                                
                                // ‰øùÂ≠òË∫´‰ªΩID
                                window.selectedPersonaForChat = this.dataset.personaId;
                                console.log('ËÆæÁΩÆselectedPersonaForChat:', window.selectedPersonaForChat);
                                
                                // ÂêØÁî®Á°ÆËÆ§ÊåâÈíÆ
                                const confirmBtn = document.getElementById('confirm-persona-btn');
                                if (confirmBtn) {
                                    confirmBtn.disabled = false;
                                }
                            });
                        });
                    }, 100);
                };
            }
            
            // ‰øÆÂ§ç2: ÈáçÂÜôconfirmPersonaAndShowCharactersÂáΩÊï∞
            if (typeof confirmPersonaAndShowCharacters === 'function') {
                confirmPersonaAndShowCharacters = function() {
                    console.log('confirmPersonaAndShowCharactersË∞ÉÁî®ÔºåË∫´‰ªΩID:', window.selectedPersonaForChat);
                    
                    if (!window.selectedPersonaForChat) {
                        console.error('Ë∫´‰ªΩID‰∏∫Á©∫ÔºÅ');
                        return;
                    }
                    
                    // ‰øùÂ≠òË∫´‰ªΩID
                    const savedPersonaId = window.selectedPersonaForChat;
                    
                    // ÈöêËóèÊ®°ÊÄÅÊ°Ü
                    const modal = document.getElementById('persona-selection-modal');
                    if (modal) {
                        modal.remove();
                    }
                    
                    // ÊÅ¢Â§çË∫´‰ªΩID
                    window.selectedPersonaForChat = savedPersonaId;
                    console.log('‰øùÊä§ÂêéÁöÑË∫´‰ªΩID:', window.selectedPersonaForChat);
                    
                    showCharacterSelectionForSingleChat();
                };
            }
            
            // ‰øÆÂ§ç3: ÈáçÂÜôbuildCharacterPromptÂáΩÊï∞
            if (typeof buildCharacterPrompt === 'function') {
                const originalBuildCharacterPrompt = buildCharacterPrompt;
                buildCharacterPrompt = function(character, hasImage = false) {
                    // Ë∞ÉÁî®ÂéüÂáΩÊï∞Ëé∑ÂèñÂü∫Á°Äprompt
                    let characterPrompt = originalBuildCharacterPrompt(character, hasImage);
                    
                    // ÁßªÈô§ÂéüÊúâÁöÑcurrentPersonaÈÄªËæëÔºåÊõøÊç¢‰∏∫‰ªéËÅäÂ§©ËÆæÁΩÆËØªÂèñ
                    const chatSettings = getCurrentChatSettings();
                    if (chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona) {
                            console.log('üîß ‰∏∫ËßíËâ≤', character.name, '‰ΩøÁî®Ë∫´‰ªΩ:', selectedPersona.name);
                            
                            // ÁßªÈô§ÊóßÁöÑË∫´‰ªΩ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
                            const personaRegex = /\n\n# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö[\s\S]*?ËØ∑Ê†πÊçÆÁî®Êà∑ÁöÑËøô‰∏™Èù¢ÂÖ∑Ë∫´‰ªΩÊù•ËøõË°åÂØπËØù„ÄÇ/;
                            characterPrompt = characterPrompt.replace(personaRegex, '');
                            
                            // Ê∑ªÂä†Êñ∞ÁöÑË∫´‰ªΩ‰ø°ÊÅØ
                            const personaInfo = `\n\n# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö\nÁî®Êà∑ÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑ÊòØ"${selectedPersona.name}"${selectedPersona.description ? `Ôºö${selectedPersona.description}` : ''}\nËØ∑Ê†πÊçÆÁî®Êà∑ÁöÑËøô‰∏™Èù¢ÂÖ∑Ë∫´‰ªΩÊù•ËøõË°åÂØπËØù„ÄÇ`;
                            
                            // Âú®ËßíËâ≤ËÆæÂÆöÂêéÊèíÂÖ•Ë∫´‰ªΩ‰ø°ÊÅØ
                            const insertPoint = characterPrompt.indexOf('\n# üî•„Äê‰øÆÂ§ç„ÄëË°®ÊÉÖÂåÖÂ∫ì‰ø°ÊÅØ');
                            if (insertPoint !== -1) {
                                characterPrompt = characterPrompt.slice(0, insertPoint) + personaInfo + characterPrompt.slice(insertPoint);
                            } else {
                                characterPrompt += personaInfo;
                            }
                        }
                    }
                    
                    return characterPrompt;
                };
            }
            
            console.log('‚úÖ Ë∫´‰ªΩÈÄâÊã©ÂäüËÉΩÊ∞∏‰πÖ‰øÆÂ§çÂ∑≤Â∫îÁî®');
        });
    </script>

    <!-- üîß„ÄêÁÆÄÂçï‰øÆÂ§ç„ÄëÁæ§ËÅäË∫´‰ªΩËÆæÁΩÆÁõ¥Êé•‰øÆÂ§ç -->
    <script>
        // ÁÆÄÂçïÁõ¥Êé•ÁöÑÁæ§ËÅäË∫´‰ªΩ‰øÆÂ§ç
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß [ÁÆÄÂçï‰øÆÂ§ç] Áæ§ËÅäË∫´‰ªΩËÆæÁΩÆ‰øÆÂ§çÂêØÂä®...');
            
            // ÈáçÂÜôcreateGroupChatÂáΩÊï∞ÔºåÁ°Æ‰øùË∫´‰ªΩËÆæÁΩÆÁ´ãÂç≥ÁîüÊïà
            if (typeof window.createGroupChat === 'function') {
                const originalCreateGroupChat = window.createGroupChat;
                window.createGroupChat = async function(personaId) {
                    console.log('üîß [‰øÆÂ§ç] createGroupChatË¢´Ë∞ÉÁî®ÔºåË∫´‰ªΩID:', personaId);
                    
                    // Ë∞ÉÁî®ÂéüÂáΩÊï∞Ôºå‰º†ÈÄípersonaIdÂèÇÊï∞
                    await originalCreateGroupChat.call(this, personaId);
                    
                    // Â¶ÇÊûúÊúâÈÄâÊã©Ë∫´‰ªΩÔºåÁ´ãÂç≥Âä†ËΩΩÂà∞ÂÜÖÂ≠ò
                    if (personaId && groupChats && groupChats.length > 0) {
                        const latestGroup = groupChats[groupChats.length - 1];
                        const savedSettings = localStorage.getItem(`chatSettings_${latestGroup.id}`);
                        
                        if (savedSettings) {
                            try {
                                const settings = JSON.parse(savedSettings);
                                window.chatSettings[latestGroup.id] = settings;
                                console.log('üîß [‰øÆÂ§ç] Áæ§ËÅäË∫´‰ªΩËÆæÁΩÆÂ∑≤Âä†ËΩΩÂà∞ÂÜÖÂ≠ò:', settings);
                            } catch (error) {
                                console.error('üîß [‰øÆÂ§ç] Ëß£ÊûêÁæ§ËÅäËÆæÁΩÆÂ§±Ë¥•:', error);
                            }
                        }
                    }
                };
            }
            
            console.log('üîß [ÁÆÄÂçï‰øÆÂ§ç] Áæ§ËÅäË∫´‰ªΩËÆæÁΩÆ‰øÆÂ§çÂÆåÊàê');
        });
    </script>

    <!-- üì±„ÄêÁßªÂä®Á´Ø‰ºòÂåñ„ÄëËæìÂÖ•Ê°ÜviewportË°å‰∏∫‰øÆÂ§ç -->
    <script>
        // ÁßªÂä®Á´ØËæìÂÖ•Ê°Ü‰ºòÂåñ
        (function() {
            'use strict';
            
            console.log('üì± [ÁßªÂä®Á´Ø‰ºòÂåñ] ËæìÂÖ•Ê°ÜviewportË°å‰∏∫‰øÆÂ§çÂêØÂä®...');
            
            let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            let isAndroid = /Android/.test(navigator.userAgent);
            let isMobile = isIOS || isAndroid;
            
            if (!isMobile) {
                console.log('üì± ÈùûÁßªÂä®Á´ØËÆæÂ§áÔºåË∑≥ËøáÁßªÂä®Á´Ø‰ºòÂåñ');
                return;
            }
            
            // Ëé∑ÂèñÊâÄÊúâÂèØËÉΩÁöÑËæìÂÖ•Ê°Ü
            function getAllInputs() {
                return document.querySelectorAll('textarea, input[type="text"], input[type="password"], input[type="email"], input[type="number"]');
            }
            
            // Èò≤Ê≠¢iOS SafariËá™Âä®Áº©Êîæ
            function preventZoom() {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                if (viewportMeta) {
                    viewportMeta.setAttribute('content', 
                        'width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no'
                    );
                }
            }
            
            // ÊÅ¢Â§çÁº©ÊîæÂäüËÉΩ
            function restoreZoom() {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                if (viewportMeta) {
                    viewportMeta.setAttribute('content', 
                        'width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=3.0, user-scalable=yes'
                    );
                }
            }
            
            // ËæìÂÖ•Ê°ÜÁÑ¶ÁÇπÂ§ÑÁêÜ
            function handleInputFocus(e) {
                console.log('üì± ËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπÔºåÈò≤Ê≠¢Ëá™Âä®Áº©Êîæ');
                
                // Èò≤Ê≠¢iOSËá™Âä®Áº©Êîæ
                if (isIOS) {
                    preventZoom();
                }
                
                // Á°Æ‰øùËæìÂÖ•Ê°ÜÂèØËßÅ
                setTimeout(() => {
                    e.target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }, 300);
            }
            
            // ËæìÂÖ•Ê°ÜÂ§±ÁÑ¶Â§ÑÁêÜ
            function handleInputBlur(e) {
                console.log('üì± ËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπÔºåÊÅ¢Â§çÁº©ÊîæÂäüËÉΩ');
                
                // ÊÅ¢Â§çÁº©ÊîæÂäüËÉΩ
                if (isIOS) {
                    setTimeout(() => {
                        restoreZoom();
                    }, 100);
                }
                
                // ÊªöÂä®ÂõûÈ°∂ÈÉ®
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 100);
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂Âà∞ÊâÄÊúâËæìÂÖ•Ê°Ü
            function bindInputEvents() {
                const inputs = getAllInputs();
                console.log(`üì± ÊâæÂà∞ ${inputs.length} ‰∏™ËæìÂÖ•Ê°ÜÔºåÊ≠£Âú®ÁªëÂÆö‰∫ã‰ª∂...`);
                
                inputs.forEach(input => {
                    // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                    input.removeEventListener('focus', handleInputFocus);
                    input.removeEventListener('blur', handleInputBlur);
                    
                    // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    input.addEventListener('focus', handleInputFocus, { passive: true });
                    input.addEventListener('blur', handleInputBlur, { passive: true });
                    
                    // Á°Æ‰øùËæìÂÖ•Ê°ÜÂ≠ó‰ΩìÂ§ßÂ∞èËá≥Â∞ë16pxÔºàÈò≤Ê≠¢iOSÁº©ÊîæÔºâ
                    const computedStyle = window.getComputedStyle(input);
                    const fontSize = parseInt(computedStyle.fontSize);
                    if (fontSize < 16) {
                        input.style.fontSize = '16px';
                        console.log('üì± Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÂ≠ó‰ΩìÂ§ßÂ∞è‰∏∫16pxÔºåÈò≤Ê≠¢iOSÁº©Êîæ');
                    }
                });
            }
            
            // ÁõëÂê¨DOMÂèòÂåñÔºåÂ§ÑÁêÜÂä®ÊÄÅÊ∑ªÂä†ÁöÑËæìÂÖ•Ê°Ü
            const observer = new MutationObserver(function(mutations) {
                let shouldRebind = false;
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                if (node.matches && (node.matches('textarea') || node.matches('input'))) {
                                    shouldRebind = true;
                                } else if (node.querySelector) {
                                    const inputs = node.querySelectorAll('textarea, input');
                                    if (inputs.length > 0) {
                                        shouldRebind = true;
                                    }
                                }
                            }
                        });
                    }
                });
                
                if (shouldRebind) {
                    console.log('üì± Ê£ÄÊµãÂà∞Êñ∞ÁöÑËæìÂÖ•Ê°ÜÔºåÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂...');
                    setTimeout(bindInputEvents, 100);
                }
            });
            
            // ÂºÄÂßãÁõëÂê¨DOMÂèòÂåñ
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁªëÂÆö‰∫ã‰ª∂
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', bindInputEvents);
            } else {
                bindInputEvents();
            }
            
            // È°µÈù¢ÊòæÁ§∫Êó∂ÈáçÊñ∞ÁªëÂÆöÔºàÂ§ÑÁêÜ‰ªéÂêéÂè∞ËøîÂõûÁöÑÊÉÖÂÜµÔºâ
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    setTimeout(bindInputEvents, 100);
                }
            });
            
            console.log('üì± [ÁßªÂä®Á´Ø‰ºòÂåñ] ËæìÂÖ•Ê°ÜviewportË°å‰∏∫‰øÆÂ§çÂ∑≤ÂêØÂä®');
        })();
    </script>

    <!-- üí∞„ÄêËΩ¨Ë¥¶ÂäüËÉΩ‰ºòÂåñ„ÄëËÆ©AIÊ†πÊçÆ‰∫∫ËÆæËá™ÁÑ∂ÂõûÂ∫î -->
    <script>
        // ËΩ¨Ë¥¶ÂäüËÉΩ‰ºòÂåñ - ÁßªÈô§Ëá™Âä®Êî∂Ê¨æÔºåËÆ©AIÊ†πÊçÆ‰∫∫ËÆæËá™ÁÑ∂ÂõûÂ∫î
        (function() {
            'use strict';
            
            console.log('üí∞ [ËΩ¨Ë¥¶‰ºòÂåñ] ÁßªÈô§Ëá™Âä®Êî∂Ê¨æÈÄªËæëÔºåËÆ©AIÊ†πÊçÆ‰∫∫ËÆæËá™ÁÑ∂ÂõûÂ∫î...');
            
            // üî•„ÄêÈáçË¶Å‰øÆÊîπ„ÄëÁßªÈô§Ëá™Âä®Êî∂Ê¨æÈÄªËæëÔºåËÆ©AIÊ†πÊçÆËßíËâ≤‰∫∫ËÆæËá™ÁÑ∂ÂÜ≥ÂÆö
            // ËΩ¨Ë¥¶Áä∂ÊÄÅÂèòÂåñÂ∫îËØ•Áî±AIÁöÑËá™ÁÑ∂ÂõûÂ§çËß¶ÂèëÔºåËÄå‰∏çÊòØËá™Âä®Â§ÑÁêÜ
            // AI‰ºöÊ†πÊçÆËá™Â∑±ÁöÑ‰∫∫ËÆæÔºàÊØîÂ¶ÇÈ´òÂÜ∑„ÄÅÊ∏©Êüî„ÄÅÂÇ≤Â®áÁ≠âÔºâÊù•ÂÜ≥ÂÆöÊòØÂê¶Êî∂Ê¨æ
            
            console.log('üí∞ [ËΩ¨Ë¥¶‰ºòÂåñ] AIÂ∞ÜÊ†πÊçÆËßíËâ≤‰∫∫ËÆæËá™ÁÑ∂ÂõûÂ∫îËΩ¨Ë¥¶Ôºå‰∏çÂÜçËá™Âä®Êî∂Ê¨æ');
        })();
    </script>
</body>
</html>