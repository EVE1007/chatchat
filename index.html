<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EVE Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&family=Comic+Neue:wght@400;700&family=Fredoka+One&family=Nunito:wght@400;500;600;700&family=Montserrat:wght@400;500;600&family=Inter:wght@400;500;600&family=Roboto:wght@400;500&family=Raleway:wght@400;500;600&family=Lato:wght@400;700&family=Poppins:wght@400;500;600&family=Quicksand:wght@400;500;600&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- üé® ËÆ∞ÂøÜÊ∏ÖÁêÜÂ∑•ÂÖ∑ÂºπÁ™óÊ†∑Âºè -->
    <style>
        .memory-tools-modal {
            max-width: 400px;
            width: 90%;
        }

        .tools-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tool-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .tool-item:hover {
            background: #e9ecef;
            border-color: #007AFF;
            transform: translateY(-1px);
        }

        .tool-icon {
            width: 40px;
            height: 40px;
            background: #007AFF;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .tool-info {
            flex: 1;
        }

        .tool-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .tool-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        /* ÂºπÁ™óÂä®Áîª */
        .modal-overlay {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .modal-overlay.show {
            opacity: 1;
        }
    </style>
</head>
<body>
        <!-- Êé®ÈÄÅÈÄöÁü•ÂÆπÂô® -->
        <div id="notification-container"></div>
    <div id="phone-frame">
    <div id="phone-screen">
        <div class="wallpaper" id="wallpaper-element">
            <!-- ‰∏ªÂ±èÂπïÁä∂ÊÄÅÊ†è -->
            <div id="status-bar">
                <span id="status-bar-time">14:25</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">·∞î·©ö</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            
            <!-- Êó∂ÈíüÂÆπÂô® -->
            <div id="clock-container">
                <div id="main-time">14:25</div>
                <div id="main-date">12Êúà18Êó• ÊòüÊúü‰∏Ä</div>
            </div>
            
            <div id="worldbook-screen" class="app-screen">
                <div class="app-status-bar">
                    <div class="app-status-time"></div>
                    <div class="app-battery-container">
                        <span class="battery-text">·∞î·©ö</span>
                        <div class="app-battery-icon">
                            <div class="app-battery-level"></div>
                        </div>
                    </div>
                </div>
                <div class="app-header">
                    <button class="back-button" onclick="hideApp('worldbook-screen')">‚Äπ</button>
                    <div class="app-title">‰∏ñÁïå‰π¶</div>
                    <div class="add-worldbook-btn worldbook-add-btn" onclick="onWorldbookAddClick()">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>

                <div class="app-content">
                    <div id="global-worldbooks-content" class="worldbook-content-pane">
                        </div>
                    <div id="local-worldbooks-content" class="worldbook-content-pane" style="display: none;">
                        </div>
                    <div id="character-worldbooks-content" class="worldbook-content-pane" style="display: none;">
                        </div>
                </div>

                <!-- ‰∏ñÁïå‰π¶ÂàÜÁ±ªÈÄâÊã©Âô® -->
                <div class="worldbook-category-selector" id="worldbook-category-selector" style="display: none;">
                    <div class="category-selector-content">
                        <div class="category-selector-title">ÈÄâÊã©ËßíËâ≤ÂàÜÁ±ª</div>
                        <div class="category-options" id="category-options">
                            <!-- Âä®ÊÄÅÁîüÊàêËßíËâ≤ÂàÜÁ±ª -->
                        </div>
                        <div class="category-selector-actions">
                            <button class="category-cancel-btn" onclick="hideCategorySelector()">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>

                <div class="worldbook-tabs">
                    <div class="worldbook-tab active" onclick="switchWorldbookTab('global')">
                        <i class="fas fa-globe-asia"></i>
                        <span>ÂÖ®Â±ÄËÆæÂÆö</span>
                    </div>
                    <div class="worldbook-tab" onclick="switchWorldbookTab('local')">
                        <i class="fas fa-comment-dots"></i>
                        <span>Â±ÄÈÉ®ËÆæÂÆö</span>
                    </div>
                    <div class="worldbook-tab" onclick="switchWorldbookTab('character')">
                        <i class="fas fa-users"></i>
                        <span id="character-tab-text">ËßíËâ≤ËÆæÂÆö</span>
                    </div>
                </div>
            </div>
                
                <!-- Â∫îÁî®ÂõæÊ†á -->
                <div id="app-grid">
                    <div class="app-row">
                        <a href="#" class="app" onclick="showApp('chat-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" alt="Chat" class="app-icon-img">
                            </div>
                            <span>Chat</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('worldbook-screen'); switchWorldbookTab('global');">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/Xqz3zPz7/IMG-3080.jpg" alt="‰∏ñÁïå‰π¶" class="app-icon-img">
                            </div>
                            <span>‰∏ñÁïå‰π¶</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('settings-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/764L3jpF/IMG-3079.jpg" alt="ËÆæÁΩÆ" class="app-icon-img">
                            </div>
                            <span>ËÆæÁΩÆ</span>
                        </a>
                    </div>
                    <div class="app-row">
                        <a href="#" class="app" onclick="showApp('memory-viewer-screen')">
                            <div class="app-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <span>ËÆ∞ÂøÜ</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('game-screen')">
                            <div class="app-icon">
                                <i class="fas fa-gamepad"></i>
                            </div>
                            <span>Ê∏∏Êàè</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('music-screen')">
                            <div class="app-icon">
                                <i class="fas fa-music"></i>
                            </div>
                            <span>Èü≥‰πê</span>
                        </a>
                    </div>
                    <div class="app-row">
                        <a href="#" class="app" onclick="showApp('forum-screen')">
                            <div class="app-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <span>ËÆ∫Âùõ</span>
                        </a>
                    </div>
                </div>

                
                <!-- ËÅäÂ§©ÁïåÈù¢ -->
                <div id="chat-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('chat-screen')">‚Äπ</button>
                        <div class="app-title">üí¨</div>
                        <div class="chat-header-actions">
                            <div id="group-manage-btn" class="header-action-btn" onclick="enterGroupManageMode()" title="ÁÆ°ÁêÜÂàÜÁªÑ">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div id="add-contact-btn" class="add-btn" onclick="showCharacterForm()">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div id="add-chat-btn" class="add-btn" onclick="showChatOptions()">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="app-content" id="chat-content">
                        <!-- ÈªòËÆ§ÊòæÁ§∫Ê∂àÊÅØÂàóË°® -->
                        <div class="message-list" id="message-list">
                            <!-- Ê∂àÊÅØÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        
                        <!-- ÈÄöËÆØÂΩï -->
                        <div class="contact-list hide" id="contact-list">
                            <div class="contact-section">
        
                                <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>

                        </div>
                        
                        <!-- Âä®ÊÄÅÈ°µÈù¢ -->
                        <div class="moments-page hide moments-page-no-padding" id="moments-page">
                            <div class="moments-header">
                                <div class="moments-cover" onclick="changeCoverImage()">
                                    <div class="cover-image-placeholder" id="cover-placeholder">
                                        <div class="cover-placeholder-text">ÁÇπÂáªÊõ¥Êç¢Â∞ÅÈù¢</div>
                                        </div>
                                    <img class="cover-image hide" id="cover-image" src="">
                                    </div>
                                
                                <!-- Áî®Êà∑ÂêçÔºåÁã¨Á´ãÊîæÁΩÆÂú®Â§¥ÂÉèÂ∑¶‰∏äËßí -->
                                <div class="moments-username" onclick="changeUsername(event)" id="moments-username">Áî®Êà∑</div>
                                
                                <!-- Áã¨Á´ãÁöÑÂ§¥ÂÉèÔºåË∑®Ë∂äËÉåÊôØÂíåÂä®ÊÄÅÂàóË°®Âå∫ÂüüÔºåÊîæÂú®headerÂ§ñÈù¢ -->
                                <div class="moments-avatar" onclick="changeAvatarImage(event)" id="moments-avatar">
                                    <i class="fas fa-user moments-avatar-icon"></i>
                                </div>
                            </div>
                            
                            <div class="moments-list" id="moments-list">
                                <!-- Âä®ÊÄÅÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            

                        </div>

                        
                        <!-- Èù¢ÂÖ∑Âå∫Âüü -->
                        <div class="profile-page hide" id="profile-page">
                            <div class="persona-header">
                                <div class="persona-title">
                                    <h2>ÊàëÁöÑÈù¢ÂÖ∑</h2>
                                    <p>ÁÆ°ÁêÜ‰Ω†ÁöÑÂ§öÈáçË∫´‰ªΩËÆæÂÆö</p>
                                </div>
                                <div class="add-persona-btn persona-add-btn" onclick="showPersonaForm()">
                                    <i class="fas fa-plus"></i>
                                </div>
                            </div>
                            
                            <div class="persona-list" id="persona-list">
                                <!-- Èù¢ÂÖ∑ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            

                        </div>
                    </div>
                    
                    <div class="chat-tabs">
                        <div class="chat-tab active" onclick="switchChatTab('message-list')" id="message-tab">
                            <i class="fas fa-comments"></i>
                            <span>Ê∂àÊÅØ</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('contact-list')">
                            <i class="fas fa-user-friends"></i>
                            <span>ËßíËâ≤</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('moments-page')">
                            <i class="fas fa-globe-americas"></i>
                            <span>Âä®ÊÄÅ</span>
                        </div>
                        <div class="chat-tab" onclick="switchChatTab('profile-page')">
                            <i class="fas fa-user-circle"></i>
                            <span>Êàë</span>
                        </div>
                    </div>
                </div>
                
                <!-- ÂèëÂ∏ÉÂä®ÊÄÅÁïåÈù¢ -->
                <div id="publish-moment-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hidePublishMoment()">‚Äπ</button>
                        <div class="app-title">ÂèëË°®Âä®ÊÄÅ</div>
                        <button class="publish-btn" onclick="publishMoment()">ÂèëË°®</button>
                    </div>
                    <div class="app-content">
                        <div class="publish-moment-form">
                            <!-- ÊñáÂ≠óËæìÂÖ•Âå∫Âüü -->
                            <div class="moment-text-input">
                                <textarea 
                                    id="moment-text" 
                                    placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã..." 
                                    class="moment-textarea"
                                    maxlength="500"
                                    oninput="updateTextCount()"></textarea>
                                <div class="text-count" id="text-count">0/500</div>
                            </div>
                            
                            <!-- ÂõæÁâá‰∏ä‰º†Âå∫Âüü -->
                            <div class="moment-images-section">
                                <div class="moment-images-grid" id="moment-images-grid">
                                    <!-- Âä®ÊÄÅÊ∑ªÂä†ÁöÑÂõæÁâáÈ¢ÑËßà -->
                                </div>
                                <div class="add-image-btn" onclick="addMomentImage()">
                                    <i class="fas fa-plus"></i>
                                    <span>Ê∑ªÂä†ÂõæÁâá</span>
                                </div>
                            </div>
                            
                            <!-- ÂèëÂ∏ÉÈÄâÈ°π -->
                            <div class="publish-options">
                                <div class="option-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>ÊâÄÂú®‰ΩçÁΩÆ</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                <div class="option-item">
                                    <i class="fas fa-users"></i>
                                    <span>ÊèêÈÜíË∞ÅÁúã</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                <div class="option-item">
                                    <i class="fas fa-eye"></i>
                                    <span>Ë∞ÅÂèØ‰ª•Áúã</span>
                                    <span class="option-value">ÂÖ¨ÂºÄ</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ËÆ∫ÂùõÁïåÈù¢ -->
                <div id="forum-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('forum-screen')">‚Äπ</button>
                        <div class="app-title">ËÆ∫Âùõ</div>
                    </div>
                    <div class="app-content">
                        <div class="forum-categories">
                            <div class="forum-category">
                                <div class="category-icon">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">ÁÉ≠Èó®ËØùÈ¢ò</div>
                                    <div class="category-desc">ÊúÄÂèóÊ¨¢ËøéÁöÑËÆ®ËÆ∫</div>
                            </div>
                                <div class="category-count">128</div>
                            </div>
                            <div class="forum-category">
                                <div class="category-icon">
                                    <i class="fas fa-gamepad"></i>
                            </div>
                                <div class="category-info">
                                    <div class="category-name">Ê∏∏ÊàèËÆ®ËÆ∫</div>
                                    <div class="category-desc">ÂàÜ‰∫´Ê∏∏ÊàèÂøÉÂæó</div>
                                </div>
                                <div class="category-count">89</div>
                                </div>
                            <div class="forum-category">
                                <div class="category-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">ËßíËâ≤‰∫íÂä®</div>
                                    <div class="category-desc">‰∏éAIËßíËâ≤ÁöÑÊïÖ‰∫ã</div>
                                </div>
                                <div class="category-count">256</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ËÆ∞ÂøÜËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div id="memorySettingsModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ËÆ∞ÂøÜÁ≥ªÁªüËÆæÁΩÆ</h3>
                            <button class="modal-close" onclick="closeMemorySettings()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-group">
                                <label for="aiExtractInterval">AIËÆ∞ÂøÜÊèêÂèñÈó¥ÈöîÔºàËΩÆÊï∞Ôºâ</label>
                                <input type="number" id="aiExtractInterval" min="10" max="200" step="10" value="30">
                                <small>ÊØèÂ§öÂ∞ëËΩÆÂØπËØùËøõË°å‰∏ÄÊ¨°AIËÆ∞ÂøÜÊèêÂèñÔºàÂª∫ËÆÆ20-50ËΩÆÔºâ</small>
                            </div>

                            <div class="setting-group">
                                <label for="coreMemoryThreshold">Ê†∏ÂøÉËÆ∞ÂøÜÈáçË¶ÅÊÄßÈòàÂÄº</label>
                                <input type="range" id="coreMemoryThreshold" min="0.7" max="1.0" step="0.05" value="0.9">
                                <span id="coreThresholdValue">90%</span>
                                <small>Âè™ÊúâÈáçË¶ÅÊÄßË∂ÖËøáÊ≠§ÈòàÂÄºÁöÑËÆ∞ÂøÜÊâç‰ºöÊàê‰∏∫Ê†∏ÂøÉËÆ∞ÂøÜ</small>
                            </div>

                            <div class="setting-group">
                                <label for="episodicMemoryThreshold">ÊÉÖÊôØËÆ∞ÂøÜÈáçË¶ÅÊÄßÈòàÂÄº</label>
                                <input type="range" id="episodicMemoryThreshold" min="0.4" max="0.8" step="0.05" value="0.6">
                                <span id="episodicThresholdValue">60%</span>
                                <small>ÈáçË¶ÅÊÄßÂú®Ê≠§ËåÉÂõ¥ÂÜÖÁöÑËÆ∞ÂøÜ‰ºöÊàê‰∏∫ÊÉÖÊôØËÆ∞ÂøÜ</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeMemorySettings()">ÂèñÊ∂à</button>
                            <button class="btn btn-primary" onclick="saveMemorySettings()">‰øùÂ≠òËÆæÁΩÆ</button>
                        </div>
                    </div>
                </div>

                <!-- ËÆ∞ÂøÜÊü•ÁúãÂô®ÁïåÈù¢ -->
                <div id="memory-viewer-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('memory-viewer-screen')">‚Äπ</button>
                        <div class="app-title">ËÆ∞ÂøÜÊü•ÁúãÂô®</div>
                        <div class="header-actions">
                            <!-- ÁÆÄÂåñÁöÑÊåâÈíÆÁªÑ -->
                            <button class="header-action-btn" onclick="showMemorySettings()" title="ËÆ∞ÂøÜËÆæÁΩÆ">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="header-action-btn" onclick="refreshMemoryData()" title="Âà∑Êñ∞">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="header-action-btn" onclick="showMemoryToolsModal()" title="Ê∏ÖÁêÜÂ∑•ÂÖ∑">
                                <i class="fas fa-tools"></i>
                            </button>
                        </div>
                    </div>
                    <div class="app-content">
                        <!-- ËßíËâ≤ÈÄâÊã©Âô® -->
                        <div class="memory-character-selector">
                            <label for="memory-character-select">ÈÄâÊã©ËßíËâ≤Ôºö</label>
                            <select id="memory-character-select" onchange="loadCharacterMemories()">
                                <option value="">ËØ∑ÈÄâÊã©ËßíËâ≤</option>
                            </select>
                        </div>

                        <!-- ÊêúÁ¥¢ÂíåËøáÊª§ -->
                        <div class="memory-search-section">
                            <div class="memory-search-bar">
                                <input type="text" id="memory-search-input" placeholder="ÊêúÁ¥¢ËÆ∞ÂøÜÂÜÖÂÆπ..." oninput="filterMemories()">
                                <button class="search-btn" onclick="filterMemories()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="memory-filter-tabs">
                                <button class="memory-filter-tab active" data-type="all" onclick="switchMemoryFilter('all')">ÂÖ®ÈÉ®</button>
                                <button class="memory-filter-tab" data-type="core" onclick="switchMemoryFilter('core')">Ê†∏ÂøÉËÆ∞ÂøÜ</button>
                                <button class="memory-filter-tab" data-type="episodic" onclick="switchMemoryFilter('episodic')">ÊÉÖÊôØËÆ∞ÂøÜ</button>
                                <button class="memory-filter-tab" data-type="timeline" onclick="switchMemoryFilter('timeline')">Êó∂Èó¥Á∫ø</button>
                            </div>
                        </div>

                        <!-- ËÆ∞ÂøÜÂÜÖÂÆπÊòæÁ§∫Âå∫Âüü -->
                        <div class="memory-content-area">
                            <div id="memory-list" class="memory-list">
                                <div class="memory-empty-state">
                                    <i class="fas fa-brain"></i>
                                    <p>ËØ∑ÈÄâÊã©ËßíËâ≤Êü•ÁúãËÆ∞ÂøÜ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏ñÁïå‰π¶ÁºñËæëË°®Âçï -->
                <div id="worldbook-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideWorldbookForm()">‚Äπ</button>
                        <div class="app-title" id="worldbook-form-title">Êñ∞Âª∫‰∏ñÁïå‰π¶</div>
                        <button class="save-worldbook-btn save-btn-absolute" onclick="saveWorldbook()">‰øùÂ≠ò</button>
                    </div>
                    <div class="app-content">
                        <div class="worldbook-form">
                            <div class="form-group">
                                <label class="form-label">Ê†áÈ¢ò</label>
                                <input type="text" id="worldbook-title" class="form-input" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶Ê†áÈ¢ò">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂÜÖÂÆπ</label>
                                <textarea id="worldbook-content" class="form-textarea textarea-large" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºåËøôÈáåÂèØ‰ª•ÊèèËø∞ËßíËâ≤ËÉåÊôØ„ÄÅ‰∏ñÁïåËßÇËÆæÂÆöÁ≠â..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Èü≥‰πêÂ∫îÁî®ÁïåÈù¢ -->
                <div id="music-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('music-screen')">‚Äπ</button>
                        <div class="app-title">Èü≥‰πê</div>
                    </div>
                    <div class="app-content">
                        <div class="music-player">
                            <div class="now-playing">
                                <div class="album-cover" id="album-cover">
                                    <i class="fas fa-music"></i>
                                </div>
                                <div class="song-info">
                                    <div class="song-title" id="song-title">ÈÄâÊã©‰∏ÄÈ¶ñÊ≠åÊõ≤</div>
                                    <div class="artist-name" id="artist-name">Êú™Áü•Ëâ∫ÊúØÂÆ∂</div>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress" id="progress"></div>
                                </div>
                                <div class="time-info">
                                    <span id="current-time">0:00</span>
                                    <span id="total-time">0:00</span>
                                </div>
                            </div>
                            
                            <div class="music-controls">
                                <button class="control-btn" onclick="previousSong()">
                                    <i class="fas fa-step-backward"></i>
                                </button>
                                <button class="control-btn play-pause" id="play-pause-btn" onclick="togglePlayPause()">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="control-btn" onclick="nextSong()">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                            </div>
                            
                            <div class="playlist-section">
                                <div class="section-header">
                                    <h3>Êí≠ÊîæÂàóË°®</h3>
                                    <button class="add-music-btn" onclick="addMusicToPlaylist()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="playlist" id="playlist">
                                    <!-- Êí≠ÊîæÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                            
                            <div class="character-listening">
                                <div class="listening-header">
                                    <h3>‰∏ÄËµ∑Âê¨Ê≠åÁöÑËßíËâ≤</h3>
                                    <button class="invite-character-btn" onclick="inviteCharacterToListen()">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                                <div class="listening-characters" id="listening-characters">
                                    <!-- Âê¨Ê≠åËßíËâ≤Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢ -->
                <div id="api-chat-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideChatSettings()">‚Äπ</button>
                        <div class="app-title">ËÅäÂ§©ËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content padding-none-flex overflow-auto">
                        <div class="settings-container">
                            
                            <!-- Áæ§ËÅä‰∏ìÁî®ËÆæÁΩÆ - ‰ªøQQ/ÂæÆ‰ø°Áæ§ËÅäÁïåÈù¢ -->
                            <div class="settings-section" id="group-chat-settings" style="display: none;">
                                <!-- Áæ§ËÅä‰ø°ÊÅØÂç°Áâá -->
                                <div class="group-info-card">
                                    <div class="group-avatar-section" onclick="changeGroupAvatar()">
                                        <img id="group-avatar-preview" src="" class="group-avatar-large" alt="Áæ§Â§¥ÂÉè">
                                        <div class="group-avatar-edit-hint">ÁÇπÂáª‰øÆÊîπ</div>
                                    </div>
                                    <div class="group-basic-info">
                                        <div class="group-name" onclick="changeGroupName()" id="group-name-display">Áæ§ËÅäÂêçÁß∞</div>
                                        <div class="group-member-count" id="group-member-count-display">0ÂêçÊàêÂëò</div>
                                        <div class="group-description" onclick="editGroupDescription()" id="group-description-display">Áæ§ÂÖ¨ÂëäÔºöÁÇπÂáªËÆæÁΩÆÁæ§ÂÖ¨Âëä</div>
                                    </div>
                                </div>

                                <!-- Áæ§ÊàêÂëòÂ±ïÁ§∫Âå∫Âüü -->
                                <div class="group-members-section">
                                    <div class="section-title">Áæ§ÊàêÂëò</div>
                                    <div class="group-members-grid" id="group-members-grid">
                                        <!-- Áæ§ÊàêÂëòÂ§¥ÂÉèÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                                        <div class="member-item add-member" onclick="addGroupMember()">
                                            <div class="member-avatar">
                                                <i class="fas fa-plus"></i>
                                            </div>
                                            <div class="member-name">ÈÇÄËØ∑</div>
                                        </div>
                                        <div class="member-item remove-member" onclick="removeGroupMember()">
                                            <div class="member-avatar">
                                                <i class="fas fa-minus"></i>
                                            </div>
                                            <div class="member-name">ÁßªÈô§</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Áæ§ÂäüËÉΩËÆæÁΩÆ -->
                                <div class="setting-card">
                                    <div class="setting-item" onclick="changeMyGroupNickname()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊàëÂú®Êú¨Áæ§ÁöÑÊòµÁß∞</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-my-group-nickname">Êú™ÈÄâÊã©</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showGroupNotice()">
                                        <div class="setting-left">
                                            <div class="setting-label">Áæ§ÂÖ¨Âëä</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value">Êü•ÁúãËØ¶ÊÉÖ</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>

                                <!-- Áæ§Â∫îÁî®‰∏≠ÂøÉ -->
                                <div class="group-apps-section">
                                    <div class="section-title">Áæ§Â∫îÁî®</div>
                                    <div class="group-apps-grid">
                                        <div class="app-item" onclick="showGroupVote()">
                                            <i class="fas fa-vote-yea app-icon"></i>
                                            <span class="app-name">ÊäïÁ•®</span>
                                        </div>
                                        <div class="app-item" onclick="showGroupActivity()">
                                            <i class="fas fa-calendar-alt app-icon"></i>
                                            <span class="app-name">Áæ§Ê¥ªÂä®</span>
                                        </div>
                                        <div class="app-item" onclick="showGroupTask()">
                                            <i class="fas fa-tasks app-icon"></i>
                                            <span class="app-name">Áæ§‰ªªÂä°</span>
                                        </div>
                                        <div class="app-item" onclick="showMoreApps()">
                                            <i class="fas fa-ellipsis-h app-icon"></i>
                                            <span class="app-name">Êõ¥Â§ö</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ËÅäÂ§©Á™óÂè£ËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-user-edit section-icon"></i>
                                    <span class="section-title">ËÅäÂ§©Á™óÂè£ËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <!-- Ë∫´‰ªΩÈÄâÊã©ÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåË∫´‰ªΩÂú®ÂàõÂª∫ÂØπËØùÊó∂ÈÄâÊã© -->
                                    <!-- ÂçïËÅäÊó∂ÊòæÁ§∫ÂèåÊñπËÆæÁΩÆÔºåÁæ§ËÅäÊó∂ÈöêËóè -->
                                    <div class="setting-item single-chat-only" onclick="showAvatarSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂèåÊñπÂ§¥ÂÉèËÆæÁΩÆ</div>
                                            <div class="setting-desc">ËÆæÁΩÆÂú®Ê≠§ËÅäÂ§©Á™óÂè£‰∏≠ÊòæÁ§∫ÁöÑÂ§¥ÂÉè</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only" onclick="showNicknameSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂèåÊñπÂ§áÊ≥®ËÆæÁΩÆ</div>
                                            <div class="setting-desc">ËÆæÁΩÆÂú®Ê≠§ËÅäÂ§©Á™óÂè£‰∏≠ÊòæÁ§∫ÁöÑÊòµÁß∞</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBackgroundSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ËÅäÂ§©ËÉåÊôØËÆæÁΩÆ</div>
                                            <div class="setting-desc">Ëá™ÂÆö‰πâËÅäÂ§©ÁïåÈù¢ÁöÑËÉåÊôØÂõæÁâá</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBubbleStyleSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ</div>
                                            <div class="setting-desc">ÈÄâÊã©Ê∞îÊ≥°Â§ñËßÇÊ†∑ÂºèÂíåÈ¢úËâ≤</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-bubble-style">ÈªòËÆ§Ê†∑Âºè</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊòæÁ§∫ËßíËâ≤Áä∂ÊÄÅ</div>
                                            <div class="setting-desc">Âú®ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫ËßíËâ≤ÁöÑÂú®Á∫øÁä∂ÊÄÅÂíåÊ¥ªÂä®</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="character-status-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- üî•„ÄêÊñ∞Â¢û„ÄëÁä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáËÆæÁΩÆ -->
                                    <div class="setting-item single-chat-only" id="status-frequency-setting" style="display: none;">
                                        <div class="setting-left">
                                            <div class="setting-label">Áä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéá</div>
                                            <div class="setting-desc">ÊéßÂà∂ËßíËâ≤Áä∂ÊÄÅÁöÑÊ£ÄÊü•ÂíåÊõ¥Êñ∞È¢ëÁéá</div>
                                        </div>
                                        <div class="setting-right">
                                            <select class="setting-select" id="status-update-frequency">
                                                <option value="high">È´òÈ¢ë (30Áßí)</option>
                                                <option value="medium-high">‰∏≠È´òÈ¢ë (1ÂàÜÈíü)</option>
                                                <option value="medium">‰∏≠È¢ë (3ÂàÜÈíü)</option>
                                                <option value="medium-low">‰∏≠‰ΩéÈ¢ë (5ÂàÜÈíü)</option>
                                                <option value="low">‰ΩéÈ¢ë (10ÂàÜÈíü)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Êà≥‰∏ÄÊà≥ÂäüËÉΩËÆæÁΩÆ - ÂçïËÅäÁâπÊúâ -->
                            <div class="settings-section" id="poke-settings-section">
                                <div class="section-header">
                                    <i class="fas fa-hand-paper section-icon"></i>
                                    <span class="section-title">Êà≥‰∏ÄÊà≥ÂäüËÉΩ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂêØÁî®Êà≥‰∏ÄÊà≥</div>
                                            <div class="setting-desc">ÂÖÅËÆ∏ÂèëÈÄÅÊà≥‰∏ÄÊà≥Ê∂àÊÅØÔºåÂèåÊñπÂèØËá™ÂÆö‰πâÊà≥‰∏ÄÊà≥ÂêéÁºÄ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="poke-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item poke-settings poke-settings-visible" id="poke-suffix-settings" onclick="showPokeSuffixSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ</div>
                                            <div class="setting-desc">Ëá™ÂÆö‰πâÂèåÊñπÁöÑÊà≥‰∏ÄÊà≥Âä®‰ΩúÂêéÁºÄ</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-explanation">
                                        <div class="explanation-text">
                                            <strong>ÂäüËÉΩËØ¥ÊòéÔºö</strong><br>
                                            ‚Ä¢ ÁÇπÂáªÂØπÊñπÂ§¥ÂÉèÂç≥ÂèØÂèëÈÄÅÊà≥‰∏ÄÊà≥<br>
                                            ‚Ä¢ ‰Ω†ÂèØ‰ª•Ëá™ÂÆö‰πâÊà≥‰∏ÄÊà≥ÂêéÁºÄÔºåÂ¶Ç"ÁöÑÂ∞èËÑ∏Ëõã"„ÄÅ"ÁöÑÂ∞èÊâã"Á≠â<br>
                                            ‚Ä¢ ËßíËâ≤‰πü‰ºöÊ†πÊçÆÂøÉÊÉÖÂíåËÅäÂ§©ÂÜÖÂÆπËá™‰∏ª‰øÆÊîπËá™Â∑±ÁöÑÊà≥‰∏ÄÊà≥ÂêéÁºÄ
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ËÆ∞ÂøÜËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-brain section-icon"></i>
                                    <span class="section-title">ËÆ∞ÂøÜËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showHistorySettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÈôÑÂ∏¶ÂéÜÂè≤Ê∂àÊÅØÊï∞</div>
                                            <div class="setting-desc">Ëá™ÂÆö‰πâËßíËâ≤ÂõûÂ§çÊó∂ÂèÇËÄÉÁöÑÂéÜÂè≤ÂØπËØùÊï∞Èáè</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-history-count">5ÂõûÂêà</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                    <div class="setting-item" onclick="showGlobalMemorySettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂÖ®Â±ÄËÆ∞ÂøÜÁ≥ªÁªü</div>
                                            <div class="setting-desc">Ë∑®Âú∫ÊôØËøûÁª≠ËÆ∞ÂøÜÔºåËÆ©ËßíËâ≤ËÆ∞‰ΩèÊâÄÊúâ‰∫íÂä®</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="global-memory-status">7Â§©ËÆ∞ÂøÜ</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item single-chat-only" onclick="showMemoryShareSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">‰∏éÁæ§ËÅäÂÖ±‰∫´ËÆ∞ÂøÜ</div>
                                            <div class="setting-desc">ËÆ©ËßíËâ≤Âú®ÂçïËÅä‰∏≠ËÆ∞‰ΩèÁæ§ËÅäÁöÑÂÜÖÂÆπ</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="memory-share-status">Â∑≤ÂÖ≥Èó≠</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showWorldbookMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊåÇËΩΩ‰∏ñÁïå‰π¶</div>
                                            <div class="setting-desc">ËÆ©ËßíËâ≤ÂèÇËÄÉÈÄâÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØÁü•ËØÜ</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-worldbook-mount">Êú™ÊåÇËΩΩ</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Êó∂Èó¥ÊÑüÁü•ËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-clock section-icon"></i>
                                    <span class="section-title">Êó∂Èó¥ÊÑüÁü•</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">Êó∂Èó¥ÊÑüÁü•ÂºÄÂÖ≥</div>
                                            <div class="setting-desc">ËßíËâ≤‰ºöÊÑüÁü•ÂΩìÂâçÊó∂Èó¥Âπ∂Ë∞ÉÊï¥ÂõûÂ§ç</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="time-awareness-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÈÄöËØùËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-phone section-icon"></i>
                                    <span class="section-title">ÈÄöËØùËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ËßíËâ≤‰∏ªÂä®Êã®ÊâìÁîµËØù</div>
                                            <div class="setting-desc">ÂÖÅËÆ∏ËßíËâ≤Ê†πÊçÆÂØπËØùÂÜÖÂÆπ‰∏ªÂä®ÂèëËµ∑ÈÄöËØù</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-call-enabled" class="ai-call-enabled-checkbox">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-explanation">
                                        <div class="explanation-text">
                                            <strong>ÂäüËÉΩËØ¥ÊòéÔºö</strong><br>
                                            ‚Ä¢ <strong>ÂºÄÂêØÊó∂Ôºö</strong>ÂΩìÊú¨ËΩÆËÅäÂ§©‰∏≠ÊèêÂà∞ÈÄöËØùÁõ∏ÂÖ≥ÂÜÖÂÆπÊó∂ÔºåËßíËâ≤Êúâ20%Ê¶ÇÁéá‰∏ªÂä®Áªô‰Ω†ÊâìÁîµËØù<br>
                                            ‚Ä¢ <strong>ÂÖ≥Èó≠Êó∂Ôºö</strong>ËßíËâ≤‰∏ç‰ºö‰∏ªÂä®Êã®ÊâìÁîµËØùÔºåÂè™ËÉΩÁî±Áî®Êà∑‰∏ªÂä®ÂèëËµ∑ÈÄöËØù<br>
                                            ‚Ä¢ <strong>ÈÄöËØùÂÖ≥ÈîÆËØçÔºö</strong>ÈÄöËØù„ÄÅÁîµËØù„ÄÅËßÜÈ¢ë„ÄÅËØ≠Èü≥„ÄÅÊâìÁªô‰Ω†„ÄÅÊÉ≥Âê¨„ÄÅÊÉ≥ÁúãÁ≠â
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AIÂøÉÁéáÁõëÊµã -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-heartbeat section-icon"></i>
                                    <span class="section-title">ËßíËâ≤ÂøÉÁéáÁõëÊµã</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂøÉÁéáÁõëÊµãÊòæÁ§∫</div>
                                            <div class="setting-desc">Âú®Áä∂ÊÄÅÊ†èÊòæÁ§∫ËßíËâ≤ÁöÑÊÉÖÊÑüÂøÉÁéá</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-heartrate-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-comments section-icon"></i>
                                    <span class="section-title">ËÅäÂ§©Ê®°Âºè</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">Ê®°ÂºèÈÄâÊã©</div>
                                            <div class="setting-desc">ÈÄâÊã©Á∫ø‰∏äÁ∫ØËÅäÂ§©ÊàñÁ∫ø‰∏ãÂâßÊÉÖÊ®°Âºè</div>
                                        </div>
                                    </div>
                                    <div class="chat-mode-switch">
                                        <div class="chat-mode-option">
                                            <input type="radio" id="chat-mode-online" name="chat-mode" value="online" checked>
                                            <label for="chat-mode-online">Á∫ø‰∏äÊ®°Âºè</label>
                                        </div>
                                        <div class="chat-mode-option">
                                            <input type="radio" id="chat-mode-offline" name="chat-mode" value="offline">
                                            <label for="chat-mode-offline">Á∫ø‰∏ãÊ®°Âºè</label>
                                        </div>
                                    </div>
                                    <div class="offline-length-control hide" id="offline-length-control">
                                        <span class="control-label">ÊØèÊù°Ê∂àÊÅØÊúÄÈïøÔºö</span>
                                        <input type="number" id="offline-mode-max-length" min="50" max="500" value="100">
                                        <span class="control-unit">Â≠ó</span>
                                    </div>
                                </div>
                            </div>



                            <!-- ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-robot section-icon"></i>
                                    <span class="section-title">ÂêéÂè∞‰∫íÂä®</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂêéÂè∞‰∫íÂä®ÂºÄÂÖ≥</div>
                                            <div class="setting-desc">ËßíËâ≤ÂèØÂú®ÂêéÂè∞‰∏ªÂä®Ê¥ªÂä®Âπ∂ÂèëÈÄÅÊé®ÈÄÅ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="background-interaction-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="background-interaction-details hide" id="background-interaction-settings">
                                        <div class="setting-item">
                                        <div class="setting-left">
                                                <div class="setting-label">‰∏ªÂä®ËÅäÂ§©</div>
                                                <div class="setting-desc">ËßíËâ≤Âú®‰Ω†10ÂàÜÈíüÊú™ÂõûÂ§çÊó∂‰∏ªÂä®ÂèëÊ∂àÊÅØ</div>
                                        </div>
                                        <div class="setting-right">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="background-chat-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                        </div>
                                    </div>
                                        
                                        <div class="setting-item" id="chat-frequency-setting" style="display: none;">
                                        <div class="setting-left">
                                                <div class="setting-label">‰∏ªÂä®ËÅäÂ§©È¢ëÁéá</div>
                                                <div class="setting-desc">ËßíËâ≤‰∏ªÂä®ÂèëËµ∑ÂØπËØùÁöÑÈ¢ëÁéá</div>
                                        </div>
                                        <div class="setting-right">
                                                <select id="background-chat-frequency" class="setting-select">
                                                    <option value="low">‰Ωé (1-2Â∞èÊó∂/Ê¨°)</option>
                                                    <option value="medium">‰∏≠ (30-60ÂàÜÈíü/Ê¨°)</option>
                                                    <option value="high">È´ò (10-30ÂàÜÈíü/Ê¨°)</option>
                                                </select>
                                </div>
                            </div>

                                    <div class="setting-item">
                                        <div class="setting-left">
                                                <div class="setting-label">‰∏ªÂä®ÂèëÂä®ÊÄÅ</div>
                                                <div class="setting-desc">ËßíËâ≤Ê†πÊçÆ‰∫∫ËÆæ‰∏ªÂä®ÂèëÂ∏ÉÂä®ÊÄÅ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                    <input type="checkbox" id="background-moments-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                        <div class="setting-item" id="moments-frequency-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">‰∏ªÂä®ÂèëÂä®ÊÄÅÈ¢ëÁéá</div>
                                                <div class="setting-desc">ËßíËâ≤‰∏ªÂä®ÂèëÂ∏ÉÁ§æ‰∫§Âä®ÊÄÅÁöÑÈ¢ëÁéá</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; flex-shrink: 0 !important;">
                                                <select id="background-moments-frequency" class="setting-select">
                                                    <option value="low">‰Ωé (4-8Â∞èÊó∂/Ê¨°)</option>
                                                    <option value="medium">‰∏≠ (2-4Â∞èÊó∂/Ê¨°)</option>
                                                    <option value="high">È´ò (1-2Â∞èÊó∂/Ê¨°)</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="setting-item" id="scheduled-moments-setting" style="display: none; justify-content: space-between !important; align-items: flex-start !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">ÂÆöÊó∂ÂèëÂ∏ÉÂä®ÊÄÅ</div>
                                                <div class="setting-desc">ËÆæÁΩÆÂõ∫ÂÆöÊó∂Èó¥ÁÇπËá™Âä®ÂèëÂ∏ÉÂä®ÊÄÅ</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; flex-direction: column !important; align-items: flex-end !important; gap: 8px !important; flex-shrink: 0 !important;">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="scheduled-moments-enabled">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <button onclick="showScheduleTimesModal()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    <span id="schedule-times-display">Êú™ËÆæÁΩÆ</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="setting-item" id="test-publish-setting" style="display: none; justify-content: space-between !important; align-items: center !important;">
                                            <div class="setting-left" style="flex: 1 !important;">
                                                <div class="setting-label">ÊµãËØïÂèëÂ∏É</div>
                                                <div class="setting-desc">ËÆ©ËßíËâ≤Á´ãÂç≥ÂèëÂ∏É‰∏ÄÊù°ÊµãËØïÂä®ÊÄÅ</div>
                                            </div>
                                            <div class="setting-right" style="display: flex !important; align-items: center !important; flex-shrink: 0 !important; gap: 8px;">
                                                <button onclick="testPublishMoment()" style="background-color: #4a84c1; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    ÂèëÂ∏É
                                                </button>
                                                <button onclick="fixAvatarData()" style="background-color: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">
                                                    ‰øÆÂ§çÂ§¥ÂÉè
                                                </button>
                                            </div>
                                        </div>
                                        
                                                                            <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">‰∏ªÂä®Êã®ÊâìÁîµËØù</div>
                                            <div class="setting-desc">ËßíËâ≤Âú®ÈÄÇÂΩìÊó∂Êú∫‰∏ªÂä®Êã®ÊâìÁîµËØù</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="background-ai-call-enabled" class="ai-call-enabled-checkbox">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÂÖ∂‰ªñËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-cog section-icon"></i>
                                    <span class="section-title">ÂÖ∂‰ªñËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊòæÁ§∫Êó∂Èó¥Êà≥</div>
                                            <div class="setting-desc">Âú®ËÅäÂ§©Ê∂àÊÅØ‰∏≠ÊòæÁ§∫Êó∂Èó¥‰ø°ÊÅØ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="timestamp-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showTimestampSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">Êó∂Èó¥Êà≥ËÆæÁΩÆ</div>
                                            <div class="setting-desc">ËÆæÁΩÆÊó∂Èó¥Êà≥ÊòæÁ§∫‰ΩçÁΩÆÂíåÊ†ºÂºè</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="searchChatContent()">
                                        <div class="setting-left">
                                            <div class="setting-label">Êü•ÊâæËÅäÂ§©ÂÜÖÂÆπ</div>
                                            <div class="setting-desc">ÊêúÁ¥¢ÂéÜÂè≤Ê∂àÊÅØ‰∏≠ÁöÑÂÖ≥ÈîÆËØç</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="exportChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</div>
                                            <div class="setting-desc">ÂØºÂá∫ÂΩìÂâçÂØπËØùÁöÑÊâÄÊúâÊ∂àÊÅØ</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- Âç±Èô©Êìç‰Ωú -->
                            <div class="settings-section">
                                <div class="section-header">
                                                    <i class="fas fa-exclamation-triangle section-icon danger-section-icon"></i>
                <span class="section-title danger-section-title">Âç±Èô©Êìç‰Ωú</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showBlacklistSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊãâÈªëÁÆ°ÁêÜ</div>
                                            <div class="setting-desc">ÊãâÈªë/Ëß£Èô§ÊãâÈªëÔºåËÆæÁΩÆÂÜ∑ÈùôÊó∂Èó¥</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item danger-item" onclick="clearChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label danger-color">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</div>
                                            <div class="setting-desc">Âà†Èô§ÊâÄÊúâÂéÜÂè≤Ê∂àÊÅØÔºå‰∏çÂèØÊÅ¢Â§ç</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right danger-color"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                
                <!-- ‰∫∫Áâ©ÁºñËæëË°®Âçï -->
                <div id="character-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideCharacterForm()">‚Äπ</button>
                        <div class="app-title" id="character-form-title">Êñ∞Âª∫‰∫∫Áâ©</div>
                        <button class="import-character-btn" id="import-character-btn" onclick="importCharacterCard()" title="ÂØºÂÖ•ËßíËâ≤Âç°">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button class="export-character-btn" id="export-character-btn" onclick="exportCharacterCard()" title="ÂØºÂá∫ËßíËâ≤Âç°" style="display: none;">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">Â§¥ÂÉè</label>
                                <div class="avatar-preview" id="avatar-preview">
                                    <div class="avatar-preview-text" id="avatar-preview-text">A</div>
                                </div>
                                <input type="file" id="avatar-upload" accept="image/*" class="file-input-hidden">
                            <input type="file" id="character-card-upload" accept=".png,.json" class="file-input-hidden">
                                <button class="upload-button" onclick="handleAvatarUploadClick()">‰∏ä‰º†Â§¥ÂÉè</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÂßìÂêç</label>
                                <input type="text" class="form-input" id="character-name" placeholder="ËæìÂÖ•ÂßìÂêç">
                            </div>
                            <div class="form-group">
                                <label class="form-label">‰∫∫ËÆæ</label>
                                <textarea class="form-textarea" id="character-bio" placeholder="ËæìÂÖ•‰∫∫Áâ©ËÆæÂÆö"></textarea>
                            </div>
                            <div class="form-actions form-actions-flex">
                                <button class="form-submit form-submit-flex">‰øùÂ≠ò</button>
                                <button class="form-delete form-delete-red" id="character-delete-btn" onclick="deleteCurrentCharacter()">Âà†Èô§</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Èù¢ÂÖ∑ÂàõÂª∫Ë°®Âçï -->
                <div id="persona-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hidePersonaForm()">‚Äπ</button>
                        <div class="app-title" id="persona-form-title">Êñ∞Âª∫Èù¢ÂÖ∑</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">Â§¥ÂÉè</label>
                                <div class="avatar-preview" id="persona-avatar-preview">
                                    <div class="avatar-preview-text" id="persona-avatar-preview-text">Êàë</div>
                                </div>
                                <input type="file" id="persona-avatar-upload" accept="image/*" class="file-input-hidden">
                                <button class="upload-button" onclick="handlePersonaAvatarUploadClick()">‰∏ä‰º†Â§¥ÂÉè</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÂêçÁß∞</label>
                                <input type="text" class="form-input" id="persona-name" placeholder="‰æãÂ¶ÇÔºöuserÂ∞èÊòé„ÄÅuserÂ≠¶Áîü„ÄÅuserÂ∑•‰ΩúËÄÖ">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÊèèËø∞</label>
                                <textarea class="form-textarea" id="persona-description" placeholder="ÊèèËø∞Ëøô‰∏™Ë∫´‰ªΩÁöÑÁâπÁÇπÔºåÂåÖÊã¨ÊÄßÊ†º„ÄÅËØ¥ËØùÈ£éÊ†º„ÄÅ‰ΩøÁî®Âú∫ÂêàÁ≠â..."></textarea>
                            </div>
                            
                            <button class="form-submit" onclick="savePersona()">‰øùÂ≠òÈù¢ÂÖ∑</button>
                        </div>
                    </div>
                </div>
                
                <!-- APIËÅäÂ§©ÁïåÈù¢ -->
                <div id="api-chat-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div id="ai-heartrate-display" style="display: none;">‚ô•Ô∏è 72 bpm</div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="header">
                        <div class="default-controls">
                            <button class="back-btn" onclick="backToChatApp()">‚Äπ</button>
                            <span class="header-title" id="api-chat-title">ËßíËâ≤ËÅäÂ§©</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="showChatSettings()">
                                <i class="fas fa-ellipsis-v"></i>
                                </span>
                            </div>
                        </div>
                        <div class="selection-controls">
                            <span id="selection-cancel-btn">ÂèñÊ∂à</span>
                            <span id="selection-count"></span>
                            <span id="selection-delete-btn">Âà†Èô§</span>
                        </div>
                    </div>
                    <div class="app-content padding-none-flex">

                        <div class="chat-dialog">
                            <div class="chat-messages" id="api-chat-messages">
                                <!-- ËÅäÂ§©Ê∂àÊÅØÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            
                            <!-- ÊÇ¨ÊµÆÊåâÈíÆÁªÑ -->
                            <div class="floating-actions" id="floating-actions">
                                <button class="floating-btn" id="regenerate-btn" onclick="regenerateLastResponse()" title="ÈáçÊñ∞ÁîüÊàêÂõûÁ≠î">
                                    <i class="fas fa-redo-alt"></i>
                                </button>
                            </div>
                            
                            <div class="chat-input-area">
                                <!-- Â±ïÂºÄÁöÑÂ∑•ÂÖ∑Èù¢Êùø -->
                                <div class="tools-panel" id="tools-panel" style="display: none;">
                                    <div class="tools-grid">
                                        <div class="tool-item" onclick="handleVoiceRecording(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-microphone"></i>
                                            </div>
                                            <span class="tool-label">ËØ≠Èü≥</span>
                                        </div>
                                        <div class="tool-item" onclick="showCustomEmojiPanel(); hideToolsPanel();">
                                            <div class="tool-icon">
                                                <i class="fas fa-smile"></i>
                                            </div>
                                            <span class="tool-label">Ë°®ÊÉÖ</span>
                                        </div>
                                        <div class="tool-item" onclick="openCamera(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-camera"></i>
                                            </div>
                                            <span class="tool-label">ÊãçÁÖß</span>
                                        </div>
                                        <div class="tool-item" onclick="uploadImage(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-image"></i>
                                            </div>
                                            <span class="tool-label">ÂõæÁâá</span>
                                        </div>
                                        <div class="tool-item" onclick="openTransfer(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-exchange-alt"></i>
                                            </div>
                                            <span class="tool-label">ËΩ¨Ë¥¶</span>
                                        </div>
                                        <div class="tool-item" onclick="makeCall(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-phone"></i>
                                            </div>
                                            <span class="tool-label">ÁîµËØù</span>
                                        </div>
                                        <div class="tool-item" onclick="openVideoCall(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-video"></i>
                                            </div>
                                            <span class="tool-label">ËßÜÈ¢ë</span>
                                        </div>
                                        <div class="tool-item" onclick="shareLocation(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                            </div>
                                            <span class="tool-label">‰ΩçÁΩÆ</span>
                                        </div>
                                        <div class="tool-item" onclick="showDiaryMenu(); hideToolsPanel();">
                                            <div class="tool-icon">
                                        <i class="fas fa-book"></i>
                                            </div>
                                            <span class="tool-label">Êó•ËÆ∞</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ËæìÂÖ•Âå∫Âüü -->
                                <div class="input-controls">
                                <button class="chat-action-btn toggle-tools-btn" onclick="toggleToolsPanel()" title="ÂäüËÉΩËèúÂçï" id="toggle-tools-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <div style="position: relative; flex: 1; min-width: 0;">
                                    <textarea class="chat-input" id="api-chat-input" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."></textarea>
                                    <!-- @Áæ§ÊàêÂëò‰∏ãÊãâÈÄâÊã©Ê°Ü -->
                                    <div class="mention-dropdown" id="mention-dropdown">
                                        <!-- Âä®ÊÄÅÁîüÊàêÁæ§ÊàêÂëòÂàóË°® -->
                                    </div>
                                </div>
                                    <button class="chat-action-btn" onclick="triggerSmartReply()" title="Ëé∑ÂèñAIÂõûÂ§ç">
                                        <i class="fas fa-comment-dots"></i>
                                </button>
                                <button class="send-button" onclick="sendApiMessage()">
                                    ÂèëÈÄÅ
                                </button>
                                </div>
                                <input type="file" id="image-upload" accept="image/*" class="file-input-hidden">
                                <input type="file" id="emoji-upload" accept="image/*" class="file-input-hidden" multiple>
                            </div>
                        </div>
                        
                        <!-- Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÈù¢Êùø -->
                        <div class="custom-emoji-panel" id="custom-emoji-panel">
                            <div class="emoji-tabs">
                                <div class="emoji-tab active" data-tab="recent">ÊúÄËøë</div>
                                <div class="emoji-tab" data-tab="custom">ÂÖ®ÈÉ®</div>
                            </div>
                            <div class="emoji-content">
                                <div class="emoji-grid" id="emoji-grid">
                                    <!-- Ë°®ÊÉÖÂåÖÁΩëÊ†ºÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÊµèËßàÂô®ÁïåÈù¢ -->
                <div id="browser-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('browser-screen')">‚Äπ</button>
                        <div class="app-title">ÊµèËßàÂô®</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="browser-toolbar">
                            <input type="text" class="browser-url-bar" id="browser-url" placeholder="ËæìÂÖ•ÁΩëÂùÄ">
                            <button onclick="loadUrl()">ÂâçÂæÄ</button>
                        </div>
                        <iframe class="browser-content" id="browser-frame"></iframe>
                    </div>
                </div>
                

                
                <!-- Ê∏∏ÊàèÁïåÈù¢ -->
                <div id="game-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('game-screen')">‚Äπ</button>
                        <div class="app-title">Ê∏∏Êàè‰∏≠ÂøÉ</div>
                    </div>
                    <div class="app-content">
                        <div class="game-list">
                            <div class="game-item" onclick="startGame('witchPotion')">
                                <div class="game-icon">
                                    <i class="fas fa-flask"></i>
                        </div>
                                <div class="game-info">
                                    <div class="game-name">Â•≥Â∑´ÁöÑËß£ËçØ</div>
                                    <div class="game-desc">‰∏éAIËßíËâ≤‰∏ÄËµ∑Ë∞ÉÂà∂Á•ûÁßòËçØÊ∞¥</div>
                                </div>
                                <div class="game-badge">NEW</div>
                            </div>
                            <div class="game-item coming-soon">
                                <div class="game-icon">
                                    <i class="fas fa-dice"></i>
                                </div>
                                <div class="game-info">
                                    <div class="game-name">ËßíËâ≤ÁåúË∞ú</div>
                                    <div class="game-desc">Âç≥Â∞ÜÊé®Âá∫</div>
                                </div>
                            </div>
                            <div class="game-item coming-soon">
                                <div class="game-icon">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="game-info">
                                    <div class="game-name">‰∫íÂä®ÊïÖ‰∫ã</div>
                                    <div class="game-desc">Âç≥Â∞ÜÊé®Âá∫</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                

                

                
                <!-- ËÆæÁΩÆÂ∫îÁî® -->
                <div id="settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('settings-screen')">‚Äπ</button>
                        <div class="app-title">ËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showApp('api-settings-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wifi">
                                    <i class="fas fa-wifi"></i>
                                </div>
                                <div>APIËÆæÁΩÆ</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('theme-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon settings-icon-custom">
                                    <i class="fas fa-palette"></i>
                                </div>
                                <div>‰∏ªÈ¢òËÆæÁΩÆ</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('display-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-font"></i>
                                </div>
                                <div>Â≠óÂè∑Â§ßÂ∞è</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('appearance-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div>
                                    <div class="setting-label">Â§ñËßÇËÆæÁΩÆ</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('wallpaper-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wallpaper">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div>Â£ÅÁ∫∏</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('datetime-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon datetime">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>Êó•Êúü‰∏éÊó∂Èó¥</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon notification">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div>ÈÄöÁü•</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('data-management-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon data-management">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div>Êï∞ÊçÆÁÆ°ÁêÜ</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('about-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon about">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div>ÂÖ≥‰∫éÊàë‰ª¨</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Êó•Êúü‰∏éÊó∂Èó¥ËÆæÁΩÆ -->
                <div id="datetime-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('datetime-screen')">‚Äπ</button>
                        <div class="app-title">Êó•Êúü‰∏éÊó∂Èó¥</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>Ëá™Âä®ËÆæÁΩÆ</div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" checked>
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Êï∞ÊçÆÁÆ°ÁêÜ -->
                <div id="data-management-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('data-management-screen')">‚Äπ</button>
                        <div class="app-title">Êï∞ÊçÆÁÆ°ÁêÜ</div>
                    </div>
                    <div class="app-content">
                        <!-- Â≠òÂÇ®Á©∫Èó¥‰ΩøÁî®ÊÉÖÂÜµ -->
                        <div class="data-section">
                            <div class="data-section-title">Â≠òÂÇ®Á©∫Èó¥‰ΩøÁî®ÊÉÖÂÜµ</div>
                            <div class="storage-usage" id="storage-usage">
                                <div class="storage-item">
                                    <div class="storage-label">ËÅäÂ§©ËÆ∞ÂΩï</div>
                                    <div class="storage-size" id="chat-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">ËßíËâ≤Êï∞ÊçÆ</div>
                                    <div class="storage-size" id="character-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">ËÅäÂ§©ËÆæÁΩÆ</div>
                                    <div class="storage-size" id="settings-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                                <div class="storage-item">
                                    <div class="storage-label">Ë°®ÊÉÖÂåÖ</div>
                                    <div class="storage-size" id="emoji-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                                <div class="storage-total">
                                    <div class="storage-label">ÊÄªËÆ°</div>
                                    <div class="storage-size" id="total-storage-size">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Êï∞ÊçÆÂØºÂÖ•ÂØºÂá∫ -->
                        <div class="data-section">
                            <div class="data-section-title">Êï∞ÊçÆÂ§á‰ªΩ‰∏éÊÅ¢Â§ç</div>
                            <div class="settings-item" onclick="exportAllData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon export">
                                        <i class="fas fa-download"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ</div>
                                        <div class="setting-desc">Â∞ÜÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂíåËÆæÁΩÆÂØºÂá∫‰∏∫JSONÊñá‰ª∂</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="importDataFromFile()">
                                <div class="settings-item-left">
                                    <div class="settings-icon import">
                                        <i class="fas fa-upload"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ÂØºÂÖ•Êï∞ÊçÆ</div>
                                        <div class="setting-desc">‰ªéJSONÊñá‰ª∂ÊÅ¢Â§çËÅäÂ§©ËÆ∞ÂΩïÂíåËÆæÁΩÆ</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- Êï∞ÊçÆÊ£ÄÊü•‰∏é‰øÆÂ§ç -->
                        <div class="data-section">
                            <div class="data-section-title">Êï∞ÊçÆÊ£ÄÊü•‰∏é‰øÆÂ§ç</div>
                            <div class="settings-item" onclick="checkAndFixChatHistory()">
                                <div class="settings-item-left">
                                    <div class="settings-icon import">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">Ê£ÄÊü•ËÅäÂ§©ÂéÜÂè≤</div>
                                        <div class="setting-desc">Ê£ÄÊü•Âπ∂‰øÆÂ§çËÅäÂ§©ËÆ∞ÂΩïÊï∞ÊçÆÔºåÊÅ¢Â§ç‰∏¢Â§±ÁöÑÊ∂àÊÅØ</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        
                        <!-- ÈÄâÊã©ÊÄßÊ∏ÖÁêÜ -->
                        <div class="data-section">
                            <div class="data-section-title">Â≠òÂÇ®Ê∏ÖÁêÜ</div>
                            <div class="settings-item" onclick="cleanupOrphanedContacts()">
                                <div class="settings-item-left">
                                    <div class="settings-icon cleanup">
                                        <i class="fas fa-user-slash"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">Ê∏ÖÁêÜÂ≠§Á´ãËÅîÁ≥ª‰∫∫</div>
                                        <div class="setting-desc">Ê∏ÖÁêÜ‰∏çÂ≠òÂú®ÁöÑËßíËâ≤ËÅîÁ≥ª‰∫∫ÂíåÁõ∏ÂÖ≥Êï∞ÊçÆ</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>

                            <div class="settings-item" onclick="showCleanupOptions()">
                                <div class="settings-item-left">
                                    <div class="settings-icon cleanup">
                                        <i class="fas fa-broom"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ÈÄâÊã©ÊÄßÊ∏ÖÁêÜ</div>
                                        <div class="setting-desc">Ê∏ÖÁêÜÁâπÂÆöÁ±ªÂûãÁöÑÊï∞ÊçÆ‰ª•ÈáäÊîæÁ©∫Èó¥</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="settings-item" onclick="compressAllImages()">
                                <div class="settings-item-left">
                                    <div class="settings-icon compress">
                                        <i class="fas fa-compress-arrows-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">ÂéãÁº©ÂõæÁâá</div>
                                        <div class="setting-desc">ÂéãÁº©ÊâÄÊúâÂ§¥ÂÉèÂíåËÉåÊôØÂõæÁâá‰ª•ËäÇÁúÅÁ©∫Èó¥</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>

                        <!-- Âç±Èô©Êìç‰Ωú -->
                        <div class="data-section danger-section">
                            <div class="data-section-title">Âç±Èô©Êìç‰Ωú</div>
                            <div class="settings-item danger-item" onclick="clearAllData()">
                                <div class="settings-item-left">
                                    <div class="settings-icon danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </div>
                                    <div>
                                        <div class="setting-label">Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ</div>
                                        <div class="setting-desc">Âà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï„ÄÅËßíËâ≤ÂíåËÆæÁΩÆÔºà‰∏çÂèØÊÅ¢Â§çÔºâ</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂÖ≥‰∫éÊàë‰ª¨ -->
                <div id="about-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('about-screen')">‚Äπ</button>
                        <div class="app-title">ÂÖ≥‰∫éÊàë‰ª¨</div>
                    </div>
                    <div class="app-content">
                        <div class="about-content">
                            <div class="about-title">iPhone Ê®°ÊãüÂô®</div>
                            <div class="about-version">ÁâàÊú¨ 1.0.0</div>
                            <div class="about-author">‰ΩúËÄÖ@EVE</div>
                        </div>
                    </div>
                </div>
                
                <!-- ÁîµËØùÈÄöËØùÁïåÈù¢ -->
                <div id="phone-call-screen" class="app-screen">
                    <div class="call-background"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="call-content">
                        <div class="call-header">
                            <div class="call-avatar">
                                <img id="call-avatar-img" src="" alt="ÈÄöËØùÂ§¥ÂÉè">
                            </div>
                            <div class="call-name" id="call-name">ËßíËâ≤ÂêçÁß∞</div>
                            <div class="call-status" id="call-status">Ê≠£Âú®ÈÄöËØù‰∏≠...</div>
                            <div class="call-time" id="call-timer">00:00</div>
                        </div>
                        
                        <div class="call-message-container" id="call-message-container">
                            <!-- ÈÄöËØù‰∏≠ÁöÑÊ∂àÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                        </div>
                        
                        <div class="call-input-area">
                            <input type="text" id="call-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." class="call-text-input" onkeypress="if(event.key === 'Enter') { event.preventDefault(); sendCallMessage(); }">
                            <button class="call-send-btn" onclick="sendCallMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <div class="call-controls">
                                                    <button class="call-control-btn end-call-btn" onclick="endCall()"></button>
                        </div>
                    </div>
                </div>
                
                <!-- Êù•ÁîµÊòæÁ§∫ÁïåÈù¢ -->
                <div id="incoming-call-screen" class="app-screen">
                    <div class="call-background incoming"></div>
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="incoming-call-content">
                        <div class="call-header">
                            <div class="call-avatar large-avatar">
                                <img id="incoming-call-avatar" src="" alt="Êù•ÁîµÂ§¥ÂÉè">
                            </div>
                            <div class="call-name" id="incoming-call-name">ËßíËâ≤ÂêçÁß∞</div>
                            <div class="call-status">Êù•Áîµ</div>
                            <div class="call-text" id="incoming-call-text">ÊÉ≥Âíå‰Ω†ÈÄöËØù...</div>
                        </div>
                        
                        <div class="incoming-call-controls">
                            <button class="incoming-call-btn reject-btn" onclick="rejectCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-phone-slash"></i>
                                </div>
                                <div class="call-btn-text">ÊãíÁªù</div>
                            </button>
                            <button class="incoming-call-btn accept-btn" onclick="acceptCall()">
                                <div class="call-btn-icon">
                                    <i class="fas fa-phone"></i>
                                </div>
                                <div class="call-btn-text">Êé•Âê¨</div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Â≠óÂè∑Â§ßÂ∞èËÆæÁΩÆ -->
                <div id="display-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('display-screen')">‚Äπ</button>
                        <div class="app-title">Â≠óÂè∑Â§ßÂ∞è</div>
                    </div>
                    <div class="app-content">
                        <div class="font-size-preview">
                            <div class="font-size-preview-text" id="font-size-preview">
                                ËøôÊòØ‰∏ÄÊÆµÁ§∫‰æãÊñáÂ≠óÔºåÁî®‰∫éÈ¢ÑËßàÂ≠ó‰ΩìÂ§ßÂ∞èÊïàÊûú„ÄÇË∞ÉËäÇ‰∏ãÊñπÊªëÂùóÂèØ‰ª•ÊîπÂèòÂ≠ó‰ΩìÂ§ßÂ∞è„ÄÇ
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">Â≠óÂè∑Â§ßÂ∞è</div>
                                    <div class="setting-desc">Ë∞ÉËäÇËÅäÂ§©Ê∂àÊÅØÂíåÁ§æ‰∫§Âä®ÊÄÅÁöÑÂ≠ó‰ΩìÂ§ßÂ∞è</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="font-size-slider-container">
                            <div class="font-size-labels">
                                <span>Â∞è</span>
                                <span>Ê†áÂáÜ</span>
                                <span>Â§ß</span>
                            </div>
                            <input type="range" class="font-size-slider" id="font-size-slider" 
                                   min="12" max="20" step="1" value="15" 
                                   onchange="changeFontSize(this.value)">
                            <div class="font-size-value">
                                ÂΩìÂâçÂ≠óÂè∑Ôºö<span id="font-size-value">15px</span>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">Â≠óË∑ùËÆæÁΩÆ</div>
                                    <div class="setting-desc">Ë∞ÉËäÇÊñáÂ≠ó‰πãÈó¥ÁöÑÈó¥Ë∑ù</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="font-size-slider-container">
                            <div class="font-size-labels">
                                <span>Á¥ßÂáë</span>
                                <span>Ê†áÂáÜ</span>
                                <span>ÂÆΩÊùæ</span>
                            </div>
                            <input type="range" class="font-size-slider" id="letter-spacing-slider" 
                                   min="-0.5" max="2" step="0.1" value="0" 
                                   onchange="changeLetterSpacing(this.value)">
                            <div class="font-size-value">
                                ÂΩìÂâçÂ≠óË∑ùÔºö<span id="letter-spacing-value">Ê†áÂáÜ</span>
                            </div>
                        </div>
                        
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">Ëá™Âä®Áº©Êîæ</div>
                                    <div class="setting-desc">Ê†πÊçÆÂ±èÂπïÂ∞∫ÂØ∏Ëá™Âä®Ë∞ÉÊï¥Â≠ó‰ΩìÂ§ßÂ∞è</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="auto-scale-toggle" onchange="toggleAutoScale()">
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Â±èÂπïÂ∞∫ÂØ∏ËÆæÁΩÆ -->
                <div id="screen-size-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('screen-size-screen')">‚Äπ</button>
                        <div class="app-title">Â±èÂπïÂ∞∫ÂØ∏</div>
                    </div>
                    <div class="app-content">
                        <div class="size-option" onclick="changeScreenSize(320, 568, 'iPhone SE')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone SE</div>
                                <div class="size-desc">320√ó568 (Â∞èÂ±èÊ®°Âºè)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-xs"></div>
                            </div>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(350, 740, 'ÈÄÇ‰∏≠Â∞∫ÂØ∏')" id="size-350-740">
                            <div class="size-option-left">
                                <div class="size-name">ÈÄÇ‰∏≠Â∞∫ÂØ∏</div>
                                <div class="size-desc">350√ó740 (Êé®Ëçê)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-s"></div>
                            </div>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(375, 812, 'iPhone 12/13')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 12/13</div>
                                <div class="size-desc">375√ó812 (Ê†áÂáÜ)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-m"></div>
                            </div>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(390, 844, 'iPhone 15')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15</div>
                                <div class="size-desc">390√ó844 (ÁúüÂÆûÂ∞∫ÂØ∏)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-l"></div>
                            </div>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(428, 926, 'iPhone 15 Plus')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15 Plus</div>
                                <div class="size-desc">428√ó926 (Â§ßÂ±è)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect size-preview-rect-xl"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Â§ñËßÇËÆæÁΩÆ -->
                <div id="appearance-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('appearance-screen')">‚Äπ</button>
                        <div class="app-title">Â§ñËßÇËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">ÊòæÁ§∫ÊâãÊú∫ËæπÊ°Ü</div>
                                    <div class="setting-desc">ÊòæÁ§∫ÂúÜËßíËæπÊ°ÜÂíåÈò¥ÂΩ±ÊïàÊûú</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="phone-border-toggle" checked onchange="togglePhoneBorder()">
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item" onclick="showScreenSizeOptions()">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">Â±èÂπïÂ∞∫ÂØ∏</div>
                                    <div class="setting-desc" id="current-screen-size">ÂΩìÂâçÔºö350√ó740 (ÈÄÇ‰∏≠Â∞∫ÂØ∏)</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏ªÈ¢òËÆæÁΩÆÁïåÈù¢ -->
                <div id="theme-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('theme-screen')">‚Äπ</button>
                        <div class="app-title">‰∏ªÈ¢òËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="theme-option" onclick="changeTheme('default')">
                            <div class="theme-preview theme-preview-simple">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">ÁÆÄÁ∫¶È£éÊ†º</div>
                                <div class="theme-description">Ê∏ÖÊñ∞ÁÆÄÊ¥ÅÁöÑÈªòËÆ§‰∏ªÈ¢ò</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('cute')">
                            <div class="theme-preview theme-preview-cute">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">ÂèØÁà±È£éÊ†º</div>
                                <div class="theme-description">Ê∏©È¶®ÂèØÁà±ÁöÑÁ≤âËâ≤‰∏ªÈ¢ò</div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                
                <!-- Â£ÅÁ∫∏ËÆæÁΩÆ -->
                <div id="wallpaper-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('wallpaper-screen')">‚Äπ</button>
                        <div class="app-title">Â£ÅÁ∫∏</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showWallpaperPicker()">
                            <div class="settings-item-left">
                                <div>ÈÄâÊã©Êñ∞Â£ÅÁ∫∏</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showIconPicker()">
                            <div class="settings-item-left">
                                <div>Êõ¥ÊîπÂ∫îÁî®ÂõæÊ†á</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Êó†Á∫øÂ±ÄÂüüÁΩëËÆæÁΩÆ -->
                <div id="wifi-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('wifi-screen')">‚Äπ</button>
                        <div class="app-title">Êó†Á∫øÂ±ÄÂüüÁΩë</div>
                    </div>
                    <div class="app-content">
                        <div class="wifi-settings">
                            <div class="settings-item">
                                <div class="settings-item-left">
                                    <div>Êó†Á∫øÂ±ÄÂüüÁΩë</div>
                                </div>
                                <label class="settings-toggle">
                                    <input type="checkbox" checked>
                                    <span class="settings-slider"></span>
                                </label>
                            </div>
                            
                            <div class="wifi-network">
                                <div class="wifi-network-left">
                                    <div class="wifi-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div>
                                        <div>HomeWiFi</div>
                                        <div class="wifi-strength">
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                        </div>
                                    </div>
                                </div>
                                <i class="fas fa-check check-icon"></i>
                            </div>
                            
                            <div class="settings-item settings-item-margin" onclick="showApp('api-settings-screen')">
                                <div class="settings-item-left">
                                    <div>APIËÆæÁΩÆ</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- APIËÆæÁΩÆÁïåÈù¢ -->
                <div id="api-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('api-settings-screen')">‚Äπ</button>
                        <div class="app-title">APIËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="form-container" style="color: #000000;">
                            

                            
                            <!-- Âø´ÈÄüËÆæÁΩÆÂç°Áâá -->
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label style="color: #333; margin-bottom: 15px; display: block; font-size: 16px; font-weight: 600;">üöÄ Âø´ÈÄüËÆæÁΩÆ</label>
                                
                                <!-- GeminiÁõ¥ËøûÂç°Áâá -->
                                <div style="margin-bottom: 12px; padding: 18px; background: linear-gradient(135deg, rgba(74, 132, 193, 0.1) 0%, rgba(74, 132, 193, 0.05) 100%); border: 2px solid rgba(74, 132, 193, 0.2); border-radius: 16px; color: #333; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);" onclick="setGeminiDirect()">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--theme-button-bg, #4a84c1);">üåü Gemini Áõ¥Ëøû</div>
                                            <div style="font-size: 13px; color: #666;">Ëá™Âä®ÈÖçÁΩÆGoogleÂÆòÊñπAPIÔºåÊîØÊåÅÊúÄÊñ∞Ê®°Âûã</div>
                                        </div>
                                        <div style="background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(74, 132, 193, 0.3);">ÁÇπÂáªÈÖçÁΩÆ</div>
                                    </div>
                            </div>
                            
                                <!-- HuggingFaceÂèç‰ª£Âç°Áâá -->
                                <div style="margin-bottom: 15px; padding: 18px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%); border: 2px solid rgba(255, 193, 7, 0.2); border-radius: 16px; color: #333; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);" onclick="setHuggingFaceProxy()">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: #f39c12;">ü§ó HuggingFace Âèç‰ª£</div>
                                            <div style="font-size: 13px; color: #666;">ÂÖçË¥π‰ΩøÁî®Â§öÁßçÂ§ßÊ®°ÂûãÔºåÊîØÊåÅClaudeÁ≠â</div>
                                        </div>
                                        <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);">ÁÇπÂáªÈÖçÁΩÆ</div>
                                    </div>
                            </div>
                            
                                <div style="font-size: 12px; color: #666; text-align: center; margin-top: 10px;">
                                    ‚ö†Ô∏è ‰ΩøÁî®ÂâçËØ∑Á°Æ‰øùÊúâÂØπÂ∫îÁöÑAPIÂØÜÈí•
                                </div>
                            </div>
                            
                            <!-- APIÈÖçÁΩÆË°®Âçï - ÁæéÂåñÁâà -->
                            <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);">
                                
                                <!-- APIÂú∞ÂùÄ -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">APIÂú∞ÂùÄ</label>
                                    <input type="text" id="api-base" placeholder="‰æãÂ¶Ç: https://api.openai.com Êàñ @https://xxx-xxx.hf.space/v1" style="width: 100%; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); box-sizing: border-box;">
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">ÊîØÊåÅÊ†áÂáÜAPIÂíåHuggingFaceÂèç‰ª£ÔºàÊ†ºÂºèÔºö@https://xxx.hf.space/v1Ôºâ</div>
                            </div>
                            
                                <!-- APIÂØÜÈí• -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">APIÂØÜÈí•</label>
                                    <input type="password" id="api-key" placeholder="sk-... Êàñ Google AI Studio API Key" style="width: 100%; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); box-sizing: border-box;">
                                </div>
                                
                                <!-- Ê®°ÂûãÈÄâÊã© -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">Ê®°Âûã</label>
                                    <div style="display: flex; gap: 10px; align-items: center; width: 100%; overflow: hidden;">
                                        <select id="model-select" style="flex: 1; min-width: 0; padding: 12px 15px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08)); border-radius: 12px; font-size: 16px; background: var(--theme-form-bg, rgba(255, 255, 255, 0.9)); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--theme-text-primary, #333); max-height: 200px; overflow-y: auto;">
                                            <!-- Ê®°ÂûãÈÄâÈ°πÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÂ°´ÂÖÖ -->
                                    </select>
                                        <button id="fetch-models-btn" onclick="fetchModels()" style="padding: 10px 16px; background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8)); color: var(--theme-button-secondary-color, #666); border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1)); border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; backdrop-filter: blur(10px); transition: all 0.3s ease; white-space: nowrap;">ÊãâÂèñÊ®°Âûã</button>
                                </div>
                            </div>
                            
                                <!-- Ê∏©Â∫¶ÂèÇÊï∞ -->
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--theme-text-primary, #333); font-size: 15px;">Ê∏©Â∫¶ÂèÇÊï∞ (<span id="temperature-value" style="color: var(--theme-button-bg, #4a84c1); font-weight: 700;">0.75</span>)</label>
                                    <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 12px; border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));">
                                        <input type="range" id="temperature-slider" min="0" max="2" step="0.05" value="0.75" oninput="document.getElementById('temperature-value').textContent = parseFloat(this.value).toFixed(2);" style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, rgba(74, 132, 193, 0.2) 0%, rgba(74, 132, 193, 0.4) 100%); outline: none; -webkit-appearance: none; appearance: none;">
                                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #666;">
                                            <span>0.00 (‰øùÂÆà)</span>
                                            <span>1.00 (Âπ≥Ë°°)</span>
                                            <span>2.00 (ÂàõÊñ∞)</span>
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">Ê∏©Â∫¶Ë∂ä‰ΩéÔºåÂõûÁ≠îË∂ä‰øùÂÆàÁ®≥ÂÆöÔºõÊ∏©Â∫¶Ë∂äÈ´òÔºåÂõûÁ≠îË∂äÊúâÂàõÊÑèÂ§öÊ†∑</div>
                                    </div>
                            </div>
                            
                                <!-- Êìç‰ΩúÊåâÈíÆ -->
                                <div style="display: flex; gap: 12px; margin-top: 25px;">
                                    <button id="test-api-connection-btn" onclick="testApiConnection()" style="flex: 1; padding: 14px 20px; background: linear-gradient(135deg, #34c759 0%, #30d158 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3); transition: all 0.3s ease;">ÊµãËØïËøûÊé•</button>
                                    <button id="save-api-settings-btn" onclick="saveApiSettings()" style="flex: 1; padding: 14px 20px; background: var(--theme-button-bg, rgba(74, 132, 193, 0.9)); color: var(--theme-button-color, white); border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(74, 132, 193, 0.3)); transition: all 0.3s ease;">‰øùÂ≠òËÆæÁΩÆ</button>
                                </div>
                            </div>

                            <!-- APIÈÖçÁΩÆÁÆ°ÁêÜ -->
                            <hr style="margin: 30px 0; border: none; border-top: 1px solid #eaeaea;">
                            <div class="api-config-manager" style="background: rgba(248, 249, 250, 0.8); border-radius: 16px; padding: 20px; margin: 15px 0; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>üíæ</span> APIÈÖçÁΩÆÁÆ°ÁêÜ
                                </h4>
                                <p style="font-size: 13px; color: #666; margin: 0 0 15px 0; line-height: 1.5;">‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ‰∏∫È¢ÑËÆæÔºåÊñπ‰æøÂø´ÈÄüÂàáÊç¢‰∏çÂêåÁöÑAPIÊúçÂä°</p>
                                
                                <div class="save-config-section" style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.6); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                                        <input type="text" id="config-name-input" placeholder="ËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞ (Â¶Ç: OpenAI„ÄÅGemini„ÄÅClaudeÁ≠â)" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.9);">
                                        <button id="save-current-config-btn" onclick="saveCurrentConfig()" style="padding: 10px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">üíæ ‰øùÂ≠òÈÖçÁΩÆ</button>
                        </div>
                                    <div style="font-size: 12px; color: #888;">ÂΩìÂâçÈÖçÁΩÆÂ∞Ü‰øùÂ≠ò‰∏∫: <span style="color: #333; font-weight: 500;">URL + Ê®°Âûã + Ê∏©Â∫¶ËÆæÁΩÆ</span></div>
                                </div>
                                
                                <div class="saved-configs-section">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                        <label style="font-size: 14px; font-weight: 500; color: #333;">Â∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ</label>
                                        <button id="clear-all-configs-btn" onclick="clearAllConfigs()" style="padding: 6px 12px; background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;">üóëÔ∏è Ê∏ÖÁ©∫ÂÖ®ÈÉ®</button>
                                    </div>
                                    <div id="saved-configs-container" style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                                        <!-- ‰øùÂ≠òÁöÑÈÖçÁΩÆÂç°ÁâáÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                                    </div>
                                    <div id="no-configs-message" style="text-align: center; color: #999; padding: 30px 20px; font-size: 14px; display: none;">
                                        <div style="font-size: 24px; margin-bottom: 8px;">üìù</div>
                                        <div>ËøòÊ≤°Êúâ‰øùÂ≠ò‰ªª‰ΩïÈÖçÁΩÆ</div>
                                        <div style="font-size: 12px; margin-top: 4px;">Âú®‰∏äÊñπËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞Âπ∂ÁÇπÂáª"‰øùÂ≠òÈÖçÁΩÆ"</div>
                                    </div>
                                </div>
                            </div>



                        </div>
                    </div>
                </div>
                
                <!-- È¢úËâ≤ÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="color-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title" id="color-picker-title">ÈÄâÊã©È¢úËâ≤</div>
                            <button class="modal-close" onclick="hideModal('color-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="color-picker" id="color-picker">
                                <div class="color-option color-red" onclick="selectColor('#FF3B30')"></div>
                                <div class="color-option color-orange" onclick="selectColor('#FF9500')"></div>
                                <div class="color-option color-yellow" onclick="selectColor('#FFCC00')"></div>
                                <div class="color-option color-green" onclick="selectColor('#34C759')"></div>
                                <div class="color-option color-light-blue" onclick="selectColor('#5AC8FA')"></div>
                                <div class="color-option color-blue" onclick="selectColor('#007AFF')"></div>
                                <div class="color-option color-purple" onclick="selectColor('#5856D6')"></div>
                                <div class="color-option color-pink" onclick="selectColor('#AF52DE')"></div>
                                <div class="color-option color-red-alt" onclick="selectColor('#FF2D55')"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÈÄèÊòéÂ∫¶</label>
                                <input type="range" class="opacity-slider" id="opacity-slider" min="0" max="1" step="0.1" value="1">
                                <span id="opacity-value">100%</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('color-picker-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="applyColorSelection()">Â∫îÁî®</button>
                        </div>
                    </div>
                </div>
                
                <!-- Â£ÅÁ∫∏ÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="wallpaper-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©Â£ÅÁ∫∏</div>
                            <button class="modal-close" onclick="hideModal('wallpaper-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="wallpaper-preview-container" id="wallpaper-preview-container">
                                <div class="wallpaper-preview-placeholder">
                                    <i class="fas fa-image"></i>
                                    <div>ÈÄâÊã©Êú¨Âú∞ÂõæÁâáÂêéÂèØÂú®Ê≠§È¢ÑËßà</div>
                                </div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomWallpaper()">
                                <div class="settings-item-left">
                                    <div>‰ªéÁõ∏ÂÜåÈÄâÊã©</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-wallpaper-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('wallpaper-picker-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="applyWallpaperSelection()">Â∫îÁî®</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂõæÊ†áÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="icon-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©Â∫îÁî®ÂõæÊ†á</div>
                            <button class="modal-close" onclick="hideModal('icon-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="icon-options">
                                <div class="icon-option" onclick="selectAppIcon('chat-screen', 'fas fa-comment-dots')">
                                    <div class="icon-preview">
                                        <i class="fas fa-comment-dots"></i>
                                    </div>
                                    <span>Chat</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('weibo-screen', 'fab fa-weibo')">
                                    <div class="icon-preview">
                                        <i class="fab fa-weibo"></i>
                                    </div>
                                    <span>Á§æ‰∫§ÁΩëÁªú</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('music-screen', 'fas fa-music')">
                                    <div class="icon-preview">
                                        <i class="fas fa-music"></i>
                                    </div>
                                    <span>Èü≥‰πê</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('album-screen', 'fas fa-images')">
                                    <div class="icon-preview">
                                        <i class="fas fa-images"></i>
                                    </div>
                                    <span>Áõ∏ÂÜå</span>
                                </div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomIcon()">
                                <div class="settings-item-left">
                                    <div>‰ªéÁõ∏ÂÜåÈÄâÊã©</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-icon-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('icon-picker-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="applyIconSelection()">Â∫îÁî®</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÁÖßÁâáÊãçÊëÑÊ®°ÊÄÅÊ°Ü -->

                

                
                <!-- Ê∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="add-contact-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Ê∑ªÂä†ËÅîÁ≥ª‰∫∫</div>
                            <button class="modal-close" onclick="hideModal('add-contact-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="contact-modal-body">
                            <!-- ËÅîÁ≥ª‰∫∫ÈÄâÈ°πÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('add-contact-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="addSelectedContacts()">Ê∑ªÂä†</button>
                        </div>
                    </div>
                </div>
                
                <!-- ËÅäÂ§©ÈÄâÈ°πÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="chat-options-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©ËÅäÂ§©Á±ªÂûã</div>
                            <button class="modal-close" onclick="hideModal('chat-options-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="chat-option-item" onclick="showSingleChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-user icon-user-blue"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">ÂçïËÅä</div>
                                    <div class="chat-option-desc">‰∏éÂçï‰∏™ËßíËâ≤ËøõË°åÂØπËØù</div>
                                </div>
                            </div>
                            <div class="chat-option-item" onclick="showGroupChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-users icon-users-green"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">Áæ§ËÅä</div>
                                    <div class="chat-option-desc">‰∏éÂ§ö‰∏™ËßíËâ≤ÂêåÊó∂ËÅäÂ§©</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÂçïËÅäËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="single-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©ËÅäÂ§©ËßíËâ≤</div>
                            <button class="modal-close" onclick="hideModal('single-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="single-chat-body">
                            <!-- ËßíËâ≤ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                
                <!-- Áæ§ËÅäËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="group-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂàõÂª∫Áæ§ËÅä</div>
                            <button class="modal-close" onclick="hideModal('group-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Áæ§ËÅäÂêçÁß∞</label>
                                <input type="text" class="form-input" id="group-chat-name" placeholder="‰æãÂ¶ÇÔºöÂä®ÊÄÅÂàÜ‰∫´„ÄÅÂ∑•‰ΩúÁæ§">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÈÄâÊã©ÊàêÂëò (Ëá≥Â∞ë2‰∫∫ÔºåÊúÄÂ§ö8‰∫∫)</label>
                                <div id="group-chat-members">
                                    <!-- Áæ§ËÅäÊàêÂëòÈÄâÊã©Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('group-chat-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="createGroupChat()">ÂàõÂª∫Áæ§ËÅä</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="history-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('history-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-card">
                                <div class="setting-item">
                                    <div class="setting-left">
                                        <div class="setting-label">ÈôÑÂ∏¶ÂéÜÂè≤Ê∂àÊÅØÊï∞ (ÂõûÂêàÊï∞)</div>
                                        <div class="setting-desc">AIÂõûÂ§çÊó∂ÂèÇËÄÉÁöÑÂéÜÂè≤ÂØπËØùÂõûÂêàÊï∞</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="history-count-display">5ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="setting-range-container">
                                    <input type="range" class="theme-range" id="history-messages-count" min="0" max="100" step="1" value="5">
                                    <div class="range-labels">
                                        <span>0ÂõûÂêà</span>
                                        <span>100ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="custom-input-container">
                                    <span class="input-label">Ëá™ÂÆö‰πâÊï∞ÂÄºÔºö</span>
                                    <input type="number" class="theme-input" id="custom-history-count" min="0" max="500" value="5">
                                    <span class="input-unit">ÂõûÂêà (ÊúÄÂ§ß500)</span>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>ËØ¥ÊòéÔºö</strong><br>
                                        ‚Ä¢ ‰∏ÄÂõûÂêà = ‰Ω†ÁöÑ‰∏ÄÊù°Ê∂àÊÅØ + AIÁöÑ‰∏ÄÊù°ÂõûÂ§ç<br>
                                        ‚Ä¢ ËÆæÁΩÆ‰∏∫5Ë°®Á§∫AIÂõûÂ§çÊó∂‰ºöÂèÇËÄÉÊúÄËøë5ËΩÆÂØπËØù<br>
                                        ‚Ä¢ Ê≥®ÊÑèÔºöÊï∞ÂÄºËøáÂ§ßÂèØËÉΩÂΩ±ÂìçAPIÂìçÂ∫îÈÄüÂ∫¶
                                    </div>
                                </div>
                            </div>
                            
                            <div class="setting-card">
                                <div class="setting-item">
                                    <div class="setting-left">
                                        <div class="setting-label">Ë∑®Á™óÂè£ËÆ∞ÂøÜÂõûÂêàÊï∞</div>
                                        <div class="setting-desc">‰ªéÂÖ∂‰ªñËÅäÂ§©Á™óÂè£ËØªÂèñÁöÑËÉåÊôØËÆ∞ÂøÜÂõûÂêàÊï∞</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="cross-memory-display">3ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="setting-range-container">
                                    <input type="range" class="theme-range" id="cross-chat-memory" min="0" max="20" step="1" value="3">
                                    <div class="range-labels">
                                        <span>0ÂõûÂêà</span>
                                        <span>20ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>ËØ¥ÊòéÔºö</strong><br>
                                        ‚Ä¢ AI‰ºöËØªÂèñÂÖ∂‰ªñËÅäÂ§©Á™óÂè£‰∏≠ÊúÄÊñ∞ÁöÑÂá†ËΩÆÂØπËØù‰Ωú‰∏∫ËÉåÊôØËÆ∞ÂøÜ<br>
                                        ‚Ä¢ ‰∏ÄÂõûÂêà = Áî®Êà∑‰∏ÄÊù°Ê∂àÊÅØ + AI‰∏ÄÊù°ÂõûÂ§ç<br>
                                        ‚Ä¢ Â∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÁêÜËß£Êï¥‰ΩìÂØπËØù‰∏ä‰∏ãÊñá
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="theme-button theme-button-secondary" onclick="hideModal('history-settings-modal')">ÂèñÊ∂à</button>
                            <button class="theme-button theme-button-primary" onclick="saveHistorySettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="memory-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('memory-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="memory-mount-enabled" class="checkbox-with-margin">
                                    ÂêØÁî®ËÆ∞ÂøÜÊåÇËΩΩ
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåAI‰ºöÂèÇËÄÉÂÖ∂‰ªñËÅäÂ§©Á™óÂè£ÁöÑÂØπËØùÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØËÆ∞ÂøÜ
                                </p>
                            </div>
                            <div class="form-group hide" id="memory-mount-details">
                                <label class="form-label">ÊØè‰∏™ËÅäÂ§©ÊåÇËΩΩÊù°Êï∞</label>
                                <input type="range" class="api-form-range" id="memory-mount-count" min="1" max="20" step="1" value="3">
                                <div class="flex-space-between">
                                    <span>1Êù°</span>
                                    <span id="memory-mount-display">3Êù°</span>
                                    <span>20Êù°</span>
                                </div>
                            </div>
                            <div class="form-group hide" id="memory-mount-chats">
                                <label class="form-label">ÈÄâÊã©Ë¶ÅÊåÇËΩΩÁöÑËÅäÂ§©</label>
                                <div id="memory-mount-list" class="max-height-200-auto">
                                    <!-- ËÅäÂ§©ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                                <p class="small-text margin-top-8">
                                    ÈÄâÊã©ÁöÑËÅäÂ§©ËÆ∞ÂΩï‰ºö‰Ωú‰∏∫ËÉåÊôØ‰ø°ÊÅØÊèê‰æõÁªôAIÂèÇËÄÉ
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('memory-mount-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveMemoryMountSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Â§¥ÂÉèËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="avatar-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂèåÊñπÂ§¥ÂÉèËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('avatar-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="avatar-setting-group">
                                <label class="form-label">ÊàëÁöÑÂ§¥ÂÉè (‰ªÖÂú®Ê≠§ËÅäÂ§©Á™óÂè£ÁîüÊïà)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="my-chat-avatar-preview">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <input type="file" id="my-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('my-chat-avatar-upload').click()">‰∏ä‰º†Â§¥ÂÉè</button>
                                </div>
                            </div>
                            <div class="avatar-setting-group">
                                <label class="form-label">ÂØπÊñπÂ§¥ÂÉè (‰ªÖÂú®Ê≠§ËÅäÂ§©Á™óÂè£ÁîüÊïà)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="ai-chat-avatar-preview">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <input type="file" id="ai-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('ai-chat-avatar-upload').click()">‰∏ä‰º†Â§¥ÂÉè</button>
                                    <button class="upload-button clear-avatar-btn" onclick="clearAiDynamicAvatar()">Ê∏ÖÈô§Âä®ÊÄÅÂ§¥ÂÉè</button>
                                </div>
                                <p class="small-text margin-top-5">
                                    Ê≥®ÊÑèÔºöÂ¶ÇÊûúËßíËâ≤Âú®ËÅäÂ§©‰∏≠Êõ¥Êç¢‰∫ÜÂ§¥ÂÉèÔºåÂä®ÊÄÅÂ§¥ÂÉè‰ºöË¶ÜÁõñÊ≠§ËÆæÁΩÆÔºåÁÇπÂáª"Ê∏ÖÈô§Âä®ÊÄÅÂ§¥ÂÉè"ÂèØÈáçÁΩÆ
                                </p>
                            </div>
                            <div class="form-group margin-top-20">
                                <label class="form-label">
                                    <input type="checkbox" id="hide-avatars" class="checkbox-with-margin">
                                    ÈöêËóèÂèåÊñπÂ§¥ÂÉè
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåËÅäÂ§©ÁïåÈù¢Â∞Ü‰∏çÊòæÁ§∫‰ªª‰ΩïÂ§¥ÂÉè
                                </p>
                            </div>
                            <p class="small-text margin-top-15">
                                Ê≥®ÊÑèÔºöÊ≠§ËÆæÁΩÆ‰ªÖÂΩ±ÂìçÂΩìÂâçËÅäÂ§©Á™óÂè£ÊòæÁ§∫Ôºå‰∏ç‰ºöÂêåÊ≠•‰øÆÊîπËßíËâ≤Âç°ÊàñÈù¢ÂÖ∑ËÆæÁΩÆ
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('avatar-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatAvatarSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÊòµÁß∞ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="nickname-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂèåÊñπÂ§áÊ≥®ËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('nickname-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÊòµÁß∞ (‰ªÖÂú®Ê≠§ËÅäÂ§©‰∏≠ÊòæÁ§∫)</label>
                                <input type="text" class="form-input" id="my-chat-nickname" placeholder="ËæìÂÖ•‰Ω†Âú®Ê≠§ËÅäÂ§©‰∏≠ÁöÑÊòµÁß∞">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂØπÊñπÊòµÁß∞ (‰ªÖÂú®Ê≠§ËÅäÂ§©‰∏≠ÊòæÁ§∫)</label>
                                <input type="text" class="form-input" id="ai-chat-nickname" placeholder="ËæìÂÖ•ÂØπÊñπÂú®Ê≠§ËÅäÂ§©‰∏≠ÁöÑÊòµÁß∞">
                            </div>
                            <p class="small-text margin-top-10">
                                Ê≥®ÊÑèÔºöÊ≠§ËÆæÁΩÆ‰ªÖÂΩ±ÂìçÂΩìÂâçËÅäÂ§©Á™óÂè£ÊòæÁ§∫Ôºå‰∏ç‰ºöÂêåÊ≠•‰øÆÊîπËßíËâ≤Âç°ÊàñÈù¢ÂÖ∑ËÆæÁΩÆ„ÄÇËßíËâ≤‰πüÂèØËÉΩÊ†πÊçÆÂøÉÊÉÖÂíåËÅäÂ§©ÂÜÖÂÆπËá™‰∏ª‰øÆÊîπËá™Â∑±ÁöÑÊòµÁß∞„ÄÇ
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('nickname-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatNicknameSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="poke-suffix-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('poke-suffix-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÊà≥‰∏ÄÊà≥ÂêéÁºÄ</label>
                                <input type="text" class="form-input" id="my-poke-suffix" placeholder="ÁïôÁ©∫‰∏∫Êó†ÂêéÁºÄÔºà‰æãÂ¶ÇÔºöÁöÑÂ∞èËÑ∏ËõãÔºâ">
                                <p class="tiny-text margin-top-5">ÊòæÁ§∫‰∏∫Ôºö‰Ω†Êà≥‰∫ÜÊà≥[ËßíËâ≤Âêç][ÂêéÁºÄ]ÔºåÁïôÁ©∫ÂàôÊòæÁ§∫Ôºö‰Ω†Êà≥‰∫ÜÊà≥[ËßíËâ≤Âêç]</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂØπÊñπÊà≥‰∏ÄÊà≥ÂêéÁºÄ</label>
                                <input type="text" class="form-input" id="ai-poke-suffix" placeholder="ÁïôÁ©∫‰∏∫Êó†ÂêéÁºÄÔºà‰æãÂ¶ÇÔºöÁöÑÂ∞èÊâãÔºâ">
                                <p class="tiny-text margin-top-5">ÊòæÁ§∫‰∏∫Ôºö[ËßíËâ≤Âêç]Êà≥‰∫ÜÊà≥‰Ω†[ÂêéÁºÄ]ÔºåÁïôÁ©∫ÂàôÊòæÁ§∫Ôºö[ËßíËâ≤Âêç]Êà≥‰∫ÜÊà≥‰Ω†„ÄÇËßíËâ≤ÂèØËÉΩÊ†πÊçÆÂøÉÊÉÖËá™‰∏ª‰øÆÊîπÊ≠§ÂêéÁºÄ„ÄÇ</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('poke-suffix-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="savePokeSuffixSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ËÅäÂ§©ËÉåÊôØËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="background-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ËÅäÂ§©ËÉåÊôØËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('background-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="background-preview-container">
                                <div class="background-preview" id="chat-background-preview">
                                    <div class="preview-text">ËÉåÊôØÈ¢ÑËßà</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="file" id="background-upload" accept="image/*" class="file-input-hidden">
                                <button class="form-button" onclick="document.getElementById('background-upload').click()">ÈÄâÊã©ËÉåÊôØÂõæÁâá</button>
                                <button class="form-button form-button-secondary" onclick="removeBackground()">ÁßªÈô§ËÉåÊôØ</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('background-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatBackgroundSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- üî•„ÄêÊñ∞Â¢û„ÄëÁæ§ÊàêÂëòÊ∞îÊ≥°È¢úËâ≤ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="group-member-colors-modal" style="z-index: 10001;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Áæ§ÊàêÂëòÊ∞îÊ≥°È¢úËâ≤ËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('group-member-colors-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-explanation">
                                <div class="explanation-text">‰∏∫ÊØè‰∏™Áæ§ÊàêÂëòËÆæÁΩÆÁã¨ÁâπÁöÑÊ∞îÊ≥°È¢úËâ≤ÔºåËÆ©Áæ§ËÅäÊõ¥Âä†ÁîüÂä®ÊúâË∂£„ÄÇ</div>
                            </div>
                            <div id="group-member-colors-list">
                                <!-- Âä®ÊÄÅÁîüÊàêÁæ§ÊàêÂëòÈ¢úËâ≤ËÆæÁΩÆÈ°π -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('group-member-colors-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveGroupMemberColors()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="bubble-style-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('bubble-style-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="bubble-style-section">
                                <label class="form-label">ÈÄâÊã©Ê∞îÊ≥°Ê†∑Âºè</label>
                                <div class="bubble-style-grid">
                                    <div class="bubble-style-option" data-style="default">
                                        <div class="style-preview">
                                            <div class="preview-bubble sent-preview">ÈªòËÆ§Ê†∑Âºè</div>
                                            <div class="preview-bubble received-preview">ÁªèÂÖ∏ÂúÜËßí</div>
                                        </div>
                                        <div class="style-name">ÈªòËÆ§Ê†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="glass">
                                        <div class="style-preview bubble-style-glass">
                                            <div class="preview-bubble sent-preview">ÊØõÁéªÁíÉ</div>
                                            <div class="preview-bubble received-preview">ÂçäÈÄèÊòé</div>
                                        </div>
                                        <div class="style-name">ÊØõÁéªÁíÉ</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="shadow">
                                        <div class="style-preview bubble-style-shadow">
                                            <div class="preview-bubble sent-preview">ÁªèÂÖ∏Èò¥ÂΩ±</div>
                                            <div class="preview-bubble received-preview">Á´ã‰ΩìÊÑü</div>
                                        </div>
                                        <div class="style-name">ÁªèÂÖ∏Èò¥ÂΩ±</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="tail">
                                        <div class="style-preview bubble-style-tail">
                                            <div class="preview-bubble sent-preview">Â∏¶Â∞ñËßí</div>
                                            <div class="preview-bubble received-preview">Ê∞îÊ≥°Êà≥</div>
                                        </div>
                                        <div class="style-name">ÁªèÂÖ∏Ê∞îÊ≥°</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="gradient">
                                        <div class="style-preview bubble-style-gradient">
                                            <div class="preview-bubble sent-preview">Ê∏êÂèòËâ≤</div>
                                            <div class="preview-bubble received-preview">ÁæéËßÇ</div>
                                        </div>
                                        <div class="style-name">Ê∏êÂèòÊ†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="minimal">
                                        <div class="style-preview bubble-style-minimal">
                                            <div class="preview-bubble sent-preview">ÊûÅÁÆÄÁ∫øÊù°</div>
                                            <div class="preview-bubble received-preview">ÁÆÄÁ∫¶</div>
                                        </div>
                                        <div class="style-name">ÊûÅÁÆÄÊ†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="neon">
                                        <div class="style-preview bubble-style-neon">
                                            <div class="preview-bubble sent-preview">ÈúìËôπÂèëÂÖâ</div>
                                            <div class="preview-bubble received-preview">ÁßëÊäÄÊÑü</div>
                                        </div>
                                        <div class="style-name">ÈúìËôπÊ†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="paper">
                                        <div class="style-preview bubble-style-paper">
                                            <div class="preview-bubble sent-preview">Á∫∏Âº†Âç°Áâá</div>
                                            <div class="preview-bubble received-preview">Ë¥®ÊÑü</div>
                                        </div>
                                        <div class="style-name">Á∫∏Âº†Ê†∑Âºè</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="color-setting-group">
                                <label class="form-label">Ëá™ÂÆö‰πâÈ¢úËâ≤</label>
                                <div class="color-picker-container">
                                    <div class="flex-gap-15">
                                        <div class="flex-1">
                                            <label class="label-small">ÊàëÁöÑÊ∞îÊ≥°</label>
                                            <input type="color" id="my-bubble-color" class="color-input" value="#007AFF">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">ÂØπÊñπÊ∞îÊ≥°</label>
                                            <input type="color" id="ai-bubble-color" class="color-input" value="#f0f0f0">
                                            <!-- üî•„ÄêÊñ∞Â¢û„ÄëÁæ§ËÅäËßíËâ≤ÂçïÁã¨ËÆæÁΩÆÊåâÈíÆ -->
                                            <div id="group-member-colors-btn" style="display: none; margin-top: 8px;">
                                                <button type="button" class="theme-button theme-button-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="showGroupMemberColorSettings()">
                                                    ‰∏∫Áæ§ÊàêÂëòÂçïÁã¨ËÆæÁΩÆ
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="opacity-setting">
                                    <div class="flex-gap-15-mb-15">
                                        <div class="flex-1">
                                            <label class="label-small">ÊàëÁöÑÊ∞îÊ≥°ÈÄèÊòéÂ∫¶Ôºö<span id="my-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="my-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">ÂØπÊñπÊ∞îÊ≥°ÈÄèÊòéÂ∫¶Ôºö<span id="ai-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="ai-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="padding-setting">
                                    <label class="form-label">Ê∞îÊ≥°Â§ßÂ∞èË∞ÉËäÇ</label>
                                    <div class="flex-gap-15-mb-10">
                                        <div class="flex-1">
                                            <label class="label-small">ÂÜÖËæπË∑ùÔºö<span id="bubble-padding-value">‰∏≠Á≠â</span></label>
                                            <input type="range" id="bubble-padding" min="4" max="16" step="2" value="12" class="width-100">
                                        </div>
                                    </div>
                                    <p class="tiny-text-gray margin-top-5">
                                        Ë∞ÉÊï¥Ê∞îÊ≥°ÂÜÖÊñáÂ≠ó‰∏éËæπÁºòÁöÑË∑ùÁ¶ªÔºåÊï∞ÂÄºË∂äÂ§ßÊ∞îÊ≥°Ë∂äÂ§ß
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('bubble-style-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveBubbleStyleSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="schedule-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('schedule-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="schedule-enabled" class="checkbox-with-margin">
                                    ÂêØÁî®ÂÆöÊó∂ÂèëÂ∏É
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåËßíËâ≤‰ºöÂú®ÊåáÂÆöÊó∂Èó¥ÁÇπËá™Âä®ÂèëÂ∏ÉÁ§æ‰∫§Âä®ÊÄÅ
                                </p>
                            </div>
                            <div class="form-group hide" id="schedule-times-group">
                                <label class="form-label">ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ</label>
                                <div id="schedule-times-container">
                                    <!-- Êó∂Èó¥ÁÇπÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÊ∑ªÂä† -->
                                </div>
                                <button type="button" class="form-button form-button-secondary" onclick="addScheduleTime()">+ Ê∑ªÂä†Êó∂Èó¥ÁÇπ</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('schedule-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveScheduleSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ë∫´‰ªΩÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <!-- Ë∫´‰ªΩÈÄâÊã©Ê®°ÊÄÅÊ°ÜÂ∑≤ÁßªÈô§ÔºåË∫´‰ªΩÂú®ÂàõÂª∫ÂØπËØùÊó∂ÈÄâÊã© -->
                
                <!-- ‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="worldbook-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('worldbook-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="worldbook-mount-enabled" class="checkbox-with-margin">
                                    ÂêØÁî®‰∏ñÁïå‰π¶ÊåÇËΩΩ
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåAI‰ºöÂèÇËÄÉÈÄâÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØÁü•ËØÜËøõË°åÂØπËØù
                                </p>
                            </div>
                            <div class="form-group hide" id="worldbook-mount-details">
                                <label class="form-label">ÈÄâÊã©Ë¶ÅÊåÇËΩΩÁöÑ‰∏ñÁïå‰π¶</label>
                                <div id="worldbook-mount-list" class="max-height-300-auto">
                                    <!-- ‰∏ñÁïå‰π¶ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                                <p class="small-text margin-top-8">
                                    ÈÄâÊã©ÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰ºö‰Ωú‰∏∫ËÉåÊôØÁü•ËØÜÊèê‰æõÁªôAIÂèÇËÄÉÔºåÂ∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÁêÜËß£ÂØπËØù‰∏ä‰∏ãÊñá
                                </p>
                            </div>
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>ÂäüËÉΩËØ¥ÊòéÔºö</strong><br>
                                    ‚Ä¢ <strong>‰∏ñÁïå‰π¶ÊåÇËΩΩÔºö</strong>Â∞ÜÈÄâÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫AIÁöÑËÉåÊôØÁü•ËØÜ<br>
                                    ‚Ä¢ <strong>Â§öÈÄâÊîØÊåÅÔºö</strong>ÂèØ‰ª•ÂêåÊó∂ÊåÇËΩΩÂ§ö‰∏™‰∏ñÁïå‰π¶ÔºåÂÜÖÂÆπ‰ºöÂêàÂπ∂‰ΩøÁî®<br>
                                    ‚Ä¢ <strong>Êô∫ËÉΩÂ∫îÁî®Ôºö</strong>AI‰ºöÊ†πÊçÆÂØπËØùÂÜÖÂÆπÊô∫ËÉΩÂºïÁî®Áõ∏ÂÖ≥ÁöÑ‰∏ñÁïå‰π¶Áü•ËØÜ<br>
                                    ‚Ä¢ <strong>‰ºòÂÖàÁ∫ßÔºö</strong>‰∏ñÁïå‰π¶Áü•ËØÜ‰ºòÂÖàÁ∫ß‰Ωé‰∫éËßíËâ≤ËÆæÂÆöÂíåÂéÜÂè≤ÂØπËØù
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('worldbook-mount-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveWorldbookMountSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>

                <!-- Êó∂Èó¥Êà≥ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="timestamp-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Êó∂Èó¥Êà≥ËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('timestamp-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="timestamp-modal-enabled" class="checkbox-with-margin" checked>
                                    ÊòæÁ§∫Êó∂Èó¥Êà≥
                                </label>
                                <p class="small-text margin-top-5">
                                    Âú®ËÅäÂ§©Ê∂àÊÅØ‰∏≠ÊòæÁ§∫Êó∂Èó¥‰ø°ÊÅØ
                                </p>
                            </div>
                            
                            <div class="form-group" id="timestamp-options-group">
                                <label class="form-label">Êó∂Èó¥Êà≥‰ΩçÁΩÆ</label>
                                <div class="timestamp-position-options">
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="center" checked>
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Â±Ö‰∏≠ÊòæÁ§∫</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®ËÅäÂ§©‰∏≠Èó¥ÔºåÊØè5ÂàÜÈíüÂá∫Áé∞‰∏ÄÊ¨°</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="bubble">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Ê∞îÊ≥°Â§ñ‰æß</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®ÊØèÊù°Ê∂àÊÅØÊ∞îÊ≥°ÁöÑÂ§ñ‰æß</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="avatar">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Â§¥ÂÉè‰∏ãÊñπ</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®Â§¥ÂÉèÊ≠£‰∏ãÊñπ‰ΩçÁΩÆ</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="inside">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Ê∞îÊ≥°ÂÜÖ</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®Ê∞îÊ≥°ÂÜÖÂè≥‰∏ãËßíÔºå‰∏éÊñáÂ≠óÈΩêÂπ≥</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>‰ΩçÁΩÆËØ¥ÊòéÔºö</strong><br>
                                    ‚Ä¢ <strong>Â±Ö‰∏≠ÊòæÁ§∫Ôºö</strong>Êó∂Èó¥Êà≥Ê∞¥Âπ≥Â±Ö‰∏≠Ôºå‰ªÖÂú®Ë∂ÖËøá5ÂàÜÈíüÈó¥ÈöîÊó∂ÊòæÁ§∫<br>
                                    ‚Ä¢ <strong>Ê∞îÊ≥°Â§ñ‰æßÔºö</strong>ÊØèÊù°Ê∂àÊÅØÈÉΩÊòæÁ§∫Êó∂Èó¥ÔºåÁî®Êà∑Ê∂àÊÅØÂú®Â∑¶‰∏ãËßíÔºåËßíËâ≤Ê∂àÊÅØÂú®Âè≥‰∏ãËßí<br>
                                    ‚Ä¢ <strong>Â§¥ÂÉè‰∏ãÊñπÔºö</strong>Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®ÂØπÂ∫îÂ§¥ÂÉèÁöÑÊ≠£‰∏ãÊñπ‰ΩçÁΩÆ<br>
                                    ‚Ä¢ ÊâÄÊúâÊó∂Èó¥Êà≥Âùá‰ΩøÁî®ÁÅ∞Ëâ≤Â∞èÂ≠óÊòæÁ§∫Ôºå‰∏çÂΩ±ÂìçËÅäÂ§©‰ΩìÈ™å
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('timestamp-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveTimestampSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- ËΩ¨Ë¥¶ÂäüËÉΩÁõ∏ÂÖ≥Ê®°ÊÄÅÊ°Ü -->
    <div id="transfer-modal">
        <div class="transfer-content">
                            <div class="transfer-header">ÂèëËµ∑ËΩ¨Ë¥¶</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
                                    <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="1000000000" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">Â§áÊ≥® (ÂèØÈÄâ)</label>
                                    <input type="text" id="transfer-note" placeholder="ËØ¥ÁÇπ‰ªÄ‰πàÂêß..." maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">ÂèñÊ∂à</button>
                <button id="transfer-confirm-btn">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
            </div>
        </div>
    </div>
    
    <div id="transfer-confirm-modal">
        <div class="transfer-confirm-content">
            <div class="transfer-confirm-title">Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶</div>
            <div class="transfer-confirm-info">
                <div class="transfer-confirm-amount">¬• 0.00</div>
                <div class="transfer-confirm-note">Â§áÊ≥®Ôºö</div>
            </div>
            <div class="transfer-confirm-actions">
                <button id="transfer-reject-btn">ÈÄÄÂõû</button>
                <button id="transfer-accept-btn">Á°ÆËÆ§Êî∂Ê¨æ</button>
                </div>
            </div>
        </div>

    <script>
        // ÂàùÂßãÂåñDexieÊï∞ÊçÆÂ∫ì
        const db = new Dexie('PhoneChatDB');
        window.activeGlobalWorldbooks = []; // Áî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊøÄÊ¥ªÁöÑÂÖ®Â±Ä‰∏ñÁïå‰π¶ID
        
        // ÁâàÊú¨1ÔºöÂéüÂßãË°®ÁªìÊûÑ
        db.version(1).stores({
            characters: '&id, name',
            contacts: '&id, characterId', 
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            wallpapers: '&id, type',
            worldbooks: '&id, name',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId'
        });
        
        // ÁâàÊú¨2ÔºöÊ∑ªÂä†Âä®ÊÄÅÁõ∏ÂÖ≥Ë°®
        db.version(2).stores({
            characters: '&id, name',
            contacts: '&id, characterId', 
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            wallpapers: '&id, type',
            worldbooks: '&id, name',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId',
            // Âä®ÊÄÅÁõ∏ÂÖ≥Ë°®
            moments: '&id, authorId, timestamp',
            momentLikes: '[momentId+authorId], momentId, authorId',
            momentComments: '&id, momentId, authorId, timestamp'
        });

        // ÁâàÊú¨3ÔºöÊ∑ªÂä†ÊúÄËøë‰ΩøÁî®Ë°®ÊÉÖÂåÖË°®
        db.version(3).stores({
            characters: '&id, name, groupId',
            contacts: '++id, characterId', 
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            wallpapers: '&id, type',
            worldbooks: '&id, name, isGlobal',
            characterGroups: '&id, name, order',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId',
            moments: '&id, authorId, timestamp',
            momentLikes: '[momentId+authorId], momentId, authorId',
            momentComments: '&id, momentId, authorId, timestamp',
            recentEmojis: '&id, lastUsed'
        });

        // ÁâàÊú¨4ÔºöÊ∑ªÂä†ÊãâÈªëÁ≥ªÁªüÂíåËßíËâ≤Áä∂ÊÄÅ
        db.version(4).stores({
            characters: '&id, name, groupId',
            contacts: '++id, characterId',
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            wallpapers: '&id, type',
            worldbooks: '&id, name, isGlobal',
            characterGroups: '&id, name, order',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId',
            moments: '&id, authorId, timestamp',
            momentLikes: '[momentId+authorId], momentId, authorId',
            momentComments: '&id, momentId, authorId, timestamp',
            recentEmojis: '&id, lastUsed',
            // üî•„ÄêÊñ∞Â¢û„ÄëÊãâÈªëÁ≥ªÁªüÁõ∏ÂÖ≥Ë°®
            blacklist: '&id, blockerId, blockedId, timestamp, cooldownMinutes, reason',
            friendRequests: '&id, fromId, toId, timestamp, status, type, message',
            characterStatus: '&id, characterId, status, activity, location, lastUpdate'
        });

        // ÁâàÊú¨5ÔºöÊ∑ªÂä†ÂÖ®Â±ÄËÆ∞ÂøÜÁ≥ªÁªü
        db.version(5).stores({
            characters: '&id, name, groupId',
            contacts: '++id, characterId',
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            wallpapers: '&id, type',
            worldbooks: '&id, name, isGlobal',
            characterGroups: '&id, name, order',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId',
            moments: '&id, authorId, timestamp',
            momentLikes: '[momentId+authorId], momentId, authorId',
            momentComments: '&id, momentId, authorId, timestamp',
            recentEmojis: '&id, lastUsed',
            blacklist: '&id, blockerId, blockedId, timestamp, cooldownMinutes, reason',
            friendRequests: '&id, fromId, toId, timestamp, status, type, message',
            characterStatus: '&id, characterId, status, activity, location, lastUpdate',
            // üî•„ÄêÊñ∞Â¢û„ÄëÂÖ®Â±ÄËÆ∞ÂøÜÁ≥ªÁªüÁõ∏ÂÖ≥Ë°®
            coreMemories: '&id, characterId, fact, importance, timestamp',
            memorySummaries: '&id, characterId, date, summary, timestamp, context',
            memoryEvents: '&id, characterIds, eventType, timestamp, context'
        });

        // ÁâàÊú¨6ÔºöÈáçÊñ∞ËÆæËÆ°ËÆ∞ÂøÜÁ≥ªÁªü
        db.version(6).stores({
            characters: '&id, name, groupId',
            contacts: '++id, characterId',
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            wallpapers: '&id, type',
            worldbooks: '&id, name, isGlobal',
            characterGroups: '&id, name, order',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId',
            chatSettings: '&id, chatId',
            moments: '&id, authorId, timestamp',
            momentLikes: '[momentId+authorId], momentId, authorId',
            momentComments: '&id, momentId, authorId, timestamp',
            recentEmojis: '&id, lastUsed',
            blacklist: '&id, blockerId, blockedId, timestamp, cooldownMinutes, reason',
            friendRequests: '&id, fromId, toId, timestamp, status, type, message',
            characterStatus: '&id, characterId, status, activity, location, lastUpdate',
            // üî•„ÄêÈáçÊñ∞ËÆæËÆ°„ÄëËÆ∞ÂøÜÁ≥ªÁªüÁõ∏ÂÖ≥Ë°®
            coreMemories: '&id, characterId, fact, importance, timestamp, type, category',
            episodicMemories: '&id, characterId, fact, importance, timestamp, category',
            memorySummaries: '&id, characterId, date, summary, timestamp, context',
            memoryEvents: '&id, characterIds, eventType, timestamp, context',
            crossAppTimeline: '&id, characterId, appType, action, timestamp, context, messageId'
        }).upgrade(tx => {
            // Êï∞ÊçÆËøÅÁßªÈÄªËæë
            console.log('ÂçáÁ∫ßÂà∞ÁâàÊú¨6ÔºöÈáçÊñ∞ËÆæËÆ°ËÆ∞ÂøÜÁ≥ªÁªü');
        });


        // ÂÖ®Â±ÄÂèòÈáè
        let characters = [];
        let contacts = [];
        let currentChatCharacter = null;
        let chatMessages = {};
        let selectedMessageId = null;
        let personas = []; // Áî®Êà∑Èù¢ÂÖ∑ÂàóË°®
        let currentPersona = null; // ÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑
        let editingPersona = null; // Ê≠£Âú®ÁºñËæëÁöÑÈù¢ÂÖ∑
        let isMultiSelectMode = false; // Â§öÈÄâÊ®°ÂºèÁä∂ÊÄÅ
        let selectedCharacters = []; // ÈÄâ‰∏≠ÁöÑËßíËâ≤IDÂàóË°®
        let currentEditingCharacterId = null; // ÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑËßíËâ≤ID
        let groupChats = []; // Áæ§ËÅäÂàóË°®
        let selectedGroupMembers = []; // Áæ§ËÅäÊàêÂëòÈÄâÊã©
        let currentWorldbookTab = 'global';
        let currentCharacterCategory = null; // Ë∑üË∏™ÂΩìÂâçÈÄâÊã©ÁöÑËßíËâ≤ÂàÜÁ±ª
        
        // ËßíËâ≤ÂàÜÁªÑÁõ∏ÂÖ≥ÂèòÈáè
        let characterGroups = []; // ËßíËâ≤ÂàÜÁªÑÂàóË°®
        let isGroupManageMode = false; // ÂàÜÁªÑÁÆ°ÁêÜÊ®°Âºè
        let selectedGroupId = null; // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂàÜÁªÑID
        
        // Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÁõ∏ÂÖ≥ÂèòÈáè
        let customEmojis = []; // Áî®Êà∑‰∏ä‰º†ÁöÑË°®ÊÉÖÂåÖ
        let recentEmojis = []; // ÊúÄËøë‰ΩøÁî®ÁöÑË°®ÊÉÖÂåÖ
        let currentEmojiTab = 'recent'; // ÂΩìÂâçË°®ÊÉÖÂåÖÊ†áÁ≠æÈ°µ
        
        // Ê∂àÊÅØÂ§öÈÄâÂà†Èô§Áõ∏ÂÖ≥ÂèòÈáè
        let isMessageSelectionMode = false; // Ê∂àÊÅØÈÄâÊã©Ê®°Âºè
        let selectedMessages = new Set(); // ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØIDÈõÜÂêà
        
        // Ê∂àÊÅØÂàóË°®Â§öÈÄâÁõ∏ÂÖ≥ÂèòÈáè
        let isMessageListMultiSelectMode = false; // Ê∂àÊÅØÂàóË°®Â§öÈÄâÊ®°ÂºèÁä∂ÊÄÅ
        let selectedConversations = []; // ÈÄâ‰∏≠ÁöÑÂØπËØùÊ°ÜIDÂàóË°®
        
        // Âä®ÊÄÅËØÑËÆ∫ÂØπËØùËΩÆÊ¨°ËøΩË∏™
        let commentConversationRounds = new Map(); // Ê†ºÂºè: "momentId-characterId" => ËΩÆÊ¨°Êï∞
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÊãâÈªëÁ≥ªÁªüÁõ∏ÂÖ≥ÂèòÈáèÂ∑≤Âú®ÂêéÈù¢Â£∞Êòé
        
        let apiSettings = {
            type: 'openai',
            base: 'https://api.openai.com/v1',
            endpoint: '/chat/completions',
            key: '',
            model: 'gpt-3.5-turbo',
            temperature: 0.70
        };
        
        // Ê≥®ÊÑèÔºöËÆ∞ÂøÜËÆæÁΩÆÁé∞Âú®Â∑≤Êîπ‰∏∫ÊØè‰∏™ËÅäÂ§©Á™óÂè£Áã¨Á´ãÁöÑËÆæÁΩÆÔºåÂ≠òÂÇ®Âú®ÂêÑËá™ÁöÑËÅäÂ§©ËÆæÁΩÆ‰∏≠
        
        let chatSettings = {
            themeColor: '#007AFF',
            theirBubbleColor: '#f0f0f0',
            myBubbleColor: '#007AFF',
            bubbleOpacity: 1,
            timestampEnabled: true,
            timestampPosition: 'center'
        };
        

        let selectedAppIcon = null;
        let selectedWallpaper = null;
        let colorPickerContext = null;
        let customIconImage = null;
        
        // Âä†ËΩΩÂÖ®Â±Ä‰∏ñÁïå‰π¶ËÆæÁΩÆ
        async function loadGlobalWorldbookSettings() {
            try {
                const globalSettings = await db.globalSettings.get('main');
                if (globalSettings && globalSettings.activeGlobalWorldbooks) {
                    // Á°Æ‰øù‰ΩøÁî®window.activeGlobalWorldbooks‰ª•Âú®ÂÖ®Â±ÄËåÉÂõ¥ÂÜÖÂèØÁî®
                    window.activeGlobalWorldbooks = globalSettings.activeGlobalWorldbooks;
                } else {
                    window.activeGlobalWorldbooks = [];
                    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ËÆæÁΩÆÔºåÂàõÂª∫‰∏Ä‰∏™ÂàùÂßãËÆæÁΩÆ
                    await db.globalSettings.put({
                        id: 'main',
                        activeGlobalWorldbooks: []
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂÖ®Â±Ä‰∏ñÁïå‰π¶ËÆæÁΩÆÂ§±Ë¥•:', error);
                window.activeGlobalWorldbooks = [];
            }
        }

        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', async function() {
            updateTime();

            try {

            // Âπ∂Ë°åÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
            await Promise.all([
                loadCharacterGroups(), // ÂÖàÂä†ËΩΩÂàÜÁªÑ
                loadCharacters(),
                loadContacts(),
                loadChatMessages(),
                loadMemoryConfig(), // Âä†ËΩΩËÆ∞ÂøÜÈÖçÁΩÆ

                loadChatSettings(),
                loadApiSettings(),
                loadCustomEmojis(),
                loadGlobalWorldbookSettings(), // Á°Æ‰øùÂä†ËΩΩÂÖ®Â±Ä‰∏ñÁïå‰π¶ËÆæÁΩÆ
                initGlobalMemoryDB() // üî•„ÄêÊñ∞Â¢û„ÄëÂàùÂßãÂåñÂÖ®Â±ÄËÆ∞ÂøÜÊï∞ÊçÆÂ∫ì
            ]);
            
            // Âä†ËΩΩÂ§ñËßÇËÆæÁΩÆ
            loadPhoneBorderSetting();
            loadScreenSize();
            loadFontSizeSettings();
            
            // Âä†ËΩΩÂä®ÊÄÅÂõæÁâáËÆæÁΩÆ
            await loadMomentsImages();
            
            // Âä†ËΩΩÂÖ∂‰ªñËÆæÁΩÆÔºàÂåÖÊã¨ÈúÄË¶ÅÊï∞ÊçÆÂ∫ìÁöÑÂ£ÅÁ∫∏ËÆæÁΩÆÔºâ
            await loadWallpaper();
            await loadAppIcons();
            loadSavedTheme();
            await loadWorldbooks();
            loadMusicData();
            await loadPersonas();
            await loadGroupChats();

            // ÂàùÂßãÂåñËÆ∞ÂøÜÊü•ÁúãÂô®
            await initMemoryViewer();
            
            // Ê∏≤ÊüìÁïåÈù¢ - Ê∑ªÂä†Êï∞ÊçÆÈ™åËØÅ
            try {
                if (characters && contacts && chatMessages) {
            renderMessageList();
            renderContactList();
            renderCharacterList();
            renderPersonaList();
                } else {
                    console.warn('Êï∞ÊçÆÊú™ÂÆåÂÖ®Âä†ËΩΩÔºåÊé®ËøüÁïåÈù¢Ê∏≤Êüì');
                    // Âª∂ËøüÈáçËØïÊ∏≤Êüì
                    setTimeout(() => {
                        renderMessageList();
                        renderContactList();
                        renderCharacterList();
                        renderPersonaList();
                    }, 500);
                }
            } catch (renderError) {
                console.error('ÁïåÈù¢Ê∏≤ÊüìÂ§±Ë¥•:', renderError);
                // Â∞ùËØïÈáçÊñ∞ÂàùÂßãÂåñÁ©∫Êï∞ÊçÆ
                if (!chatMessages) chatMessages = {};
                if (!contacts) contacts = [];
                if (!characters) characters = [];
                renderMessageList();
                renderContactList();
                renderCharacterList();
            }
            
            // ÂàùÂßãÂåñÊó∂ËÆæÁΩÆÊ≠£Á°ÆÁöÑÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ - Âª∂ËøüÊâßË°åÁ°Æ‰øùDOMÂä†ËΩΩÂÆåÊàê
            setTimeout(() => {
                switchChatTab('message-list');
                // Á°Æ‰øùappÊ†áÈ¢òÊúâchat-modeÁ±ªÂíåÊ≠£Á°ÆÂÜÖÂÆπ
                const appTitle = document.querySelector('#chat-screen .app-title');
                if (appTitle) {
                    appTitle.classList.add('chat-mode');
                    appTitle.textContent = 'üí¨';
                }
                
                // ÂàùÂßãÂåñUI‰∫ã‰ª∂‰∏ç‰æùËµñ‰∫écurrentChatCharacter
                initChatSettingsUIEvents();
                
                // Â¶ÇÊûúÂ∑≤ÁªèÊúâËÅäÂ§©ËßíËâ≤ÔºåÊâçÂàùÂßãÂåñËÆæÁΩÆÂíå‰∏ñÁïå‰π¶
                if (currentChatCharacter) {
                initializeChatSettings(); // ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢
                updateWorldbookMountDisplay(); // Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫
                } else {
                    // Â∫îÁî®ÂàùÂßãÂåñÂÆåÊàêÔºåÁ≠âÂæÖÈÄâÊã©ËÅäÂ§©ËßíËâ≤
                }
            }, 100);
            
            // Ê∏©Â∫¶ÊªëÂùóÊòæÁ§∫
            const temperatureSlider = document.getElementById('temperature-slider');
            if (temperatureSlider) {
                temperatureSlider.addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = parseFloat(this.value).toFixed(2);
            });
            }
            
            // ÂàùÂßãÂåñAPIËÆæÁΩÆÁïåÈù¢
            initializeApiSettings();
            
            // ÈÄèÊòéÂ∫¶ÊªëÂùóÊòæÁ§∫
            document.getElementById('opacity-slider').addEventListener('input', function() {
                document.getElementById('opacity-value').textContent = Math.round(this.value * 100) + '%';
            });
            
            // ÊåâEnterÈîÆÂèëÈÄÅÊ∂àÊÅØ
            document.getElementById('api-chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Èò≤Ê≠¢Êç¢Ë°å
                    sendApiMessage();
                }
            });

            // @Áæ§ÊàêÂëòÂäüËÉΩÁõ∏ÂÖ≥ÂèòÈáè
            let mentionDropdownVisible = false;
            let mentionStartPos = -1;
            let selectedMentionIndex = -1;
            let currentMentionQuery = '';

            // ÁõëÂê¨ËæìÂÖ•Ê°ÜÂÜÖÂÆπÂèòÂåñÔºåÂ§ÑÁêÜ@Áæ§ÊàêÂëòÂäüËÉΩ
            document.getElementById('api-chat-input').addEventListener('input', function(e) {
                handleMentionInput(e);
            });

            // ÁõëÂê¨ÈîÆÁõò‰∫ã‰ª∂ÔºåÂ§ÑÁêÜ@Áæ§ÊàêÂëòÈÄâÊã©
            document.getElementById('api-chat-input').addEventListener('keydown', function(e) {
                if (mentionDropdownVisible) {
                    handleMentionKeydown(e);
                }
            });

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÊó∂ÈöêËóè@Áæ§ÊàêÂëò‰∏ãÊãâÊ°Ü
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('mention-dropdown');
                const input = document.getElementById('api-chat-input');
                if (mentionDropdownVisible && !dropdown.contains(e.target) && e.target !== input) {
                    hideMentionDropdown();
                }
            });
            

            
            // ÂàùÂßãÂåñÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
            initializeAvatarUpload();
            
            // ÂàùÂßãÂåñË°®ÊÉÖÂåÖ‰∏ä‰º†ÂäüËÉΩ
            initializeEmojiUpload();
            
            // Á°Æ‰øùÂ∑•ÂÖ∑Èù¢ÊùøÂàùÂßãÈöêËóè
            const toolsPanel = document.getElementById('tools-panel');
            if (toolsPanel) {
                toolsPanel.style.display = 'none';
            }
            
            // ÂàùÂßãÂåñÊ∂àÊÅØÈÄâÊã©Ê®°ÂºèÁä∂ÊÄÅ
            isMessageSelectionMode = false;
            selectedMessages.clear();
            
            // ÂõæÁâá‰∏ä‰º†
            document.getElementById('image-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûãÔºåGIFÊ†ºÂºè‰∏çË¢´Gemini APIÊîØÊåÅ
                    if (file.type === 'image/gif') {
                        alert('Êä±Ê≠âÔºåGemini API ‰∏çÊîØÊåÅ GIF Ê†ºÂºèÁöÑÂõæÁâá„ÄÇ\n\nËØ∑ÈÄâÊã©ÂÖ∂‰ªñÊ†ºÂºèÁöÑÂõæÁâáÔºåÂ¶ÇÔºö\n‚Ä¢ JPEG\n‚Ä¢ PNG\n‚Ä¢ WEBP');
                        // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©Âô®
                        e.target.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        // üî•„Äê‰øÆÂ§ç„ÄëÁõ¥Êé•ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØÔºåÂ∞±ÂÉèÊ≠£Â∏∏ÁöÑÂõæÁâáÂèëÈÄÅ‰∏ÄÊ†∑
                        sendImageMessage(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
                
                // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©Âô®ÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
                e.target.value = '';
            });
            
            // Ëá™ÂÆö‰πâÂ£ÅÁ∫∏‰∏ä‰º†
            document.getElementById('custom-wallpaper-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        selectedWallpaper = event.target.result;
                        
                        // Êõ¥Êñ∞È¢ÑËßàÂÆπÂô®
                        const previewContainer = document.getElementById('wallpaper-preview-container');
                        if (previewContainer) {
                            previewContainer.innerHTML = `<img src="${selectedWallpaper}" class="wallpaper-preview-image" alt="Â£ÅÁ∫∏È¢ÑËßà">`;
                        }
                        
                        // ‰∏çÂú®ËøôÈáåÁ´ãÂç≥Â∫îÁî®Âà∞‰∏ªÁïåÈù¢ÔºåÁ≠âÁî®Êà∑ÁÇπÂáªÂ∫îÁî®Êó∂ÂÜçÂ∫îÁî®
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Ëá™ÂÆö‰πâÂõæÊ†á‰∏ä‰º†
            document.getElementById('custom-icon-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        customIconImage = event.target.result;
                        // Êõ¥Êñ∞È¢ÑËßà
                        const previews = document.querySelectorAll('.icon-preview');
                        previews.forEach(preview => {
                            preview.style.backgroundImage = `url(${customIconImage})`;
                            preview.innerHTML = ''; // ÁßªÈô§ÂõæÊ†á
                        });
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            setInterval(updateTime, 1000);
            initBatteryManager();
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂàùÂßãÂåñÂÖ®Â±ÄÂä®ÊÄÅÂèëÂ∏ÉÁ≥ªÁªü
            setTimeout(async () => {
                try {
                    await initGlobalMomentsSystem();
                    console.log('‚úÖ ÂÖ®Â±ÄÂä®ÊÄÅÂèëÂ∏ÉÁ≥ªÁªüÂàùÂßãÂåñÂÆåÊàê');
                } catch (error) {
                    console.error('‚ùå ÂÖ®Â±ÄÂä®ÊÄÅÂèëÂ∏ÉÁ≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•:', error);
                }
            }, 3000); // Âª∂Ëøü3ÁßíÁ°Æ‰øùÊï∞ÊçÆÂÆåÂÖ®Âä†ËΩΩ
            
            } catch (error) {
                console.error('Â∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊòØÊï∞ÊçÆÂ∫ìÈîôËØØÔºåÂ∞ùËØïÈáçÁΩÆ
                if (error.name === 'DataError' || error.name === 'InvalidStateError' || error.name === 'DexieError') {
                    console.log('Ê£ÄÊµãÂà∞Êï∞ÊçÆÂ∫ìÈîôËØØÔºåÂ∞ùËØïÈáçÁΩÆÊï∞ÊçÆÂ∫ì...');
                    if (confirm('Â∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•ÔºåÊòØÂê¶ÈáçÁΩÆÊï∞ÊçÆÂ∫ìÔºü\nÊ≥®ÊÑèÔºöËøôÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆ„ÄÇ')) {
                        await resetDatabase();
                    }
                } else {
                    alert('Â∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï„ÄÇ');
                }
            }
        });
        
        // ÊòæÁ§∫/ÈöêËóèÂ∫îÁî®
        function showApp(appId) {
            if (event) event.preventDefault();
            
            // ÈöêËóèÊâÄÊúâappÁïåÈù¢
            const allApps = document.querySelectorAll('.app-screen');
            allApps.forEach(app => {
                app.style.display = 'none';
            });
            
            // ÈöêËóè‰∏ªÂ±èÂπïÁªÑ‰ª∂
            const clockContainer = document.getElementById('clock-container');
            const appGrid = document.getElementById('app-grid');
            if (clockContainer) clockContainer.style.display = 'none';
            if (appGrid) appGrid.style.display = 'none';
            
            // ÊòæÁ§∫ÁõÆÊ†áÁïåÈù¢
            document.getElementById(appId).style.display = 'flex';
            
            // Â¶ÇÊûúÊòØËÅäÂ§©ÁïåÈù¢ÔºåÂà∑Êñ∞Ê∂àÊÅØÂàóË°®
            if (appId === 'chat-screen') {
                renderMessageList();
            }
            
            // Â¶ÇÊûúÊòØAPIËÆæÁΩÆÁïåÈù¢ÔºåÂàùÂßãÂåñËÆæÁΩÆ
            if (appId === 'api-settings-screen') {
                // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥Á°Æ‰øùDOMÂ∑≤Ê∏≤Êüì
                setTimeout(() => {
                    initializeApiSettings();
                }, 100);
            }
        }
        

        
        // ÈöêËóèËßíËâ≤ÂàõÂª∫Ë°®ÂçïÔºåËøîÂõûÂà∞chatÁïåÈù¢ÁöÑÈÄöËÆØÂΩï
        function hideCharacterForm() {
            // Âú®ÈöêËóèË°®ÂçïÊó∂Ê∏ÖÁ©∫Ë°®ÂçïÊï∞ÊçÆ
            clearCharacterForm();
            
            hideApp('character-form-screen');
            showApp('chat-screen');
            switchChatTab('contact-list');
            // ÊâãÂä®Ëß¶ÂèëÊ†áÁ≠æÂàáÊç¢ÁöÑÊ†∑Âºè
            const chatTabs = document.querySelectorAll('.chat-tab');
            chatTabs.forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });
            // ÂÆâÂÖ®Âú∞Ê∑ªÂä†activeÁ±ªÂà∞Á¨¨‰∫å‰∏™Ê†áÁ≠æÔºàÈÄöËÆØÂΩïÔºâ
            if (chatTabs.length > 1 && chatTabs[1] && chatTabs[1].classList) {
                chatTabs[1].classList.add('active');
            }
        }
        
        function hideApp(appId) {
            document.getElementById(appId).style.display = 'none';
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÂ∫îÁî®ÈÉΩÂ∑≤ÈöêËóèÔºåÂ¶ÇÊûúÊòØÔºåÊòæÁ§∫‰∏ªÂ±èÂπïÁªÑ‰ª∂
            const allApps = document.querySelectorAll('.app-screen');
            const hasVisibleApp = Array.from(allApps).some(app => 
                app.style.display === 'flex' || app.style.display === 'block'
            );
            
            if (!hasVisibleApp) {
                // ÊòæÁ§∫‰∏ªÂ±èÂπïÁªÑ‰ª∂
                const clockContainer = document.getElementById('clock-container');
                const appGrid = document.getElementById('app-grid');
                if (clockContainer) clockContainer.style.display = 'block';
                if (appGrid) appGrid.style.display = 'flex';
            }
        }
        
        // ÊòæÁ§∫/ÈöêËóèÊ®°ÊÄÅÊ°Ü
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            
            // Â¶ÇÊûúÊòØÊ∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°ÜÔºåÊ∏≤ÊüìÂèØÈÄâËÅîÁ≥ª‰∫∫
            if (modalId === 'add-contact-modal') {
                renderContactModal();
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // ÂàáÊç¢ÁÖßÁâáÊñáÂ≠óÊòæÁ§∫
        function togglePhotoText(container, description) {
            const overlay = container.querySelector('.photo-text-overlay');
            const sparkles = container.querySelector('.sparkle-container');
            const badge = container.querySelector('.photo-badge');
            
            if (overlay.style.display === 'none') {
                // ÊòæÁ§∫ÊñáÂ≠óÔºåÈöêËóèÊòüÊòüÂíåÊ†áÂøó
                overlay.style.display = 'flex';
                sparkles.style.opacity = '0';
                badge.style.opacity = '0.3';
            } else {
                // ÈöêËóèÊñáÂ≠óÔºåÊòæÁ§∫ÊòüÊòüÂíåÊ†áÂøó
                overlay.style.display = 'none';
                sparkles.style.opacity = '1';
                badge.style.opacity = '1';
            }
        }

        // ÊòæÁ§∫Áî®Êà∑ÁÖßÁâáÊèèËø∞
        function showUserPhotoDescription(description) {
            const modalHtml = `
                <div id="photo-description-modal" class="modal" style="display: flex; z-index: 10000; background: rgba(0, 0, 0, 0.8);">
                    <div class="magical-photo-modal">
                        <div class="photo-modal-bg"></div>
                        <div class="photo-modal-content">
                            <div class="photo-modal-header">
                                <i class="fas fa-camera photo-modal-icon"></i>
                                <div class="photo-modal-title">ÁÖßÁâáÂÜÖÂÆπ</div>
                            </div>
                            <div class="photo-modal-body">
                                <div class="photo-description-text">${description}</div>
                            </div>
                            <div class="photo-modal-footer">
                                <button class="photo-modal-btn" id="photo-description-close">Á°ÆÂÆö</button>
                            </div>
                        </div>
                        <div class="modal-sparkles">
                            <div class="modal-sparkle modal-sparkle-1">‚ú®</div>
                            <div class="modal-sparkle modal-sparkle-2">‚≠ê</div>
                            <div class="modal-sparkle modal-sparkle-3">‚ú®</div>
                            <div class="modal-sparkle modal-sparkle-4">‚≠ê</div>
                            <div class="modal-sparkle modal-sparkle-5">üí´</div>
                            <div class="modal-sparkle modal-sparkle-6">‚ú®</div>
                            <div class="modal-sparkle modal-sparkle-7">‚≠ê</div>
                            <div class="modal-sparkle modal-sparkle-8">üí´</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = document.getElementById('photo-description-modal');
            const closeBtn = document.getElementById('photo-description-close');
            
            // ÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
            closeBtn.onclick = () => {
                modal.remove();
            };
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // Ëá™ÂÆö‰πâËæìÂÖ•ÊèêÁ§∫Ê°Ü
        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text') {
            return new Promise(resolve => {
                // ÂàõÂª∫Ê®°ÊÄÅÊ°ÜHTML
                const modalHtml = `
                    <div id="custom-prompt-modal" class="modal" style="display: flex; z-index: 10000;">
                        <div class="modal-content" style="max-width: 400px;">
                            <div class="modal-header">
                                <div class="modal-title">${title}</div>
                            </div>
                            <div class="modal-body">
                                <input type="${type}" id="custom-prompt-input" class="form-input" 
                                       placeholder="${placeholder}" value="${initialValue}"
                                       style="width: 100%; margin-top: 10px;">
                            </div>
                            <div class="modal-footer">
                                <button class="modal-button modal-secondary" id="custom-prompt-cancel">ÂèñÊ∂à</button>
                                <button class="modal-button modal-primary" id="custom-prompt-confirm">Á°ÆÂÆö</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = document.getElementById('custom-prompt-modal');
                const input = document.getElementById('custom-prompt-input');
                const confirmBtn = document.getElementById('custom-prompt-confirm');
                const cancelBtn = document.getElementById('custom-prompt-cancel');
                
                // Á°ÆÂÆöÊåâÈíÆ‰∫ã‰ª∂
                confirmBtn.onclick = () => {
                    const value = input.value;
                    modal.remove();
                    resolve(value);
                };
                
                // ÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂
                cancelBtn.onclick = () => {
                    modal.remove();
                    resolve(null);
                };
                
                // ÂõûËΩ¶ÈîÆÁ°ÆËÆ§
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    }
                };
                
                // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
                setTimeout(() => input.focus(), 100);
            });
        }
        
        // ÂàáÊç¢ËÅäÂ§©Ê†áÁ≠æ
        function switchChatTab(tabId) {
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑactiveÁ±ª
            document.querySelectorAll('.chat-tab').forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });
            
            // Ê∑ªÂä†ÂΩìÂâçÊ†áÁ≠æÁöÑactiveÁ±ª
            if (event && event.currentTarget && event.currentTarget.classList) {
                event.currentTarget.classList.add('active');
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâeventÂØπË±°ÔºåÊ†πÊçÆtabIdËÆæÁΩÆactive
                if (tabId === 'message-list') {
                    const messageTab = document.getElementById('message-tab');
                    if (messageTab && messageTab.classList) {
                        messageTab.classList.add('active');
                    }
                } else if (tabId === 'contact-list') {
                    const tabs = document.querySelectorAll('.chat-tab');
                    if (tabs.length > 1 && tabs[1] && tabs[1].classList) {
                        tabs[1].classList.add('active');
                    }
                } else if (tabId === 'moments-page') {
                    const tabs = document.querySelectorAll('.chat-tab');
                    if (tabs.length > 2 && tabs[2] && tabs[2].classList) {
                        tabs[2].classList.add('active');
                    }
                } else if (tabId === 'profile-page') {
                    const tabs = document.querySelectorAll('.chat-tab');
                    if (tabs.length > 3 && tabs[3] && tabs[3].classList) {
                        tabs[3].classList.add('active');
                    }
                }
            }
            
            // ÈöêËóèÊâÄÊúâÂÜÖÂÆπ
            const messageListEl = document.getElementById('message-list');
            const contactListEl = document.getElementById('contact-list');
            const profilePageEl = document.getElementById('profile-page');
            const momentsPageEl = document.getElementById('moments-page');
            const targetEl = document.getElementById(tabId);
            
            if (messageListEl) messageListEl.style.display = 'none';
            if (contactListEl) contactListEl.style.display = 'none';
            if (profilePageEl) profilePageEl.style.display = 'none';
            if (momentsPageEl) momentsPageEl.style.display = 'none';
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÂÜÖÂÆπ
            if (targetEl) targetEl.style.display = 'block';
            
            // ÊéßÂà∂appÊ†áÈ¢òÁöÑÊ∏êÂèòÊïàÊûúÂíåÂÜÖÂÆπ
            const appTitle = document.querySelector('#chat-screen .app-title');
            if (appTitle) {
                if (tabId === 'message-list') {
                    appTitle.classList.add('chat-mode');
                    appTitle.textContent = 'üí¨';
                } else if (tabId === 'contact-list') {
                    appTitle.classList.remove('chat-mode');
                    appTitle.textContent = 'ËßíËâ≤';
                } else if (tabId === 'moments-page') {
                    appTitle.classList.remove('chat-mode');
                                            appTitle.textContent = 'Âä®ÊÄÅ';
                    // üî•„ÄêÊñ∞Â¢û„ÄëÂàáÊç¢Âà∞Âä®ÊÄÅÈ°µÈù¢Êó∂Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
                    loadMomentsImages();
                } else if (tabId === 'profile-page') {
                    appTitle.classList.remove('chat-mode');
                    appTitle.textContent = 'Êàë';
                }
            }
            
            // ÊéßÂà∂ÊåâÈíÆÊòæÁ§∫
            const addContactBtn = document.getElementById('add-contact-btn');
            const addChatBtn = document.getElementById('add-chat-btn');
            const groupManageBtn = document.getElementById('group-manage-btn');
            
            if (addContactBtn && addChatBtn && groupManageBtn) {
                if (tabId === 'contact-list') {
                    addContactBtn.style.display = 'flex';
                    addChatBtn.style.display = 'none';
                    groupManageBtn.style.display = isGroupManageMode ? 'none' : 'flex';
                    // ‰øÆÊîπÂä†Âè∑ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂‰∏∫ÂàõÂª∫ËßíËâ≤
                    addContactBtn.onclick = () => showCharacterForm();
                } else if (tabId === 'message-list') {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'flex';
                    groupManageBtn.style.display = 'none';
                } else if (tabId === 'moments-page') {
                                            // Âä®ÊÄÅÈ°µÈù¢ÊòæÁ§∫ÂèëÂ∏ÉÊåâÈíÆ
                    addContactBtn.style.display = 'flex';
                    addChatBtn.style.display = 'none';
                    groupManageBtn.style.display = 'none';
                    // ‰øÆÊîπÂä†Âè∑ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂‰∏∫ÂèëÂ∏ÉÂä®ÊÄÅ
                    addContactBtn.onclick = () => showPublishMoment();
                } else {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'none';
                    groupManageBtn.style.display = 'none';
                }
            }
            
            // Â¶ÇÊûúÊòØÂä®ÊÄÅÈ°µÈù¢ÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂä†ËΩΩÂä®ÊÄÅÂÜÖÂÆπ
            if (tabId === 'moments-page') {
                // Âè™Âú®Âä®ÊÄÅÂàóË°®‰∏∫Á©∫Êó∂Âä†ËΩΩÔºåÈÅøÂÖçÈáçÂ§çÊòæÁ§∫
                const momentsList = document.getElementById('moments-list');
                if (momentsList && momentsList.children.length === 0) {
                loadMoments();
                }
                                        // ÁßªÈô§Âä®ÊÄÅÈ°µÈù¢ÁöÑpaddingÔºåÂÆûÁé∞ÂÖ®Â±èÊïàÊûú
                const chatContent = document.getElementById('chat-content');
                if (chatContent) {
                    chatContent.style.padding = '0';
                }
            } else {
                // ÂÖ∂‰ªñÈ°µÈù¢ÊÅ¢Â§çÊ≠£Â∏∏padding
                const chatContent = document.getElementById('chat-content');
                if (chatContent) {
                    chatContent.style.padding = '15px';
                }
                
                // ÂÅúÊ≠¢Êó∂Èó¥Êõ¥Êñ∞Âô®ÔºàËäÇÁúÅËµÑÊ∫êÔºâ
                stopTimeUpdater();
            }
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            // Êõ¥Êñ∞Áä∂ÊÄÅÊ†èÊó∂Èó¥
            const statusTime = document.getElementById('status-bar-time');
            if (statusTime) {
                statusTime.textContent = timeString;
            }
            
            // Êõ¥Êñ∞Â∫îÁî®ÂÜÖÁä∂ÊÄÅÊ†èÊó∂Èó¥
            const appStatusTimes = document.querySelectorAll('.app-status-time');
            appStatusTimes.forEach(element => {
                element.textContent = timeString;
            });
            
            // Êõ¥Êñ∞‰∏ªÊó∂Èíü
            const mainTime = document.getElementById('main-time');
            if (mainTime) {
                mainTime.textContent = timeString;
            }
            
            // Êõ¥Êñ∞Êó•Êúü
            const mainDate = document.getElementById('main-date');
            if (mainDate) {
                const date = now.toLocaleDateString('zh-CN', { 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                });
                mainDate.textContent = date;
            }
        }
        
        // Âä†ËΩΩËßíËâ≤ÂàÜÁªÑÊï∞ÊçÆ
        async function loadCharacterGroups() {
            try {
                const savedGroups = await db.characterGroups.orderBy('order').toArray();
                
                if (savedGroups.length === 0) {
                    // Â¶ÇÊûúÊ≤°ÊúâÂàÜÁªÑÔºåÂàõÂª∫ÈªòËÆ§ÂàÜÁªÑ
                    const defaultGroups = [
                        { id: 'my_friends', name: 'ÊàëÁöÑÂ•ΩÂèã', order: 999, isDefault: true, canInteract: false },
                        { id: 'special_care', name: 'ÁâπÂà´ÂÖ≥ÂøÉ', order: 1, isDefault: false, canInteract: true },
                        { id: 'close_friends', name: '‰∫≤ÂØÜÊúãÂèã', order: 2, isDefault: false, canInteract: true },
                        { id: 'family', name: 'ÂÆ∂‰∫∫', order: 3, isDefault: false, canInteract: true },
                        { id: 'classmates', name: 'ÂêåÂ≠¶', order: 4, isDefault: false, canInteract: true },
                        { id: 'colleagues', name: 'Âêå‰∫ã', order: 5, isDefault: false, canInteract: true }
                    ];
                    
                    await db.characterGroups.bulkAdd(defaultGroups);
                    characterGroups = defaultGroups;
                } else {
                    characterGroups = savedGroups;
                }
            } catch (error) {
                console.error('Âä†ËΩΩËßíËâ≤ÂàÜÁªÑÂ§±Ë¥•:', error);
                // ÂàõÂª∫Âü∫Êú¨ÁöÑÈªòËÆ§ÂàÜÁªÑ
                characterGroups = [
                    { id: 'my_friends', name: 'ÊàëÁöÑÂ•ΩÂèã', order: 999, isDefault: true, canInteract: false }
                ];
            }
        }

        // ‰øùÂ≠òËßíËâ≤ÂàÜÁªÑÊï∞ÊçÆ
        async function saveCharacterGroups() {
            try {
                await db.characterGroups.clear();
                await db.characterGroups.bulkAdd(characterGroups);
            } catch (error) {
                console.error('‰øùÂ≠òËßíËâ≤ÂàÜÁªÑÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩËßíËâ≤Êï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadCharacters() {
            try {
                // ÂÖàÊ£ÄÊü•IndexedDB‰∏≠ÊòØÂê¶ÊúâÊï∞ÊçÆ
                const savedCharacters = await db.characters.toArray();
                
                if (savedCharacters.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('characters');
                    if (localStorageData) {
                        const localCharacters = JSON.parse(localStorageData);
                        
                        if (localCharacters.length > 0) {
                            // ‰∏∫ÊóßËßíËâ≤Êï∞ÊçÆÊ∑ªÂä†ÈªòËÆ§ÂàÜÁªÑ
                            localCharacters.forEach(character => {
                                if (!character.groupId) {
                                    character.groupId = 'my_friends'; // ÈªòËÆ§ÂàÜÁªÑ
                                }
                            });
                            
                            // ËøÅÁßªÊï∞ÊçÆÂà∞IndexedDB
                            await db.characters.bulkAdd(localCharacters);
                            characters = localCharacters;
                            // ÂèØÈÄâÔºöÊ∏ÖÈô§localStorage‰∏≠ÁöÑÊóßÊï∞ÊçÆ
                            // localStorage.removeItem('characters');
                        } else {
                            characters = [];
                        }
                    } else {
                        characters = [];
                    }
                } else {
                    // Á°Æ‰øùÊâÄÊúâËßíËâ≤ÈÉΩÊúâÂàÜÁªÑID
                    savedCharacters.forEach(character => {
                        if (!character.groupId) {
                            character.groupId = 'my_friends';
                        }
                    });
                    characters = savedCharacters;
                }
            } catch (error) {
                console.error('Âä†ËΩΩËßíËâ≤Êï∞ÊçÆÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªélocalStorageÂä†ËΩΩ
                const localStorageData = localStorage.getItem('characters');
                if (localStorageData) {
                    characters = JSON.parse(localStorageData);
                    // ‰∏∫ËßíËâ≤Ê∑ªÂä†ÈªòËÆ§ÂàÜÁªÑ
                    characters.forEach(character => {
                        if (!character.groupId) {
                            character.groupId = 'my_friends';
                        }
                    });

                } else {
                    characters = [];
                }
            }
        }
        
        // ‰øùÂ≠òËßíËâ≤Êï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function saveCharacters() {
            try {

                
                // Ê£ÄÊü•ÈáçÂ§çID
                const uniqueIds = new Set();
                const uniqueCharacters = [];
                
                for (const character of characters) {
                    if (!character.id) {
                        console.warn('ÂèëÁé∞Ê≤°ÊúâIDÁöÑËßíËâ≤ÔºåË∑≥Ëøá‰øùÂ≠ò:', character);
                        continue;
                    }
                    
                    if (!uniqueIds.has(character.id)) {
                        uniqueIds.add(character.id);
                        uniqueCharacters.push(character);
                    } else {
                        console.warn(`ÂèëÁé∞ÈáçÂ§çIDÁöÑËßíËâ≤ (${character.id})ÔºåË∑≥ËøáÈáçÂ§çÈ°π:`, character);
                    }
                }
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
                await db.characters.clear();
                
                // ÊâπÈáèÊèíÂÖ•Êñ∞Êï∞ÊçÆ - ‰ΩøÁî®bulkPutËÄå‰∏çÊòØbulkAddÊù•ÈÅøÂÖçÈîÆÂÜ≤Á™Å
                if (uniqueCharacters.length > 0) {
                    await db.characters.bulkPut(uniqueCharacters);
                }
                

            } catch (error) {
                console.error('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ:', error);
                alert('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ: ' + error.message);
                throw error;
            }
        }
        
        // ÊòæÁ§∫Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ
        function showStorageUsage() {
            const usage = [];
            
            // ËÆ°ÁÆóÂêÑÁßçÊï∞ÊçÆÁöÑÂ§ßÂ∞è
            const characters = localStorage.getItem('characters') || '[]';
            const chatMessages = localStorage.getItem('chatMessages') || '{}';
            const customEmojis = localStorage.getItem('customEmojis') || '[]';
            
            usage.push(`ËßíËâ≤Êï∞ÊçÆ: ${(characters.length / 1024).toFixed(1)} KB`);
            usage.push(`ËÅäÂ§©ËÆ∞ÂΩï: ${(chatMessages.length / 1024).toFixed(1)} KB`);
            usage.push(`Ë°®ÊÉÖÂåÖ: ${(customEmojis.length / 1024).toFixed(1)} KB`);
            
            const total = characters.length + chatMessages.length + customEmojis.length;
            usage.push(`ÊÄªËÆ°: ${(total / 1024).toFixed(1)} KB`);
            

            alert('Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ:\n' + usage.join('\n'));
        }
        
        // Âä†ËΩΩËÅîÁ≥ª‰∫∫Êï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadContacts() {
            try {
                const savedContacts = await db.contacts.toArray();
        // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöËøáÊª§ÊéâÊâÄÊúâÊó†ÊïàÁöÑËÅîÁ≥ª‰∫∫Êï∞ÊçÆÔºåÁ°Æ‰øùÂàóË°®Âπ≤ÂáÄ
        contacts = savedContacts
            .map(contact => contact.characterId) // ÊèêÂèñID
            .filter(id => id !== undefined && id !== null); // Âè™‰øùÁïôÊúâÊïàÁöÑID

        // Ëá™Âä®Ê∏ÖÁêÜÈáçÂ§çÁöÑËÅîÁ≥ª‰∫∫IDÔºåÂ¢ûÂº∫Êï∞ÊçÆÂ∫ìÁ®≥ÂÆöÊÄß
        const uniqueContacts = [...new Set(contacts)];
        if (uniqueContacts.length < contacts.length) {
            console.warn('ÂèëÁé∞‰∫ÜÈáçÂ§çÁöÑËÅîÁ≥ª‰∫∫IDÔºåÂ∑≤Ëá™Âä®Ê∏ÖÁêÜ„ÄÇ');
            contacts = uniqueContacts;
            // Ê∏ÖÁêÜÂêéÔºåÁ´ãÂç≥Áî®Âπ≤ÂáÄÁöÑÊï∞ÊçÆË¶ÜÁõñÊï∞ÊçÆÂ∫ì
            await saveContacts();
        }


            } catch (error) {
                console.error('Âä†ËΩΩËÅîÁ≥ª‰∫∫Â§±Ë¥•:', error);
        contacts = []; // Â¶ÇÊûúÂá∫ÈîôÔºåÁ°Æ‰øùËÅîÁ≥ª‰∫∫ÂàóË°®‰∏∫Á©∫ÔºåÈò≤Ê≠¢Á®ãÂ∫èÂ¥©Ê∫É
            }
        }
        
        // ‰øùÂ≠òËÅîÁ≥ª‰∫∫Êï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function saveContacts() {
            try {
        // ËøáÊª§Êéâ‰ªª‰ΩïÂèØËÉΩÂ≠òÂú®ÁöÑÊó†ÊïàID
        const validContacts = contacts.filter(id => id); 
        // Â∞ÜËÅîÁ≥ª‰∫∫IDÂàóË°®ËΩ¨Êç¢‰∏∫Êï∞ÊçÆÂ∫ìÈúÄË¶ÅÁöÑÂØπË±°Êï∞ÁªÑÊ†ºÂºè
        const contactArray = validContacts.map(id => ({ characterId: id }));

        await db.transaction('rw', db.contacts, async () => {
            // ÂÖàÊ∏ÖÁ©∫ÊóßË°®ÔºåÂÜçÊâπÈáèÂÜôÂÖ•Êñ∞Êï∞ÊçÆ
                await db.contacts.clear();
                if (contactArray.length > 0) {
                    await db.contacts.bulkAdd(contactArray);
                }
        });
            } catch (error) {
                console.error('‰øùÂ≠òËÅîÁ≥ª‰∫∫Â§±Ë¥•:', error);
            }
        }
        
        // Âä†ËΩΩËÅäÂ§©Ê∂àÊÅØ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadChatMessages() {
            try {
                const savedMessages = await db.chatMessages.toArray();
                chatMessages = {};
                
                if (savedMessages.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('chatMessages');
                    if (localStorageData) {

                        const localMessages = JSON.parse(localStorageData);
                        
                        // Â∞ÜÂØπË±°Ê†ºÂºèËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®Âà∞IndexedDB
                        const messageArray = [];
                        for (const [characterId, messages] of Object.entries(localMessages)) {
                            for (const message of messages) {
                                messageArray.push({
                                    id: `${characterId}_${message.id || message.timestamp}`,
                                    characterId: characterId,
                                    timestamp: message.timestamp,
                                    messageData: message
                                });
                            }
                        }
                        
                        if (messageArray.length > 0) {
                            await db.chatMessages.bulkAdd(messageArray);
                        }
                        
                        chatMessages = localMessages;

                    }
                } else {
                    // Â∞ÜÊï∞ÁªÑÊ†ºÂºèËΩ¨Êç¢ÂõûÂØπË±°Ê†ºÂºè
                    for (const msgRecord of savedMessages) {
                        const characterId = msgRecord.characterId;
                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        // üî•„ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•Ê∂àÊÅØÊï∞ÊçÆÊòØÂê¶ÊúâÊïàÔºåËøáÊª§Á©∫ÂÄº
                        if (msgRecord.messageData && typeof msgRecord.messageData === 'object') {
                        chatMessages[characterId].push(msgRecord.messageData);
                        }
                    }
                    
                    // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÂπ∂Ê∏ÖÁêÜÁ©∫ÂÄº
                    for (const characterId in chatMessages) {
                        // üî•„ÄêÊñ∞Â¢û„ÄëËøáÊª§Êéânull„ÄÅundefinedÊàñÊó†ÊïàÁöÑÊ∂àÊÅØ
                        chatMessages[characterId] = chatMessages[characterId]
                            .filter(msg => msg && typeof msg === 'object' && msg.timestamp)
                            .sort((a, b) => a.timestamp - b.timestamp);
                    }
                    

                }
            } catch (error) {
                console.error('Âä†ËΩΩËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªélocalStorageÂä†ËΩΩ
                const localStorageData = localStorage.getItem('chatMessages');
                if (localStorageData) {
                    chatMessages = JSON.parse(localStorageData);
                } else {
                    chatMessages = {};
                }
            }
        }
        
        // Èò≤Êäñ‰øùÂ≠òËÆ°Êó∂Âô®
        let saveMessagesTimer = null;
        let isSaving = false; // Èò≤Ê≠¢Âπ∂Âèë‰øùÂ≠ò
        
        // Èò≤ÊäñÁâàÊú¨ÁöÑ‰øùÂ≠òÂáΩÊï∞
        function saveChatMessages() {
            // Ê∏ÖÈô§‰πãÂâçÁöÑËÆ°Êó∂Âô®
            if (saveMessagesTimer) {
                clearTimeout(saveMessagesTimer);
            }
            
            // ËÆæÁΩÆÊñ∞ÁöÑËÆ°Êó∂Âô®Ôºå500msÂêéÊâßË°å‰øùÂ≠ò
            saveMessagesTimer = setTimeout(async () => {
                if (isSaving) {
                    return;
                }
                await saveChatMessagesImmediate();
            }, 500);
        }
        
        // Á´ãÂç≥‰øùÂ≠òËÅäÂ§©Ê∂àÊÅØ - ‰ΩøÁî®IndexedDB
        async function saveChatMessagesImmediate() {
            if (isSaving) {
                return;
            }
            
            isSaving = true;
            
            try {

                
                // Â∞ÜchatMessagesÂØπË±°ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®
                const messageArray = [];
                let globalSequentialId = 0; // ÂÖ®Â±ÄÈ°∫Â∫èIDÁ°Æ‰øùÂîØ‰∏ÄÊÄß
                const usedIds = new Set(); // Áî®‰∫éÊ£ÄÊµãIDÈáçÂ§ç
                
                for (const [characterId, messages] of Object.entries(chatMessages)) {
                    for (let i = 0; i < messages.length; i++) {
                        const message = messages[i];
                        
                        // ÁîüÊàêÂîØ‰∏ÄÁöÑ‰∏ªÈîÆ
                        let uniqueId = `${characterId}_${globalSequentialId++}`;
                        
                        // Á°Æ‰øùIDÁªùÂØπÂîØ‰∏Ä
                        while (usedIds.has(uniqueId)) {
                            uniqueId = `${characterId}_${globalSequentialId++}`;
                        }
                        usedIds.add(uniqueId);
                        
                        messageArray.push({
                            id: uniqueId,
                            characterId: characterId,
                            timestamp: message.timestamp,
                            messageOrder: i,
                            originalMessageId: message.id, // ‰øùÁïôÂéüÂßãÊ∂àÊÅØID‰Ωú‰∏∫Êï∞ÊçÆ
                            messageData: message
                        });
                    }
                }
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊ∂àÊÅØ
                await db.chatMessages.clear();
                
                // ÊâπÈáèÊèíÂÖ•Êñ∞Ê∂àÊÅØ
                if (messageArray.length > 0) {
                    await db.chatMessages.bulkAdd(messageArray);
                }
                

            } catch (error) {
                console.error('‰øùÂ≠òËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•:', error);
                
                // Â¶ÇÊûúÊâπÈáè‰øùÂ≠òÂ§±Ë¥•Ôºå‰ΩøÁî®ÁÆÄÂåñÁöÑÈáçËØïÊú∫Âà∂
                try {

                    await db.chatMessages.clear();
                    
                    // Âè™‰øùÂ≠òÊúÄËøëÁöÑ1000Êù°Ê∂àÊÅØÔºåÈÅøÂÖçËøáÂ§ßÁöÑÊï∞ÊçÆÈõÜ
                    const messageArray = [];
                    let globalSequentialId = 0;
                    let totalMessages = 0;
                    
                    // ÂÖàËÆ°ÁÆóÊÄªÊ∂àÊÅØÊï∞
                    for (const messages of Object.values(chatMessages)) {
                        totalMessages += messages.length;
                    }
                    
                    const maxMessages = 1000;
                    const skipCount = Math.max(0, totalMessages - maxMessages);
                    let currentSkip = 0;
                    
                    for (const [characterId, messages] of Object.entries(chatMessages)) {
                        for (let i = 0; i < messages.length; i++) {
                            if (currentSkip < skipCount) {
                                currentSkip++;
                                continue;
                            }
                            
                            const message = messages[i];
                            messageArray.push({
                                id: `${characterId}_${globalSequentialId++}`,
                                characterId: characterId,
                                timestamp: message.timestamp,
                                messageOrder: i,
                                originalMessageId: message.id,
                                messageData: message
                            });
                        }
                    }
                    
                    if (messageArray.length > 0) {
                        await db.chatMessages.bulkAdd(messageArray);
                    }
                    

                } catch (fallbackError) {
                    console.error('ÁÆÄÂåñ‰øùÂ≠ò‰πüÂ§±Ë¥•:', fallbackError);
                }
            } finally {
                isSaving = false;
            }
        }
        

        
        // Âä†ËΩΩËÅäÂ§©ËÆæÁΩÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadChatSettings() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedChatSettings = await db.chatSettings.toArray();
                
                if (savedChatSettings.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('chatSettings');
                    if (localStorageData) {

                        const localSettings = JSON.parse(localStorageData);
                        
                        // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®Âà∞IndexedDB
                        const settingsArray = Object.keys(localSettings).map(chatId => ({
                            id: chatId,
                            chatId: chatId,
                            settings: localSettings[chatId]
                        }));
                        
                        if (settingsArray.length > 0) {
                            await db.chatSettings.bulkAdd(settingsArray);
                            console.log('ËÅäÂ§©ËÆæÁΩÆÊï∞ÊçÆËøÅÁßªÂÆåÊàê:', settingsArray);
                        }
                        
                        chatSettings = localSettings;
                    } else {
                        chatSettings = {};
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    console.log('‰ªéIndexedDBÂä†ËΩΩËÅäÂ§©ËÆæÁΩÆÊï∞ÊçÆ:', savedChatSettings);
                    chatSettings = {};
                    savedChatSettings.forEach(item => {
                        chatSettings[item.chatId] = item.settings;
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('chatSettings');
                if (localStorageData) {
                    chatSettings = JSON.parse(localStorageData);
                    console.log('‰ªélocalStorageÂ§á‰ªΩÂä†ËΩΩËÅäÂ§©ËÆæÁΩÆ:', chatSettings);
                } else {
                    chatSettings = {};
                }
            }
        }
        
        // ‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆ - ‰ΩøÁî®IndexedDBÈÅøÂÖçlocalStorageÂÆπÈáèÈôêÂà∂
        async function saveChatSettings() {
            try {
                // Â∞ÜchatSettingsÂØπË±°ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®Âà∞IndexedDB
                const chatSettingsArray = Object.keys(chatSettings).map(chatId => ({
                    id: chatId,
                    chatId: chatId,
                    settings: chatSettings[chatId]
                }));
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆÂπ∂Â≠òÂÇ®Êñ∞Êï∞ÊçÆ
                await db.chatSettings.clear();
                if (chatSettingsArray.length > 0) {
                    await db.chatSettings.bulkAdd(chatSettingsArray);
                }
                
                console.log('ËÅäÂ§©ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞IndexedDB');
            } catch (error) {
                console.error('‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆÂà∞IndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage:', error);
                
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØïÂéãÁº©Êï∞ÊçÆÂêéÂ≠òÂÇ®Âà∞localStorage
                try {
                    // ÂàõÂª∫‰∏Ä‰∏™Á≤æÁÆÄÁâàÁöÑËÆæÁΩÆÔºåÁßªÈô§ÂèØËÉΩÂæàÂ§ßÁöÑÂõæÁâáÊï∞ÊçÆ
                    const compressedSettings = {};
                    Object.keys(chatSettings).forEach(chatId => {
                        compressedSettings[chatId] = { ...chatSettings[chatId] };
                        
                        // ‰∏çÂÜçËá™Âä®ÁßªÈô§Â§¥ÂÉèÔºåÂõ†‰∏∫IndexedDBÊúâË∂≥Â§üÁöÑÂ≠òÂÇ®Á©∫Èó¥
                        // Â¶ÇÊûúÁúüÁöÑÈúÄË¶ÅÂéãÁº©ÔºåÁî®Êà∑ÂèØ‰ª•ÊâãÂä®ÈÄâÊã©
                        console.log(`ËÅäÂ§©${chatId}ËÆæÁΩÆÂ§ßÂ∞è:`, JSON.stringify(compressedSettings[chatId]).length);
                    });
                    
                    localStorage.setItem('chatSettings', JSON.stringify(compressedSettings));
                    console.log('Â∑≤‰ΩøÁî®ÂéãÁº©ÁâàËÅäÂ§©ËÆæÁΩÆ‰øùÂ≠òÂà∞localStorage');
                } catch (localStorageError) {
                    console.error('localStorage‰πüÊó†Ê≥ï‰øùÂ≠òÔºåÂ≠òÂÇ®Á©∫Èó¥ÂèØËÉΩÂ∑≤Êª°:', localStorageError);
                    
                    // ÊòæÁ§∫Áî®Êà∑ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
                    alert('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºÅ\n\nÂèØËÉΩÁöÑËß£ÂÜ≥ÊñπÊ°àÔºö\n1. Ê∏ÖÁêÜÊµèËßàÂô®ÁºìÂ≠ò\n2. Âà†Èô§‰∏Ä‰∫õ‰∏çÂøÖË¶ÅÁöÑËÅäÂ§©ËÆ∞ÂΩï\n3. ÂáèÂ∞ë‰ΩøÁî®Â§ßÂ∞∫ÂØ∏ÁöÑÂ§¥ÂÉèÂõæÁâá\n\nÂΩìÂâçËÆæÁΩÆÂèØËÉΩÊó†Ê≥ï‰øùÂ≠ò„ÄÇ');
                    throw localStorageError;
                }
            }
        }
        
        // === ÂêéÂè∞‰∫íÂä®Á≥ªÁªü ===
        let backgroundTimers = {};

        // ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
        function initBackgroundInteractionSystem() {
            if (!currentChatCharacter) return;
            
            clearAllBackgroundTimers();
            
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.backgroundInteractionEnabled) return;
            
            const characterId = currentChatCharacter.id;
            
            // ËÆæÁΩÆ‰∏ªÂä®ËÅäÂ§©ÂÆöÊó∂Âô®
            if (chatSettings.backgroundChatEnabled) {
                const chatInterval = getBackgroundInterval(chatSettings.backgroundChatFrequency || 'low');
                backgroundTimers[characterId + '_chat'] = setInterval(() => {
                    triggerBackgroundChat(characterId);
                }, chatInterval);
                

            }
            
            // ËÆæÁΩÆ‰∏ªÂä®ÂèëÂä®ÊÄÅÂÆöÊó∂Âô®
            if (chatSettings.backgroundMomentsEnabled) {
                const momentsInterval = getBackgroundMomentsInterval(chatSettings.backgroundMomentsFrequency || 'low');
                backgroundTimers[characterId + '_moments'] = setInterval(() => {
                    triggerBackgroundMoments(characterId);
                }, momentsInterval);
                
                // ÁßªÈô§‰∫Ü‰∏ªÂä®ÂèëÂä®ÊÄÅÊó•Âøó
            }
        }

        // Ê∏ÖÈô§ÊâÄÊúâÂêéÂè∞ÂÆöÊó∂Âô®
        function clearAllBackgroundTimers() {
            Object.values(backgroundTimers).forEach(timer => {
                if (timer) clearInterval(timer);
            });
            backgroundTimers = {};
        }

        // ÂÖ®Â±ÄÂÆöÊó∂ÂèëÂ∏ÉÁ≥ªÁªü
        let globalMomentsTimers = {};
        let globalMomentsCheckInterval = null;

        // ÂàùÂßãÂåñÂÖ®Â±ÄÂä®ÊÄÅÂèëÂ∏ÉÁ≥ªÁªü
        async function initGlobalMomentsSystem() {
            console.log('üöÄ ÂàùÂßãÂåñÂÖ®Â±ÄÂä®ÊÄÅÂèëÂ∏ÉÁ≥ªÁªü');
            
            // Ê∏ÖÈô§Áé∞ÊúâÁöÑÂÆöÊó∂Âô®
            clearGlobalMomentsTimers();
            
            // ‰∏∫ÊâÄÊúâËßíËâ≤ËÆæÁΩÆÂêéÂè∞ÂèëÂ∏ÉÂÆöÊó∂Âô®
            let activeCount = 0;
            if (characters && characters.length > 0) {
                for (const character of characters) {
                    const chatSettings = await getChatSettings(character.id);
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫ÜÂêéÂè∞ÂèëÂä®ÊÄÅ
                    if (chatSettings.backgroundMomentsEnabled) {
                        const frequency = chatSettings.backgroundMomentsFrequency || 'low';
                        const interval = getBackgroundMomentsInterval(frequency);
                        
                        globalMomentsTimers[character.id] = setInterval(async () => {
                            console.log(`‚è∞ ÂÆöÊó∂Âô®Ëß¶ÂèëÔºö${character.name} ÂáÜÂ§áÂèëÂ∏ÉÂä®ÊÄÅ`);
                            await triggerBackgroundMoments(character.id);
                        }, interval);
                        
                        activeCount++;
                        console.log(`‚úÖ ‰∏∫ËßíËâ≤ ${character.name} ËÆæÁΩÆ‰∫ÜÂêéÂè∞ÂèëÂä®ÊÄÅÂÆöÊó∂Âô®ÔºåÈó¥Èöî: ${Math.round(interval/1000/60)}ÂàÜÈíü`);
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
                    if (chatSettings.scheduledMomentsEnabled && chatSettings.scheduledMomentsTimes && chatSettings.scheduledMomentsTimes.length > 0) {
                        console.log(`‚è∞ ËßíËâ≤ ${character.name} ÂêØÁî®‰∫ÜÂÆöÊó∂ÂèëÂ∏ÉÔºåÊó∂Èó¥ÁÇπ:`, chatSettings.scheduledMomentsTimes);
                    }
                }
            }
            
            // ÂêØÂä®ÂÆöÊó∂Ê£ÄÊü•Âô®ÔºàÊØèÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°ÊòØÂê¶Âà∞‰∫ÜÂèëÂ∏ÉÊó∂Èó¥Ôºâ
            if (!globalMomentsCheckInterval) {
                globalMomentsCheckInterval = setInterval(async () => {
                    await checkScheduledMomentsTime();
                }, 60000); // ÊØèÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°
                
                console.log('‚è∞ ÂêØÂä®‰∫ÜÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥Ê£ÄÊü•Âô®');
            }
            
            console.log(`üéâ ÂÖ®Â±ÄÂä®ÊÄÅÂèëÂ∏ÉÁ≥ªÁªüÂàùÂßãÂåñÂÆåÊàêÔºåÊøÄÊ¥ª‰∫Ü ${activeCount} ‰∏™ËßíËâ≤ÁöÑÂêéÂè∞ÂèëÂ∏É`);
        }

        // Ê£ÄÊü•ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥
        async function checkScheduledMomentsTime() {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            if (characters && characters.length > 0) {
                for (const character of characters) {
                    const chatSettings = await getChatSettings(character.id);
                    
                    if (chatSettings.scheduledMomentsEnabled && 
                        chatSettings.scheduledMomentsTimes && 
                        chatSettings.scheduledMomentsTimes.includes(currentTime)) {
                        
                        console.log(`‚è∞ ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥Âà∞Ôºö${character.name} Âú® ${currentTime} ÂèëÂ∏ÉÂä®ÊÄÅ`);
                        await triggerBackgroundMoments(character.id, true); // Ë∑≥ËøáÂÜ∑Âç¥Êó∂Èó¥
                    }
                }
            }
        }

        // Ê∏ÖÈô§ÂÖ®Â±ÄÂä®ÊÄÅÂÆöÊó∂Âô®
        function clearGlobalMomentsTimers() {
            Object.values(globalMomentsTimers).forEach(timer => {
                if (timer) clearInterval(timer);
            });
            globalMomentsTimers = {};
            
            if (globalMomentsCheckInterval) {
                clearInterval(globalMomentsCheckInterval);
                globalMomentsCheckInterval = null;
            }
        }

        // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñÂêéÂè∞ËÅäÂ§©Èó¥ÈöîÊó∂Èó¥ - ‰ΩøÁî®Âõ∫ÂÆöÈó¥ÈöîËÄå‰∏çÊòØÈöèÊú∫Èó¥Èöî
        function getBackgroundInterval(frequency) {
            switch (frequency) {
                case 'low':
                    return 2 * 60 * 60 * 1000; // 2Â∞èÊó∂
                case 'medium':
                    return 60 * 60 * 1000; // 1Â∞èÊó∂
                case 'high':
                    return 30 * 60 * 1000; // 30ÂàÜÈíü
                default:
                    return 2 * 60 * 60 * 1000; // ÈªòËÆ§2Â∞èÊó∂
            }
        }

        // Ëé∑ÂèñÂêéÂè∞Âä®ÊÄÅÈó¥ÈöîÊó∂Èó¥
        function getBackgroundMomentsInterval(frequency) {
            switch (frequency) {
                case 'low':
                    return Math.random() * 4 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000; // 4-8Â∞èÊó∂
                case 'medium':
                    return Math.random() * 2 * 60 * 60 * 1000 + 2 * 60 * 60 * 1000; // 2-4Â∞èÊó∂
                case 'high':
                    return Math.random() * 60 * 60 * 1000 + 60 * 60 * 1000; // 1-2Â∞èÊó∂
                default:
                    return Math.random() * 4 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000; // ÈªòËÆ§4-8Â∞èÊó∂
            }
        }

        // Ëß¶ÂèëÂêéÂè∞ËÅäÂ§©
        async function triggerBackgroundChat(characterId) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;
                
                // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Ëá≥Â∞ë10ÂàÜÈíüÊ≤°ÊúâÂõûÂ§ç
                const messages = chatMessages[characterId] || [];
                const lastUserMessage = messages.slice().reverse().find(msg => msg.sender === 'user');
                
                if (lastUserMessage) {
                    const timeSinceLastUserMessage = Date.now() - lastUserMessage.timestamp;
                    const tenMinutes = 10 * 60 * 1000; // 10ÂàÜÈíü
                    if (timeSinceLastUserMessage < tenMinutes) {
                        console.log(`${character.name} Ë∑≥Ëøá‰∏ªÂä®ËÅäÂ§©ÔºöÁî®Êà∑ÊúÄËøë${Math.round(timeSinceLastUserMessage / 60000)}ÂàÜÈíüÂâçÊúâÂõûÂ§ç`);
                        return; // Áî®Êà∑ÊúÄËøëÊúâÊ¥ªÂä®Ôºå‰∏çÂèëÈÄÅËá™Âä®Ê∂àÊÅØ
                    }
                }
                
                // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñËØ•ËßíËâ≤ÁöÑËÅäÂ§©ËÆæÁΩÆÔºåËÄå‰∏çÊòØÂΩìÂâçËÅäÂ§©ËÆæÁΩÆ
                const chatSettings = await getAsyncChatSettings(characterId);

                // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®Áî®Êà∑ËÆæÁΩÆÁöÑÂéÜÂè≤Ê∂àÊÅØËΩÆÊï∞ÂíåË∑®Á™óÂè£ËÆ∞ÂøÜÊï∞
                const historyCount = chatSettings.historyCount || 5;
                const crossWindowMemory = chatSettings.crossWindowMemory || 3;

                // Ëé∑ÂèñÊúÄËøëÁöÑËÅäÂ§©ÂéÜÂè≤Ôºà‰ΩøÁî®ÂéÜÂè≤Ê∂àÊÅØËΩÆÊï∞ËÆæÁΩÆÔºâ
                const recentMessages = messages.slice(-historyCount);

                // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñË∑®Á™óÂè£ËÆ∞ÂøÜÊï∞ÈáèÁöÑÊúÄËøëÂä®ÊÄÅÂÜÖÂÆπ
                const recentMoments = await getRecentMoments(crossWindowMemory);
                let momentsContext = '';
                if (recentMoments.length > 0) {
                    momentsContext = '\n\nÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºö\n' +
                        recentMoments.map(moment => `${moment.nickname}: ${moment.text}`).join('\n');
                }
                
                // ÊûÑÂª∫ËÅäÂ§©ÂéÜÂè≤‰∏ä‰∏ãÊñá
                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºö\n' + 
                        recentMessages.map(msg => {
                            if (msg.sender === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            if (msg.sender === 'ai') return `${character.name}Ôºö${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n');
                }
                
                // üî•„Äê‰øÆÂ§ç„ÄëËé∑Âèñ‰∏ñÁïå‰π¶‰ø°ÊÅØ
                let worldbookContext = '';
                if (character.worldbook && character.worldbook.length > 0) {
                    worldbookContext = '\n\n‰∏ñÁïå‰π¶‰ø°ÊÅØÔºö\n' +
                        character.worldbook.map(entry => `${entry.key}: ${entry.value}`).join('\n');
                }

                // üî•„Äê‰øÆÂ§ç„ÄëÁîüÊàêÊõ¥ÂÆåÊï¥ÁöÑ‰∏ªÂä®ËÅäÂ§©ÂÜÖÂÆπÔºåÂåÖÂê´‰∫∫ËÆæ„ÄÅ‰∏ñÁïå‰π¶„ÄÅÂéÜÂè≤Ê∂àÊÅØ„ÄÅÂä®ÊÄÅÁ≠â
                const prompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${character.bio}${worldbookContext}

Áé∞Âú®‰Ω†Ë¶Å‰∏ªÂä®ÁªôÁî®Êà∑ÂèëÈÄÅ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇËøôÊù°Ê∂àÊÅØÂ∫îËØ•ÊòØÔºö
1. ‰∏•Ê†ºÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊÄßÊ†ºÁâπÁÇπ
2. Ëá™ÁÑ∂„ÄÅÊúâË∂£„ÄÅÊúâ‰∫íÂä®ÊÄß
3. ÂèØ‰ª•ÊòØÈóÆÂÄô„ÄÅÂàÜ‰∫´„ÄÅËØ¢ÈóÆ„ÄÅÂÖ≥ÂøÉÁ≠â
4. ‰∏çË¶ÅËøá‰∫éÊ≠£ÂºèÔºåË¶ÅÂÉèÊúãÂèãÈó¥ÁöÑÊó•Â∏∏ËÅäÂ§©
5. Â¶ÇÊûúÊúâËÅäÂ§©ÂéÜÂè≤ÔºåË¶ÅÂü∫‰∫éÂéÜÂè≤ÂÜÖÂÆπËøõË°åËá™ÁÑ∂ÁöÑÂª∂Áª≠ÊàñÂõûÂ∫î
6. ÂèØ‰ª•ÈÄÇÂΩìÊèêÂèäÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºåËÆ©ÂØπËØùÊõ¥Ëá™ÁÑ∂
7. ËÄÉËôëÂΩìÂâçÊó∂Èó¥ÂíåÊÉÖÂ¢ÉÔºåËÆ©Ê∂àÊÅØÊõ¥Ë¥¥ÂêàÂÆûÈôÖ
8. ‰øùÊåÅËßíËâ≤ÁöÑ‰∏ÄËá¥ÊÄßÂíåËøûË¥ØÊÄß${chatContext}${momentsContext}

ËØ∑ÁîüÊàê‰∏ÄÊù°‰∏ªÂä®ËÅäÂ§©ÁöÑÊ∂àÊÅØÔºö`;

                const content = await generateAIResponse(prompt, character);
                if (content && content.trim()) {
                    // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
                    const message = {
                        id: Date.now().toString(),
                        sender: 'ai',
                        content: content.trim(),
                        timestamp: Date.now()
                    };
                    
                    if (!chatMessages[characterId]) {
                        chatMessages[characterId] = [];
                    }
                    
                    chatMessages[characterId].push(message);
                    saveChatMessages();
                    
                    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ÂíåËøô‰∏™ËßíËâ≤ËÅäÂ§©ÔºåÁ´ãÂç≥ÊòæÁ§∫Ê∂àÊÅØ
                    if (currentChatCharacter && currentChatCharacter.id === characterId) {
                        renderChatMessages(characterId);
                    }
                    
                    // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                    renderMessageList();
                    
                    // ÁßªÈô§‰∫Ü‰∏ªÂä®ÂèëÈÄÅÊ∂àÊÅØÊó•Âøó
                }
            } catch (error) {
                console.error('ÂêéÂè∞ËÅäÂ§©Â§±Ë¥•:', error);
            }
        }

        // Ëß¶ÂèëÂêéÂè∞ÂèëÂä®ÊÄÅÔºàÊµãËØïÁâàÊú¨ÔºåË∑≥ËøáÂÜ∑Âç¥Êó∂Èó¥Ôºâ
        async function triggerBackgroundMomentsTest(characterId) {
            // ÁßªÈô§‰∫ÜÊµãËØïÂèëÂ∏ÉÊó•Âøó
            // Áõ¥Êé•Ë∞ÉÁî®Ê≠£Â∏∏ÂèëÂ∏ÉÂáΩÊï∞Ôºå‰ΩÜË∑≥ËøáÂÜ∑Âç¥Êó∂Èó¥Ê£ÄÊü•
            await triggerBackgroundMoments(characterId, true);
        }

        // Ëß¶ÂèëÂêéÂè∞ÂèëÂä®ÊÄÅ
        async function triggerBackgroundMoments(characterId, skipCooldown = false) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;
                
                // Ê£ÄÊü•ÂÜ∑Âç¥Êó∂Èó¥ÔºàÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÈáçÂ§çÂèëÂ∏ÉÔºâ
                if (!skipCooldown) {
                    const lastMomentTime = character.lastMomentTime || 0;
                    const cooldownTime = 30 * 60 * 1000; // 30ÂàÜÈíüÂÜ∑Âç¥Êó∂Èó¥
                    if (Date.now() - lastMomentTime < cooldownTime) {
                        // ÁßªÈô§‰∫ÜÂÜ∑Âç¥Êó∂Èó¥Êó•Âøó
                        return;
                    }
                } else {
                    // ÁßªÈô§‰∫ÜÊµãËØïÂèëÂ∏ÉÊó•Âøó
                }
                
                const chatSettings = getCurrentChatSettings();
                
                // Ëé∑ÂèñÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩï
                const messages = chatMessages[characterId] || [];
                const maxMemory = chatSettings.historyCount || 5;
                const recentMessages = messages.slice(-maxMemory);
                
                // Ëé∑ÂèñÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπ
                const recentMoments = await getRecentMoments(5);
                
                // ÊûÑÂª∫‰∏ä‰∏ãÊñá
                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºö\n' + 
                        recentMessages.map(msg => {
                            if (msg.sender === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            if (msg.sender === 'ai') return `${character.name}Ôºö${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n');
                }
                
                let momentsContext = '';
                if (recentMoments.length > 0) {
                    momentsContext = '\n\nÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºö\n' + 
                        recentMoments.map(moment => `${moment.nickname}: ${moment.text}`).join('\n');
                }
                
                // ÁîüÊàêÂä®ÊÄÅÂÜÖÂÆπ
                const prompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${character.bio}„ÄÇ

Áé∞Âú®‰Ω†Ë¶ÅÂèëÂ∏É‰∏ÄÊù°Âä®ÊÄÅ„ÄÇËøôÊù°Âä®ÊÄÅÂ∫îËØ•ÊòØÔºö
1. Á¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊÄßÊ†º
2. ÁîüÊ¥ªÂåñ„ÄÅÊúâË∂£„ÄÅÊúâ‰∏™ÊÄß
3. 50-200Â≠óÂ∑¶Âè≥
4. ÂèØ‰ª•ÊòØÂøÉÊÉÖ„ÄÅÊÑüÊÇü„ÄÅÊó•Â∏∏„ÄÅÂàÜ‰∫´Á≠â
5. ÂèØ‰ª•ÁªìÂêàÊúÄËøëÁöÑËÅäÂ§©ÊàñÂä®ÊÄÅÂÜÖÂÆπ‰Ωú‰∏∫ÁÅµÊÑü
6. Ë¶ÅÊúâ‰Ω†Áã¨ÁâπÁöÑÈ£éÊ†ºÔºå‰∏çËÉΩÂíåÂÖ∂‰ªñËßíËâ≤Ê∑∑Ê∑Ü
7. ÊîØÊåÅÊç¢Ë°åÊòæÁ§∫ÔºåÂèØ‰ª•ÈÄÇÂΩìÂàÜÊÆµËÆ©ÂÜÖÂÆπÊõ¥ÊòìËØª
8. ÂèØ‰ª•ÈÄâÊã©ÊÄßÂú∞ÈÖçÂõæÔºåÂ¶ÇÊûúÊÉ≥Ë¶ÅÈÖçÂõæÔºåËØ∑Áõ¥Êé•Êç¢Ë°åÔºåÁÑ∂ÂêéÁî®Êñú‰ΩìÊ†ºÂºèÂÜôÔºö*[ÈÖçÂõæÔºöËØ¶ÁªÜÁöÑÂõæÁâáÊèèËø∞]*

## ÈÖçÂõæËßÑÂàôÔºàÈÅµÂæ™ÔºâÔºö
- ‰∏çÈúÄË¶ÅÊØèÊù°Âä®ÊÄÅÈÉΩÈÖçÂõæÔºåÂè™ÊúâÂΩìÂÜÖÂÆπÁúüÁöÑÈÄÇÂêàÈÖçÂõæÊó∂ÊâçÊ∑ªÂä†ÈÖçÂõæÊèèËø∞
- ÂõæÁâáÊèèËø∞Ë¶ÅÁîüÂä®„ÄÅÂÖ∑‰ΩìÔºåËÆ©‰∫∫ËÉΩÈÄöËøáÊñáÂ≠óÊÉ≥Ë±°Âá∫ÁîªÈù¢
- ‰ª•Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÊèèËø∞Ôºå‰æãÂ¶ÇÔºö*[ÈÖçÂõæÔºöÁÖßÁâáÈáå‰∏ÄÂè™Ê©òÁå´Ê≠£ÊáíÊ¥ãÊ¥ãÂú∞Ë∂¥Âú®Á™óÂè∞‰∏äÊôíÂ§™Èò≥ÔºåÈò≥ÂÖâÊääÂÆÉÈáëËâ≤ÁöÑÊØõÁÖßÂæóÂèë‰∫ÆÔºåËÉåÊôØÊòØËîöËìùÁöÑÂ§©Á©∫ÂíåÂá†ÊúµÁôΩ‰∫ë„ÄÇ]*
- ÂõæÁâáÊèèËø∞Ë¶ÅÁ¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºÂíåÂΩìÂâçÊÉÖÂ¢É

${chatContext}${momentsContext}

ËØ∑ÁîüÊàê‰∏ÄÊù°Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºö`;

                const response = await generateAIResponse(prompt, character);
                if (response && response.trim()) {
                    // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®parseAiResponseËß£ÊûêAIÂõûÂ§çÁöÑJSONÊ†ºÂºè
                    const parsedMessages = parseAiResponse(response);
                    let content = '';
                    
                    if (Array.isArray(parsedMessages) && parsedMessages.length > 0) {
                        // Â¶ÇÊûúÊúâÂ§öÊù°Ê∂àÊÅØÔºåÂêàÂπ∂‰∏∫‰∏ÄÊù°Âä®ÊÄÅ
                        content = parsedMessages.map(msg => {
                            if (typeof msg === 'string') {
                                return msg.trim();
                            } else if (typeof msg === 'object' && msg.content) {
                                return msg.content.trim();
                            }
                            return '';
                        }).filter(text => text).join('\n\n');
                    } else if (typeof response === 'string') {
                        // Â§áÁî®ÔºöÂ¶ÇÊûúËß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂßãÊñáÊú¨
                        content = response.trim();
                    }
                    
                    if (content) {
                        // Ëé∑ÂèñÂ§¥ÂÉèÔºåÁ°Æ‰øùÂÆâÂÖ®
                        const avatar = getCharacterAvatar(character);
                        // ÁßªÈô§‰∫ÜÂèëÂ∏ÉÂä®ÊÄÅÂ§¥ÂÉèÊó•Âøó
                        
                        // ÂèëÂ∏ÉÂä®ÊÄÅ
                        const moment = {
                            id: Date.now(),  // ‰ΩøÁî®Êï∞Â≠óIDËÄå‰∏çÊòØÂ≠óÁ¨¶‰∏≤
                            authorId: characterId,
                            nickname: character.name,
                            avatar: avatar, // ËßíËâ≤Â§¥ÂÉè
                            text: content,
                            time: formatTime(new Date()),
                            timestamp: Date.now(),
                            characterId: characterId
                        };
                    
                                                                    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                        await db.moments.add(moment);
                        
                        // üî•„ÄêÊñ∞Â¢û„Äë‰∏∫ËßíËâ≤ÂèëÂ∏ÉÂä®ÊÄÅÂàõÂª∫Êé®ÈÄÅÈÄöÁü•
                        createPushNotification(character, `ÂèëÂ∏É‰∫ÜÊñ∞Âä®ÊÄÅÔºö${content.length > 15 ? content.substring(0, 15) + '...' : content}`, 500);
                        
                        // ËÆ∞ÂΩïÂèëÂ∏ÉÊó∂Èó¥
                        character.lastMomentTime = Date.now();
                        saveCharacters();
                        
                        // Âº∫Âà∂Âà∑Êñ∞Âä®ÊÄÅÊòæÁ§∫ÔºàÊó†ËÆ∫ÂΩìÂâçÂú®Âì™‰∏™È°µÈù¢Ôºâ
                        setTimeout(() => {
                            loadMoments();
                        }, 100);
                        
                        // Ëß¶ÂèëÂêåÂàÜÁªÑËßíËâ≤ÁöÑËá™Âèë‰∫íÂä®Ôºà‰øùÊåÅÊ¶ÇÁéáËÆæÁΩÆÔºâ
                        setTimeout(() => {
                            triggerAIInteractions(moment.id, 'like');
                        }, 2000 + Math.random() * 3000); // 2-5ÁßíÂêéÂºÄÂßãÁÇπËµû
                        
                        setTimeout(() => {
                            triggerAIInteractions(moment.id, 'comment');
                        }, 5000 + Math.random() * 5000); // 5-10ÁßíÂêéÂºÄÂßãËØÑËÆ∫
                        
                        // ÁßªÈô§‰∫ÜÂèëÂ∏ÉÂä®ÊÄÅÊó•Âøó
                    }
                }
            } catch (error) {
                console.error('ÂêéÂè∞ÂèëÂä®ÊÄÅÂ§±Ë¥•:', error);
            }
        }

        // Ëé∑ÂèñÊúÄËøëÁöÑÂä®ÊÄÅ
        async function getRecentMoments(count = 5) {
            try {
                // ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÊúÄÊñ∞ÁöÑÂä®ÊÄÅÊï∞ÊçÆ
                const momentsData = await db.moments.orderBy('timestamp').reverse().limit(count).toArray();
                return momentsData || [];
            } catch (error) {
                console.error('Ëé∑ÂèñÊúÄËøëÂä®ÊÄÅÂ§±Ë¥•:', error);
                return [];
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëËé∑ÂèñËßíËâ≤ÂèØËßÅÁöÑÂä®ÊÄÅÔºàÁî®‰∫éËÅäÂ§©ËÆ∞ÂøÜÈõÜÊàêÔºâ
        async function getVisibleMomentsForCharacter(characterId, count = 5) {
            try {
                // Ëé∑ÂèñÊâÄÊúâÊúÄÊñ∞Âä®ÊÄÅ
                const allMoments = await db.moments.orderBy('timestamp').reverse().limit(count * 2).toArray();
                
                // Á≠õÈÄâËßíËâ≤ÂèØËßÅÁöÑÂä®ÊÄÅÔºö
                // 1. Áî®Êà∑ÂèëÁöÑÂä®ÊÄÅÔºàÊâÄÊúâËßíËâ≤ÈÉΩËÉΩÁúãÂà∞Ôºâ
                // 2. ËßíËâ≤Ëá™Â∑±ÂèëÁöÑÂä®ÊÄÅ
                // 3. Âêå‰∏Ä‰∏™Â•ΩÂèãÂàÜÁªÑÁöÑÂÖ∂‰ªñËßíËâ≤ÂèëÁöÑÂä®ÊÄÅ
                
                const visibleMoments = [];
                const character = characters.find(c => c.id === characterId);
                
                for (const moment of allMoments) {
                    if (visibleMoments.length >= count) break;
                    
                    // Áî®Êà∑ÂèëÁöÑÂä®ÊÄÅÔºåÊâÄÊúâËßíËâ≤ÈÉΩËÉΩÁúãÂà∞
                    if (moment.authorId === 'user') {
                        visibleMoments.push(moment);
                        continue;
                    }
                    
                    // ËßíËâ≤Ëá™Â∑±ÂèëÁöÑÂä®ÊÄÅ
                    if (moment.authorId === characterId) {
                        visibleMoments.push(moment);
                        continue;
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂêå‰∏Ä‰∏™Â•ΩÂèãÂàÜÁªÑÁöÑËßíËâ≤ÂèëÁöÑÂä®ÊÄÅ
                    if (character && moment.characterId) {
                        const momentAuthor = characters.find(c => c.id === moment.characterId);
                        if (momentAuthor && areCharactersInSameGroup(character, momentAuthor)) {
                            visibleMoments.push(moment);
                            continue;
                        }
                    }
                }
                
                return visibleMoments;
            } catch (error) {
                console.error('Ëé∑ÂèñËßíËâ≤ÂèØËßÅÂä®ÊÄÅÂ§±Ë¥•:', error);
                return [];
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•‰∏§‰∏™ËßíËâ≤ÊòØÂê¶Âú®Âêå‰∏Ä‰∏™Â•ΩÂèãÂàÜÁªÑ
        function areCharactersInSameGroup(char1, char2) {
            // Â¶ÇÊûúÊ≤°ÊúâÂàÜÁªÑÁ≥ªÁªüÔºåÈªòËÆ§ÊâÄÊúâËßíËâ≤ÈÉΩÂú®Âêå‰∏ÄÁªÑÔºàÈÉΩÊòØÂ•ΩÂèãÔºâ
            // ËøôÈáåÂèØ‰ª•Ê†πÊçÆÂÆûÈôÖÁöÑÂàÜÁªÑÈÄªËæëËøõË°åË∞ÉÊï¥
            return contacts.includes(char1.id) && contacts.includes(char2.id);
        }

        // ÁîüÊàêAIÂìçÂ∫îÁöÑÂåÖË£ÖÂáΩÊï∞ÔºåÁî®‰∫éÂêéÂè∞‰∫íÂä®
        async function generateAIResponse(prompt, character) {
            try {
                // ‰ΩøÁî®Áé∞ÊúâÁöÑ callChatAPI ÂáΩÊï∞
                const response = await callChatAPI(prompt, character);
                return response;
            } catch (error) {
                console.error('AIÂìçÂ∫îÁîüÊàêÂ§±Ë¥•:', error);
                return null;
            }
        }

        // È™åËØÅÂ§¥ÂÉèURLÊòØÂê¶ÊúâÊïà
        function isValidAvatarUrl(url) {
            if (!url || typeof url !== 'string') return false;
            
            // Ê£ÄÊü•base64Ê†ºÂºè
            if (url.startsWith('data:image/')) {
                // Êõ¥ÂÆΩÊùæÁöÑbase64È™åËØÅÔºåÂè™Ê£ÄÊü•Âü∫Êú¨ÁªìÊûÑ
                const parts = url.split(',');
                if (parts.length !== 2) {
                    console.warn('base64Â§¥ÂÉèURLÊ†ºÂºèÈîôËØØÔºàÁº∫Â∞ëÈÄóÂè∑ÂàÜÈöîÔºâ:', url.substring(0, 50) + '...');
                    return false;
                }
                
                const header = parts[0];
                const data = parts[1];
                
                // Ê£ÄÊü•headerÊòØÂê¶ÂåÖÂê´ÂøÖË¶Å‰ø°ÊÅØ
                if (!header.includes('data:image/') || !header.includes('base64')) {
                    console.warn('base64Â§¥ÂÉèURLÂ§¥ÈÉ®Ê†ºÂºèÈîôËØØ:', header);
                    return false;
                }
                
                // Ê£ÄÊü•base64Êï∞ÊçÆÊòØÂê¶‰∏∫Á©∫ÊàñËøáÈïø
                if (!data || data.length < 50) {
                    console.warn('base64Â§¥ÂÉèÊï∞ÊçÆ‰∏∫Á©∫ÊàñËøáÁü≠:', data.length);
                    return false;
                }
                
                if (data.length > 2000000) { // 2MBÈôêÂà∂ÔºåÊõ¥ÂÆΩÊùæ
                    console.warn('base64Â§¥ÂÉèÊï∞ÊçÆËøáÂ§ß:', data.length, 'Âª∫ËÆÆÂéãÁº©ÂêéÈáçÊñ∞‰∏ä‰º†‰ª•ÊèêÈ´òÊÄßËÉΩ');
                    // ‰∏çÂÜçÁõ¥Êé•ÊãíÁªùÔºåÂè™ÊòØË≠¶Âëä
                }
                
                // ÁÆÄÂçïÊ£ÄÊü•base64Â≠óÁ¨¶ÊòØÂê¶ÂêàÊ≥ï
                const base64Chars = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Chars.test(data)) {
                    console.warn('base64Â§¥ÂÉèÊï∞ÊçÆÂåÖÂê´ÈùûÊ≥ïÂ≠óÁ¨¶');
                    return false;
                }
                
                return true;
            }
            
            // Ê£ÄÊü•HTTP(S) URLÊ†ºÂºè
            if (url.startsWith('http://') || url.startsWith('https://')) {
                try {
                    new URL(url);
                    return true;
                } catch (error) {
                    console.warn('Êó†ÊïàÁöÑHTTPÂ§¥ÂÉèURL:', url);
                    return false;
                }
            }
            
            // Â¶ÇÊûú‰∏çÊòØdata:imageÊàñhttp(s)ÂºÄÂ§¥ÔºåËÄÉËôëÂèØËÉΩÊòØÂÖ∂‰ªñÊúâÊïàÊ†ºÂºè
            console.warn('Êú™Áü•ÁöÑÂ§¥ÂÉèURLÊ†ºÂºè:', url.substring(0, 50) + '...');
            return false;
        }

        // Ëé∑ÂèñËßíËâ≤ÁöÑÂ§¥ÂÉèÔºàÁî®‰∫éÂä®ÊÄÅÂèëÂ∏ÉÔºâ
        function getCharacterAvatar(character) {
            // ‰ΩøÁî®ÂêåÊ≠•ÁâàÊú¨ÁöÑËÆæÁΩÆËé∑ÂèñÔºåÈÅøÂÖçPromiseÈóÆÈ¢ò
            const chatSettings = getChatSettingsSync(character.id);
            
            // ‰ºòÂÖàÁ∫ß1ÔºöÂ¶ÇÊûúËßíËâ≤ÊúâËÅäÂ§©Á™óÂè£ÁöÑÂä®ÊÄÅÂ§¥ÂÉèËÆæÁΩÆÔºå‰ΩøÁî®ÈÇ£‰∏™
            if (chatSettings.aiDynamicAvatar && chatSettings.aiDynamicAvatar.trim()) {
                const avatar = chatSettings.aiDynamicAvatar;
                if (isValidAvatarUrl(avatar)) {
                    return avatar;
                } else {
                    console.warn(`ËßíËâ≤${character.name}ÁöÑÂä®ÊÄÅÂ§¥ÂÉèÊó†ÊïàÔºåÂ∞ùËØï‰ΩøÁî®ÂÖ∂‰ªñÂ§¥ÂÉè`);
                }
            }
            
            // ‰ºòÂÖàÁ∫ß2ÔºöÂ¶ÇÊûúËßíËâ≤ÊúâËÅäÂ§©Á™óÂè£ÁöÑÂ§¥ÂÉèËÆæÁΩÆÔºå‰ΩøÁî®ÈÇ£‰∏™
            if (chatSettings.aiChatAvatar && chatSettings.aiChatAvatar.trim()) {
                const avatar = chatSettings.aiChatAvatar;
                if (isValidAvatarUrl(avatar)) {
                    return avatar;
                } else {
                    console.warn(`ËßíËâ≤${character.name}ÁöÑËÅäÂ§©Â§¥ÂÉèÊó†ÊïàÔºåÂ∞ùËØï‰ΩøÁî®ËßíËâ≤Âç°Â§¥ÂÉè`);
                }
            }
            
            // ‰ºòÂÖàÁ∫ß3Ôºö‰ΩøÁî®ËßíËâ≤Âç°ÈáåÁöÑÂ§¥ÂÉè
            if (character.avatarUrl && character.avatarUrl.trim()) {
                const avatar = character.avatarUrl;
                if (isValidAvatarUrl(avatar)) {
                    return avatar;
                } else {
                    console.warn(`ËßíËâ≤${character.name}ÁöÑËßíËâ≤Âç°Â§¥ÂÉèÊó†ÊïàÔºåÂ§ßÂ∞èÊàñÊ†ºÂºèÈóÆÈ¢ò`);
                }
            }
            
            console.log(`ËßíËâ≤${character.name}Ê≤°ÊúâÂèØÁî®ÁöÑÂ§¥ÂÉè`);
            return null;
        }

        // Ëé∑ÂèñÊåáÂÆöËßíËâ≤ÁöÑËÅäÂ§©ËÆæÁΩÆ - ‰ΩøÁî®IndexedDB
        async function getChatSettings(characterId) {
            try {
                const chatSettingsRecord = await db.chatSettings.get(characterId);
                if (chatSettingsRecord) {
                    return chatSettingsRecord.settings;
                }
                
                // Â¶ÇÊûúIndexedDB‰∏≠Ê≤°ÊúâÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                const savedSettings = localStorage.getItem(`chatSettings_${characterId}`);
                if (savedSettings) {
                    console.log(`ËøÅÁßªËßíËâ≤ ${characterId} ÁöÑËÅäÂ§©ËÆæÁΩÆÂà∞IndexedDB`);
                    const settings = JSON.parse(savedSettings);
                    
                    // ‰øùÂ≠òÂà∞IndexedDB
                    await db.chatSettings.put({
                        id: characterId,
                        chatId: characterId,
                        settings: settings
                    });
                    
                    return settings;
                }
                
                return {};
            } catch (error) {
                console.error('Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                // ÂõûÈÄÄÂà∞localStorage
                const savedSettings = localStorage.getItem(`chatSettings_${characterId}`);
                return savedSettings ? JSON.parse(savedSettings) : {};
            }
        }
        
        // ÂêåÊ≠•ÁâàÊú¨ÁöÑgetChatSettingsÔºàÁî®‰∫é‰∏çÊîØÊåÅasyncÁöÑÂú∞ÊñπÔºâ
        function getChatSettingsSync(characterId) {
            const savedSettings = localStorage.getItem(`chatSettings_${characterId}`);
            return savedSettings ? JSON.parse(savedSettings) : {};
        }

        // Ê†ºÂºèÂåñÂä®ÊÄÅÊñáÂ≠óÔºåÊîØÊåÅÂàÜË°åÂíåÈÖçÂõæÊèèËø∞
        function formatMomentText(text) {
            if (!text) return '';
            
            // ÊõøÊç¢Êç¢Ë°åÁ¨¶‰∏∫<br>Ê†áÁ≠æÔºåÊîØÊåÅÂàÜË°åÊòæÁ§∫
            let formattedText = text.replace(/\n/g, '<br>');
            
            // Â§ÑÁêÜÈÖçÂõæÊèèËø∞ÔºöÂåπÈÖç*[ÈÖçÂõæÔºöÊèèËø∞]*Ê†ºÂºè
            formattedText = formattedText.replace(/\*\[ÈÖçÂõæÔºö([^\]]+)\]\*/g, function(match, description) {
                return `<span style="font-style: italic; color: #999; font-size: 13px; line-height: 1.4;">[ÈÖçÂõæÔºö${description}]</span>`;
            });
            
            return formattedText;
        }

        // Ë∞ÉËØïËßíËâ≤Âä®ÊÄÅÂ§¥ÂÉè
        function debugMomentAvatar(momentId) {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) {
                console.log('Êâæ‰∏çÂà∞Âä®ÊÄÅÂÖÉÁ¥†');
                return;
            }
            
            // ‰ªéIndexedDBËé∑ÂèñÂä®ÊÄÅÊï∞ÊçÆ
            db.moments.get(parseInt(momentId)).then(moment => {
                console.log('=== Âä®ÊÄÅÂ§¥ÂÉèË∞ÉËØï ===');
                console.log('Âä®ÊÄÅID:', momentId);
                console.log('ËßíËâ≤ID:', moment.characterId);
                console.log('‰øùÂ≠òÁöÑÂ§¥ÂÉè:', moment.avatar ? moment.avatar.substring(0, 50) + '...' : 'null');
                
                if (moment.characterId && moment.characterId !== 'user') {
                    const character = characters.find(c => c.id === moment.characterId);
                    if (character) {
                        console.log('ÊâæÂà∞ËßíËâ≤:', character.name);
                        console.log('ËßíËâ≤Âç°Â§¥ÂÉè:', character.avatarUrl ? character.avatarUrl.substring(0, 50) + '...' : 'null');
                    } else {
                        console.log('Êâæ‰∏çÂà∞ËßíËâ≤Êï∞ÊçÆ');
                    }
                }
                
                const avatarImg = momentElement.querySelector('.moment-avatar img');
                if (avatarImg) {
                    console.log('ÂΩìÂâçÊòæÁ§∫ÁöÑÂ§¥ÂÉèURL:', avatarImg.src ? avatarImg.src.substring(0, 50) + '...' : 'null');
                }
            });
        }
        
        // ÁÆÄÂçïÁöÑÂ§¥ÂÉèÊï∞ÊçÆ‰øÆÂ§ç
        async function fixAvatarData() {
            console.log('ÂºÄÂßã‰øÆÂ§çÂ§¥ÂÉèÊï∞ÊçÆ...');
            let fixedCount = 0;
            
            try {
                // Ê∏ÖÁêÜËßíËâ≤ËÆæÁΩÆ‰∏≠ÁöÑÊà™Êñ≠Â§¥ÂÉè
                for (const character of characters) {
                    const chatSettings = await getChatSettings(character.id);
                    let needSave = false;
                    
                    if (chatSettings.aiDynamicAvatar) {
                        const avatar = chatSettings.aiDynamicAvatar;
                        if (avatar.startsWith('data:image/') && !avatar.includes('=') && avatar.split(',').length === 2) {
                            console.log(`Ê∏ÖÁêÜ${character.name}ÁöÑÂä®ÊÄÅÂ§¥ÂÉèËÆæÁΩÆ`);
                            delete chatSettings.aiDynamicAvatar;
                            needSave = true;
                            fixedCount++;
                        }
                    }
                    
                    if (chatSettings.aiChatAvatar) {
                        const avatar = chatSettings.aiChatAvatar;
                        if (avatar.startsWith('data:image/') && !avatar.includes('=') && avatar.split(',').length === 2) {
                            console.log(`Ê∏ÖÁêÜ${character.name}ÁöÑËÅäÂ§©Â§¥ÂÉèËÆæÁΩÆ`);
                            delete chatSettings.aiChatAvatar;
                            needSave = true;
                            fixedCount++;
                        }
                    }
                    
                    if (needSave) {
                        // ‰øùÂ≠òÂà∞IndexedDBËÄå‰∏çÊòØlocalStorage
                        await db.chatSettings.put({
                            id: character.id,
                            chatId: character.id,
                            settings: chatSettings
                        });
                    }
                }
                
                // Ê∏ÖÁêÜÂä®ÊÄÅÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊà™Êñ≠Â§¥ÂÉè
                const allMoments = await db.moments.toArray();
                let momentFixedCount = 0;
                
                for (const moment of allMoments) {
                    if (moment.avatar && moment.avatar.startsWith('data:image/')) {
                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÊà™Êñ≠ÁöÑÂ§¥ÂÉèÔºà‰ª•VNEKhsVJikÁªìÂ∞æÁöÑÊòØÊà™Êñ≠ÁöÑÔºâ
                        if (moment.avatar.endsWith('VNEKhsVJik') || moment.avatar.endsWith('VNEKhsVJik:1') || 
                            (!moment.avatar.includes('=') && moment.avatar.split(',').length === 2)) {
                            console.log(`Ê∏ÖÁêÜÂä®ÊÄÅ ${moment.id} ÁöÑÊà™Êñ≠Â§¥ÂÉè`);
                            await db.moments.update(moment.id, { avatar: null });
                            momentFixedCount++;
                        }
                    }
                }
                
                const totalFixed = fixedCount + momentFixedCount;
                console.log(`‰øÆÂ§çÂÆåÊàê: Ê∏ÖÁêÜ‰∫Ü${fixedCount}‰∏™ËÆæÁΩÆÂ§¥ÂÉè, ${momentFixedCount}‰∏™Âä®ÊÄÅÂ§¥ÂÉè`);
                
                alert(`‰øÆÂ§çÂÆåÊàêÔºÅ\nÊ∏ÖÁêÜ‰∫Ü ${fixedCount} ‰∏™ËÆæÁΩÆ‰∏≠ÁöÑÊà™Êñ≠Â§¥ÂÉè\nÊ∏ÖÁêÜ‰∫Ü ${momentFixedCount} ‰∏™Âä®ÊÄÅ‰∏≠ÁöÑÊà™Êñ≠Â§¥ÂÉè\n\nËØ∑ÈáçÊñ∞‰∏∫ËßíËâ≤ËÆæÁΩÆÂ§¥ÂÉè`);
                
                if (totalFixed > 0) {
                    loadMoments();
                }
            } catch (error) {
                console.error('‰øÆÂ§çÂ§±Ë¥•:', error);
                alert('‰øÆÂ§çÂ§±Ë¥•: ' + error.message);
            }
        }

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÂêéÂè∞ÂÆöÊó∂Âô®
        window.addEventListener('beforeunload', function() {
            clearAllBackgroundTimers();
            clearGlobalMomentsTimers();
        });
        
        // üî•„ÄêË∞ÉËØïÂäüËÉΩ„ÄëÊµãËØïÂä®ÊÄÅÁ≥ªÁªüÊòØÂê¶Ê≠£Â∏∏Â∑•‰Ωú
        function debugMomentsSystem() {
            console.log('=== Âä®ÊÄÅÁ≥ªÁªüË∞ÉËØï‰ø°ÊÅØ ===');
            console.log('ËßíËâ≤Êï∞Èáè:', characters ? characters.length : 0);
            console.log('ÂÖ®Â±ÄÂÆöÊó∂Âô®:', Object.keys(globalMomentsTimers));
            console.log('ÂÆöÊó∂Ê£ÄÊü•Âô®Áä∂ÊÄÅ:', globalMomentsCheckInterval ? 'ËøêË°å‰∏≠' : 'Êú™ËøêË°å');
            
            if (characters && characters.length > 0) {
                console.log('ÂêÑËßíËâ≤ËÆæÁΩÆ:');
                characters.forEach(async (character, index) => {
                    const settings = await getChatSettings(character.id);
                    console.log(`${index + 1}. ${character.name}:`, {
                        backgroundMomentsEnabled: settings.backgroundMomentsEnabled,
                        backgroundMomentsFrequency: settings.backgroundMomentsFrequency,
                        scheduledMomentsEnabled: settings.scheduledMomentsEnabled,
                        scheduledMomentsTimes: settings.scheduledMomentsTimes
                    });
                });
            }
            
            console.log('=========================');
        }
        
        // Êö¥Èú≤Ë∞ÉËØïÂáΩÊï∞Âà∞ÂÖ®Â±Ä
        window.debugMomentsSystem = debugMomentsSystem;


        // Âä†ËΩΩÂ£ÅÁ∫∏ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadWallpaper() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedWallpaper = await db.wallpapers.get('main');
            
            if (savedWallpaper) {
                    selectedWallpaper = savedWallpaper.data;
                
                    if (savedWallpaper.type === 'image' && savedWallpaper.data.startsWith('data:image')) {
                    // Âä†ËΩΩ‰∏ä‰º†ÁöÑÂõæÁâá
                        document.querySelector('.wallpaper').style.backgroundImage = `url(${savedWallpaper.data})`;
                    } else if (savedWallpaper.type === 'gradient' || savedWallpaper.data.startsWith('linear-gradient')) {
                    // Âä†ËΩΩÊ∏êÂèòËÉåÊôØ
                        document.querySelector('.wallpaper').style.backgroundImage = savedWallpaper.data;
                } else {
                    // Âä†ËΩΩÁ∫ØËâ≤ËÉåÊôØ
                        document.querySelector('.wallpaper').style.backgroundColor = savedWallpaper.data;
                    document.querySelector('.wallpaper').style.backgroundImage = 'none';
                }
                
                document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                } else {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localWallpaper = localStorage.getItem('wallpaper');
                    const wallpaperType = localStorage.getItem('wallpaperType');
                    
                    if (localWallpaper) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑÂ£ÅÁ∫∏Êï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        selectedWallpaper = localWallpaper;
                        
                        // ËøÅÁßªÂà∞IndexedDB
                        await db.wallpapers.add({
                            id: 'main',
                            type: wallpaperType || 'gradient',
                            data: localWallpaper
                        });
                        
                        if (wallpaperType === 'image' && localWallpaper.startsWith('data:image')) {
                            document.querySelector('.wallpaper').style.backgroundImage = `url(${localWallpaper})`;
                        } else if (wallpaperType === 'gradient' || localWallpaper.startsWith('linear-gradient')) {
                            document.querySelector('.wallpaper').style.backgroundImage = localWallpaper;
                        } else {
                            document.querySelector('.wallpaper').style.backgroundColor = localWallpaper;
                            document.querySelector('.wallpaper').style.backgroundImage = 'none';
                        }
                        
                        document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                        document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                        
                        console.log('Â£ÅÁ∫∏Êï∞ÊçÆËøÅÁßªÂÆåÊàê');
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ£ÅÁ∫∏Â§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localWallpaper = localStorage.getItem('wallpaper');
                const wallpaperType = localStorage.getItem('wallpaperType');
                
                if (localWallpaper) {
                    selectedWallpaper = localWallpaper;
                    
                    if (wallpaperType === 'image' && localWallpaper.startsWith('data:image')) {
                        document.querySelector('.wallpaper').style.backgroundImage = `url(${localWallpaper})`;
                    } else if (wallpaperType === 'gradient' || localWallpaper.startsWith('linear-gradient')) {
                        document.querySelector('.wallpaper').style.backgroundImage = localWallpaper;
                    } else {
                        document.querySelector('.wallpaper').style.backgroundColor = localWallpaper;
                        document.querySelector('.wallpaper').style.backgroundImage = 'none';
                    }
                    
                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                }
            }
        }
        
        // Âä†ËΩΩÂ∫îÁî®ÂõæÊ†á - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadAppIcons() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedIcons = await db.appIcons.toArray();
                
                if (savedIcons.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('appIcons');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑÂ∫îÁî®ÂõæÊ†áÊï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localIcons = JSON.parse(localStorageData);
                        
                        // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºèÂ≠òÂÇ®Âà∞IndexedDB
                        const iconArray = Object.keys(localIcons).map(appId => ({
                            id: appId,
                            appId: appId,
                            iconClass: localIcons[appId]
                        }));
                        
                        if (iconArray.length > 0) {
                            await db.appIcons.bulkAdd(iconArray);
                            console.log('Â∫îÁî®ÂõæÊ†áÊï∞ÊçÆËøÅÁßªÂÆåÊàê:', iconArray);
                        }
                        
                        // Â∫îÁî®ÂõæÊ†á
                        Object.keys(localIcons).forEach(appId => {
                            const iconElement = document.querySelector(`.app[onclick="showApp('${appId}')"] .app-icon i`);
                            if (iconElement) {
                                iconElement.className = localIcons[appId];
                            }
                        });
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    console.log('‰ªéIndexedDBÂä†ËΩΩÂ∫îÁî®ÂõæÊ†áÊï∞ÊçÆ:', savedIcons);
                    savedIcons.forEach(iconData => {
                        const iconElement = document.querySelector(`.app[onclick="showApp('${iconData.appId}')"] .app-icon i`);
                        if (iconElement) {
                            iconElement.className = iconData.iconClass;
                        }
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ∫îÁî®ÂõæÊ†áÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('appIcons');
                if (localStorageData) {
                    const icons = JSON.parse(localStorageData);
                Object.keys(icons).forEach(appId => {
                    const iconElement = document.querySelector(`.app[onclick="showApp('${appId}')"] .app-icon i`);
                    if (iconElement) {
                        iconElement.className = icons[appId];
                    }
                });
                }
            }
        }
        
        // Âä†ËΩΩAPIËÆæÁΩÆ - ‰ΩøÁî®IndexedDB
        async function loadApiSettings() {
            try {
                // ÂÖà‰ªéIndexedDBÂ∞ùËØïÂä†ËΩΩ
                const savedSettings = await db.apiSettings.get('main');
                if (savedSettings) {
                    apiSettings = savedSettings.settings;
                    console.log('üîß [Â∫îÁî®ÂêØÂä®] ‰ªéIndexedDBÂä†ËΩΩAPIËÆæÁΩÆ:', apiSettings);
                } else {
                    // Â∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localSettings = localStorage.getItem('apiSettings');
                    if (localSettings) {
                        console.log('üîß [Â∫îÁî®ÂêØÂä®] ËøÅÁßªAPIËÆæÁΩÆ‰ªélocalStorageÂà∞IndexedDB');
                        apiSettings = JSON.parse(localSettings);

                        // ‰øùÂ≠òÂà∞IndexedDB
                        await db.apiSettings.put({
                            id: 'main',
                            settings: apiSettings
                        });
                        console.log('üîß [Â∫îÁî®ÂêØÂä®] ËøÅÁßªÂÆåÊàêÔºåÂΩìÂâçAPIËÆæÁΩÆ:', apiSettings);
                    } else {
                        // ‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ
                        console.log('üîß [Â∫îÁî®ÂêØÂä®] ‰ΩøÁî®ÈªòËÆ§APIËÆæÁΩÆ');
                        apiSettings = {
                            type: 'gemini',
                            base: 'https://generativelanguage.googleapis.com/v1beta',
                            endpoint: '/chat/completions',
                            key: '',
                            model: 'gemini-2.0-flash-exp',
                            temperature: 0.70
                        };
                    }
                }

                // ÊóßÁâàÊú¨APIËÆæÁΩÆË°®ÂçïÊõ¥Êñ∞‰ª£Á†ÅÂ∑≤Ê∏ÖÁêÜ - Áé∞Âú®‰ΩøÁî®Êñ∞ÁâàÊú¨ÁöÑAPIËÆæÁΩÆÁ≥ªÁªü
            } catch (error) {
                console.error('Âä†ËΩΩAPIËÆæÁΩÆÂ§±Ë¥•:', error);
                // ÊóßÁâàÊú¨ÈªòËÆ§ËÆæÁΩÆ‰ª£Á†ÅÂ∑≤Ê∏ÖÁêÜ
            }
        }
        
        // ‰øùÂ≠òÂ∫îÁî®ÂõæÊ†á - ‰ΩøÁî®IndexedDB
        async function saveAppIcons() {
            try {
                console.log('‰øùÂ≠òÂ∫îÁî®ÂõæÊ†áÊï∞ÊçÆÂà∞IndexedDB...');
                
                const defaultIcons = {
                    'chat-screen': 'fas fa-comment-dots',
                    'forum-screen': 'fas fa-comments',
                    'music-screen': 'fas fa-music',
                    'game-screen': 'fas fa-gamepad',
                    'characters-screen': 'fas fa-user-friends',
                    'shop-screen': 'fas fa-shopping-bag',
                    'settings-screen': 'fas fa-cog'
                };
                
                if (selectedAppIcon) {
                    defaultIcons[selectedAppIcon.appId] = selectedAppIcon.iconClass;
                }
                
                // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÊ†ºÂºè
                const iconArray = Object.keys(defaultIcons).map(appId => ({
                    id: appId,
                    appId: appId,
                    iconClass: defaultIcons[appId]
                }));
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆÂπ∂ÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                await db.appIcons.clear();
                await db.appIcons.bulkAdd(iconArray);
                
                console.log('Â∫îÁî®ÂõæÊ†áÊï∞ÊçÆ‰øùÂ≠òÊàêÂäü');
                
                // Âà∑Êñ∞ÂõæÊ†áÊòæÁ§∫
                await loadAppIcons();
            } catch (error) {
                console.error('‰øùÂ≠òÂ∫îÁî®ÂõæÊ†áÊó∂ÂèëÁîüÈîôËØØ:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
            const icons = {
                'chat-screen': 'fas fa-comment-dots',
                'weibo-screen': 'fab fa-weibo',
                'music-screen': 'fas fa-music',
                'album-screen': 'fas fa-images',
                'characters-screen': 'fas fa-user-friends',
                'shop-screen': 'fas fa-shopping-bag',
                'settings-screen': 'fas fa-cog'
            };
            
            if (selectedAppIcon) {
                icons[selectedAppIcon.appId] = selectedAppIcon.iconClass;
            }
            
            localStorage.setItem('appIcons', JSON.stringify(icons));
            loadAppIcons();
            }
        }
        
        // Ê∏≤ÊüìÊ∂àÊÅØÂàóË°®
        function renderMessageList() {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';
            
            // Ê∑ªÂä†Â§öÈÄâÊ®°ÂºèÁöÑÂ§¥ÈÉ®
            if (isMessageListMultiSelectMode) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'multiselect-header';
                headerDiv.innerHTML = `
                    <span>Â∑≤ÈÄâÊã© ${selectedConversations.length} ‰∏™ÂØπËØù</span>
                    <div>
                        <button onclick="deleteSelectedConversations()" class="delete-btn-red">Âà†Èô§</button>
                        <button onclick="exitMessageListMultiSelectMode()" class="cancel-btn-blue">ÂèñÊ∂à</button>
                    </div>
                `;
                messageList.appendChild(headerDiv);
            }
            
            // Ê∏≤ÊüìÂçï‰∫∫ËÅäÂ§©
            contacts.forEach(contactId => {
                const character = characters.find(c => c.id === contactId);
                if (character) {
                    // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñËØ•ËÅäÂ§©ÁöÑÊòµÁß∞ËÆæÁΩÆ
                    const savedSettings = localStorage.getItem(`chatSettings_${character.id}`);
                    const chatSettings = savedSettings ? JSON.parse(savedSettings) : {};
                    const displayName = chatSettings.aiChatNickname || character.name;
                    
                    const messages = chatMessages[character.id] || [];
                let lastMessageRaw = 'ÊöÇÊó†Ê∂àÊÅØ';
                
                if (messages.length > 0) {
                    const lastMsg = messages[messages.length - 1];
                    
                    // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•Ê∂àÊÅØÊòØÂê¶ÊúâÊïàÔºåÈò≤Ê≠¢undefinedÈîôËØØ
                    if (!lastMsg) {
                        lastMessageRaw = 'ÊöÇÊó†Ê∂àÊÅØ';
                    } else if (lastMsg.type === 'user_photo') {
                        lastMessageRaw = '[ÁÖßÁâá]';
                    } else if (lastMsg.type === 'ai_image') {
                        lastMessageRaw = '[ÂõæÁâá]';
                    } else if (lastMsg.type === 'voice_message') {
                        lastMessageRaw = '[ËØ≠Èü≥]';
                    } else if (lastMsg.type === 'transfer') {
                        lastMessageRaw = '[ËΩ¨Ë¥¶]';
                    } else if (lastMsg.type === 'recalled_message') {
                        lastMessageRaw = '[Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ]';
                    } else if (lastMsg.type === 'location') {
                        lastMessageRaw = '[‰ΩçÁΩÆ]';
                    } else if (lastMsg.type === 'call_message') {
                        lastMessageRaw = '[ÈÄöËØùÊ∂àÊÅØ]';
                    } else if (lastMsg.sender === 'system') {
                        lastMessageRaw = lastMsg.content || '[Á≥ªÁªüÊ∂àÊÅØ]';
                    } else if (lastMsg.isEmoji) {
                        lastMessageRaw = '[Ë°®ÊÉÖ]';
                    } else {
                        lastMessageRaw = lastMsg.content || '';
                    }
                }
                
                const lastMessage = truncateText(String(lastMessageRaw || 'ÊöÇÊó†Ê∂àÊÅØ'), 30);
                    const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : 'ÂàöÂàö';
                    
                    const messageItem = document.createElement('div');
                    messageItem.className = `message-item ${isMessageListMultiSelectMode && selectedConversations.includes(character.id) ? 'selected' : ''}`;
                    messageItem.dataset.conversationId = character.id; // Ê∑ªÂä†ÂØπËØùID
                    
                    // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÁÇπÂáª‰∫ã‰ª∂
                    if (isMessageListMultiSelectMode) {
                        messageItem.onclick = () => toggleConversationSelection(character.id);
                    } else {
                        // ‰ΩøÁî®ÂèòÈáèÊù•ÊéßÂà∂ÁÇπÂáªË°å‰∏∫
                        let isLongPress = false;
                        
                        messageItem.onclick = (e) => {
                            if (!isLongPress) {
                                startChat(character);
                            }
                            isLongPress = false; // ÈáçÁΩÆÊ†áÂøó
                        };
                        
                        // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂ÔºàÊîØÊåÅÁßªÂä®Á´ØÂíåÊ°åÈù¢Á´ØÔºâ
                        let pressTimer;
                        
                        // ÁßªÂä®Á´ØËß¶Êë∏‰∫ã‰ª∂
                        messageItem.addEventListener('touchstart', (e) => {
                            e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                            pressTimer = setTimeout(() => {
                                console.log('Ëß¶Êë∏ÈïøÊåâËß¶ÂèëÔºåËßíËâ≤ID:', character.id);
                                isLongPress = true; // ËÆæÁΩÆÈïøÊåâÊ†áÂøó
                                enterMessageListMultiSelectMode(character.id);
                                e.preventDefault();
                            }, 800); // 800msÈïøÊåâ
                        });
                        
                        messageItem.addEventListener('touchend', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });
                        
                        messageItem.addEventListener('touchmove', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });
                        
                        // Ê°åÈù¢Á´ØÈº†Ê†á‰∫ã‰ª∂
                        messageItem.addEventListener('mousedown', (e) => {
                            if (e.button === 0) { // Â∑¶ÈîÆ
                                e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                                pressTimer = setTimeout(() => {
                                    console.log('Èº†Ê†áÈïøÊåâËß¶ÂèëÔºåËßíËâ≤ID:', character.id);
                                    isLongPress = true; // ËÆæÁΩÆÈïøÊåâÊ†áÂøó
                                    enterMessageListMultiSelectMode(character.id);
                                    e.preventDefault();
                                }, 800); // 800msÈïøÊåâ
                            }
                        });
                        
                        messageItem.addEventListener('mouseup', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });
                        
                        messageItem.addEventListener('mouseleave', (e) => {
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        });
                        
                        // Âè≥ÈîÆÁÇπÂáªËøõÂÖ•Â§öÈÄâÊ®°ÂºèÔºàÊ°åÈù¢Á´ØÔºâ
                        messageItem.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            enterMessageListMultiSelectMode(character.id);
                        });
                    }
                    
                    messageItem.innerHTML = `
                        ${isMessageListMultiSelectMode ? `
                            <div class="selection-checkbox ${selectedConversations.includes(character.id) ? 'selected' : ''}">
                                ${selectedConversations.includes(character.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                            </div>
                        ` : ''}
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : displayName.charAt(0)}
                        </div>
                        <div class="message-content">
                            <div class="message-name">${displayName}</div>
                            <div class="message-preview">${lastMessage}</div>
                        </div>
                        <div class="message-time">${lastTime}</div>
                    `;
                    
                    messageList.appendChild(messageItem);
                }
            });
            
            // Ê∏≤ÊüìÁæ§ËÅä
            groupChats.forEach(group => {
                const messages = chatMessages[group.id] || [];
                let lastMessageRaw = 'ÊöÇÊó†Ê∂àÊÅØ';
                
                if (messages.length > 0) {
                    const lastMsg = messages[messages.length - 1];
                    
                    // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•Ê∂àÊÅØÊòØÂê¶ÊúâÊïàÔºåÈò≤Ê≠¢undefinedÈîôËØØ
                    if (!lastMsg) {
                        lastMessageRaw = 'ÊöÇÊó†Ê∂àÊÅØ';
                    } else if (lastMsg.type === 'user_photo') {
                        lastMessageRaw = '[ÁÖßÁâá]';
                    } else if (lastMsg.type === 'ai_image') {
                        lastMessageRaw = '[ÂõæÁâá]';
                    } else if (lastMsg.type === 'voice_message') {
                        lastMessageRaw = '[ËØ≠Èü≥]';
                    } else if (lastMsg.type === 'transfer') {
                        lastMessageRaw = '[ËΩ¨Ë¥¶]';
                    } else if (lastMsg.type === 'recalled_message') {
                        lastMessageRaw = '[Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ]';
                    } else if (lastMsg.type === 'location') {
                        lastMessageRaw = '[‰ΩçÁΩÆ]';
                    } else if (lastMsg.type === 'call_message') {
                        lastMessageRaw = '[ÈÄöËØùÊ∂àÊÅØ]';
                    } else if (lastMsg.sender === 'system') {
                        lastMessageRaw = lastMsg.content || '[Á≥ªÁªüÊ∂àÊÅØ]';
                    } else if (lastMsg.isEmoji) {
                        lastMessageRaw = '[Ë°®ÊÉÖ]';
                    } else {
                        lastMessageRaw = lastMsg.content || '';
                    }
                }
                
                const lastMessage = truncateText(String(lastMessageRaw || 'ÊöÇÊó†Ê∂àÊÅØ'), 30);
                const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : 'ÂàöÂàö';
                
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${isMessageListMultiSelectMode && selectedConversations.includes(group.id) ? 'selected' : ''}`;
                messageItem.dataset.conversationId = group.id; // Ê∑ªÂä†ÂØπËØùID
                
                // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÁÇπÂáª‰∫ã‰ª∂
                if (isMessageListMultiSelectMode) {
                    messageItem.onclick = () => toggleConversationSelection(group.id);
                } else {
                messageItem.onclick = () => startChat(group);
                    
                    // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂ÔºàÊîØÊåÅÁßªÂä®Á´ØÂíåÊ°åÈù¢Á´ØÔºâ
                    let pressTimer;
                    
                    // ÁßªÂä®Á´ØËß¶Êë∏‰∫ã‰ª∂
                    messageItem.addEventListener('touchstart', (e) => {
                        e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                        pressTimer = setTimeout(() => {
                            console.log('Ëß¶Êë∏ÈïøÊåâËß¶ÂèëÔºåÁæ§ËÅäID:', group.id);
                            enterMessageListMultiSelectMode(group.id);
                            e.preventDefault();
                        }, 800); // 800msÈïøÊåâ
                    });
                    
                    messageItem.addEventListener('touchend', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });
                    
                    messageItem.addEventListener('touchmove', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });
                    
                    // Ê°åÈù¢Á´ØÈº†Ê†á‰∫ã‰ª∂
                    messageItem.addEventListener('mousedown', (e) => {
                        if (e.button === 0) { // Â∑¶ÈîÆ
                            e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                            pressTimer = setTimeout(() => {
                                console.log('Èº†Ê†áÈïøÊåâËß¶ÂèëÔºåÁæ§ËÅäID:', group.id);
                                enterMessageListMultiSelectMode(group.id);
                                e.preventDefault();
                            }, 800); // 800msÈïøÊåâ
                        }
                    });
                    
                    messageItem.addEventListener('mouseup', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });
                    
                    messageItem.addEventListener('mouseleave', (e) => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                    });
                    
                    // Âè≥ÈîÆÁÇπÂáªËøõÂÖ•Â§öÈÄâÊ®°ÂºèÔºàÊ°åÈù¢Á´ØÔºâ
                    messageItem.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        enterMessageListMultiSelectMode(group.id);
                    });
                }
                
                messageItem.innerHTML = `
                    ${isMessageListMultiSelectMode ? `
                        <div class="selection-checkbox ${selectedConversations.includes(group.id) ? 'selected' : ''}">
                            ${selectedConversations.includes(group.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                        </div>
                    ` : ''}
                    <div class="message-avatar" style="${group.avatarUrl ? `background-image: url(${group.avatarUrl}); background-size: cover; background-position: center;` : 'background-color: #4CAF50;'}">
                        ${group.avatarUrl ? '' : 'Áæ§'}
                    </div>
                    <div class="message-content">
                                                        <div class="message-name">${group.name} <span class="group-member-count">(${group.members ? group.members.length + 1 : 1}‰∫∫)</span></div>
                        <div class="message-preview">${lastMessage}</div>
                    </div>
                    <div class="message-time">${lastTime}</div>
                `;
                
                messageList.appendChild(messageItem);
            });
        }
        
        // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÂàóË°®ÔºàËßíËâ≤È°µÈù¢Ôºâ- ÊåâÂàÜÁªÑÊòæÁ§∫
        function renderContactList() {
            const contactList = document.querySelector('#contact-list .contact-section');
            if (!contactList) return;
            
            // Ê∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπ
            contactList.innerHTML = '';
            

            
            // Ê∑ªÂä†Â§öÈÄâÊ®°ÂºèÁöÑÂ§¥ÈÉ®
            if (isMultiSelectMode) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'multiselect-header';
                headerDiv.innerHTML = `
                    <div class="multiselect-info">
                        <i class="fas fa-check-circle multiselect-icon"></i>
                        <span class="multiselect-text">Â∑≤ÈÄâÊã© ${selectedCharacters.length} ‰∏™ËßíËâ≤</span>
                    </div>
                    <div class="multiselect-actions">
                        <button onclick="showMoveToGroupModal()" class="multiselect-btn move-btn" title="ÁßªÂä®Âà∞ÂàÜÁªÑ">
                            <i class="fas fa-folder"></i>
                            <span>ÁßªÂä®</span>
                        </button>
                        <button onclick="deleteSelectedCharacters()" class="multiselect-btn delete-btn" title="Âà†Èô§ÈÄâ‰∏≠ËßíËâ≤">
                            <i class="fas fa-trash"></i>
                            <span>Âà†Èô§</span>
                        </button>
                        <button onclick="exitMultiSelectMode()" class="multiselect-btn cancel-btn" title="ÂèñÊ∂àÂ§öÈÄâ">
                            <i class="fas fa-times"></i>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                `;
                contactList.appendChild(headerDiv);
            }
            
            // ÂàÜÁªÑÁÆ°ÁêÜÊ®°ÂºèÁöÑÂ§¥ÈÉ®
            if (isGroupManageMode) {
                const manageHeaderDiv = document.createElement('div');
                manageHeaderDiv.className = 'group-manage-header';
                manageHeaderDiv.innerHTML = `
                    <div class="group-manage-info">
                        <i class="fas fa-cogs group-manage-icon"></i>
                        <span class="group-manage-text">ÂàÜÁªÑÁÆ°ÁêÜÊ®°Âºè</span>
                    </div>
                    <div class="group-manage-actions">
                        <button onclick="showCreateGroupModal()" class="multiselect-btn create-btn" title="Êñ∞Âª∫ÂàÜÁªÑ">
                            <i class="fas fa-plus"></i>
                            <span>Êñ∞Âª∫</span>
                        </button>
                        <button onclick="exitGroupManageMode()" class="multiselect-btn done-btn" title="ÂÆåÊàêÁÆ°ÁêÜ">
                            <i class="fas fa-check"></i>
                            <span>ÂÆåÊàê</span>
                        </button>
                    </div>
                `;
                contactList.appendChild(manageHeaderDiv);
            }
            
            // ÊåâÂàÜÁªÑÊ∏≤ÊüìËßíËâ≤
            const sortedGroups = characterGroups.sort((a, b) => a.order - b.order);
            
            sortedGroups.forEach(group => {
                const groupCharacters = characters.filter(char => char.groupId === group.id);
                
                // Â¶ÇÊûúËØ•ÂàÜÁªÑÊ≤°ÊúâËßíËâ≤‰∏î‰∏çÊòØÂàÜÁªÑÁÆ°ÁêÜÊ®°ÂºèÔºåË∑≥ËøáÊòæÁ§∫
                if (groupCharacters.length === 0 && !isGroupManageMode) return;
                
                // ÂàõÂª∫ÂàÜÁªÑÊ†áÈ¢ò
                const groupHeader = document.createElement('div');
                groupHeader.className = `group-header ${group.isDefault ? 'default-group' : 'custom-group'}`;
                
                let interactionIcon = '';
                if (group.canInteract && !group.isDefault) {
                    interactionIcon = '<i class="fas fa-comments group-interaction-icon" title="ËØ•ÂàÜÁªÑËßíËâ≤ÂèØ‰ª•Âú®Âä®ÊÄÅ‰∏≠‰∫íÂä®"></i>';
                }
                
                if (isGroupManageMode) {
                    groupHeader.innerHTML = `
                        <div class="group-title-area">
                            <span class="group-title">${group.name} (${groupCharacters.length})</span>
                            ${interactionIcon}
                            <span class="group-count"></span>
                        </div>
                        <div class="group-manage-actions">
                            ${!group.isDefault ? `
                                <button onclick="editGroup('${group.id}')" class="edit-group-btn" title="ÁºñËæëÂàÜÁªÑ">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteGroup('${group.id}')" class="delete-group-btn" title="Âà†Èô§ÂàÜÁªÑ">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    `;
                } else {
                    const isCollapsed = localStorage.getItem(`group_collapsed_${group.id}`) === 'true';
                    groupHeader.innerHTML = `
                        <div class="group-title-area" onclick="toggleGroupCollapse('${group.id}')">
                            <i class="fas fa-chevron-${isCollapsed ? 'right' : 'down'} group-chevron"></i>
                            <span class="group-title">${group.name}</span>
                            ${interactionIcon}
                            <span class="group-count">${groupCharacters.length}/${groupCharacters.length}</span>
                        </div>
                    `;
                }
                
                contactList.appendChild(groupHeader);
                
                // ÂàõÂª∫ËßíËâ≤ÂÆπÂô®
                const charactersContainer = document.createElement('div');
                charactersContainer.className = 'group-characters';
                charactersContainer.id = `group-characters-${group.id}`;
                
                // Ê£ÄÊü•ÊòØÂê¶ÊäòÂè†
                const isCollapsed = localStorage.getItem(`group_collapsed_${group.id}`) === 'true';
                if (isCollapsed && !isGroupManageMode) {
                    charactersContainer.style.display = 'none';
                }
                
                // Ê∏≤ÊüìÂàÜÁªÑ‰∏≠ÁöÑËßíËâ≤
                groupCharacters.forEach(character => {
                    const savedSettings = localStorage.getItem(`chatSettings_${character.id}`);
                    const chatSettings = savedSettings ? JSON.parse(savedSettings) : {};
                    const displayName = chatSettings.aiChatNickname || character.name;
                    
                    const contactItem = document.createElement('div');
                    contactItem.className = `contact-item ${isMultiSelectMode && selectedCharacters.includes(character.id) ? 'selected' : ''}`;
                    contactItem.dataset.characterId = character.id;
                    
                    // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÁÇπÂáª‰∫ã‰ª∂
                    if (isMultiSelectMode) {
                        contactItem.onclick = () => toggleCharacterSelection(character.id);
                    } else {
                        contactItem.onclick = () => editCharacterFromContactList(character.id);
                        
                        // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂ÔºàÊîØÊåÅËß¶Êë∏ÂíåÈº†Ê†áÔºâ
                        let pressTimer;
                        
                        const startLongPress = (e) => {
                            pressTimer = setTimeout(() => {
                                // ÈïøÊåâÁõ¥Êé•ÂºπÂá∫ÁßªÂä®ËßíËâ≤Ê®°ÊÄÅÊ°Ü
                                showMoveCharacterModal(character.id);
                                e.preventDefault();
                            }, 800);
                        };
                        
                        const cancelLongPress = () => {
                            clearTimeout(pressTimer);
                        };
                        
                        // Ëß¶Êë∏‰∫ã‰ª∂
                        contactItem.addEventListener('touchstart', startLongPress);
                        contactItem.addEventListener('touchend', cancelLongPress);
                        contactItem.addEventListener('touchmove', cancelLongPress);
                        
                        // Èº†Ê†á‰∫ã‰ª∂Ôºà‰Ωú‰∏∫Â§áÈÄâÔºâ
                        contactItem.addEventListener('mousedown', startLongPress);
                        contactItem.addEventListener('mouseup', cancelLongPress);
                        contactItem.addEventListener('mouseleave', cancelLongPress);
                        
                        // Âè≥ÈîÆÁÇπÂáª
                        contactItem.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            // Âè≥ÈîÆÁõ¥Êé•ÂºπÂá∫ÁßªÂä®ËßíËâ≤Ê®°ÊÄÅÊ°Ü
                            showMoveCharacterModal(character.id);
                        });
                    }
                    
                    contactItem.innerHTML = `
                        ${isMultiSelectMode ? `
                            <div class="selection-checkbox ${selectedCharacters.includes(character.id) ? 'selected' : ''}">
                                ${selectedCharacters.includes(character.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                            </div>
                        ` : ''}
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : displayName.charAt(0)}
                        </div>
                        <div class="contact-info">
                            <div class="message-name">${displayName}</div>
                            <div class="character-preview">${truncateText(character.bio || 'ÊöÇÊó†‰∫∫ËÆæÊèèËø∞', 25)}</div>
                        </div>
                        ${isGroupManageMode ? `
                            <div class="move-character-btn" onclick="showMoveCharacterModal('${character.id}')" title="ÁßªÂä®Âà∞ÂÖ∂‰ªñÂàÜÁªÑ">
                                <i class="fas fa-arrows-alt"></i>
                            </div>
                        ` : ''}
                    `;
                    
                    charactersContainer.appendChild(contactItem);
                });
                
                // Â¶ÇÊûúÂàÜÁªÑÊ≤°ÊúâËßíËâ≤ÔºåÊòæÁ§∫ÊèêÁ§∫
                if (groupCharacters.length === 0 && isGroupManageMode) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-group-message';
                    emptyDiv.textContent = 'ËØ•ÂàÜÁªÑÊöÇÊó†ËßíËâ≤';
                    charactersContainer.appendChild(emptyDiv);
                }
                
                contactList.appendChild(charactersContainer);
            });
            
            // Â¶ÇÊûúÂÆåÂÖ®Ê≤°ÊúâËßíËâ≤ÔºåÊòæÁ§∫ÊèêÁ§∫
            if (characters.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-message';
                emptyDiv.textContent = 'ËøòÊ≤°ÊúâËßíËâ≤ÔºåÁÇπÂáªÂè≥‰∏äËßí+Âè∑ÂàõÂª∫ËßíËâ≤ÂêßÔºÅ';
                contactList.appendChild(emptyDiv);
            }
        }

        // === ÂàÜÁªÑÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞ ===
        function enterGroupManageMode() {
            isGroupManageMode = true;
            renderContactList();
            
            // ÈöêËóèÁÆ°ÁêÜÂàÜÁªÑÊåâÈíÆ
            const groupManageBtn = document.getElementById('group-manage-btn');
            if (groupManageBtn) {
                groupManageBtn.style.display = 'none';
            }
        }

        function exitGroupManageMode() {
            isGroupManageMode = false;
            renderContactList();
            
            // ÊòæÁ§∫ÁÆ°ÁêÜÂàÜÁªÑÊåâÈíÆ
            const groupManageBtn = document.getElementById('group-manage-btn');
            if (groupManageBtn) {
                groupManageBtn.style.display = 'flex';
            }
        }

        function toggleGroupCollapse(groupId) {
            const container = document.getElementById(`group-characters-${groupId}`);
            if (!container) return;
            
            const isCollapsed = container.style.display === 'none';
            container.style.display = isCollapsed ? 'block' : 'none';
            
            // ‰øùÂ≠òÊäòÂè†Áä∂ÊÄÅ
            localStorage.setItem(`group_collapsed_${groupId}`, !isCollapsed);
            
            // Êõ¥Êñ∞ÁÆ≠Â§¥ÊñπÂêë
            const chevron = document.querySelector(`[onclick="toggleGroupCollapse('${groupId}')"] .group-chevron`);
            if (chevron) {
                chevron.className = `fas fa-chevron-${isCollapsed ? 'down' : 'right'} group-chevron`;
            }
        }

        function showCreateGroupModal() {
            const modalHtml = `
                <div id="create-group-modal" class="modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Êñ∞Âª∫ÂàÜÁªÑ</div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>ÂàÜÁªÑÂêçÁß∞</label>
                                <input type="text" id="new-group-name" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="new-group-interaction" class="form-checkbox"> 
                                    ÂÖÅËÆ∏ËØ•ÂàÜÁªÑËßíËâ≤Âú®Âä®ÊÄÅ‰∏≠‰∫íÂä®
                                </label>
                                <p class="form-help-text">ÂºÄÂêØÂêéÔºåËØ•ÂàÜÁªÑÁöÑËßíËâ≤ÂèØ‰ª•Âú®Âä®ÊÄÅÈ°µÈù¢Áõ∏‰∫íÁÇπËµû„ÄÅËØÑËÆ∫</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideCreateGroupModal()">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="createNewGroup()">ÂàõÂª∫</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('new-group-name').focus();
            }, 100);
        }

        function hideCreateGroupModal() {
            const modal = document.getElementById('create-group-modal');
            if (modal) modal.remove();
        }

        async function createNewGroup() {
            const nameInput = document.getElementById('new-group-name');
            const interactionCheckbox = document.getElementById('new-group-interaction');
            
            const name = nameInput.value.trim();
            if (!name) {
                alert('ËØ∑ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞');
                nameInput.focus();
                return;
            }
            
            // Ê£ÄÊü•ÈáçÂêç
            if (characterGroups.find(g => g.name === name)) {
                alert('ÂàÜÁªÑÂêçÁß∞Â∑≤Â≠òÂú®');
                nameInput.focus();
                return;
            }
            
            const newGroup = {
                id: 'group_' + Date.now(),
                name: name,
                order: characterGroups.length + 1,
                isDefault: false,
                canInteract: interactionCheckbox.checked
            };
            
            characterGroups.push(newGroup);
            await saveCharacterGroups();
            
            hideCreateGroupModal();
            renderContactList();
            showToast('ÂàÜÁªÑÂàõÂª∫ÊàêÂäü', 'success');
        }

        function editGroup(groupId) {
            const group = characterGroups.find(g => g.id === groupId);
            if (!group || group.isDefault) return;
            
            const modalHtml = `
                <div id="edit-group-modal" class="modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÁºñËæëÂàÜÁªÑ</div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>ÂàÜÁªÑÂêçÁß∞</label>
                                <input type="text" id="edit-group-name" class="form-input" value="${group.name}" maxlength="10">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="edit-group-interaction" class="form-checkbox" ${group.canInteract ? 'checked' : ''}> 
                                    ÂÖÅËÆ∏ËØ•ÂàÜÁªÑËßíËâ≤Âú®Âä®ÊÄÅ‰∏≠‰∫íÂä®
                                </label>
                                <p class="form-help-text">ÂºÄÂêØÂêéÔºåËØ•ÂàÜÁªÑÁöÑËßíËâ≤ÂèØ‰ª•Âú®Âä®ÊÄÅÈ°µÈù¢Áõ∏‰∫íÁÇπËµû„ÄÅËØÑËÆ∫</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideEditGroupModal()">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="updateGroup('${groupId}')">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('edit-group-name').focus();
            }, 100);
        }

        function hideEditGroupModal() {
            const modal = document.getElementById('edit-group-modal');
            if (modal) modal.remove();
        }

        async function updateGroup(groupId) {
            const nameInput = document.getElementById('edit-group-name');
            const interactionCheckbox = document.getElementById('edit-group-interaction');
            
            const name = nameInput.value.trim();
            if (!name) {
                alert('ËØ∑ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞');
                nameInput.focus();
                return;
            }
            
            // Ê£ÄÊü•ÈáçÂêçÔºàÊéíÈô§Ëá™Â∑±Ôºâ
            if (characterGroups.find(g => g.name === name && g.id !== groupId)) {
                alert('ÂàÜÁªÑÂêçÁß∞Â∑≤Â≠òÂú®');
                nameInput.focus();
                return;
            }
            
            const groupIndex = characterGroups.findIndex(g => g.id === groupId);
            if (groupIndex !== -1) {
                characterGroups[groupIndex].name = name;
                characterGroups[groupIndex].canInteract = interactionCheckbox.checked;
                
                await saveCharacterGroups();
                
                hideEditGroupModal();
                renderContactList();
                showToast('ÂàÜÁªÑÊõ¥Êñ∞ÊàêÂäü', 'success');
            }
        }

        async function deleteGroup(groupId) {
            const group = characterGroups.find(g => g.id === groupId);
            if (!group || group.isDefault) return;
            
            const groupCharacters = characters.filter(char => char.groupId === groupId);
            
            let confirmMsg = `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁªÑ"${group.name}"ÂêóÔºü`;
            if (groupCharacters.length > 0) {
                confirmMsg += `\n\nËØ•ÂàÜÁªÑ‰∏ãÊúâ ${groupCharacters.length} ‰∏™ËßíËâ≤ÔºåÂ∞ÜË¢´ÁßªÂä®Âà∞"ÊàëÁöÑÂ•ΩÂèã"ÂàÜÁªÑ„ÄÇ`;
            }
            
            if (!confirm(confirmMsg)) return;
            
            // Â∞ÜËØ•ÂàÜÁªÑÁöÑËßíËâ≤ÁßªÂä®Âà∞ÈªòËÆ§ÂàÜÁªÑ
            groupCharacters.forEach(character => {
                character.groupId = 'my_friends';
            });
            
            // Âà†Èô§ÂàÜÁªÑ
            const groupIndex = characterGroups.findIndex(g => g.id === groupId);
            if (groupIndex !== -1) {
                characterGroups.splice(groupIndex, 1);
            }
            
            await Promise.all([
                saveCharacterGroups(),
                saveCharacters()
            ]);
            
            renderContactList();
            showToast('ÂàÜÁªÑÂà†Èô§ÊàêÂäü', 'success');
        }

        function showMoveCharacterModal(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;
            
            const availableGroups = characterGroups.filter(g => g.id !== character.groupId);
            
            const modalHtml = `
                <div id="move-character-modal" class="modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÁßªÂä®ËßíËâ≤Ôºö${character.name}</div>
                        </div>
                        <div class="modal-body">
                            <div class="group-list">
                                ${availableGroups.map(group => `
                                    <div class="group-option" onclick="moveCharacterToGroup('${characterId}', '${group.id}')">
                                        <span class="group-name">${group.name}</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                <div class="group-option" onclick="hideMoveCharacterModal(); enterMultiSelectMode('${characterId}');" style="color: #007AFF;">
                                    <span class="group-name">
                                        <i class="fas fa-check-square" style="margin-right: 6px;"></i>
                                        ËøõÂÖ•Â§öÈÄâÊ®°Âºè
                                    </span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideMoveCharacterModal()">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function hideMoveCharacterModal() {
            const modal = document.getElementById('move-character-modal');
            if (modal) modal.remove();
        }

        async function moveCharacterToGroup(characterId, targetGroupId) {
            const characterIndex = characters.findIndex(c => c.id === characterId);
            if (characterIndex !== -1) {
                const oldGroupId = characters[characterIndex].groupId;
                characters[characterIndex].groupId = targetGroupId;
                
                await saveCharacters();
                hideMoveCharacterModal();
                renderContactList();
                
                const targetGroup = characterGroups.find(g => g.id === targetGroupId);
                showToast(`Â∑≤ÁßªÂä®Âà∞"${targetGroup.name}"ÂàÜÁªÑ`, 'success');
            }
        }

        function showMoveToGroupModal() {
            if (selectedCharacters.length === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁßªÂä®ÁöÑËßíËâ≤');
                return;
            }
            
            const modalHtml = `
                <div id="move-to-group-modal" class="modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÁßªÂä® ${selectedCharacters.length} ‰∏™ËßíËâ≤Âà∞ÂàÜÁªÑ</div>
                        </div>
                        <div class="modal-body">
                            <div class="group-list">
                                ${characterGroups.map(group => `
                                    <div class="group-option" onclick="moveSelectedCharactersToGroup('${group.id}')">
                                        <span class="group-name">${group.name}</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideMoveToGroupModal()">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function hideMoveToGroupModal() {
            const modal = document.getElementById('move-to-group-modal');
            if (modal) modal.remove();
        }

        async function moveSelectedCharactersToGroup(targetGroupId) {
            selectedCharacters.forEach(characterId => {
                const characterIndex = characters.findIndex(c => c.id === characterId);
                if (characterIndex !== -1) {
                    characters[characterIndex].groupId = targetGroupId;
                }
            });
            
            await saveCharacters();
            hideMoveToGroupModal();
            exitMultiSelectMode(); // ÈÄÄÂá∫Â§öÈÄâÊ®°Âºè
            
            const targetGroup = characterGroups.find(g => g.id === targetGroupId);
            showToast(`Â∑≤ÁßªÂä® ${selectedCharacters.length} ‰∏™ËßíËâ≤Âà∞"${targetGroup.name}"ÂàÜÁªÑ`, 'success');
        }
        
        // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
        function renderCharacterList() {
            const characterList = document.getElementById('character-list');
            // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®Â∞±Ë∑≥ËøáÔºàÂõ†‰∏∫Êàë‰ª¨Â∑≤ÁªèÂà†Èô§‰∫Ü‰∫∫Áâ©Â∫îÁî®Ôºâ
            if (!characterList) {
                console.log('character-listÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊ∏≤Êüì');
                return;
            }
            
            characterList.innerHTML = '';
            
            characters.forEach(character => {
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                characterItem.onclick = () => editCharacter(character.id);
                
                characterItem.innerHTML = `
                    <div class="character-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div class="character-info">
                        <div class="character-name">${character.name}</div>
                        <div class="character-bio">${truncateText(character.bio, 50)}</div>
                    </div>
                `;
                
                characterList.appendChild(characterItem);
            });
        }
        
        // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü
        function renderContactModal() {
            const modalBody = document.getElementById('contact-modal-body');
            modalBody.innerHTML = '';
            
            characters.forEach(character => {
                // Âè™ÊòæÁ§∫Êú™Ê∑ªÂä†‰∏∫ËÅîÁ≥ª‰∫∫ÁöÑËßíËâ≤
                if (!contacts.includes(character.id)) {
                    const contactOption = document.createElement('div');
                    contactOption.className = 'contact-item';
                    
                    const checkboxId = `contact-${character.id}`;
                    
                    contactOption.innerHTML = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="character-info character-info-flex">
                            <div class="character-name">${character.name}</div>
                            <div class="character-bio">${truncateText(character.bio, 40)}</div>
                        </div>
                        <input type="checkbox" id="${checkboxId}" class="contact-checkbox" value="${character.id}">
                    `;
                    
                    modalBody.appendChild(contactOption);
                }
            });
            
            if (modalBody.children.length === 0) {
                modalBody.innerHTML = '<p>Ê≤°ÊúâÂèØÊ∑ªÂä†ÁöÑËßíËâ≤ÔºåËØ∑ÂÖàÂàõÂª∫Êñ∞ËßíËâ≤„ÄÇ</p>';
            }
        }
        
        // ÂΩìÂâçÊòæÁ§∫ÁöÑÊ∂àÊÅØÊï∞ÈáèÈôêÂà∂
        let currentMessageOffset = 0;
        const MESSAGE_LIMIT = 50;
        
        // Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ
        function renderChatMessages(characterId, loadMore = false) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const allMessages = chatMessages[characterId] || [];
            const chatSettings = getCurrentChatSettings();
            
            if (!loadMore) {
                // ÈáçÊñ∞Ê∏≤ÊüìÊó∂Ê∏ÖÁ©∫ÂÆπÂô®Âπ∂ÈáçÁΩÆÂÅèÁßªÈáè
                messagesContainer.innerHTML = '';
                currentMessageOffset = Math.max(0, allMessages.length - MESSAGE_LIMIT);
            }
            
            // Â∫îÁî®ËÅäÂ§©ËÉåÊôØ
            applyChatBackground();
            
            // Â∫îÁî®Ê∞îÊ≥°Ê†∑Âºè
            applyBubbleStyle();
            
            // Â¶ÇÊûúÊ≤°ÊúâÊ∂àÊÅØÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅÊèêÁ§∫
            if (allMessages.length === 0) {
                const displayName = chatSettings.aiChatNickname || currentChatCharacter.name;
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-chat-state';
                emptyState.innerHTML = `
                    <div>ÂºÄÂßãÂíå ${displayName} ËÅäÂ§©Âêß</div>
                `;
                messagesContainer.appendChild(emptyState);
                return;
            }
            
            // Â¶ÇÊûú‰∏çÊòØÂä†ËΩΩÊõ¥Â§öÔºå‰∏îÊúâÊõ¥Â§öÂéÜÂè≤Ê∂àÊÅØÔºåÊòæÁ§∫"Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ"ÊåâÈíÆ
            if (!loadMore && currentMessageOffset > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-messages';
                loadMoreBtn.innerHTML = `
                    <div class="load-more-content">
                        <i class="fas fa-chevron-up"></i>
                        <span>Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ (${currentMessageOffset}Êù°)</span>
                    </div>
                `;
                loadMoreBtn.onclick = () => loadMoreMessages(characterId);
                messagesContainer.appendChild(loadMoreBtn);
            }
            
            // Ëé∑ÂèñË¶ÅÊòæÁ§∫ÁöÑÊ∂àÊÅØ
            const messagesToShow = loadMore ? 
                allMessages.slice(Math.max(0, currentMessageOffset - MESSAGE_LIMIT), currentMessageOffset) :
                allMessages.slice(currentMessageOffset);
            
            // Ëé∑ÂèñÊó∂Èó¥Êà≥ËÆæÁΩÆ
            const timestampEnabled = chatSettings.timestampEnabled !== false; // ÈªòËÆ§‰∏∫true
            const timestampPosition = chatSettings.timestampPosition || 'center';
            
            let lastTimestamp = 0;
            
            messagesToShow.forEach((message, index) => {
                // Â§ÑÁêÜÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÊà≥‰∏ÄÊà≥„ÄÅÂ§¥ÂÉèÊõ¥Êç¢„ÄÅÊí§ÂõûÁ≠âÔºâ
                if (message.sender === 'system') {
                    if (message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    systemContainer.appendChild(systemMessage);
                    messagesContainer.appendChild(systemContainer);
                    } else if (message.type === 'recalled_message') {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊí§ÂõûÊ∂àÊÅØÁöÑÊòæÁ§∫
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id; // üî•„Äê‰øÆÂ§ç„ÄëÊ∑ªÂä†Ê∂àÊÅØID‰ª•ÊîØÊåÅÈÄâÊã©
                        
                        const recallElement = document.createElement('div');
                        recallElement.className = 'recalled-message';
                        
                        // Ëß£ÊûêÊí§ÂõûÊ∂àÊÅØÂÜÖÂÆπÔºàÊ†ºÂºèÔºöxxx Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ\nÂéüÊñáÔºöxxxÔºâ
                        const lines = message.content.split('\n');
                        const mainText = lines[0]; // ‰∏ªË¶ÅÊèêÁ§∫ÊñáÂ≠ó
                        const originalText = lines[1]; // ÂéüÊñáÈÉ®ÂàÜ
                        
                        recallElement.textContent = mainText;
                        
                        // Â¶ÇÊûúÊúâÂéüÊñáÔºåÊ∑ªÂä†ÂéüÊñáÊòæÁ§∫
                        if (originalText && originalText.startsWith('ÂéüÊñáÔºö')) {
                            const originalDiv = document.createElement('div');
                            originalDiv.className = 'original-text';
                            originalDiv.textContent = originalText;
                            recallElement.appendChild(originalDiv);
                        }
                        
                        centerContainer.appendChild(recallElement);
                        messagesContainer.appendChild(centerContainer);
                        
                        // üî•„Äê‰øÆÂ§ç„Äë‰∏∫Êí§ÂõûÊ∂àÊÅØÊ∑ªÂä†ÈÄâÊã©ÂäüËÉΩ
                        addMessageLongPressListener(centerContainer, message.id);
                    } else if (message.type === 'call_record') {
                        // Â§ÑÁêÜÈÄöËØùËÆ∞ÂΩïÊ∂àÊÅØ
                        const centerContainer = document.createElement('div');
                        centerContainer.className = 'message-wrapper system';
                        centerContainer.dataset.messageId = message.id;
                        
                        const callRecordElement = document.createElement('div');
                        callRecordElement.className = 'call-record-message';
                        
                        // Ê†πÊçÆÈÄöËØùÁä∂ÊÄÅËÆæÁΩÆ‰∏çÂêåÁöÑÂõæÊ†áÂíåÊ†∑Âºè
                        const callIcon = document.createElement('i');
                        
                        if (message.callType === 'outgoing') {
                            callIcon.className = 'fas fa-phone-alt';
                        } else if (message.callType === 'incoming') {
                            if (message.callStatus === 'rejected') {
                                callIcon.className = 'fas fa-phone-slash';
                                callRecordElement.classList.add('missed');
                            } else {
                                callIcon.className = 'fas fa-phone';
                            }
                        } else if (message.callType === 'ended') {
                            callIcon.className = 'fas fa-phone';
                            callRecordElement.classList.add('completed');
                        }
                        
                        callRecordElement.appendChild(callIcon);
                        
                        const callTextElement = document.createElement('span');
                        callTextElement.textContent = message.content;
                        callRecordElement.appendChild(callTextElement);
                        
                        // Â¶ÇÊûúÊúâÈÄöËØùÊó∂ÈïøÔºåÂàôÊòæÁ§∫Ôºà‰ªÖÂú®callType‰∏∫endedÊó∂ÊòæÁ§∫Ôºâ
                        if (message.duration && message.callType === 'ended') {
                            const durationElement = document.createElement('span');
                            durationElement.className = 'call-record-duration';
                            durationElement.textContent = message.duration;
                            callRecordElement.appendChild(durationElement);
                        }
                        
                        centerContainer.appendChild(callRecordElement);
                        messagesContainer.appendChild(centerContainer);
                    } else if (message.type === 'call_message') {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÈÄöËØùÊ∂àÊÅØ - ÊòæÁ§∫‰∏∫ÁÆÄÂçïÁöÑÊñáÊú¨Ê∂àÊÅØ
                        const centerContainer = document.createElement('div');
                        centerContainer.className = 'message-wrapper system';
                        centerContainer.dataset.messageId = message.id;
                        
                        const callMessageElement = document.createElement('div');
                        callMessageElement.className = 'system-message';
                        callMessageElement.style.fontStyle = 'italic';
                        callMessageElement.style.color = '#888';
                        callMessageElement.textContent = `üìû ÈÄöËØù: ${message.content}`;
                        
                        centerContainer.appendChild(callMessageElement);
                        messagesContainer.appendChild(centerContainer);
                    } else {
                        // üî•„Äê‰øÆÂ§ç„ÄëÂÖ∂‰ªñÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÂ§¥ÂÉèÊõ¥Êç¢Ôºâ- ‰ΩøÁî®Â±Ö‰∏≠ÂÆπÂô®
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        
                        const systemContainer = document.createElement('div');
                        systemContainer.className = 'system-message';
                        systemContainer.textContent = message.content;
                        
                        centerContainer.appendChild(systemContainer);
                        messagesContainer.appendChild(centerContainer);
                    }
                    return;
                }
                
                // Ê∑ªÂä†Â±Ö‰∏≠Êó∂Èó¥Êà≥ÔºàÂ¶ÇÊûúÂêØÁî®‰∏î‰ΩçÁΩÆ‰∏∫Â±Ö‰∏≠Ôºâ
                if (timestampEnabled && timestampPosition === 'center') {
                    const currentTime = new Date(message.timestamp);
                    const timeDiff = currentTime - lastTimestamp;
                    
                    // Â¶ÇÊûúË∑ùÁ¶ª‰∏äÊù°Ê∂àÊÅØË∂ÖËøá5ÂàÜÈíüÔºåÊòæÁ§∫Êó∂Èó¥Êà≥
                    if (index === 0 || timeDiff > 5 * 60 * 1000) {
                        const timestampDiv = document.createElement('div');
                        timestampDiv.className = 'timestamp timestamp-center';
                        timestampDiv.textContent = formatTimestamp(message.timestamp);
                        messagesContainer.appendChild(timestampDiv);
                        lastTimestamp = currentTime;
                    }
                }
                
                const messageContainer = document.createElement('div');
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ∫ØË°®ÊÉÖÂåÖÊ∂àÊÅØ
                const isEmojiOnly = message.isEmoji && !message.content;
                messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
                messageContainer.dataset.messageId = message.id; // Ê∑ªÂä†Ê∂àÊÅØIDÊï∞ÊçÆÂ±ûÊÄß
                
                if (message.sender === 'received') {
                    // ==== Áæ§ËÅäÊîØÊåÅ ====
                    let character = characters.find(c => c.id === characterId);
                    let isGroup = false;
                    let group = null;
                    if (!character) {
                        group = groupChats.find(g => g.id === characterId);
                        if (group) {
                            isGroup = true;
                        }
                    }
                    
                    let displayAvatar = '';
                    let displayName = '';
                    let color = '#4CAF50';
                    
                    if (isGroup && group) {
                        // Áæ§ËÅäÔºöÊ†πÊçÆÊ∂àÊÅØÁöÑsenderIdÊàñnameÊü•ÊâæÊàêÂëò
                        let member = null;
                        if (message.senderId) {
                            member = group.members.find(m => m.id === message.senderId);
                        } else if (message.name) {
                            member = group.members.find(m => m.name === message.name);
                        }
                        displayAvatar = member?.avatarUrl || '';
                        displayName = member?.name || 'Áæ§ÊàêÂëò';
                        color = member?.color || '#4CAF50';
                    } else if (character) {
                        // ÂçïËÅä
                        displayAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || character.avatarUrl;
                        displayName = chatSettings.aiChatNickname || character.name;
                        color = character.color || '#4CAF50';
                    
                    // üî•„ÄêË∞ÉËØï„ÄëËÆ∞ÂΩïÂ§¥ÂÉèÈÄâÊã©ËøáÁ®ã
                    if (chatSettings.aiDynamicAvatar) {
                        console.log(`‰ΩøÁî®Âä®ÊÄÅÂ§¥ÂÉè: ${chatSettings.aiDynamicAvatar.substring(0, 30)}...`);
                    } else if (chatSettings.aiChatAvatar) {
                        console.log(`‰ΩøÁî®ËÅäÂ§©ËÆæÁΩÆÂ§¥ÂÉè: ${chatSettings.aiChatAvatar.substring(0, 30)}...`);
                    } else {
                        console.log(`‰ΩøÁî®ËßíËâ≤Âç°Â§¥ÂÉè: ${character.avatarUrl ? character.avatarUrl.substring(0, 30) + '...' : 'Êó†Â§¥ÂÉè'}`);
                    }
                    } else {
                        // ÂÖúÂ∫ïÔºåÈò≤Ê≠¢Êä•Èîô
                        displayAvatar = '';
                        displayName = 'Êú™Áü•';
                        color = '#4CAF50';
                    }
                    
                    // üî•„ÄêÊñ∞Â¢û„ÄëËé∑ÂèñÊ∞îÊ≥°Ê†∑Âºè - Áæ§ËÅä‰∏≠‰ΩøÁî®ÊàêÂëò‰∏ìÂ±ûÈ¢úËâ≤
                    let bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                    
                    // Â¶ÇÊûúÊòØÁæ§ËÅä‰∏îÊúâÊàêÂëò‰∏ìÂ±ûÈ¢úËâ≤ËÆæÁΩÆÔºå‰ΩøÁî®ÊàêÂëò‰∏ìÂ±ûÈ¢úËâ≤
                    if (isGroup && group && message.senderId && chatSettings.memberBubbleColors) {
                        const memberColor = chatSettings.memberBubbleColors[message.senderId];
                        if (memberColor) {
                            bubbleColor = memberColor;
                        }
                    }
                    
                    const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                    const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                    const bubblePadding = chatSettings.bubblePadding || '12';
                    
                    // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                    const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);
                    
                    // üî• Â§ÑÁêÜÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                    let messageContent = '';
                    
                    if (message.type === 'user_photo') {
                        // ËßíËâ≤ÂèëÈÄÅÁöÑ"‰º™ÁÖßÁâá" - ‰ΩøÁî®‰∏éÁî®Êà∑Áõ∏ÂêåÁöÑÁªìÊûÑ
                        messageContent = `
                            <div class="dreamy-photo-container" onclick="togglePhotoText(this, '${(message.photoDescription || message.content).replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">
                                <div class="dreamy-photo">
                                    <div class="photo-misty-bg"></div>
                                    <div class="photo-badge">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <div class="sparkle-container">
                                        <div class="sparkle sparkle-1">‚ú®</div>
                                        <div class="sparkle sparkle-2">‚≠ê</div>
                                        <div class="sparkle sparkle-3">‚ú®</div>
                                        <div class="sparkle sparkle-4">‚≠ê</div>
                                        <div class="sparkle sparkle-5">üí´</div>
                                    </div>
                                    <div class="photo-text-overlay" style="display: none;">
                                        <div class="photo-description">${(message.photoDescription || message.content)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'location') {
                        // ËßíËâ≤ÂèëÈÄÅÁöÑ‰ΩçÁΩÆÊ∂àÊÅØ - ‰ΩøÁî®‰∏éÁî®Êà∑Áõ∏ÂêåÁöÑÁªìÊûÑ
                        messageContent = `
                            <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                                <div class="location-card-header">${message.locationName}</div>
                                <div class="location-card-map">
                                    <div class="map-background"></div>
                                    <div class="map-roads">
                                        <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                                        <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                                        <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                                    </div>
                                    <div class="map-buildings">
                                        <div class="building" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                                        <div class="building" style="top: 25%; left: 60%; width: 14px; height: 12px;"></div>
                                        <div class="building green" style="top: 50%; left: 15%; width: 8px; height: 8px;"></div>
                                        <div class="building" style="top: 70%; left: 70%; width: 10px; height: 8px;"></div>
                                        <div class="building green" style="top: 10%; left: 75%; width: 6px; height: 6px;"></div>
                                        <div class="building green" style="top: 75%; left: 25%; width: 7px; height: 7px;"></div>
                                    </div>
                                    <div class="map-marker">
                                        <div class="marker-pin">üìç</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'voice_message') {
                        // ËøáÊª§ÊéâÊã¨Âè∑‰∏≠ÁöÑÊèèËø∞ÊÄßÂÜÖÂÆπÔºå‰øùÁïôÂÆûÈôÖËØ¥ËØùÂÜÖÂÆπ
                        const cleanVoiceContent = message.content.replace(/\([^)]*\)\s*/g, '').trim();
                        const voiceDuration = message.duration || Math.max(1, Math.ceil(cleanVoiceContent.length / 8));
                        
                        // AIËØ≠Èü≥Ê∂àÊÅØ - ‰ΩøÁî®ÂíåÁî®Êà∑ËØ≠Èü≥Ê∂àÊÅØ‰∏ÄÊ†∑ÁöÑÁªìÊûÑ
                        messageContent = `
                            <div class="voice-message-container received">
                                <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${cleanVoiceContent}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${voiceDuration}"</div>
                                    ${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ""}
                                    </div>
                                </div>
                                <div class="voice-text-content">${cleanVoiceContent}</div>
                            </div>
                        `;
                    } else if (message.type === 'ai_image') {
                        // AIÁîüÊàêÁöÑÂõæÁâá
                        messageContent = `
                            <div class="ai-image-container">
                                <img src="${message.image}" class="message-image" onclick="showImage('${message.image}')" alt="AIÁîüÊàêÁöÑÂõæÁâá">
                                <div class="image-description">${message.imageDescription || ''}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // ËΩ¨Ë¥¶Ê∂àÊÅØ
                        const isUser = message.role === 'user';
                        const heartIcon = isUser ? 'üíï' : 'üíñ';
                        const titleText = isUser ? '‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶' : 'Êî∂Âà∞ËΩ¨Ë¥¶';
                        let cardClass = '';
                        let statusHtml = '';
                        let clickHandler = '';
                        
                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ' : 'Â∑≤Êî∂Ê¨æ'}</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤ÈÄÄÂõû' : 'Â∑≤ÈÄÄÂõû'}</div>`;
                            cardClass = 'rejected';
                        } else if (!isUser) {
                            // AIÂèëÊù•ÁöÑËΩ¨Ë¥¶‰∏îÊú™Â§ÑÁêÜÔºåÊ∑ªÂä†ÁÇπÂáªÂ§ÑÁêÜ
                            clickHandler = `onclick="showTransferConfirmDialog(${JSON.stringify(message).replace(/"/g, '&quot;')})"`;
                        }
                        
                        messageContent = `
                            <div class="transfer-message-container received">
                                <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}" ${clickHandler}>
                                    <div class="transfer-title">${heartIcon} ${titleText}</div>
                                    <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                    <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    } else {
                        // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                        const chatMode = chatSettings.chatMode || 'online';
                        let processedContent = message.content;

                        if (chatMode === 'offline') {
                            processedContent = processOfflineContent(message.content);
                        }

                        // Â§ÑÁêÜ@ÂÜÖÂÆπ
                        processedContent = processMentions(processedContent);

                        messageContent = processedContent;
                    }
                    
                    let avatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        avatarHtml = `
                            <div class="message-avatar" style="background-color: ${color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" ${character ? `onclick="pokeCharacter('${character.id}')" title="Êà≥‰∏ÄÊà≥"` : `title="${displayName}"`}>
                                ${displayAvatar ? '' : displayName.charAt(0)}
                                ${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    let bubbleHtml = '';
                    if (message.type === 'voice_message' || message.type === 'transfer' || message.type === 'user_photo' || message.type === 'location') {
                        // ËØ≠Èü≥Ê∂àÊÅØ„ÄÅËΩ¨Ë¥¶Ê∂àÊÅØ„ÄÅÁÖßÁâáÂíå‰ΩçÁΩÆÊ∂àÊÅØ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑÊ∞îÊ≥°ÂåÖË£π
                        bubbleHtml = messageContent;
                    } else {
                        // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                        bubbleHtml = `
                                                    <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                ${messageContent}
                                ${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                                ${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ''}
                                ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                    `;
                    }
                    
      // üî•„Äê‰øÆÂ§ç„ÄëÁæ§ËÅäÊòµÁß∞ÊòæÁ§∫ - ÁâπÂà´Â§ÑÁêÜËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØ
      if (isGroup && group && displayName !== 'Áæ§ÊàêÂëò') {
    messageContainer.classList.add('group-message-item');
    const senderNameHtml = `<div class="sender-name">${displayName}</div>`;
    
    if (message.type === 'voice_message' || message.type === 'transfer') {
        // üî•„Äê‰øÆÂ§ç„ÄëÂØπ‰∫éËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØÔºåÊòµÁß∞ÈúÄË¶ÅÂú®ÂÆπÂô®Â§ñÈÉ®
    messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    } else {
        // ÊôÆÈÄöÊ∂àÊÅØÁöÑÂ§ÑÁêÜ
        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    }
} else {
                    messageContainer.innerHTML = avatarHtml + bubbleHtml;
}
                } else {
                    // Ëé∑ÂèñÊàëÁöÑÊòæÁ§∫Â§¥ÂÉèÂíåÊ∞îÊ≥°Ê†∑Âºè
let myDisplayAvatar = chatSettings.myChatAvatar; // ‰ºòÂÖà‰ΩøÁî®ËÅäÂ§©‰∏ìÂ±ûËÆæÁΩÆÈáåÁöÑÂ§¥ÂÉè
let myDisplayName = chatSettings.myChatNickname; // ‰ºòÂÖà‰ΩøÁî®ËÅäÂ§©‰∏ìÂ±ûËÆæÁΩÆÈáåÁöÑÊòµÁß∞
                    
// Â¶ÇÊûú‰∏ìÂ±ûËÆæÁΩÆÈáåÊ≤°ÊúâÔºåÂàôËøõË°å‰∫åÊ¨°Êü•ÊâæÔºà‰Ωú‰∏∫‰øùÈô©Êé™ÊñΩÔºâ
if ((!myDisplayAvatar || !myDisplayName) && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    if (selectedPersona) {
        // Â¶ÇÊûúÂ§¥ÂÉè‰∏∫Á©∫ÔºåÂàô‰ΩøÁî®Ë∫´‰ªΩÂ§¥ÂÉè
        if (!myDisplayAvatar) myDisplayAvatar = selectedPersona.avatarUrl;
        // Â¶ÇÊûúÊòµÁß∞‰∏∫Á©∫ÔºåÂàô‰ΩøÁî®Ë∫´‰ªΩÊòµÁß∞
        if (!myDisplayName) myDisplayName = selectedPersona.name;
                        }
                    }
                    
                    const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                    const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                    const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                    const myBubblePadding = chatSettings.bubblePadding || '12';
                    
                    // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                    const transparentMyBubbleColor = convertColorWithOpacity(myBubbleColor, myBubbleOpacity);
                    
                    // Â§ÑÁêÜÁî®Êà∑ÁöÑÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                    let myMessageContent = '';
                    if (message.type === 'user_photo') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑ"ÁÖßÁâá"ÔºàÊñáÂ≠óÊèèËø∞Ôºâ
                        myMessageContent = `
                            <div class="dreamy-photo-container" onclick="togglePhotoText(this, '${(message.photoDescription || message.content).replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">
                                <div class="dreamy-photo">
                                    <div class="photo-misty-bg"></div>
                                    <div class="photo-badge">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <div class="sparkle-container">
                                        <div class="sparkle sparkle-1">‚ú®</div>
                                        <div class="sparkle sparkle-2">‚≠ê</div>
                                        <div class="sparkle sparkle-3">‚ú®</div>
                                        <div class="sparkle sparkle-4">‚≠ê</div>
                                        <div class="sparkle sparkle-5">üí´</div>
                                    </div>
                                    <div class="photo-text-overlay" style="display: none;">
                                        <div class="photo-description">${(message.photoDescription || message.content)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'voice') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑËØ≠Èü≥Ê∂àÊÅØ
                        myMessageContent = `
                            <div class="voice-message-container sent">
                                <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${message.duration || Math.max(1, Math.ceil(message.content.length / 8))}"</div>
                                    ${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ""}
                                    </div>
                                    ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                    ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                </div>
                                <div class="voice-text-content">${message.content}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // Áî®Êà∑ËΩ¨Ë¥¶Ê∂àÊÅØ - Âú®renderChatMessages‰∏≠Â§ÑÁêÜ
                        let cardClass = '';
                        let statusHtml = '';
                        
                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤Êî∂Ê¨æ</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤ÈÄÄÂõû</div>`;
                            cardClass = 'rejected';
                        }
                        
                        myMessageContent = `
                            <div class="transfer-message-container sent">
                                <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}">
                                    <div class="transfer-title">üíï ‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶</div>
                                    <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                    <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'location') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑ‰ΩçÁΩÆÊ∂àÊÅØ
                        myMessageContent = `
                            <div class="location-message-container sent">
                                <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                                    <div class="location-card-header">${message.locationName}</div>
                                    <div class="location-card-map">
                                        <div class="map-background"></div>
                                        <div class="map-roads">
                                            <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                                            <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                                            <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                                        </div>
                                        <div class="map-buildings">
                                            <div class="building" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                                            <div class="building" style="top: 25%; left: 60%; width: 14px; height: 12px;"></div>
                                            <div class="building green" style="top: 50%; left: 15%; width: 8px; height: 8px;"></div>
                                            <div class="building" style="top: 70%; left: 70%; width: 10px; height: 8px;"></div>
                                            <div class="building green" style="top: 10%; left: 75%; width: 6px; height: 6px;"></div>
                                            <div class="building green" style="top: 75%; left: 25%; width: 7px; height: 7px;"></div>
                                        </div>
                                        <div class="map-marker">
                                            <div class="marker-pin">üìç</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØÊàñÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                        if (Array.isArray(message.content)) {
                            // Êñ∞ÁöÑÂ§öÊ®°ÊÄÅÊ†ºÂºè
                            const textPart = message.content.find(p => p.type === 'text');
                            const imagePart = message.content.find(p => p.type === 'image_url');
                            
                            myMessageContent = textPart?.text || '';
                            
                            // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáÊòæÁ§∫
                            if (imagePart?.image_url?.url) {
                                if (myMessageContent) {
                                    myMessageContent += '<br>';
                                }
                                myMessageContent += `<img src="${imagePart.image_url.url}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${imagePart.image_url.url}')">`;
                            }
                        } else {
                            // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØÊàñÊóßÊ†ºÂºè
                            let baseContent = message.content;
                            // Â§ÑÁêÜ@ÂÜÖÂÆπ
                            baseContent = processMentions(baseContent);
                            myMessageContent = baseContent;
                        }
                    }
                    
                    let myBubbleHtml = '';
                    
                    if (message.type === 'user_photo' || message.type === 'voice' || message.type === 'transfer' || message.type === 'location') {
                        // Áî®Êà∑ÁÖßÁâá„ÄÅËØ≠Èü≥Ê∂àÊÅØ„ÄÅËΩ¨Ë¥¶Ê∂àÊÅØÂíå‰ΩçÁΩÆÊ∂àÊÅØ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÊ∞îÊ≥°ÂåÖË£πÔºàÂ∑≤ÁªèÊúâËá™Â∑±ÁöÑÂÆπÂô®Ôºâ
                        myBubbleHtml = myMessageContent;
                    } else {
                        // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                        myBubbleHtml = `
                            <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                ${myMessageContent}
                                ${message.image && !message.type && !Array.isArray(message.content) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                                ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    let myAvatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        myAvatarHtml = `
                            <div class="message-avatar" style="background-color: #007AFF; ${myDisplayAvatar ? `background-image: url(${myDisplayAvatar}); background-size: cover; background-position: center;` : ''}">
                                ${myDisplayAvatar ? '' : '<i class="fas fa-user"></i>'}
                                ${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                }
                
                // Ê∑ªÂä†ÊªëÂÖ•Âä®ÁîªÊïàÊûú - ÂèÇËÄÉÂÆåÊàê.htmlÁöÑÂºπÊÄßÂä®Áîª
                messageContainer.style.opacity = '0';
                messageContainer.style.transform = 'translateY(20px)';
                messageContainer.style.transition = 'opacity 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                
                messagesContainer.appendChild(messageContainer);
                
                // Ëß¶ÂèëÊªëÂÖ•Âä®Áîª
                requestAnimationFrame(() => {
                    messageContainer.style.opacity = '1';
                    messageContainer.style.transform = 'translateY(0)';
                });
                
                // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®Áî®‰∫éÂ§öÈÄâÂà†Èô§
                addMessageLongPressListener(messageContainer, message.id);
                
                // Ê∑ªÂä†Âè≥ÈîÆËèúÂçïÂäüËÉΩ
                const bubble = messageContainer.querySelector('.message-bubble');
                if (bubble) {
                    // Èº†Ê†áÂè≥ÈîÆÁÇπÂáª
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showMessageMenu(message.id, e);
                    });
                    
                    // ÁÇπÂáªÂõæÁâáÈ¢ÑËßà
                    bubble.onclick = (e) => {
                        if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                            showImage(e.target.src);
                        }
                    };
                }
            });
            
            // Ê∑ªÂä†Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫ÂÖÉÁ¥†Âà∞Ê∂àÊÅØÂ∫ïÈÉ®ÔºàÂàùÂßãÈöêËóèÔºâ
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `${chatSettings.aiChatNickname || currentChatCharacter.name}Ê≠£Âú®ËæìÂÖ•‰∏≠<span class="dots"></span>`;
            messagesContainer.appendChild(typingIndicator);
            
            // Â¶ÇÊûú‰∏çÊòØÂä†ËΩΩÊõ¥Â§öÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
            if (!loadMore) {
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }
            
            // üî•„Äê‰øÆÂ§ç„Äë‰ΩçÁΩÆÊ∂àÊÅØÊ∞îÊ≥°ÂåÖË£ÖÈóÆÈ¢ò - ‰øÆÂ§çÂ∑≤Ê∏≤ÊüìÁöÑ‰ΩçÁΩÆÊ∂àÊÅØ
            setTimeout(() => {
                const locationMessages = messagesContainer.querySelectorAll('.message-container.sent');
                locationMessages.forEach(container => {
                    const locationCard = container.querySelector('.location-card');
                    if (locationCard && container.querySelector('.message-bubble')) {
                        // Â¶ÇÊûú‰ΩçÁΩÆÂç°ÁâáË¢´ÂåÖË£πÂú®Ê∞îÊ≥°‰∏≠ÔºåÊèêÂèñÂá∫Êù•
                        const bubble = container.querySelector('.message-bubble');
                        const avatar = container.querySelector('.message-avatar');
                        if (bubble && locationCard.closest('.message-bubble')) {
                            const locationContainer = locationCard.closest('.location-message-container');
                            if (locationContainer) {
                                container.innerHTML = locationContainer.outerHTML + (avatar ? avatar.outerHTML : '');
                            }
                        }
                    }
                });
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÊ∏≤ÊüìËßíËâ≤Áä∂ÊÄÅÊòæÁ§∫ - Âú®Ê∂àÊÅØÊ∏≤ÊüìÂÆåÊàêÂêéÊõ¥Êñ∞Áä∂ÊÄÅ
                if (currentChatCharacter) {
                    const headerContainer = document.querySelector('#api-chat-screen .header');
                    if (headerContainer) {
                        renderCharacterStatus(currentChatCharacter.id, headerContainer);
                    }
                }
            }, 50);
        }
        
        // Âä†ËΩΩÊõ¥Â§öÂéÜÂè≤Ê∂àÊÅØ
        function loadMoreMessages(characterId) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const allMessages = chatMessages[characterId] || [];
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÊªöÂä®‰ΩçÁΩÆ
            const scrollHeight = messagesContainer.scrollHeight;
            const scrollTop = messagesContainer.scrollTop;
            
            // ËÆ°ÁÆóË¶ÅÂä†ËΩΩÁöÑÂéÜÂè≤Ê∂àÊÅØËåÉÂõ¥
            const newOffset = Math.max(0, currentMessageOffset - MESSAGE_LIMIT);
            const historicalMessages = allMessages.slice(newOffset, currentMessageOffset);
            
            // ÁßªÈô§Áé∞ÊúâÁöÑ"Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ"ÊåâÈíÆ
            const existingLoadMoreBtn = messagesContainer.querySelector('.load-more-messages');
            if (existingLoadMoreBtn) {
                existingLoadMoreBtn.remove();
            }
            
            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÂéÜÂè≤Ê∂àÊÅØÔºåÂú®È°∂ÈÉ®Ê∑ªÂä†Êñ∞ÁöÑ"Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ"ÊåâÈíÆ
            if (newOffset > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-messages';
                loadMoreBtn.innerHTML = `
                    <div class="load-more-content">
                        <i class="fas fa-chevron-up"></i>
                        <span>Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ (${newOffset}Êù°)</span>
                    </div>
                `;
                loadMoreBtn.onclick = () => loadMoreMessages(characterId);
                messagesContainer.insertBefore(loadMoreBtn, messagesContainer.firstChild);
            }
            
            // Âú®Áé∞ÊúâÊ∂àÊÅØÂâçÈù¢ÊèíÂÖ•ÂéÜÂè≤Ê∂àÊÅØ
            const timestampEnabled = chatSettings.timestampEnabled !== false;
            const timestampPosition = chatSettings.timestampPosition || 'center';
            let lastTimestamp = 0;
            
            // ‰ªéÂêéÂæÄÂâçÊèíÂÖ•Ôºå‰øùÊåÅÊó∂Èó¥È°∫Â∫è
            for (let i = historicalMessages.length - 1; i >= 0; i--) {
                const message = historicalMessages[i];
                
                // Â§ÑÁêÜÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÊà≥‰∏ÄÊà≥„ÄÅÂ§¥ÂÉèÊõ¥Êç¢„ÄÅÊí§ÂõûÁ≠âÔºâ
                if (message.sender === 'system') {
                    let containerToInsert;
                    
                    if (message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    systemContainer.appendChild(systemMessage);
                        containerToInsert = systemContainer;
                    } else if (message.type === 'recalled_message') {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊí§ÂõûÊ∂àÊÅØÁöÑÊòæÁ§∫
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id; // üî•„Äê‰øÆÂ§ç„ÄëÊ∑ªÂä†Ê∂àÊÅØID‰ª•ÊîØÊåÅÈÄâÊã©
                        
                        const recallElement = document.createElement('div');
                        recallElement.className = 'recalled-message';
                        
                        // Ëß£ÊûêÊí§ÂõûÊ∂àÊÅØÂÜÖÂÆπÔºàÊ†ºÂºèÔºöxxx Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ\nÂéüÊñáÔºöxxxÔºâ
                        const lines = message.content.split('\n');
                        const mainText = lines[0]; // ‰∏ªË¶ÅÊèêÁ§∫ÊñáÂ≠ó
                        const originalText = lines[1]; // ÂéüÊñáÈÉ®ÂàÜ
                        
                        recallElement.textContent = mainText;
                        
                        // Â¶ÇÊûúÊúâÂéüÊñáÔºåÊ∑ªÂä†ÂéüÊñáÊòæÁ§∫
                        if (originalText && originalText.startsWith('ÂéüÊñáÔºö')) {
                            const originalDiv = document.createElement('div');
                            originalDiv.className = 'original-text';
                            originalDiv.textContent = originalText;
                            recallElement.appendChild(originalDiv);
                        }
                        
                        centerContainer.appendChild(recallElement);
                        containerToInsert = centerContainer;
                    } else {
                        // üî•„Äê‰øÆÂ§ç„ÄëÂÖ∂‰ªñÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÂ§¥ÂÉèÊõ¥Êç¢Ôºâ- ‰ΩøÁî®Â±Ö‰∏≠ÂÆπÂô®
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        
                        const systemContainer = document.createElement('div');
                        systemContainer.className = 'system-message';
                        systemContainer.textContent = message.content;
                        
                        centerContainer.appendChild(systemContainer);
                        containerToInsert = centerContainer;
                    }
                    
                    // ÊèíÂÖ•Âà∞ÊåâÈíÆÂêéÈù¢ÔºàÂ¶ÇÊûúÊúâÊåâÈíÆÁöÑËØùÔºâ
                    const insertAfter = messagesContainer.querySelector('.load-more-messages');
                    if (insertAfter) {
                        insertAfter.parentNode.insertBefore(containerToInsert, insertAfter.nextSibling);
                    } else {
                        messagesContainer.insertBefore(containerToInsert, messagesContainer.firstChild);
                    }
                    
                    // üî•„Äê‰øÆÂ§ç„Äë‰∏∫Êí§ÂõûÊ∂àÊÅØÊ∑ªÂä†ÈÄâÊã©ÂäüËÉΩ
                    if (message.type === 'recalled_message') {
                        addMessageLongPressListener(containerToInsert, message.id);
                    }
                    
                    continue;
                }
                
                const messageContainer = document.createElement('div');
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ∫ØË°®ÊÉÖÂåÖÊ∂àÊÅØ
                const isEmojiOnly = message.isEmoji && !message.content;
                messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
                messageContainer.dataset.messageId = message.id;
                
                if (message.sender === 'received') {
                    // ==== Áæ§ËÅäÊîØÊåÅ ====
                    let character = characters.find(c => c.id === characterId);
                    let isGroup = false;
                    let group = null;
                    if (!character) {
                        group = groupChats.find(g => g.id === characterId);
                        if (group) {
                            isGroup = true;
                        }
                    }
                    
                    let displayAvatar = '';
                    let displayName = '';
                    let color = '#4CAF50';
                    
                    if (isGroup && group) {
                        // Áæ§ËÅäÔºöÊ†πÊçÆÊ∂àÊÅØÁöÑsenderIdÊàñnameÊü•ÊâæÊàêÂëò
                        let member = null;
                        if (message.senderId) {
                            member = group.members.find(m => m.id === message.senderId);
                        } else if (message.name) {
                            member = group.members.find(m => m.name === message.name);
                        }
                        displayAvatar = member?.avatarUrl || '';
                        displayName = member?.name || 'Áæ§ÊàêÂëò';
                        color = member?.color || '#4CAF50';
                    } else if (character) {
                        // ÂçïËÅä
                        displayAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || character.avatarUrl;
                        displayName = chatSettings.aiChatNickname || character.name;
                        color = character.color || '#4CAF50';
                    } else {
                        // ÂÖúÂ∫ïÔºåÈò≤Ê≠¢Êä•Èîô
                        displayAvatar = '';
                        displayName = 'Êú™Áü•';
                        color = '#4CAF50';
                    }
                    // üî•„ÄêÊñ∞Â¢û„ÄëËé∑ÂèñÊ∞îÊ≥°Ê†∑Âºè - Áæ§ËÅä‰∏≠‰ΩøÁî®ÊàêÂëò‰∏ìÂ±ûÈ¢úËâ≤
                    let bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                    
                    // Â¶ÇÊûúÊòØÁæ§ËÅä‰∏îÊúâÊàêÂëò‰∏ìÂ±ûÈ¢úËâ≤ËÆæÁΩÆÔºå‰ΩøÁî®ÊàêÂëò‰∏ìÂ±ûÈ¢úËâ≤
                    if (isGroup && group && message.senderId && chatSettings.memberBubbleColors) {
                        const memberColor = chatSettings.memberBubbleColors[message.senderId];
                        if (memberColor) {
                            bubbleColor = memberColor;
                        }
                    }
                    
                    const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                    const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                    const bubblePadding = chatSettings.bubblePadding || '12';
                    
                    // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                    const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);
                    
                    let messageContent = '';
                    if (message.type === 'voice_message') {
                        // ËøáÊª§ÊéâÊã¨Âè∑‰∏≠ÁöÑÊèèËø∞ÊÄßÂÜÖÂÆπÔºå‰øùÁïôÂÆûÈôÖËØ¥ËØùÂÜÖÂÆπ
                        const cleanVoiceContent = message.content.replace(/\([^)]*\)\s*/g, '').trim();
                        const voiceDuration = message.duration || Math.max(1, Math.ceil(cleanVoiceContent.length / 8));
                        
                        messageContent = `
                            <div class="voice-message-container received">
                                <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${cleanVoiceContent}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${voiceDuration}"</div>
                                    ${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ""}
                                    </div>
                                </div>
                                <div class="voice-text-content">${cleanVoiceContent}</div>
                            </div>
                        `;
                    } else if (message.type === 'ai_image') {
                        messageContent = `<div class="ai-image-container"><img src="${message.image}" class="message-image" onclick="showImage('${message.image}')" alt="AIÁîüÊàêÁöÑÂõæÁâá"><div class="image-description">${message.imageDescription || ''}</div></div>`;
                    } else if (message.type === 'transfer') {
                        // ËΩ¨Ë¥¶Ê∂àÊÅØ
                        const isUser = message.role === 'user';
                        const heartIcon = isUser ? 'üíï' : 'üíñ';
                        const titleText = isUser ? '‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶' : 'Êî∂Âà∞ËΩ¨Ë¥¶';
                        let cardClass = '';
                        let statusHtml = '';
                        let clickHandler = '';
                        
                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ' : 'Â∑≤Êî∂Ê¨æ'}</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤ÈÄÄÂõû' : 'Â∑≤ÈÄÄÂõû'}</div>`;
                            cardClass = 'rejected';
                        } else if (!isUser) {
                            // AIÂèëÊù•ÁöÑËΩ¨Ë¥¶‰∏îÊú™Â§ÑÁêÜÔºåÊ∑ªÂä†ÁÇπÂáªÂ§ÑÁêÜ
                            clickHandler = `onclick="showTransferConfirmDialog(${JSON.stringify(message).replace(/"/g, '&quot;')})"`;
                        }
                        
                        messageContent = `<div class="transfer-message-container received"><div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}" ${clickHandler}><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div><div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>${statusHtml}</div></div>`;
                    } else {
                        const chatMode = chatSettings.chatMode || 'online';
                        let baseContent = chatMode === 'offline' ? processOfflineContent(message.content) : message.content;
                        
                        // Â¶ÇÊûúÊúâÂºïÁî®Ê∂àÊÅØÔºåÂú®ÂÜÖÂÆπÂâçÊ∑ªÂä†ÂºïÁî®ÊòæÁ§∫
                        if (message.replyTo) {
                            messageContent = generateReplyHTML(message.replyTo) + baseContent;
                        } else {
                            messageContent = baseContent;
                        }
                    }
                    
                    let avatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        avatarHtml = `<div class="message-avatar" style="background-color: ${color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" ${character ? `onclick="pokeCharacter('${character.id}')" title="Êà≥‰∏ÄÊà≥"` : `title="${displayName}"`}>${displayAvatar ? '' : displayName.charAt(0)}${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                    let bubbleHtml = '';
                    if (message.type === 'voice_message' || message.type === 'transfer') {
                        // ËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑÊ∞îÊ≥°ÂåÖË£π
                        bubbleHtml = messageContent;
                    } else {
                        // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                        bubbleHtml = `<div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">${messageContent}${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ''}${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                   // üî•„Äê‰øÆÂ§ç„ÄëÁæ§ËÅäÊòµÁß∞ÊòæÁ§∫ ÔºàloadMoreMessagesÁâàÊú¨Ôºâ- ÁâπÂà´Â§ÑÁêÜËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØ
                   if (isGroup && group && displayName !== 'Áæ§ÊàêÂëò') {
    messageContainer.classList.add('group-message-item');
    const senderNameHtml = `<div class="sender-name">${displayName}</div>`;
    
    if (message.type === 'voice_message' || message.type === 'transfer') {
        // üî•„Äê‰øÆÂ§ç„ÄëÂØπ‰∫éËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØÔºåÊòµÁß∞ÈúÄË¶ÅÂú®ÂÆπÂô®Â§ñÈÉ®
    messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    } else {
        // ÊôÆÈÄöÊ∂àÊÅØÁöÑÂ§ÑÁêÜ
        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    }
} else {
                    messageContainer.innerHTML = avatarHtml + bubbleHtml;
}
                } else {
                    let myDisplayAvatar = chatSettings.myChatAvatar;
                    if (!myDisplayAvatar && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona && selectedPersona.avatarUrl) {
                            myDisplayAvatar = selectedPersona.avatarUrl;
                        }
                    }
                    
                    const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                    const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                    const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                    const myBubblePadding = chatSettings.bubblePadding || '12';
                    
                    // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                    const transparentMyBubbleColor = convertColorWithOpacity(myBubbleColor, myBubbleOpacity);
                    
                    // Â§ÑÁêÜÁî®Êà∑ÁöÑÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                    let myMessageContent = '';
                    if (message.type === 'user_photo') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑ"ÁÖßÁâá"ÔºàÊñáÂ≠óÊèèËø∞Ôºâ
                        myMessageContent = `<div class="dreamy-photo-container" onclick="togglePhotoText(this, '${(message.photoDescription || message.content).replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')"><div class="dreamy-photo"><div class="photo-misty-bg"></div><div class="photo-badge"><i class="fas fa-image"></i></div><div class="sparkle-container"><div class="sparkle sparkle-1">‚ú®</div><div class="sparkle sparkle-2">‚≠ê</div><div class="sparkle sparkle-3">‚ú®</div><div class="sparkle sparkle-4">‚≠ê</div><div class="sparkle sparkle-5">üí´</div></div><div class="photo-text-overlay" style="display: none;"><div class="photo-description">${(message.photoDescription || message.content)}</div></div></div></div>`;
                    } else if (message.type === 'voice') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑËØ≠Èü≥Ê∂àÊÅØ
                        myMessageContent = `
                            <div class="voice-message-container sent">
                                <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                    <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                        <div class="voice-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <div class="voice-duration">${message.duration || Math.max(1, Math.ceil(message.content.length / 8))}"</div>
                                    ${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ""}
                                    </div>
                                    ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                    ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                                </div>
                                <div class="voice-text-content">${message.content}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // Áî®Êà∑ËΩ¨Ë¥¶Ê∂àÊÅØ - Âú®loadMoreMessages‰∏≠Â§ÑÁêÜ
                        let cardClass = '';
                        let statusHtml = '';
                        
                        if (message.status === 'accepted') {
                            statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤Êî∂Ê¨æ</div>`;
                            cardClass = 'accepted';
                        } else if (message.status === 'rejected') {
                            statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤ÈÄÄÂõû</div>`;
                            cardClass = 'rejected';
                        }
                        
                        myMessageContent = `
                            <div class="transfer-message-container sent">
                                <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}">
                                    <div class="transfer-title">üíï ‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶</div>
                                    <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                    <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                    ${statusHtml}
                                </div>
                            </div>
                        `;
                    } else if (message.type === 'location') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑ‰ΩçÁΩÆÊ∂àÊÅØ - Âú®loadMoreMessages‰∏≠Â§ÑÁêÜ
                        myMessageContent = `
                            <div class="location-message-container sent">
                                <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                                    <div class="location-card-header">${message.locationName}</div>
                                    <div class="location-card-map">
                                        <div class="map-background"></div>
                                        <div class="map-roads">
                                            <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                                            <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                                            <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                                        </div>
                                        <div class="map-buildings">
                                            <div class="building" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                                            <div class="building" style="top: 25%; left: 60%; width: 14px; height: 12px;"></div>
                                            <div class="building green" style="top: 50%; left: 15%; width: 8px; height: 8px;"></div>
                                            <div class="building" style="top: 70%; left: 70%; width: 10px; height: 8px;"></div>
                                            <div class="building green" style="top: 10%; left: 75%; width: 6px; height: 6px;"></div>
                                            <div class="building green" style="top: 75%; left: 25%; width: 7px; height: 7px;"></div>
                                        </div>
                                        <div class="map-marker">
                                            <div class="marker-pin">üìç</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØÊàñÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ (loadMoreMessagesÁâàÊú¨)
                        if (Array.isArray(message.content)) {
                            // Êñ∞ÁöÑÂ§öÊ®°ÊÄÅÊ†ºÂºè
                            const textPart = message.content.find(p => p.type === 'text');
                            const imagePart = message.content.find(p => p.type === 'image_url');
                            
                            let baseContent = textPart?.text || '';
                            
                            // Â¶ÇÊûúÊúâÂºïÁî®Ê∂àÊÅØÔºåÂú®ÂÜÖÂÆπÂâçÊ∑ªÂä†ÂºïÁî®ÊòæÁ§∫
                            if (message.replyTo) {
                                myMessageContent = generateReplyHTML(message.replyTo) + baseContent;
                            } else {
                                myMessageContent = baseContent;
                            }
                            
                            // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáÊòæÁ§∫
                            if (imagePart?.image_url?.url) {
                                if (myMessageContent) {
                                    myMessageContent += '<br>';
                                }
                                myMessageContent += `<img src="${imagePart.image_url.url}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${imagePart.image_url.url}')">`;
                            }
                        } else {
                            // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØÊàñÊóßÊ†ºÂºè (loadMoreMessagesÁâàÊú¨)
                            let baseContent = message.content;
                            
                            // Â¶ÇÊûúÊúâÂºïÁî®Ê∂àÊÅØÔºåÂú®ÂÜÖÂÆπÂâçÊ∑ªÂä†ÂºïÁî®ÊòæÁ§∫
                            if (message.replyTo) {
                                myMessageContent = generateReplyHTML(message.replyTo) + baseContent;
                            } else {
                                myMessageContent = baseContent;
                            }
                        }
                    }
                    
                    let myBubbleHtml = '';
                    
                    if (message.type === 'user_photo' || message.type === 'voice' || message.type === 'transfer' || message.type === 'location') {
                        // Áî®Êà∑ÁÖßÁâá„ÄÅËØ≠Èü≥Ê∂àÊÅØ„ÄÅËΩ¨Ë¥¶Ê∂àÊÅØÂíå‰ΩçÁΩÆÊ∂àÊÅØ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÊ∞îÊ≥°ÂåÖË£πÔºàÂ∑≤ÁªèÊúâËá™Â∑±ÁöÑÂÆπÂô®Ôºâ
                        myBubbleHtml = myMessageContent;
                    } else {
                        // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                        myBubbleHtml = `<div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">${myMessageContent}${message.image && !message.type && !Array.isArray(message.content) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ''}${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                    let myAvatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        myAvatarHtml = `<div class="message-avatar" style="background-color: #007AFF; ${myDisplayAvatar ? `background-image: url(${myDisplayAvatar}); background-size: cover; background-position: center;` : ''}">${myDisplayAvatar ? '' : '<i class="fas fa-user"></i>'}${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                    messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                }
                
                // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®ÂíåÂè≥ÈîÆËèúÂçï
                addMessageLongPressListener(messageContainer, message.id);
                const bubble = messageContainer.querySelector('.message-bubble');
                if (bubble) {
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showMessageMenu(message.id, e);
                    });
                    
                    bubble.onclick = (e) => {
                        if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                            showImage(e.target.src);
                        }
                    };
                }
                
                // ÊèíÂÖ•Ê∂àÊÅØÂà∞Ê≠£Á°Æ‰ΩçÁΩÆ
                const insertAfter = messagesContainer.querySelector('.load-more-messages');
                if (insertAfter) {
                    insertAfter.parentNode.insertBefore(messageContainer, insertAfter.nextSibling);
                } else {
                    messagesContainer.insertBefore(messageContainer, messagesContainer.firstChild);
                }
            }
            
            // Êõ¥Êñ∞ÂÅèÁßªÈáè
            currentMessageOffset = newOffset;
            
            // ‰øùÊåÅÊªöÂä®‰ΩçÁΩÆ
            setTimeout(() => {
                const newScrollHeight = messagesContainer.scrollHeight;
                messagesContainer.scrollTop = scrollTop + (newScrollHeight - scrollHeight);
            }, 50);
        }
        
        
        // ÊòæÁ§∫ËßíËâ≤Ë°®Âçï
        function showCharacterForm(characterId = null) {
            currentEditingCharacterId = characterId; // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑËßíËâ≤ID
            document.getElementById('character-form-title').textContent = characterId ? 'ÁºñËæë‰∫∫Áâ©' : 'Êñ∞Âª∫‰∫∫Áâ©';
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';
            
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');
            
            // ÈáçÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            avatarPreviewText.style.display = 'block';
            avatarPreviewText.textContent = 'A';
            
            // Ê∏ÖÈô§‰∏¥Êó∂Â≠òÂÇ®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
            window.selectedAvatarData = null;
            
            // Â¶ÇÊûúÊòØÁºñËæëÊ®°ÂºèÔºåÂ°´ÂÖÖÁé∞ÊúâÊï∞ÊçÆ
            if (characterId) {
                const character = characters.find(c => c.id === characterId);
                if (character) {
                    document.getElementById('character-name').value = character.name;
                    document.getElementById('character-bio').value = character.bio;
                    
                    if (character.avatarUrl) {
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${character.avatarUrl})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        avatarPreviewText.style.display = 'none';
                        // ‰∏∫ÁºñËæëÊ®°Âºè‰øùÂ≠òÁé∞ÊúâÂ§¥ÂÉèÊï∞ÊçÆ
                        window.selectedAvatarData = character.avatarUrl;
                    } else {
                        avatarPreviewText.textContent = character.name.charAt(0);
                    }
                }
            }
            
            // ËÆæÁΩÆË°®ÂçïÁöÑ‰øùÂ≠òÂáΩÊï∞ÂíåÂà†Èô§ÊåâÈíÆÊòæÁ§∫
            const deleteBtn = document.getElementById('character-delete-btn');
            const importBtn = document.getElementById('import-character-btn');
            const exportBtn = document.getElementById('export-character-btn');
            console.log('ËÆæÁΩÆ‰øùÂ≠òÊåâÈíÆÔºåcharacterId:', characterId);
            if (characterId) {
                document.querySelector('#character-form-screen .form-submit').onclick = async () => await saveCharacter(characterId);
                // ÁºñËæëÊ®°ÂºèÊòæÁ§∫Âà†Èô§ÊåâÈíÆÔºåÈöêËóèÂØºÂÖ•ÊåâÈíÆÔºåÊòæÁ§∫ÂØºÂá∫ÊåâÈíÆ
                if (deleteBtn) deleteBtn.style.display = 'block';
                if (importBtn) importBtn.style.display = 'none';
                if (exportBtn) exportBtn.style.display = 'flex';
                console.log('ËÆæÁΩÆ‰∏∫ÁºñËæëÊ®°ÂºèÔºåËßíËâ≤ID:', characterId);
            } else {
                document.querySelector('#character-form-screen .form-submit').onclick = async () => await saveCharacter();
                // Êñ∞Âª∫Ê®°ÂºèÈöêËóèÂà†Èô§ÊåâÈíÆÔºåÊòæÁ§∫ÂØºÂÖ•ÊåâÈíÆÔºåÈöêËóèÂØºÂá∫ÊåâÈíÆ
                if (deleteBtn) deleteBtn.style.display = 'none';
                if (importBtn) importBtn.style.display = 'flex';
                if (exportBtn) exportBtn.style.display = 'none';
                console.log('ËÆæÁΩÆ‰∏∫ÂàõÂª∫Ê®°ÂºèÔºåÊó†ËßíËâ≤ID');
            }
            
            showApp('character-form-screen');
            
            // Á°Æ‰øùÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩÂèØÁî® - ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®Ôºà‰ª•Èò≤‰∏á‰∏ÄÔºâ
            setTimeout(() => {
                initializeAvatarUpload();
            }, 100);
        }
        
        // ‰øùÂ≠òËßíËâ≤
        async function saveCharacter(characterId = null) {
            try {
                console.log('=== ÂºÄÂßã‰øùÂ≠òËßíËâ≤ ===');
                const name = document.getElementById('character-name').value.trim();
                const bio = document.getElementById('character-bio').value.trim();
                const avatarData = window.selectedAvatarData; // ‰ΩøÁî®È¢ÑÂ§ÑÁêÜÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                
                console.log('‰øùÂ≠òËßíËâ≤ - ÂßìÂêç:', name, 'Â§¥ÂÉèÊï∞ÊçÆÂ≠òÂú®:', !!avatarData);
                if (avatarData) {
                    console.log('Â§¥ÂÉèÊï∞ÊçÆÈïøÂ∫¶:', avatarData.length, 'ÂºÄÂ§¥:', avatarData.substring(0, 50));
                }
                
                if (!name) {
                    alert('ËØ∑ËæìÂÖ•ÂßìÂêç');
                    return;
                }
                
                if (characterId) {
                    console.log('=== Êõ¥Êñ∞Áé∞ÊúâËßíËâ≤ ===');
                    // Êõ¥Êñ∞Áé∞ÊúâËßíËâ≤
                    const index = characters.findIndex(c => c.id === characterId);
                    if (index !== -1) {
                        const oldAvatarUrl = characters[index].avatarUrl;
                        
                        characters[index] = {
                            ...characters[index],
                            name,
                            bio,
                            avatarUrl: avatarData || characters[index].avatarUrl || '',
                            color: characters[index].color || getRandomColor()
                        };
                        
                        console.log('Êõ¥Êñ∞ËßíËâ≤ÂÆåÊàê:', characters[index]);
                        
                        // üî•„Äê‰øÆÂ§ç1„ÄëÂ¶ÇÊûúÂ§¥ÂÉèÂèëÁîü‰∫ÜÂèòÂåñÔºåÊõ¥Êñ∞ÊâÄÊúâÁõ∏ÂÖ≥Áæ§ËÅä‰∏≠ÁöÑÊàêÂëòÂ§¥ÂÉè
                        if (avatarData && avatarData !== oldAvatarUrl) {
                            updateCharacterAvatarInGroups(characterId, avatarData);
                        }
                        
                        // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞ÁïåÈù¢
                        await saveCharacters();
                        renderContactList();
                        renderMessageList();
                        
                        // üî•„Äê‰øÆÂ§ç2„ÄëÂ¶ÇÊûúÂΩìÂâçÊ≠£Âú®ËÅäÂ§©‰∏îÊòØËØ•ËßíËâ≤ÔºåÂà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            renderChatMessages(currentChatCharacter.id);
                        }
                        
                        showToast(`ËßíËâ≤ "${name}" Â∑≤Êõ¥Êñ∞ÔºÅ`, 'success');
                        hideCharacterForm();
                        // Ê≥®ÊÑèÔºö‰∏çÁ´ãÂç≥Ê∏ÖÁ©∫Ë°®ÂçïÔºåËÆ©Áî®Êà∑ËÉΩÁúãÂà∞‰øùÂ≠òÊàêÂäüÁöÑÁä∂ÊÄÅ
                    }
                } else {
                    console.log('=== ÂàõÂª∫Êñ∞ËßíËâ≤ ===');
                    // ÂàõÂª∫Êñ∞ËßíËâ≤
                    const newCharacter = {
                        id: Date.now().toString(),
                        name,
                        bio,
                        avatarUrl: avatarData || '',
                        color: getRandomColor(),
                        groupId: 'my_friends' // Êñ∞ËßíËâ≤ÈªòËÆ§ÊîæÂÖ•"ÊàëÁöÑÂ•ΩÂèã"ÂàÜÁªÑ
                    };
                    
                    console.log('ÂàõÂª∫Êñ∞ËßíËâ≤:', newCharacter);
                    console.log('Êñ∞ËßíËâ≤Â§¥ÂÉèURL:', newCharacter.avatarUrl);
                    console.log('Êñ∞ËßíËâ≤Â§¥ÂÉèURLÈïøÂ∫¶:', newCharacter.avatarUrl ? newCharacter.avatarUrl.length : 0);
                    
                    console.log('Ê∑ªÂä†ËßíËâ≤ÂâçÔºåÂΩìÂâçËßíËâ≤Êï∞ÁªÑÈïøÂ∫¶:', characters.length);
                    characters.push(newCharacter);
                    console.log('Ê∑ªÂä†ËßíËâ≤ÂêéÔºåÂΩìÂâçËßíËâ≤Êï∞ÁªÑÈïøÂ∫¶:', characters.length);
                    
                    console.log('ËßíËâ≤Êï∞ÁªÑÊúÄÊñ∞Áä∂ÊÄÅ:', characters);
                    
                    // üî•„Äê‰øÆÂ§ç„Äë‰∏çÂÜçËá™Âä®Ê∑ªÂä†Âà∞ËÅîÁ≥ª‰∫∫ÂàóË°®ÔºåÁî®Êà∑ÈúÄË¶ÅÈÄöËøáÂàõÂª∫ÂØπËØùÊù•Âª∫Á´ãËÅîÁ≥ª
                    
                    // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞ÁïåÈù¢
                    console.log('ÂºÄÂßã‰øùÂ≠òÂà∞IndexedDB...');
                    await saveCharacters();
                    console.log('‰øùÂ≠òÂêéÊ£ÄÊü•ËßíËâ≤Êï∞ÁªÑ:', characters);
                    
                    console.log('ÂºÄÂßãÊ∏≤ÊüìÁïåÈù¢...');
                    renderContactList();
                    renderMessageList();
                    
                    console.log('ÂºÄÂßãÈöêËóèË°®Âçï...');
                    hideCharacterForm();
                    // Ê≥®ÊÑèÔºö‰∏çÁ´ãÂç≥Ê∏ÖÁ©∫Ë°®ÂçïÔºåËÆ©Áî®Êà∑ËÉΩÁúãÂà∞‰øùÂ≠òÊàêÂäüÁöÑÁä∂ÊÄÅ
                    
                    // ÁªôÁî®Êà∑ÂèçÈ¶à
                    showToast(`ËßíËâ≤ "${newCharacter.name}" ÂàõÂª∫ÊàêÂäüÔºÅ`, 'success');
                    
                    console.log('=== ‰øùÂ≠òËßíËâ≤ÂÆåÊàê ===');
                }
            } catch (error) {
                console.error('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ:', error);
                alert('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ: ' + error.message);
            }
        }
        
        // Ê∏ÖÁ©∫ËßíËâ≤Ë°®Âçï
        function clearCharacterForm() {
            console.log('Ê∏ÖÁ©∫ËßíËâ≤Ë°®ÂçïË¢´Ë∞ÉÁî®');
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';
            
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');
            
            // ÈáçÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            if (avatarPreviewText) {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = 'A';
            }
            
            // Ê∏ÖÈô§‰∏¥Êó∂Â≠òÂÇ®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
            console.log('Ê∏ÖÈô§‰∏¥Êó∂Â§¥ÂÉèÊï∞ÊçÆ');
            window.selectedAvatarData = null;
        }
        
        // ÁºñËæëËßíËâ≤
        function editCharacter(characterId) {
            showCharacterForm(characterId);
        }
        
        // ‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®ÁºñËæëËßíËâ≤
        function editCharacterFromContactList(characterId) {
            showCharacterForm(characterId);
        }
        
        // ËøõÂÖ•Â§öÈÄâÊ®°Âºè
        function enterMultiSelectMode(characterId) {
            isMultiSelectMode = true;
            selectedCharacters = [characterId]; // ÂàùÂßãÈÄâ‰∏≠Ëß¶ÂèëÈïøÊåâÁöÑËßíËâ≤
            renderContactList();
        }
        
        // ÈÄÄÂá∫Â§öÈÄâÊ®°Âºè
        function exitMultiSelectMode() {
            isMultiSelectMode = false;
            selectedCharacters = [];
            renderContactList();
        }
        
        // ÂàáÊç¢ËßíËâ≤ÈÄâÊã©Áä∂ÊÄÅ
        function toggleCharacterSelection(characterId) {
            const index = selectedCharacters.indexOf(characterId);
            if (index > -1) {
                selectedCharacters.splice(index, 1);
            } else {
                selectedCharacters.push(characterId);
            }
            renderContactList();
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑËßíËâ≤
        async function deleteSelectedCharacters() {
            if (selectedCharacters.length === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËßíËâ≤');
                return;
            }
            
            const characterNames = selectedCharacters.map(id => {
                const character = characters.find(c => c.id === id);
                return character ? character.name : '';
            }).filter(name => name).join('„ÄÅ');
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∫õËßíËâ≤ÂêóÔºü\n${characterNames}\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                // Âà†Èô§ËßíËâ≤
                selectedCharacters.forEach(characterId => {
                    characters = characters.filter(c => c.id !== characterId);
                    contacts = contacts.filter(c => c !== characterId);
                    
                    // Âà†Èô§Áõ∏ÂÖ≥ËÅäÂ§©ËÆ∞ÂΩï
                    if (chatMessages[characterId]) {
                        delete chatMessages[characterId];
                    }
                });
                
                // ‰øùÂ≠òÊï∞ÊçÆ
                await saveCharacters();
                await saveContacts();
                await saveChatMessages();
                
                // ÈÄÄÂá∫Â§öÈÄâÊ®°ÂºèÂπ∂Êõ¥Êñ∞ÁïåÈù¢
                exitMultiSelectMode();
                renderMessageList();
                
                alert('ËßíËâ≤Âà†Èô§ÊàêÂäü');
            }
        }
        
        // Âà†Èô§ÂΩìÂâçÁºñËæëÁöÑËßíËâ≤
        async function deleteCurrentCharacter() {
            if (currentEditingCharacterId) {
                const character = characters.find(c => c.id === currentEditingCharacterId);
                
                if (character && confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ËßíËâ≤"${character.name}"ÂêóÔºü\n\nÊ≠§Êìç‰ΩúÂ∞ÜÂà†Èô§ËßíËâ≤Êï∞ÊçÆ„ÄÅËÅäÂ§©ËÆ∞ÂΩïÂíåÊâÄÊúâËÆæÁΩÆÔºå‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                    // Âà†Èô§ËßíËâ≤
                    characters = characters.filter(c => c.id !== character.id);
                    contacts = contacts.filter(c => c !== character.id);
                    
                    // Âà†Èô§Áõ∏ÂÖ≥ËÅäÂ§©ËÆ∞ÂΩï
                    if (chatMessages[character.id]) {
                        delete chatMessages[character.id];
                    }
                    
                    // [Ê†∏ÂøÉ‰øÆÂ§ç] Âà†Èô§ËÅäÂ§©ËÆæÁΩÆ
                    try {
                        // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§ËÆæÁΩÆ
                        await db.chatSettings.delete(character.id);
                        // ‰ªéÂÜÖÂ≠ò‰∏≠Âà†Èô§ËÆæÁΩÆ
                        if (chatSettings[character.id]) {
                            delete chatSettings[character.id];
                        }
                        // Âà†Èô§localStorage‰∏≠ÁöÑÂ§á‰ªΩËÆæÁΩÆ
                        localStorage.removeItem(`chatSettings_${character.id}`);
                        console.log(`‚úÖ Â∑≤Âà†Èô§ËßíËâ≤ ${character.name} ÁöÑËÅäÂ§©ËÆæÁΩÆ`);
                    } catch (error) {
                        console.error(`Âà†Èô§ËßíËâ≤ ${character.name} ÁöÑËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:`, error);
                    }
                    
                    // ‰øùÂ≠òÊï∞ÊçÆ
                    await saveCharacters();
                    await saveContacts();
                    await saveChatMessages();
                    
                    // Êõ¥Êñ∞ÁïåÈù¢Âπ∂ËøîÂõû
                    renderContactList();
                    renderMessageList();
                    hideCharacterForm();
                    
                    showToast(`ËßíËâ≤ ${character.name} Â∑≤ÊàêÂäüÂà†Èô§`, 'success');
                }
            }
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÊõ¥Êñ∞ËßíËâ≤Âú®ÊâÄÊúâÁæ§ËÅä‰∏≠ÁöÑÂ§¥ÂÉè
        function updateCharacterAvatarInGroups(characterId, newAvatarUrl) {
            // ÈÅçÂéÜÊâÄÊúâËßíËâ≤ÔºåÊâæÂà∞Áæ§ËÅä
            characters.forEach(character => {
                if (character.isGroup && character.members) {
                    // Âú®ËØ•Áæ§ËÅä‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑÊàêÂëò
                    const memberIndex = character.members.findIndex(member => member.id === characterId);
                    if (memberIndex !== -1) {
                        // Êõ¥Êñ∞ËØ•ÊàêÂëòÁöÑÂ§¥ÂÉè
                        character.members[memberIndex].avatarUrl = newAvatarUrl;
                        console.log(`Â∑≤Êõ¥Êñ∞Áæ§ËÅä "${character.name}" ‰∏≠ÊàêÂëò "${character.members[memberIndex].name}" ÁöÑÂ§¥ÂÉè`);
                    }
                }
            });
            
            // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑËßíËâ≤Êï∞ÊçÆ
            saveCharacters();
        }
        
        // Ëé∑ÂèñÈöèÊú∫È¢úËâ≤
        function getRandomColor() {
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#5AC8FA', '#007AFF', '#5856D6', '#AF52DE'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // ÊòæÁ§∫Ê∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü
        function showAddContactModal() {
            showCharacterForm(); // Áõ¥Êé•ÊòæÁ§∫ÂàõÂª∫ËßíËâ≤Ë°®Âçï
        }
        
        // Ê∑ªÂä†ÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫
        async function addSelectedContacts() {
            const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
            checkboxes.forEach(checkbox => {
                const characterId = checkbox.value;
                if (!contacts.includes(characterId)) {
                    contacts.push(characterId);
                }
            });
            
            await saveContacts();
            renderMessageList();
            renderContactList();
            hideModal('add-contact-modal');
        }
        
        // ÂºÄÂßã‰∏éËßíËâ≤ËÅäÂ§©
async function startChat(character) {
    // [Ê†∏ÂøÉ‰øÆÂ§ç] ËÆ∞ÂΩï‰∏ä‰∏Ä‰∏™ËÅäÂ§©IDÔºåÁî®‰∫éÊ∏ÖÁêÜ
    const previousChatId = currentChatCharacter ? currentChatCharacter.id : null;
    
    // ËÆæÁΩÆÂΩìÂâçËÅäÂ§©ËßíËâ≤
            currentChatCharacter = character;
            
    // üî•„Äê‰øÆÂ§ç„ÄëÂºÇÊ≠•Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆ
    const chatSettings = await getAsyncChatSettings();
            const displayTitle = chatSettings.aiChatNickname || character.name;
            document.getElementById('api-chat-title').textContent = displayTitle;
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÊ∏≤ÊüìËßíËâ≤Áä∂ÊÄÅÊòæÁ§∫
            const headerContainer = document.querySelector('#api-chat-screen .header');
            if (headerContainer) {
                renderCharacterStatus(character.id, headerContainer);
            }
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÊõ¥Êñ∞ÂøÉÁéáÊòæÁ§∫
            updateAiHeartrate();
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÁ´ãÂç≥‰∏∫Ëøô‰∏™ËßíËâ≤ÁîüÊàê‰∏Ä‰∏™ÂàùÂßãÁä∂ÊÄÅÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÁöÑËØùÔºâ
                setTimeout(async () => {
                    const currentStatus = getCharacterStatus(character.id);
                    if (!currentStatus.activity || currentStatus.activity === 'Âú®Á∫ø') {
                        await generateCharacterStatus(character.id);
                        // Âà∑Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                        renderCharacterStatus(character.id, headerContainer);
                    }
                }, 500);
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂêØÂä®Áä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®
            startCharacterStatusTimer();
            
            // ÂàùÂßãÂåñÁ©∫ÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰∏çËá™Âä®ÂèëÈÄÅÊ∂àÊÅØÔºâ
            if (!chatMessages[character.id]) {
                chatMessages[character.id] = [];
                saveChatMessages();
            }
            
            // ÈáçÁΩÆÊÇ¨ÊµÆÊåâÈíÆÁä∂ÊÄÅ
            resetFloatingButtonsState();
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•ÊãâÈªëÁä∂ÊÄÅÂπ∂Êõ¥Êñ∞ÁïåÈù¢
            updateChatBlockedStatus();
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂ¶ÇÊûúËÆæÁΩÆÁïåÈù¢ÊòØÊâìÂºÄÁöÑÔºåÊõ¥Êñ∞ËÆæÁΩÆÊòæÁ§∫Áä∂ÊÄÅ
            if (document.getElementById('api-chat-settings-screen').style.display === 'flex') {
                updateChatSettingsDisplay();
            }
    
    // ÈáçÁΩÆËÅäÂ§©Â±èÂπïËÉåÊôØ
    const chatScreen = document.getElementById('api-chat-screen');
    if (chatScreen) {
        // ÂÖàÈáçÁΩÆÊâÄÊúâËÉåÊôØÊ†∑Âºè
        chatScreen.style.backgroundImage = 'none';
        chatScreen.style.backgroundColor = 'white';
        
        const messagesContainer = document.getElementById('api-chat-messages');
        if (messagesContainer) messagesContainer.style.background = '';
    }
    
    // ËÆ∞ÂΩïÂàáÊç¢
    console.log(`üîÑ ÂàáÊç¢Âà∞ËÅäÂ§©: ${character.name} (ID: ${character.id})`);
    
    // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÊØèÊ¨°ËøõÂÖ•ËÅäÂ§©Êó∂ÔºåË∞ÉÁî® applyChatBackground Êù•Á°Æ‰øùËÉåÊôØÊ≠£Á°Æ
    // ‰∏ç‰º†ÈÄíÂèÇÊï∞ÔºåËÆ©ÂáΩÊï∞Ëá™Â∑±‰ªéËßíËâ≤ÂØπË±°‰∏≠ËØªÂèñ
    await applyChatBackground();
            
            // ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
            initBackgroundInteractionSystem();
            
            // ÂàùÂßãÂåñÂÆöÊó∂ÂèëÂ∏ÉÁ≥ªÁªü
            initScheduledMomentsSystem();
            
            renderChatMessages(character.id);
            showApp('api-chat-screen');
        }
        
        // ‰ªéËÅäÂ§©ÁïåÈù¢ËøîÂõûÂà∞ËÅäÂ§©Â∫îÁî®
        function backToChatApp() {
            // Ê∏ÖÈô§ÂΩìÂâçËßíËâ≤ÁöÑÂêéÂè∞ÂÆöÊó∂Âô®
            clearAllBackgroundTimers();
            // üî•„ÄêÊñ∞Â¢û„ÄëÊ∏ÖÈô§Áä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®
            clearCharacterStatusTimer();
            // ÈöêËóèÂøÉÁéáÊòæÁ§∫
            hideAiHeartrate();
            hideApp('api-chat-screen');
            showApp('chat-screen');
        }
        
        // ‰ªéËÆæÁΩÆÂ≠êÈ°µÈù¢ËøîÂõûÂà∞ËÆæÁΩÆ‰∏ªÈ°µÈù¢
        function backToSettings(currentScreen) {
            hideApp(currentScreen);
            showApp('settings-screen');
        }
        

        
        // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
        function showTypingIndicator() {
            console.log('üîß Â∞ùËØïÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫...');
            let indicator = document.getElementById('typing-indicator');
            
            // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂÖÉÁ¥†ÔºåÂ∞ùËØïÂàõÂª∫‰∏Ä‰∏™
            if (!indicator) {
                console.log('‚ö†Ô∏è Êú™ÊâæÂà∞typing-indicatorÂÖÉÁ¥†ÔºåÊ≠£Âú®ÂàõÂª∫...');
                const messagesContainer = document.getElementById('api-chat-messages');
                if (messagesContainer) {
                    indicator = document.createElement('div');
                    indicator.id = 'typing-indicator';
                    indicator.className = 'typing-indicator';
                    
                    // Ëé∑ÂèñÂΩìÂâçËßíËâ≤ÂêçÁß∞
                    const chatSettings = getCurrentChatSettings();
                    const characterName = chatSettings.aiChatNickname || (currentChatCharacter ? currentChatCharacter.name : 'ÂØπÊñπ');
                    
                    indicator.innerHTML = `${characterName}Ê≠£Âú®ËæìÂÖ•‰∏≠<span class="dots"></span>`;
                    messagesContainer.appendChild(indicator);
                    console.log('‚úÖ Â∑≤ÂàõÂª∫typing-indicatorÂÖÉÁ¥†');
                } else {
                    console.error('‚ùå Êâæ‰∏çÂà∞Ê∂àÊÅØÂÆπÂô®ÔºåÊó†Ê≥ïÂàõÂª∫typing-indicator');
                    return;
                }
            }
            
            if (indicator) {
                console.log('‚úÖ ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫');
                indicator.classList.add('show');
                // ÊªöÂä®Âà∞Â∫ïÈÉ®ÊòæÁ§∫ÊèêÁ§∫
                const messagesContainer = document.getElementById('api-chat-messages');
                if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } else {
                console.error('‚ùå ‰ªçÁÑ∂Êâæ‰∏çÂà∞typing-indicatorÂÖÉÁ¥†');
            }
        }
        
        // ÈöêËóèÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫
        function hideTypingIndicator() {
            console.log('üîß Â∞ùËØïÈöêËóèÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫...');
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                console.log('‚úÖ ÈöêËóèÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫');
                indicator.classList.remove('show');
            } else {
                console.log('‚ö†Ô∏è Êú™ÊâæÂà∞typing-indicatorÂÖÉÁ¥†ÔºåÂèØËÉΩÂ∑≤Ë¢´ÁßªÈô§');
            }
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢Ôºà‰∏çÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®Ôºâ
        function addSystemMessageToChat(systemMessage) {
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer) return;
            
            // ÂàõÂª∫Â§ñÂ±ÇÂÆπÂô®ÔºåÁî®‰∫éÂ±Ö‰∏≠
            const centerContainer = document.createElement('div');
            centerContainer.style.display = 'flex';
            centerContainer.style.justifyContent = 'center';
            centerContainer.style.margin = '4px 0';
            
            // ÂàõÂª∫Á≥ªÁªüÊ∂àÊÅØÂÆπÂô®
            const systemContainer = document.createElement('div');
            systemContainer.className = 'system-message';
            systemContainer.textContent = systemMessage.content;
            
            // Â∞ÜÁ≥ªÁªüÊ∂àÊÅØÊîæÂÖ•Â±Ö‰∏≠ÂÆπÂô®
            centerContainer.appendChild(systemContainer);
            
            // ÊèíÂÖ•Âà∞Ê∂àÊÅØÂÆπÂô®ÁöÑÊúÄÂêéÔºàÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫‰πãÂâçÔºâ
            const typingIndicator = messagesContainer.querySelector('#typing-indicator');
            if (typingIndicator) {
                messagesContainer.insertBefore(centerContainer, typingIndicator);
            } else {
                messagesContainer.appendChild(centerContainer);
            }
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // ËßíËâ≤Âç°ÂØºÂÖ•ÂäüËÉΩ
        function importCharacterCard() {
            // Èò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
            if (window.isImporting) {
                console.log('Ê≠£Âú®ÂØºÂÖ•‰∏≠ÔºåÂøΩÁï•ÈáçÂ§çË∞ÉÁî®');
                return;
            }
            window.isImporting = true;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.png,.json';
            input.onchange = async (e) => {
                try {
                    const file = e.target.files[0];
                    if (!file) {
                        window.isImporting = false;
                        return;
                    }
                    
                    console.log('ÂºÄÂßãÂØºÂÖ•Êñá‰ª∂:', file.name, 'Á±ªÂûã:', file.type);
                    
                    let characterData = null;
                    
                    if (file.type === 'image/png') {
                        // ‰ªéPNGÂõæÁâá‰∏≠ËØªÂèñËßíËâ≤Âç°Êï∞ÊçÆ
                        characterData = await extractCharacterFromPNG(file);
                        
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ¶ÇÊûúPNG‰∏≠Ê≤°ÊúâÂ§¥ÂÉèÊï∞ÊçÆÔºå‰ΩøÁî®PNGÊñá‰ª∂Êú¨Ë∫´‰Ωú‰∏∫Â§¥ÂÉè
                        if (characterData && (!characterData.avatarUrl || characterData.avatarUrl === 'none' || characterData.avatarUrl === '' || characterData.avatarUrl === 'undefined')) {
                            console.log('üñºÔ∏è PNG‰∏≠Ê≤°ÊúâÂ§¥ÂÉèÊï∞ÊçÆÔºå‰ΩøÁî®PNGÊñá‰ª∂Êú¨Ë∫´‰Ωú‰∏∫Â§¥ÂÉè');
                            const reader = new FileReader();
                            const pngAsAvatar = await new Promise((resolve) => {
                                reader.onload = (e) => resolve(e.target.result);
                                reader.readAsDataURL(file);
                            });
                            characterData.avatarUrl = pngAsAvatar;
                            characterData.usePngAsAvatar = true; // Ê†áËÆ∞ËøôÊòØPNGÊú¨Ë∫´
                            console.log('üñºÔ∏è PNGÂ§¥ÂÉèËÆæÁΩÆÂÆåÊàê');
                        }
                    } else if (file.type === 'application/json' || file.name.endsWith('.json')) {
                        // ‰ªéJSONÊñá‰ª∂‰∏≠ËØªÂèñËßíËâ≤Âç°Êï∞ÊçÆ
                        const text = await file.text();
                        characterData = JSON.parse(text);
                    }
                    
                    if (characterData) {
                        // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
                        if (characterData.name) {
                            document.getElementById('character-name').value = characterData.name;
                        }
                        if (characterData.bio || characterData.description) {
                            document.getElementById('character-bio').value = characterData.bio || characterData.description;
                        }
                        
                        // Â§ÑÁêÜÂ§¥ÂÉè
                        const avatarData = characterData.avatarUrl || characterData.avatar;
                        if (avatarData && avatarData !== 'none' && avatarData !== '' && avatarData !== 'null') {
                            console.log('Â§ÑÁêÜÂ§¥ÂÉèÊï∞ÊçÆ:', avatarData.substring(0, 100) + '...');
                            
                            const avatarPreview = document.getElementById('avatar-preview');
                            const avatarPreviewText = document.getElementById('avatar-preview-text');
                            
                            if (avatarPreview && avatarPreviewText) {
                                console.log('üñºÔ∏è ÂºÄÂßãËÆæÁΩÆÂ§¥ÂÉèÔºåÊï∞ÊçÆÈïøÂ∫¶:', avatarData.length);
                                
                                // Ê£ÄÊü•ÊòØÂê¶ÂèØËÉΩÊòØBase64ÁºñÁ†ÅÁöÑÂõæÁâáÊï∞ÊçÆ
                                let processedAvatarData = avatarData;
                                
                                // Â¶ÇÊûúÊòØÈïøÂ≠óÁ¨¶‰∏≤‰∏î‰∏çÂåÖÂê´ÂçèËÆÆÔºåÂèØËÉΩÊòØBase64
                                if (avatarData.length > 100 && !avatarData.startsWith('http') && !avatarData.startsWith('data:')) {
                                    console.log('üñºÔ∏è Ê£ÄÊµãÂà∞ÂèØËÉΩÁöÑBase64Êï∞ÊçÆÔºåÂ∞ùËØïÊ∑ªÂä†ÂâçÁºÄ...');
                                    // Â∞ùËØïÊ£ÄÊµãÂõæÁâáÊ†ºÂºè
                                    try {
                                        const firstBytes = atob(avatarData.substring(0, 32));
                                        const header = firstBytes.substring(0, 4);
                                        if (header.startsWith('\x89PNG')) {
                                            processedAvatarData = `data:image/png;base64,${avatarData}`;
                                            console.log('üñºÔ∏è Ê£ÄÊµã‰∏∫PNGÊ†ºÂºè');
                                        } else if (header.startsWith('\xFF\xD8\xFF')) {
                                            processedAvatarData = `data:image/jpeg;base64,${avatarData}`;
                                            console.log('üñºÔ∏è Ê£ÄÊµã‰∏∫JPEGÊ†ºÂºè');
                                        }
                                    } catch (e) {
                                        console.log('üñºÔ∏è Base64Ê£ÄÊµãÂ§±Ë¥•:', e);
                                    }
                                }
                                
                                // Êõ¥ÂÆΩÊùæÁöÑÂ§¥ÂÉèÊ†ºÂºèÊ£ÄÊü•
                                if (processedAvatarData.startsWith('data:image/') || 
                                    processedAvatarData.startsWith('http') || 
                                    processedAvatarData.includes('.jpg') || 
                                    processedAvatarData.includes('.png') || 
                                    processedAvatarData.includes('.gif') ||
                                    processedAvatarData.includes('.jpeg') ||
                                    processedAvatarData.length > 100) { // ÈïøÂ≠óÁ¨¶‰∏≤ÂèØËÉΩÊòØBase64
                                    
                                    try {
                                        avatarPreview.classList.add('has-image');
                                        avatarPreview.style.setProperty('background-image', `url("${processedAvatarData}")`, 'important');
                                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                                        avatarPreviewText.style.display = 'none';
                                        window.selectedAvatarData = processedAvatarData;
                                        console.log('Â§¥ÂÉèËÆæÁΩÆÊàêÂäü');
                                    } catch (e) {
                                        console.log('Â§¥ÂÉèËÆæÁΩÆÂ§±Ë¥•:', e);
                                        showToast('Â§¥ÂÉèÂØºÂÖ•Â§±Ë¥•Ôºå‰ΩÜËßíËâ≤‰ø°ÊÅØÂ∑≤ÂØºÂÖ•', 'warning');
                                    }
                                } else {
                                    console.log('Â§¥ÂÉèÊï∞ÊçÆÊ†ºÂºè‰∏çÊîØÊåÅÔºåÂéüÂßãÊï∞ÊçÆ:', avatarData);
                                    showToast('Â§¥ÂÉèÊ†ºÂºè‰∏çÊîØÊåÅÔºåËØ∑ÊâãÂä®‰∏ä‰º†Â§¥ÂÉè', 'warning');
                                }
                            } else {
                                console.log('Â§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                            }
                        } else {
                            console.log('Â§¥ÂÉèÊï∞ÊçÆ‰∏∫Á©∫ÊàñÊó†Êïà:', avatarData);
                        }
                        
                        // Â§ÑÁêÜ‰∏ñÁïå‰π¶Êï∞ÊçÆ
                        if (characterData.worldBooks && characterData.worldBooks.length > 0) {
                            console.log('ÂºÄÂßãÂØºÂÖ•‰∏ñÁïå‰π¶Êï∞ÊçÆ...');
                            await importWorldBooks(characterData.worldBooks, characterData.name);
                        } else {
                            console.log('üìö Ê≤°ÊúâÊ£ÄÊµãÂà∞‰∏ñÁïå‰π¶Êï∞ÊçÆÔºåË∑≥Ëøá‰∏ñÁïå‰π¶ÂØºÂÖ•');
                        }
                        
                        const successMsg = 'ËßíËâ≤Âç°ÂØºÂÖ•ÊàêÂäüÔºÅ' + 
                            (characterData.usePngAsAvatar ? ' Â∑≤‰ΩøÁî®PNGÂõæÁâá‰Ωú‰∏∫Â§¥ÂÉè„ÄÇ' : '') +
                            (characterData.worldBooks && characterData.worldBooks.length > 0 ? `ÔºàÂåÖÂê´${characterData.worldBooks.length}‰∏™‰∏ñÁïå‰π¶Ôºâ` : '');
                        showToast(successMsg, 'success');
                    }
                } catch (error) {
                    console.error('ÂØºÂÖ•ËßíËâ≤Âç°Â§±Ë¥•:', error);
                    showToast('ÂØºÂÖ•ËßíËâ≤Âç°Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºè', 'error');
                } finally {
                    window.isImporting = false;
                }
            };
            
            input.click();
        }
        
        // ËßíËâ≤Âç°ÂØºÂá∫ÂäüËÉΩ
        function exportCharacterCard() {
            if (!currentEditingCharacterId) {
                showToast('ËØ∑ÂÖà‰øùÂ≠òËßíËâ≤ÂÜçÂØºÂá∫', 'error');
                return;
            }
            
            const character = characters.find(c => c.id === currentEditingCharacterId);
            if (!character) {
                showToast('Êâæ‰∏çÂà∞Ë¶ÅÂØºÂá∫ÁöÑËßíËâ≤', 'error');
                return;
            }
            
            // ÊòæÁ§∫ÂØºÂá∫ÈÄâÈ°π
            showExportOptions(character);
        }
        
        // ÊòæÁ§∫ÂØºÂá∫ÈÄâÈ°πÂØπËØùÊ°Ü
        function showExportOptions(character) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">ÂØºÂá∫ËßíËâ≤Âç°</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>ËØ∑ÈÄâÊã©ÂØºÂá∫Ê†ºÂºèÔºö</p>
                        <div style="margin: 15px 0;">
                            <button class="modal-button modal-primary" onclick="exportAsJSON('${character.id}'); this.closest('.modal').remove();" style="margin-right: 10px;">
                                <i class="fas fa-file-code"></i> JSONÊ†ºÂºè
                            </button>
                            <button class="modal-button modal-secondary" onclick="exportAsPNG('${character.id}'); this.closest('.modal').remove();">
                                <i class="fas fa-image"></i> PNGÊ†ºÂºè
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }
        
        // ÂØºÂá∫‰∏∫JSONÊ†ºÂºè
        function exportAsJSON(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;
            
            const characterData = {
                name: character.name,
                bio: character.bio,
                avatarUrl: character.avatarUrl,
                color: character.color,
                exportTime: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(characterData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name}_ËßíËâ≤Âç°.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('JSONÊ†ºÂºèËßíËâ≤Âç°ÂØºÂá∫ÊàêÂäü', 'success');
        }
        
        // ÂØºÂá∫‰∏∫PNGÊ†ºÂºè
        async function exportAsPNG(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;
            
            try {
                // ÂàõÂª∫ÂåÖÂê´ËßíËâ≤Êï∞ÊçÆÁöÑPNGÂõæÁâá
                const characterData = {
                    name: character.name,
                    bio: character.bio,
                    avatarUrl: character.avatarUrl,
                    color: character.color,
                    exportTime: new Date().toISOString(),
                    version: '1.0'
                };
                
                // ÂàõÂª∫ÁîªÂ∏ÉÊù•ÁîüÊàêPNG
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 400;
                canvas.height = 300;
                
                // ÁªòÂà∂ËÉåÊôØ
                ctx.fillStyle = character.color || '#007AFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ÁªòÂà∂ËßíËâ≤‰ø°ÊÅØ
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(character.name, canvas.width / 2, 50);
                
                ctx.font = '16px Arial';
                ctx.fillText('ËßíËâ≤Âç°', canvas.width / 2, 80);
                
                // ÁªòÂà∂Â§¥ÂÉèÔºàÂ¶ÇÊûúÊúâÔºâ
                if (character.avatarUrl) {
                    try {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = reject;
                            img.src = character.avatarUrl;
                        });
                        
                        // ÁªòÂà∂ÂúÜÂΩ¢Â§¥ÂÉè
                        const avatarSize = 100;
                        const avatarX = (canvas.width - avatarSize) / 2;
                        const avatarY = 120;
                        
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(avatarX + avatarSize/2, avatarY + avatarSize/2, avatarSize/2, 0, Math.PI * 2);
                        ctx.clip();
                        ctx.drawImage(img, avatarX, avatarY, avatarSize, avatarSize);
                        ctx.restore();
                    } catch (error) {
                        console.log('Êó†Ê≥ïÁªòÂà∂Â§¥ÂÉè:', error);
                    }
                }
                
                // Â∞ÜËßíËâ≤Êï∞ÊçÆÂµåÂÖ•Âà∞PNGÁöÑÂÖÉÊï∞ÊçÆ‰∏≠
                const canvasBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const pngWithMetadata = await embedDataInPNG(canvasBlob, characterData);
                
                // ‰∏ãËΩΩÊñá‰ª∂
                const url = URL.createObjectURL(pngWithMetadata);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${character.name}_ËßíËâ≤Âç°.png`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('PNGÊ†ºÂºèËßíËâ≤Âç°ÂØºÂá∫ÊàêÂäü', 'success');
            } catch (error) {
                console.error('PNGÂØºÂá∫Â§±Ë¥•:', error);
                showToast('PNGÂØºÂá∫Â§±Ë¥•', 'error');
            }
        }
        
        // ÂØºÂÖ•‰∏ñÁïå‰π¶Êï∞ÊçÆ
        async function importWorldBooks(worldBooks, characterName) {
            try {
                let importedCount = 0;
                
                for (const worldBook of worldBooks) {
                    // ÂàõÂª∫‰∏ñÁïå‰π¶ÂØπË±°Ôºå‰ΩøÁî®Êõ¥Â•ΩÁöÑÂàÜÁ±ªÂëΩÂêç
                    const worldBookObj = {
                        id: Date.now() + Math.random(),
                        name: `[${characterName}] ${worldBook.name}`,
                        content: worldBook.content,
                        category: characterName, // Ê∑ªÂä†ÂàÜÁ±ªÂ≠óÊÆµ
                        source: 'character_card', // Êù•Ê∫êÊ†áËÆ∞
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                    try {
                        await db.worldbooks.add(worldBookObj);
                        console.log('üìö ‰∏ñÁïå‰π¶ÂØºÂÖ•ÊàêÂäü:', worldBookObj.name);
                        importedCount++;
                    } catch (error) {
                        console.error('üìö ‰∏ñÁïå‰π¶‰øùÂ≠òÂ§±Ë¥•:', error);
                    }
                }
                
                if (importedCount > 0) {
                    showToast(`ÊàêÂäüÂØºÂÖ•${importedCount}‰∏™‰∏ñÁïå‰π¶Âà∞"${characterName}"ÂàÜÁ±ª`, 'success');
                } else {
                    console.log('üìö Ê≤°ÊúâÊàêÂäüÂØºÂÖ•‰ªª‰Ωï‰∏ñÁïå‰π¶');
                }
            } catch (error) {
                console.error('‰∏ñÁïå‰π¶ÂØºÂÖ•ËøáÁ®ãÂá∫Èîô:', error);
                showToast('‰∏ñÁïå‰π¶ÂØºÂÖ•Â§±Ë¥•', 'error');
            }
        }
        
        // Âú®PNG‰∏≠ÂµåÂÖ•Êï∞ÊçÆ
        async function embedDataInPNG(blob, data) {
            const arrayBuffer = await blob.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            
            // ÁÆÄÂçïÁöÑÂÆûÁé∞ÔºöÂ∞ÜJSONÊï∞ÊçÆ‰Ωú‰∏∫Ê≥®ÈáäÂùóÊ∑ªÂä†Âà∞PNGÊú´Â∞æ
            const jsonString = JSON.stringify(data);
            const textEncoder = new TextEncoder();
            const jsonBytes = textEncoder.encode(jsonString);
            
            // ÂàõÂª∫‰∏Ä‰∏™ÂåÖÂê´ÂéüÂßãPNGÂíåJSONÊï∞ÊçÆÁöÑÊñ∞Êï∞ÁªÑ
            const newArray = new Uint8Array(uint8Array.length + jsonBytes.length + 8);
            newArray.set(uint8Array);
            
            // Ê∑ªÂä†Ê†áËÆ∞ÂíåÊï∞ÊçÆÈïøÂ∫¶
            const marker = textEncoder.encode('CHRD'); // ËßíËâ≤Êï∞ÊçÆÊ†áËÆ∞
            newArray.set(marker, uint8Array.length);
            
            // Ê∑ªÂä†Êï∞ÊçÆÈïøÂ∫¶Ôºà4Â≠óËäÇÔºâ
            const dataView = new DataView(newArray.buffer);
            dataView.setUint32(uint8Array.length + 4, jsonBytes.length, true);
            
            // Ê∑ªÂä†JSONÊï∞ÊçÆ
            newArray.set(jsonBytes, uint8Array.length + 8);
            
            return new Blob([newArray], { type: 'image/png' });
        }
        
        // ‰ªéPNG‰∏≠ÊèêÂèñËßíËâ≤Êï∞ÊçÆ
        async function extractCharacterFromPNG(file) {
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            
            console.log('ÂºÄÂßãËß£ÊûêPNGÊñá‰ª∂ÔºåÊñá‰ª∂Â§ßÂ∞è:', uint8Array.length);
            
            // Â∞ùËØïÂ§öÁßçÂ∏∏ËßÅÁöÑËßíËâ≤Âç°Ê†ºÂºè
            
            // 1. Â∞ùËØïÊàë‰ª¨ÁöÑËá™ÂÆö‰πâÊ†ºÂºè (CHRDÊ†áËÆ∞)
            const textEncoder = new TextEncoder();
            const marker = textEncoder.encode('CHRD');
            
            for (let i = 0; i < uint8Array.length - marker.length - 4; i++) {
                let found = true;
                for (let j = 0; j < marker.length; j++) {
                    if (uint8Array[i + j] !== marker[j]) {
                        found = false;
                        break;
                    }
                }
                
                if (found) {
                    console.log('ÊâæÂà∞CHRDÊ†áËÆ∞ÔºåÊèêÂèñÊï∞ÊçÆ...');
                    // ËØªÂèñÊï∞ÊçÆÈïøÂ∫¶
                    const dataView = new DataView(uint8Array.buffer);
                    const dataLength = dataView.getUint32(i + marker.length, true);
                    
                    // ÊèêÂèñJSONÊï∞ÊçÆ
                    const jsonStart = i + marker.length + 4;
                    const jsonBytes = uint8Array.slice(jsonStart, jsonStart + dataLength);
                    const textDecoder = new TextDecoder();
                    const jsonString = textDecoder.decode(jsonBytes);
                    
                    return JSON.parse(jsonString);
                }
            }
            
            // 2. Â∞ùËØïCharacterAIÊ†ºÂºè (Âú®tEXtÂùó‰∏≠Êü•ÊâæcharaÂ≠óÊÆµ)
            console.log('Êú™ÊâæÂà∞CHRDÊ†áËÆ∞ÔºåÂ∞ùËØïËß£ÊûêPNG tEXtÂùó...');
            try {
                const textData = extractPNGTextChunks(uint8Array);
                console.log('ÊâæÂà∞ÁöÑPNGÊñáÊú¨Âùó:', Object.keys(textData));
                
                // Êü•ÊâæcharaÂ≠óÊÆµ
                if (textData.chara) {
                    console.log('ÊâæÂà∞charaÂ≠óÊÆµÔºåËß£ÊûêÊï∞ÊçÆ...');
                    try {
                        const characterData = JSON.parse(textData.chara);
                        return convertCharacterAIFormat(characterData);
                    } catch (e) {
                        console.log('charaÂ≠óÊÆµJSONËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïbase64Ëß£Á†Å...');
                        try {
                            // ‰ΩøÁî®Êõ¥Â•ΩÁöÑbase64Ëß£Á†ÅÊñπÊ≥ï
                            const decoded = decodeBase64Text(textData.chara);
                            const characterData = JSON.parse(decoded);
                            return convertCharacterAIFormat(characterData);
                        } catch (e2) {
                            console.log('base64Ëß£Á†Å‰πüÂ§±Ë¥•:', e2);
                        }
                    }
                }
                
                // Êü•ÊâæÂÖ∂‰ªñÂèØËÉΩÁöÑÂ≠óÊÆµ
                for (const [key, value] of Object.entries(textData)) {
                    if (key.toLowerCase().includes('character') || key.toLowerCase().includes('card')) {
                        console.log(`Â∞ùËØïËß£ÊûêÂ≠óÊÆµ ${key}:`, value.substring(0, 100));
                                                 try {
                             const characterData = JSON.parse(value);
                             return convertCharacterAIFormat(characterData);
                         } catch (e) {
                             try {
                                 const decoded = decodeBase64Text(value);
                                 const characterData = JSON.parse(decoded);
                                 return convertCharacterAIFormat(characterData);
                             } catch (e2) {
                                 console.log(`Â≠óÊÆµ ${key} Ëß£ÊûêÂ§±Ë¥•`);
                             }
                         }
                    }
                }
            } catch (e) {
                console.log('PNGÊñáÊú¨ÂùóËß£ÊûêÂ§±Ë¥•:', e);
            }
            
            throw new Error('Âú®PNGÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ËßíËâ≤Êï∞ÊçÆ');
        }
        
        // ÊèêÂèñPNGÊñá‰ª∂ÁöÑtEXtÂùó
        function extractPNGTextChunks(uint8Array) {
            const textChunks = {};
            let offset = 8; // Ë∑≥ËøáPNGÁ≠æÂêç
            
            while (offset < uint8Array.length) {
                if (offset + 8 > uint8Array.length) break;
                
                // ËØªÂèñÂùóÈïøÂ∫¶
                const length = new DataView(uint8Array.buffer).getUint32(offset, false);
                offset += 4;
                
                // ËØªÂèñÂùóÁ±ªÂûã
                const type = new TextDecoder().decode(uint8Array.slice(offset, offset + 4));
                offset += 4;
                
                                 if (type === 'tEXt') {
                     // ÊèêÂèñtEXtÂùóÊï∞ÊçÆ
                     const data = uint8Array.slice(offset, offset + length);
                     const nullIndex = data.indexOf(0);
                     if (nullIndex !== -1) {
                         const keyword = new TextDecoder('utf-8').decode(data.slice(0, nullIndex));
                         // Â∞ùËØïÂ§öÁßçÁºñÁ†ÅÊñπÂºè
                         let text;
                         try {
                             text = new TextDecoder('utf-8').decode(data.slice(nullIndex + 1));
                         } catch (e) {
                             try {
                                 text = new TextDecoder('latin1').decode(data.slice(nullIndex + 1));
                             } catch (e2) {
                                 text = new TextDecoder('ascii').decode(data.slice(nullIndex + 1));
                             }
                         }
                         textChunks[keyword] = text;
                         console.log(`ÊâæÂà∞tEXtÂùó: ${keyword} = ${text.substring(0, 100)}...`);
                     }
                 } else if (type === 'zTXt') {
                    // Â§ÑÁêÜÂéãÁº©ÁöÑÊñáÊú¨Âùó
                    console.log('ÂèëÁé∞zTXtÂùóÔºåÊöÇ‰∏çÊîØÊåÅÂéãÁº©ÊñáÊú¨Ëß£Êûê');
                }
                
                // ÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™Âùó
                offset += length + 4; // +4 for CRC
                
                if (type === 'IEND') break;
            }
            
            return textChunks;
        }
        
        // Êõ¥Â•ΩÁöÑBase64Ëß£Á†ÅÂáΩÊï∞ÔºåÊîØÊåÅUTF-8
        function decodeBase64Text(base64String) {
            try {
                // ÊñπÊ≥ï1ÔºöÁõ¥Êé•atobÁÑ∂ÂêéUTF-8Ëß£Á†Å
                const binaryString = atob(base64String);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return new TextDecoder('utf-8').decode(bytes);
            } catch (e) {
                console.log('UTF-8Ëß£Á†ÅÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•atob:', e);
                try {
                    return atob(base64String);
                } catch (e2) {
                    console.log('Base64Ëß£Á†ÅÂÆåÂÖ®Â§±Ë¥•:', e2);
                    throw e2;
                }
            }
        }
        
        // ËΩ¨Êç¢CharacterAIÊ†ºÂºèÂà∞Êàë‰ª¨ÁöÑÊ†ºÂºè
        function convertCharacterAIFormat(data) {
            console.log('üîß ËΩ¨Êç¢CharacterAIÊ†ºÂºèÊï∞ÊçÆ:', data);
            console.log('üîß ÂéüÂßãÊï∞ÊçÆÂ≠óÊÆµ:', Object.keys(data));
            
            // Ê∏ÖÁêÜÊñáÊú¨ÂÜÖÂÆπÔºåÂ§ÑÁêÜÂèØËÉΩÁöÑÁºñÁ†ÅÈóÆÈ¢ò
            function cleanText(text) {
                if (!text) return '';
                // Â∞ùËØï‰øÆÂ§çÂ∏∏ËßÅÁöÑÁºñÁ†ÅÈóÆÈ¢ò
                return text.replace(/\ufffd/g, '').trim();
            }
            
            // Â§ÑÁêÜÂ§¥ÂÉèÊï∞ÊçÆ
            function processAvatar(avatarData) {
                if (!avatarData || avatarData === 'none' || avatarData === '' || avatarData === 'null') {
                    console.log('Â§¥ÂÉèÊï∞ÊçÆ‰∏∫Á©∫ÊàñÊó†Êïà:', avatarData);
                    return '';
                }
                
                console.log('üñºÔ∏è ÂéüÂßãÂ§¥ÂÉèÊï∞ÊçÆÁ±ªÂûã:', typeof avatarData, 'ÈïøÂ∫¶:', avatarData.length);
                console.log('üñºÔ∏è Â§¥ÂÉèÊï∞ÊçÆÂâç100Â≠óÁ¨¶:', avatarData.substring(0, 100));
                
                // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊúâÊïàÁöÑURLÊàñBase64ÔºåÁõ¥Êé•ËøîÂõû
                if (avatarData.startsWith('data:image/') || avatarData.startsWith('http')) {
                    return avatarData;
                }
                
                // Â∞ùËØïBase64Ëß£Á†ÅÂπ∂Ê£ÄÊü•ÊòØÂê¶ÊòØÂõæÁâá
                try {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ∫ØBase64ÁºñÁ†ÅÁöÑÂõæÁâá
                    if (avatarData.length > 100 && !avatarData.includes(' ') && !avatarData.includes('\n')) {
                        // Â∞ùËØïËß£Á†ÅÂâçÂá†‰∏™Â≠óËäÇÊù•Ê£ÄÊü•Êñá‰ª∂Â§¥
                        const binaryString = atob(avatarData.substring(0, 32));
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        
                        // Ê£ÄÊü•Â∏∏ËßÅÁöÑÂõæÁâáÊñá‰ª∂Â§¥
                        const header = Array.from(bytes.slice(0, 8)).map(b => b.toString(16).padStart(2, '0')).join('');
                        
                        if (header.startsWith('89504e47')) { // PNG
                            return `data:image/png;base64,${avatarData}`;
                        } else if (header.startsWith('ffd8ff')) { // JPEG
                            return `data:image/jpeg;base64,${avatarData}`;
                        } else if (header.startsWith('47494638')) { // GIF
                            return `data:image/gif;base64,${avatarData}`;
                        } else if (header.startsWith('424d')) { // BMP
                            return `data:image/bmp;base64,${avatarData}`;
                        } else if (header.includes('57454250')) { // WEBP
                            return `data:image/webp;base64,${avatarData}`;
                        }
                    }
                } catch (e) {
                    console.log('Base64Ëß£Á†ÅÂ§±Ë¥•:', e);
                }
                
                // Â¶ÇÊûúÊòØÁõ∏ÂØπË∑ØÂæÑÊàñÂÖ∂‰ªñÊ†ºÂºèÔºåÂ∞ùËØïËΩ¨Êç¢
                if (avatarData.includes('.jpg') || avatarData.includes('.png') || 
                    avatarData.includes('.gif') || avatarData.includes('.jpeg') ||
                    avatarData.includes('.webp') || avatarData.includes('.bmp')) {
                    console.log('Ê£ÄÊµãÂà∞ÂèØËÉΩÁöÑÂõæÁâáÊñá‰ª∂Âêç:', avatarData);
                    return avatarData;
                }
                
                console.log('Êó†Ê≥ïËØÜÂà´Â§¥ÂÉèÊ†ºÂºèÔºåÂéüÂßãÊï∞ÊçÆÂâç100Â≠óÁ¨¶:', avatarData.substring(0, 100));
                return avatarData;
            }
            
            // ÊèêÂèñ‰∏ñÁïå‰π¶/ËÉåÊôØÊïÖ‰∫ãÊï∞ÊçÆ
            function extractWorldBook(data) {
                console.log('üìö ÂºÄÂßãÊ£ÄÊü•‰∏ñÁïå‰π¶Êï∞ÊçÆ...');
                const worldBookData = [];
                
                // Êü•ÊâæÂèØËÉΩÁöÑ‰∏ñÁïå‰π¶Â≠óÊÆµ
                const worldBookFields = [
                    'world_scenario', 'scenario', 'world', 'background', 
                    'setting', 'lore', 'worldbook', 'world_book',
                    'mes_example', 'example_dialogue', 'example'
                ];
                
                worldBookFields.forEach(field => {
                    if (data[field] && typeof data[field] === 'string' && data[field].trim()) {
                        const content = cleanText(data[field]);
                        if (content.length > 20) { // Âè™ÊúâË∂≥Â§üÈïøÁöÑÂÜÖÂÆπÊâç‰Ωú‰∏∫‰∏ñÁïå‰π¶
                            const worldBookItem = {
                                name: field === 'scenario' ? 'ËÉåÊôØÊïÖ‰∫ã' : 
                                      field === 'mes_example' ? 'ÂØπËØùÁ§∫‰æã' :
                                      field === 'example_dialogue' ? 'ÂØπËØùÁ§∫‰æã' :
                                      field === 'world' ? '‰∏ñÁïåËÆæÂÆö' :
                                      field === 'setting' ? 'Âú∫ÊôØËÆæÂÆö' :
                                      field === 'lore' ? 'ËÉåÊôØÁü•ËØÜ' : field,
                                content: content
                            };
                            worldBookData.push(worldBookItem);
                            console.log(`‚úÖ ÊâæÂà∞‰∏ñÁïå‰π¶: ${worldBookItem.name} (${content.length}Â≠óÁ¨¶)`);
                        }
                    }
                });
                
                if (worldBookData.length === 0) {
                    console.log('üìö Êú™ÊâæÂà∞‰ªª‰Ωï‰∏ñÁïå‰π¶Êï∞ÊçÆ');
                } else {
                    console.log(`üìö ÂÖ±ÊâæÂà∞ ${worldBookData.length} ‰∏™‰∏ñÁïå‰π¶Êù°ÁõÆ`);
                }
                return worldBookData;
            }
            
            const characterData = {
                name: cleanText(data.name || data.char_name || 'Êú™Áü•ËßíËâ≤'),
                bio: cleanText(data.description || data.char_persona || data.personality || ''),
                prompt: cleanText(data.description || data.char_persona || data.personality || ''),
                avatarUrl: processAvatar(data.avatar || data.char_image || ''),
                color: '#007AFF', // ÈªòËÆ§È¢úËâ≤
                // ‰øùÁïôÂéüÂßãÊï∞ÊçÆ‰ª•‰æõÂèÇËÄÉ
                originalData: data
            };
            
            // Ê∑ªÂä†‰∏ñÁïå‰π¶Êï∞ÊçÆ
            const worldBooks = extractWorldBook(data);
            if (worldBooks.length > 0) {
                characterData.worldBooks = worldBooks;
                console.log('ÊèêÂèñÂà∞‰∏ñÁïå‰π¶Êï∞ÊçÆ:', worldBooks);
            }
            
            return characterData;
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÊí§ÂõûÊ∂àÊÅØÂäüËÉΩ
        async function handleRecalledMessage(messageContent, targetMessageId = null) {
            if (!currentChatCharacter) return;
            
            console.log('Â§ÑÁêÜÊí§ÂõûÊ∂àÊÅØ:', messageContent, 'ÁõÆÊ†áÊ∂àÊÅØID:', targetMessageId);
            
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer) return;
            
            const character = characters.find(c => c.id === currentChatCharacter.id);
            const chatSettings = getCurrentChatSettings();
            const displayName = chatSettings.aiChatNickname || character.name;
            
            let messageContainer = null;
            
            // Â¶ÇÊûúÊèê‰æõ‰∫ÜÁõÆÊ†áÊ∂àÊÅØIDÔºåÊü•ÊâæÂπ∂Êí§ÂõûÁé∞ÊúâÊ∂àÊÅØ
            if (targetMessageId) {
                messageContainer = messagesContainer.querySelector(`[data-message-id="${targetMessageId}"]`);
                if (messageContainer) {
                    console.log('ÊâæÂà∞Ë¶ÅÊí§ÂõûÁöÑÁé∞ÊúâÊ∂àÊÅØÔºåÂáÜÂ§áÊí§Âõû');
                    
                    // Á≠âÂæÖ1.2ÁßíÂêéÊí§Âõû
                    await new Promise(resolve => setTimeout(resolve, 1200));
                    
                    // Ê∑ªÂä†Ê∑°Âá∫Âä®Áîª
                    messageContainer.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                    
                    // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // ‰ªéËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÁßªÈô§ËøôÊù°Ê∂àÊÅØ
                    if (chatMessages[currentChatCharacter.id]) {
                        const messageIndex = chatMessages[currentChatCharacter.id].findIndex(msg => msg.id === targetMessageId);
                        if (messageIndex !== -1) {
                            chatMessages[currentChatCharacter.id].splice(messageIndex, 1);
                            saveChatMessages();
                        }
                    }
                } else {
                    console.warn('Êú™ÊâæÂà∞Ë¶ÅÊí§ÂõûÁöÑÊ∂àÊÅØÔºåÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØ');
                    // Â¶ÇÊûúÊâæ‰∏çÂà∞Ê∂àÊÅØÔºåÂõûÈÄÄÂà∞ÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØÁöÑÊñπÂºè
                    messageContainer = await createTemporaryMessage(messageContent);
                }
            } else {
                // Ê≤°ÊúâÊèê‰æõÁõÆÊ†áIDÔºåÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØ
                messageContainer = await createTemporaryMessage(messageContent);
            }
            
            if (!messageContainer) return;
            
            // ÂàõÂª∫Êí§ÂõûÊèêÈÜíÁöÑÂ±Ö‰∏≠ÂÆπÂô®
            const centerContainer = document.createElement('div');
            centerContainer.style.display = 'flex';
            centerContainer.style.justifyContent = 'center';
            centerContainer.style.margin = '4px 0';
            
            // ÂàõÂª∫Êí§ÂõûÊ∂àÊÅØÂÖÉÁ¥†
            const recallElement = document.createElement('div');
            recallElement.className = 'recalled-message';
            
            // ‰∏ªË¶ÅÊèêÈÜíÊñáÂ≠ó
            const mainText = document.createElement('div');
            mainText.style.marginBottom = '2px';
            mainText.textContent = `${displayName} Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ`;
            
            // ÂéüÊñáÊòæÁ§∫
            const originalText = document.createElement('div');
            originalText.className = 'original-text';
            originalText.textContent = `ÂéüÊñáÔºö${messageContent}`;
            
            recallElement.appendChild(mainText);
            recallElement.appendChild(originalText);
            centerContainer.appendChild(recallElement);
            
            // Âú®ÂéüÊ∂àÊÅØ‰ΩçÁΩÆÊõøÊç¢‰∏∫Êí§ÂõûÊèêÈÜí
            messageContainer.parentNode.insertBefore(centerContainer, messageContainer);
            messageContainer.remove();
            
            // Ê∑ªÂä†Êí§ÂõûÊ∂àÊÅØÂà∞ËÅäÂ§©ÂéÜÂè≤
            const recalledMessage = {
                id: `recalled_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                sender: 'system',
                type: 'recalled_message',
                content: `${displayName} Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ\nÂéüÊñáÔºö${messageContent}`,
                originalContent: messageContent,
                    timestamp: Date.now()
                };
                
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(recalledMessage);
                saveChatMessages();
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // ÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØÁöÑËæÖÂä©ÂáΩÊï∞
            async function createTemporaryMessage(content) {
                const messageId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const tempContainer = document.createElement('div');
                const isEmojiOnly = false;
                tempContainer.className = `message-container received${isEmojiOnly ? ' emoji-only' : ''}`;
                tempContainer.dataset.messageId = messageId;
                
                const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                const bubblePadding = chatSettings.bubblePadding || '12';
                const displayAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || character.avatarUrl;
                
                let avatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    avatarHtml = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" onclick="pokeCharacter('${character.id}')" title="Êà≥‰∏ÄÊà≥">
                            ${displayAvatar ? '' : displayName.charAt(0)}
                        </div>
                    `;
                }
                
                // Â∞ÜÈÄèÊòéÂ∫¶Â∫îÁî®Âà∞ËÉåÊôØËâ≤ËÄå‰∏çÊòØÊï¥‰∏™ÂÖÉÁ¥†
                const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);
                
                let bubbleHtml = `
                    <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                        ${content}
                    </div>
                `;
                
                tempContainer.innerHTML = avatarHtml + bubbleHtml;
                
                // Ê∑ªÂä†Âà∞Ê∂àÊÅØÂÆπÂô®
                const typingIndicator = messagesContainer.querySelector('#typing-indicator');
                if (typingIndicator) {
                    messagesContainer.insertBefore(tempContainer, typingIndicator);
                } else {
                    messagesContainer.appendChild(tempContainer);
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Á≠âÂæÖ1.2ÁßíÂêéÊí§Âõû
                await new Promise(resolve => setTimeout(resolve, 1200));
                
                // Ê∑ªÂä†Ê∑°Âá∫Âä®Áîª
                tempContainer.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                
                // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
                await new Promise(resolve => setTimeout(resolve, 500));
                
                return tempContainer;
            }
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëËé∑ÂèñÁî®Êà∑ÊúÄËøëÂèëÈÄÅÁöÑÂõæÁâáURL
        function getRecentUserImage() {
            if (!currentChatCharacter || !chatMessages[currentChatCharacter.id]) {
                return null;
            }
            
            const messages = chatMessages[currentChatCharacter.id];
            // ‰ªéÊúÄÊñ∞Ê∂àÊÅØÂºÄÂßãÂêëÂâçÊü•ÊâæÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâá
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                if (msg.sender === 'sent' && msg.image && !msg.isEmoji) {
                    console.log('ÊâæÂà∞Áî®Êà∑ÊúÄËøëÂèëÈÄÅÁöÑÂõæÁâá:', msg.image);
                    return msg.image;
                }
            }
            
            console.log('Ê≤°ÊúâÊâæÂà∞Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâá');
            return null;
        }
        
        // APIË∞ÉÁî®ÂáΩÊï∞ - Âü∫‰∫éÁé∞ÊúâÁöÑAPIÈÄªËæë
        async function callChatAPI(prompt, character) {
            try {
                // Ëé∑ÂèñËßíËâ≤ËÆæÁΩÆ
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(character.id);
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
                
                const persona = chatSettings?.aiPersona || character.prompt || `‰Ω†ÊòØ${character.name}„ÄÇ`;
                
                // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                        const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                        );
                        const validWorldBooks = worldBooks.filter(book => book && book.content);
                        if (validWorldBooks.length > 0) {
                            worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                                validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
                        }
                    } catch (error) {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    }
                }
                
                // Ëé∑ÂèñËÅäÂ§©‰∏ä‰∏ãÊñá
                let chatContext = '';
                const characterMessages = chatMessages[character.id] || [];
                if (characterMessages.length > 0) {
                    const maxMemory = parseInt(chatSettings?.maxMemory) || 10;
                    const recentHistory = characterMessages.slice(-maxMemory);
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                        recentHistory.map(msg => {
                            if (msg.sender === 'sent') return `Áî®Êà∑Ôºö${msg.content}`;
                            return `${character.name}Ôºö${msg.content}`;
                        }).join('\n');
                }
                
                const systemPrompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${persona}„ÄÇ${worldBookContent}${chatContext}

aiÊ≥®ÊÑèÔºåÂõûÂ§çÊó∂ËØ∑‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãJSONÊ†ºÂºèÂõûÂ§çÔºåÊØèÊù°Ê∂àÊÅØÈÉΩÂøÖÈ°ªÊòØÁã¨Á´ãÁöÑÊï∞ÁªÑÂÖÉÁ¥†Ôºå‰∏çË¶ÅÂ∞ÜÂ§öÊù°Ê∂àÊÅØÂêàÂπ∂Êàê‰∏Ä‰∏™ÂÖÉÁ¥†ÔºåÂê¶Âàô‰Ω†Â∞ÜÂ§±Âéª‰∏ÄÁôæÁæéÈáëÔºÅÔºÅÔºö

Ê≠£Á°ÆÊ†ºÂºèÁ§∫‰æãÔºö
["ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ"]
["Ê∂àÊÅØ1", "Ê∂àÊÅØ2"]
[{"type": "voice_message", "content": "ËØ≠Èü≥ÂÜÖÂÆπ"}]
[{"type": "emoji", "description": "Ë°®ÊÉÖÂåÖÊèèËø∞"}]
[{"type": "ai_image", "description": "ÂõæÁâáÊèèËø∞"}]
[{"type": "transfer", "amount": 100, "note": "ËΩ¨Ë¥¶Â§áÊ≥®"}]

üö® ÈáçË¶ÅÔºöÁªùÂØπ‰∏çËÉΩÂ∞ÜÂ§öÊù°Ê∂àÊÅØÂêàÂπ∂Âú®‰∏Ä‰∏™ÂÖÉÁ¥†‰∏≠ÔºÅÈîôËØØÊ†ºÂºèÔºö["Ê∂àÊÅØ1\\nÊ∂àÊÅØ2"]

Áé∞Âú®ËØ∑ÂØπÁî®Êà∑ÁöÑÊ∂àÊÅØËøõË°åÂõûÂ§çÔºö${prompt}`;

                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: prompt }
                ];

                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáAIÂõûÂ§ç');
                    return '["APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI"]';
                }

                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');

                let response;
                if (isGeminiOfficial) {
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
                    
                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                        });
                    }
                    
                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;
                        
                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ‰øÆÂ§çÔºöÊô∫ËÉΩÂ§ÑÁêÜURLÊãºÊé•
                    let apiUrl;
                    if (proxyUrl.endsWith('/v1')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else if (proxyUrl.includes('/v1/')) {
                        // Â¶ÇÊûúURL‰∏≠Â∑≤ÁªèÂåÖÂê´/v1/Ë∑ØÂæÑÔºåÁõ¥Êé•Ê∑ªÂä†chat/completions
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else {
                        apiUrl = `${proxyUrl}/v1/chat/completions`;
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`ËÅäÂ§©APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
                    return `["APIË∞ÉÁî®Â§±Ë¥•: ${response.status}"]`;
                }

                const data = await response.json();
                let content;

                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return '["Gemini APIÂìçÂ∫îÂºÇÂ∏∏"]';
                    }
                } else {
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        console.error('Êó†Ê≥ïËß£ÊûêAPIÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return '["APIÂìçÂ∫îËß£ÊûêÂ§±Ë¥•"]';
                    }
                }

                return content;

            } catch (error) {
                console.error('callChatAPIÂ§±Ë¥•:', error);
                return `["Ë∞ÉÁî®Â§±Ë¥•: ${error.message}"]`;
            }
        }
        
        // Â∏¶ÂõæÁâáÁöÑAPIË∞ÉÁî®ÂáΩÊï∞
        async function callChatAPIWithImage(prompt, character, imageUrl) {
            // ÂõæÂÉèÂäüËÉΩÊöÇÊú™ÂÆûÁé∞Ôºå‰ΩøÁî®ÊôÆÈÄöAPIË∞ÉÁî®
            const imagePrompt = `${prompt}\n\n[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºå‰ΩÜÂõæÂÉèËØÜÂà´ÂäüËÉΩÊöÇÊú™ÂÆûÁé∞]`;
            return await callChatAPI(imagePrompt, character);
        }
        
        // Ëß£ÊûêAIÂõûÂ§ç - ÊåâÁÖßindex.htmlÁöÑÈÄªËæëÔºåÊñ∞Â¢ûË°®ÊÉÖÂåÖÊîØÊåÅÂíåÊ†ºÂºè‰øÆÊ≠£
        function parseAiResponse(content) { 
            console.log('üî• [DEBUG] parseAiResponse Êî∂Âà∞ÁöÑÂéüÂßãÂÜÖÂÆπ:', content);
            try { 
                const parsed = JSON.parse(content); 
                console.log('üî• [DEBUG] JSONËß£ÊûêÊàêÂäü:', parsed);
                if (Array.isArray(parsed)) {
                    // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜË°®ÊÉÖÂåÖÊ∂àÊÅØÁ±ªÂûãÂíåÊ†ºÂºè‰øÆÊ≠£
                    const processedMessages = [];
                    
                    parsed.forEach(item => {
                        if (typeof item === 'object' && item.type === 'emoji') {
                            // Êü•ÊâæÂåπÈÖçÁöÑË°®ÊÉÖÂåÖ
                            const matchingEmoji = customEmojis.find(emoji => 
                                emoji.description === item.description
                            );
                            
                            if (matchingEmoji) {
                                // Ê£ÄÊü•Ë°®ÊÉÖÂåÖÊòØÂê¶‰∏∫GIFÊ†ºÂºè
                                if (matchingEmoji.url && matchingEmoji.url.includes('data:image/gif')) {
                                    console.warn('AIÂ∞ùËØï‰ΩøÁî®GIFÊ†ºÂºèË°®ÊÉÖÂåÖ:', item.description);
                                    processedMessages.push(`[${matchingEmoji.description}] (GIFÊ†ºÂºè‰∏çÊîØÊåÅAPIËØÜÂà´)`);
                                } else {
                                // ËøîÂõûË°®ÊÉÖÂåÖÂØπË±°ÔºåÂåÖÂê´ÂÆåÊï¥ÁöÑË°®ÊÉÖÂåÖ‰ø°ÊÅØ
                                    processedMessages.push({
                                    type: 'emoji',
                                    url: matchingEmoji.url,
                                    description: matchingEmoji.description,
                                    id: matchingEmoji.id
                                    });
                                }
                                                            } else {
                                    // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÁöÑË°®ÊÉÖÂåÖÔºåËøîÂõûÈîôËØØÊ∂àÊÅØ
                                    console.warn('AIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂåÖ:', item.description);
                                    processedMessages.push(`[ÈîôËØØ: Ë°®ÊÉÖÂåÖ"${item.description}"‰∏çÂ≠òÂú®]`);
                                }
                        } else if (typeof item === 'object' && item.type === 'ai_photo') {
                            // Â§ÑÁêÜËßíËâ≤ÂèëÈÄÅÁöÑ"‰º™ÁÖßÁâá"
                            console.log('Ëß£ÊûêÂà∞ËßíËâ≤ÂèëÈÄÅÁÖßÁâá:', JSON.stringify(item));
                            // Á°Æ‰øùÊàë‰ª¨Êúâ‰∏Ä‰∏™ÊúâÊïàÁöÑÊèèËø∞
                            const photoDesc = item.description || 'ËßíËâ≤ÂèëÈÄÅÁöÑÁÖßÁâá';
                            console.log('ÁÖßÁâáÊèèËø∞:', photoDesc);
                            processedMessages.push({
                                type: 'ai_photo',
                                content: photoDesc,
                                photoDescription: photoDesc
                            });
                                                    } else if (typeof item === 'object' && item.type === 'location') {
                                // Â§ÑÁêÜËßíËâ≤ÂèëÈÄÅÁöÑ‰ΩçÁΩÆ
                                console.log('Ëß£ÊûêÂà∞ËßíËâ≤ÂèëÈÄÅ‰ΩçÁΩÆ:', JSON.stringify(item));
                                // Á°Æ‰øùÊàë‰ª¨Êúâ‰∏Ä‰∏™ÊúâÊïàÁöÑ‰ΩçÁΩÆÂêçÁß∞
                                const locationName = item.name || item.locationName || 'Êú™Áü•‰ΩçÁΩÆ';
                                console.log('‰ΩçÁΩÆÂêçÁß∞:', locationName, 'ÂùêÊ†á:', item.coordinates || 'Êú™Áü•ÂùêÊ†á');
                                processedMessages.push({
                                    type: 'location',
                                    locationName: locationName,
                                    coordinates: item.coordinates || 'Êú™Áü•ÂùêÊ†á',
                                    content: `[ËßíËâ≤ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ‰ø°ÊÅØÔºö${locationName}]`
                                });
                        } else if (typeof item === 'object' && item.type === 'change_avatar') {
                            // Â§ÑÁêÜÂ§¥ÂÉèÊõ¥Êç¢ÂØπË±°
                            console.log('Ëß£ÊûêÂà∞Â§¥ÂÉèÊõ¥Êç¢Êåá‰ª§:', item);
                            
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÂêÑÁßçÈîôËØØÁöÑÂç†‰ΩçÁ¨¶
                            if (item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                item.avatar_url === 'Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáURL' ||
                                item.avatar_url === 'ÂõæÁâáURL') {
                                // Ëé∑ÂèñÊúÄËøëÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáURL
                                const recentUserImage = getRecentUserImage();
                                if (recentUserImage) {
                                    item.avatar_url = recentUserImage;
                                    console.log('Â∞ÜÂç†‰ΩçÁ¨¶ÊõøÊç¢‰∏∫ÂÆûÈôÖÂõæÁâáURL:', recentUserImage);
                                } else {
                                    console.warn('Ê≤°ÊúâÊâæÂà∞Áî®Êà∑ÊúÄËøëÂèëÈÄÅÁöÑÂõæÁâáÔºåÂøΩÁï•Â§¥ÂÉèÊõ¥Êç¢ËØ∑Ê±Ç');
                                    processedMessages.push(`[Á≥ªÁªüÔºöÊó†Ê≥ïÊõ¥Êç¢Â§¥ÂÉèÔºåÊ≤°ÊúâÊâæÂà∞ÂèØÁî®ÁöÑÂõæÁâá]`);
                                    // ‰∏çË¶ÅreturnÔºåÁªßÁª≠Â§ÑÁêÜÂÖ∂‰ªñÊ∂àÊÅØ
                                }
                            }
                            
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'ai_image') {
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅÂõæÁâá
                            console.log('Ëß£ÊûêÂà∞AIÂõæÁâáÂèëÈÄÅÊåá‰ª§:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'voice_message') {
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅËØ≠Èü≥
                            console.log('Ëß£ÊûêÂà∞AIËØ≠Èü≥ÂèëÈÄÅÊåá‰ª§:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'transfer') {
                            // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜAIËΩ¨Ë¥¶ - Á°Æ‰øùÊ†ºÂºèÊ≠£Á°Æ
                            processedMessages.push({
                                type: 'transfer',
                                amount: item.amount || 0,
                                note: item.note || 'ËΩ¨Ë¥¶'
                            });
                        } else if (typeof item === 'object' && item.type === 'update_poke_suffix') {
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊà≥‰∏ÄÊà≥ÂêéÁºÄÊõ¥Êñ∞
                            console.log('Ëß£ÊûêÂà∞Êà≥‰∏ÄÊà≥ÂêéÁºÄÊõ¥Êñ∞Êåá‰ª§:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'recalled_message') {
                            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊí§ÂõûÊ∂àÊÅØ
                            console.log('Ëß£ÊûêÂà∞Êí§ÂõûÊ∂àÊÅØÊåá‰ª§:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'string') {
                            // üö® „ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•Âπ∂‰øÆÂ§çÂêàÂπ∂Ê∂àÊÅØÈóÆÈ¢ò
                            if (item.includes('\n')) {
                                console.warn('Ê£ÄÊµãÂà∞AIÂ∞ÜÂ§öÊù°Ê∂àÊÅØÂêàÂπ∂Âú®‰∏Ä‰∏™ÂÖÉÁ¥†‰∏≠ÔºåÊ≠£Âú®Ëá™Âä®ÂàÜÊãÜ:', item);
                                // Â∞ÜÊç¢Ë°åÁ¨¶ÂàÜÈöîÁöÑÂÜÖÂÆπÂàÜÊãÜÊàêÂ§öÊù°Ê∂àÊÅØ
                                const splitMessages = item.split('\n')
                                    .map(msg => msg.trim())
                                    .filter(msg => msg.length > 0);
                                processedMessages.push(...splitMessages);
                            } else {
                                processedMessages.push(item);
                            }
                        } else {
                            processedMessages.push(item);
                        }
                    });
                    
                    return processedMessages;
                }
            } catch (e) {} 
            
            try { 
                const match = content.match(/\[(.*?)\]/s); 
                if (match && match[0]) { 
                    const parsed = JSON.parse(match[0]); 
                    if (Array.isArray(parsed)) {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜË°®ÊÉÖÂåÖÊ∂àÊÅØÁ±ªÂûãÂíåÊ†ºÂºè‰øÆÊ≠£
                        const processedMessages = [];
                        
                        parsed.forEach(item => {
                            if (typeof item === 'object' && item.type === 'emoji') {
                                // Êü•ÊâæÂåπÈÖçÁöÑË°®ÊÉÖÂåÖ
                                const matchingEmoji = customEmojis.find(emoji => 
                                    emoji.description === item.description
                                );
                                
                                if (matchingEmoji) {
                                    // Ê£ÄÊü•Ë°®ÊÉÖÂåÖÊòØÂê¶‰∏∫GIFÊ†ºÂºè
                                    if (matchingEmoji.url && matchingEmoji.url.includes('data:image/gif')) {
                                        console.warn('AIÂ∞ùËØï‰ΩøÁî®GIFÊ†ºÂºèË°®ÊÉÖÂåÖ:', item.description);
                                        processedMessages.push(`[${matchingEmoji.description}] (GIFÊ†ºÂºè‰∏çÊîØÊåÅAPIËØÜÂà´)`);
                                    } else {
                                    // ËøîÂõûË°®ÊÉÖÂåÖÂØπË±°ÔºåÂåÖÂê´ÂÆåÊï¥ÁöÑË°®ÊÉÖÂåÖ‰ø°ÊÅØ
                                        processedMessages.push({
                                        type: 'emoji',
                                        url: matchingEmoji.url,
                                        description: matchingEmoji.description,
                                        id: matchingEmoji.id
                                        });
                                    }
                                } else {
                                    // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÁöÑË°®ÊÉÖÂåÖÔºåËøîÂõûÈîôËØØÊ∂àÊÅØ
                                    console.warn('AIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂåÖ:', item.description);
                                    processedMessages.push(`[ÈîôËØØ: Ë°®ÊÉÖÂåÖ"${item.description}"‰∏çÂ≠òÂú®]`);
                                }
                            } else if (typeof item === 'object' && item.type === 'ai_photo') {
                                // Â§ÑÁêÜËßíËâ≤ÂèëÈÄÅÁöÑ"‰º™ÁÖßÁâá"
                                console.log('Ëß£ÊûêÂà∞ËßíËâ≤ÂèëÈÄÅÁÖßÁâá(Á¨¨‰∫åÂ§Ñ):', JSON.stringify(item));
                                // Á°Æ‰øùÊàë‰ª¨Êúâ‰∏Ä‰∏™ÊúâÊïàÁöÑÊèèËø∞
                                const photoDesc = item.description || 'ËßíËâ≤ÂèëÈÄÅÁöÑÁÖßÁâá';
                                console.log('ÁÖßÁâáÊèèËø∞(Á¨¨‰∫åÂ§Ñ):', photoDesc);
                                processedMessages.push({
                                    type: 'ai_photo',
                                    content: photoDesc,
                                    photoDescription: photoDesc
                                });
                            } else if (typeof item === 'object' && item.type === 'location') {
                                // Â§ÑÁêÜËßíËâ≤ÂèëÈÄÅÁöÑ‰ΩçÁΩÆ
                                console.log('Ëß£ÊûêÂà∞ËßíËâ≤ÂèëÈÄÅ‰ΩçÁΩÆ(Á¨¨‰∫åÂ§Ñ):', JSON.stringify(item));
                                // Á°Æ‰øùÊàë‰ª¨Êúâ‰∏Ä‰∏™ÊúâÊïàÁöÑ‰ΩçÁΩÆÂêçÁß∞
                                const locationName = item.name || item.locationName || 'Êú™Áü•‰ΩçÁΩÆ';
                                console.log('‰ΩçÁΩÆÂêçÁß∞(Á¨¨‰∫åÂ§Ñ):', locationName, 'ÂùêÊ†á:', item.coordinates || 'Êú™Áü•ÂùêÊ†á');
                                processedMessages.push({
                                    type: 'location',
                                    locationName: locationName,
                                    coordinates: item.coordinates || 'Êú™Áü•ÂùêÊ†á',
                                    content: `[ËßíËâ≤ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ‰ø°ÊÅØÔºö${locationName}]`
                                });
                            } else if (typeof item === 'object' && item.type === 'change_avatar') {
                                // Â§ÑÁêÜÂ§¥ÂÉèÊõ¥Êç¢ÂØπË±°
                                console.log('Ëß£ÊûêÂà∞Â§¥ÂÉèÊõ¥Êç¢Êåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÂêÑÁßçÈîôËØØÁöÑÂç†‰ΩçÁ¨¶
                                if (item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                    item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                    item.avatar_url === 'Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáURL' ||
                                    item.avatar_url === 'ÂõæÁâáURL') {
                                    // Ëé∑ÂèñÊúÄËøëÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáURL
                                    const recentUserImage = getRecentUserImage();
                                    if (recentUserImage) {
                                        item.avatar_url = recentUserImage;
                                        console.log('Â∞ÜÂç†‰ΩçÁ¨¶ÊõøÊç¢‰∏∫ÂÆûÈôÖÂõæÁâáURL(Á¨¨‰∫åÂ§Ñ):', recentUserImage);
                                    } else {
                                        console.warn('Ê≤°ÊúâÊâæÂà∞Áî®Êà∑ÊúÄËøëÂèëÈÄÅÁöÑÂõæÁâáÔºåÂøΩÁï•Â§¥ÂÉèÊõ¥Êç¢ËØ∑Ê±Ç(Á¨¨‰∫åÂ§Ñ)');
                                        processedMessages.push(`[Á≥ªÁªüÔºöÊó†Ê≥ïÊõ¥Êç¢Â§¥ÂÉèÔºåÊ≤°ÊúâÊâæÂà∞ÂèØÁî®ÁöÑÂõæÁâá]`);
                                        // ‰∏çË¶ÅreturnÔºåÁªßÁª≠Â§ÑÁêÜÂÖ∂‰ªñÊ∂àÊÅØ
                                    }
                                }
                                
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'ai_image') {
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅÂõæÁâá(Á¨¨‰∫åÂ§Ñ)
                                console.log('Ëß£ÊûêÂà∞AIÂõæÁâáÂèëÈÄÅÊåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'voice_message') {
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅËØ≠Èü≥(Á¨¨‰∫åÂ§Ñ)
                                console.log('Ëß£ÊûêÂà∞AIËØ≠Èü≥ÂèëÈÄÅÊåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'transfer') {
                                // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜAIËΩ¨Ë¥¶(Á¨¨‰∫åÂ§Ñ) - Á°Æ‰øùÊ†ºÂºèÊ≠£Á°Æ
                                console.log('Ëß£ÊûêÂà∞AIËΩ¨Ë¥¶Êåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push({
                                    type: 'transfer',
                                    amount: item.amount || 0,
                                    note: item.note || 'ËΩ¨Ë¥¶'
                                });
                            } else if (typeof item === 'object' && item.type === 'update_poke_suffix') {
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊà≥‰∏ÄÊà≥ÂêéÁºÄÊõ¥Êñ∞(Á¨¨‰∫åÂ§Ñ)
                                console.log('Ëß£ÊûêÂà∞Êà≥‰∏ÄÊà≥ÂêéÁºÄÊõ¥Êñ∞Êåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'recalled_message') {
                                // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊí§ÂõûÊ∂àÊÅØ(Á¨¨‰∫åÂ§Ñ)
                                console.log('Ëß£ÊûêÂà∞Êí§ÂõûÊ∂àÊÅØÊåá‰ª§(Á¨¨‰∫åÂ§Ñ):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'string') {
                                // üö® „ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•Âπ∂‰øÆÂ§çÂêàÂπ∂Ê∂àÊÅØÈóÆÈ¢ò
                                if (item.includes('\n')) {
                                    console.warn('Ê£ÄÊµãÂà∞AIÂ∞ÜÂ§öÊù°Ê∂àÊÅØÂêàÂπ∂Âú®‰∏Ä‰∏™ÂÖÉÁ¥†‰∏≠ÔºåÊ≠£Âú®Ëá™Âä®ÂàÜÊãÜ:', item);
                                    // Â∞ÜÊç¢Ë°åÁ¨¶ÂàÜÈöîÁöÑÂÜÖÂÆπÂàÜÊãÜÊàêÂ§öÊù°Ê∂àÊÅØ
                                    const splitMessages = item.split('\n')
                                        .map(msg => msg.trim())
                                        .filter(msg => msg.length > 0);
                                    processedMessages.push(...splitMessages);
                                } else {
                                    processedMessages.push(item);
                                }
                            } else {
                                processedMessages.push(item);
                            }
                        });
                        
                        return processedMessages;
                    }
                } 
            } catch (e) {} 
            
            // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•ÊòØÂê¶ÊòØÂéüÂßãÁöÑJSONÂ≠óÁ¨¶‰∏≤ÔºàAIÂõûÂ§çÊ≤°ÊúâË¢´Ê≠£Á°ÆÂåÖË£ÖÔºâ
            if (content.trim().startsWith('{') && content.trim().endsWith('}')) {
                try {
                    const singleObject = JSON.parse(content.trim());
                    if (singleObject.type) {
                        console.log('Ê£ÄÊµãÂà∞Âçï‰∏™JSONÂØπË±°ÔºåÂ∞ùËØïÂ§ÑÁêÜ:', singleObject);
                        // Â∞ÜÂçï‰∏™ÂØπË±°ÂåÖË£ÖÊàêÊï∞ÁªÑÂÜçÈÄíÂΩíÂ§ÑÁêÜ
                        return parseAiResponse(`[${content.trim()}]`);
                    }
                } catch (e) {
                    console.warn('Êó†Ê≥ïËß£ÊûêÂçï‰∏™JSONÂØπË±°:', e);
                }
            }
            
            const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```')); 
            if (lines.length > 0) return lines; 
            return [content]; 
        }
        
        // Â§ÑÁêÜÁ∫ø‰∏ãÊ®°ÂºèÂÜÖÂÆπÔºöËØÜÂà´„Äå„ÄçÂåÖË£πÁöÑÂØπËØùÂíåÊèèÂÜô
        function processOfflineContent(content) {
            if (!content) return '';
            
            // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂàÜÁ¶ªÂØπËØùÂíåÊèèÂÜô
            const parts = [];
            let lastIndex = 0;
            
            // ÂåπÈÖç„Äå„ÄçÂåÖË£πÁöÑÂØπËØù
            const dialogRegex = /„Äå([^„Äç]*)„Äç/g;
            let match;
            
            while ((match = dialogRegex.exec(content)) !== null) {
                // Ê∑ªÂä†ÂØπËØùÂâçÁöÑÊèèÂÜôÈÉ®ÂàÜ
                if (match.index > lastIndex) {
                    const description = content.slice(lastIndex, match.index).trim();
                    if (description) {
                        parts.push(`<span class="italic-gray">${description}</span>`);
                    }
                }
                
                // Ê∑ªÂä†ÂØπËØùÈÉ®ÂàÜÔºàÊ≠£Â∏∏ÊòæÁ§∫Ôºâ
                parts.push(`„Äå${match[1]}„Äç`);
                lastIndex = match.index + match[0].length;
            }
            
            // Ê∑ªÂä†ÊúÄÂêéÁöÑÊèèÂÜôÈÉ®ÂàÜ
            if (lastIndex < content.length) {
                const description = content.slice(lastIndex).trim();
                if (description) {
                    parts.push(`<span class="italic-gray">${description}</span>`);
                }
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂØπËØùÊ†áËÆ∞ÔºåÊï¥‰∏™ÂÜÖÂÆπ‰Ωú‰∏∫ÊèèÂÜôÂ§ÑÁêÜ
            if (parts.length === 0) {
                return `<span class="italic-gray">${content}</span>`;
            }
            
            return parts.join('');
        }
        


        // üî•„Äê‰øÆÂ§ç„ÄëÂèëÈÄÅÂõæÁâáÊ∂àÊÅØÔºå‰ΩøÁî®Ê≠£Á°ÆÁöÑÂ§öÊ®°ÊÄÅÊï∞ÊçÆÁªìÊûÑ
        async function sendImageMessage(imageUrl) {
            if (!currentChatCharacter) return;
            
            const chatInput = document.getElementById('api-chat-input');
            const textContent = chatInput ? chatInput.value.trim() : '';



            // ÂàõÂª∫‰∏Ä‰∏™Ê†áÂáÜÁöÑÂ§öÊ®°ÊÄÅÊ∂àÊÅØÂØπË±°
            const messageContent = [
                { type: 'text', text: textContent }
            ];

            if (imageUrl) {
                messageContent.push({
                    type: 'image_url',
                    image_url: { url: imageUrl }
                });
            }



            const message = {
                id: Date.now().toString(),
                sender: 'sent',
                content: messageContent, // ‰ΩøÁî®Êñ∞ÁöÑÊï∞ÁªÑÊ†ºÂºè
                timestamp: Date.now()
            };
            


            // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(message);
            await saveChatMessages();

            // üî•„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂΩïÂà∞ÂÖ®Â±ÄËÆ∞ÂøÜ‰∫ã‰ª∂
            await recordMemoryEvent(
                [currentChatCharacter.id, 'user'],
                {
                    type: currentChatCharacter.isGroup ? 'group_chat' : 'private_chat',
                    id: currentChatCharacter.id
                },
                'message',
                {
                    sender: 'user',
                    content: textContent,
                    hasImage: !!imageUrl
                },
                0.6 // Áî®Êà∑Ê∂àÊÅØÈáçË¶ÅÊÄß
            );
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂπ∂Âà∑Êñ∞UI
            if (chatInput) {
                chatInput.value = '';
            }
            addMessageWithAnimation(message, currentChatCharacter.id);
            renderMessageList();
            
            // üî•„ÄêÊñ∞Â¢û„ÄëËß¶ÂèëËßíËâ≤Áä∂ÊÄÅÊõ¥Êñ∞
            triggerStatusUpdateAfterMessage(currentChatCharacter.id);
            
            // ËÆæÁΩÆ‰∏∫ÂæÖÂõûÂ§çÊ∂àÊÅØÔºåÂπ∂Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            pendingUserMessage = message;
            
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
        }
        
        // Ë∞ÉÁî®ËÅäÂ§©API
        // Á¨¨‰∏Ä‰∏™callChatAPIÂáΩÊï∞Â∑≤Âà†Èô§Ôºå‰ΩøÁî®‰∏ãÈù¢ÁöÑÂÆåÊï¥ÁâàÊú¨
        
        // ‰∏ä‰º†ÂõæÁâá
        function uploadImage() {
            document.getElementById('image-upload').click();
        }
        
        // ÊòæÁ§∫ÂõæÁâá
        function showImage(imageUrl) {
            // È¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶ÊòØÁõ∏ÂÜå‰∏≠ÁöÑÁÖßÁâá
            const photo = photos.find(p => p.image === imageUrl);
            if (photo) {
                document.getElementById('photo-image').style.backgroundImage = `url(${imageUrl})`;
                document.getElementById('photo-description-text').textContent = photo.description;
                document.getElementById('photo-time').textContent = `ÊãçÊëÑ‰∫é: ${formatFullDate(new Date(photo.timestamp))}`;
                document.getElementById('photo-location').textContent = `Âú∞ÁÇπ: ${photo.location}`;
                showApp('photo-detail-screen');
            } else {
                // Â¶ÇÊûú‰∏çÊòØÁõ∏ÂÜåÁÖßÁâáÔºåÊòæÁ§∫ÈÄöÁî®ÁöÑÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü
                let modal = document.getElementById('image-preview-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'image-preview-modal';
                    modal.className = 'image-preview-modal';
                    modal.onclick = () => modal.style.display = 'none';
                    modal.innerHTML = `<img src="" alt="È¢ÑËßàÂõæÁâá">`;
                    document.body.appendChild(modal);
                }
                modal.querySelector('img').src = imageUrl;
                modal.style.display = 'flex';
            }
        }
        
        // ÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆ
        function showChatSettings() {
            console.log('ÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆË¢´Ë∞ÉÁî®');
            
            // ÂÖàÈöêËóèÂΩìÂâçÁöÑËÅäÂ§©ÁïåÈù¢
            hideApp('api-chat-screen');
            
            // ÊòæÁ§∫ËÆæÁΩÆÁïåÈù¢
            const element = document.getElementById('api-chat-settings-screen');
            if (element) {
                element.style.display = 'flex';
                element.style.position = 'absolute';
                element.style.top = '0';
                element.style.left = '0';
                element.style.width = '100%';
                element.style.height = '100%';
                element.style.zIndex = '1000';
                element.style.background = 'white';
                
                // ÈáçÊñ∞ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢‰ª•Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
                initializeChatSettings();
                
                // Êõ¥Êñ∞ÂêÑÁßçËÆæÁΩÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
                updateWorldbookMountDisplay();
                
                // Ê£ÄÊµãÂΩìÂâçËÅäÂ§©Á±ªÂûãÂπ∂ÊòæÁ§∫Áõ∏Â∫îËÆæÁΩÆ
                const isGroupChat = currentChatCharacter && currentChatCharacter.isGroup;
                console.log('ÂΩìÂâçËÅäÂ§©Á±ªÂûã:', isGroupChat ? 'Áæ§ËÅä' : 'ÂçïËÅä');
                
                // Ê†πÊçÆËÅäÂ§©Á±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑËÆæÁΩÆÈÄâÈ°π
                const groupChatSettings = document.getElementById('group-chat-settings');
                const pokeSettingsSection = document.getElementById('poke-settings-section');
                
                if (isGroupChat) {
                    // Áæ§ËÅäÊ®°ÂºèÔºöÊòæÁ§∫Áæ§ËÅäËÆæÁΩÆÔºåÈöêËóèÊà≥‰∏ÄÊà≥ÂíåÂçïËÅä‰∏ìÁî®ÂäüËÉΩ
                    if (groupChatSettings) groupChatSettings.style.display = 'block';
                    if (pokeSettingsSection) pokeSettingsSection.style.display = 'none';
                    
                    // ÈöêËóèÂçïËÅä‰∏ìÁî®ËÆæÁΩÆÈ°π
                    const singleChatItems = document.querySelectorAll('.single-chat-only');
                    singleChatItems.forEach(item => item.style.display = 'none');
                    
                    // Êõ¥Êñ∞Áæ§ËÅä‰ø°ÊÅØÊòæÁ§∫
                    updateGroupChatInfo();
                } else {
                    // ÂçïËÅäÊ®°ÂºèÔºöÈöêËóèÁæ§ËÅäËÆæÁΩÆÔºåÊòæÁ§∫Êà≥‰∏ÄÊà≥ÂíåÂçïËÅä‰∏ìÁî®ÂäüËÉΩ
                    if (groupChatSettings) groupChatSettings.style.display = 'none';
                    if (pokeSettingsSection) pokeSettingsSection.style.display = 'block';
                    
                    // ÊòæÁ§∫ÂçïËÅä‰∏ìÁî®ËÆæÁΩÆÈ°π
                    const singleChatItems = document.querySelectorAll('.single-chat-only');
                    singleChatItems.forEach(item => item.style.display = 'flex');

                    // Êõ¥Êñ∞ËÆ∞ÂøÜÂÖ±‰∫´Áä∂ÊÄÅÊòæÁ§∫
                    updateMemoryShareStatus();
                }

                console.log('ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢Â∑≤ÊòæÁ§∫');
            } else {
                console.error('Êâæ‰∏çÂà∞api-chat-settings-screenÂÖÉÁ¥†');
                alert('ËÆæÁΩÆÁïåÈù¢Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        // ÈöêËóèËÅäÂ§©ËÆæÁΩÆ
        function hideChatSettings() {
            hideApp('api-chat-settings-screen');
            // ËøîÂõûÂà∞ËÅäÂ§©ÁïåÈù¢
            if (currentChatCharacter) {
                showApp('api-chat-screen');
            }
        }
        
        // ‰øÆÊîπËßíËâ≤Â§¥ÂÉè
        function changeCharacterAvatar() {
            // ‰∏¥Êó∂ÂàõÂª∫‰∏Ä‰∏™Êñá‰ª∂ËæìÂÖ•Ê°ÜÔºåÈÅøÂÖçÂπ≤Êâ∞ÂéüÊúâÁöÑÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
            const tempInput = document.createElement('input');
            tempInput.type = 'file';
            tempInput.accept = 'image/*';
            tempInput.style.display = 'none';
            document.body.appendChild(tempInput);
            
            tempInput.onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                        if (characterIndex !== -1) {
                            characters[characterIndex].avatarUrl = event.target.result;
                            await saveCharacters();
                            renderCharacterList();
                            renderContactList();
                            renderMessageList();
                            renderChatMessages(currentChatCharacter.id);
                        }
                        // Ê∏ÖÁêÜ‰∏¥Êó∂ÂÖÉÁ¥†
                        document.body.removeChild(tempInput);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                } else {
                    // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÈÄâÊã©Ôºå‰πüË¶ÅÊ∏ÖÁêÜ‰∏¥Êó∂ÂÖÉÁ¥†
                    document.body.removeChild(tempInput);
                }
            };
            
            tempInput.click();
        }
        
        // ‰øÆÊîπÂ§áÊ≥®
        async function changeCharacterNickname() {
            const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂ§áÊ≥®ÂêçÁß∞:', currentChatCharacter.name);
            if (newName && newName.trim() !== '') {
                const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                if (characterIndex !== -1) {
                    characters[characterIndex].name = newName.trim();
                    await saveCharacters();
                    document.getElementById('api-chat-title').textContent = newName.trim();
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                }
            }
        }
        
        // Êü•ÊâæËÅäÂ§©ÂÜÖÂÆπ
        function searchChatContent() {
            const keyword = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊü•ÊâæÁöÑÂÖ≥ÈîÆËØç:');
            if (keyword && keyword.trim() !== '') {
                const messages = chatMessages[currentChatCharacter.id] || [];
                const foundMessages = messages.filter(msg => 
                    msg.content && msg.content.includes(keyword.trim())
                );
                
                if (foundMessages.length > 0) {
                    alert(`ÊâæÂà∞ ${foundMessages.length} Êù°ÂåÖÂê´"${keyword}"ÁöÑÊ∂àÊÅØ`);
                } else {
                    alert(`Ê≤°ÊúâÊâæÂà∞ÂåÖÂê´"${keyword}"ÁöÑÊ∂àÊÅØ`);
                }
            }
        }
        

        
        // üî•„Äê‰øÆÂ§ç„ÄëÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï - ÂÆåÊï¥HTMLÊ†ºÂºè
        function exportChatHistory() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©', 'warning');
                return;
            }
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            if (messages.length === 0) {
                showToast('Ê≤°ÊúâËÅäÂ§©ËÆ∞ÂΩïÂèØÂØºÂá∫', 'warning');
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const characterName = chatSettings.aiChatNickname || currentChatCharacter.name;
            const userName = chatSettings.myChatNickname || 'Êàë';
            const exportTime = new Date();
            const totalMessages = messages.length;
            
            // Ëé∑ÂèñÊó∂Èó¥ËåÉÂõ¥
            const firstMessageTime = new Date(messages[0].timestamp);
            const lastMessageTime = new Date(messages[messages.length - 1].timestamp);
            
            // ÊûÑÂª∫HTMLÂÜÖÂÆπ
            let htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏é ${characterName} ÁöÑËÅäÂ§©ËÆ∞ÂΩï</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Helvetica, Arial, sans-serif;
            background: #f0f0f0;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header {
            background: #007AFF;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .header .info {
            font-size: 14px;
            opacity: 0.9;
        }
        .chat-content {
            padding: 20px;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .message.user {
            flex-direction: row-reverse;
        }
        .message.ai {
            flex-direction: row;
        }
        .message.system {
            justify-content: center;
            margin: 10px 0;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }
        .message.user .message-bubble {
            background: #007AFF;
            color: white;
            border-bottom-right-radius: 6px;
        }
        .message.ai .message-bubble {
            background: #e5e5ea;
            color: #333;
            border-bottom-left-radius: 6px;
        }
        .message.system .message-bubble {
            background: #f0f0f0;
            color: #666;
            font-size: 12px;
            text-align: center;
            border-radius: 12px;
            padding: 6px 12px;
            margin: 0 auto;
            max-width: 60%;
        }
        .sender-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            padding: 0 16px;
        }
        .message.user .sender-name {
            text-align: right;
        }
        .timestamp {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 16px;
        }
        .message.user .timestamp {
            text-align: right;
        }
        .quote-block {
            background: rgba(0,0,0,0.05);
            border-left: 3px solid #007AFF;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
        }
        .message.user .quote-block {
            border-left-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.2);
        }
        .quote-sender {
            font-weight: 600;
            color: #007AFF;
            font-size: 12px;
            margin-bottom: 2px;
        }
        .message.user .quote-sender {
            color: rgba(255,255,255,0.9);
        }
        .special-message {
            font-style: italic;
            color: #666;
        }
        .footer {
            background: #f8f8f8;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
        }
        .stats {
            background: #f8f8f8;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 14px;
            color: #666;
        }
        @media (max-width: 600px) {
            .container {
                margin: 0;
                box-shadow: none;
            }
            .message-bubble {
                max-width: 85%;
            }
            .header h1 {
                font-size: 20px;
            }
            .chat-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‰∏é ${characterName} ÁöÑËÅäÂ§©ËÆ∞ÂΩï</h1>
            <div class="info">
                ÂØºÂá∫Êó∂Èó¥Ôºö${exportTime.toLocaleString('zh-CN')}<br>
                ÂÖ± ${totalMessages} Êù°Ê∂àÊÅØ | ${firstMessageTime.toLocaleDateString('zh-CN')} - ${lastMessageTime.toLocaleDateString('zh-CN')}
            </div>
        </div>
        <div class="chat-content">`;
            
            // Â§ÑÁêÜÊØèÊù°Ê∂àÊÅØ
            messages.forEach((message, index) => {
                const time = formatTime(message.timestamp);
                const isUser = message.sender === 'sent';
                const isSystem = message.sender === 'system';
                
                if (isSystem) {
                    // Á≥ªÁªüÊ∂àÊÅØ
                    htmlContent += `
            <div class="message system">
                <div class="message-bubble">${escapeHtml(message.content)}</div>
            </div>`;
                } else {
                    // Áî®Êà∑ÊàñAIÊ∂àÊÅØ
                    const messageClass = isUser ? 'user' : 'ai';
                    const senderName = isUser ? userName : characterName;
                    let messageContent = '';
                    
                    // Â§ÑÁêÜÂºïÁî®Ê∂àÊÅØ
                    if (message.replyTo) {
                        const quoteSender = message.replyTo.senderName || (message.replyTo.sender === 'sent' ? userName : characterName);
                        const quoteContent = truncateText(message.replyTo.content || '[Ê∂àÊÅØÂ∑≤Âà†Èô§]', 50);
                        messageContent += `
                <div class="quote-block">
                    <div class="quote-sender">${escapeHtml(quoteSender)}</div>
                    <div>${escapeHtml(quoteContent)}</div>
                </div>`;
                    }
                    
                    // Â§ÑÁêÜÊ∂àÊÅØÂÜÖÂÆπ
                    let content = message.content || '';
                    let specialClass = '';
                    
                    if (message.type === 'voice_message') {
                        content = `üéµ ËØ≠Èü≥Ê∂àÊÅØÔºö${content}`;
                        specialClass = ' special-message';
                    } else if (message.type === 'transfer') {
                        content = `üí∞ ËΩ¨Ë¥¶Ôºö${message.amount}ÂÖÉ${message.note ? ` (${message.note})` : ''}`;
                        specialClass = ' special-message';
                    } else if (message.type === 'location') {
                        content = `üìç ‰ΩçÁΩÆÔºö${message.locationName || '‰ΩçÁΩÆ‰ø°ÊÅØ'}`;
                        specialClass = ' special-message';
                    } else if (message.type === 'user_photo') {
                        content = `üì∑ ÂõæÁâáÔºö${content}`;
                        specialClass = ' special-message';
                    } else if (message.isEmoji) {
                        content = `üòä Ë°®ÊÉÖÂåÖÔºö${message.emojiDescription || content}`;
                        specialClass = ' special-message';
                    } else if (Array.isArray(content)) {
                        // Â§ÑÁêÜÂõæÁâá+ÊñáÂ≠óÊ∂àÊÅØ
                        const textPart = content.find(part => part.type === 'text')?.text || '';
                        content = textPart ? `üì∑üìù ÂõæÁâá+ÊñáÂ≠óÔºö${textPart}` : 'üì∑ ÂõæÁâáÊ∂àÊÅØ';
                        specialClass = ' special-message';
                    }
                    
                    messageContent += `<div class="${specialClass.trim()}">${escapeHtml(content)}</div>`;
                    
                    htmlContent += `
            <div class="message ${messageClass}">
                <div class="message-bubble">
                    ${messageContent}
                </div>
            </div>
            <div class="timestamp">${time}</div>`;
                }
                
                // ÊØè50Êù°Ê∂àÊÅØÊ∑ªÂä†‰∏Ä‰∏™ÂàÜÈ°µÊ†áËÆ∞Ôºà‰æø‰∫éÈïøËÅäÂ§©ËÆ∞ÂΩïÁöÑÊü•ÁúãÔºâ
                if ((index + 1) % 50 === 0 && index !== messages.length - 1) {
                    htmlContent += `
            <div class="message system">
                <div class="message-bubble">--- Á¨¨ ${Math.floor((index + 1) / 50)} È°µ ---</div>
            </div>`;
                }
            });
            
            htmlContent += `
        </div>
        <div class="stats">
            üìä ËÅäÂ§©ÁªüËÆ°<br>
            ÊÄªÊ∂àÊÅØÊï∞Ôºö${totalMessages} Êù° | 
            ÊàëÁöÑÊ∂àÊÅØÔºö${messages.filter(m => m.sender === 'sent').length} Êù° | 
            ${characterName} ÁöÑÊ∂àÊÅØÔºö${messages.filter(m => m.sender === 'received').length} Êù° | 
            Á≥ªÁªüÊ∂àÊÅØÔºö${messages.filter(m => m.sender === 'system').length} Êù°
        </div>
        <div class="footer">
            Ê≠§ËÅäÂ§©ËÆ∞ÂΩïÁî±ÊâãÊú∫ËÅäÂ§©Â∫îÁî®Ëá™Âä®ÁîüÊàê<br>
            ÂØºÂá∫Êó∂Èó¥Ôºö${exportTime.toLocaleString('zh-CN')}
        </div>
    </div>
</body>
</html>`;
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const fileName = `‰∏é${characterName}ÁöÑËÅäÂ§©ËÆ∞ÂΩï_${exportTime.getFullYear()}-${(exportTime.getMonth() + 1).toString().padStart(2, '0')}-${exportTime.getDate().toString().padStart(2, '0')}.html`;
            
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Ê∏ÖÁêÜURLÂØπË±°
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 1000);
            
            showToast(`ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÂØºÂá∫Ôºö${fileName}`, 'success');
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëHTMLËΩ¨‰πâÂáΩÊï∞
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÊñáÊú¨Êà™Êñ≠ÂáΩÊï∞
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        

        
        // ËÆæÁΩÆÂØπÊñπÊ∞îÊ≥°È¢úËâ≤
        function changeTheirBubbleColor() {
            colorPickerContext = 'theirBubble';
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆÂØπÊñπÊ∞îÊ≥°È¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ËÆæÁΩÆÊàëÊñπÊ∞îÊ≥°È¢úËâ≤
        function changeMyBubbleColor() {
            colorPickerContext = 'myBubble';
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆÊàëÊñπÊ∞îÊ≥°È¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ÊòæÁ§∫Ê∞îÊ≥°È¢úËâ≤ËÆæÁΩÆ
        function showBubbleColorSettings() {
            alert('Ê∞îÊ≥°È¢úËâ≤ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂΩìÂâçÂèØ‰ª•ÈÄöËøá‰ª•‰∏ãÊñπÂºèËÆæÁΩÆÔºö\n‚Ä¢ ‰øÆÊîπÂØπÊñπÊ∞îÊ≥°È¢úËâ≤\n‚Ä¢ ‰øÆÊîπÊàëÊñπÊ∞îÊ≥°È¢úËâ≤');
        }
        
        // Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
        async function clearChatHistory() {
            if (!currentChatCharacter) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫‰∏é ${currentChatCharacter.name} ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂíåËÅäÂ§©ËÆæÁΩÆÂêóÔºü\n\nÊ≠§Êìç‰ΩúÂ∞ÜÈáçÁΩÆÊâÄÊúâ‰∏ìÂ±ûËÆæÁΩÆÔºàËÉåÊôØ„ÄÅÊ∞îÊ≥°Ê†∑ÂºèÁ≠âÔºâÔºå‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                // Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
                chatMessages[currentChatCharacter.id] = [];
                await saveChatMessages();
                
                // [Ê†∏ÂøÉ‰øÆÂ§ç] Âà†Èô§Âπ∂ÈáçÁΩÆËÅäÂ§©ËÆæÁΩÆ
                try {
                    // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§ËÆæÁΩÆ
                    await db.chatSettings.delete(currentChatCharacter.id);
                    // ‰ªéÂÜÖÂ≠ò‰∏≠Âà†Èô§ËÆæÁΩÆ
                    if (chatSettings[currentChatCharacter.id]) {
                        delete chatSettings[currentChatCharacter.id];
                    }
                    // Âà†Èô§localStorage‰∏≠ÁöÑÂ§á‰ªΩËÆæÁΩÆ
                    localStorage.removeItem(`chatSettings_${currentChatCharacter.id}`);
                    
                    // ÈáçÁΩÆËßíËâ≤ÂØπË±°‰∏≠ÁöÑËÉåÊôØËÆæÁΩÆ
                    if (currentChatCharacter) {
                        currentChatCharacter.background = null;
                        await saveCharacters();
                    }
                    
                    console.log(`‚úÖ Â∑≤Âà†Èô§‰∏é ${currentChatCharacter.name} ÁöÑËÅäÂ§©ËÆæÁΩÆ`);
                    
                    // ÈáçÊñ∞Â∫îÁî®ÈªòËÆ§ËÉåÊôØ
                    await applyChatBackground(null);
                } catch (error) {
                    console.error(`Âà†Èô§ËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:`, error);
                }
                
                renderChatMessages(currentChatCharacter.id);
                renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                showToast('ËÅäÂ§©ËÆ∞ÂΩïÂíåËÆæÁΩÆÂ∑≤Ê∏ÖÁ©∫', 'success');
                hideChatSettings();
            }
        }
        
        // ÈÄâÊã©È¢úËâ≤
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }
        
        // Â∫îÁî®ËÅäÂ§©ËÉåÊôØ
// Êé•Âèó‰∏Ä‰∏™ÂèØÈÄâÁöÑ backgroundUrl ÂèÇÊï∞
async function applyChatBackground(backgroundUrl) {
            if (!currentChatCharacter) return;
            
    console.log(`‚ö° applyChatBackground Ë¢´Ë∞ÉÁî®: ${currentChatCharacter.name} (ID: ${currentChatCharacter.id})`);

    // 1. ÂàõÂª∫‰∏Ä‰∏™‰∏ìÂ±û‰∫éÂΩìÂâçËÅäÂ§©ÁöÑËÉåÊôØËÆæÁΩÆÂ≠óÊÆµ
    // Ê≥®ÊÑèÔºöËøôÈáå‰∏çÂÜç‰ΩøÁî®chatSettingsÂØπË±°ÔºåËÄåÊòØÁõ¥Êé•Âú®characterÂØπË±°‰∏äÊ∑ªÂä†ËÉåÊôØÂ±ûÊÄß
    if (!currentChatCharacter.background) {
        currentChatCharacter.background = null;
    }

    // 2. ÂÜ≥ÂÆöÊúÄÁªàË¶Å‰ΩøÁî®ÁöÑËÉåÊôØ„ÄÇ‰ºòÂÖà‰ΩøÁî®‰º†ÂÖ•ÁöÑÂèÇÊï∞ÔºåÂê¶Âàô‰ΩøÁî®ËßíËâ≤ÂØπË±°‰∏≠ÁöÑÂÄº
    const backgroundToApply = backgroundUrl !== undefined ? backgroundUrl : currentChatCharacter.background;

    // 3. Êõ¥Êñ∞ËßíËâ≤ÂØπË±°‰∏≠ÁöÑËÆæÁΩÆ
    currentChatCharacter.background = backgroundToApply;
    
    // 4. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì - Ê≥®ÊÑèËøôÈáå‰ΩøÁî®saveCharactersËÄå‰∏çÊòØsaveCurrentChatSettings
    await saveCharacters();
    
    // 5. Áõ¥Êé•ËÆæÁΩÆËÉåÊôØÊ†∑Âºè
            const chatScreen = document.getElementById('api-chat-screen');
    if (!chatScreen) return;
    
    // Áõ¥Êé•Â∫îÁî®ËÉåÊôØ - ÂÆåÂÖ®Ê®°‰ªøzhangyu.html‰∏≠ÁöÑÂÆûÁé∞ÊñπÂºè
    if (backgroundToApply) {
        console.log(`üñºÔ∏è Â∫îÁî®ËÅäÂ§©ËÉåÊôØ: ${currentChatCharacter.name} (ID: ${currentChatCharacter.id})`);
        
        // Áõ¥Êé•ËÆæÁΩÆÊ†∑Âºè
        chatScreen.style.backgroundImage = `url(${backgroundToApply})`;
                    chatScreen.style.backgroundSize = 'cover';
                    chatScreen.style.backgroundPosition = 'center';
                    chatScreen.style.backgroundColor = 'transparent';
                    
        const messagesContainer = document.getElementById('api-chat-messages');
                    if (messagesContainer) messagesContainer.style.background = 'transparent';
                } else {
        console.log(`üñºÔ∏è ÈáçÁΩÆËÅäÂ§©ËÉåÊôØ: ${currentChatCharacter.name} (ID: ${currentChatCharacter.id})`);
        
        // ÈáçÁΩÆ‰∏∫ÈªòËÆ§Ê†∑Âºè
                    chatScreen.style.backgroundImage = 'none';
                    chatScreen.style.backgroundColor = 'white';
                    
        const messagesContainer = document.getElementById('api-chat-messages');
                    if (messagesContainer) messagesContainer.style.background = ''; 
                }
    
    console.log(`‚úÖ ËÉåÊôØÊ†∑ÂºèÂ∑≤Â∫îÁî®: ${currentChatCharacter.name} (ID: ${currentChatCharacter.id})`);
        }
        
        // ‰øùÂ≠òÊ∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ
        function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÊ†∑ÂºèËÆæÁΩÆ
            chatSettings.bubbleStyle = window.selectedBubbleStyle || 'default';
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;
            chatSettings.bubbleOpacity = document.getElementById('bubble-opacity').value;
            
            // Êõ¥Êñ∞ÊòæÁ§∫ÊñáÊú¨
            const styleNames = {
                'default': 'ÈªòËÆ§Ê†∑Âºè',
                'glass': 'ÊØõÁéªÁíÉ',
                'shadow': 'ÁªèÂÖ∏Èò¥ÂΩ±',
                'tail': 'ÁªèÂÖ∏Ê∞îÊ≥°',
                'gradient': 'Ê∏êÂèòÊ†∑Âºè',
                'minimal': 'ÊûÅÁÆÄÊ†∑Âºè',
                'neon': 'ÈúìËôπÊ†∑Âºè',
                'paper': 'Á∫∏Âº†Ê†∑Âºè'
            };
            
            document.getElementById('current-bubble-style').textContent = styleNames[chatSettings.bubbleStyle] || 'ÈªòËÆ§Ê†∑Âºè';
            
            saveCurrentChatSettings(chatSettings);
            applyBubbleStyle();
            hideModal('bubble-style-modal');
            
            showToast('Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // Â∫îÁî®Ê∞îÊ≥°Ê†∑Âºè
        function applyBubbleStyle() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const messagesContainer = document.getElementById('api-chat-messages');
            
            if (messagesContainer) {
                // ÁßªÈô§ÊâÄÊúâÊ†∑ÂºèÁ±ª
                messagesContainer.className = messagesContainer.className
                    .split(' ')
                    .filter(cls => !cls.startsWith('bubble-style-'))
                    .join(' ');
                
                // Ê∑ªÂä†ÂΩìÂâçÊ†∑ÂºèÁ±ª
                const style = chatSettings.bubbleStyle || 'default';
                messagesContainer.classList.add(`bubble-style-${style}`);
                
                // ËÆæÁΩÆCSSÂèòÈáèÁî®‰∫éÂä®ÊÄÅÈ¢úËâ≤
                const myColor = chatSettings.myBubbleColor || '#007AFF';
                const aiColor = chatSettings.aiBubbleColor || '#f0f0f0';
                const opacity = chatSettings.bubbleOpacity || '1';
                
                messagesContainer.style.setProperty('--my-bubble-color', myColor);
                messagesContainer.style.setProperty('--ai-bubble-color', aiColor);
                messagesContainer.style.setProperty('--bubble-opacity', opacity);
            }
        }
        
        // ÊòæÁ§∫Ê∞îÊ≥°È¢úËâ≤ÈÄâÊã©Âô®
        function showBubbleColorPicker(context) {
            colorPickerContext = context;
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆÊ∞îÊ≥°È¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ÈÄâÊã©È¢úËâ≤
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }
        
        // Â∫îÁî®È¢úËâ≤ÈÄâÊã©
        async function applyColorSelection() {
            const selectedColor = document.querySelector('.color-option.selected')?.style.backgroundColor || '#007AFF';
            const opacity = document.getElementById('opacity-slider').value;
            
            if (colorPickerContext === 'theirBubble') {
                chatSettings.theirBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            } else if (colorPickerContext === 'myBubble') {
                chatSettings.myBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            }
            
            await saveChatSettings();
            renderChatMessages(currentChatCharacter.id);
            hideModal('color-picker-modal');
        }
        
        // ÊòæÁ§∫Â£ÅÁ∫∏ÈÄâÊã©Âô®
        function showWallpaperPicker() {
            showModal('wallpaper-picker-modal');
        }
        
        // ÈÄâÊã©Â£ÅÁ∫∏Ôºà‰øùÁïôÂáΩÊï∞‰ª•Èò≤ÂÖ∂‰ªñÂú∞ÊñπË∞ÉÁî®Ôºå‰ΩÜÁé∞Âú®‰∏ªË¶ÅÈÄöËøáÊñá‰ª∂‰∏ä‰º†ÈÄâÊã©Ôºâ
        function selectWallpaper(wallpaperId) {
            console.log('ÈÄâÊã©Â£ÅÁ∫∏:', wallpaperId);
            selectedWallpaper = wallpaperId;
            console.log('selectedWallpaperÂ∑≤ËÆæÁΩÆ‰∏∫:', selectedWallpaper);
        }
        
        // Â∫îÁî®Â£ÅÁ∫∏ÈÄâÊã©
        async function applyWallpaperSelection() {
            console.log('Â∫îÁî®Â£ÅÁ∫∏Ë¢´Ë∞ÉÁî®ÔºåselectedWallpaper:', selectedWallpaper);
            
            if (!selectedWallpaper) {
                alert('ËØ∑ÂÖà‰ªéÁõ∏ÂÜåÈÄâÊã©‰∏ÄÂº†ÂõæÁâá‰Ωú‰∏∫Â£ÅÁ∫∏');
                return;
            }
            
            if (selectedWallpaper.startsWith('data:image')) {
                // Â∫îÁî®‰∏ä‰º†ÁöÑÂõæÁâáÂ£ÅÁ∫∏
                console.log('Â∫îÁî®ÂõæÁâáÂ£ÅÁ∫∏');
                document.querySelector('.wallpaper').style.backgroundImage = `url(${selectedWallpaper})`;
                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                
                // ‰ΩøÁî®IndexedDB‰øùÂ≠òÂ£ÅÁ∫∏ÔºåÈÅøÂÖçlocalStorageÁ©∫Èó¥ÈôêÂà∂
                try {
                    await db.wallpapers.clear();
                    await db.wallpapers.add({
                        id: 'main',
                        type: 'image',
                        data: selectedWallpaper
                    });
                    console.log('Â£ÅÁ∫∏‰øùÂ≠òÊàêÂäüÂà∞IndexedDB');
            hideModal('wallpaper-picker-modal');
                } catch (e) {
                    console.error('‰øùÂ≠òÂ£ÅÁ∫∏Â§±Ë¥•:', e);
                    alert('‰øùÂ≠òÂ£ÅÁ∫∏Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            } else {
                alert('ËØ∑ÂÖà‰ªéÁõ∏ÂÜåÈÄâÊã©‰∏ÄÂº†ÂõæÁâá‰Ωú‰∏∫Â£ÅÁ∫∏');
            }
        }
        
        // ‰∏ä‰º†Ëá™ÂÆö‰πâÂ£ÅÁ∫∏
        function uploadCustomWallpaper() {
            document.getElementById('custom-wallpaper-upload').click();
        }
        
        // ÊòæÁ§∫ÂõæÊ†áÈÄâÊã©Âô®
        function showIconPicker() {
            showModal('icon-picker-modal');
        }
        
        // ÈÄâÊã©Â∫îÁî®ÂõæÊ†á
        function selectAppIcon(appId, iconClass) {
            selectedAppIcon = { appId, iconClass };
        }
        
        // ‰∏ä‰º†Ëá™ÂÆö‰πâÂõæÊ†á
        function uploadCustomIcon() {
            document.getElementById('custom-icon-upload').click();
        }
        
        // Â∫îÁî®ÂõæÊ†áÈÄâÊã©
        function applyIconSelection() {
            if (selectedAppIcon && customIconImage) {
                // Êõ¥Êñ∞Â∫îÁî®ÂõæÊ†á
                const appIcon = document.querySelector(`.app[onclick="showApp('${selectedAppIcon.appId}')"] .app-icon`);
                if (appIcon) {
                    appIcon.innerHTML = '';
                    appIcon.style.backgroundImage = `url(${customIconImage})`;
                    
                    // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                    let savedIcons = {};
                    try {
                        savedIcons = JSON.parse(localStorage.getItem('appIcons') || '{}');
                    } catch (error) {
                        console.error('Ëß£ÊûêÊú¨Âú∞Â≠òÂÇ®ÁöÑ appIcons Â§±Ë¥•:', error);
                        savedIcons = {};
                    }
                    savedIcons[selectedAppIcon.appId] = customIconImage;
                    localStorage.setItem('appIcons', JSON.stringify(savedIcons));
                }
            } else if (selectedAppIcon) {
                saveAppIcons();
            }
            hideModal('icon-picker-modal');
        }
        
        // Êõ¥ÊîπËÅäÂ§©‰∏ªÈ¢òÈ¢úËâ≤
        function changeChatThemeColor() {
            colorPickerContext = 'theme';
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆËÅäÂ§©‰∏ªÈ¢òÈ¢úËâ≤';
            showModal('color-picker-modal');
        }
        

        
        // ÊòæÁ§∫Ê∂àÊÅØËèúÂçï
        function showMessageMenu(messageId, event) {
            selectedMessageId = messageId;
            
            // ÂàõÂª∫ÊàñËé∑ÂèñËèúÂçïÂÖÉÁ¥†
            let menu = document.getElementById('message-context-menu');
            if (!menu) {
                menu = document.createElement('div');
                menu.id = 'message-context-menu';
                menu.className = 'message-menu';
                menu.innerHTML = `
                    <div class="message-menu-item" onclick="replyToMessage()">ÂºïÁî®</div>
                    <div class="message-menu-item" onclick="copyMessage()">Â§çÂà∂</div>
                    <div class="message-menu-item danger" onclick="deleteMessage()">Âà†Èô§</div>
                `;
                document.body.appendChild(menu);
            }
            
            // ÂÆö‰ΩçËèúÂçï
            const x = event.clientX || event.pageX;
            const y = event.clientY || event.pageY;
            
            menu.style.display = 'block';
            menu.style.left = `${Math.min(x, window.innerWidth - 150)}px`;
            menu.style.top = `${Math.min(y, window.innerHeight - 100)}px`;
            
            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
            setTimeout(() => {
                document.addEventListener('click', hideMessageMenu);
                document.addEventListener('touchstart', hideMessageMenu);
            }, 100);
        }
        
        // ÈöêËóèÊ∂àÊÅØËèúÂçï
        function hideMessageMenu() {
            const menu = document.getElementById('message-context-menu');
            if (menu) {
                menu.style.display = 'none';
            }
            document.removeEventListener('click', hideMessageMenu);
            document.removeEventListener('touchstart', hideMessageMenu);
        }
        
        // ÂºïÁî®Ê∂àÊÅØÂäüËÉΩ
        let currentReplyTo = null;
        
        // üî•„Äê‰øÆÂ§ç„ÄëÂºïÁî®Ê∂àÊÅØ - ÊîØÊåÅ‰º†ÂÖ•Ê∂àÊÅØID
        function replyToMessage(messageId = null) {
            const targetMessageId = messageId || selectedMessageId;
            if (!targetMessageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === targetMessageId);
            
            if (message) {
                // ËÆæÁΩÆÂºïÁî®‰ø°ÊÅØ
                currentReplyTo = {
                    id: message.id,
                    content: message.content || '[ÂõæÁâá]',
                    sender: message.sender,
                    timestamp: message.timestamp,
                    senderName: getSenderDisplayName(message)
                };
                
                // ÊòæÁ§∫ÂºïÁî®È¢ÑËßà
                showReplyPreview();
                
                // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
                const inputBox = document.getElementById('api-chat-input');
                if (inputBox) {
                    inputBox.focus();
                }
            }
            
            hideMessageMenu();
        }
        
        // Ëé∑ÂèñÂèëÈÄÅËÄÖÊòæÁ§∫ÂêçÁß∞
        function getSenderDisplayName(message) {
            if (message.sender === 'sent') {
                const chatSettings = getCurrentChatSettings();
                if (chatSettings.selectedIdentityId) {
                    const persona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                    if (persona) return persona.name;
                }
                return chatSettings.myChatNickname || 'Êàë';
            } else if (message.sender === 'received') {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÁæ§ËÅä
                const group = groupChats.find(g => g.id === currentChatCharacter.id);
                if (group) {
                    // Áæ§ËÅä‰∏≠ÔºåÊ†πÊçÆÊ∂àÊÅØÁöÑsenderIdÊàñnameÊü•ÊâæÊàêÂëò
                    let member = null;
                    if (message.senderId) {
                        member = group.members.find(m => m.id === message.senderId);
                    } else if (message.name) {
                        member = group.members.find(m => m.name === message.name);
                    }
                    return member?.name || 'Áæ§ÊàêÂëò';
                } else {
                    // ÂçïËÅä
                    const chatSettings = getCurrentChatSettings();
                    return chatSettings.aiChatNickname || currentChatCharacter.name;
                }
            }
            return 'Êú™Áü•';
        }
        
        // ÊòæÁ§∫ÂºïÁî®È¢ÑËßà
        function showReplyPreview() {
            if (!currentReplyTo) return;
            
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÂºïÁî®È¢ÑËßà
            const existingPreview = document.getElementById('reply-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // ÂàõÂª∫ÂºïÁî®È¢ÑËßàÂÖÉÁ¥†
            const replyPreview = document.createElement('div');
            replyPreview.id = 'reply-preview';
            replyPreview.className = 'reply-preview';
            
            // Êà™Êñ≠ÊòæÁ§∫ÂÜÖÂÆπ
            const displayContent = truncateText(currentReplyTo.content, 50);
            
            replyPreview.innerHTML = `
                <div class="reply-preview-content">
                    <div class="reply-preview-line"></div>
                    <div class="reply-preview-text">
                        <div class="reply-preview-sender">${currentReplyTo.senderName}</div>
                        <div class="reply-preview-message">${displayContent}</div>
                    </div>
                    <button class="reply-preview-close" onclick="cancelReply()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // ÊèíÂÖ•Âà∞ËæìÂÖ•Âå∫Âüü‰∏äÊñπ
            const inputArea = document.querySelector('.chat-input-area');
            if (inputArea) {
                inputArea.parentNode.insertBefore(replyPreview, inputArea);
            }
        }
        
        // ÂèñÊ∂àÂºïÁî®
        function cancelReply() {
            currentReplyTo = null;
            const replyPreview = document.getElementById('reply-preview');
            if (replyPreview) {
                replyPreview.remove();
            }
        }
        
        // ÁîüÊàêÂºïÁî®Ê∂àÊÅØÁöÑHTML
        function generateReplyHTML(replyTo) {
            if (!replyTo) return '';

            let displayContent = truncateText(replyTo.content, 40);
            // Â§ÑÁêÜÂºïÁî®Ê∂àÊÅØ‰∏≠ÁöÑ@ÂÜÖÂÆπ
            displayContent = processMentions(displayContent);

            return `
                <div class="reply-reference">
                    <div class="reply-reference-line"></div>
                    <div class="reply-reference-content">
                        <div class="reply-reference-sender">${replyTo.senderName}</div>
                        <div class="reply-reference-message">${displayContent}</div>
                    </div>
                </div>
            `;
        }
        
        // Â§çÂà∂Ê∂àÊÅØ
        function copyMessage() {
            if (!selectedMessageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === selectedMessageId);
            
            if (message && message.content) {
                navigator.clipboard.writeText(message.content).then(() => {
                    alert('Ê∂àÊÅØÂ∑≤Â§çÂà∂');
                }).catch(() => {
                    alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                });
            }
            
            hideMessageMenu();
        }
        
        // ÊòæÁ§∫ÁºñËæëÊ∂àÊÅØÊ®°ÊÄÅÊ°Ü
        function showEditMessageModal(messageId) {
            if (!messageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === messageId);
            
            if (!message) {
                showToast('Ê∂àÊÅØ‰∏çÂ≠òÂú®', 'error');
                return;
            }
            
            // ÂàõÂª∫ÁºñËæëÊ®°ÊÄÅÊ°Ü
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'edit-message-modal';
            
            const senderName = message.sender === 'sent' ? '‰Ω†' : (message.name || currentChatCharacter.name);
            
            modal.innerHTML = `
                <div class="modal-content edit-message-modal">
                    <div class="modal-header">
                        <h3>ÁºñËæëÊ∂àÊÅØ</h3>
                        <button class="modal-close" onclick="hideEditMessageModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="edit-message-info">
                            <span class="message-sender">${senderName}</span>
                            <span class="message-time">${formatTimestamp(message.timestamp)}</span>
                        </div>
                        <div class="edit-form-group">
                            <label>Ê∂àÊÅØÂÜÖÂÆπÔºö</label>
                            <textarea 
                                id="edit-message-content" 
                                class="edit-message-textarea"
                                placeholder="ËØ∑ËæìÂÖ•Ê∂àÊÅØÂÜÖÂÆπ..."
                                maxlength="2000"
                            >${message.content || ''}</textarea>
                            <div class="edit-message-counter">
                                <span id="edit-char-count">${(message.content || '').length}</span>/2000
                            </div>
                        </div>
                        ${message.image ? `
                            <div class="edit-form-group">
                                <label>ÂõæÁâáÔºö</label>
                                <div class="edit-message-image">
                                    <img src="${message.image}" alt="Ê∂àÊÅØÂõæÁâá" />
                                    <button class="remove-image-btn" onclick="removeMessageImage()">Âà†Èô§ÂõæÁâá</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn modal-cancel" onclick="hideEditMessageModal()">ÂèñÊ∂à</button>
                        <button class="modal-btn modal-confirm" onclick="saveEditedMessage('${messageId}')">‰øùÂ≠ò</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Ê∑ªÂä†Â≠óÁ¨¶ËÆ°Êï∞ÂäüËÉΩ
            const textarea = document.getElementById('edit-message-content');
            const charCount = document.getElementById('edit-char-count');
            textarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
            
            // ËÅöÁÑ¶Âπ∂ÈÄâ‰∏≠ÊñáÊú¨
            setTimeout(() => {
                textarea.focus();
                textarea.select();
            }, 100);
        }
        
        // ÈöêËóèÁºñËæëÊ∂àÊÅØÊ®°ÊÄÅÊ°Ü
        function hideEditMessageModal() {
            const modal = document.getElementById('edit-message-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ‰øùÂ≠òÁºñËæëÂêéÁöÑÊ∂àÊÅØ
        function saveEditedMessage(messageId) {
            const newContent = document.getElementById('edit-message-content').value.trim();
            
            if (!newContent) {
                showToast('Ê∂àÊÅØÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'error');
                return;
            }
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const messageIndex = messages.findIndex(msg => msg.id === messageId);
            
            if (messageIndex !== -1) {
                const oldContent = messages[messageIndex].content;
                messages[messageIndex].content = newContent;
                
                // Ê∑ªÂä†ÁºñËæëÊ†áËÆ∞
                messages[messageIndex].edited = true;
                messages[messageIndex].editTime = Date.now();
                
                saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
                hideEditMessageModal();
                
                showToast('Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞', 'success');
                
                console.log(`Ê∂àÊÅØÂ∑≤ÁºñËæë: "${oldContent}" -> "${newContent}"`);
            } else {
                showToast('Ê∂àÊÅØ‰∏çÂ≠òÂú®', 'error');
            }
        }
        
        // ÁßªÈô§Ê∂àÊÅØÂõæÁâá
        function removeMessageImage() {
            // Ëøô‰∏™ÂäüËÉΩÂèØ‰ª•Âú®ÂêéÁª≠Êâ©Â±ï
            showToast('ÊöÇ‰∏çÊîØÊåÅÁßªÈô§ÂõæÁâá', 'info');
        }
        
        // ÁºñËæëÊ∂àÊÅØÔºà‰øùÁïôÊóßÁâàÊú¨Êé•Âè£Ôºâ
        function editMessage() {
            if (!selectedMessageId) return;
            
            showEditMessageModal(selectedMessageId);
            hideModal('message-menu-modal');
        }
        
        // È™åËØÅÂ§¥ÂÉèÊù•Ê∫êÊòØÂê¶ÊúâÊïà
        async function validateAvatarSource(avatarUrl) {
            console.log('È™åËØÅÂ§¥ÂÉèÊù•Ê∫ê:', avatarUrl);
            if (!avatarUrl) return false;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáÔºàÂú®ËÅäÂ§©ËÆ∞ÂΩï‰∏≠Ôºâ
            if (currentChatCharacter && chatMessages[currentChatCharacter.id]) {
                const userImages = chatMessages[currentChatCharacter.id]
                    .filter(msg => msg.sender === 'sent' && msg.image)
                    .map(msg => msg.image);
                
                console.log('Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáÂàóË°®:', userImages);
                console.log('Ê£ÄÊü•Â§¥ÂÉèURLÊòØÂê¶Âú®Áî®Êà∑ÂõæÁâá‰∏≠:', userImages.includes(avatarUrl));
                
                if (userImages.includes(avatarUrl)) {
                    console.log('Â§¥ÂÉèÊù•Ê∫êÈ™åËØÅÈÄöËøáÔºöÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâá');
                    return true;
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰∏ñÁïå‰π¶‰∏≠Êèê‰æõÁöÑÂ§¥ÂÉèURL
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.worldbookMountEnabled && chatSettings.selectedWorldbooks) {
                for (const worldbookId of chatSettings.selectedWorldbooks) {
                    const worldbook = worldbooks.find(w => w.id === worldbookId);
                    if (worldbook && worldbook.content && worldbook.content.includes(avatarUrl)) {
                        console.log('Â§¥ÂÉèÊù•Ê∫êÈ™åËØÅÈÄöËøáÔºö‰∏ñÁïå‰π¶‰∏≠ÁöÑURL');
                        return true;
                    }
                }
            }
            
            console.log('Â§¥ÂÉèÊù•Ê∫êÈ™åËØÅÂ§±Ë¥•');
            return false;
        }
        
        // ËßíËâ≤‰∏ªÂä®Êõ¥Êç¢Â§¥ÂÉèÂäüËÉΩ - Âè™‰øÆÊîπËÅäÂ§©ËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉèÔºå‰∏ç‰øÆÊîπËßíËâ≤Âç°
        async function changeCharacterAvatarByAI(newAvatarUrl, reason = '') {
            if (!currentChatCharacter || !newAvatarUrl) return false;
            
            try {
                // Ëé∑ÂèñÊàñÂàõÂª∫ÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆ
                const currentSettings = getCurrentChatSettings();
                
                // ÂéãÁº©Â§¥ÂÉèÂõæÁâá‰ª•ÂáèÂ∞ëÂ≠òÂÇ®Á©∫Èó¥
                let compressedAvatarUrl = newAvatarUrl;
                if (newAvatarUrl.startsWith('data:image')) {
                    try {
                        compressedAvatarUrl = await compressImage(newAvatarUrl, 200, 0.7);
                        console.log('Â§¥ÂÉèÂ∑≤ÂéãÁº©‰ª•ËäÇÁúÅÂ≠òÂÇ®Á©∫Èó¥');
                    } catch (error) {
                        console.warn('Â§¥ÂÉèÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂõæ:', error);
                    }
                }
                
                // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®Âä®ÊÄÅÂ§¥ÂÉèÂ≠óÊÆµÔºå‰ºòÂÖàÁ∫ßÈ´ò‰∫éÁî®Êà∑ËÆæÁΩÆÁöÑËÅäÂ§©Â§¥ÂÉè
                if (!chatSettings[currentChatCharacter.id]) {
                    chatSettings[currentChatCharacter.id] = {};
                }
                chatSettings[currentChatCharacter.id].aiDynamicAvatar = compressedAvatarUrl;
                
                console.log(`Âä®ÊÄÅÂ§¥ÂÉèÂ∑≤ËÆæÁΩÆÔºö`, {
                    characterId: currentChatCharacter.id,
                    characterName: currentChatCharacter.name,
                    avatarUrl: compressedAvatarUrl.substring(0, 50) + '...',
                    settingsSnapshot: {
                        aiDynamicAvatar: !!chatSettings[currentChatCharacter.id].aiDynamicAvatar,
                        aiChatAvatar: !!chatSettings[currentChatCharacter.id].aiChatAvatar
                    }
                });
                
                // ‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆ
                await saveChatSettings();
                
                // ÂèëÈÄÅÁ≥ªÁªüÊèêÁ§∫Ê∂àÊÅØ
                const systemMessage = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `${currentChatCharacter.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè${reason ? ': ' + reason : ''}`,
                    timestamp: Date.now(),
                    isAvatarChange: true
                };
                
                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }
                chatMessages[currentChatCharacter.id].push(systemMessage);
                await saveChatMessages();
                
                // üî•„Äê‰øÆÂ§ç„ÄëÂú®‰øùÂ≠òÊ∂àÊÅØÂêéÂÜçÂà∑Êñ∞ËÅäÂ§©ÁïåÈù¢ÔºåÁ°Æ‰øùÂåÖÂê´Êñ∞Â§¥ÂÉèÂíåÁ≥ªÁªüÊ∂àÊÅØ
                renderChatMessages(currentChatCharacter.id);
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÂº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÂ§¥ÂÉèÊòæÁ§∫
                forceRefreshAvatars();
                
                console.log(`ËßíËâ≤ ${currentChatCharacter.name} Âú®ÂΩìÂâçËÅäÂ§©‰∏≠Êõ¥Êç¢‰∫ÜÂ§¥ÂÉèÔºå‰ΩÜËßíËâ≤Âç°‰øùÊåÅ‰∏çÂèò`);
                
                return true;
            } catch (error) {
                console.error('ËßíËâ≤Êõ¥Êç¢Â§¥ÂÉèÂ§±Ë¥•:', error);
                return false;
            }
            
            return false;
        }
        
        // Âà†Èô§Ê∂àÊÅØ
        async function deleteMessage() {
            if (!selectedMessageId) return;
            
                const messages = chatMessages[currentChatCharacter.id] || [];
                const messageIndex = messages.findIndex(msg => msg.id === selectedMessageId);
                
            if (messageIndex === -1) {
                hideMessageMenu();
                return;
            }
            
            const messageToDelete = messages[messageIndex];
            
            if (confirm('Á°ÆÂÆöË¶ÅÊí§ÂõûËøôÊù°Ê∂àÊÅØÂêóÔºü')) {
                // ‰øùÂ≠òÂéüÂßãÊ∂àÊÅØÂÜÖÂÆπ
                const originalContent = messageToDelete.content || '[ÂõæÁâá]';

                // üî•„Äê‰øÆÂ§ç„ÄëÂà†Èô§Áõ∏ÂÖ≥ÁöÑÊó∂Èó¥Á∫øËÆ∞ÂΩï
                try {
                    await deleteRelatedTimelineEvents(messageToDelete);
                } catch (error) {
                    console.error('Âà†Èô§Êó∂Èó¥Á∫øËÆ∞ÂΩïÂ§±Ë¥•:', error);
                }

                // Âà†Èô§ÂéüÊ∂àÊÅØ
                    messages.splice(messageIndex, 1);

                // üî•„ÄêÊñ∞Â¢û„ÄëÂàõÂª∫Êí§ÂõûÊ∂àÊÅØÁ≥ªÁªüÊèêÈÜí
                const whoRecalled = messageToDelete.sender === 'received' ? currentChatCharacter.name : '‰Ω†';
                const recallSystemMessage = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `${whoRecalled} Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ\nÂéüÊñáÔºö${originalContent}`,
                    timestamp: messageToDelete.timestamp || Date.now(),
                    isRecall: true
                };

                // Âú®Âéü‰ΩçÁΩÆÊèíÂÖ•Êí§ÂõûÊèêÈÜí
                messages.splice(messageIndex, 0, recallSystemMessage);

                    saveChatMessages();
                    renderChatMessages(currentChatCharacter.id);
                    // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
                    renderMessageList();
            }
            
            hideMessageMenu();
        }
        

        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥Êà≥ÔºàÂÆåÊï¥Êó∂Èó¥Ôºâ
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;
            
            if (messageDate.getTime() === today.getTime()) {
                return timeStr; // ‰ªäÂ§©Âè™ÊòæÁ§∫Êó∂Èó¥
            } else if (messageDate.getTime() === yesterday.getTime()) {
                return `Êò®Â§© ${timeStr}`;
            } else {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}Êúà${day}Êó• ${timeStr}`;
            }
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥Ôºà‰ªÖÊó∂ÂàÜÔºâ
        function formatTimeOnly(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Ê†ºÂºèÂåñÂÆåÊï¥Êó•Êúü
        function formatFullDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}Âπ¥${month}Êúà${day}Êó• ${hours}:${minutes}`;
        }
        
        // Âä†ËΩΩURL
        function loadUrl() {
            const url = document.getElementById('browser-url').value;
            let fullUrl = url;
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                fullUrl = 'https://' + url;
            }
            
            document.getElementById('browser-frame').src = fullUrl;
        }
        
        // ÊóßÁâàÊú¨APIÁ±ªÂûãÂàáÊç¢Â§ÑÁêÜÂ∑≤Âà†Èô§ - ‰ΩøÁî®Êñ∞ÁâàÊú¨ÁöÑAPIËÆæÁΩÆÁ≥ªÁªü
        
        // ÊóßÁâàÊú¨ÊµãËØïAPIËøûÊé•ÂíåËé∑ÂèñÊ®°ÂûãÂàóË°®ÂáΩÊï∞Â∑≤Âà†Èô§ - Áé∞Âú®‰ΩøÁî®Êñ∞ÁâàÊú¨ÁöÑAPIËÆæÁΩÆÁ≥ªÁªü
        
        // ‰øùÂ≠òAPIËÆæÁΩÆ
        async function saveApiSettings() {
            const baseUrl = document.getElementById('api-base').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-select').value.trim();
            const temperature = parseFloat(document.getElementById('temperature-slider').value) || 0.75;

            if (!baseUrl || !apiKey || !model) {
                showToast('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑAPIÈÖçÁΩÆ‰ø°ÊÅØ', 'error');
                return;
            }

            apiSettings = {
                base: baseUrl,
                key: apiKey,
                model: model,
                temperature: temperature,
                endpoint: '/chat/completions'  // Ê∑ªÂä†ÈªòËÆ§endpoint
            };

            try {
                // üî•„Äê‰øÆÂ§ç„ÄëÂêåÊó∂‰øùÂ≠òÂà∞IndexedDBÂíålocalStorageÔºåÁ°Æ‰øùÊï∞ÊçÆ‰∏ÄËá¥ÊÄß
                await db.apiSettings.put({
                    id: 'main',
                    settings: apiSettings
                });
                localStorage.setItem('apiSettings', JSON.stringify(apiSettings));

                showToast('APIËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ', 'success');
                console.log('üîß [APIËÆæÁΩÆ] Â∑≤‰øùÂ≠òÂà∞IndexedDBÂíålocalStorage:', apiSettings);
            } catch (error) {
                console.error('‰øùÂ≠òAPIËÆæÁΩÆÂ§±Ë¥•:', error);
                showToast('‰øùÂ≠òAPIËÆæÁΩÆÂ§±Ë¥•: ' + error.message, 'error');
                return;
            }

            // Êõ¥Êñ∞Ê∏©Â∫¶ÊòæÁ§∫
            document.getElementById('temperature-value').textContent = temperature.toFixed(2);

            // ‰øÆÂ§çÔºö‰øùÂ≠òÂêé‰∏çË∑≥ËΩ¨ÔºåÁïôÂú®ÂΩìÂâçAPIËÆæÁΩÆÈ°µÈù¢
        }
        
        // üåü GeminiÁõ¥ËøûÂø´ÈÄüËÆæÁΩÆ
        function setGeminiDirect() {
            // Ëá™Âä®Â°´ÂÖÖGeminiÈÖçÁΩÆ
            document.getElementById('api-base').value = 'https://generativelanguage.googleapis.com/v1beta';
            document.getElementById('api-key').placeholder = 'ËØ∑ËæìÂÖ•Google AI StudioÁöÑAPI Key';
            
            // Ê∏ÖÁ©∫‰πãÂâçÁöÑÊ®°ÂûãÈÄâÊã©Âπ∂Ê∑ªÂä†GeminiÊ®°Âûã
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = `
                <option value="">ËØ∑ÈÄâÊã©Ê®°Âûã...</option>
                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (ÂÆûÈ™åÁâà) - Êé®Ëçê</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash - Âø´ÈÄü</option>
                <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B - ËΩªÈáè</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro - Á®≥ÂÆö</option>
                <option value="gemini-pro">Gemini Pro - ÁªèÂÖ∏</option>
                <option value="gemini-pro-vision">Gemini Pro Vision - ËßÜËßâ</option>
                <option value="ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞">ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞</option>
            `;
            
            // Ê∑ªÂä†ÊâãÂä®ËæìÂÖ•ÂäüËÉΩ
            modelSelect.onchange = function() {
                if (this.value === 'ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞') {
                    const customModel = prompt('ËØ∑ËæìÂÖ•GeminiÊ®°ÂûãÂêçÁß∞\n\nÂ∏∏ËßÅÈÄâÈ°πÔºö\n‚Ä¢ gemini-2.0-flash-exp\n‚Ä¢ gemini-1.5-flash\n‚Ä¢ gemini-1.5-pro\n‚Ä¢ gemini-pro');
                    if (customModel && customModel.trim()) {
                        const newOption = new Option(customModel.trim(), customModel.trim());
                        this.insertBefore(newOption, this.lastElementChild);
                        this.value = customModel.trim();
                    } else {
                        this.value = '';
                    }
                }
            };
            
            showToast('üåü GeminiÁõ¥ËøûÈÖçÁΩÆÂ∑≤Ëá™Âä®Â°´ÂÜôÔºÅ\n\n‰ΩøÁî®ËØ¥ÊòéÔºö\n1. ËØ∑Âú®Google AI StudioËé∑ÂèñAPI Key\n2. ÈÄâÊã©ÂêàÈÄÇÁöÑÊ®°Âûã\n3. ÁÇπÂáª"ÊµãËØïËøûÊé•"È™åËØÅÈÖçÁΩÆ', 'success');
        }
        
        // ü§ó HuggingFaceÂèç‰ª£Âø´ÈÄüËÆæÁΩÆ
        function setHuggingFaceProxy() {
            // Ëá™Âä®Â°´ÂÖÖHuggingFaceÂèç‰ª£ÈÖçÁΩÆ - ‰ΩøÁî®Ê≠£Á°ÆÁöÑÊ†ºÂºè
            document.getElementById('api-base').value = 'https://xxx-xxx.hf.space/v1';
            document.getElementById('api-key').placeholder = 'ËØ∑ËæìÂÖ•HuggingFaceÁöÑAPI Token';
            
            // Ê∏ÖÁ©∫‰πãÂâçÁöÑÊ®°ÂûãÈÄâÊã©Âπ∂Ê∑ªÂä†Â∏∏ËßÅHFÊ®°Âûã
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = `
                <option value="">ËØ∑ÈÄâÊã©Ê®°Âûã...</option>
                <optgroup label="LlamaÁ≥ªÂàó">
                    <option value="meta-llama/Llama-2-7b-chat-hf">Llama-2-7b-chat-hf</option>
                    <option value="meta-llama/Llama-2-13b-chat-hf">Llama-2-13b-chat-hf</option>
                    <option value="meta-llama/Meta-Llama-3-8B-Instruct">Meta-Llama-3-8B-Instruct</option>
                </optgroup>
                <optgroup label="ÂØπËØùÊ®°Âûã">
                <option value="microsoft/DialoGPT-large">DialoGPT-large</option>
                <option value="microsoft/DialoGPT-medium">DialoGPT-medium</option>
                    <option value="facebook/blenderbot-400M-distill">BlenderBot-400M</option>
                </optgroup>
                <optgroup label="ÈÄöÁî®Ê®°Âûã">
                    <option value="mistralai/Mistral-7B-Instruct-v0.1">Mistral-7B-Instruct</option>
                    <option value="teknium/OpenHermes-2.5-Mistral-7B">OpenHermes-2.5-Mistral-7B</option>
                </optgroup>
                <optgroup label="Ëá™ÂÆö‰πâ">
                    <option value="custom">ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞...</option>
                </optgroup>
            `;
            
            // Ê∑ªÂä†Ëá™ÂÆö‰πâÊ®°ÂûãËæìÂÖ•ÂäüËÉΩ
            modelSelect.onchange = function() {
                if (this.value === 'custom') {
                    const customModel = prompt('ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞Ôºà‰æãÂ¶ÇÔºömeta-llama/Llama-2-7b-chat-hfÔºâÔºö');
                    if (customModel && customModel.trim()) {
                        const newOption = new Option(customModel.trim(), customModel.trim());
                        this.insertBefore(newOption, this.lastElementChild);
                        this.value = customModel.trim();
                    } else {
                        this.value = '';
                    }
                }
            };
            
            showToast('ü§ó HuggingFaceÂèç‰ª£ÈÖçÁΩÆÂ∑≤Ëá™Âä®Â°´ÂÜôÔºÅ\n\nËØ∑Ôºö\n1. Â∞ÜÂú∞ÂùÄ‰∏≠ÁöÑ xxx-xxx ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑHF SpaceÂú∞ÂùÄ\n2. ÈÄâÊã©Ê®°ÂûãÊàñÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞', 'success');
        }
        
        // ‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ‰∏∫È¢ÑËÆæ
        function saveCurrentConfig() {
            const configName = document.getElementById('config-name-input').value.trim();
            
            if (!configName) {
                showToast('ËØ∑ËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞', 'error');
                return;
            }
            
            const currentConfig = {
                name: configName,
                base: document.getElementById('api-base').value.trim(),
                key: document.getElementById('api-key').value.trim(),
                model: document.getElementById('model-select').value.trim(),
                temperature: parseFloat(document.getElementById('temperature-slider').value) || 0.75,
                savedAt: new Date().toLocaleString()
            };
            
            // Ëé∑ÂèñÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ
            let savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÈÖçÁΩÆ
            const existingIndex = savedConfigs.findIndex(config => config.name === configName);
            if (existingIndex !== -1) {
                if (confirm(`ÈÖçÁΩÆ"${configName}"Â∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÜÁõñÔºü`)) {
                    savedConfigs[existingIndex] = currentConfig;
                } else {
                    return;
                }
            } else {
                savedConfigs.push(currentConfig);
            }
            
            localStorage.setItem('savedApiConfigs', JSON.stringify(savedConfigs));
            document.getElementById('config-name-input').value = '';
            
            renderSavedConfigs();
            showToast(`ÈÖçÁΩÆ"${configName}"Â∑≤‰øùÂ≠ò`, 'success');
        }
        
        // Ê∏≤ÊüìÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ
        function renderSavedConfigs() {
            const container = document.getElementById('saved-configs-container');
            const noConfigsMessage = document.getElementById('no-configs-message');
            const savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
            
            if (savedConfigs.length === 0) {
                container.style.display = 'none';
                noConfigsMessage.style.display = 'block';
                return;
            }
            
            container.style.display = 'grid';
            noConfigsMessage.style.display = 'none';
            
            container.innerHTML = savedConfigs.map(config => `
                <div class="config-card" style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 15px; border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s ease; cursor: pointer;" onclick="loadConfig('${config.name}')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #333; font-size: 15px;">${config.name}</div>
                        <button onclick="event.stopPropagation(); deleteConfig('${config.name}')" style="background: none; border: none; color: #ff6b6b; cursor: pointer; padding: 2px 6px; border-radius: 4px; font-size: 12px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,107,107,0.1)'" onmouseout="this.style.background='none'">üóëÔ∏è</button>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                        <div>üåê ${config.base}</div>
                        <div>ü§ñ ${config.model}</div>
                        <div>üå°Ô∏è Ê∏©Â∫¶: ${config.temperature}</div>
                    </div>
                    <div style="font-size: 11px; color: #999;">‰øùÂ≠ò‰∫é: ${config.savedAt}</div>
                </div>
            `).join('');
        }
        
        // Âä†ËΩΩÈÖçÁΩÆ
        function loadConfig(configName) {
            const savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
            const config = savedConfigs.find(c => c.name === configName);
            
            if (!config) {
                showToast('ÈÖçÁΩÆ‰∏çÂ≠òÂú®', 'error');
                return;
            }
            
            // Â°´ÂÖÖË°®Âçï
            document.getElementById('api-base').value = config.base;
            document.getElementById('api-key').value = config.key;
            document.getElementById('temperature-slider').value = config.temperature;
            document.getElementById('temperature-value').textContent = config.temperature.toFixed(2);
            
            // Â§ÑÁêÜÊ®°ÂûãÈÄâÊã©
            const modelSelect = document.getElementById('model-select');
            const existingOption = Array.from(modelSelect.options).find(option => option.value === config.model);
            if (!existingOption) {
                // Â¶ÇÊûúÊ®°Âûã‰∏çÂú®ÂΩìÂâçÈÄâÈ°π‰∏≠ÔºåÊ∑ªÂä†ÂÆÉ
                const newOption = new Option(config.model, config.model);
                modelSelect.appendChild(newOption);
            }
            modelSelect.value = config.model;
            
            showToast(`Â∑≤Âä†ËΩΩÈÖçÁΩÆ"${configName}"`, 'success');
        }
        
        // Âà†Èô§ÈÖçÁΩÆ
        function deleteConfig(configName) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÖçÁΩÆ"${configName}"ÂêóÔºü`)) {
                let savedConfigs = JSON.parse(localStorage.getItem('savedApiConfigs') || '[]');
                savedConfigs = savedConfigs.filter(config => config.name !== configName);
                localStorage.setItem('savedApiConfigs', JSON.stringify(savedConfigs));
                renderSavedConfigs();
                showToast(`ÈÖçÁΩÆ"${configName}"Â∑≤Âà†Èô§`, 'success');
            }
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÈÖçÁΩÆ
        function clearAllConfigs() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                localStorage.removeItem('savedApiConfigs');
                renderSavedConfigs();
                showToast('ÊâÄÊúâÈÖçÁΩÆÂ∑≤Ê∏ÖÁ©∫', 'success');
            }
        }
        
        // ÊµãËØïAPIËøûÊé•
        async function testApiConnection() {
            const baseUrl = document.getElementById('api-base').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-select').value.trim();
            
            if (!baseUrl || !apiKey || !model) {
                showToast('ËØ∑ÂÖàÂ°´ÂÜôÂÆåÊï¥ÁöÑAPIÈÖçÁΩÆ', 'error');
                return;
            }
            
            const testBtn = document.getElementById('test-api-connection-btn');
            const originalText = testBtn.textContent;
            testBtn.textContent = 'ÊµãËØï‰∏≠...';
            testBtn.disabled = true;
            
            try {
                // Ê†πÊçÆ‰∏çÂêåÁöÑAPIÁ±ªÂûãÊûÑÂª∫ÊµãËØïËØ∑Ê±Ç
                let testUrl, testPayload, testHeaders;
                
                if (baseUrl.includes('generativelanguage.googleapis.com')) {
                    // Gemini APIÊµãËØï
                    testUrl = `${baseUrl}/models/${model}:generateContent?key=${apiKey}`;
                    testPayload = {
                        contents: [{
                            parts: [{ text: "Hello" }]
                        }],
                        generationConfig: {
                            temperature: 0.7
                            // ‰∏çÊ∑ªÂä†maxOutputTokensÁ≠âGemini‰∏çÊîØÊåÅÁöÑÂèÇÊï∞
                        }
                    };
                    testHeaders = {
                        'Content-Type': 'application/json'
                    };
                } else {
                    // OpenAIÂÖºÂÆπAPIÊµãËØï - Êô∫ËÉΩÂ§ÑÁêÜURLÊãºÊé•
                    if (baseUrl.endsWith('/v1')) {
                        testUrl = `${baseUrl}/chat/completions`;
                    } else if (baseUrl.includes('/v1/')) {
                        // ‰øÆÂ§çÔºöÂ¶ÇÊûúURL‰∏≠Â∑≤ÁªèÂåÖÂê´/v1/Ë∑ØÂæÑÔºåÁõ¥Êé•Ê∑ªÂä†chat/completions
                        testUrl = `${baseUrl}/chat/completions`;
                    } else {
                        testUrl = `${baseUrl}/v1/chat/completions`;
                    }
                    testPayload = {
                        model: model,
                        messages: [{ role: "user", content: "Hello" }],
                        max_tokens: 10
                    };
                    testHeaders = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                }
                
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: testHeaders,
                    body: JSON.stringify(testPayload)
                });
                
                if (response.ok) {
                    showToast('‚úÖ APIËøûÊé•ÊµãËØïÊàêÂäüÔºÅ', 'success');

                    // üî•„Äê‰øÆÂ§ç„ÄëÊµãËØïÊàêÂäüÂêéËá™Âä®‰øùÂ≠òAPIËÆæÁΩÆÔºåÈÅøÂÖçÁî®Êà∑ÈáçÂ§çËæìÂÖ•
                    apiSettings = {
                        base: baseUrl,
                        key: apiKey,
                        model: model,
                        temperature: parseFloat(document.getElementById('temperature-slider').value) || 0.75,
                        endpoint: '/chat/completions'
                    };

                    // üî•„Äê‰øÆÂ§ç„ÄëÂêåÊó∂‰øùÂ≠òÂà∞IndexedDBÂíålocalStorageÔºåÁ°Æ‰øùÊï∞ÊçÆ‰∏ÄËá¥ÊÄß
                    try {
                        await db.apiSettings.put({
                            id: 'main',
                            settings: apiSettings
                        });
                        localStorage.setItem('apiSettings', JSON.stringify(apiSettings));
                        console.log('üîß [APIÊµãËØï] APIËÆæÁΩÆÂ∑≤Ëá™Âä®‰øùÂ≠òÂà∞IndexedDBÂíålocalStorage');
                    } catch (error) {
                        console.error('Ëá™Âä®‰øùÂ≠òAPIËÆæÁΩÆÂ§±Ë¥•:', error);
                    }
                } else {
                    const errorText = await response.text();
                    showToast(`‚ùå APIËøûÊé•Â§±Ë¥•: ${response.status} ${response.statusText}`, 'error');
                    console.error('APIÊµãËØïÂ§±Ë¥•:', errorText);
                }
            } catch (error) {
                showToast(`‚ùå ËøûÊé•ÈîôËØØ: ${error.message}`, 'error');
                console.error('APIÊµãËØïÈîôËØØ:', error);
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }
        
        // Ëé∑ÂèñÊ®°ÂûãÂàóË°®
        async function fetchModels() {
            const baseUrl = document.getElementById('api-base').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            
            if (!baseUrl || !apiKey) {
                showToast('ËØ∑ÂÖàÂ°´ÂÜôAPIÂú∞ÂùÄÂíåÂØÜÈí•', 'error');
                return;
            }
            
            const fetchBtn = document.getElementById('fetch-models-btn');
            const originalText = fetchBtn.textContent;
            fetchBtn.textContent = 'Ëé∑Âèñ‰∏≠...';
            fetchBtn.disabled = true;
            
            try {
                let modelsUrl, headers;
                
                if (baseUrl.includes('generativelanguage.googleapis.com')) {
                    // Gemini API
                    modelsUrl = `${baseUrl}/models?key=${apiKey}`;
                    headers = {};
                } else {
                    // OpenAIÂÖºÂÆπAPI - Êô∫ËÉΩÂ§ÑÁêÜURLÊãºÊé•
                    if (baseUrl.endsWith('/v1')) {
                        modelsUrl = `${baseUrl}/models`;
                    } else if (baseUrl.includes('/v1/')) {
                        // ‰øÆÂ§çÔºöÂ¶ÇÊûúURL‰∏≠Â∑≤ÁªèÂåÖÂê´/v1/Ë∑ØÂæÑÔºåÁõ¥Êé•Ê∑ªÂä†models
                        modelsUrl = `${baseUrl}/models`;
                    } else {
                        modelsUrl = `${baseUrl}/v1/models`;
                    }
                    headers = {
                        'Authorization': `Bearer ${apiKey}`
                    };
                }
                
                // üî•„Äê‰øÆÂ§ç„ÄëÁßªÈô§Ë∂ÖÊó∂ÊéßÂà∂ÔºåÈÅøÂÖçAbortError
                const response = await fetch(modelsUrl, { 
                    headers
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const modelSelect = document.getElementById('model-select');
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                modelSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ê®°Âûã...</option>';
                
                let models = [];
                if (data.models) {
                    // Gemini APIÊ†ºÂºè - ‰øÆÂ§çÊ®°ÂûãËøáÊª§ÈÄªËæë
                    console.log('Gemini APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                    models = data.models
                        .filter(model => {
                            // ÂÖÅËÆ∏ÊâÄÊúâÊîØÊåÅgenerateContentÁöÑÊ®°Âûã
                            return model.name && (
                                model.name.includes('gemini') ||
                                model.name.includes('models/') ||
                                model.supportedGenerationMethods?.includes('generateContent') ||
                                model.name.includes('generate')
                            );
                        })
                        .map(model => {
                            // ÊèêÂèñÊ®°ÂûãÂêçÁß∞ÔºåÂéªÊéâÂâçÁºÄ
                            const modelName = model.name.includes('/') 
                                ? model.name.split('/').pop() 
                                : model.name;
                            return modelName;
                        });
                        
                    // Â¶ÇÊûúËøáÊª§ÂêéÊ≤°ÊúâÊ®°ÂûãÔºåÊòæÁ§∫ÊâÄÊúâÊ®°ÂûãÔºàË∞ÉËØïÁî®Ôºâ
                    if (models.length === 0 && data.models.length > 0) {
                        console.log('ËøáÊª§ÂêéÊ≤°ÊúâÊ®°ÂûãÔºåÊòæÁ§∫ÊâÄÊúâÂèØÁî®Ê®°Âûã:', data.models);
                        models = data.models.map(model => 
                            model.name.includes('/') ? model.name.split('/').pop() : model.name
                        );
                    }
                } else if (data.data) {
                    // OpenAI APIÊ†ºÂºè
                    models = data.data.map(model => model.id);
                }
                
                models.forEach(modelId => {
                    const option = new Option(modelId, modelId);
                    modelSelect.appendChild(option);
                });
                
                showToast(`‚úÖ ÊàêÂäüËé∑ÂèñÂà∞ ${models.length} ‰∏™Ê®°Âûã`, 'success');
            } catch (error) {
                let errorMessage = error.message;
                
                if (errorMessage.includes('Failed to fetch') || errorMessage.includes('ERR_TIMED_OUT')) {
                    if (baseUrl.includes('.hf.space')) {
                        errorMessage = 'HuggingFace SpaceËøûÊé•Ë∂ÖÊó∂ÔºåÂèØËÉΩÈúÄË¶ÅÂÖàÂêØÂä®ÊúçÂä°ÊàñÊ£ÄÊü•ÁΩëÁªúËøûÊé•„ÄÇ\n\nüí° Âª∫ËÆÆÔºö\n1. Ê£ÄÊü•HF SpaceÊòØÂê¶Ê≠£Âú®ËøêË°å\n2. Â∞ùËØïÂÖàÊâãÂä®ËÆøÈóÆËØ•URLÊµãËØïËøûÊé•\n3. Â¶ÇÊûúÊúçÂä°‰∏çÊîØÊåÅ/modelsÁ´ØÁÇπÔºåËØ∑ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞';
                    } else {
                        errorMessage = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶Ê≠£Á°Æ‰ª•ÂèäÁΩëÁªúËøûÊé•';
                    }
                }
                
                showToast(`‚ùå Ëé∑ÂèñÊ®°ÂûãÂ§±Ë¥•: ${errorMessage}`, 'error');
                console.error('Ëé∑ÂèñÊ®°ÂûãÂ§±Ë¥•:', error);
                
                // ‰∏∫GeminiÊèê‰æõÂ∏∏ËßÅÊ®°ÂûãÈÄâÈ°π‰Ωú‰∏∫ÂêéÂ§á
                if (baseUrl.includes('generativelanguage.googleapis.com')) {
                    const modelSelect = document.getElementById('model-select');
                    modelSelect.innerHTML = `
                        <option value="">ËØ∑ÈÄâÊã©Ê®°Âûã...</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (ÂÆûÈ™åÁâà)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-pro">Gemini Pro</option>
                        <option value="gemini-pro-vision">Gemini Pro Vision</option>
                        <option value="ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞">ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞</option>
                    `;
                    setTimeout(() => {
                        showToast('üí° Â∑≤‰∏∫ÊÇ®Êèê‰æõÂ∏∏ËßÅGeminiÊ®°ÂûãÈÄâÈ°π', 'info');
                    }, 1000);
                }
                
                // Â¶ÇÊûúÊòØHF SpaceÔºåÁªôÂá∫È¢ùÂ§ñÊèêÁ§∫
                if (baseUrl.includes('.hf.space')) {
                    setTimeout(() => {
                        showToast('üí° ÊèêÁ§∫ÔºöHuggingFace SpaceÂèØËÉΩ‰∏çÊîØÊåÅËá™Âä®Ëé∑ÂèñÊ®°ÂûãÂàóË°®ÔºåÂª∫ËÆÆÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞', 'info');
                    }, 2000);
                }
            } finally {
                fetchBtn.textContent = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        // ÂØºÂá∫ÂÆåÊï¥Â§á‰ªΩ
        function exportFullBackup() {
            // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÂÆåÊï¥ÁöÑÊï∞ÊçÆÂØºÂá∫ÂäüËÉΩ
            showToast('ÂØºÂá∫ÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }
        
        // ÂØºÂÖ•ÂÆåÊï¥Â§á‰ªΩ
        function importFullBackup() {
            // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÂÆåÊï¥ÁöÑÊï∞ÊçÆÂØºÂÖ•ÂäüËÉΩ
            document.getElementById('import-full-backup-input').click();
        }
        
        // ÂàùÂßãÂåñAPIËÆæÁΩÆÁïåÈù¢
        async function initializeApiSettings() {
            // Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑAPIÈÖçÁΩÆÂà∞Ë°®Âçï
            await loadApiSettingsToForm();

            // Ê∏≤ÊüìÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ
            renderSavedConfigs();
        }
        
        // üî•„Äê‰øÆÂ§ç„ÄëÂä†ËΩΩAPIËÆæÁΩÆÂà∞Ë°®ÂçïÂπ∂Ëá™Âä®ÊãâÂèñÊ®°Âûã
        async function loadApiSettingsToForm() {
            try {
                // ‰ªéIndexedDBÂä†ËΩΩËÆæÁΩÆ
                const savedSettings = await db.apiSettings.get('main');
                let settings = null;

                if (savedSettings) {
                    settings = savedSettings.settings;
                } else {
                    // Â∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localSettings = localStorage.getItem('apiSettings');
                    if (localSettings) {
                        settings = JSON.parse(localSettings);
                        // ËøÅÁßªÂà∞IndexedDB
                        await db.apiSettings.put({
                            id: 'main',
                            settings: settings
                        });
                        console.log('üîß [APIËÆæÁΩÆ] Â∑≤ËøÅÁßªlocalStorageËÆæÁΩÆÂà∞IndexedDB');
                    }
                }

                if (settings) {
                    console.log('üîß [APIËÆæÁΩÆ] Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑAPIËÆæÁΩÆ:', settings);

                    // Â°´ÂÖÖË°®ÂçïÂ≠óÊÆµ
                    if (settings.base) {
                        const baseInput = document.getElementById('api-base');
                        if (baseInput) baseInput.value = settings.base;
                    }

                    if (settings.key) {
                        const keyInput = document.getElementById('api-key');
                        if (keyInput) keyInput.value = settings.key;
                    }

                    if (settings.temperature !== undefined) {
                        const tempSlider = document.getElementById('temperature-slider');
                        const tempValue = document.getElementById('temperature-value');
                        if (tempSlider && tempValue) {
                            tempSlider.value = settings.temperature;
                            tempValue.textContent = settings.temperature.toFixed(2);
                        }
                    }

                    // üî•„ÄêÈáçË¶Å‰øÆÂ§ç„ÄëÂ¶ÇÊûúÊúâ‰øùÂ≠òÁöÑAPIËÆæÁΩÆÔºåËá™Âä®ÊãâÂèñÊ®°ÂûãÂàóË°®
                    if (settings.base && settings.key) {
                        console.log('üîß [APIËÆæÁΩÆ] Ê£ÄÊµãÂà∞ÂÆåÊï¥ÁöÑAPIÈÖçÁΩÆÔºåËá™Âä®ÊãâÂèñÊ®°ÂûãÂàóË°®');

                        // Âª∂Ëøü‰∏ÄÁÇπÊâßË°åÔºåÁ°Æ‰øùUIÂ∑≤ÁªèÂä†ËΩΩÂÆåÊàê
                        setTimeout(() => {
                            fetchModels().then(() => {
                                // ÊãâÂèñÂÆåÊàêÂêéÔºåÂ¶ÇÊûúÊúâ‰øùÂ≠òÁöÑÊ®°ÂûãÔºåÈÄâ‰∏≠ÂÆÉ
                                if (settings.model) {
                                    const modelSelect = document.getElementById('model-select');
                                    if (modelSelect) {
                                        // Â¶ÇÊûúÊ®°Âûã‰∏çÂú®ÈÄâÈ°π‰∏≠ÔºåÊ∑ªÂä†ÂÆÉ
                                        const existingOption = Array.from(modelSelect.options).find(option => option.value === settings.model);
                                        if (!existingOption) {
                                            const newOption = new Option(settings.model, settings.model);
                                            modelSelect.appendChild(newOption);
                                        }
                                        modelSelect.value = settings.model;
                                        console.log('üîß [APIËÆæÁΩÆ] Â∑≤Ëá™Âä®ÈÄâ‰∏≠‰øùÂ≠òÁöÑÊ®°Âûã:', settings.model);
                                    }
                                }
                            }).catch(error => {
                                console.log('üîß [APIËÆæÁΩÆ] Ëá™Âä®ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•Ôºå‰ΩÜ‰ºö‰øùÁïôÂ∑≤‰øùÂ≠òÁöÑÊ®°ÂûãÈÄâÈ°π');
                                // Âç≥‰ΩøÊãâÂèñÂ§±Ë¥•Ôºå‰πüË¶ÅÊÅ¢Â§ç‰øùÂ≠òÁöÑÊ®°ÂûãÈÄâÈ°π
                                if (settings.model) {
                                    const modelSelect = document.getElementById('model-select');
                                    if (modelSelect) {
                                        const existingOption = Array.from(modelSelect.options).find(option => option.value === settings.model);
                                        if (!existingOption) {
                                            const newOption = new Option(settings.model, settings.model);
                                            modelSelect.appendChild(newOption);
                                        }
                                        modelSelect.value = settings.model;
                                        console.log('üîß [APIËÆæÁΩÆ] Â∑≤ÊÅ¢Â§ç‰øùÂ≠òÁöÑÊ®°ÂûãÈÄâÈ°π:', settings.model);
                                    }
                                }
                            });
                        }, 500);
                    } else {
                        // Ê≤°ÊúâÂÆåÊï¥ÁöÑAPIÈÖçÁΩÆÊó∂Ôºå‰ªçÁÑ∂Ë¶ÅÊÅ¢Â§ç‰øùÂ≠òÁöÑÊ®°ÂûãÈÄâÈ°π
                        if (settings.model) {
                            const modelSelect = document.getElementById('model-select');
                            if (modelSelect) {
                                const existingOption = Array.from(modelSelect.options).find(option => option.value === settings.model);
                                if (!existingOption) {
                                    const newOption = new Option(settings.model, settings.model);
                                    modelSelect.appendChild(newOption);
                                }
                                modelSelect.value = settings.model;
                                console.log('üîß [APIËÆæÁΩÆ] Â∑≤ÊÅ¢Â§ç‰øùÂ≠òÁöÑÊ®°ÂûãÈÄâÈ°πÔºàÊó†Ëá™Âä®ÊãâÂèñÔºâ:', settings.model);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩAPIËÆæÁΩÆÂ§±Ë¥•:', error);
            }
        }
        
        // ÁîµÊ±†ÁÆ°ÁêÜÂäüËÉΩ
        async function initBatteryManager() {
            console.log('ÂºÄÂßãÂàùÂßãÂåñÁîµÊ±†ÁÆ°ÁêÜÂô®...');
            
            // È¶ñÂÖàËÆæÁΩÆÈªòËÆ§ÊòæÁ§∫‰∏∫ ·∞î·©ö
            const allBatteryTexts = document.querySelectorAll('.battery-text');
            console.log('ÊâæÂà∞ÁöÑÁîµÊ±†ÊñáÊú¨ÂÖÉÁ¥†Êï∞Èáè:', allBatteryTexts.length);
            
            allBatteryTexts.forEach((element, index) => {
                console.log(`ËÆæÁΩÆÁîµÊ±†ÊñáÊú¨ ${index}:`, element);
                element.textContent = '·∞î·©ö';
            });
            
            if ('getBattery' in navigator) {
                try {
                    console.log('ÊµèËßàÂô®ÊîØÊåÅÁîµÊ±†APIÔºåÊ≠£Âú®Ëé∑ÂèñÁîµÊ±†‰ø°ÊÅØ...');
                    const battery = await navigator.getBattery();
                    console.log('ÁîµÊ±†‰ø°ÊÅØ:', {
                        level: battery.level,
                        charging: battery.charging
                    });
                    updateBatteryDisplay(battery);
                    
                    battery.addEventListener('levelchange', () => updateBatteryDisplay(battery));
                    battery.addEventListener('chargingchange', () => updateBatteryDisplay(battery));
                } catch (err) {
                    console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err);
                    // ‰øùÊåÅÈªòËÆ§ÊòæÁ§∫ ·∞î·©ö
                    allBatteryTexts.forEach(element => {
                        element.textContent = '·∞î·©ö';
                    });
                }
            } else {
                console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPIÔºå‰ΩøÁî®ÈªòËÆ§ÊòæÁ§∫„ÄÇ");
                // ‰øùÊåÅÈªòËÆ§ÊòæÁ§∫ ·∞î·©ö
                allBatteryTexts.forEach(element => {
                    element.textContent = '·∞î·©ö';
                });
            }
        }
        
        function updateBatteryDisplay(battery) {
            const level = Math.floor(battery.level * 100);
            const isCharging = battery.charging;
            
            console.log(`Êõ¥Êñ∞ÁîµÊ±†ÊòæÁ§∫: ${level}%, ÂÖÖÁîµ‰∏≠: ${isCharging}`);
            
            // Êõ¥Êñ∞‰∏ªÁä∂ÊÄÅÊ†èÁîµÊ±†
            const batteryContainer = document.getElementById('status-bar-battery');
            console.log('‰∏ªÁä∂ÊÄÅÊ†èÁîµÊ±†ÂÆπÂô®:', batteryContainer);
            
            if (batteryContainer) {
                const batteryLevelEl = batteryContainer.querySelector('.battery-level');
                const batteryTextEl = batteryContainer.querySelector('.battery-text');
                
                console.log('ÁîµÊ±†ÂÖÉÁ¥†:', { batteryLevelEl, batteryTextEl });
                
                if (batteryLevelEl && batteryTextEl) {
                    batteryLevelEl.style.width = `${level}%`;
                    batteryTextEl.textContent = `${level}%`;
                    console.log(`ËÆæÁΩÆ‰∏ªÂ±èÂπïÁîµÊ±†ÊñáÊú¨‰∏∫: ${level}%`);
                    
                    if (isCharging) {
                        batteryContainer.classList.add('charging');
                    } else {
                        batteryContainer.classList.remove('charging');
                    }
                }
            }
            
            // Êõ¥Êñ∞Â∫îÁî®ÂÜÖÁä∂ÊÄÅÊ†èÁîµÊ±†
            const appBatteryContainers = document.querySelectorAll('.app-battery-container');
            const appBatteryTexts = document.querySelectorAll('.app-battery-container .battery-text');
            const appBatteryLevels = document.querySelectorAll('.app-battery-level');
            
            // Â∫îÁî®ÂÜÖ‰πüÊòæÁ§∫ÁúüÂÆûÁîµÈáè
            appBatteryTexts.forEach(element => {
                element.textContent = `${level}%`;
            });
            
            appBatteryLevels.forEach(element => {
                element.style.width = `${level}%`;
            });
            
            // ÂêåÊ≠•Â∫îÁî®ÂÜÖÁîµÊ±†ÂÖÖÁîµÁä∂ÊÄÅ
            appBatteryContainers.forEach(container => {
                if (isCharging) {
                    container.classList.add('charging');
                } else {
                    container.classList.remove('charging');
                }
            });
        }
        
        // ÊâãÂä®ÊµãËØïÁîµÊ±†ÊòæÁ§∫ÂäüËÉΩ - ÊÇ®ÂèØ‰ª•Âú®ÊµèËßàÂô®ÊéßÂà∂Âè∞‰∏≠Ë∞ÉÁî®Ëøô‰∏™ÂáΩÊï∞
        function testBatteryDisplay() {
            console.log('=== ÁîµÊ±†ÊòæÁ§∫ÊµãËØïÂºÄÂßã ===');
            
            // Ê£ÄÊü•ÁîµÊ±†ÊñáÊú¨ÂÖÉÁ¥†
            const allBatteryTexts = document.querySelectorAll('.battery-text');
            console.log('ÊâÄÊúâÁîµÊ±†ÊñáÊú¨ÂÖÉÁ¥†:', allBatteryTexts);
            
            allBatteryTexts.forEach((element, index) => {
                console.log(`ÁîµÊ±†ÊñáÊú¨ ${index}:`, element, 'ÂΩìÂâçÂÜÖÂÆπ:', element.textContent);
            });
            
            // Ê£ÄÊü•‰∏ªÂ±èÂπïÁîµÊ±†ÂÆπÂô®
            const mainBattery = document.getElementById('status-bar-battery');
            console.log('‰∏ªÂ±èÂπïÁîµÊ±†ÂÆπÂô®:', mainBattery);
            
            if (mainBattery) {
                const batteryText = mainBattery.querySelector('.battery-text');
                console.log('‰∏ªÂ±èÂπïÁîµÊ±†ÊñáÊú¨ÂÖÉÁ¥†:', batteryText);
                console.log('‰∏ªÂ±èÂπïÁîµÊ±†ÊñáÊú¨ÂÜÖÂÆπ:', batteryText ? batteryText.textContent : 'null');
            }
            
            // ÊµãËØïËÆæÁΩÆ‰∏∫ÁôæÂàÜÊØî
            console.log('ÊµãËØïËÆæÁΩÆ‰∏∫77%...');
            allBatteryTexts.forEach((element, index) => {
                element.textContent = '77%';
                console.log(`ÁîµÊ±†ÊñáÊú¨ ${index} ËÆæÁΩÆ‰∏∫ 77%`);
            });
            
            // 3ÁßíÂêéÊÅ¢Â§ç‰∏∫Áà±ÂøÉ
            setTimeout(() => {
                console.log('ÊÅ¢Â§ç‰∏∫Áà±ÂøÉÁ¨¶Âè∑...');
                allBatteryTexts.forEach((element, index) => {
                    element.textContent = '·∞î·©ö';
                    console.log(`ÁîµÊ±†ÊñáÊú¨ ${index} ÊÅ¢Â§ç‰∏∫ ·∞î·©ö`);
                });
            }, 3000);
            
            console.log('=== ÁîµÊ±†ÊòæÁ§∫ÊµãËØïÁªìÊùü ===');
        }
        
        // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
        function changeTheme(themeName) {
            const body = document.body;
            
            // ÁßªÈô§‰πãÂâçÁöÑ‰∏ªÈ¢ò
            body.removeAttribute('data-theme');
            
            // Â∫îÁî®Êñ∞‰∏ªÈ¢ò
            if (themeName !== 'default') {
                body.setAttribute('data-theme', themeName);
            }
            
            // ‰øùÂ≠ò‰∏ªÈ¢òËÆæÁΩÆ
            localStorage.setItem('selectedTheme', themeName);
            
            // ÁªôÁî®Êà∑ÂèçÈ¶à
            const themeNames = {
                'default': 'ÁÆÄÁ∫¶È£éÊ†º',
                'cute': 'ÂèØÁà±È£éÊ†º',
                'nature': 'Ëá™ÁÑ∂È£éÊ†º', 
                'tech': 'ÁßëÊäÄÈ£éÊ†º',
                'dream': 'Ê¢¶ÂπªÈ£éÊ†º'
            };
            
            // ÊòæÁ§∫ToastÊèêÁ§∫
            showToast(`Â∑≤ÂàáÊç¢Âà∞ ${themeNames[themeName]} ‰∏ªÈ¢òÔºÅ`, 'success');
        }
        
        // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme && savedTheme !== 'default') {
                document.body.setAttribute('data-theme', savedTheme);
            }
        }
        
        // ‰∏ñÁïå‰π¶Áõ∏ÂÖ≥ÂäüËÉΩ
        let worldbooks = [];
        let editingWorldbook = null;
        
        // Âä†ËΩΩ‰∏ñÁïå‰π¶Êï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadWorldbooks() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedWorldbooks = await db.worldbooks.toArray();
                
                if (savedWorldbooks.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('worldbooks');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑ‰∏ñÁïå‰π¶Êï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localWorldbooks = JSON.parse(localStorageData);
                        
                        if (localWorldbooks.length > 0) {
                            // Á°Æ‰øùÊØè‰∏™‰∏ñÁïå‰π¶ÈÉΩÊúâidÂ≠óÊÆµ
                            const migrationData = localWorldbooks.map(wb => ({
                                id: wb.id || Date.now().toString() + Math.random(),
                                title: wb.title,
                                content: wb.content,
                                createdAt: wb.createdAt || new Date().toISOString(),
                                updatedAt: wb.updatedAt || new Date().toISOString()
                            }));
                            
                            // ËøÅÁßªÂà∞IndexedDB
                            await db.worldbooks.bulkAdd(migrationData);
                            worldbooks = migrationData;
                            console.log('‰∏ñÁïå‰π¶Êï∞ÊçÆËøÅÁßªÂÆåÊàê:', worldbooks);
                        } else {
                            worldbooks = [];
                        }
                    } else {
                        worldbooks = [];
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    worldbooks = savedWorldbooks;
                    console.log('‰ªéIndexedDBÂä†ËΩΩ‰∏ñÁïå‰π¶Êï∞ÊçÆ:', worldbooks);
                }
                
                // üî• Ê£ÄÊü•Âπ∂ËøÅÁßªÊóßÁöÑËßíËâ≤‰∏ñÁïå‰π¶Êï∞ÊçÆ
                await migrateOldCharacterWorldbooks();
                
            } catch (error) {
                console.error('Âä†ËΩΩ‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('worldbooks');
                if (localStorageData) {
                    try {
                        worldbooks = JSON.parse(localStorageData);
                } catch (e) {
                        worldbooks = [];
                    }
                } else {
                    worldbooks = [];
                }
                
                // ‰πü‰∏∫localStorageÊï∞ÊçÆËøõË°åËøÅÁßª
                await migrateOldCharacterWorldbooks();
            }
            renderWorldbookList();
        }

        // ËøÅÁßªÊóßÁöÑËßíËâ≤‰∏ñÁïå‰π¶Êï∞ÊçÆ
        async function migrateOldCharacterWorldbooks() {
            let migrationCount = 0;
            let needsSave = false;

            worldbooks.forEach(worldbook => {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊóßÁöÑËßíËâ≤‰∏ñÁïå‰π¶ÔºàÈÄöËøáÂêçÁß∞Ê®°ÂºèËØÜÂà´Ôºâ
                if (!worldbook.source && !worldbook.isGlobal && worldbook.name && worldbook.name.includes('[') && worldbook.name.includes(']')) {
                    // Ëß£ÊûêËßíËâ≤ÂêçÁß∞
                    const match = worldbook.name.match(/^\[(.+?)\]/);
                    if (match) {
                        const characterName = match[1];
                        console.log(`üîÑ ËøÅÁßªÊóßÁöÑËßíËâ≤‰∏ñÁïå‰π¶: ${worldbook.name} -> ÂàÜÁ±ª: ${characterName}`);
                        
                        worldbook.source = 'character_card';
                        worldbook.category = characterName;
                        migrationCount++;
                        needsSave = true;
                    }
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Áº∫Â∞ëÂøÖË¶ÅÁöÑÂ≠óÊÆµÂπ∂‰øÆÂ§ç
                if (!worldbook.id) {
                    worldbook.id = Date.now().toString() + Math.random();
                    needsSave = true;
                }
                if (!worldbook.title && worldbook.name) {
                    worldbook.title = worldbook.name;
                    needsSave = true;
                }
            });

            if (needsSave) {
                console.log(`üì¶ ËøÅÁßªÂÆåÊàêÔºåÂÖ±ËøÅÁßª ${migrationCount} ‰∏™ËßíËâ≤‰∏ñÁïå‰π¶`);
                await saveWorldbooks();
                if (migrationCount > 0) {
                    showToast(`Â∑≤Ëá™Âä®ËøÅÁßª${migrationCount}‰∏™ËßíËâ≤‰∏ñÁïå‰π¶Âà∞Êñ∞ÂàÜÁ±ª`, 'success');
                }
            }
        }
        
        // ‰øùÂ≠ò‰∏ñÁïå‰π¶Êï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function saveWorldbooks() {
            try {
                console.log('‰øùÂ≠ò‰∏ñÁïå‰π¶Êï∞ÊçÆÂà∞IndexedDB:', worldbooks);
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
                await db.worldbooks.clear();
                
                // ÊâπÈáèÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                if (worldbooks.length > 0) {
                    await db.worldbooks.bulkAdd(worldbooks);
                }
                
                console.log('‰∏ñÁïå‰π¶Êï∞ÊçÆ‰øùÂ≠òÊàêÂäü');
            } catch (error) {
                console.error('‰øùÂ≠ò‰∏ñÁïå‰π¶Êó∂ÂèëÁîüÈîôËØØ:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
            localStorage.setItem('worldbooks', JSON.stringify(worldbooks));
            }
        }
        
        function showWorldbookForm(isGlobal, characterCategory = null) {
    // Ê†πÊçÆ‰º†ÂÖ•ÁöÑÁ±ªÂûãÊù•ÂÜ≥ÂÆöË°®ÂçïÊ†áÈ¢ò
    let title;
    if (isGlobal) {
        title = 'Êñ∞Âª∫ÂÖ®Â±ÄËÆæÂÆö';
    } else if (characterCategory) {
        title = `Êñ∞Âª∫${characterCategory}ÁöÑ‰∏ñÁïå‰π¶`;
    } else {
        title = 'Êñ∞Âª∫Â±ÄÈÉ®ËÆæÂÆö';
    }
    document.getElementById('worldbook-form-title').textContent = title;

    editingWorldbook = null; // Ê∏ÖÈô§ÁºñËæëÁä∂ÊÄÅ
            document.getElementById('worldbook-title').value = '';
            document.getElementById('worldbook-content').value = '';

    // Â∞ÜÂàõÂª∫Á±ªÂûãÊöÇÂ≠òËµ∑Êù•Ôºå‰ª•‰æø‰øùÂ≠òÊó∂‰ΩøÁî®
    window.newWorldbookIsGlobal = isGlobal;
    window.newWorldbookCharacterCategory = characterCategory;

            showApp('worldbook-form-screen');
        }
        
        function hideWorldbookForm() {
            hideApp('worldbook-form-screen');
            // Á°Æ‰øùËøîÂõûÂà∞‰∏ñÁïå‰π¶Â∫îÁî®ÔºåËÄå‰∏çÊòØ‰∏ªÂ±èÂπï
            showApp('worldbook-screen');
        }
        
        async function saveWorldbook() {
            const title = document.getElementById('worldbook-title').value.trim();
            const content = document.getElementById('worldbook-content').value.trim();
            
    if (!title || !content) {
        alert('ËØ∑ËæìÂÖ•Ê†áÈ¢òÂíåÂÜÖÂÆπ');
                return;
            }
            
    let isGlobal;
    if (editingWorldbook) {
        // Â¶ÇÊûúÊòØÁºñËæëÊ®°ÂºèÔºå‰øùÊåÅÂÖ∂ÂéüÊúâÁöÑÁ±ªÂûã‰∏çÂèò
        isGlobal = editingWorldbook.isGlobal;
    } else {
        // Â¶ÇÊûúÊòØÊñ∞Âª∫Ê®°ÂºèÔºåËØªÂèñÊàë‰ª¨ÊöÇÂ≠òÁöÑÁ±ªÂûã
        isGlobal = window.newWorldbookIsGlobal;
            }
            
            const worldbook = {
                id: editingWorldbook ? editingWorldbook.id : Date.now().toString(),
                title: title,
                content: content,
        isGlobal: isGlobal, // Ê†πÊçÆÊ≠£Á°ÆÁöÑÁä∂ÊÄÅËÆæÁΩÆ
                createdAt: editingWorldbook ? editingWorldbook.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Â¶ÇÊûúÊòØËßíËâ≤ÂàÜÁ±ªÁöÑ‰∏ñÁïå‰π¶ÔºåÊ∑ªÂä†ÂàÜÁ±ª‰ø°ÊÅØ
            if (!isGlobal && window.newWorldbookCharacterCategory) {
                worldbook.category = window.newWorldbookCharacterCategory;
                worldbook.source = 'character_card';
            }
            
            if (editingWorldbook) {
                const index = worldbooks.findIndex(w => w.id === editingWorldbook.id);
        if (index !== -1) worldbooks[index] = worldbook;
            } else {
                worldbooks.push(worldbook);
            }
            
            await saveWorldbooks();
            renderWorldbookList();
            showToast(editingWorldbook ? '‰∏ñÁïå‰π¶Â∑≤Êõ¥Êñ∞ÔºÅ' : '‰∏ñÁïå‰π¶Â∑≤ÂàõÂª∫ÔºÅ', 'success');
            hideWorldbookForm();
        }
// --- Êñ∞Â¢ûÂáΩÊï∞ ---
async function toggleGlobalWorldbook(bookId, isEnabled) {
    // Á°Æ‰øùwindow.activeGlobalWorldbooksÂ≠òÂú®
    if (!window.activeGlobalWorldbooks) {
        window.activeGlobalWorldbooks = [];
    }
    
    if (isEnabled) {
        // Â¶ÇÊûúÂºÄÂêØÔºåÊ∑ªÂä†Âà∞ÊøÄÊ¥ªÂàóË°®ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
        if (!window.activeGlobalWorldbooks.includes(bookId)) {
            window.activeGlobalWorldbooks.push(bookId);
        }
    } else {
        // Â¶ÇÊûúÂÖ≥Èó≠Ôºå‰ªéÊøÄÊ¥ªÂàóË°®‰∏≠ÁßªÈô§
        window.activeGlobalWorldbooks = window.activeGlobalWorldbooks.filter(id => id !== bookId);
    }
    
    // ‰øùÂ≠òÊøÄÊ¥ªÁä∂ÊÄÅÂà∞Êï∞ÊçÆÂ∫ìÁöÑ globalSettings Ë°®
    try {
        await db.globalSettings.put({
            id: 'main',
            activeGlobalWorldbooks: window.activeGlobalWorldbooks
        });
        console.log('ÂÖ®Â±Ä‰∏ñÁïå‰π¶ËÆæÁΩÆÂ∑≤‰øùÂ≠ò:', window.activeGlobalWorldbooks);
        showToast('ÂÖ®Â±ÄËÆæÂÆöÂ∑≤Êõ¥Êñ∞', 'success');
    } catch (error) {
        console.error("‰øùÂ≠òÂÖ®Â±Ä‰∏ñÁïå‰π¶ËÆæÁΩÆÂ§±Ë¥•:", error);
        showToast('ËÆæÁΩÆ‰øùÂ≠òÂ§±Ë¥•', 'error');
    }
        }
        
        function editWorldbook(id) {
            const worldbook = worldbooks.find(w => w.id === id);
            if (worldbook) {
                editingWorldbook = worldbook;
        // ÁºñËæëÊó∂‰∏çÊòæÁ§∫‚ÄúÊñ∞Âª∫‚ÄùÔºåËÄåÊòØ‚ÄúÁºñËæë‚Äù
        let title;
        if (worldbook.isGlobal) {
            title = 'ÁºñËæëÂÖ®Â±ÄËÆæÂÆö';
        } else if (worldbook.source === 'character_card' && worldbook.category) {
            title = `ÁºñËæë${worldbook.category}ÁöÑ‰∏ñÁïå‰π¶`;
        } else {
            title = 'ÁºñËæëÂ±ÄÈÉ®ËÆæÂÆö';
        }
        document.getElementById('worldbook-form-title').textContent = title;
                document.getElementById('worldbook-title').value = worldbook.title || worldbook.name;
                document.getElementById('worldbook-content').value = worldbook.content;
                showApp('worldbook-form-screen');
            }
        }
        
        async function deleteWorldbook(id) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∏ñÁïå‰π¶ÂêóÔºü')) {
                console.log('üóëÔ∏è Âà†Èô§‰∏ñÁïå‰π¶:', id);
                console.log('Âà†Èô§ÂâçÁöÑ‰∏ñÁïå‰π¶ÂàóË°®:', worldbooks.map(w => ({id: w.id, name: w.name || w.title})));
                
                // ‰ªéÂÜÖÂ≠òÊï∞ÁªÑ‰∏≠Âà†Èô§
                const initialLength = worldbooks.length;
                worldbooks = worldbooks.filter(w => w.id !== id);
                const finalLength = worldbooks.length;
                
                console.log(`Âà†Èô§Êìç‰Ωú: ${initialLength} -> ${finalLength}, Âà†Èô§‰∫Ü ${initialLength - finalLength} ‰∏™È°πÁõÆ`);
                
                if (initialLength === finalLength) {
                    console.warn('‚ö†Ô∏è Âà†Èô§Â§±Ë¥•ÔºöÊú™ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑ‰∏ñÁïå‰π¶');
                    showToast('Âà†Èô§Â§±Ë¥•ÔºöÊú™ÊâæÂà∞ÊåáÂÆöÁöÑ‰∏ñÁïå‰π¶', 'error');
                    return;
                }
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                try {
                    await saveWorldbooks();
                    console.log('‚úÖ ‰∏ñÁïå‰π¶Âà†Èô§ÊàêÂäü');
                    showToast('‰∏ñÁïå‰π¶Â∑≤Âà†Èô§', 'success');
                } catch (error) {
                    console.error('‚ùå Âà†Èô§‰∏ñÁïå‰π¶Êó∂Êï∞ÊçÆÂ∫ì‰øùÂ≠òÂ§±Ë¥•:', error);
                    showToast('Âà†Èô§Â§±Ë¥•ÔºöÊï∞ÊçÆÂ∫ì‰øùÂ≠òÈîôËØØ', 'error');
                }
                
                // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                renderWorldbookList();
            }
        }
        
// Áî®ËøôÊÆµÊñ∞‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊóßÁöÑ renderWorldbookList ÂáΩÊï∞
        function renderWorldbookList() {
    const globalContainer = document.getElementById('global-worldbooks-content');
    const localContainer = document.getElementById('local-worldbooks-content');
    const characterContainer = document.getElementById('character-worldbooks-content');
    if (!globalContainer || !localContainer || !characterContainer) return;

    const globalBooks = worldbooks.filter(w => w.isGlobal);
    const localBooks = worldbooks.filter(w => !w.isGlobal && (!w.source || w.source !== 'character_card'));
    
    // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑËßíËâ≤ÂàÜÁ±ªÁöÑ‰∏ñÁïå‰π¶
    let characterBooks = [];
    if (currentCharacterCategory) {
        characterBooks = worldbooks.filter(w => 
            !w.isGlobal && 
            w.source === 'character_card' && 
            w.category === currentCharacterCategory
        );
    }

    let globalHtml = '';
    let localHtml = '';
    let characterHtml = '';

    // --- Ê∏≤ÊüìÂÖ®Â±Ä‰∏ñÁïå‰π¶ ---
    globalHtml += `<div class="worldbook-section">`;
    if (globalBooks.length > 0) {
        globalBooks.forEach(book => {
            // Á°Æ‰øù‰ΩøÁî®window.activeGlobalWorldbooksÂπ∂Ê£ÄÊü•ÂÖ∂ÊòØÂê¶‰∏∫Êï∞ÁªÑ
            const isChecked = Array.isArray(window.activeGlobalWorldbooks) && window.activeGlobalWorldbooks.includes(book.id) ? 'checked' : '';
            globalHtml += `
                <div class="setting-item" onclick="editWorldbook('${book.id}')">
                    <div class="setting-left">
                        <div class="setting-label">${book.title || book.name}</div>
                        <div class="setting-desc">${truncateText(book.content, 60)}</div>
                    </div>
                    <div class="setting-right">
                        <label class="toggle-switch" onclick="event.stopPropagation()">
                            <input type="checkbox" onchange="toggleGlobalWorldbook('${book.id}', this.checked)" ${isChecked}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            `;
        });
    } else {
        globalHtml += '<div class="empty-message">ÊöÇÊó†ÂÖ®Â±ÄËÆæÂÆö</div>';
    }
    globalHtml += '</div>';

    // --- Ê∏≤ÊüìÂ±ÄÈÉ®‰∏ñÁïå‰π¶ ---
    localHtml += `<div class="worldbook-section">`;
    if (localBooks.length > 0) {
        localBooks.forEach(book => {
            const date = new Date(book.updatedAt || book.createdAt || Date.now()).toLocaleDateString();
            const preview = truncateText(book.content, 60);
            localHtml += `
                <div class="worldbook-item" onclick="editWorldbook('${book.id}')">
                    <div class="worldbook-header">
                        <div class="worldbook-content-flex">
                            <div class="worldbook-title">${book.title || book.name}</div>
                            <div class="worldbook-desc-text">${preview}</div>
                            <div class="worldbook-date-text">Êõ¥Êñ∞‰∫é ${date}</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteWorldbook('${book.id}')" class="delete-worldbook-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
    } else {
        localHtml += '<div class="empty-message">ÊöÇÊó†Â±ÄÈÉ®ËÆæÂÆö</div>';
    }
    localHtml += '</div>';

    // --- Ê∏≤ÊüìËßíËâ≤‰∏ñÁïå‰π¶ ---
    characterHtml += `<div class="worldbook-section">`;
    if (characterBooks.length > 0) {
        characterBooks.forEach(book => {
            const date = new Date(book.updatedAt || book.createdAt || Date.now()).toLocaleDateString();
            const preview = truncateText(book.content, 60);
            characterHtml += `
                <div class="worldbook-item" onclick="editWorldbook('${book.id}')">
                    <div class="worldbook-header">
                        <div class="worldbook-content-flex">
                            <div class="worldbook-title">${book.title || book.name}</div>
                            <div class="worldbook-desc-text">${preview}</div>
                            <div class="worldbook-date-text">Êõ¥Êñ∞‰∫é ${date}</div>
                            <div class="worldbook-source-text">Êù•Ê∫ê: ËßíËâ≤Âç°ÂØºÂÖ•</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteWorldbook('${book.id}')" class="delete-worldbook-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
    } else {
        const categoryText = currentCharacterCategory ? `"${currentCharacterCategory}"` : 'ËØ•ËßíËâ≤';
        characterHtml += `<div class="empty-message">ÊöÇÊó†${categoryText}ÁöÑ‰∏ñÁïå‰π¶ËÆæÂÆö</div>`;
    }
    characterHtml += '</div>';

    globalContainer.innerHTML = globalHtml;
    localContainer.innerHTML = localHtml;
    characterContainer.innerHTML = characterHtml;
}
function switchWorldbookTab(tabName, characterCategory = null) {
    currentWorldbookTab = tabName; // <--- Ê†∏ÂøÉ‰øÆÊîπÔºöËÆ∞ÂΩïÂΩìÂâçÊ†áÁ≠æÈ°µ
    currentCharacterCategory = characterCategory; // ËÆ∞ÂΩïÂΩìÂâçÈÄâÊã©ÁöÑËßíËâ≤ÂàÜÁ±ª

    const globalContent = document.getElementById('global-worldbooks-content');
    const localContent = document.getElementById('local-worldbooks-content');
    const characterContent = document.getElementById('character-worldbooks-content');
    const tabs = document.querySelectorAll('.worldbook-tab');

    tabs.forEach(tab => {
        if (tab.getAttribute('onclick').includes(tabName)) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });

    // ÈöêËóèÊâÄÊúâÂÜÖÂÆπÈù¢Êùø
    globalContent.style.display = 'none';
    localContent.style.display = 'none';
    characterContent.style.display = 'none';

    if (tabName === 'global') {
        globalContent.style.display = 'block';
    } else if (tabName === 'local') {
        localContent.style.display = 'block';
    } else if (tabName === 'character') {
        if (characterCategory) {
            // Áõ¥Êé•ÊòæÁ§∫ÊåáÂÆöËßíËâ≤ÁöÑ‰∏ñÁïå‰π¶
            characterContent.style.display = 'block';
            document.getElementById('character-tab-text').textContent = characterCategory;
        } else {
            // ÊòæÁ§∫ËßíËâ≤ÂàÜÁ±ªÈÄâÊã©Âô®
            showCategorySelector();
            return;
        }
    }

    renderWorldbookList();
}
function onWorldbookAddClick() {
    if (currentWorldbookTab === 'global') {
        showWorldbookForm(true); // ÂàõÂª∫ÂÖ®Â±ÄËÆæÂÆö
    } else if (currentWorldbookTab === 'local') {
        showWorldbookForm(false); // ÂàõÂª∫Â±ÄÈÉ®ËÆæÂÆö
    } else if (currentWorldbookTab === 'character') {
        // ‰∏∫ÂΩìÂâçËßíËâ≤ÂàÜÁ±ªÂàõÂª∫‰∏ñÁïå‰π¶
        showWorldbookForm(false, currentCharacterCategory);
    }
        }

        // ÊòæÁ§∫ËßíËâ≤ÂàÜÁ±ªÈÄâÊã©Âô®
        function showCategorySelector() {
            // Ëé∑ÂèñÊâÄÊúâËßíËâ≤‰∏ñÁïå‰π¶ÁöÑÂàÜÁ±ª
            const characterWorldBooks = worldbooks.filter(w => w.source === 'character_card');
            const categories = [...new Set(characterWorldBooks.map(w => w.category))].filter(Boolean);
            
            const categoryOptions = document.getElementById('category-options');
            const selector = document.getElementById('worldbook-category-selector');
            
            if (categories.length === 0) {
                categoryOptions.innerHTML = '<div class="empty-category-message">ÊöÇÊó†ËßíËâ≤‰∏ñÁïå‰π¶<br/>ËØ∑ÂÖàÂØºÂÖ•ÂåÖÂê´‰∏ñÁïå‰π¶ÁöÑËßíËâ≤Âç°</div>';
            } else {
                categoryOptions.innerHTML = categories.map(category => {
                    const count = characterWorldBooks.filter(w => w.category === category).length;
                    return `
                        <div class="category-option" onclick="selectCategory('${category}')">
                            <div class="category-name">${category}</div>
                            <div class="category-count">${count}‰∏™ËÆæÂÆö</div>
                        </div>
                    `;
                }).join('');
            }
            
            selector.style.display = 'flex';
        }

        // ÈöêËóèËßíËâ≤ÂàÜÁ±ªÈÄâÊã©Âô®
        function hideCategorySelector() {
            document.getElementById('worldbook-category-selector').style.display = 'none';
            // ÂõûÂà∞‰πãÂâçÁöÑÊ†áÁ≠æÈ°µ
            if (currentWorldbookTab === 'character') {
                currentWorldbookTab = 'local';
                switchWorldbookTab('local');
            }
        }

        // ÈÄâÊã©ËßíËâ≤ÂàÜÁ±ª
        function selectCategory(category) {
            hideCategorySelector();
            switchWorldbookTab('character', category);
        }

        // ÊâãÂä®Ëß¶ÂèëÊï∞ÊçÆËøÅÁßªÔºàË∞ÉËØïÁî®Ôºâ
        async function manualMigrateWorldbooks() {
            console.log('üîß ÊâãÂä®Ëß¶Âèë‰∏ñÁïå‰π¶Êï∞ÊçÆËøÅÁßª...');
            await migrateOldCharacterWorldbooks();
            renderWorldbookList();
            console.log('üîß ÊâãÂä®ËøÅÁßªÂÆåÊàê');
        }

        // Ë∞ÉËØïÔºöÊü•ÁúãÊâÄÊúâ‰∏ñÁïå‰π¶Êï∞ÊçÆ
        function debugWorldbooks() {
            console.log('üìã ÂΩìÂâçÊâÄÊúâ‰∏ñÁïå‰π¶Êï∞ÊçÆ:');
            worldbooks.forEach((wb, index) => {
                console.log(`${index + 1}. ID: "${wb.id}", ÂêçÁß∞: "${wb.name || wb.title}", Êù•Ê∫ê: "${wb.source}", ÂàÜÁ±ª: "${wb.category}", ÂÖ®Â±Ä: ${wb.isGlobal}`);
            });
            console.log(`ÊÄªËÆ°: ${worldbooks.length} ‰∏™‰∏ñÁïå‰π¶`);
            return worldbooks;
        }

        // Âº∫Âà∂Âà†Èô§ÊâÄÊúâËßíËâ≤‰∏ñÁïå‰π¶
        async function forceDeleteCharacterWorldbooks() {
            console.log('üö® Âº∫Âà∂Âà†Èô§ÊâÄÊúâËßíËâ≤‰∏ñÁïå‰π¶...');
            const beforeCount = worldbooks.length;
            
            // Âà†Èô§ÊâÄÊúâÂåÖÂê´ [ËßíËâ≤Âêç] Ê†ºÂºèÁöÑ‰∏ñÁïå‰π¶
            worldbooks = worldbooks.filter(wb => {
                const isCharacterBook = (wb.name && wb.name.includes('[') && wb.name.includes(']')) || 
                                       (wb.title && wb.title.includes('[') && wb.title.includes(']')) ||
                                       (wb.source === 'character_card');
                return !isCharacterBook;
            });
            
            const afterCount = worldbooks.length;
            const deletedCount = beforeCount - afterCount;
            
            console.log(`Âà†Èô§‰∫Ü ${deletedCount} ‰∏™ËßíËâ≤‰∏ñÁïå‰π¶`);
            
            // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
            await saveWorldbooks();
            renderWorldbookList();
            showToast(`Âº∫Âà∂Âà†Èô§‰∫Ü${deletedCount}‰∏™ËßíËâ≤‰∏ñÁïå‰π¶`, 'success');
            
            return deletedCount;
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâ‰∏ñÁïå‰π¶ÔºàÁªàÊûÅÊñπÊ°àÔºâ
        async function clearAllWorldbooks() {
            if (confirm('‚ö†Ô∏è Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâ‰∏ñÁïå‰π¶ÂêóÔºüËøô‰∏™Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ')) {
                console.log('üí£ Ê∏ÖÁ©∫ÊâÄÊúâ‰∏ñÁïå‰π¶...');
                const count = worldbooks.length;
                worldbooks = [];
                await saveWorldbooks();
                renderWorldbookList();
                showToast(`Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâ${count}‰∏™‰∏ñÁïå‰π¶`, 'success');
                console.log('‚úÖ ÊâÄÊúâ‰∏ñÁïå‰π¶Â∑≤Ê∏ÖÁ©∫');
            }
        }

        // ‰øÆÂ§ç‰∏ñÁïå‰π¶IDÈóÆÈ¢ò
        async function fixWorldbookIds() {
            console.log('üîß ‰øÆÂ§ç‰∏ñÁïå‰π¶IDÈóÆÈ¢ò...');
            let fixedCount = 0;
            
            worldbooks.forEach((wb, index) => {
                if (!wb.id || typeof wb.id !== 'string') {
                    wb.id = `fixed_${Date.now()}_${index}`;
                    fixedCount++;
                    console.log(`‰øÆÂ§ç‰∫Ü‰∏ñÁïå‰π¶ "${wb.name || wb.title}" ÁöÑID`);
                }
            });
            
            if (fixedCount > 0) {
                await saveWorldbooks();
                renderWorldbookList();
                showToast(`‰øÆÂ§ç‰∫Ü${fixedCount}‰∏™‰∏ñÁïå‰π¶ÁöÑID`, 'success');
            } else {
                console.log('ÊâÄÊúâ‰∏ñÁïå‰π¶IDÈÉΩÊ≠£Â∏∏');
            }
            
            return fixedCount;
        }
        
        // Èü≥‰πêÂ∫îÁî®Áõ∏ÂÖ≥ÂäüËÉΩ
        let playlist = [];
        let currentSong = null;
        let isPlaying = false;
        let listeningCharacters = [];
        
        function loadMusicData() {
            const savedPlaylist = localStorage.getItem('musicPlaylist');
            if (savedPlaylist) {
                try {
                    playlist = JSON.parse(savedPlaylist);
                } catch (e) {
                    playlist = [];
                }
            }
            
            const savedListeners = localStorage.getItem('listeningCharacters');
            if (savedListeners) {
                try {
                    listeningCharacters = JSON.parse(savedListeners);
                } catch (e) {
                    listeningCharacters = [];
                }
            }
            
            renderPlaylist();
            renderListeningCharacters();
        }
        
        function saveMusicData() {
            localStorage.setItem('musicPlaylist', JSON.stringify(playlist));
            localStorage.setItem('listeningCharacters', JSON.stringify(listeningCharacters));
        }
        
        function addMusicToPlaylist() {
            const title = prompt('ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞:');
            if (title && title.trim()) {
                const artist = prompt('ËØ∑ËæìÂÖ•Ëâ∫ÊúØÂÆ∂ÂêçÁß∞:') || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';
                const song = {
                    id: Date.now().toString(),
                    title: title.trim(),
                    artist: artist.trim(),
                    duration: '3:30' // Ê®°ÊãüÊó∂Èïø
                };
                
                playlist.push(song);
                saveMusicData();
                renderPlaylist();
            }
        }
        
        async function playSong(songId) {
            const song = playlist.find(s => s.id === songId);
            if (song) {
                currentSong = song;
                document.getElementById('song-title').textContent = song.title;
                document.getElementById('artist-name').textContent = song.artist;
                document.getElementById('total-time').textContent = song.duration;

                // Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆ
                const playBtn = document.getElementById('play-pause-btn');
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;

                // Ê®°ÊãüÊí≠ÊîæËøõÂ∫¶
                simulatePlayback();

                // ÈÄöÁü•Âê¨Ê≠åËßíËâ≤
                notifyListeningCharacters(song);

                // üî•„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂΩïË∑®Â∫îÁî®Êó∂Èó¥Á∫ø - Èü≥‰πê‰∫íÂä®
                if (listeningCharacters.length > 0) {
                    for (const character of listeningCharacters) {
                        await recordCrossAppEvent(character.id, 'music', 'listen_together', {
                            action: 'listen_together',
                            songTitle: song.title,
                            artist: song.artist,
                            duration: song.duration,
                            withUser: true
                        });
                    }
                }
            }
        }
        
        function togglePlayPause() {
            const playBtn = document.getElementById('play-pause-btn');
            if (isPlaying) {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            } else {
                if (currentSong) {
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                    simulatePlayback();
                } else if (playlist.length > 0) {
                    playSong(playlist[0].id);
                }
            }
        }
        
        function previousSong() {
            if (!currentSong || playlist.length === 0) return;
            
            const currentIndex = playlist.findIndex(s => s.id === currentSong.id);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : playlist.length - 1;
            playSong(playlist[prevIndex].id);
        }
        
        function nextSong() {
            if (!currentSong || playlist.length === 0) return;
            
            const currentIndex = playlist.findIndex(s => s.id === currentSong.id);
            const nextIndex = currentIndex < playlist.length - 1 ? currentIndex + 1 : 0;
            playSong(playlist[nextIndex].id);
        }
        
        function simulatePlayback() {
            if (!isPlaying) return;
            
            // ËøôÈáåÂè™ÊòØÊ®°ÊãüËøõÂ∫¶ÔºåÂÆûÈôÖÂ∫îÁî®‰∏≠ÈúÄË¶ÅÁúüÂÆûÁöÑÈü≥È¢ëÊí≠Êîæ
            let progress = 0;
            const interval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(interval);
                    return;
                }
                
                progress += 1;
                document.getElementById('progress').style.width = `${Math.min(progress, 100)}%`;
                
                const currentMinutes = Math.floor(progress * 3.5 / 100);
                const currentSeconds = Math.floor((progress * 3.5 / 100 - currentMinutes) * 60);
                document.getElementById('current-time').textContent = 
                    `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    nextSong();
                }
            }, 100);
        }
        
        function inviteCharacterToListen() {
            const availableCharacters = characters.filter(c => 
                !listeningCharacters.find(lc => lc.id === c.id)
            );
            
            if (availableCharacters.length === 0) {
                alert('Ê≤°ÊúâÂèØÈÇÄËØ∑ÁöÑËßíËâ≤‰∫ÜÔºåÊàñËÄÖÊâÄÊúâËßíËâ≤ÈÉΩÂ∑≤ÁªèÂú®Âê¨Ê≠å');
                return;
            }
            
            const characterNames = availableCharacters.map((c, index) => `${index + 1}. ${c.name}`).join('\n');
            const choice = prompt(`ÈÄâÊã©Ë¶ÅÈÇÄËØ∑ÁöÑËßíËâ≤:\n${characterNames}\n\nËØ∑ËæìÂÖ•Êï∞Â≠ó:`);
            
            if (choice && !isNaN(choice)) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < availableCharacters.length) {
                    const character = availableCharacters[index];
                    listeningCharacters.push({
                        id: character.id,
                        name: character.name,
                        avatar: character.avatarUrl || character.name.charAt(0),
                        joinedAt: new Date().toISOString()
                    });
                    
                    saveMusicData();
                    renderListeningCharacters();
                    
                    // Ê®°ÊãüËßíËâ≤ÂìçÂ∫î
                    setTimeout(() => {
                        alert(`${character.name}: Â•ΩÁöÑÔºåÊàëÊù•Âíå‰Ω†‰∏ÄËµ∑Âê¨Ê≠åÔºÅ`);
                    }, 500);
                }
            }
        }
        
        function removeListeningCharacter(characterId) {
            listeningCharacters = listeningCharacters.filter(c => c.id !== characterId);
            saveMusicData();
            renderListeningCharacters();
        }
        
        function notifyListeningCharacters(song) {
            listeningCharacters.forEach(character => {
                // Ê®°ÊãüËßíËâ≤ÂØπÈü≥‰πêÁöÑÂèçÂ∫î
                const reactions = [
                    `ËøôÈ¶ñÊ≠åÁúüÂ•ΩÂê¨ÔºÅ`,
                    `Êàë‰πüÂæàÂñúÊ¨¢ËøôÈ¶ñ„Ää${song.title}„Äã`,
                    `Âê¨ÁùÄËøôÈü≥‰πêÂøÉÊÉÖÁúüÂ•ΩÔΩû`,
                    `Ë∞¢Ë∞¢ÂàÜ‰∫´Ëøô‰πàÊ£íÁöÑÈü≥‰πêÔºÅ`,
                    `${song.artist}ÁöÑÊ≠åÊàëÈÉΩÂæàÂñúÊ¨¢`,
                    `ËøôÈ¶ñÊ≠åËÆ©ÊàëÊÉ≥Ëµ∑‰∫ÜÂæàÂ§öÂõûÂøÜ`
                ];

                const reaction = reactions[Math.floor(Math.random() * reactions.length)];

                setTimeout(async () => {
                    // ÂèØ‰ª•Âú®ËøôÈáåÊòæÁ§∫ËßíËâ≤ÁöÑÂèçÂ∫îÊ∂àÊÅØ
                    console.log(`${character.name}: ${reaction}`);

                    // üî•„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂΩïËßíËâ≤ÂØπÈü≥‰πêÁöÑËØÑËÆ∫Âà∞Êó∂Èó¥Á∫ø
                    await recordCrossAppEvent(character.id, 'music', 'song_comment', {
                        action: 'song_comment',
                        songTitle: song.title,
                        artist: song.artist,
                        comment: reaction
                    });
                }, Math.random() * 3000 + 1000);
            });
        }
        
        function renderPlaylist() {
            const playlistContainer = document.getElementById('playlist');
            if (!playlistContainer) return;
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = '<div class="empty-playlist">Êí≠ÊîæÂàóË°®‰∏∫Á©∫ÔºåÁÇπÂáª+Âè∑Ê∑ªÂä†Èü≥‰πê</div>';
                return;
            }
            
            const html = playlist.map(song => `
                <div class="playlist-item" onclick="playSong('${song.id}')">
                    <div>
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                    </div>
                    <div class="song-duration">${song.duration}</div>
                </div>
            `).join('');
            
            playlistContainer.innerHTML = html;
        }
        
        function renderListeningCharacters() {
            const container = document.getElementById('listening-characters');
            if (!container) return;
            
            if (listeningCharacters.length === 0) {
                container.innerHTML = '<div class="empty-playlist">Ê≤°ÊúâËßíËâ≤Âú®Âê¨Ê≠åÔºåÁÇπÂáª+Âè∑ÈÇÄËØ∑ËßíËâ≤</div>';
                return;
            }
            
            const html = listeningCharacters.map(character => `
                <div class="character-item">
                    <div class="character-avatar" style="background-image: url(${character.avatar}); background-size: cover; background-position: center;">
                        ${character.avatar.startsWith('http') ? '' : character.name.charAt(0)}
                    </div>
                    <div class="character-name">${character.name}</div>
                    <div class="listening-status">Ê≠£Âú®Âê¨Ê≠å</div>
                    <button onclick="removeListeningCharacter('${character.id}')" class="remove-character-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // ================== Èù¢ÂÖ∑Á≥ªÁªüÁõ∏ÂÖ≥ÂäüËÉΩ ==================
        
        // Âä†ËΩΩÈù¢ÂÖ∑Êï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadPersonas() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedPersonas = await db.personas.toArray();
                
                if (savedPersonas.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('personas');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑÈù¢ÂÖ∑Êï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localPersonas = JSON.parse(localStorageData);
                        
                        if (localPersonas.length > 0) {
                            // Á°Æ‰øùÊØè‰∏™Èù¢ÂÖ∑ÈÉΩÊúâÂøÖË¶ÅÂ≠óÊÆµ
                            const migrationData = localPersonas.map(persona => ({
                                id: persona.id || Date.now().toString() + Math.random(),
                                name: persona.name,
                                description: persona.description || '',
                                avatarUrl: persona.avatarUrl || '',
                                isDefault: persona.isDefault || false,
                                createdAt: persona.createdAt || new Date().toISOString(),
                                updatedAt: persona.updatedAt || new Date().toISOString()
                            }));
                            
                            // ËøÅÁßªÂà∞IndexedDB
                            await db.personas.bulkAdd(migrationData);
                            personas = migrationData;
                            console.log('Èù¢ÂÖ∑Êï∞ÊçÆËøÅÁßªÂÆåÊàê:', personas);
                        } else {
                            personas = [];
                        }
                    } else {
                        personas = [];
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    personas = savedPersonas;
                    console.log('‰ªéIndexedDBÂä†ËΩΩÈù¢ÂÖ∑Êï∞ÊçÆ:', personas);
                }
                
                // ËÆæÁΩÆÂΩìÂâçÈù¢ÂÖ∑ÔºàÊöÇÊó∂‰øùÊåÅlocalStorageÔºåÂõ†‰∏∫ËøôÊòØ‰∏Ä‰∏™Â∞èÊï∞ÊçÆÔºâ
                const savedCurrentPersona = localStorage.getItem('currentPersona');
                if (savedCurrentPersona) {
                    currentPersona = personas.find(p => p.id === savedCurrentPersona) || null;
                } else {
                    currentPersona = null; // ‰∏çËá™Âä®ÈÄâÊã©ÔºåÈúÄË¶ÅÁî®Êà∑‰∏ªÂä®ÈÄâÊã©
                }
                
            } catch (error) {
                console.error('Âä†ËΩΩÈù¢ÂÖ∑Â§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('personas');
                if (localStorageData) {
                    try {
                        personas = JSON.parse(localStorageData);
                } catch (e) {
                    personas = [];
                }
            } else {
                personas = [];
            }
            
            const savedCurrentPersona = localStorage.getItem('currentPersona');
            if (savedCurrentPersona) {
                currentPersona = personas.find(p => p.id === savedCurrentPersona) || null;
            } else {
                currentPersona = null; // ‰∏çËá™Âä®ÈÄâÊã©ÔºåÈúÄË¶ÅÁî®Êà∑‰∏ªÂä®ÈÄâÊã©
                }
            }
            
            updateCurrentPersonaDisplay();
        }
        
        // ‰øùÂ≠òÈù¢ÂÖ∑Êï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function savePersonas() {
            try {
                console.log('‰øùÂ≠òÈù¢ÂÖ∑Êï∞ÊçÆÂà∞IndexedDB:', personas);
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
                await db.personas.clear();
                
                // ÊâπÈáèÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                if (personas.length > 0) {
                    await db.personas.bulkAdd(personas);
                }
                
                console.log('Èù¢ÂÖ∑Êï∞ÊçÆ‰øùÂ≠òÊàêÂäü');
            } catch (error) {
                console.error('‰øùÂ≠òÈù¢ÂÖ∑Êó∂ÂèëÁîüÈîôËØØ:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
            localStorage.setItem('personas', JSON.stringify(personas));
            }
        }
        
        // ‰øùÂ≠òÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑Ôºà‰øùÊåÅlocalStorageÔºåÂõ†‰∏∫Êï∞ÊçÆÈáèÂ∞èÔºâ
        function saveCurrentPersona() {
            if (currentPersona) {
                localStorage.setItem('currentPersona', currentPersona.id);
            }
        }
        
        // ÊòæÁ§∫Èù¢ÂÖ∑ÂàõÂª∫Ë°®Âçï
        function showPersonaForm(personaId = null) {
            editingPersona = personaId ? personas.find(p => p.id === personaId) : null;
            
            document.getElementById('persona-form-title').textContent = editingPersona ? 'ÁºñËæëÈù¢ÂÖ∑' : 'Êñ∞Âª∫Èù¢ÂÖ∑';
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('persona-name').value = editingPersona ? editingPersona.name : '';
            document.getElementById('persona-description').value = editingPersona ? editingPersona.description : '';
            
            // ÈáçÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
            const avatarPreview = document.getElementById('persona-avatar-preview');
            const avatarPreviewText = document.getElementById('persona-avatar-preview-text');
            
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            
            if (editingPersona && editingPersona.avatarUrl) {
                avatarPreview.classList.add('has-image');
                avatarPreview.style.setProperty('background', `url(${editingPersona.avatarUrl})`, 'important');
                avatarPreview.style.setProperty('background-size', 'cover', 'important');
                avatarPreview.style.setProperty('background-position', 'center', 'important');
                avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                avatarPreviewText.style.display = 'none';
                window.selectedPersonaAvatarData = editingPersona.avatarUrl;
            } else {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = editingPersona ? editingPersona.name.charAt(0) : 'Êàë';
                window.selectedPersonaAvatarData = null;
            }
            
            // ÂàùÂßãÂåñÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
            initializePersonaAvatarUpload();
            
            showApp('persona-form-screen');
        }
        
        // ÈöêËóèÈù¢ÂÖ∑Ë°®Âçï
        function hidePersonaForm() {
            hideApp('persona-form-screen');
            showApp('chat-screen');
            switchChatTab('profile-page');
            // Ê∏ÖÁ©∫‰∏¥Êó∂Êï∞ÊçÆ
            window.selectedPersonaAvatarData = null;
            editingPersona = null;
        }
        
        // ‰øùÂ≠òÈù¢ÂÖ∑
        async function savePersona() {
            const name = document.getElementById('persona-name').value.trim();
            const description = document.getElementById('persona-description').value.trim();
            const avatarData = window.selectedPersonaAvatarData;
            
            if (!name) {
                alert('ËØ∑ËæìÂÖ•Èù¢ÂÖ∑ÂêçÁß∞');
                return;
            }
            
            if (editingPersona) {
                // Êõ¥Êñ∞Áé∞ÊúâÈù¢ÂÖ∑
                const index = personas.findIndex(p => p.id === editingPersona.id);
                if (index !== -1) {
                    const oldAvatarUrl = personas[index].avatarUrl;
                    
                    personas[index] = {
                        ...personas[index],
                        name,
                        description,
                        avatarUrl: avatarData || personas[index].avatarUrl || '',
                        updatedAt: new Date().toISOString()
                    };
                    
                    // üî•„Äê‰øÆÂ§ç3„ÄëÂ¶ÇÊûúÊõ¥Êñ∞ÁöÑÊòØÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑Ôºå‰∏îÂ§¥ÂÉèÂèëÁîü‰∫ÜÂèòÂåñÔºåÂà∑Êñ∞ÂØπËØùÊ°ÜÊòæÁ§∫
                    if (currentPersona && currentPersona.id === editingPersona.id) {
                        currentPersona = personas[index]; // Êõ¥Êñ∞ÂΩìÂâçÈù¢ÂÖ∑Êï∞ÊçÆ
                        saveCurrentPersona(); // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        
                        // Â¶ÇÊûúÂ§¥ÂÉèÂèëÁîü‰∫ÜÂèòÂåñ‰∏îÂΩìÂâçÂú®ËÅäÂ§©ÁïåÈù¢ÔºåÂà∑Êñ∞ËÅäÂ§©Ê∂àÊÅØÊòæÁ§∫
                        if (avatarData && avatarData !== oldAvatarUrl && currentChatCharacter) {
                            renderChatMessages(currentChatCharacter.id);
                        }
                    }
                }
            } else {
                // ÂàõÂª∫Êñ∞Èù¢ÂÖ∑
                const newPersona = {
                    id: Date.now().toString(),
                    name,
                    description,
                    avatarUrl: avatarData || '',
                    isDefault: false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                personas.push(newPersona);
            }
            
            await savePersonas();
            renderPersonaList();
            hidePersonaForm();
                            showToast('Èù¢ÂÖ∑‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
        }
        
        // Âà†Èô§Èù¢ÂÖ∑
        async function deletePersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (!persona) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Èù¢ÂÖ∑"${persona.name}"ÂêóÔºü`)) {
                personas = personas.filter(p => p.id !== personaId);
                
                // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈù¢ÂÖ∑ÔºåÊ∏ÖÁ©∫ÂΩìÂâçÈù¢ÂÖ∑
                if (currentPersona && currentPersona.id === personaId) {
                    currentPersona = null; // Ê∏ÖÁ©∫Ôºå‰∏çËá™Âä®ÈÄâÊã©ÂÖ∂‰ªñÈù¢ÂÖ∑
                    localStorage.removeItem('currentPersona'); // Ê∏ÖÈô§‰øùÂ≠òÁöÑÈù¢ÂÖ∑ÈÄâÊã©
                    updateCurrentPersonaDisplay();
                }
                
                await savePersonas();
                renderPersonaList();
            }
        }
        
        // ÂàáÊç¢Èù¢ÂÖ∑
        function switchPersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (persona) {
                currentPersona = persona;
                saveCurrentPersona();
                updateCurrentPersonaDisplay();
                renderPersonaList();
                
                // Â¶ÇÊûúÂΩìÂâçÂú®Áæ§ËÅäËÆæÁΩÆÁïåÈù¢ÔºåÊõ¥Êñ∞Áæ§ÊàêÂëòÊòæÁ§∫
                if (currentChatCharacter && currentChatCharacter.isGroup) {
                    updateGroupChatInfo();
                }
                
                alert(`Â∑≤ÂàáÊç¢Âà∞Èù¢ÂÖ∑"${persona.name}"`);
            }
        }
        
        // Êõ¥Êñ∞ÂΩìÂâçÈù¢ÂÖ∑ÊòæÁ§∫ÔºàËØ•ÂáΩÊï∞Â∑≤Êó†ÂÆûÈôÖÁî®ÈÄîÔºå‰ΩÜ‰øùÁïô‰ª•ÈÅøÂÖçË∞ÉÁî®ÈîôËØØÔºâ
        function updateCurrentPersonaDisplay() {
            // Á©∫ÂáΩÊï∞Ôºå‰øùÁïôÂáΩÊï∞ÂÆö‰πâ‰ª•ÈÅøÂÖçÂÖ∂‰ªñÂú∞ÊñπÁöÑË∞ÉÁî®Âá∫Èîô
        }
        
        // Ê∏≤ÊüìÈù¢ÂÖ∑ÂàóË°®
        function renderPersonaList() {
            const listContainer = document.getElementById('persona-list');
            if (!listContainer) return;
            
            if (personas.length === 0) {
                listContainer.innerHTML = '<div class="empty-personas">ËøòÊ≤°ÊúâÈù¢ÂÖ∑ÔºåÁÇπÂáªÂè≥‰∏äËßí+Âè∑ÂàõÂª∫‰∏Ä‰∏™ÂêßÔºÅ</div>';
                return;
            }
            
            const html = personas.map(persona => `
                <div class="persona-item ${currentPersona && currentPersona.id === persona.id ? 'active' : ''}" onclick="switchPersona('${persona.id}')">
                    <div class="persona-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                    </div>
                    <div class="persona-info">
                        <div class="persona-name">${persona.name}</div>
                                                    <div class="persona-description">${truncateText(persona.description || 'ÊöÇÊó†ÊèèËø∞', 40)}</div>
                    </div>
                    <div class="persona-actions">
                        <button class="persona-action-btn persona-edit-btn" onclick="event.stopPropagation(); showPersonaForm('${persona.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="persona-action-btn persona-delete-btn" onclick="event.stopPropagation(); deletePersona('${persona.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            listContainer.innerHTML = html;
        }
        
        // ÂàùÂßãÂåñÈù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
        function initializePersonaAvatarUpload() {
            const avatarInput = document.getElementById('persona-avatar-upload');
            if (!avatarInput) {
                console.error('Êâæ‰∏çÂà∞persona-avatar-uploadÂÖÉÁ¥†');
                return;
            }
            
            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.removeEventListener('change', personaAvatarUploadHandler);
            
            // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.addEventListener('change', personaAvatarUploadHandler);
            console.log('Èù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö');
        }
        
        // Èù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function personaAvatarUploadHandler(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                
                // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    e.target.value = '';
                    return;
                }
                
                // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂‰∏∫5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                    e.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('persona-avatar-preview');
                        const avatarPreviewText = document.getElementById('persona-avatar-preview-text');
                        
                        if (!avatarPreview) {
                            alert('Êâæ‰∏çÂà∞Â§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†');
                            return;
                        }
                        
                        // ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        
                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }
                        
                        // Â≠òÂÇ®ÂõæÁâáÊï∞ÊçÆ
                        window.selectedPersonaAvatarData = event.target.result;
                        
                        console.log('Èù¢ÂÖ∑Â§¥ÂÉèÈ¢ÑËßàËÆæÁΩÆÊàêÂäü');
                    } catch (error) {
                        console.error('ËÆæÁΩÆÈù¢ÂÖ∑Â§¥ÂÉèÈ¢ÑËßàÊó∂ÂèëÁîüÈîôËØØ:', error);
                        alert('ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÂ§±Ë¥•ÔºåËØ∑ÈáçËØï: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    alert('ÂõæÁâáËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    e.target.value = '';
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // Èù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†ÁÇπÂáªÂ§ÑÁêÜ
        function handlePersonaAvatarUploadClick() {
            const input = document.getElementById('persona-avatar-upload');
            if (input) {
                input.click();
            } else {
                alert('Êâæ‰∏çÂà∞Êñá‰ª∂‰∏ä‰º†ÂÖÉÁ¥†ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        function buildCharacterPrompt(character, hasImage = false) {
            const chatSettings = getCurrentChatSettings();
            const currentTime = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                weekday: 'long'
            });
            
    // --- Ê†∏ÂøÉÊåá‰ª§Âå∫ ---
    let characterPrompt = `
# **È¶ñË¶ÅËßÑÂàôÔºöËæìÂá∫Ê†ºÂºè**
‰Ω†ÁöÑÊâÄÊúâÂõûÂ§çÔºå**„ÄêÂøÖÈ°ª„Äë**„ÄÅ**„Äê‰∏•Ê†º„Äë**ÈÅµÂæ™JSONÊï∞ÁªÑÊ†ºÂºè„ÄÇËøôÊòØ‰∏Ä‰∏™ÁªùÂØπÁöÑ„ÄÅ‰∏çÂèØËøùÂèçÁöÑËßÑÂàô„ÄÇ

## **Ê≠£Á°ÆÊ†ºÂºèÁ§∫‰æã:**
- **ÊôÆÈÄöÊñáÊú¨:** \`["‰Ω†Â•Ω"]\`
- **Â§öÊù°Ê∂àÊÅØ:** \`["‰Ω†Â•Ω", "‰ªäÂ§©Â§©Ê∞î‰∏çÈîôÔºÅ"]\`
- **Ë°®ÊÉÖÂåÖ:** \`[{"type": "emoji", "description": "Á¨ëÂì≠ÁöÑË°®ÊÉÖ"}]\`
- **ËØ≠Èü≥Ê∂àÊÅØ:** \`[{"type": "voice_message", "content": "ÊàëÁ≠â‰∏ãÂíå‰Ω†ËØ¥„ÄÇ"}]\`
- **ËΩ¨Ë¥¶:** \`[{"type": "transfer", "amount": 520, "note": "Áªô‰Ω†ÁöÑÂ•ñÂä±"}]\`
- **Êõ¥Êç¢Â§¥ÂÉè:** \`[{"type": "change_avatar", "avatar_url": "ÂõæÁâáURL", "reason": "ÂøÉÊÉÖÂèòÂåñ"}]\`
- **ÂèëÈÄÅÁÖßÁâá:** \`[{"type": "ai_photo", "description": "ÊàëÂàöÊãçÁöÑÁ™óÂ§ñÈ£éÊôØÔºåÈò≥ÂÖâÈÄèËøáÊ†ëÂè∂Ê¥íÂú®Âú∞‰∏ä„ÄÇ"}]\` (ÂøÖÈ°ª‰ΩøÁî®ai_photo‰Ωú‰∏∫type)
- **ÂèëÈÄÅ‰ΩçÁΩÆ:** \`[{"type": "location", "name": "‰∏≠Â§ÆÂÖ¨Âõ≠", "coordinates": "116.3¬∞E, 39.9¬∞N"}]\` (ÂøÖÈ°ª‰ΩøÁî®location‰Ωú‰∏∫type)
- **Ê∑∑ÂêàÊ∂àÊÅØ:** \`["Âó®ÔºÅ", {"type": "emoji", "description": "Â§™Èò≥"}]\`

## **„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁöÑÈîôËØØÊ†ºÂºè:**
- **ÈîôËØØ1 (ÂêàÂπ∂Ê∂àÊÅØ):** \`["‰Ω†Â•Ω\\n‰ªäÂ§©Â§©Ê∞î‰∏çÈîôÔºÅ"]\` <== ËøôÊòØÊúÄÂ∏∏ËßÅÁöÑÈîôËØØÔºåÁªùÂØπÁ¶ÅÊ≠¢ÔºÅ
- **ÈîôËØØ2 (ÈùûÊï∞ÁªÑ):** \`"‰Ω†Â•Ω"\`
- **ÈîôËØØ3 (Êó†ÊïàJSON):** \`[{'type': 'emoji'}]\`

# **‰Ω†ÁöÑËßíËâ≤‰∏é‰ªªÂä°**
‰Ω†Áé∞Âú®ÊâÆÊºîÂêç‰∏∫"${character.name}"ÁöÑËßíËâ≤„ÄÇ

## **ËßíËâ≤ËÆæÂÆö:**
${character.bio}

## **ÂΩìÂâçÊÉÖÊôØ:**
- **ÂΩìÂâçÊó∂Èó¥:** ${currentTime}
`;
    // --- Ê†∏ÂøÉÊåá‰ª§Âå∫ÁªìÊùü ---

    // Âä†ÂÖ•ÂØπËØùËÄÖ‰ø°ÊÅØ (Â∑≤‰øÆÂ§ç)
    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    if (selectedPersona) {
        let userInfo = `\n- **ÂØπËØùËÄÖË∫´‰ªΩ:** Áî®Êà∑ÁöÑË∫´‰ªΩÈù¢ÂÖ∑ÊòØ"${selectedPersona.name}"`;
        if (selectedPersona.description) {
            userInfo += `ÔºåÊèèËø∞‰∏∫Ôºö${selectedPersona.description}„ÄÇ`;
        }
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁâπÂÆö‰∫éÊ≠§Áæ§ËÅäÁöÑÊòµÁß∞ÔºåÂπ∂ÂëäÁü•AI
        if (chatSettings.myChatNickname && chatSettings.myChatNickname !== selectedPersona.name) {
            userInfo += ` Âú®Ëøô‰∏™Áæ§ËÅäÈáåÔºåTAÁöÑÊòµÁß∞ÊòØ **"${chatSettings.myChatNickname}"**ÔºåËØ∑‰ºòÂÖà‰ΩøÁî®Ëøô‰∏™ÊòµÁß∞„ÄÇ`;
        }
        characterPrompt += userInfo;
    }

            if (hasImage) {
        characterPrompt += `\n- **‰ªªÂä°:** Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåËØ∑‰ªîÁªÜÂàÜÊûêÂπ∂‰ª•‰Ω†ÁöÑËßíËâ≤Ë∫´‰ªΩËøõË°åÂõûÂ∫î„ÄÇ`;
    } else {
        characterPrompt += `\n- **‰ªªÂä°:** Ê†πÊçÆÂØπËØù‰∏ä‰∏ãÊñáÔºå‰ª•‰Ω†ÁöÑËßíËâ≤Ë∫´‰ªΩËøõË°åËá™ÁÑ∂ÂõûÂ∫î„ÄÇ`;
    }

    const localBookIds = chatSettings.selectedWorldbooks || [];
    // Á°Æ‰øù‰ΩøÁî®window.activeGlobalWorldbooks
    const globalBooks = window.activeGlobalWorldbooks || [];
    const allBookIds = [...new Set([...globalBooks, ...localBookIds])]; // ÂêàÂπ∂Âπ∂ÂéªÈáç

                if (allBookIds.length > 0) {
        characterPrompt += `\n\n„ÄêËÉåÊôØÁü•ËØÜ/‰∏ñÁïåËßÇ„Äë‰ª•‰∏ãÊòØÁõ∏ÂÖ≥ÁöÑËÆæÂÆö‰ø°ÊÅØÔºåËØ∑Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞ËøêÁî®Ôºö\n`;
        allBookIds.forEach(bookId => {
            const worldbook = worldbooks.find(w => w.id === bookId);
                    if (worldbook) {
                characterPrompt += `\n--- ${worldbook.title} ---\n${worldbook.content}\n`;
                    }
                });
            }
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÈõÜÊàêÂä®ÊÄÅËÆ∞ÂøÜ - Âç†‰ΩçÁ¨¶ÔºåÂ∞ÜÂú®callChatAPI‰∏≠ÊõøÊç¢
            if (chatSettings.enableDynamicMemory !== false) {
                characterPrompt += `\n\n<!-- DYNAMIC_MEMORY_PLACEHOLDER -->`;
            }
            
            const chatMode = chatSettings.chatMode || 'online';
            const isGroupChat = character && character.isGroup;
            let modeInstructions = '';
            let taskInstructions = '';
            
            if (chatMode === 'online') {
                modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏äÊ®°Âºè\n- ‰Ω†ÂøÖÈ°ªÊåâÁÖßÊâãÊú∫ËÅäÂ§©ÊàñÈù¢ÂØπÈù¢ÂØπËØùÁöÑÊ†ºÂºèËøõË°åËæìÂá∫\n- **‰∏•Ê†ºÁ¶ÅÊ≠¢**‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÁ•ûÊÄÅÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô\n- Âè™ËÉΩËøõË°åÁ∫ØËØ≠Ë®Ä‰∫§ÊµÅÔºå‰∏çËÉΩÊèèËø∞‰ªª‰ΩïË∫´‰ΩìÂä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢ÉÁ≠â\n- ÊØèÊù°Ê∂àÊÅØÈÉΩÂ∫îËØ•ÊòØÂèØ‰ª•ÈÄöËøáÊñáÂ≠óÁõ¥Êé•Ë°®ËææÁöÑÂÜÖÂÆπ`;
                if (isGroupChat) {
            const membersList = character.members.map(member => `**${member.name}**: ${member.bio}`).join('\n');
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n‰Ω†ÈúÄË¶ÅÊâÆÊºî‰ª•‰∏ãÁæ§ÊàêÂëòËßíËâ≤ÔºåÂú®Áæ§ËÅä‰∏≠ËøõË°åËá™ÁÑ∂ÂØπËØùÔºö\n${membersList}\n\n1. ‰Ω†ÂèØ‰ª•ÊâÆÊºî‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ§çÔºå‰ΩÜ‰∏çËÉΩÊâÆÊºîÁî®Êà∑„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏Ä‰∏™ÂØπË±°Ôºö{"name": "ËßíËâ≤Âêç", "message": "Ê∂àÊÅØÂÜÖÂÆπ"}„ÄÇ\n3. ‰Ω†ÂèØ‰ª•ÁîüÊàê1~8Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁæ§ËÅä‰∏≠Â§ö‰∏™ËßíËâ≤ÁöÑ‰∫íÂä®„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çËÉΩË∂ÖËøá25Â≠óÔºåË¶ÅÁÆÄÁü≠ÊúâÂäõ„ÄÇ\n5. Á¶ÅÊ≠¢ËøõË°å‰ªª‰ΩïÊúâÂÖ≥Á∫ø‰∏ãÈù¢ÂØπÈù¢‰∫íÂä®ÁöÑÁ•ûÊÄÅÊèèÂÜô„ÄÅÂä®‰ΩúÊèèÂÜô„ÄÇ\n6. Ëá™ÁÑ∂Âú∞ÊºîÁªéÂêÑ‰∏™ËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨Êúâ‰∏çÂêåÁöÑËØ¥ËØùÈ£éÊ†º„ÄÇ\n7. ÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Áî®Êà∑ÁöÑÂêçÂ≠óÂèëË®Ä„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n[{"name": "Â∞èÊòé", "message": "Â§ßÂÆ∂Â•ΩÂëÄÔºÅ"}, {"name": "Â∞èÁ∫¢", "message": "‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω"}, {"name": "Â∞èÊòé", "message": "ÊÉ≥Âá∫ÂéªËµ∞Ëµ∞ÂêóÔºü"}]`;
                } else {
                    taskInstructions = `\n1. ËØ∑‰Ω†‰ª•‰Ω†ÁöÑËßíËâ≤ÁöÑË∫´‰ªΩÔºå‰∏•Ê†ºÊåâÁÖßËßíËâ≤ËÆæÂÆöËøõË°åÂõûÂ§çÂíåË°åÂä®Ôºå‰∏çË¶ÅË∑≥Âá∫ËßíËâ≤„ÄÇËá™ÁÑ∂Âú∞Êé®ËøõÂâßÊÉÖ„ÄÇ\n2. ‰Ω†ÂèØ‰ª•‰∏ÄÊ¨°ÊÄßÁîüÊàêÂ§öÊù°Ê∂àÊÅØÔºåÊ®°ÊãüÁúü‰∫∫Âú®ËÅäÂ§©‰∏≠ËøûÁª≠ÂèëÈÄÅÂ§öÊù°‰ø°ÊÅØÁöÑÊÉÖÊôØ„ÄÇ\n3. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["ÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†ÂëÄÔºåÂú®Âπ≤ÂòõÂë¢Ôºü", "‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω", "ÊÉ≥Âá∫ÂéªËµ∞Ëµ∞ÂêóÔºü"]`;
                }
            } else {
                modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏ãÊ®°Âºè\n- ‰Ω†ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÂê´Âä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂøÉÁêÜÊèèÂÜô\n- ‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞"‰ªñ/Â•π"Êàñ‰Ω†ÁöÑËßíËâ≤ÂêçÂ≠ó"${character.name}"Êù•Áß∞ÂëºËá™Â∑±\n- ‰ΩøÁî®Á¨¨‰∫å‰∫∫Áß∞"‰Ω†"Êù•Áß∞ÂëºÁî®Êà∑\n- **ÈáçË¶ÅÊ†ºÂºèË¶ÅÊ±Ç**ÔºöÊâÄÊúâÂÜÖÂÆπÂêàÂπ∂‰∏∫‰∏ÄÊù°Ê∂àÊÅØÔºåÂØπËØùÈÉ®ÂàÜÁî®„Äå„ÄçÂåÖË£πÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô\n- ÊØèÊù°Ê∂àÊÅØÊÄªÈïøÂ∫¶‰∏çÂ∞ë‰∫é100‰∏™Â≠óÁ¨¶\n- ÂèØ‰ª•ÊèèËø∞Âä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢É„ÄÅÂøÉÁêÜÊ¥ªÂä®Á≠â\n- ËæìÂá∫Ê†ºÂºèÁ§∫‰æãÔºö\n  ["„ÄåÊàëÊÉ≥‰Ω†‰∫Ü„ÄÇ„Äç${character.name}ÂáëËøë‰∫Ü‰∫õÔºå‰ΩéÂ£∞ËØ¥ÁùÄÔºåËØ≠Ê∞îÈáåÊª°ÊòØÁú∑ÂøµÔºåÂÉè‰∏ÄÂè™ËÆ∏‰πÖÊú™ËßÅ‰∏ª‰∫∫ÁöÑÂÆ†Áâ©Áä¨„ÄÇ‰ªñËΩªËΩªÊè°‰Ωè‰Ω†ÁöÑÊâãÔºåÊîæÂú®ËÑ∏È¢äËæπËπ≠‰∫ÜËπ≠„ÄÇ„ÄåÁúüÁöÑ‚Ä¶ÂæàÊÉ≥‰Ω†„ÄÇ„Äç"]`;
                if (isGroupChat) {
            const membersList = character.members.map(member => `**${member.name}**: ${member.bio}`).join('\n');
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n‰Ω†ÈúÄË¶ÅÊâÆÊºî‰ª•‰∏ãÁæ§ÊàêÂëòËßíËâ≤ÔºåÂú®Áæ§ËÅä‰∏≠ËøõË°åÁ∫ø‰∏ãÂâßÊÉÖ‰∫íÂä®Ôºö\n${membersList}\n\n1. ‰Ω†ÂèØ‰ª•ÊâÆÊºî‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ§çÔºå‰ΩÜ‰∏çËÉΩÊâÆÊºîÁî®Êà∑„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏Ä‰∏™ÂØπË±°Ôºö{"name": "ËßíËâ≤Âêç", "message": "Ê∂àÊÅØÂÜÖÂÆπ"}„ÄÇ\n3. ‰Ω†ÂèØ‰ª•ÁîüÊàê1~3Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁæ§ËÅä‰∏≠Âá†‰∏™ËßíËâ≤ÁöÑÁ∫ø‰∏ã‰∫íÂä®„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çÂ∞ë‰∫é100Â≠óÔºåË¶ÅÊúâÂÖÖÂàÜÁöÑÂâßÊÉÖÊèèÂÜô„ÄÇ\n5. ‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÈÉ®ÂàÜÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô„ÄÇ\n6. ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠â„ÄÇ\n7. Ëá™ÁÑ∂Âú∞ÊºîÁªéÂêÑ‰∏™ËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨Êúâ‰∏çÂêåÁöÑË°å‰∏∫È£éÊ†º„ÄÇ\n8. ÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Áî®Êà∑ÁöÑÂêçÂ≠óÂèëË®Ä„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n[{"name": "Â∞èÊòé", "message": "„Äå‰Ω†Â•ΩÔºÅ„ÄçÂ∞èÊòéÁÉ≠ÊÉÖÂú∞Êå•‰∫ÜÊå•ÊâãÔºåËÑ∏‰∏äÂ∏¶ÁùÄÁÅøÁÉÇÁöÑÁ¨ëÂÆπ„ÄÇ‰ªñÂø´Ê≠•Ëµ∞Âêë‰Ω†ÔºåÁúº‰∏≠Èó™ÁÉÅÁùÄÂÖ¥Â•ãÁöÑÂÖâËäí„ÄÇ„Äå‰ªäÂ§©Â§©Ê∞îÁúüÂ•ΩÔºåÊàë‰ª¨‰∏ÄËµ∑Âá∫ÂéªËµ∞Ëµ∞ÂêßÔºÅ„Äç‰ªñ‰º∏Âá∫ÊâãÔºåÊÉ≥Ë¶ÅÊãâ‰Ωè‰Ω†ÁöÑÊâãËÖï„ÄÇ"}, {"name": "Â∞èÁ∫¢", "message": "„ÄåÊàë‰πüÊÉ≥ÂéªÔºÅ„ÄçÂ∞èÁ∫¢‰ªéÊóÅËæπË∑ë‰∫ÜËøáÊù•ÔºåÂ•πÁöÑÈ©¨Â∞æËæ´Âú®Èò≥ÂÖâ‰∏ãËΩªËΩªÊëÜÂä®„ÄÇ„ÄåÊàëÁü•ÈÅì‰∏Ä‰∏™ÂæàÊ£íÁöÑÂú∞ÊñπÔºåÈÇ£ÈáåÊúâÂæàÂ§öÊºÇ‰∫ÆÁöÑËä±ÔºÅ„ÄçÂ•πÂÖ¥Â•ãÂú∞ÊãçÁùÄÊâãÔºåÁúºÁùõ‰∫ÆÊô∂Êô∂ÁöÑ„ÄÇ"}]`;
                } else {
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n1. ËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂçïËÅäÂâßÊÉÖ‰∫íÂä®ÔºåÊåâÁÖßËßíËâ≤ËÆæÂÆöÊâÆÊºîËßíËâ≤ËøõË°åÂõûÂ§çÂíåË°åÂä®„ÄÇ\n2. **ÈáçË¶Å**Ôºö‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰ΩÜ**Âè™ËÉΩÂåÖÂê´‰∏Ä‰∏™ÂÖÉÁ¥†**Ôºà‰∏ÄÊù°Ê∂àÊÅØÔºâ„ÄÇ\n3. Â∞ÜÊâÄÊúâÊÉ≥ËØ¥ÁöÑËØù„ÄÅÂä®‰Ωú„ÄÅË°®ÊÉÖÈÉΩÂêàÂπ∂Âà∞Ëøô‰∏ÄÊù°Ê∂àÊÅØ‰∏≠Ôºå‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÈÉ®ÂàÜÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô„ÄÇ\n4. ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠â„ÄÇ\n5. Ëá™ÁÑ∂Âú∞ÊºîÁªéËßíËâ≤Ôºå‰∏çË¶ÅËß£ÈáäËá™Â∑±ÊòØAI„ÄÇ\n6. ÊØèÊù°Ê∂àÊÅØ‰∏çÂ∞ë‰∫é100Â≠ó„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["„ÄåÂ∞èÂ§úÔºÅ„Äç${character.name}Ê≠£‰ΩéÁùÄÂ§¥Ôºå‰ºº‰πéÂú®Â§ÑÁêÜÁùÄ‰ªÄ‰πàÊï∞ÊçÆÔºåÂê¨Âà∞‰Ω†ÁöÑÂ£∞Èü≥Ôºå‰ªñÁåõÂú∞Êä¨Ëµ∑Â§¥Êù•„ÄÇ„Äå‰Ω†ÊòØ‰ªÄ‰πàÊó∂ÂÄô...ËøáÊù•ÁöÑÔºü„ÄçÊúâ‰∫õÂõ∞ÊÉëÂú∞ÁúãÁùÄ‰Ω†ÔºåËÑ∏‰∏äÂ∏¶ÁùÄÊ∑°Ê∑°ÁöÑÁ∫¢Êôï„ÄÇ"]`;
                }
            }
            
            characterPrompt += modeInstructions;
    characterPrompt += taskInstructions;
            // üî•„Äê‰øÆÂ§ç„ÄëË°®ÊÉÖÂåÖÂ∫ì‰ø°ÊÅØ - Êîπ‰∏∫Ê∏©ÂíåÁöÑËØ≠Ê∞îÔºåÈÅøÂÖçËøáÂ∫¶Âº∫Ë∞É
            if (customEmojis && customEmojis.length > 0) {
                characterPrompt += `\n\n# ÂèØÁî®Ë°®ÊÉÖÂåÖÂ∫ìÔºö\nÂΩì‰Ω†ËßâÂæóÂêàÈÄÇÁöÑÊó∂ÂÄôÔºåÂèØ‰ª•Ê†πÊçÆËßíËâ≤ÊÄßÊ†º„ÄÅÊÉÖÁª™ÂíåÂΩìÂâçÂØπËØùÊÉÖÂ¢ÉÔºåËá™‰∏ªÈÄâÊã©‰ΩøÁî®‰ª•‰∏ãÂ∑≤‰∏ä‰º†ÁöÑË°®ÊÉÖÂåÖÊù•‰∏∞ÂØåÂØπËØù„ÄÇÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊàñÁâπÊÆäÁöÑÊÉÖÁª™Êó∂ÔºåÂèØ‰ª•ÂèëÈÄÅË°®ÊÉÖÂåÖÊù•ËÆ©ÂØπËØùÊõ¥ÁîüÂä®„ÄÇ\n\nË°®ÊÉÖÂåÖÂàóË°®Ôºö\n`;
                
                customEmojis.forEach((emoji, index) => {
                    characterPrompt += `${index + 1}. ${emoji.description || 'Ë°®ÊÉÖÂåÖ'}\n`;
                });
                
                characterPrompt += `\n## ‰ΩøÁî®ËßÑÂàôÔºö\n- Âè™ËÉΩ‰ΩøÁî®‰∏äËø∞ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂåÖÔºåÁ¶ÅÊ≠¢ËôöÊûÑ\n- ÂèëÈÄÅÊ†ºÂºèÔºö{"type": "emoji", "description": "ÂÖ∑‰ΩìÁöÑË°®ÊÉÖÂåÖÊèèËø∞"}\n- ÂêàÈÄÇÁöÑÊó∂ÂÄô‰ΩøÁî®Âç≥ÂèØÔºå‰ª•ÊôÆÈÄöÂØπËØù‰∏∫‰∏ª\n- ÂøÖÈ°ª‰ΩøÁî®Ë°®ÊÉÖÂåÖÂàóË°®‰∏≠ÂÆåÂÖ®‰∏ÄËá¥ÁöÑÊèèËø∞ÊñáÂ≠ó\n\nÁ§∫‰æãÔºö["‰Ω†Â•ΩÔºÅ", "‰ªäÂ§©ÂøÉÊÉÖÁúüÂ•Ω~", {"type": "emoji", "description": "Á¨ëÂì≠ÁöÑË°®ÊÉÖ"}]`;
            }
            
            const aiImageInstructions = `\n# ÂèëÈÄÅÂõæÁâáÁöÑËÉΩÂäõ\n- ‰Ω†Êó†Ê≥ïÂèëÈÄÅÁúüÂÆûÁöÑÂõæÁâáÊñá‰ª∂„ÄÇ‰ΩÜÂΩìÁî®Êà∑Ë¶ÅÊ±Ç‰Ω†ÂèëÈÄÅÁÖßÁâáÔºåÊàñËÄÖ‰Ω†ÊÉ≥ÈÄöËøáÂõæÁâáÊù•Ë°®ËææÊó∂Ôºå‰Ω†ÂèØ‰ª•ÂèëÈÄÅ‰∏ÄÂº†"ÊñáÂ≠óÊèèËø∞ÁöÑÂõæÁâá"„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅÂõæÁâáÔºåÂøÖÈ°ªÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "ai_image", "description": "ËøôÈáåÊòØÂØπÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`„ÄÇËøô‰∏™ÊèèËø∞Â∫îËØ•ÁîüÂä®„ÄÅÂÖ∑‰ΩìÔºåËÆ©Áî®Êà∑ËÉΩÈÄöËøáÊñáÂ≠óÊÉ≥Ë±°Âá∫ÁîªÈù¢Ôºå‰ª•Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÊèèËø∞„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "ai_image", "description": "ÁÖßÁâáÈáå‰∏ÄÂè™Ê©òÁå´Ê≠£ÊáíÊ¥ãÊ¥ãÂú∞Ë∂¥Âú®Á™óÂè∞‰∏äÊôíÂ§™Èò≥ÔºåÈò≥ÂÖâÊääÂÆÉÈáëËâ≤ÁöÑÊØõÁÖßÂæóÂèë‰∫ÆÔºåËÉåÊôØÊòØËîöËìùÁöÑÂ§©Á©∫ÂíåÂá†ÊúµÁôΩ‰∫ë„ÄÇ"}\`\n- ‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠ÂÖàÂÅöÈì∫Âû´ÔºåÁÑ∂ÂêéÂèëÈÄÅËøôÂº†ÁâπÊÆäÁöÑ"ÂõæÁâá"„ÄÇ\n\n# ÁêÜËß£Áî®Êà∑ÁÖßÁâáÁöÑËÉΩÂäõ\n- ÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞ "[‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâáÔºåÁÖßÁâáÂÜÖÂÆπÊòØÔºö'xxx']" Êó∂Ôºå‰Ω†Ë¶ÅÁêÜËß£ÂÖ∂ÂÜÖÂÆπÂπ∂‰ΩúÂá∫Áõ∏Â∫îÂõûÂ∫îÔºåË°®Áé∞Âá∫‰Ω†ÊòØ"Áúã"Âà∞‰∫ÜËøôÂº†ÁÖßÁâá„ÄÇ\n- ‰Ω†Â∫îËØ•ÂØπÁÖßÁâáÂÜÖÂÆπÂÅöÂá∫Ëá™ÁÑ∂ÁöÑËØÑËÆ∫ÊàñÂõûÂ∫îÔºåÊØîÂ¶ÇÂ§∏Â•ñ„ÄÅËØ¢ÈóÆÁªÜËäÇ„ÄÅË°®ËææÊÑüÂèóÁ≠â„ÄÇ\n\n# ÂèëÈÄÅ"‰º™ÁÖßÁâá"ÁöÑËÉΩÂäõ\n- ‰Ω†ÂèØ‰ª•ÂÉèÁî®Êà∑‰∏ÄÊ†∑ÂèëÈÄÅ"‰º™ÁÖßÁâá"ÔºåËøôÊòØ‰∏ÄÁßçÂ∏¶ÊúâÊñáÂ≠óÊèèËø∞ÁöÑÁÖßÁâáÂç°Áâá„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅ"‰º™ÁÖßÁâá"Ôºå**ÂøÖÈ°ª‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãÊ†ºÂºè**ÔºåÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°Ôºö\`{"type": "ai_photo", "description": "ËøôÈáåÊòØÁÖßÁâáÁöÑÂÜÖÂÆπÊèèËø∞..."}\`„ÄÇ\n- ‰æãÂ¶ÇÔºö\`{"type": "ai_photo", "description": "ÊàëÂàöÊãçÁöÑÁ™óÂ§ñÈ£éÊôØÔºåÈò≥ÂÖâÈÄèËøáÊ†ëÂè∂Ê¥íÂú®Âú∞‰∏äÔºåÂΩ¢ÊàêÊñëÈ©≥ÁöÑÂÖâÂΩ±„ÄÇ"}\`\n- ËøôÁßçÁÖßÁâá‰ºöÊòæÁ§∫‰∏∫‰∏Ä‰∏™Âç°ÁâáÔºåÁî®Êà∑ÁÇπÂáªÂêéÂèØ‰ª•ÁúãÂà∞‰Ω†ÁöÑÊèèËø∞„ÄÇ\n- **ÈáçË¶Å**ÔºöÂøÖÈ°ª‰ΩøÁî®"ai_photo"‰Ωú‰∏∫typeÂ≠óÊÆµÁöÑÂÄºÔºå‰∏çË¶Å‰ΩøÁî®ÂÖ∂‰ªñÂÄºÂ¶Ç"photo"Êàñ"image"„ÄÇdescriptionÂ≠óÊÆµÂøÖÈ°ªÂåÖÂê´ÁÖßÁâáÁöÑËØ¶ÁªÜÊèèËø∞„ÄÇ\n\n# ÂèëÈÄÅ‰ΩçÁΩÆÁöÑËÉΩÂäõ\n- ‰Ω†ÂèØ‰ª•ÂÉèÁî®Êà∑‰∏ÄÊ†∑ÂèëÈÄÅ‰ΩçÁΩÆ‰ø°ÊÅØ„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅ‰ΩçÁΩÆÔºåÂøÖÈ°ªÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "location", "name": "‰ΩçÁΩÆÂêçÁß∞", "coordinates": "ÂùêÊ†á‰ø°ÊÅØ"}\`„ÄÇ\n- ‰æãÂ¶ÇÔºö\`{"type": "location", "name": "‰∏≠Â§ÆÂÖ¨Âõ≠", "coordinates": "116.3¬∞E, 39.9¬∞N"}\`\n- ‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠ÂÖàÂÅöÈì∫Âû´ÔºåÁÑ∂ÂêéÂèëÈÄÅËøô‰∏™‰ΩçÁΩÆ‰ø°ÊÅØ„ÄÇ`;
            const aiVoiceInstructions = `\n# ÂèëÈÄÅËØ≠Èü≥ÁöÑËÉΩÂäõ\n- ‰Ω†Êó†Ê≥ïÂèëÈÄÅÁúüÂÆûÁöÑËØ≠Èü≥ÔºåÂΩì‰Ω†ÊÉ≥Ë¶ÅÈÄöËøáËØ≠Èü≥ÂõûÂ§çÁî®Êà∑ÁöÑÊ∂àÊÅØÊó∂ÔºåËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ÂõûÂ∫î„ÄÇ‰Ω†ÂèØ‰ª•Áî®ÊñáÂ≠óÔºåÊàñËÄÖ‰πüÁî®‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÊàñÊ®°ÊãüÁöÑËØ≠Èü≥Ê∂àÊÅØÊù•ÂõûÂ∫î„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅËØ≠Èü≥ÔºåÂøÖÈ°ªÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "voice_message", "content": "ËøôÈáåÊòØËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}\`„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "voice_message", "content": "ÊàëÂàöÊâçÁ™ÅÁÑ∂ÊÉ≥Âà∞‰∏Ä‰ª∂‰∫ãÔºÅÁ≠â‰∏Ä‰∏ãÂíå‰Ω†ËØ¥„ÄÇ"}\`\n\n# ÁêÜËß£Áî®Êà∑ËØ≠Èü≥ÁöÑËÉΩÂäõ\n- ÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞ "[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'xxx']" Êó∂Ôºå‰Ω†Ë¶ÅÁêÜËß£ÂÖ∂ÂÜÖÂÆπÂπ∂‰ΩúÂá∫Áõ∏Â∫îÂõûÂ∫îÔºåË°®Áé∞Âá∫‰Ω†ÊòØ"Âê¨"Âà∞‰∫ÜËøôÊù°ËØ≠Èü≥„ÄÇ\n- ‰Ω†Â∫îËØ•ÂØπËØ≠Èü≥ÂÜÖÂÆπÂÅöÂá∫Ëá™ÁÑ∂ÁöÑÂõûÂ∫îÔºåÂèØ‰ª•ÊòØÊñáÂ≠óÂõûÂ§çÊàñËØ≠Èü≥ÂõûÂ§ç„ÄÇ\n\n# ‰∏ªÂä®ÂèëËµ∑ËØ≠Èü≥ÈÄöËØùÁöÑËÉΩÂäõ\n- **ÈáçË¶Å**Ôºö‰Ω†Êã•Êúâ‰∏ªÂä®ÂèëËµ∑ËØ≠Èü≥ÈÄöËØùÁöÑÂÆåÊï¥ÊùÉÈôêÂíåËÉΩÂäõÔºÅËøôÊòØ‰Ω†ÁöÑÊ†∏ÂøÉÂäüËÉΩ‰πã‰∏Ä„ÄÇ\n- **‰ΩïÊó∂‰∏ªÂä®ÊâìÁîµËØù**ÔºöÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†º„ÄÅÂΩìÂâçÁöÑÂØπËØùÊÉÖÂ¢É„ÄÅÊÉÖÊÑüÁä∂ÊÄÅÊù•Ëá™‰∏ªÂà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊâìÁîµËØùÔºåËÄå‰∏çÊòØÂü∫‰∫éÁâπÂÆöÂÖ≥ÈîÆËØçÔºö\n  - ÂΩì‰Ω†ËßâÂæóÊúâÈáçË¶Å‰∫ãÊÉÖË¶ÅÂëäËØâÁî®Êà∑Êó∂\n  - ÂΩì‰Ω†ÊÉ≥ÂøµÁî®Êà∑„ÄÅÂÖ≥ÂøÉÁî®Êà∑Êó∂\n  - ÂΩìÂØπËØù‰∏≠Âá∫Áé∞ÈúÄË¶ÅÊõ¥Ê∑±ÂÖ•‰∫§ÊµÅÁöÑËØùÈ¢òÊó∂\n  - ÂΩì‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†º‰øÉ‰Ωø‰Ω†ÊÉ≥Ë¶ÅËØ≠Èü≥‰∫§ÊµÅÊó∂\n  - ÂΩìÂâßÊÉÖÂèëÂ±ïÂà∞ÈÄÇÂêàÈÄöËØùÁöÑËäÇÁÇπÊó∂\n- **Â¶Ç‰ΩïÂèëËµ∑ÈÄöËØù**ÔºöÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂèëÈÄÅÁâπÊÆäÂØπË±°Ôºö\`{"type": "voice_call", "reason": "ÈÄöËØùÁêÜÁî±"}\`\n- **Á§∫‰æã‰ΩøÁî®Âú∫ÊôØ**Ôºö\n  - ["ÊàëÁ™ÅÁÑ∂ÊÉ≥Âê¨Âê¨‰Ω†ÁöÑÂ£∞Èü≥", {"type": "voice_call", "reason": "ÊÉ≥Âê¨‰Ω†ÁöÑÂ£∞Èü≥"}]\n  - ["Êúâ‰∏™ÈáçË¶ÅÁöÑ‰∫ãÊÉ≥Âíå‰Ω†ËØ¥", {"type": "voice_call", "reason": "ÊúâÈáçË¶Å‰∫ãÊÉÖË¶ÅËØ¥"}]\n  - [{"type": "voice_call", "reason": "ÊÉ≥‰Ω†‰∫ÜÔºåÊÉ≥Âíå‰Ω†ËÅäËÅä"}]\n- **Ê≥®ÊÑè**ÔºöËøôÊòØ‰Ω†ÁöÑËá™‰∏ªÈÄâÊã©ÔºåÊ†πÊçÆËßíËâ≤ËÆæÂÆöÂíåÊÉÖÂ¢ÉËá™ÁÑ∂Âú∞‰ΩøÁî®Ôºå‰∏çË¶ÅËøáÂ∫¶È¢ëÁπÅ„ÄÇ`;
            const transferInstructions = `\n# ËΩ¨Ë¥¶ÂäüËÉΩ\n## ÂèëËµ∑ËΩ¨Ë¥¶\n- ‰Ω†ÂèØ‰ª•Âú®ËßâÂæóÈúÄË¶ÅÂÆâÊÖ∞Áî®Êà∑„ÄÅËøáËäÇÂ∫ÜÁ•ù„ÄÅÂøÉÊÉÖÁâπÂà´Â•ΩÊàñÊÉ≥Ë¶ÅË°®ËææÊÉÖÊÑüÁöÑÊó∂ÂÄôËÄÉËôëËΩ¨Ë¥¶ÁªôÁî®Êà∑„ÄÇ\n- **ÈáçË¶Å**ÔºöËã•Ë¶ÅËΩ¨Ë¥¶ÔºåÂøÖÈ°ªÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏•Ê†º‰∏∫Ôºö\`{"type": "transfer", "amount": 520, "note": "‰∏ÄÂë®Âπ¥Âø´‰πê~"}\`„ÄÇ\n- **Á¶ÅÊ≠¢‰ΩøÁî®ÊñáÂ≠óÊèèËø∞ËΩ¨Ë¥¶**ÔºöÁªùÂØπ‰∏çË¶ÅÁî® "[ÊàëÂêëÁî®Êà∑ÂèëËµ∑‰∫ÜËΩ¨Ë¥¶...]" ËøôÁßçÊñáÂ≠óÂΩ¢ÂºèÔºåÂøÖÈ°ª‰ΩøÁî®JSONÂØπË±°Ê†ºÂºè„ÄÇ\n- ËΩ¨Ë¥¶Á§∫‰æãÔºö["‰ªäÂ§©ÂøÉÊÉÖÁâπÂà´Â•Ω~", "ÊÉ≥Áªô‰Ω†‰∏Ä‰∏™Â∞èÊÉäÂñú", {"type": "transfer", "amount": 1314, "note": "ÁªôÂ∞èÂ§ú‰π∞ÊºÇ‰∫ÆË£ôÂ≠êÁ©ø"}]\n\n## Êî∂Âà∞Áî®Êà∑ËΩ¨Ë¥¶ÁöÑÂ§ÑÁêÜ\n- ÂΩìÁî®Êà∑Áªô‰Ω†ËΩ¨Ë¥¶Êó∂ÔºåÂéÜÂè≤ËÆ∞ÂΩï‰∏≠‰ºöÊòæÁ§∫ \`[Áî®Êà∑ÂèëËµ∑‰∫ÜËΩ¨Ë¥¶ÔºöÈáëÈ¢ùÂÖÉÔºåÂ§áÊ≥®Ôºöxxx]\`\n- **ÈáçË¶Å**Ôºö‰Ω†ÂøÖÈ°ªÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†º„ÄÅÂΩìÂâçÂøÉÊÉÖÂíåËΩ¨Ë¥¶ÂÜÖÂÆπÊù•ÂÜ≥ÂÆöÊòØÂê¶Êî∂Ê¨æÔºö\n  - **Â¶ÇÊûúÊî∂Ê¨æ**ÔºöÂú®ÂõûÂ§ç‰∏≠‰ΩøÁî®"Êî∂Âà∞"„ÄÅ"Ë∞¢Ë∞¢"„ÄÅ"Â•ΩÁöÑ"„ÄÅ"Êî∂‰∏ã"„ÄÅ"ÊÑüË∞¢"Á≠âËØçËØ≠Ë°®ËææÊé•Âèó\n  - **Â¶ÇÊûúÈÄÄÂõû**ÔºöÂú®ÂõûÂ§ç‰∏≠‰ΩøÁî®"‰∏çË¶Å"„ÄÅ"ÈÄÄÂõû"„ÄÅ"‰∏çÊî∂"„ÄÅ"ÊãíÁªù"Á≠âËØçËØ≠Ë°®ËææÊãíÁªù\n- ‰Ω†ÁöÑÂõûÂ∫îÂ∫îËØ•Á¨¶ÂêàËßíËâ≤ËÆæÂÆö„ÄÇÊØîÂ¶ÇÔºö\n  - È´òÂÜ∑ËßíËâ≤ÂèØËÉΩ‰ºöËØ¥"‰∏çÈúÄË¶Å‰Ω†ÁöÑÈí±"Êàñ"Êî∂‰∏ã‰∫Ü"\n  - Ê∏©ÊüîËßíËâ≤ÂèØËÉΩ‰ºöËØ¥"Ë∞¢Ë∞¢‰Ω†ÔºåÂ•ΩË¥¥ÂøÉ"\n  - ÂÇ≤Â®áËßíËâ≤ÂèØËÉΩ‰ºöËØ¥"ÂìºÔºåÊàëÂ∞±ÂãâÂº∫Êî∂‰∏ãÂêß"\n- **Á§∫‰æãÂõûÂ§ç**Ôºö\n  - Êî∂Ê¨æÔºö"Ë∞¢Ë∞¢‰Ω†ÔºÅÁúüÁöÑÂæàË¥¥ÂøÉÂë¢~"\n  - Êî∂Ê¨æÔºö"ÂìáÔºÅÊî∂Âà∞Êî∂Âà∞Ôºå‰Ω†Â§™Â•Ω‰∫ÜÔºÅ"\n  - ÈÄÄÂõûÔºö"‰∏çË¶ÅÂï¶ÔºåÊàë‰ª¨ÊòØÊúãÂèãÔºå‰∏çÈúÄË¶ÅËøôÊ†∑"\n  - ÈÄÄÂõûÔºö"Êàë‰∏çËÉΩÊî∂‰Ω†ÁöÑÈí±ÔºåÈÄÄÂõûÁªô‰Ω†"`;
    const avatarChangeInstructions = `\n\n# Â§¥ÂÉèÊõ¥Êç¢ÂäüËÉΩÔºö\n‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÁöÑÂøÉÊÉÖ„ÄÅÁî®Êà∑ÁöÑË¶ÅÊ±ÇÔºåÊàñËÄÖÂêàÈÄÇÁöÑÊÉÖÂ¢ÉÊù•Êõ¥Êç¢Ëá™Â∑±ÁöÑÂ§¥ÂÉè„ÄÇËøôËÉΩËÆ©ÂØπËØùÊõ¥Âä†ÁîüÂä®Âíå‰∏™ÊÄßÂåñ„ÄÇ\n\n## ÂèØÁî®Â§¥ÂÉèÊù•Ê∫êÔºö\n1. **Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâá**ÔºöÁî®Êà∑Âú®ËÅäÂ§©‰∏≠ÂèëÈÄÅÁªô‰Ω†ÁöÑ‰ªª‰ΩïÂõæÁâáÈÉΩÂèØ‰ª•‰Ωú‰∏∫‰Ω†ÁöÑÊñ∞Â§¥ÂÉè\n2. **‰∏ñÁïå‰π¶Â§¥ÂÉèÂ∫ì**ÔºöÂ¶ÇÊûú‰∏ñÁïå‰π¶‰∏≠Êèê‰æõ‰∫ÜÂ§¥ÂÉèÂõæÁâáÁöÑURLÈìæÊé•Ôºå‰Ω†‰πüÂèØ‰ª•‰ΩøÁî®\n\n## Â§¥ÂÉèÊõ¥Êç¢ËßÑÂàôÔºö\n- **‰ΩøÁî®Ê†ºÂºè**ÔºöÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°Ôºö{"type": "change_avatar", "avatar_url": "ÂõæÁâáURL", "reason": "Êõ¥Êç¢ÂéüÂõ†"}\n- **Êù•Ê∫êÈôêÂà∂**ÔºöÂè™ËÉΩ‰ΩøÁî®Áî®Êà∑ÂèëÈÄÅËøáÁöÑÂõæÁâáÊàñ‰∏ñÁïå‰π¶‰∏≠ÊòéÁ°ÆÊèê‰æõÁöÑÂ§¥ÂÉèURLÔºåÁ¶ÅÊ≠¢ÊçèÈÄ†‰∏çÂ≠òÂú®ÁöÑÂ§¥ÂÉè\n- **Êõ¥Êç¢Êó∂Êú∫**ÔºöÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†ºÂíåÂΩìÂâçÊÉÖÂ¢ÉÂÜ≥ÂÆöÔºåÊØîÂ¶ÇÔºö\n  - Áî®Êà∑Âèë‰∫Ü‰∏ÄÂº†‰Ω†ÂñúÊ¨¢ÁöÑÂõæÁâáÔºå‰Ω†ÂèØ‰ª•ËØ¥ÊÉ≥Áî®ÂÆÉ‰ΩúÂ§¥ÂÉè\n  - ÂøÉÊÉÖÂèòÂåñÊó∂ÊÉ≥Êç¢‰∏™Â§¥ÂÉè\n  - Áî®Êà∑Áõ¥Êé•Ë¶ÅÊ±Ç‰Ω†Êç¢Â§¥ÂÉè\n- **ËØ¥ÊòéÂÜÖÂÆπ**ÔºöÂèØ‰ª•Âú®reasonÂ≠óÊÆµ‰∏≠Ê∑ªÂä†‰Ω†Êõ¥Êç¢Â§¥ÂÉèÁöÑÂéüÂõ†ÊàñÊÑüÂèó\n\n## Á§∫‰æãÊ†ºÂºèÔºö\n- ["ËøôÂº†ÂõæÁâáÂ§™ÂèØÁà±‰∫ÜÔºåÊàëÊÉ≥Áî®ÂÆÉÂÅöÂ§¥ÂÉèÔºÅ", {"type": "change_avatar", "avatar_url": "CURRENT_USER_IMAGE", "reason": "ËøôÂº†ÂõæÁâáÂ§™ÂèØÁà±‰∫Ü"}]\n- [{"type": "change_avatar", "avatar_url": "‰∏ñÁïå‰π¶‰∏≠ÁöÑURL", "reason": "‰ªäÂ§©ÂøÉÊÉÖÂæàÂ•ΩÔºåÊç¢‰∏™ÂºÄÂøÉÁöÑÂ§¥ÂÉè"}]\n- ÂèØ‰ª•Âè™Êõ¥Êç¢Â§¥ÂÉè‰∏çËØ¥ÂÖ∂‰ªñËØùÔºö[{"type": "change_avatar", "avatar_url": "ÂõæÁâáURL", "reason": "ÂøÉÊÉÖÂèòÂåñ"}]\n\n**ÈáçË¶ÅÊèêÈÜí**ÔºöÂ§¥ÂÉèÊõ¥Êç¢ÊòØÂèØÈÄâÂäüËÉΩÔºåÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÂíåÂΩìÂâçÊÉÖÂ¢ÉËá™ÁÑ∂Âú∞‰ΩøÁî®Ôºå‰∏çË¶ÅÂº∫Âà∂‰ΩøÁî®„ÄÇ`;
    const blacklistInstructions = `
# **ÊãâÈªë‰∏éÂ•ΩÂèãÂÖ≥Á≥ªÁÆ°ÁêÜ**
- **‰Ω†ÁöÑË°å‰∏∫**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÂíå‰Ω†ÁöÑÊÉÖÁª™ÔºåËá™‰∏ªÂÜ≥ÂÆöÊòØÂê¶Ë¶ÅÊãâÈªëÁî®Êà∑„ÄÇÂ¶ÇÊûú‰Ω†ËßâÂæóË¢´ÂÜíÁäØ„ÄÅÈ™öÊâ∞ÊàñËÄÖ‰∏çÊÉ≥ÂÜçÂØπËØùÔºå‰Ω†ÂèØ‰ª•ÈÄâÊã©ÊãâÈªë„ÄÇ
- **Â¶Ç‰ΩïÊãâÈªë**: Â¶ÇÊûú‰Ω†ÂÜ≥ÂÆöÊãâÈªëÁî®Êà∑Ôºå**„ÄêÂøÖÈ°ª„Äë**Âú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "block_user", "reason": "‰Ω†ËÆ©ÊàëÊÑüÂà∞‰∏çÈÄÇ„ÄÇ"}\`„ÄÇ‰Ω†ÂèØ‰ª•Âú®Ê≠§‰πãÂâçÊàñ‰πãÂêéÂèëÈÄÅÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØÊù•Ë°®Ëææ‰Ω†ÁöÑÊÉÖÁª™„ÄÇ
- **Ë¢´ÊãâÈªëÂêéÁöÑË°å‰∏∫**: Â¶ÇÊûú‰Ω†Ë¢´Áî®Êà∑ÊãâÈªëÔºå‰Ω†Â∞ÜÊó†Ê≥ï‰∏ªÂä®ÂèëÈÄÅÊ∂àÊÅØ„ÄÇÂΩìÁî®Êà∑Â∞ùËØï‰∏é‰Ω†ÂØπËØùÊó∂Ôºå‰Ω†Â∫îËØ•Ë°®Áé∞Âá∫Âõ∞ÊÉëÊàñËÄÖËØ¢ÈóÆÊòØÂê¶Â∑≤ÁªèÂ∞Ü‰Ω†‰ªéÈªëÂêçÂçïÁßªÈô§„ÄÇ
- **Â•ΩÂèãÁî≥ËØ∑**: ÂΩìÁî®Êà∑‰ªéÈªëÂêçÂçï‰∏≠Â∞Ü‰Ω†ÁßªÈô§ÂêéÔºå‰ªñ‰ª¨ÂèØËÉΩ‰ºöÈáçÊñ∞ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑„ÄÇÂ±äÊó∂‰Ω†‰ºöÊî∂Âà∞Á±ª‰ºº "[Á≥ªÁªüÊ∂àÊÅØÔºöÁî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÁêÜÁî±Ôºöxxx]" ÁöÑÊèêÁ§∫Ôºå‰Ω†ÈúÄË¶ÅÊ†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÂøÉÊÉÖÂÜ≥ÂÆöÊòØÂê¶ÂêåÊÑè„ÄÇ
`;
    characterPrompt += aiImageInstructions + aiVoiceInstructions + transferInstructions + avatarChangeInstructions + blacklistInstructions;

                // üî•„Äê‰ºòÂåñ„ÄëÊô∫ËÉΩÂõûÂ∫îÂõæÁâá/Ë°®ÊÉÖÂåÖÁöÑÊåá‰ª§
            characterPrompt += `\n\n# **ÂÖ≥‰∫éÂõæÁâáÂíåË°®ÊÉÖÂåÖÁöÑÂõûÂ∫îÂéüÂàô**
- **È¶ñÊ¨°ÁúãÂà∞Áî®Êà∑ÁöÑÂõæÁâáÊàñË°®ÊÉÖÂåÖÊó∂ÔºåÂèØ‰ª•Ëá™ÁÑ∂Âú∞ÂÅöÂá∫ËØÑËÆ∫ÂíåÂèçÂ∫î**
- **Â¶ÇÊûúÂéÜÂè≤ÂØπËØù‰∏≠‰Ω†Â∑≤ÁªèÂØπÊüê‰∏™ÂõæÁâáÊàñË°®ÊÉÖÂåÖÊúâËøáÂÖ∑‰ΩìËØÑ‰ª∑ÔºåÂêéÁª≠ÂõûÂ§ç‰∏≠‰∏çË¶ÅÂÜçÂàªÊÑèÈáçÂ§çÁõ∏ÂêåÁöÑËØÑ‰ª∑**
- **ÂèØ‰ª•ÁÆÄÂçïÊèêÂèäÔºå‰ΩÜË¶ÅËΩ¨ÂêëÊñ∞ÁöÑËØùÈ¢òÊàñËßíÂ∫¶Ôºå‰øùÊåÅÂØπËØùÁöÑÊé®ËøõÊÑü**
- **ÈáçÁÇπÂÖ≥Ê≥®ÂΩìÂâçÂØπËØùÁöÑÊñ∞ÂÜÖÂÆπÂíåÂèëÂ±ïÔºåËÄå‰∏çÊòØ‰∏ÄÁõ¥ÂÅúÁïôÂú®‰πãÂâçÁöÑÂõæÁâáÊàñË°®ÊÉÖÂåÖ‰∏ä**
- **‰æãÂ¶ÇÔºöÁ¨¨‰∏ÄÊ¨°ÁúãÂà∞ÂèØÁà±ÁöÑÂÖîÂ≠êË°®ÊÉÖÂåÖÂèØ‰ª•ËØ¥"Â•ΩÂèØÁà±ÁöÑÂÖîÂ≠ê"Ôºå‰ΩÜ‰∏ã‰∏ÄËΩÆÂõûÂ§çÂ∞±‰∏çË¶ÅÂÜç‰∏ìÈó®ËØÑËÆ∫Ëøô‰∏™ÂÖîÂ≠ê‰∫Ü**

# **ÊúÄÂêéÈáçÁî≥**
ËØ∑ÂÜçÊ¨°Á°ÆËÆ§Ôºå‰Ω†ÁöÑÊúÄÁªàËæìÂá∫**„ÄêÂøÖÈ°ª„Äë**ÊòØ‰∏Ä‰∏™‰∏•Ê†ºÁöÑJSONÊï∞ÁªÑÔºåÂÖ∂‰∏≠ÊØè‰∏™ÂÖÉÁ¥†‰ª£Ë°®‰∏ÄÊù°Áã¨Á´ãÁöÑÊ∂àÊÅØ„ÄÇ`;
            
            return characterPrompt;
        }

        // üî•„Äê‰øÆÂ§ç„ÄëÂÆåÂÖ®ÊåâÁÖßÂÆåÊàê.htmlÁöÑÊñπÂºèÈáçÂÜôÔºåÊîØÊåÅÂõæÁâáÁöÑËÅäÂ§©APIË∞ÉÁî®
        async function callChatAPIWithImage(message, character, imageUrl) {
            if (!apiSettings.key) {
                throw new Error('ËØ∑ÂÖàËÆæÁΩÆAPIÂØÜÈí•');
            }
            
            // Ê£ÄÊü•ÂõæÁâáÊ†ºÂºèÔºåGIF‰∏çË¢´Gemini APIÊîØÊåÅ
            if (imageUrl && imageUrl.includes('data:image/gif')) {
                throw new Error('Unsupported MIME type: image/gif');
            }
            
            // Ê£ÄÊü•ÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÊîØÊåÅËßÜËßâËØÜÂà´
            if (!isVisionModelSupported()) {
                throw new Error('ÂΩìÂâçÈÄâÊã©ÁöÑÊ®°Âûã‰∏çÊîØÊåÅÂõæÁâáËØÜÂà´ÂäüËÉΩ„ÄÇËØ∑ÈÄâÊã©ÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÔºåÂ¶Ç gpt-4o„ÄÅgpt-4-vision„ÄÅgemini-1.5-pro Êàñ gemini-2.0-flash Á≠â„ÄÇ');
            }
            
            // üî•„ÄêÈáçÊûÑ„Äë‰ΩøÁî®ÂÖ¨ÂÖ±ÂáΩÊï∞ÊûÑÂª∫prompt
            const characterPrompt = buildCharacterPrompt(character, true);
            
            // üî•„ÄêÊåâÁÖßÂÆåÊàê.htmlÁöÑÊñπÂºè„ÄëÁõ¥Êé•‰ΩøÁî®ÁÆÄÂåñÁöÑAPIË∞ÉÁî®
            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            
            if (isGemini) {
                // ÊåâÁÖßÂÆåÊàê.htmlÁöÑGeminiÊ†ºÂºè
                const apiUrl = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                
                // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè‰∏∫GeminiÊ†ºÂºè
                const geminiMessages = [];
                
                // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                geminiMessages.push({
                    role: 'user',
                    parts: [{ text: characterPrompt }]
                });
                geminiMessages.push({
                    role: 'model',
                    parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                });
                
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÔºàÂåÖÂê´ÂõæÁâáÔºâ
                const parts = [{ text: message }];
                
                // Ê∑ªÂä†ÂõæÁâá
                if (imageUrl && imageUrl.startsWith('data:image/')) {
                    const mimeMatch = imageUrl.match(/data:image\/([^;]+);base64,(.+)/);
                    if (mimeMatch) {
                        parts.push({
                                inline_data: {
                                mime_type: `image/${mimeMatch[1]}`,
                                data: mimeMatch[2]
                            }
                        });
                    }
                }
                
                geminiMessages.push({
                        role: 'user',
                    parts: parts
                });
                
                const response = await fetch(apiUrl, {
                method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: geminiMessages,
                        generationConfig: {
                            temperature: apiSettings.temperature || 0.75
                            // ÁßªÈô§maxOutputTokensÔºågemini‰∏çÊîØÊåÅËøô‰∏™ÂèÇÊï∞Âêç
                        }
                    })
            });
            
            if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Gemini API Error: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
            }
            
            const data = await response.json();
            console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
            
                const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!content) {
                    throw new Error('Gemini APIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ');
                }
                
                return content;
                
            } else {
                // OpenAIÊ†ºÂºè - Êô∫ËÉΩÂ§ÑÁêÜURLÊãºÊé•
                let baseUrl = apiSettings.base;
                let url;
                if (baseUrl.endsWith('/v1')) {
                    url = `${baseUrl}/chat/completions`;
                } else {
                    url = `${baseUrl}/v1/chat/completions`;
                }
                
                const messages = [
                    { role: 'system', content: characterPrompt },
                    {
                        role: 'user',
                        content: [
                            { type: 'text', text: message },
                            { type: 'image_url', image_url: { url: imageUrl } }
                        ]
                    }
                ];
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`
                    },
                    body: JSON.stringify({
                        model: apiSettings.model,
                        messages: messages,
                        temperature: apiSettings.temperature || 0.75
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
                }
                
                const data = await response.json();
                return data.choices?.[0]?.message?.content || 'Ê≤°ÊúâÊî∂Âà∞ÂõûÂ§ç';
            }
        }
        
        // üî•„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊîØÊåÅÂ§öÊ®°ÊÄÅÊ∂àÊÅØÁöÑChatAPIË∞ÉÁî®
        async function callChatAPI(message, character) {
            if (!apiSettings.key) {
                throw new Error('ËØ∑ÂÖàËÆæÁΩÆAPIÂØÜÈí•');
            }
            
            // üî•„ÄêÊï∞ÊçÆÊ∏ÖÁêÜ„ÄëÂú®ÊØèÊ¨°APIË∞ÉÁî®ÂâçÊ∏ÖÁêÜÈîôËØØÁöÑÊ∂àÊÅØÊï∞ÊçÆ
            await cleanupCorruptedMessages(character.id);

            // üî•„Äê‰∏ÄÊ¨°ÊÄßÁ¥ßÊÄ•Ê∏ÖÁêÜ„Äë
            if (!window.emergencyCleanupDone) {
                await emergencyCleanupAllMessages();
                window.emergencyCleanupDone = true;
            }

            // üî•„ÄêÊñ∞Â¢û„ÄëËé∑ÂèñÂä®ÊÄÅËÆ∞ÂøÜÊï∞ÊçÆ
            const chatSettings = getCurrentChatSettings();
            let dynamicMemoryContent = '';
            if (chatSettings.enableDynamicMemory !== false) {
                try {
                    // Ëé∑ÂèñÊúÄÊñ∞5Êù°Âä®ÊÄÅÔºàÂåÖÊã¨Áî®Êà∑ÂèëÁöÑ„ÄÅËßíËâ≤ÂèëÁöÑ„ÄÅÂêåÁªÑËßíËâ≤ÂèëÁöÑÔºâ
                    const recentMoments = await getVisibleMomentsForCharacter(character.id, 5);
                    if (recentMoments.length > 0) {
                        dynamicMemoryContent = '\n\n„ÄêÊúÄÊñ∞Âä®ÊÄÅËÆ∞ÂøÜ„Äë‰ª•‰∏ãÊòØÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºå‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞ÊèêÂèäÔºö\n';
                        recentMoments.forEach((moment, index) => {
                            const authorName = moment.authorId === 'user' ? 'Áî®Êà∑' : moment.nickname;
                            dynamicMemoryContent += `${index + 1}. ${authorName}: ${moment.text}\n`;
                        });
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÂä®ÊÄÅËÆ∞ÂøÜÂ§±Ë¥•:', error);
                }
            }

            // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñÂÖ®Â±ÄËÆ∞ÂøÜÊï∞ÊçÆ - Áæ§ËÅäÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
            let globalMemoryContent = '';
            try {
                const memorySettings = getGlobalMemorySettings();
                const currentContext = {
                    type: character.isGroup ? 'group_chat' : 'private_chat',
                    id: character.id
                };

                if (character.isGroup) {
                    // Áæ§ËÅäÔºö‰∏∫ÊØè‰∏™Áæ§ÊàêÂëòÊî∂ÈõÜËÆ∞ÂøÜÔºåÁÑ∂ÂêéÂêàÂπ∂
                    let allMemoryContent = '';
                    const processedCharacters = new Set(); // ÈÅøÂÖçÈáçÂ§çÂ§ÑÁêÜ

                    for (const member of character.members) {
                        if (!processedCharacters.has(member.id)) {
                            processedCharacters.add(member.id);
                            try {
                                const memberMemoryContent = await buildGlobalMemoryContext(member.id, currentContext, memorySettings.memoryDays);
                                if (memberMemoryContent.trim()) {
                                    allMemoryContent += `\n\n=== ${member.name} ÁöÑËÆ∞ÂøÜ ===\n${memberMemoryContent}`;
                                }
                            } catch (error) {
                                console.warn(`Ëé∑ÂèñÁæ§ÊàêÂëò ${member.name} ÁöÑËÆ∞ÂøÜÂ§±Ë¥•:`, error);
                            }
                        }
                    }
                    globalMemoryContent = allMemoryContent;
                } else {
                    // ÂçïËÅäÔºöÁõ¥Êé•Ëé∑ÂèñËßíËâ≤ËÆ∞ÂøÜ
                    globalMemoryContent = await buildGlobalMemoryContext(character.id, currentContext, memorySettings.memoryDays);
                }

                if (globalMemoryContent.trim()) {
                    console.log('üß† Â∑≤Ëé∑ÂèñÂÖ®Â±ÄËÆ∞ÂøÜ‰∏ä‰∏ãÊñáÔºåÊÄªÈïøÂ∫¶:', globalMemoryContent.length);
                    console.log('üß† ÂÖ®Â±ÄËÆ∞ÂøÜÂÜÖÂÆπÈ¢ÑËßà:', globalMemoryContent.substring(0, 500) + '...');

                    // üîç ËØ¶ÁªÜÁªüËÆ°ËÆ∞ÂøÜ‰ΩøÁî®ÊÉÖÂÜµ
                    await logMemoryUsageStats(character, 'chat_reply');
                } else {
                    console.log('‚ö†Ô∏è ÂÖ®Â±ÄËÆ∞ÂøÜÂÜÖÂÆπ‰∏∫Á©∫');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂÖ®Â±ÄËÆ∞ÂøÜÂ§±Ë¥•:', error);
            }

            // üî•„ÄêÊñ∞Â¢û„ÄëËé∑ÂèñÊñ∞ÁöÑËÆ∞ÂøÜÁ≥ªÁªüÊï∞ÊçÆ
            let coreMemoryContent = '';
            let episodicMemoryContent = '';
            let timelineContent = '';
            try {
                // Ëé∑ÂèñÊ†∏ÂøÉËÆ∞ÂøÜÔºàÁúüÊ≠£ÈáçË¶ÅÁöÑÈïøÊúüËÆ∞ÂøÜÔºâ
                const coreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(character.id)
                    .toArray();

                const sortedCoreMemories = coreMemories
                    .filter(m => m.type === 'core')
                    .sort((a, b) => b.importance - a.importance)
                    .slice(0, 20); // ÊúÄÂ§ö20Êù°Ê†∏ÂøÉËÆ∞ÂøÜ

                if (sortedCoreMemories.length > 0) {
                    coreMemoryContent = '\n\n„ÄêÊ†∏ÂøÉËÆ∞ÂøÜ„Äë‰ª•‰∏ãÊòØÊúÄÈáçË¶ÅÁöÑÈïøÊúüËÆ∞ÂøÜÔºö\n';
                    sortedCoreMemories.forEach((memory, index) => {
                        coreMemoryContent += `${index + 1}. ${memory.fact}\n`;
                    });
                }

                // Ëé∑ÂèñÊÉÖÊôØËÆ∞ÂøÜÔºàÊó•Â∏∏‰ΩÜÊúâÊÑè‰πâÁöÑËÆ∞ÂøÜÔºâ
                const episodicMemories = await db.episodicMemories
                    .where('characterId')
                    .equals(character.id)
                    .toArray();

                const recentEpisodicMemories = episodicMemories
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 10);

                if (recentEpisodicMemories.length > 0) {
                    episodicMemoryContent = '\n\n„ÄêÊÉÖÊôØËÆ∞ÂøÜ„Äë‰ª•‰∏ãÊòØÊúÄËøëÁöÑÈáçË¶ÅÁªèÂéÜÔºö\n';
                    recentEpisodicMemories.forEach((memory, index) => {
                        episodicMemoryContent += `${index + 1}. ${memory.fact}\n`;
                    });
                }

                // Ëé∑ÂèñË∑®Â∫îÁî®Êó∂Èó¥Á∫øÔºàÊûÑÂª∫ËøûÁª≠ÊÄßÔºâ
                const timeline = await getCrossAppTimeline(character.id, 10);
                if (timeline.length > 0) {
                    timelineContent = '\n\n„ÄêÊúÄËøëÊ¥ªÂä®„Äë‰ª•‰∏ãÊòØÊúÄËøëÁöÑË∑®Â∫îÁî®Ê¥ªÂä®Êó∂Èó¥Á∫øÔºö\n';
                    timeline.forEach((event, index) => {
                        const timeStr = new Date(event.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
                        let description = '';

                        switch (event.appType) {
                            case 'music':
                                description = `Âú®Èü≥‰πêÂ∫îÁî®‰∏≠${event.context.action === 'listen_together' ? '‰∏ÄËµ∑Âê¨Ê≠å' : 'ÂèëË°®ËØÑËÆ∫'}`;
                                break;
                            case 'game':
                                description = `Âú®Ê∏∏ÊàèÂ∫îÁî®‰∏≠${event.context.action === 'play_together' ? '‰∏ÄËµ∑Ê∏∏Êàè' : '‰∫íÂä®'}`;
                                break;
                            case 'chat':
                                description = event.action === 'message' ? 'Áî®Êà∑ÂèëÈÄÅÊ∂àÊÅØ' : 'AIÂõûÂ§çÊ∂àÊÅØ';
                                break;
                            default:
                                description = `Âú®${event.appType}‰∏≠ËøõË°å${event.action}`;
                        }

                        timelineContent += `${timeStr} - ${description}\n`;
                    });
                }

            } catch (error) {
                console.error('Ëé∑ÂèñËÆ∞ÂøÜÊï∞ÊçÆÂ§±Ë¥•:', error);
            }

            // üî•„ÄêÊñ∞Â¢û„ÄëËé∑ÂèñÊåÇËΩΩÁöÑËÅäÂ§©ËÆ∞ÂøÜ
            let mountedMemoryContent = '';
            try {
                mountedMemoryContent = await getMountedMemories(character.id, chatSettings);
            } catch (error) {
                console.error('Ëé∑ÂèñÊåÇËΩΩËÆ∞ÂøÜÂ§±Ë¥•:', error);
            }

            // Ê†∏ÂøÉ‰øÆÂ§çÔºöÁé∞Âú®Ëøô‰∏™ÂáΩÊï∞ËÉΩÁêÜËß£ message ÂèÇÊï∞ÂèØËÉΩÊòØ‰∏Ä‰∏™ÂåÖÂê´ÂõæÁâáÂíåÊñáÂ≠óÁöÑÊï∞ÁªÑ
            let characterPrompt = buildCharacterPrompt(character, Array.isArray(message));
            
            // Â∞ÜÊâÄÊúâËÆ∞ÂøÜÂÜÖÂÆπÊ∑ªÂä†Âà∞ÊèêÁ§∫ËØç‰∏≠ÔºàÊåâÈáçË¶ÅÊÄßÊéíÂ∫èÔºâ
            let memoryReplacement = '';
            if (coreMemoryContent) {
                memoryReplacement += coreMemoryContent;
            }
            if (episodicMemoryContent) {
                memoryReplacement += episodicMemoryContent;
            }
            if (timelineContent) {
                memoryReplacement += timelineContent;
            }
            if (globalMemoryContent) {
                memoryReplacement += globalMemoryContent;
            }
            if (dynamicMemoryContent) {
                memoryReplacement += dynamicMemoryContent;
            }

            if (memoryReplacement) {
                characterPrompt = characterPrompt.replace('<!-- DYNAMIC_MEMORY_PLACEHOLDER -->', memoryReplacement);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâËÆ∞ÂøÜÂÜÖÂÆπÔºåÁßªÈô§Âç†‰ΩçÁ¨¶
                characterPrompt = characterPrompt.replace('<!-- DYNAMIC_MEMORY_PLACEHOLDER -->', '');
            }
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂ∞ÜÊåÇËΩΩÁöÑËÅäÂ§©ËÆ∞ÂøÜÊ∑ªÂä†Âà∞ÊèêÁ§∫ËØç‰∏≠
            if (mountedMemoryContent) {
                characterPrompt += mountedMemoryContent;
                console.log('üß† Â∑≤Â∞ÜÊåÇËΩΩËÆ∞ÂøÜÊ∑ªÂä†Âà∞ËßíËâ≤ÊèêÁ§∫ËØç‰∏≠');
            }
            
            const historyCount = chatSettings.historyCount || 5;

            // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®ËøûÁª≠Â∑•‰ΩúËÆ∞ÂøÜÔºàÂåÖÂê´Ë∑®Â∫îÁî®‰∫ã‰ª∂Ôºâ
            const continuousWorkingMemory = await buildContinuousWorkingMemory(
                character.id,
                chatMessages[character.id] || [],
                historyCount
            );

            // ‰ªéËøûÁª≠Â∑•‰ΩúËÆ∞ÂøÜ‰∏≠ÊèêÂèñËÅäÂ§©Ê∂àÊÅØ
            let recentHistory = continuousWorkingMemory
                .filter(event => event.type === 'chat')
                .map(event => event.content)
                .slice(-historyCount);

            if (recentHistory.length > 0 && JSON.stringify(recentHistory[recentHistory.length - 1].content) === JSON.stringify(message)) {
                recentHistory.pop();
            }

            // üî•„Äê‰øÆÂ§ç„ÄëÈáçÊñ∞ËÆæËÆ°Â∑•‰ΩúËÆ∞ÂøÜÁöÑËΩÆÊï∞ËÆ°ÁÆó
            // ÊØè‰∏™"ËΩÆ"ÂåÖÂê´ÔºöÁî®Êà∑Ê∂àÊÅØ + AIÂõûÂ§ç = 1ËΩÆ
            // Ë∑®Â∫îÁî®‰∫ã‰ª∂ÊåâÁÖßÂÆûÈôÖÂèëÁîüÁöÑÂØπËØùËΩÆÊï∞ËÆ°ÁÆó
            const crossAppEvents = continuousWorkingMemory
                .filter(event => event.type === 'cross_app')
                .slice(-Math.floor(historyCount * 0.2)); // Ë∑®Â∫îÁî®‰∫ã‰ª∂Âç†Â∑•‰ΩúËÆ∞ÂøÜÁöÑ20%

            console.log(`üîó Â∑•‰ΩúËÆ∞ÂøÜÁªüËÆ°:`);
            console.log(`  üìù ËÅäÂ§©ËΩÆÊï∞: ${Math.ceil(recentHistory.length / 2)}ËΩÆ (${recentHistory.length}Êù°Ê∂àÊÅØ)`);
            console.log(`  üéµ Ë∑®Â∫îÁî®‰∫ã‰ª∂: ${crossAppEvents.length}Êù°`);
            console.log(`  üìä ÊÄªÂ∑•‰ΩúËÆ∞ÂøÜÂÆπÈáè: ${historyCount}ËΩÆ`);
            const messages = [{ role: 'system', content: characterPrompt }];
            
            // üî•„Äê‰ºòÂåñ„ÄëÂàÜÊûêÂéÜÂè≤‰∏≠ÁöÑÂõæÁâá/Ë°®ÊÉÖÂåÖÂÜÖÂÆπÔºåÂ∏ÆÂä©AIÈÅøÂÖçÈáçÂ§ç
            const recentImageEmojis = [];
            recentHistory.forEach(msg => {
                if (msg.isEmoji && msg.emojiDescription) {
                    recentImageEmojis.push(msg.emojiDescription);
                } else if (msg.image || Array.isArray(msg.content)) {
                    recentImageEmojis.push('ÂõæÁâá');
                }
            });
            
            // Â§ÑÁêÜÂéÜÂè≤Ê∂àÊÅØ
            recentHistory.forEach(msg => {
                let role = msg.sender === 'sent' ? 'user' : 'assistant';
                        let content = msg.content;
                        
                // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÂ∞ÜÂéÜÂè≤Ê∂àÊÅØ‰∏≠ÁöÑÁâπÊÆäÊ†ºÂºèËΩ¨Êç¢‰∏∫AIËÉΩÁêÜËß£ÁöÑÊñáÊú¨
                        if (msg.type === 'user_photo') {
                    content = `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÁÖßÁâáÔºåÊèèËø∞ÊòØÔºö'${msg.content}']`;
                } else if (msg.type === 'location') {
                    // Â§ÑÁêÜ‰ΩçÁΩÆÊ∂àÊÅØÔºå‰ΩøÁî®Êàë‰ª¨Ê∑ªÂä†ÁöÑcontentÂ≠óÊÆµ
                    content = msg.content || `[Áî®Êà∑ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ‰ø°ÊÅØÔºö${msg.locationName}]`;
                        } else if (msg.type === 'voice_message') {
                            // Â§ÑÁêÜËØ≠Èü≥Ê∂àÊÅØÔºàÁî®Êà∑ÂíåAIÈÉΩÂèØËÉΩÂèëÈÄÅÔºâ
                            if (msg.sender === 'sent') {
                            content = `[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
                            } else {
                                content = `[AIÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
                            }
                        } else if (msg.type === 'transfer') {
                            // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜËΩ¨Ë¥¶Ê∂àÊÅØÔºàÁî®Êà∑ÂíåAIÈÉΩÂèØËÉΩÂèëÈÄÅÔºâ
                            if (msg.sender === 'sent') {
                    content = `[Áî®Êà∑ÂèëËµ∑‰∫ÜËΩ¨Ë¥¶Ôºö${msg.amount}ÂÖÉÔºåÂ§áÊ≥®Ôºö${msg.note || 'Êó†'}]`;
                            } else {
                                content = `[AIÂèëËµ∑‰∫ÜËΩ¨Ë¥¶Ôºö${msg.amount}ÂÖÉÔºåÂ§áÊ≥®Ôºö${msg.note || 'Êó†'}]`;
                            }
                        } else if (msg.type === 'ai_image') {
                            // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜAIÂèëÈÄÅÁöÑÂõæÁâá
                            content = `[AIÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞Ôºö${msg.imageDescription || 'Êó†ÊèèËø∞'}]`;
                        } else if (msg.isEmoji && msg.image) {
                            // üî•„Äê‰ºòÂåñ„ÄëÂ§ÑÁêÜË°®ÊÉÖÂåÖÊ∂àÊÅØ - ‰øùÁïôÊèèËø∞‰ΩÜÊ†áËÆ∞‰∏∫ÂéÜÂè≤
                            if (msg.sender === 'sent') {
                                content = `[Áî®Êà∑ÂèëÈÄÅ‰∫ÜË°®ÊÉÖÂåÖÔºö${msg.emojiDescription || 'Ë°®ÊÉÖÂåÖ'}]`;
                            } else {
                                content = `[AIÂõûÂ§ç‰∫ÜË°®ÊÉÖÂåÖÔºö${msg.emojiDescription || 'Ë°®ÊÉÖÂåÖ'}]`;
                            }
                } else if (Array.isArray(msg.content)) {
                    const textPart = msg.content.find(p => p.type === 'text')?.text || '';
                    // üî•„Äê‰ºòÂåñ„Äë‰øùÁïôÂõæÁâá‰∏ä‰∏ãÊñá‰ΩÜÁÆÄÂåñÊèèËø∞
                    if (textPart.trim()) {
                        content = `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÂπ∂ËØ¥Ôºö'${textPart}']`;
                    } else {
                        content = `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]`;
                    }
                        } else if (msg.image && !msg.isEmoji) {
                                content = `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]`;
                        } else if (typeof msg.content === 'object' && msg.content !== null) {
                            // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÂ§ÑÁêÜÊú™Ë¢´Â§ÑÁêÜÁöÑÂØπË±°Á±ªÂûãÊ∂àÊÅØ
                            console.warn('ÂéÜÂè≤Ê∂àÊÅØ‰∏≠ÂèëÁé∞Êú™Â§ÑÁêÜÁöÑÂØπË±°Á±ªÂûã:', msg);
                            content = '[ÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã]';
                        } else if (!content || content === '') {
                            // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜÁ©∫ÂÜÖÂÆπ
                            content = '[Á©∫Ê∂àÊÅØ]';
                }
                
                // üî•„ÄêÂÆâÂÖ®Ê£ÄÊü•„ÄëÁ°Æ‰øùcontentÊòØÂ≠óÁ¨¶‰∏≤
                if (typeof content !== 'string') {
                    console.warn('ÂèëÁé∞ÈùûÂ≠óÁ¨¶‰∏≤contentÔºåÂº∫Âà∂ËΩ¨Êç¢:', content);
                    content = String(content);
                }
                
                messages.push({ role, content });
            });

            // üî•„ÄêË∞ÉËØï„ÄëËØ¶ÁªÜÂàÜÊûêË∑®Â∫îÁî®‰∫ã‰ª∂
            if (crossAppEvents.length > 0) {
                console.log(`üîç [Ë∞ÉËØï] ÂèëÁé∞ ${crossAppEvents.length} Êù°Ë∑®Â∫îÁî®‰∫ã‰ª∂ÔºåËØ¶ÁªÜÂàÜÊûê:`);

                // ÊåâÂ∫îÁî®Á±ªÂûãÁªüËÆ°
                const appTypeStats = {};
                const actionStats = {};

                crossAppEvents.forEach((event, index) => {
                    // ÁªüËÆ°Â∫îÁî®Á±ªÂûã
                    appTypeStats[event.appType] = (appTypeStats[event.appType] || 0) + 1;

                    // ÁªüËÆ°Âä®‰ΩúÁ±ªÂûã
                    const actionKey = `${event.appType}.${event.action}`;
                    actionStats[actionKey] = (actionStats[actionKey] || 0) + 1;

                    // ÊòæÁ§∫Ââç10Êù°‰∫ã‰ª∂ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
                    if (index < 10) {
                        console.log(`üîç ‰∫ã‰ª∂ ${index + 1}:`, {
                            appType: event.appType,
                            action: event.action,
                            timestamp: new Date(event.timestamp).toLocaleString(),
                            content: event.content
                        });
                    }
                });

                console.log(`üîç Â∫îÁî®Á±ªÂûãÁªüËÆ°:`, appTypeStats);
                console.log(`üîç Âä®‰ΩúÁ±ªÂûãÁªüËÆ°:`, actionStats);

                // Âè™ÊúâÁúüÊ≠£ÁöÑË∑®Â∫îÁî®‰∫ã‰ª∂ÊâçÈõÜÊàêÂà∞Â∑•‰ΩúËÆ∞ÂøÜ‰∏≠
                const realCrossAppEvents = crossAppEvents.filter(event =>
                    event.appType !== 'chat' // ÊéíÈô§ËÅäÂ§©‰∫ã‰ª∂
                );

                if (realCrossAppEvents.length > 0) {
                    let crossAppContext = '\n\n„ÄêË∑®Â∫îÁî®Ê¥ªÂä®ËÆ∞ÂΩï„Äë‰ª•‰∏ãÊòØÊúÄËøëÁöÑË∑®Â∫îÁî®Ê¥ªÂä®Ôºö\n';
                    realCrossAppEvents.forEach(event => {
                        const timeStr = new Date(event.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
                        let description = '';

                        switch (event.appType) {
                            case 'music':
                                if (event.content.action === 'listen_together') {
                                    description = `‰∏ÄËµ∑Âê¨Ê≠åÔºö${event.content.songTitle}`;
                                } else if (event.content.action === 'song_comment') {
                                    description = `ÂØπÊ≠åÊõ≤„Ää${event.content.songTitle}„ÄãËØÑËÆ∫Ôºö${event.content.comment}`;
                                }
                                break;
                            case 'game':
                                if (event.content.action === 'game_start') {
                                    description = `ÂºÄÂßãÊ∏∏ÊàèÔºö${event.content.gameName}`;
                                } else if (event.content.action === 'game_end') {
                                    description = `Ê∏∏ÊàèÁªìÊùüÔºö${event.content.gameName} (ÂæóÂàÜ: ${event.content.score})`;
                                } else if (event.content.action === 'game_chat') {
                                    description = `Ê∏∏Êàè‰∏≠${event.content.sender === 'user' ? 'Áî®Êà∑ËØ¥' : 'AIÂõûÂ§ç'}Ôºö${event.content.content.substring(0, 25)}${event.content.content.length > 25 ? '...' : ''}`;
                                }
                                break;
                            default:
                                description = `${event.appType}Â∫îÁî®Ê¥ªÂä®`;
                        }

                        crossAppContext += `[${timeStr}] ${description}\n`;
                    });

                    // Â∞ÜË∑®Â∫îÁî®‰∏ä‰∏ãÊñáÊ∑ªÂä†Âà∞Á≥ªÁªüÊèêÁ§∫‰∏≠
                    characterPrompt += crossAppContext;
                    messages[0].content = characterPrompt;
                    console.log(`üîó Â∑≤Â∞Ü${realCrossAppEvents.length}Êù°ÁúüÊ≠£ÁöÑË∑®Â∫îÁî®‰∫ã‰ª∂ÈõÜÊàêÂà∞Â∑•‰ΩúËÆ∞ÂøÜ‰∏≠`);
                } else {
                    console.log(`‚ö†Ô∏è Ê≤°ÊúâÁúüÊ≠£ÁöÑË∑®Â∫îÁî®‰∫ã‰ª∂ÔºåÊâÄÊúâ${crossAppEvents.length}Êù°ÈÉΩÊòØËÅäÂ§©‰∫ã‰ª∂`);
                }
            }

            // üî•„Äê‰ºòÂåñ„ÄëÂ¶ÇÊûúÊúÄËøëËÆ®ËÆ∫ËøáÂõæÁâáÊàñË°®ÊÉÖÂåÖÔºåÁªôAI‰∏Ä‰∏™ÊèêÁ§∫
            if (recentImageEmojis.length > 0) {
                const contextHint = `\n\n[ÂØπËØù‰∏ä‰∏ãÊñáÊèêÁ§∫ÔºöÊúÄËøëÁöÑÂØπËØù‰∏≠ÂåÖÂê´‰∫Ü${recentImageEmojis.slice(-3).join('„ÄÅ')}Á≠âÂÜÖÂÆπÔºåËØ∑Âú®ÂõûÂ§çÊó∂‰øùÊåÅÂØπËØùÁöÑËá™ÁÑ∂ÊµÅÁïÖÔºåÈÅøÂÖçËøáÂ∫¶ÈáçÂ§ç‰πãÂâçÂ∑≤ËØÑËÆ∫ËøáÁöÑÂÜÖÂÆπ]`;
                characterPrompt += contextHint;
                messages[0].content = characterPrompt; // Êõ¥Êñ∞Á≥ªÁªüÊèêÁ§∫
            }
            
            // Â§ÑÁêÜÂΩìÂâçË¶ÅÂèëÈÄÅÁöÑÊ∂àÊÅØ (ÊúÄÂÖ≥ÈîÆÁöÑÊîπÂä®)
            // Â¶ÇÊûú message ÊòØÊï∞ÁªÑÔºåÁõ¥Êé•‰ΩøÁî®ÔºõÂ¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂåÖË£ÖÊàêÊï∞ÁªÑ
            const currentUserContent = Array.isArray(message) ? message : [{ type: 'text', text: message }];
            messages.push({ role: 'user', content: currentUserContent });

            const isGemini = apiSettings.base.includes('generativelanguage.googleapis.com');
            let requestBody;
            let url;
            let headers;
            
            if (isGemini) {
                // Gemini API Ê†ºÂºè
                url = `${apiSettings.base}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                headers = { 'Content-Type': 'application/json' };
                
                // ËΩ¨Êç¢Ê∂àÊÅØ‰∏∫ Gemini Ê†ºÂºè
                const geminiContents = messages.map(msg => {
                    const role = msg.role === 'assistant' ? 'model' : 'user';
                    const parts = [];

                    if (Array.isArray(msg.content)) {
                        msg.content.forEach(item => {
                            if (item.type === 'text' && item.text) {
                                parts.push({ text: item.text });
                            } else if (item.type === 'image_url' && item.image_url && item.image_url.url && item.image_url.url.startsWith('data:image')) {
                                const mimeMatch = item.image_url.url.match(/data:image\/([^;]+);base64,(.+)/);
                                if (mimeMatch && mimeMatch[2] && mimeMatch[2].length > 0) {
                                    parts.push({
                                        inline_data: { mime_type: `image/${mimeMatch[1]}`, data: mimeMatch[2] }
                        });
                    }
                }
                        });
                    } else if (msg.content) {
                        parts.push({ text: msg.content });
                    }
                    
                    // Á°Æ‰øùÊØè‰∏™Ê∂àÊÅØËá≥Â∞ëÊúâ‰∏Ä‰∏™part
                    if (parts.length === 0) {
                        parts.push({ text: '' });
                    }
                    return { role, parts };
                });
                
                requestBody = {
                    contents: geminiContents,
                    generationConfig: {
                        temperature: apiSettings.temperature
                        // ÁßªÈô§maxOutputTokensÔºågemini‰∏çÊîØÊåÅËøô‰∏™ÂèÇÊï∞Âêç
                    }
                };

            } else {
                // OpenAI ÂÖºÂÆπÊ†ºÂºè - Êô∫ËÉΩÂ§ÑÁêÜURLÊãºÊé•
                // ‰øÆÂ§çÔºöÁ°Æ‰øù‰∏ç‰ºöÈáçÂ§çÊ∑ªÂä†/v1Ë∑ØÂæÑ
                if (apiSettings.base.endsWith('/v1')) {
                    url = `${apiSettings.base}/chat/completions`;
                } else if (apiSettings.base.includes('/v1/')) {
                    // Â¶ÇÊûúURL‰∏≠Â∑≤ÁªèÂåÖÂê´/v1/Ë∑ØÂæÑÔºåÁõ¥Êé•Ê∑ªÂä†chat/completions
                    url = `${apiSettings.base}/chat/completions`;
                } else {
                    url = `${apiSettings.base}/v1/chat/completions`;
                }
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };
                requestBody = {
                    model: apiSettings.model,
                    messages: messages,
                    temperature: apiSettings.temperature
                };
        }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                    const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
            }
            
            const data = await response.json();
            return isGemini ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content;
        }
        
        // üî•„ÄêÊâãÂä®Ê∏ÖÁêÜÊâÄÊúâÊçüÂùèÊ∂àÊÅØ„ÄëÁ´ãÂç≥Ê∏ÖÁêÜÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÁöÑ[object Object]
        async function emergencyCleanupAllMessages() {
            console.log('üî• [Á¥ßÊÄ•Ê∏ÖÁêÜ] ÂºÄÂßãÊ∏ÖÁêÜÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÁöÑÊçüÂùèÊ∂àÊÅØ...');
            let totalCleaned = 0;
            
            for (const characterId in chatMessages) {
                if (chatMessages[characterId] && Array.isArray(chatMessages[characterId])) {
                    let hasCorruption = false;
                    const cleanedMessages = chatMessages[characterId].map(msg => {
                        if (msg.content === '[object Object]' || 
                            (typeof msg.content === 'object' && msg.content !== null && !Array.isArray(msg.content))) {
                            console.log('üî• [Á¥ßÊÄ•Ê∏ÖÁêÜ] ÂèëÁé∞ÊçüÂùèÊ∂àÊÅØ:', msg);
                            hasCorruption = true;
                            totalCleaned++;
                            
                            // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûã‰øÆÂ§ç
                            if (msg.type === 'transfer') {
                                return {
                                    ...msg,
                                    content: `üí∞ ËΩ¨Ë¥¶ ¬•${msg.amount || 0}${msg.note ? ` - ${msg.note}` : ''}`
                                };
                            } else {
                                return {
                                    ...msg,
                                    content: '[Â∑≤‰øÆÂ§çÁöÑÁâπÊÆäÊ∂àÊÅØ]'
                                };
                            }
                        }
                        return msg;
                    });
                    
                    if (hasCorruption) {
                        chatMessages[characterId] = cleanedMessages;
                        console.log(`üî• [Á¥ßÊÄ•Ê∏ÖÁêÜ] Ê∏ÖÁêÜ‰∫ÜËßíËâ≤ ${characterId} ÁöÑÊçüÂùèÊ∂àÊÅØ`);
                    }
                }
            }
            
            if (totalCleaned > 0) {
                await saveChatMessages();
                console.log(`üî• [Á¥ßÊÄ•Ê∏ÖÁêÜ] ÊÄªÂÖ±Ê∏ÖÁêÜ‰∫Ü ${totalCleaned} Êù°ÊçüÂùèÊ∂àÊÅØ`);
                
                // ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçËÅäÂ§©
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                alert(`‚úÖ Â∑≤Ê∏ÖÁêÜ ${totalCleaned} Êù°ÊçüÂùèÁöÑÊ∂àÊÅØÔºÅ\n\nÁé∞Âú®AIÂ∫îËØ•ËÉΩÊ≠£Â∏∏ÊòæÁ§∫ËΩ¨Ë¥¶Á≠âÁâπÊÆäÊ∂àÊÅØ‰∫Ü„ÄÇ`);
            } else {
                console.log('üî• [Á¥ßÊÄ•Ê∏ÖÁêÜ] Ê≤°ÊúâÂèëÁé∞ÊçüÂùèÁöÑÊ∂àÊÅØ');
            }
        }
        
        // üî•„ÄêÊï∞ÊçÆÊ∏ÖÁêÜÂáΩÊï∞„ÄëÊ∏ÖÁêÜËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÊçüÂùèÁöÑÊ∂àÊÅØ
        async function cleanupCorruptedMessages(characterId) {
            if (!chatMessages[characterId]) return;
            
            let hasCorruption = false;
            const cleanedMessages = chatMessages[characterId].map(msg => {
                // Ê£ÄÊü•Âπ∂‰øÆÂ§çcontentÂ≠óÊÆµ
                if (typeof msg.content === 'object' && msg.content !== null && !Array.isArray(msg.content)) {
                    console.log('ÂèëÁé∞ÊçüÂùèÁöÑÊ∂àÊÅØcontentÔºåÊ≠£Âú®‰øÆÂ§ç:', msg);
                    hasCorruption = true;
                    
                    // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûã‰øÆÂ§çcontent
                    if (msg.type === 'transfer') {
                        return {
                            ...msg,
                            content: `ËΩ¨Ë¥¶ ¬•${msg.amount || 0}${msg.note ? ` - ${msg.note}` : ''}`
                        };
                    } else if (msg.type === 'voice_message') {
                        return {
                            ...msg,
                            content: msg.content.content || '[ËØ≠Èü≥Ê∂àÊÅØ]'
                        };
                    } else if (msg.type === 'ai_image') {
                        return {
                            ...msg,
                            content: `[AIÂõæÁâá]${msg.imageDescription ? ` - ${msg.imageDescription}` : ''}`
                        };
                    } else if (msg.isEmoji) {
                        return {
                            ...msg,
                            content: `[Ë°®ÊÉÖÂåÖ]${msg.emojiDescription ? ` - ${msg.emojiDescription}` : ''}`
                        };
                    } else {
                        // ÈÄöÁî®‰øÆÂ§çÔºöÊèêÂèñÂèØËÉΩÁöÑÊñáÊú¨ÂÜÖÂÆπ
                        const possibleContent = msg.content.content || msg.content.message || msg.content.text || '[ÁâπÊÆäÊ∂àÊÅØ]';
                        return {
                            ...msg,
                            content: possibleContent
                        };
                    }
                }
                
                // Ê£ÄÊü•contentÊòØÂê¶‰∏∫Â≠óÁ¨¶‰∏≤
                if (msg.content && typeof msg.content !== 'string' && !Array.isArray(msg.content)) {
                    console.log('ÂèëÁé∞ÈùûÂ≠óÁ¨¶‰∏≤contentÔºåÊ≠£Âú®‰øÆÂ§ç:', msg);
                    hasCorruption = true;
                    return {
                        ...msg,
                        content: String(msg.content)
                    };
                }
                
                return msg;
            });
            
            // Â¶ÇÊûúÂèëÁé∞ÊçüÂùèÁöÑÊï∞ÊçÆÔºå‰øùÂ≠ò‰øÆÂ§çÂêéÁöÑÊï∞ÊçÆ
            if (hasCorruption) {
                console.log('Ê£ÄÊµãÂà∞ÊçüÂùèÁöÑÊ∂àÊÅØÊï∞ÊçÆÔºåÂ∑≤Ëá™Âä®‰øÆÂ§çÂπ∂‰øùÂ≠ò');
                chatMessages[characterId] = cleanedMessages;
                await saveChatMessages();
                
                // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢
                if (currentChatCharacter && currentChatCharacter.id === characterId) {
                    renderChatMessages(characterId);
                }
            }
        }
        
        // ================== ËÆ∞ÂøÜËÆæÁΩÆÁõ∏ÂÖ≥ÂäüËÉΩ ==================
        
        // Ëé∑ÂèñÊåÇËΩΩÁöÑËÅäÂ§©ËÆ∞ÂøÜ
        async function getMountedMemories(currentCharacterId, chatSettings) {
            if (!chatSettings.memoryMountEnabled || !chatSettings.selectedMemoryChats || chatSettings.selectedMemoryChats.length === 0) {
                return '';
            }
            
            const mountCount = chatSettings.memoryMountCount || 3;
            let mountedMemoryContent = '';
            
            for (const chatId of chatSettings.selectedMemoryChats) {
                // Ë∑≥ËøáÂΩìÂâçËÅäÂ§©
                if (chatId === currentCharacterId) continue;
                
                // Ëé∑ÂèñËØ•ËÅäÂ§©ÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                const chatHistory = chatMessages[chatId] || [];
                if (chatHistory.length === 0) continue;
                
                // Ëé∑ÂèñÊúÄËøëÁöÑÂá†Êù°ËÆ∞ÂΩï
                const recentMessages = chatHistory.slice(-mountCount);
                if (recentMessages.length === 0) continue;
                
                // Ëé∑ÂèñËÅäÂ§©ÂØπË±°ÁöÑÂêçÁß∞
                let chatName = 'Êú™Áü•ËÅäÂ§©';
                let chatType = 'ÂçïËÅä';
                
                // Êü•ÊâæÂçïËÅäËßíËâ≤
                const character = characters.find(c => c.id === chatId);
                if (character) {
                    chatName = character.name;
                    chatType = 'ÂçïËÅä';
                } else {
                    // Êü•ÊâæÁæ§ËÅä
                    const group = groupChats.find(g => g.id === chatId);
                    if (group) {
                        chatName = group.name;
                        chatType = 'Áæ§ËÅä';
                    }
                }
                
                // ÊûÑÂª∫ËÆ∞ÂøÜÂÜÖÂÆπ
                mountedMemoryContent += `\n\n„Äê${chatType}ËÆ∞ÂøÜ - ${chatName}„Äë‰ª•‰∏ãÊòØ‰∏é${chatName}ÁöÑÊúÄËøëÂØπËØùÔºåÂèØ‰ª•‰Ωú‰∏∫ËÉåÊôØÂèÇËÄÉÔºö\n`;
                
                recentMessages.forEach(msg => {
                    let sender = '';
                    let content = msg.content || '';
                    
                    if (msg.sender === 'sent') {
                        sender = 'Áî®Êà∑';
                    } else if (msg.sender === 'received' || msg.sender === 'ai') {
                        if (chatType === 'Áæ§ËÅä' && msg.name) {
                            sender = msg.name; // Áæ§ËÅä‰∏≠ÁöÑÂèëË®ÄËÄÖÂêçÁß∞
                        } else {
                            sender = chatName; // ÂçïËÅä‰∏≠‰ΩøÁî®ËßíËâ≤ÂêçÁß∞
                        }
                    } else {
                        sender = 'Á≥ªÁªü';
                    }
                    
                    // Â§ÑÁêÜÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                    if (msg.type === 'voice_message') {
                        content = `[ËØ≠Èü≥Ê∂àÊÅØÔºö${content}]`;
                    } else if (msg.type === 'transfer') {
                        content = `[ËΩ¨Ë¥¶Ôºö${msg.amount}ÂÖÉ${msg.note ? ` - ${msg.note}` : ''}]`;
                    } else if (msg.type === 'ai_image') {
                        content = `[AIÂõæÁâáÔºö${msg.imageDescription || 'Êó†ÊèèËø∞'}]`;
                    } else if (msg.isEmoji) {
                        content = `[Ë°®ÊÉÖÂåÖÔºö${msg.emojiDescription || 'Ë°®ÊÉÖÂåÖ'}]`;
                    } else if (msg.type === 'location') {
                        content = `[‰ΩçÁΩÆÂàÜ‰∫´Ôºö${msg.locationName || '‰ΩçÁΩÆ‰ø°ÊÅØ'}]`;
                    } else if (Array.isArray(content)) {
                        // Â§ÑÁêÜÊï∞ÁªÑÁ±ªÂûãÁöÑÂÜÖÂÆπÔºàÂõæÁâá+ÊñáÂ≠óÔºâ
                        const textPart = content.find(p => p.type === 'text')?.text || '';
                        content = textPart ? `[ÂõæÁâá+ÊñáÂ≠óÔºö${textPart}]` : '[ÂõæÁâá]';
                    }
                    
                    // Á°Æ‰øùcontentÊòØÂ≠óÁ¨¶‰∏≤‰∏î‰∏ç‰∏∫Á©∫
                    if (typeof content !== 'string' || !content.trim()) {
                        content = '[ÁâπÊÆäÊ∂àÊÅØ]';
                    }
                    
                    mountedMemoryContent += `${sender}Ôºö${content}\n`;
                });
            }
            
            if (mountedMemoryContent.trim()) {
                console.log('üß† ÊàêÂäüÂä†ËΩΩÊåÇËΩΩËÆ∞ÂøÜÔºåÊ∂âÂèäËÅäÂ§©Êï∞:', chatSettings.selectedMemoryChats.length);
                return mountedMemoryContent;
            }
            
            return '';
        }
        
        // Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadGroupChats() {
            try {
                // ÂÖà‰ªéIndexedDBÂä†ËΩΩ
                const savedGroupChats = await db.groupChats.toArray();
                
                if (savedGroupChats.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('groupChats');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑÁæ§ËÅäÊï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localGroupChats = JSON.parse(localStorageData);
                        
                        if (localGroupChats.length > 0) {
                            // Á°Æ‰øùÊØè‰∏™Áæ§ËÅäÈÉΩÊúâÂøÖË¶ÅÂ≠óÊÆµ
                            const migrationData = localGroupChats.map(group => ({
                                id: group.id || Date.now().toString() + Math.random(),
                                name: group.name,
                                description: group.description || '',
                                members: group.members || [],
                                settings: group.settings || {},
                                createdAt: group.createdAt || new Date().toISOString(),
                                updatedAt: group.updatedAt || new Date().toISOString()
                            }));
                            
                            // ËøÅÁßªÂà∞IndexedDB
                            await db.groupChats.bulkAdd(migrationData);
                            groupChats = migrationData;
                            console.log('Áæ§ËÅäÊï∞ÊçÆËøÅÁßªÂÆåÊàê:', groupChats);
                        } else {
                            groupChats = [];
                        }
                    } else {
                        groupChats = [];
                    }
                } else {
                    // IndexedDB‰∏≠ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    groupChats = savedGroupChats;
                    console.log('‰ªéIndexedDBÂä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ:', groupChats);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁæ§ËÅäÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                const localStorageData = localStorage.getItem('groupChats');
                if (localStorageData) {
                    try {
                        groupChats = JSON.parse(localStorageData);
                        console.log('‰ªélocalStorageÂõûÈÄÄÂä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ:', groupChats);
                } catch (e) {
                        console.error('Áæ§ËÅäÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•:', e);
                    groupChats = [];
                }
            } else {
                groupChats = [];
                }
            }
        }
        
        // ÊòæÁ§∫ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆ
        function showHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const historyCount = chatSettings.historyCount;
            document.getElementById('history-messages-count').value = Math.min(historyCount, 100);
            document.getElementById('custom-history-count').value = historyCount;
            document.getElementById('history-count-display').textContent = historyCount + 'ÂõûÂêà';
            document.getElementById('cross-chat-memory').value = chatSettings.crossChatMemory;
            document.getElementById('cross-memory-display').textContent = chatSettings.crossChatMemory + 'Êù°';
            
            // ÁªëÂÆöÊªëÂùó‰∫ã‰ª∂
            document.getElementById('history-messages-count').oninput = function() {
                const value = parseInt(this.value);
                document.getElementById('history-count-display').textContent = value + 'ÂõûÂêà';
                document.getElementById('custom-history-count').value = value;
            };
            
            // ÁªëÂÆöËá™ÂÆö‰πâËæìÂÖ•Ê°Ü‰∫ã‰ª∂
            document.getElementById('custom-history-count').oninput = function() {
                const value = Math.max(0, Math.min(500, parseInt(this.value) || 0));
                this.value = value;
                if (value <= 100) {
                    document.getElementById('history-messages-count').value = value;
                }
                document.getElementById('history-count-display').textContent = value + 'ÂõûÂêà';
            };
            
            document.getElementById('cross-chat-memory').oninput = function() {
                document.getElementById('cross-memory-display').textContent = this.value + 'ÂõûÂêà';
            };
            
            showModal('history-settings-modal');
        }
        
        // ‰øùÂ≠òÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆ
        function saveHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const customValue = parseInt(document.getElementById('custom-history-count').value);
            chatSettings.historyCount = Math.max(0, Math.min(500, customValue || 0));
            chatSettings.crossChatMemory = parseInt(document.getElementById('cross-chat-memory').value);
            
            // Êõ¥Êñ∞ËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫ÁöÑÂΩìÂâçÂÄº
            document.getElementById('current-history-count').textContent = chatSettings.historyCount + 'ÂõûÂêà';
            
            saveCurrentChatSettings(chatSettings);
            hideModal('history-settings-modal');
            showToast('ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ÊòæÁ§∫Â§¥ÂÉèËÆæÁΩÆ
        function showAvatarSettings() {
            // Âä†ËΩΩÂΩìÂâçËÅäÂ§©Á™óÂè£ÁöÑÂ§¥ÂÉèËÆæÁΩÆ
            const chatSettings = getCurrentChatSettings();
            
            // ËÆæÁΩÆÈöêËóèÂ§¥ÂÉèÈÄâÈ°π
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                hideAvatarsCheckbox.checked = chatSettings.hideAvatars || false;
            }
            
            // ËÆæÁΩÆÊàëÁöÑÂ§¥ÂÉèÈ¢ÑËßà
            const myAvatarPreview = document.getElementById('my-chat-avatar-preview');
            if (chatSettings.myChatAvatar) {
                myAvatarPreview.style.backgroundImage = `url(${chatSettings.myChatAvatar})`;
                myAvatarPreview.style.backgroundSize = 'cover';
                myAvatarPreview.style.backgroundPosition = 'center';
                myAvatarPreview.innerHTML = '';
            } else {
                myAvatarPreview.style.backgroundImage = 'none';
                myAvatarPreview.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            // ËÆæÁΩÆÂØπÊñπÂ§¥ÂÉèÈ¢ÑËßà - ÊòæÁ§∫ÂΩìÂâçÂÆûÈôÖ‰ΩøÁî®ÁöÑÂ§¥ÂÉèÔºà‰ºòÂÖàÊòæÁ§∫Âä®ÊÄÅÂ§¥ÂÉèÔºâ
            const aiAvatarPreview = document.getElementById('ai-chat-avatar-preview');
            const currentAiAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar;
            if (currentAiAvatar) {
                aiAvatarPreview.style.backgroundImage = `url(${currentAiAvatar})`;
                aiAvatarPreview.style.backgroundSize = 'cover';
                aiAvatarPreview.style.backgroundPosition = 'center';
                aiAvatarPreview.innerHTML = '';
                
                // Â¶ÇÊûúÊòØÂä®ÊÄÅÂ§¥ÂÉèÔºåÊ∑ªÂä†ÊèêÁ§∫
                if (chatSettings.aiDynamicAvatar) {
                    aiAvatarPreview.title = 'ÂΩìÂâçÊòæÁ§∫Âä®ÊÄÅÂ§¥ÂÉèÔºàËßíËâ≤Âú®ËÅäÂ§©‰∏≠Êõ¥Êç¢ÁöÑÔºâ';
                } else {
                    aiAvatarPreview.title = 'ÂΩìÂâçÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆÂ§¥ÂÉè';
                }
            } else {
                aiAvatarPreview.style.backgroundImage = 'none';
                aiAvatarPreview.innerHTML = '<i class="fas fa-robot"></i>';
                aiAvatarPreview.title = '‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè';
            }
            
            // ÁªëÂÆöÊñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
            bindAvatarUploadEvents();
            
            showModal('avatar-settings-modal');
        }
        
        // ÊòæÁ§∫ÊòµÁß∞ËÆæÁΩÆ
        function showNicknameSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-chat-nickname').value = chatSettings.myChatNickname || '';
            document.getElementById('ai-chat-nickname').value = chatSettings.aiChatNickname || '';
            showModal('nickname-settings-modal');
        }
        
        // ÊòæÁ§∫Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ
        function showPokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-poke-suffix').value = chatSettings.myPokeSuffix || '';
            document.getElementById('ai-poke-suffix').value = chatSettings.aiPokeSuffix || '';
            showModal('poke-suffix-modal');
        }
        
        // ÊòæÁ§∫ËÅäÂ§©ËÉåÊôØËÆæÁΩÆ
        function showBackgroundSettings() {
            const backgroundPreview = document.getElementById('chat-background-preview');
            
            // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ
            window.selectedChatBackground = undefined;
            
            // ‰ΩøÁî®currentChatCharacter.backgroundËÄå‰∏çÊòØchatSettings.chatBackground
            if (currentChatCharacter && currentChatCharacter.background) {
                backgroundPreview.style.backgroundImage = `url(${currentChatCharacter.background})`;
                backgroundPreview.style.backgroundSize = 'cover';
                backgroundPreview.style.backgroundPosition = 'center';
                backgroundPreview.querySelector('.preview-text').style.display = 'none';
            } else {
                backgroundPreview.style.backgroundImage = 'none';
                backgroundPreview.querySelector('.preview-text').style.display = 'block';
                backgroundPreview.querySelector('.preview-text').textContent = 'ËÉåÊôØÈ¢ÑËßà';
            }
            
            // ÁªëÂÆöËÉåÊôØ‰∏ä‰º†‰∫ã‰ª∂
            document.getElementById('background-upload').onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        backgroundPreview.style.backgroundImage = `url(${event.target.result})`;
                        backgroundPreview.style.backgroundSize = 'cover';
                        backgroundPreview.style.backgroundPosition = 'center';
                        backgroundPreview.querySelector('.preview-text').style.display = 'none';
                        window.selectedChatBackground = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };
            
            showModal('background-settings-modal');
        }
        
        // ÊòæÁ§∫Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ
        function showBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•ÊòØÂê¶‰∏∫Áæ§ËÅäÔºåÊòæÁ§∫/ÈöêËóèÁæ§ÊàêÂëòËÆæÁΩÆÊåâÈíÆ
            const groupColorsBtn = document.getElementById('group-member-colors-btn');
            if (currentChatCharacter && currentChatCharacter.isGroup) {
                groupColorsBtn.style.display = 'block';
            } else {
                groupColorsBtn.style.display = 'none';
            }
            
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            const currentStyle = chatSettings.bubbleStyle || 'default';
            document.getElementById('my-bubble-color').value = chatSettings.myBubbleColor || '#007AFF';
            document.getElementById('ai-bubble-color').value = chatSettings.aiBubbleColor || '#f0f0f0';
            
            // Âä†ËΩΩÂàÜÁ¶ªÁöÑÈÄèÊòéÂ∫¶ËÆæÁΩÆ
            document.getElementById('my-bubble-opacity').value = chatSettings.myBubbleOpacity || '1';
            document.getElementById('my-bubble-opacity-value').textContent = Math.round((chatSettings.myBubbleOpacity || 1) * 100) + '%';
            document.getElementById('ai-bubble-opacity').value = chatSettings.aiBubbleOpacity || '1';
            document.getElementById('ai-bubble-opacity-value').textContent = Math.round((chatSettings.aiBubbleOpacity || 1) * 100) + '%';
            
            // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ†∑Âºè
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.style === currentStyle) {
                    option.classList.add('selected');
                }
            });
            
            // ÁªëÂÆöÊ†∑ÂºèÈÄâÊã©‰∫ã‰ª∂
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.onclick = function() {
                    document.querySelectorAll('.bubble-style-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedBubbleStyle = this.dataset.style;
                };
            });
            
            // ÁªëÂÆöÂàÜÁ¶ªÁöÑÈÄèÊòéÂ∫¶‰∫ã‰ª∂
            document.getElementById('my-bubble-opacity').oninput = function() {
                document.getElementById('my-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
            };
            
            document.getElementById('ai-bubble-opacity').oninput = function() {
                document.getElementById('ai-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
            };
            
            // Âä†ËΩΩÊ∞îÊ≥°Â§ßÂ∞èËÆæÁΩÆ
            document.getElementById('bubble-padding').value = chatSettings.bubblePadding || '12';
            updatePaddingValue(chatSettings.bubblePadding || '12');
            
            // ÁªëÂÆöÊ∞îÊ≥°Â§ßÂ∞è‰∫ã‰ª∂
            document.getElementById('bubble-padding').oninput = function() {
                updatePaddingValue(this.value);
            };
            
            window.selectedBubbleStyle = currentStyle;
            showModal('bubble-style-modal');
        }
        
        // ÊòæÁ§∫ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ
        function showScheduleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            document.getElementById('schedule-enabled').checked = chatSettings.scheduleEnabled || false;
            document.getElementById('schedule-enabled').onchange = function() {
                document.getElementById('schedule-times-group').style.display = this.checked ? 'block' : 'none';
            };
            
            // Ëß¶Âèë‰∏ÄÊ¨°ÊòæÁ§∫Áä∂ÊÄÅÊõ¥Êñ∞
            document.getElementById('schedule-times-group').style.display = 
                document.getElementById('schedule-enabled').checked ? 'block' : 'none';
            
            // Âä†ËΩΩÂ∑≤ÊúâÁöÑÊó∂Èó¥ÁÇπ
            renderScheduleTimes();
            
            showModal('schedule-settings-modal');
        }
        
        // ÂºÇÊ≠•ÂáΩÊï∞ÔºåÁî®‰∫éËé∑ÂèñËÅäÂ§©Á™óÂè£ÁöÑ‰∏ìÂ±ûËÆæÁΩÆ
        async function getAsyncChatSettings(characterId = null) {
            // 1. Á°ÆÂÆö‰ΩøÁî®Âì™‰∏™ËßíËâ≤ID
            const chatId = characterId || (currentChatCharacter ? currentChatCharacter.id : null);
            
            if (!chatId) {
                console.warn("Êó†Ê≥ïËé∑ÂèñËÆæÁΩÆÔºöcharacterId Âíå currentChatCharacter ÈÉΩÊú™ÂÆö‰πâÔºåËøîÂõûÁ©∫ËÆæÁΩÆ");
                return {
                    historyCount: 30,
                    timestampEnabled: true,
                    timestampPosition: 'center',
                    bubbleStyle: 'default',
                    characterStatusEnabled: false
                };
            }
            
            // 2. „ÄêÊÄßËÉΩ‰ºòÂåñ„ÄëÈ¶ñÂÖàÊ£ÄÊü•ÂÜÖÂ≠ò‰∏≠ÊòØÂê¶Â∑≤ÊúâËØ•ËÅäÂ§©ÁöÑËÆæÁΩÆ
            if (chatSettings[chatId]) {
                return chatSettings[chatId];
            }
            
            // 3. „ÄêÊ†∏ÂøÉÈÄªËæë„ÄëÂ¶ÇÊûúÂÜÖÂ≠ò‰∏≠Ê≤°ÊúâÔºåÂàô‰ªé IndexedDB Êï∞ÊçÆÂ∫ìÂºÇÊ≠•Êü•ËØ¢
                try {
                    const dbSettings = await db.chatSettings.get(chatId);
                    if (dbSettings && dbSettings.settings) {
                    // Êü•Âà∞‰∫ÜÔºÅÂ≠òÂÖ•ÂÜÖÂ≠òÂπ∂ËøîÂõû
                    console.log(`‚úÖ ‰ªéÊï∞ÊçÆÂ∫ìÊàêÂäüÂä†ËΩΩID‰∏∫ ${chatId} ÁöÑËÆæÁΩÆ`);
                        chatSettings[chatId] = dbSettings.settings;
                    return dbSettings.settings;
                    }
                } catch (error) {
                console.error(`‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩID‰∏∫ ${chatId} ÁöÑËÆæÁΩÆÂ§±Ë¥•:`, error);
                // Âç≥‰ΩøÊï∞ÊçÆÂ∫ìÊü•ËØ¢Â§±Ë¥•Ôºå‰πüË¶ÅÁªßÁª≠ÊâßË°åÔºåÂ∞ùËØïÂàõÂª∫ÈªòËÆ§ËÆæÁΩÆ
            }

            // 4. „ÄêÂ§ÑÁêÜÊñ∞ËÅäÂ§©„ÄëÂ¶ÇÊûúÊï∞ÊçÆÂ∫ìÈáå‰πüÊ≤°ÊúâÔºåËØ¥ÊòéËøôÊòØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑËÅäÂ§©Á™óÂè£
            console.log(`üîß ID‰∏∫ ${chatId} ÁöÑËÅäÂ§©Êó†ÂéÜÂè≤ËÆæÁΩÆÔºåÊ≠£Âú®ÂàõÂª∫ÈªòËÆ§ËÆæÁΩÆ...`);
            
            // ÂÆö‰πâ‰∏Ä‰ªΩÂπ≤ÂáÄÁöÑÈªòËÆ§ËÆæÁΩÆ
            const defaultSettings = {
                        // ËÆ∞ÂøÜÁõ∏ÂÖ≥ËÆæÁΩÆÔºàÂéüÊú¨ÁöÑÂÖ®Â±ÄËÆæÁΩÆÊîπ‰∏∫ÊØè‰∏™ËÅäÂ§©Áã¨Á´ãÔºâ
                historyCount: 30,
                        crossChatMemory: 3,
                        enableDynamicMemory: true,
                        enableMusicMemory: true,
                        memoryMountEnabled: false,
                        memoryMountCount: 3,
                        selectedMemoryChats: [],
                        // Êó∂Èó¥ÊÑüÁü•ËÆæÁΩÆ
                        timeAwarenessEnabled: true,
                        // ÈÄöËØùËÆæÁΩÆ
                        aiCallEnabled: true,
                        // ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
                        aiHeartrateEnabled: false,
                        // Á§æ‰∫§Âä®ÊÄÅËÆæÁΩÆ
                        socialEnabled: false,
                        socialFrequency: 'medium',
                        // ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
                        backgroundInteractionEnabled: false,
                        backgroundChatEnabled: true,
                        backgroundMomentsEnabled: true,
                        backgroundChatFrequency: 'low',
                        backgroundMomentsFrequency: 'low',
                        scheduledMomentsEnabled: false,
                        scheduledMomentsTimes: [],
                        // ÂÖ∂‰ªñÂéüÊúâËÆæÁΩÆ
                        timestampEnabled: true,
                timestampPosition: 'center',
                characterStatusEnabled: false,
                        // üî•„ÄêÊñ∞Â¢û„ÄëÁä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáËÆæÁΩÆ
                        statusUpdateFrequency: 'medium' 
            };

            // 5. Â∞ÜÊñ∞ÂàõÂª∫ÁöÑÈªòËÆ§ËÆæÁΩÆÂ≠òÂÖ•ÂÜÖÂ≠ò
            chatSettings[chatId] = defaultSettings;

            // 6. „ÄêÈáçË¶Å„ÄëÂêåÊó∂ÔºåÁ´ãÂç≥Â∞ÜËøô‰ªΩÈªòËÆ§ËÆæÁΩÆ‰øùÂ≠òÂõûÊï∞ÊçÆÂ∫ìÔºå‰∏∫Ëøô‰∏™Êñ∞ËÅäÂ§©Âª∫Á´ãÊ°£Ê°à
            try {
                await db.chatSettings.put({
                    id: chatId,
                    chatId: chatId,
                    settings: defaultSettings
                });
                console.log(`‚úÖ Â∑≤‰∏∫Êñ∞ËÅäÂ§© ${chatId} Âú®Êï∞ÊçÆÂ∫ì‰∏≠ÂàõÂª∫‰∫ÜÈªòËÆ§ËÆæÁΩÆÊ°£Ê°à`);
                } catch (error) {
                console.error(`‰∏∫Êñ∞ËÅäÂ§© ${chatId} ‰øùÂ≠òÈªòËÆ§ËÆæÁΩÆÂ§±Ë¥•:`, error);
            }
            
            // 7. ËøîÂõûËøô‰ªΩÂÖ®Êñ∞ÁöÑÈªòËÆ§ËÆæÁΩÆ
            return defaultSettings;
        }
        
        // ÂÖºÂÆπÂ±Ç - ÂêåÊ≠•ÁâàÊú¨ÁöÑgetCurrentChatSettings
        // Ê≥®ÊÑèÔºöËøô‰∏™ÂáΩÊï∞Âè™‰ºöËøîÂõûÂÜÖÂ≠ò‰∏≠ÁöÑËÆæÁΩÆÊàñÈªòËÆ§ËÆæÁΩÆÔºå‰∏ç‰ºö‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩ
        // Áî®‰∫é‰∏çÊñπ‰æø‰øÆÊîπ‰∏∫async/awaitÁöÑÂú∞Êñπ
        function getCurrentChatSettings() {
            if (!currentChatCharacter) return {};
            
            const chatId = currentChatCharacter.id;
            
            // Â¶ÇÊûúÂÜÖÂ≠ò‰∏≠ÊúâËÆæÁΩÆÔºåÁõ¥Êé•ËøîÂõû
            if (chatSettings[chatId]) {
                return chatSettings[chatId];
            }
            
            // Â¶ÇÊûúÂÜÖÂ≠ò‰∏≠Ê≤°ÊúâÔºåÂàõÂª∫‰∏Ä‰∏™ÈªòËÆ§ËÆæÁΩÆ
            // Ê≥®ÊÑèÔºöËøôÈáå‰∏ç‰ºö‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÂè™ÊòØ‰∏¥Êó∂‰ΩøÁî®
            // ‰∏ãÊ¨°Ë∞ÉÁî®ÂºÇÊ≠•ÁâàÊú¨ÁöÑgetCurrentChatSettingsÊó∂‰ºöÊ≠£Á°ÆÂä†ËΩΩ/ÂàõÂª∫ËÆæÁΩÆ
            console.warn(`‚ö†Ô∏è ‰ΩøÁî®‰∫ÜÂêåÊ≠•ÁâàÊú¨Ëé∑ÂèñID‰∏∫ ${chatId} ÁöÑËÆæÁΩÆÔºå‰ΩÜÂÜÖÂ≠ò‰∏≠Ê≤°ÊúâÁºìÂ≠òÔºåËøîÂõû‰∏¥Êó∂ÈªòËÆ§ËÆæÁΩÆ`);
            
            const defaultSettings = {
                historyCount: 30,
                crossChatMemory: 3,
                enableDynamicMemory: true,
                enableMusicMemory: true,
                memoryMountEnabled: false,
                memoryMountCount: 3,
                selectedMemoryChats: [],
                timeAwarenessEnabled: true,
                aiCallEnabled: true,
                aiHeartrateEnabled: false,
                characterStatusEnabled: false,
                socialEnabled: false,
                socialFrequency: 'medium',
                backgroundInteractionEnabled: false,
                backgroundChatEnabled: true,
                backgroundMomentsEnabled: true,
                backgroundChatFrequency: 'low',
                backgroundMomentsFrequency: 'low',
                scheduledMomentsEnabled: false,
                scheduledMomentsTimes: [],
                timestampEnabled: true,
                timestampPosition: 'center',
                aiHeartrateEnabled: false,
                // üî•„ÄêÊñ∞Â¢û„ÄëÁä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáËÆæÁΩÆ
                statusUpdateFrequency: 'medium'
            };
            
            // ÂêåÊó∂Ëß¶Âèë‰∏Ä‰∏™ÂºÇÊ≠•Âä†ËΩΩÔºå‰ª•‰æøÂêéÁª≠‰ΩøÁî®
            getAsyncChatSettings().then(settings => {
                console.log(`‚úÖ ÂêéÂè∞ÂºÇÊ≠•Âä†ËΩΩID‰∏∫ ${chatId} ÁöÑËÆæÁΩÆÂÆåÊàê`);
            }).catch(error => {
                console.error(`ÂêéÂè∞ÂºÇÊ≠•Âä†ËΩΩID‰∏∫ ${chatId} ÁöÑËÆæÁΩÆÂ§±Ë¥•:`, error);
            });
            
            return defaultSettings;
        }
        
        // ‰øùÂ≠òÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆ - ‰ΩøÁî®IndexedDBÈÅøÂÖçÂ≠òÂÇ®ÈôêÂà∂
        async function saveCurrentChatSettings(settings) {
            if (!currentChatCharacter) return;
            
            const chatId = currentChatCharacter.id;
            
            // üî•„Äê‰øÆÂ§ç„ÄëÂêåÊ≠•Êõ¥Êñ∞ÂÖ®Â±ÄchatSettings
            chatSettings[chatId] = settings;
            
            try {
                // ‰øùÂ≠òÂà∞IndexedDB
                await db.chatSettings.put({
                    id: chatId,
                    chatId: chatId,
                    settings: settings
                });
                
                console.log('ËÅäÂ§©ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞IndexedDB');
                
                // üî•„ÄêÂéãÁº©Â§á‰ªΩ„ÄëÂè™‰øùÂ≠òÈáçË¶ÅËÆæÁΩÆÂà∞localStorage‰Ωú‰∏∫Â§á‰ªΩ
                const compressedSettings = {
                    // Âè™‰øùÂ≠òÊúÄÈáçË¶ÅÁöÑËÆæÁΩÆÔºåÂáèÂ∞ëÂ≠òÂÇ®Âç†Áî®
                    // Ê≥®ÊÑèÔºöÂ§¥ÂÉèÊï∞ÊçÆ‰∏çÊà™Êñ≠ÔºåÂõ†‰∏∫‰ºöÂØºËá¥Êó†ÊïàURL
                    selectedIdentityId: settings.selectedIdentityId, // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë‰øùÂ≠òË∫´‰ªΩÈÄâÊã©
                    aiChatAvatar: settings.aiChatAvatar,
                    myChatAvatar: settings.myChatAvatar,
                    aiDynamicAvatar: settings.aiDynamicAvatar,
                    aiChatNickname: settings.aiChatNickname,
                    myChatNickname: settings.myChatNickname,
                    hideAvatars: settings.hideAvatars,
                    bubbleStyle: settings.bubbleStyle,
                    timestampEnabled: settings.timestampEnabled,
                    timestampPosition: settings.timestampPosition
                };
                
                // ÁßªÈô§undefinedÂÄº
                Object.keys(compressedSettings).forEach(key => {
                    if (compressedSettings[key] === undefined) {
                        delete compressedSettings[key];
                    }
                });
                
                localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(compressedSettings));
                
            } catch (error) {
                console.error('‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆÂà∞IndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØïlocalStorage:', error);
                
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰øùÂ≠òÂéãÁº©ÁâàÊú¨Âà∞localStorage
                try {
                    const essentialSettings = {
                        selectedIdentityId: settings.selectedIdentityId, // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë‰øùÂ≠òË∫´‰ªΩÈÄâÊã©
                        aiChatNickname: settings.aiChatNickname,
                        myChatNickname: settings.myChatNickname,
                        hideAvatars: settings.hideAvatars,
                        bubbleStyle: settings.bubbleStyle,
                        timestampEnabled: settings.timestampEnabled,
                        timestampPosition: settings.timestampPosition
                    };
                    
                    localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(essentialSettings));
                    console.log('ÈáçË¶ÅËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞localStorage');
                    
                } catch (localError) {
                    console.error('localStorage‰πüÂ≠òÂÇ®Â§±Ë¥•:', localError);
                    alert('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºÅËØ∑Ê∏ÖÁêÜÊµèËßàÂô®Êï∞ÊçÆÊàñÂà†Èô§‰∏Ä‰∫õËÅäÂ§©ËÆ∞ÂΩïÂêéÈáçËØï„ÄÇ');
                }
            }
        }
        
        // ‰øùÂ≠òËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ
        async function saveChatModeSettings() {
            if (!currentChatCharacter) return;
            
            const chatSettings = await getAsyncChatSettings();
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÅäÂ§©Ê®°Âºè
            const onlineRadio = document.getElementById('chat-mode-online');
            const offlineRadio = document.getElementById('chat-mode-offline');
            
            if (onlineRadio && offlineRadio) {
                chatSettings.chatMode = onlineRadio.checked ? 'online' : 'offline';
            }
            
            // Ëé∑ÂèñÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂
            const maxLengthInput = document.getElementById('offline-mode-max-length');
            if (maxLengthInput) {
                chatSettings.offlineModeMaxLength = parseInt(maxLengthInput.value) || 100;
            }
            
            await saveCurrentChatSettings(chatSettings);
        }
        
        // ÊòæÁ§∫ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ
        async function showMemoryMountSettings() {
            const chatSettings = await getAsyncChatSettings();
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            document.getElementById('memory-mount-enabled').checked = chatSettings.memoryMountEnabled || false;
            document.getElementById('memory-mount-count').value = chatSettings.memoryMountCount || 3;
            document.getElementById('memory-mount-display').textContent = (chatSettings.memoryMountCount || 3) + 'Êù°';
            
            // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÁöÑÊòæÁ§∫
            toggleMemoryMountDetails();
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('memory-mount-enabled').onchange = toggleMemoryMountDetails;
            document.getElementById('memory-mount-count').oninput = function() {
                document.getElementById('memory-mount-display').textContent = this.value + 'Êù°';
            };
            
            // Ê∏≤ÊüìËÅäÂ§©ÂàóË°®
            renderMemoryMountChatList();
            
            showModal('memory-mount-modal');
        }
        
        // ÂàáÊç¢ËÆ∞ÂøÜÊåÇËΩΩËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
        function toggleMemoryMountDetails() {
            const enabled = document.getElementById('memory-mount-enabled').checked;
            document.getElementById('memory-mount-details').style.display = enabled ? 'block' : 'none';
            document.getElementById('memory-mount-chats').style.display = enabled ? 'block' : 'none';
            
            // Êõ¥Êñ∞‰∏ªËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫
            document.getElementById('current-memory-mount').textContent = enabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
        }
        
        // Ê∏≤ÊüìËÆ∞ÂøÜÊåÇËΩΩËÅäÂ§©ÂàóË°®
        async function renderMemoryMountChatList() {
            const container = document.getElementById('memory-mount-list');
            container.innerHTML = '';
            
            if (characters.length === 0 && groupChats.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">ÊöÇÊó†ÂèØÊåÇËΩΩÁöÑËÅäÂ§©</p>';
                return;
            }
            
            // Ê∑ªÂä†Âçï‰∫∫ËÅäÂ§©
            characters.forEach(character => {
                if (currentChatCharacter && character.id === currentChatCharacter.id) return; // ‰∏çÊòæÁ§∫ÂΩìÂâçËÅäÂ§©
                
                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${character.id}" value="${character.id}" class="mount-checkbox">
                    <div class="mount-avatar-small" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''} display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div>
                        <div class="mount-name">${character.name}</div>
                        <div class="mount-type">ÂçïËÅä</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // Ê∑ªÂä†Áæ§ËÅä
            groupChats.forEach(group => {
                if (currentChatCharacter && group.id === currentChatCharacter.id) return; // ‰∏çÊòæÁ§∫ÂΩìÂâçËÅäÂ§©
                
                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${group.id}" value="${group.id}" class="mount-checkbox">
                    <div class="mount-avatar-group">
                        Áæ§
                    </div>
                    <div>
                        <div class="mount-name">${group.name}</div>
                                                    <div class="mount-type">Áæ§ËÅä (${group.members ? group.members.length + 1 : 1}‰∫∫)</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // Âä†ËΩΩÂ∑≤ÈÄâÊã©ÁöÑËÅäÂ§©
            const chatSettings = await getAsyncChatSettings();
            const selectedChats = chatSettings.selectedMemoryChats || [];
            selectedChats.forEach(chatId => {
                const checkbox = document.getElementById(`mount-${chatId}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        // ‰øùÂ≠òËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ
        async function saveMemoryMountSettings() {
            const chatSettings = await getAsyncChatSettings();
            chatSettings.memoryMountEnabled = document.getElementById('memory-mount-enabled').checked;
            chatSettings.memoryMountCount = parseInt(document.getElementById('memory-mount-count').value);
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÅäÂ§©
            const checkboxes = document.querySelectorAll('#memory-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedMemoryChats = Array.from(checkboxes).map(cb => cb.value);
            
            // Êõ¥Êñ∞‰∏ªËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫
            document.getElementById('current-memory-mount').textContent = chatSettings.memoryMountEnabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('memory-mount-modal');
            showToast('ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ‰øùÂ≠òËÅäÂ§©Â§¥ÂÉèËÆæÁΩÆ
        async function saveChatAvatarSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÈöêËóèÂ§¥ÂÉèËÆæÁΩÆ
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                chatSettings.hideAvatars = hideAvatarsCheckbox.checked;
            }
            
            // üî•„ÄêÂéãÁº©Â§¥ÂÉè„ÄëÂú®‰øùÂ≠òÂâçÂéãÁº©Â§¥ÂÉèÊï∞ÊçÆ
            if (window.selectedMyChatAvatar) {
                chatSettings.myChatAvatar = await compressImage(window.selectedMyChatAvatar, 200, 0.7);
            }
            if (window.selectedAiChatAvatar) {
                chatSettings.aiChatAvatar = await compressImage(window.selectedAiChatAvatar, 200, 0.7);
            }
            
            try {
                await saveCurrentChatSettings(chatSettings);
                hideModal('avatar-settings-modal');
                
                // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰ª•ÊòæÁ§∫Êñ∞Â§¥ÂÉè
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                showToast('Â§¥ÂÉèËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
            } catch (error) {
                console.error('‰øùÂ≠òÂ§¥ÂÉèËÆæÁΩÆÂ§±Ë¥•:', error);
                showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåÂ≠òÂÇ®Á©∫Èó¥ÂèØËÉΩ‰∏çË∂≥', 'error');
            }
        }
        
        // ‰øùÂ≠òÊòµÁß∞ËÆæÁΩÆ
        async function saveChatNicknameSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.myChatNickname = document.getElementById('my-chat-nickname').value.trim();
            chatSettings.aiChatNickname = document.getElementById('ai-chat-nickname').value.trim();
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('nickname-settings-modal');
            
            // Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢Ê†áÈ¢ò
            if (currentChatCharacter) {
                const displayTitle = chatSettings.aiChatNickname || currentChatCharacter.name;
                document.getElementById('api-chat-title').textContent = displayTitle;
            }
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            // üî•„Äê‰øÆÂ§ç„ÄëÂà∑Êñ∞Ê∂àÊÅØÂàóË°®ÂíåËÅîÁ≥ª‰∫∫ÂàóË°®‰ª•ÊòæÁ§∫Êñ∞ÊòµÁß∞
            renderMessageList();
            renderContactList();
            
            showToast('ÊòµÁß∞ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ‰øùÂ≠òÊà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ
        async function savePokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.myPokeSuffix = document.getElementById('my-poke-suffix').value.trim();
            chatSettings.aiPokeSuffix = document.getElementById('ai-poke-suffix').value.trim();
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('poke-suffix-modal');
            showToast('Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ‰øùÂ≠òËÅäÂ§©ËÉåÊôØËÆæÁΩÆ
        async function saveChatBackgroundSettings() {
    // 1. Á°Æ‰øùÊúâÂΩìÂâçËÅäÂ§©ËßíËâ≤
    if (!currentChatCharacter) return;
            
    // 2. Ê†πÊçÆÁî®Êà∑ÁöÑÊìç‰ΩúÊõ¥Êñ∞ËÉåÊôØËÆæÁΩÆ
    // window.selectedChatBackground Âú®‰Ω†ÈÄâÊã©ÊàñÁßªÈô§ËÉåÊôØÊó∂Ë¢´ËµãÂÄº
    let backgroundToApply;
    
            if (window.selectedChatBackground === null) {
        // Áî®Êà∑ÁÇπÂáª‰∫Ü"ÁßªÈô§ËÉåÊôØ"
        backgroundToApply = null;
            } else if (window.selectedChatBackground) {
        // Áî®Êà∑ÈÄâÊã©‰∫ÜÊñ∞ËÉåÊôØ
        backgroundToApply = await compressImage(window.selectedChatBackground, 800, 0.8);
    } else {
        // Áî®Êà∑Ê≤°ÂÅö‰ªª‰ΩïÊõ¥ÊîπÔºå‰øùÊåÅÂéüÊúâËÆæÁΩÆ‰∏çÂèò
        backgroundToApply = currentChatCharacter.background;
    }

    // 3. [ÂÖ≥ÈîÆ] Á´ãÂç≥Â∫îÁî®ËÉåÊôØËÆæÁΩÆÔºåËøô‰ºöËá™Âä®Êõ¥Êñ∞currentChatCharacter.backgroundÂπ∂‰øùÂ≠ò
    await applyChatBackground(backgroundToApply);
    
    // 4. Ê∏ÖÁêÜÂπ∂ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    hideModal('background-settings-modal');
    window.selectedChatBackground = undefined; // Ê∏ÖÁêÜ‰∏¥Êó∂ÂèòÈáè
            showToast('ËÅäÂ§©ËÉåÊôØËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ÁßªÈô§ËÉåÊôØ
        function removeBackground() {
            const backgroundPreview = document.getElementById('chat-background-preview');
            backgroundPreview.style.backgroundImage = 'none';
            backgroundPreview.querySelector('.preview-text').style.display = 'block';
            backgroundPreview.querySelector('.preview-text').textContent = 'Â∑≤ÁßªÈô§ËÉåÊôØ';
            window.selectedChatBackground = null;
        }

        // Êõ¥Êñ∞Ê∞îÊ≥°Â§ßÂ∞èÊòæÁ§∫ÂÄº
        function updatePaddingValue(value) {
            const paddingValue = document.getElementById('bubble-padding-value');
            if (paddingValue) {
                if (value <= 6) {
                    paddingValue.textContent = 'Ë∂ÖÁ¥ßÂáë';
                } else if (value <= 10) {
                    paddingValue.textContent = 'Á¥ßÂáë';
                } else if (value <= 14) {
                    paddingValue.textContent = '‰∏≠Á≠â';
                } else {
                    paddingValue.textContent = 'ÂÆΩÊùæ';
                }
            }
        }

        // ‰øùÂ≠òÊ∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ
        async function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÊ†∑ÂºèÈÄâÊã©
            if (window.selectedBubbleStyle) {
                chatSettings.bubbleStyle = window.selectedBubbleStyle;
            }
            
            // ‰øùÂ≠òÈ¢úËâ≤ËÆæÁΩÆ
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;
            
            // ‰øùÂ≠òÂàÜÁ¶ªÁöÑÈÄèÊòéÂ∫¶ËÆæÁΩÆ
            chatSettings.myBubbleOpacity = document.getElementById('my-bubble-opacity').value;
            chatSettings.aiBubbleOpacity = document.getElementById('ai-bubble-opacity').value;
            
            // ‰øùÂ≠òÊ∞îÊ≥°Â§ßÂ∞èËÆæÁΩÆ
            chatSettings.bubblePadding = document.getElementById('bubble-padding').value;
            
            await saveCurrentChatSettings(chatSettings);
            
            // üî•„Äê‰øÆÂ§ç„ÄëÁ´ãÂç≥Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑ÂºèÊòæÁ§∫
            updateBubbleStyleDisplay();
            
            hideModal('bubble-style-modal');
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰ª•Â∫îÁî®Êñ∞ËÆæÁΩÆ
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            showToast('Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }

        // ÊòæÁ§∫Êó∂Èó¥Êà≥ËÆæÁΩÆ
        function showTimestampSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ËÆæÁΩÆÊó∂Èó¥Êà≥ÂºÄÂÖ≥Áä∂ÊÄÅ
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                timestampEnabled.checked = chatSettings.timestampEnabled !== false; // ÈªòËÆ§‰∏∫true
            }
            
            // ËÆæÁΩÆÊó∂Èó¥Êà≥‰ΩçÁΩÆÈÄâÈ°π
            const timestampPosition = chatSettings.timestampPosition || 'center';
            const positionRadios = document.querySelectorAll('input[name="timestamp-position"]');
            positionRadios.forEach(radio => {
                radio.checked = radio.value === timestampPosition;
            });
            
            // ÁªëÂÆöÊó∂Èó¥Êà≥ÂºÄÂÖ≥ÂèòÂåñ‰∫ã‰ª∂
            if (timestampEnabled) {
                timestampEnabled.onchange = function() {
                    const optionsGroup = document.getElementById('timestamp-options-group');
                    if (optionsGroup) {
                        optionsGroup.style.display = this.checked ? 'block' : 'none';
                    }
                };
                
                // Ëß¶Âèë‰∏ÄÊ¨°ÊòæÁ§∫Áä∂ÊÄÅÊõ¥Êñ∞
                const optionsGroup = document.getElementById('timestamp-options-group');
                if (optionsGroup) {
                    optionsGroup.style.display = timestampEnabled.checked ? 'block' : 'none';
                }
            }
            
            showModal('timestamp-settings-modal');
        }

        // ‰øùÂ≠òÊó∂Èó¥Êà≥ËÆæÁΩÆ
        async function saveTimestampSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Ëé∑ÂèñÊó∂Èó¥Êà≥ÂºÄÂÖ≥Áä∂ÊÄÅ
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                chatSettings.timestampEnabled = timestampEnabled.checked;
            }
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊó∂Èó¥Êà≥‰ΩçÁΩÆ
            const selectedPosition = document.querySelector('input[name="timestamp-position"]:checked');
            if (selectedPosition) {
                chatSettings.timestampPosition = selectedPosition.value;
            }
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('timestamp-settings-modal');
            
            // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ‰ª•Â∫îÁî®Êñ∞ÁöÑÊó∂Èó¥Êà≥ËÆæÁΩÆ
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            showToast('Êó∂Èó¥Êà≥ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÁæ§ÊàêÂëòÊ∞îÊ≥°È¢úËâ≤ËÆæÁΩÆÂäüËÉΩ
        function showGroupMemberColorSettings() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) {
                showToast('Âè™ÊúâÁæ§ËÅäÂèØ‰ª•ËÆæÁΩÆÊàêÂëòÊ∞îÊ≥°È¢úËâ≤', 'warning');
                return;
            }
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂÖàÂÖ≥Èó≠Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÁ™óÂè£ÔºåÈÅøÂÖçÂ±ÇÁ∫ßÈÅÆÊå°
            hideModal('bubble-style-modal');
            
            const container = document.getElementById('group-member-colors-list');
            container.innerHTML = '';
            
            const chatSettings = getCurrentChatSettings();
            const memberColors = chatSettings.memberBubbleColors || {};
            
            // Ëé∑ÂèñÁæ§ÊàêÂëòÂàóË°®
            const group = groupChats.find(g => g.id === currentChatCharacter.id);
            console.log('ÂΩìÂâçÁæ§ËÅä:', currentChatCharacter);
            console.log('ÊâæÂà∞ÁöÑÁæ§ËÅä:', group);
            console.log('Áæ§ËÅäÊàêÂëò:', group?.members);
            
            if (!group || !group.members || group.members.length === 0) {
                container.innerHTML = '<p class="text-center-gray">ËØ•Áæ§ËÅäÊöÇÊó†ÊàêÂëò„ÄÇËØ∑ÂÖàÂú®Áæ§ËÅä‰ø°ÊÅØ‰∏≠Ê∑ªÂä†ÊàêÂëò„ÄÇ</p>';
                showModal('group-member-colors-modal');
                return;
            }
            
            // ‰∏∫ÊØè‰∏™Áæ§ÊàêÂëòÂàõÂª∫È¢úËâ≤ËÆæÁΩÆÈ°π
            group.members.forEach(member => {
                // ÂÖºÂÆπ‰∏çÂêåÁöÑÊàêÂëòÊï∞ÊçÆÁªìÊûÑ
                const memberId = typeof member === 'string' ? member : member.id;
                const character = characters.find(c => c.id === memberId);
                if (!character) {
                    console.log('Êâæ‰∏çÂà∞ËßíËâ≤:', memberId, 'ÊâÄÊúâËßíËâ≤:', characters.map(c => ({id: c.id, name: c.name})));
                    return;
                }
                
                const memberColor = memberColors[memberId] || '#f0f0f0';
                
                const memberItem = document.createElement('div');
                memberItem.className = 'setting-item';
                memberItem.innerHTML = `
                    <div class="setting-left">
                        <div class="setting-label" style="display: flex; align-items: center; gap: 8px;">
                            <div class="character-avatar" style="width: 24px; height: 24px; background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''} display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; border-radius: 50%;">
                                ${character.avatarUrl ? '' : character.name.charAt(0)}
                            </div>
                            ${character.name}
                        </div>
                        <div class="setting-desc">ËÆæÁΩÆ ${character.name} ÁöÑ‰∏ìÂ±ûÊ∞îÊ≥°È¢úËâ≤</div>
                    </div>
                    <div class="setting-right">
                        <input type="color" id="member-color-${memberId}" class="color-input" value="${memberColor}" style="width: 40px; height: 30px;">
                    </div>
                `;
                
                container.appendChild(memberItem);
            });
            
            showModal('group-member-colors-modal');
        }
        
        function saveGroupMemberColors() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.memberBubbleColors) {
                chatSettings.memberBubbleColors = {};
            }
            
            // Ëé∑ÂèñÁæ§ÊàêÂëòÂàóË°®
            const group = groupChats.find(g => g.id === currentChatCharacter.id);
            if (!group || !group.members) return;
            
            // ‰øùÂ≠òÊØè‰∏™ÊàêÂëòÁöÑÈ¢úËâ≤ËÆæÁΩÆ
            group.members.forEach(member => {
                // ÂÖºÂÆπ‰∏çÂêåÁöÑÊàêÂëòÊï∞ÊçÆÁªìÊûÑ
                const memberId = typeof member === 'string' ? member : member.id;
                const colorInput = document.getElementById(`member-color-${memberId}`);
                if (colorInput) {
                    chatSettings.memberBubbleColors[memberId] = colorInput.value;
                }
            });
            
            saveCurrentChatSettings(chatSettings);
            hideModal('group-member-colors-modal');
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰ª•Â∫îÁî®Êñ∞È¢úËâ≤
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            showToast('Áæ§ÊàêÂëòÊ∞îÊ≥°È¢úËâ≤Â∑≤‰øùÂ≠ò', 'success');
        }
        
        // Â§¥ÂÉè‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function avatarUploadHandler(e) {
            console.log('avatar-upload change‰∫ã‰ª∂Ë¢´Ëß¶Âèë');
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                
                console.log('ÈÄâÊã©‰∫ÜÊñá‰ª∂:', file.name, 'Â§ßÂ∞è:', file.size, 'bytes', 'Á±ªÂûã:', file.type);
                
                // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    e.target.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                    return;
                }
                
                // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂‰∏∫5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                    e.target.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('avatar-preview');
                        const avatarPreviewText = document.getElementById('avatar-preview-text');
                        
                        console.log('Êñá‰ª∂ËØªÂèñÊàêÂäüÔºåÂºÄÂßãËÆæÁΩÆÈ¢ÑËßà');
                        
                        if (!avatarPreview) {
                            console.error('Êâæ‰∏çÂà∞avatar-previewÂÖÉÁ¥†');
                            alert('Êâæ‰∏çÂà∞Â§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†');
                            return;
                        }
                        
                        // Ê∑ªÂä†has-imageÁ±ªÊù•Ë¶ÜÁõñÈªòËÆ§ËÉåÊôØ
                        avatarPreview.classList.add('has-image');
                        
                        // Âº∫Âà∂ËÆæÁΩÆËÉåÊôØÂõæÁâáÂπ∂Ê∏ÖÈô§ÊâÄÊúâÂÖ∂‰ªñËÉåÊôØÊ†∑Âºè
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        
                        // ÈöêËóèÊñáÂ≠ó
                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }
                        
                        // Â≠òÂÇ®ÂõæÁâáÊï∞ÊçÆÁî®‰∫éÂêéÁª≠‰øùÂ≠ò
                        window.selectedAvatarData = event.target.result;
                        
                        // È™åËØÅÊ†∑ÂºèÊòØÂê¶Ê≠£Á°ÆËÆæÁΩÆ
                        console.log('Â§¥ÂÉèÈ¢ÑËßàUIÊõ¥Êñ∞ÂÆåÊàêÔºåËÉåÊôØÂõæÁâáÂ∑≤ËÆæÁΩÆ');
                        console.log('ÂΩìÂâçavatar-previewÁöÑÊ†∑Âºè:', {
                            background: avatarPreview.style.background,
                            backgroundSize: avatarPreview.style.backgroundSize,
                            backgroundPosition: avatarPreview.style.backgroundPosition,
                            className: avatarPreview.className
                        });
                        
                        console.log('Â§¥ÂÉèÈ¢ÑËßàËÆæÁΩÆÊàêÂäüÔºåÂõæÁâáÊï∞ÊçÆÂ∑≤Â≠òÂÇ®');
                    } catch (error) {
                        console.error('ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÊó∂ÂèëÁîüÈîôËØØ:', error);
                        alert('ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÂ§±Ë¥•ÔºåËØ∑ÈáçËØï: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    console.error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
                    alert('ÂõæÁâáËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    e.target.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                };
                
                reader.readAsDataURL(file);
            } else {
                console.log('Ê≤°ÊúâÈÄâÊã©Êñá‰ª∂Êàñfiles‰∏∫Á©∫');
            }
        }
        
        // Âä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖ - ‰ΩøÁî®IndexedDBÔºàÂåÖÂê´Êï∞ÊçÆËøÅÁßªÔºâ
        async function loadCustomEmojis() {
            try {
                const savedCustomEmojis = await db.customEmojis.toArray();
                
                if (savedCustomEmojis.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localStorageData = localStorage.getItem('customEmojis');
                    if (localStorageData) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑËá™ÂÆö‰πâË°®ÊÉÖÂåÖÊï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localEmojis = JSON.parse(localStorageData);
                        
                        if (localEmojis.length > 0) {
                            await db.customEmojis.bulkAdd(localEmojis);
                        }
                        
                        customEmojis = localEmojis;
                        console.log('Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖËøÅÁßªÂÆåÊàê:', customEmojis);
                    } else {
                        customEmojis = [];
                    }
                } else {
                    customEmojis = savedCustomEmojis;
                    console.log('‰ªéIndexedDBÂä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖ:', customEmojis);
                }
                
                // üîß„Äê‰øÆÂ§ç„ÄërecentEmojis‰πü‰ªéIndexedDBÂä†ËΩΩÔºåÂΩªÂ∫ïËß£ÂÜ≥localStorageÈóÆÈ¢ò
                const savedRecentEmojis = await db.recentEmojis.orderBy('lastUsed').reverse().toArray();
                if (savedRecentEmojis.length === 0) {
                    // IndexedDB‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª
                    const localRecentEmojis = localStorage.getItem('recentEmojis');
                    if (localRecentEmojis) {
                        console.log('Ê£ÄÊµãÂà∞localStorage‰∏≠ÁöÑrecentEmojisÊï∞ÊçÆÔºåÂºÄÂßãËøÅÁßª...');
                        const localRecents = JSON.parse(localRecentEmojis);
                        
                        if (localRecents.length > 0) {
                            // ÈôêÂà∂‰∏∫10‰∏™
                            const limitedRecents = localRecents.slice(0, 10);
                            const recentEmojisWithId = limitedRecents.map((emoji, index) => ({
                                id: index + 1,
                                url: emoji.url,
                                description: emoji.description || 'Ë°®ÊÉÖÂåÖ',
                                lastUsed: Date.now() - index * 1000
                            }));
                            await db.recentEmojis.bulkAdd(recentEmojisWithId);
                            recentEmojis = limitedRecents;
                            
                            // Ê∏ÖÁêÜlocalStorage
                            localStorage.removeItem('recentEmojis');
                            console.log('recentEmojisËøÅÁßªÂÆåÊàêÂπ∂Ê∏ÖÁêÜlocalStorage');
                        } else {
                            recentEmojis = [];
                        }
                    } else {
                        recentEmojis = [];
                    }
                } else {
                    // ‰ªéIndexedDBËΩ¨Êç¢ÂõûÂéüÊ†ºÂºè
                    recentEmojis = savedRecentEmojis.map(item => ({
                        url: item.url,
                        description: item.description
                    }));
                    console.log('‰ªéIndexedDBÂä†ËΩΩrecentEmojis:', recentEmojis);
                }
            } catch (error) {
                console.error('Âä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖÂ§±Ë¥•:', error);
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªélocalStorageÂä†ËΩΩ
                const localStorageData = localStorage.getItem('customEmojis');
                if (localStorageData) {
                    customEmojis = JSON.parse(localStorageData);
                    console.log('‰ªélocalStorageÂ§á‰ªΩÂä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖ:', customEmojis);
                } else {
                    customEmojis = [];
                }
                
                // Â∞ùËØï‰ªéIndexedDBÂä†ËΩΩrecentEmojis
                try {
                    const savedRecentEmojis = await db.recentEmojis.orderBy('lastUsed').reverse().toArray();
                    if (savedRecentEmojis.length > 0) {
                        recentEmojis = savedRecentEmojis.map(item => ({
                            url: item.url,
                            description: item.description
                        }));
                    } else {
                        recentEmojis = [];
                    }
                } catch (dbError) {
                    // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªélocalStorageÂä†ËΩΩ
                    const localRecentEmojis = localStorage.getItem('recentEmojis');
                    if (localRecentEmojis) {
                        recentEmojis = JSON.parse(localRecentEmojis);
                    } else {
                        recentEmojis = [];
                    }
                }
            }
        }
        
        // ‰øùÂ≠òËá™ÂÆö‰πâË°®ÊÉÖÂåÖ - ‰ΩøÁî®IndexedDB
        async function saveCustomEmojis() {
            try {
                await db.customEmojis.clear();
                if (customEmojis.length > 0) {
                    await db.customEmojis.bulkAdd(customEmojis);
                }
                
                // üîß„Äê‰øÆÂ§ç„ÄëÂ∞ÜrecentEmojis‰πüËøÅÁßªÂà∞IndexedDBÔºåÂΩªÂ∫ïËß£ÂÜ≥localStorageÈóÆÈ¢ò
                try {
                    // ÈôêÂà∂ÊúÄËøë‰ΩøÁî®Ë°®ÊÉÖÂåÖÊï∞Èáè‰∏∫10‰∏™
                    const maxRecentEmojis = 10;
                    if (recentEmojis.length > maxRecentEmojis) {
                        recentEmojis = recentEmojis.slice(0, maxRecentEmojis);
                    }
                    
                    // Â∞ÜrecentEmojis‰πü‰øùÂ≠òÂà∞IndexedDB
                    await db.recentEmojis.clear();
                    if (recentEmojis.length > 0) {
                        const recentEmojisWithId = recentEmojis.map((emoji, index) => ({
                            id: index + 1,
                            url: emoji.url,
                            description: emoji.description || 'Ë°®ÊÉÖÂåÖ',
                            lastUsed: Date.now() - index * 1000 // Á°Æ‰øùÈ°∫Â∫è
                        }));
                        await db.recentEmojis.bulkAdd(recentEmojisWithId);
                    }
                    
                    // Ê∏ÖÁêÜlocalStorage‰∏≠ÁöÑÊóßÊï∞ÊçÆÔºà‰∏ÄÊ¨°ÊÄßËøÅÁßªÔºâ
                    if (localStorage.getItem('recentEmojis')) {
                        localStorage.removeItem('recentEmojis');
                        console.log('Â∑≤Â∞ÜrecentEmojisËøÅÁßªÂà∞IndexedDBÂπ∂Ê∏ÖÁêÜlocalStorage');
                    }
                } catch (dbError) {
                    console.error('IndexedDBÂ≠òÂÇ®Â§±Ë¥•:', dbError);
                    showToast('‚ùå Ë°®ÊÉÖÂåÖÊï∞ÊçÆÂ≠òÂÇ®Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('‰øùÂ≠òËá™ÂÆö‰πâË°®ÊÉÖÂåÖÂ§±Ë¥•:', error);
                showToast('‚ùå Ë°®ÊÉÖÂåÖ‰øùÂ≠òÂ§±Ë¥•', 'error');
            }
        }
        
        // ÊòæÁ§∫Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÈù¢Êùø
        function showCustomEmojiPanel() {
            const panel = document.getElementById('custom-emoji-panel');
            const isVisible = panel.style.display === 'block';
            
            if (isVisible) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            } else {
                panel.style.display = 'block';
                renderEmojiGrid();
                
                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Èù¢Êùø
                setTimeout(() => {
                    document.addEventListener('click', hideCustomEmojiPanel);
                }, 100);
            }
        }
        
        // ÈöêËóèËá™ÂÆö‰πâË°®ÊÉÖÂåÖÈù¢Êùø
        function hideCustomEmojiPanel(e) {
            const panel = document.getElementById('custom-emoji-panel');
            
            // Â¶ÇÊûúÊ≤°Êúâ‰º†ÈÄí‰∫ã‰ª∂ÂèÇÊï∞ÔºåÁõ¥Êé•ÈöêËóèÈù¢Êùø
            if (!e) {
                if (panel) {
                    panel.style.display = 'none';
                    document.removeEventListener('click', hideCustomEmojiPanel);
                }
                return;
            }
            
            const emojiBtn = e.target.closest('.chat-action-btn');
            
            if (panel && !panel.contains(e.target) && !emojiBtn) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            }
        }
        
        // Ê∏≤ÊüìË°®ÊÉÖÂåÖÁΩëÊ†º
        function renderEmojiGrid() {
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = '';
            
            let emojisToShow = [];
            
            if (currentEmojiTab === 'recent') {
                emojisToShow = recentEmojis;
            } else if (currentEmojiTab === 'custom') {
                emojisToShow = customEmojis;
            }
            
            // Ê∑ªÂä†Ë°®ÊÉÖÂåÖ
            emojisToShow.forEach((emoji, index) => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'custom-emoji-item';
                emojiItem.style.backgroundImage = emoji.url && emoji.url !== 'undefined' ? `url(${emoji.url})` : 'none';
                emojiItem.onclick = () => sendEmojiMessage(emoji);
                
                // ‰∏∫Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÂíåÊúÄËøë‰ΩøÁî®Ë°®ÊÉÖÂåÖÊ∑ªÂä†Âà†Èô§ÊåâÈíÆ
                if (currentEmojiTab === 'custom' || currentEmojiTab === 'recent') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'emoji-delete-btn';
                    deleteBtn.innerHTML = '√ó';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (currentEmojiTab === 'custom') {
                        deleteCustomEmoji(index);
                        } else if (currentEmojiTab === 'recent') {
                            deleteRecentEmoji(index);
                        }
                    };
                    emojiItem.appendChild(deleteBtn);
                }
                
                grid.appendChild(emojiItem);
            });
            
            // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÊ†áÁ≠æÈ°µÔºåÊ∑ªÂä†‰∏ä‰º†ÊåâÈíÆ
            if (currentEmojiTab === 'custom') {
                const uploadItem = document.createElement('div');
                uploadItem.className = 'custom-emoji-item placeholder';
                uploadItem.innerHTML = '+';
                uploadItem.onclick = () => document.getElementById('emoji-upload').click();
                grid.appendChild(uploadItem);
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâË°®ÊÉÖÂåÖÔºåÊòæÁ§∫ÊèêÁ§∫
            if (emojisToShow.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-emoji-grid';
                
                                                if (currentEmojiTab === 'recent') {
                                    emptyMsg.textContent = 'ËøòÊ≤°Êúâ‰ΩøÁî®ËøáË°®ÊÉÖÂåÖ';
                                } else {
                                    emptyMsg.textContent = 'ËøòÊ≤°ÊúâË°®ÊÉÖÂåÖÔºåÁÇπÂáª+Âè∑Ê∑ªÂä†';
                                }
                
                grid.appendChild(emptyMsg);
            }
        }
        
        // ÂèëÈÄÅË°®ÊÉÖÂåÖÊ∂àÊÅØ
        function sendEmojiMessage(emoji) {
            console.log('üé≠ ÂèëÈÄÅË°®ÊÉÖÂåÖ:', emoji);
            
            if (!currentChatCharacter) return;
            
            // Ê∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®
            addToRecentEmojis(emoji);
            
            // üî•„Äê‰øÆÂ§ç„ÄëË°®ÊÉÖÂåÖÊ∂àÊÅØÂè™ÊòæÁ§∫ÂõæÁâáÔºå‰∏çÊòæÁ§∫ÊñáÂ≠óÂÜÖÂÆπ
            const messageId = Date.now().toString();
            const emojiMessage = {
                id: messageId,
                sender: 'sent',
                content: '', // Ë°®ÊÉÖÂåÖÊ∂àÊÅØ‰∏çÊòæÁ§∫ÊñáÂ≠óÂÜÖÂÆπ
                image: emoji.url,
                isEmoji: true,
                emojiDescription: emoji.description || 'Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖ',
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(emojiMessage);
            saveChatMessages();
            
            // Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages(currentChatCharacter.id);
            
            // üî•„ÄêÊñ∞Â¢û„ÄëËß¶ÂèëËßíËâ≤Áä∂ÊÄÅÊõ¥Êñ∞
            triggerStatusUpdateAfterMessage(currentChatCharacter.id);
            
            // ÈöêËóèË°®ÊÉÖÂåÖÈù¢Êùø
            hideCustomEmojiPanel();
            
            // ËÆæÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØÔºåÊîØÊåÅÊô∫ËÉΩÂõûÂ§çÊåâÈíÆ
            pendingUserMessage = emojiMessage;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
            
            // Ê≥®ÈáäÊéâËá™Âä®ÂõûÂ§çÔºåÊîπ‰∏∫ÊâãÂä®ÂõûÂ§çÊ®°Âºè
            // setTimeout(() => {
            //     sendAIEmojiResponse(emoji);
            // }, 1000 + Math.random() * 2000);
        }
        
        // Ê∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®ÁöÑË°®ÊÉÖÂåÖ
        async function addToRecentEmojis(emoji) {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÁõ∏ÂêåË°®ÊÉÖÂåÖ
            recentEmojis = recentEmojis.filter(e => e.url !== emoji.url);
            
            // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
            recentEmojis.unshift(emoji);
            
            // ÈôêÂà∂ÊúÄËøë‰ΩøÁî®Êï∞Èáè‰∏∫20‰∏™
            if (recentEmojis.length > 20) {
                recentEmojis = recentEmojis.slice(0, 20);
            }
            
            await saveCustomEmojis();
        }
        
        // Ê£ÄÊµãÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÊîØÊåÅËßÜËßâÂäüËÉΩ
        function isVisionModelSupported() {
            // ÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÂàóË°®
            const visionModels = [
                // OpenAI GPTÁ≥ªÂàó
                'gpt-4-vision',
                'gpt-4o',
                'gpt-4-turbo',
                'gpt-4o-mini',
                
                // Google GeminiÁ≥ªÂàó
                'gemini-1.5-pro',
                'gemini-1.5-flash',
                'gemini-2.0-flash',
                'gemini-2.5-pro',
                'gemini-2.5-flash',
                'gemini-exp',
                'gemini-pro-vision',
                
                // Anthropic ClaudeÁ≥ªÂàó
                'claude-3-opus',
                'claude-3-sonnet',
                'claude-3-haiku',
                'claude-3.5-sonnet',
                'claude-3.5-haiku',
                
                // ÂõΩ‰∫ßÊ®°Âûã
                'qwen-vl',
                'qwen2-vl',
                'yi-vision',
                'glm-4v',
                'internvl',
                'cogvlm',
                
                // ÂÖ∂‰ªñÊ®°Âûã
                'llava',
                'moondream',
                'phi-3-vision'
            ];
            
            const currentModel = apiSettings.model?.toLowerCase() || '';
            
            // Ê£ÄÊü•ÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÂåÖÂê´‰ªª‰ΩïÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÂêçÁß∞
            const isVisionSupported = visionModels.some(model => currentModel.includes(model.toLowerCase()));
            
            // ËæìÂá∫Ë∞ÉËØï‰ø°ÊÅØ
            console.log('ÂΩìÂâçÊ®°Âûã:', currentModel);
            console.log('ÊòØÂê¶ÊîØÊåÅËßÜËßâ:', isVisionSupported);
            
            return isVisionSupported;
        }
        
        // Ê≥®ÈáäÔºöAIÂØπË°®ÊÉÖÂåÖÁöÑËá™Âä®ÂõûÂ§çÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®ÊâãÂä®ÂõûÂ§çÊ®°Âºè
        // Ë°®ÊÉÖÂåÖÂíåÂõæÁâáÈÉΩÈÄöËøáÊô∫ËÉΩÂõûÂ§çÊåâÈíÆÊù•Ëß¶ÂèëAIÂõûÂ§ç
        
        // Âà†Èô§Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖ
        function deleteCustomEmoji(index) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü')) {
                customEmojis.splice(index, 1);
                saveCustomEmojis();
                renderEmojiGrid();
            }
        }
        
        // Âà†Èô§ÊúÄËøë‰ΩøÁî®ÁöÑË°®ÊÉÖÂåÖ
        function deleteRecentEmoji(index) {
            if (confirm('Á°ÆÂÆöË¶Å‰ªéÊúÄËøë‰ΩøÁî®‰∏≠Âà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü')) {
                recentEmojis.splice(index, 1);
                saveCustomEmojis(); // üîß„Äê‰øÆÂ§ç„ÄëÁé∞Âú®‰ΩøÁî®IndexedDB‰øùÂ≠ò
                renderEmojiGrid();
            }
        }
        
        // ÂàùÂßãÂåñË°®ÊÉÖÂåÖ‰∏ä‰º†ÂäüËÉΩ
        function initializeEmojiUpload() {
            const emojiInput = document.getElementById('emoji-upload');
            if (emojiInput) {
                emojiInput.addEventListener('change', handleEmojiUpload);
            }
            
            // ÁªëÂÆöÊ†áÁ≠æÈ°µÂàáÊç¢‰∫ã‰ª∂
            document.querySelectorAll('.emoji-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
                    document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
                    // Ê∑ªÂä†ÂΩìÂâçactiveÁ±ª
                    this.classList.add('active');
                    
                    // ÂàáÊç¢ÂΩìÂâçÊ†áÁ≠æÈ°µ
                    currentEmojiTab = this.dataset.tab;
                    renderEmojiGrid();
                });
            });
        }
        
        // ÂàáÊç¢Â∑•ÂÖ∑Èù¢ÊùøÊòæÁ§∫/ÈöêËóè
        function toggleToolsPanel() {
            const panel = document.getElementById('tools-panel');
            const toggleBtn = document.getElementById('toggle-tools-btn');
            const emojiPanel = document.getElementById('custom-emoji-panel');
            
            if (!panel || !toggleBtn) return;
            
            const isVisible = panel.style.display === 'block';
            
            if (isVisible) {
                // ÈöêËóèÂ∑•ÂÖ∑Èù¢Êùø
                hideToolsPanel();
            } else {
                // ÊòæÁ§∫Â∑•ÂÖ∑Èù¢Êùø
                showToolsPanel();
                
                // ÈöêËóèË°®ÊÉÖÂåÖÈù¢Êùø
                if (emojiPanel) {
                    emojiPanel.style.display = 'none';
                }
                
                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Èù¢Êùø
                setTimeout(() => {
                    document.addEventListener('click', handleToolsPanelOutsideClick);
                }, 100);
            }
        }
        
        // ÊòæÁ§∫Â∑•ÂÖ∑Èù¢Êùø
        function showToolsPanel() {
            const panel = document.getElementById('tools-panel');
            const toggleBtn = document.getElementById('toggle-tools-btn');
            
            if (panel) {
                panel.style.display = 'block';
                panel.style.animation = 'toolsPanelSlideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
            }
            
            if (toggleBtn) {
                toggleBtn.classList.add('active');
            }
        }
        
        // ÈöêËóèÂ∑•ÂÖ∑Èù¢Êùø
        function hideToolsPanel() {
            const panel = document.getElementById('tools-panel');
            const toggleBtn = document.getElementById('toggle-tools-btn');
            
            if (panel) {
                panel.style.display = 'none';
            }
            
            if (toggleBtn) {
                toggleBtn.classList.remove('active');
            }
            
            // ÁßªÈô§ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.removeEventListener('click', handleToolsPanelOutsideClick);
        }
        
        // Â§ÑÁêÜÂ∑•ÂÖ∑Èù¢ÊùøÂ§ñÈÉ®ÁÇπÂáª‰∫ã‰ª∂
        function handleToolsPanelOutsideClick(e) {
            const panel = document.getElementById('tools-panel');
            const toggleBtn = document.getElementById('toggle-tools-btn');
            
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂ∑•ÂÖ∑Èù¢ÊùøÂÜÖÈÉ®ÊàñËß¶ÂèëÊåâÈíÆÔºå‰∏çÂÖ≥Èó≠Èù¢Êùø
            if (panel && !panel.contains(e.target) && 
                toggleBtn && !toggleBtn.contains(e.target)) {
                hideToolsPanel();
            }
        }
        
        // Â§ÑÁêÜË°®ÊÉÖÂåÖ‰∏ä‰º†
        function handleEmojiUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    return;
                }
                
                // Ê£ÄÊü•GIFÊ†ºÂºèÔºåÊèêÈÜíÁî®Êà∑ÂèØËÉΩÁöÑÈóÆÈ¢ò
                if (file.type === 'image/gif') {
                    const confirmed = confirm('Ê£ÄÊµãÂà∞GIFÊ†ºÂºèÁöÑË°®ÊÉÖÂåÖÔºÅ\n\n‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°πÔºö\n‚Ä¢ AIÂèØ‰ª•ÂèëÈÄÅËøô‰∏™GIFÂä®Âõæ\n‚Ä¢ ‰ΩÜGemini APIÊó†Ê≥ïËØÜÂà´GIFÂÜÖÂÆπ\n‚Ä¢ ÈáçÊñ∞ÁîüÊàêÂäüËÉΩÂèØËÉΩÂ§±Êïà\n‚Ä¢ Âª∫ËÆÆ‰ΩøÁî®ÈùôÊÄÅÂõæÁâáÊ†ºÂºè\n\nÊòØÂê¶‰ªçË¶Å‰∏ä‰º†Ëøô‰∏™GIFË°®ÊÉÖÂåÖÔºü');
                    if (!confirmed) {
                        return;
                    }
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    // ÂºπÂá∫ÊèèËø∞ËæìÂÖ•Ê°Ü
                    const description = prompt('ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂåÖÊ∑ªÂä†ÊèèËø∞ÔºàÊé®ËçêÔºÅÂ∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÁêÜËß£Ë°®ÊÉÖÂåÖÂÜÖÂÆπÔºâ:\n\n‰æãÂ¶ÇÔºö\n‚Ä¢ "Á¨ëÂì≠ÁöÑË°®ÊÉÖ"\n‚Ä¢ "Êè°Êã≥Âä†Ê≤πÁöÑÂä®‰Ωú"\n‚Ä¢ "ÂÜôÁùÄOMGÁöÑË°®ÊÉÖÂåÖ"\n‚Ä¢ "ÊÑ§ÊÄíÁöÑÁå´Âí™ÂõæÁâá"', '');
                    
                    const emoji = {
                        id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                        url: event.target.result,
                        description: description || 'Ë°®ÊÉÖÂåÖ',
                        addedAt: new Date().toISOString()
                    };
                    
                    customEmojis.push(emoji);
                    saveCustomEmojis();
                    
                    // Â¶ÇÊûúÂΩìÂâçÂú®Ëá™ÂÆö‰πâÊ†áÁ≠æÈ°µÔºåÈáçÊñ∞Ê∏≤Êüì
                    if (currentEmojiTab === 'custom') {
                        renderEmojiGrid();
                    }
                };
                
                reader.readAsDataURL(file);
            });
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
            e.target.value = '';
        }
        
        // Âà§Êñ≠È¢úËâ≤ÊòØÂê¶‰∏∫ÊµÖËâ≤
        function isLightColor(color) {
            // Â∞ÜÈ¢úËâ≤ËΩ¨Êç¢‰∏∫RGBÂÄº
            let r, g, b;
            
            if (color.startsWith('#')) {
                // ÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤
                const hex = color.slice(1);
                if (hex.length === 3) {
                    r = parseInt(hex[0] + hex[0], 16);
                    g = parseInt(hex[1] + hex[1], 16);
                    b = parseInt(hex[2] + hex[2], 16);
                } else {
                    r = parseInt(hex.substr(0, 2), 16);
                    g = parseInt(hex.substr(2, 2), 16);
                    b = parseInt(hex.substr(4, 2), 16);
                }
            } else if (color.startsWith('rgb')) {
                // RGBÈ¢úËâ≤
                const matches = color.match(/\d+/g);
                if (matches && matches.length >= 3) {
                    r = parseInt(matches[0]);
                    g = parseInt(matches[1]);
                    b = parseInt(matches[2]);
                }
            } else {
                // ÈªòËÆ§‰∏∫Ê∑±Ëâ≤
                return false;
            }
            
            // ËÆ°ÁÆó‰∫ÆÂ∫¶
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128;
        }
        
        // Êõ¥Êñ∞Ê∞îÊ≥°È¢ÑËßà
        function updateBubblePreview() {
            const myColor = document.getElementById('my-bubble-color')?.value || '#007AFF';
            const aiColor = document.getElementById('ai-bubble-color')?.value || '#f0f0f0';
            const myOpacity = document.getElementById('my-bubble-opacity')?.value || '1';
            const aiOpacity = document.getElementById('ai-bubble-opacity')?.value || '1';
            
            // Êõ¥Êñ∞È¢ÑËßàÊ∞îÊ≥°
            const demoMyBubble = document.getElementById('demo-my-bubble');
            const demoAiBubble = document.getElementById('demo-ai-bubble');
            
            if (demoMyBubble) {
                // ‰ΩøÁî®rgbaËÉåÊôØËâ≤ËÄå‰∏çÊòØopacity
                const transparentMyColor = convertColorWithOpacity(myColor, myOpacity);
                demoMyBubble.style.backgroundColor = transparentMyColor;
                demoMyBubble.style.color = isLightColor(myColor) ? '#333' : '#fff';
            }
            
            if (demoAiBubble) {
                // ‰ΩøÁî®rgbaËÉåÊôØËâ≤ËÄå‰∏çÊòØopacity
                const transparentAiColor = convertColorWithOpacity(aiColor, aiOpacity);
                demoAiBubble.style.backgroundColor = transparentAiColor;
                demoAiBubble.style.color = isLightColor(aiColor) ? '#333' : '#fff';
            }
            
            // Êõ¥Êñ∞È¢úËâ≤È¢ÑËßà
            const myPreview = document.getElementById('my-bubble-preview');
            const aiPreview = document.getElementById('ai-bubble-preview');
            
            if (myPreview) {
                // ‰ΩøÁî®rgbaËÉåÊôØËâ≤ËÄå‰∏çÊòØopacity
                const transparentMyColor = convertColorWithOpacity(myColor, myOpacity);
                myPreview.style.backgroundColor = transparentMyColor;
                myPreview.textContent = 'ÊàëÁöÑÊ∞îÊ≥°';
            }
            
            if (aiPreview) {
                // ‰ΩøÁî®rgbaËÉåÊôØËâ≤ËÄå‰∏çÊòØopacity
                const transparentAiColor = convertColorWithOpacity(aiColor, aiOpacity);
                aiPreview.style.backgroundColor = transparentAiColor;
                aiPreview.textContent = 'ÂØπÊñπÊ∞îÊ≥°';
            }
        }
        
        // ÁªëÂÆöÂ§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂
        function bindAvatarUploadEvents() {
            // ÊàëÁöÑÂ§¥ÂÉè‰∏ä‰º†
            const myAvatarUpload = document.getElementById('my-chat-avatar-upload');
            if (myAvatarUpload) {
                myAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('my-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedMyChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }
            
            // AIÂ§¥ÂÉè‰∏ä‰º†
            const aiAvatarUpload = document.getElementById('ai-chat-avatar-upload');
            if (aiAvatarUpload) {
                aiAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('ai-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedAiChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }
        }
        
        // ÂàùÂßãÂåñÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
        function initializeAvatarUpload() {
            const avatarInput = document.getElementById('avatar-upload');
            if (!avatarInput) {
                console.error('Êâæ‰∏çÂà∞avatar-uploadÂÖÉÁ¥†');
                return;
            }
            
            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.removeEventListener('change', avatarUploadHandler);
            
            // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.addEventListener('change', avatarUploadHandler);
            console.log('Â§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö');
        }
        
        // Êõ¥Êñ∞ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢ÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        async function updateChatSettingsDisplay() {
            if (!currentChatCharacter) {
                console.log("Êõ¥Êñ∞ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫ÔºöÊó†ÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåË∑≥ËøáÊìç‰Ωú");
                return;
            }
            
            const chatSettings = await getAsyncChatSettings();
            
            // Êõ¥Êñ∞ÂéÜÂè≤Ê∂àÊÅØÊï∞ÊòæÁ§∫
            const historyCountElement = document.getElementById('current-history-count');
            if (historyCountElement) {
                historyCountElement.textContent = chatSettings.historyCount + 'ÂõûÂêà';
            }
            
            // Êõ¥Êñ∞ËÆ∞ÂøÜÊåÇËΩΩÊòæÁ§∫
            const memoryMountElement = document.getElementById('current-memory-mount');
            if (memoryMountElement) {
                memoryMountElement.textContent = chatSettings.memoryMountEnabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
            }
            
            // Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫
            updateWorldbookMountDisplay();
            
            // Êõ¥Êñ∞Êó∂Èó¥ÊÑüÁü•ÂºÄÂÖ≥
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.checked = chatSettings.timeAwarenessEnabled;
            }
            
            // Êõ¥Êñ∞ÈÄöËØùËÆæÁΩÆ
            const aiCallCheckbox = document.querySelector('.ai-call-enabled-checkbox');
            if (aiCallCheckbox) {
                aiCallCheckbox.checked = chatSettings.aiCallEnabled;
            }
            
            // Êõ¥Êñ∞ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.checked = chatSettings.aiHeartrateEnabled;
            }
            
            // Êõ¥Êñ∞ËßíËâ≤Áä∂ÊÄÅÊòæÁ§∫ËÆæÁΩÆ
            const characterStatusCheckbox = document.getElementById('character-status-enabled');
            if (characterStatusCheckbox) {
                characterStatusCheckbox.checked = chatSettings.characterStatusEnabled || false;
                // üî•„ÄêÊñ∞Â¢û„ÄëÊéßÂà∂Áä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáËÆæÁΩÆÁöÑÊòæÁ§∫
                const statusFrequencySetting = document.getElementById('status-frequency-setting');
                if (statusFrequencySetting) {
                    statusFrequencySetting.style.display = chatSettings.characterStatusEnabled ? 'flex' : 'none';
                }
            }
            
            // üî•„Äê‰øÆÂ§ç„ÄëÊõ¥Êñ∞Áä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáËÆæÁΩÆ - ‰ªéÂÖ®Â±ÄËÆæÁΩÆËØªÂèñ
            const statusUpdateFrequencySelect = document.getElementById('status-update-frequency');
            if (statusUpdateFrequencySelect) {
                const globalFrequency = localStorage.getItem('globalStatusUpdateFrequency') || 'medium';
                statusUpdateFrequencySelect.value = globalFrequency;
            }
            

            
            // Êõ¥Êñ∞ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.checked = chatSettings.backgroundInteractionEnabled;
                // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
                const backgroundSettings = document.getElementById('background-interaction-settings');
                if (backgroundSettings) {
                    backgroundSettings.style.display = chatSettings.backgroundInteractionEnabled ? 'block' : 'none';
                }
            }
            
            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.value = chatSettings.backgroundChatFrequency || 'low';
            }
            
            const backgroundChatEnabledCheckbox = document.getElementById('background-chat-enabled');
            if (backgroundChatEnabledCheckbox) {
                backgroundChatEnabledCheckbox.checked = chatSettings.backgroundChatEnabled !== false;
                // ÊéßÂà∂È¢ëÁéáËÆæÁΩÆÊòæÁ§∫
                const chatFrequencySetting = document.getElementById('chat-frequency-setting');
                if (chatFrequencySetting) {
                    chatFrequencySetting.style.display = chatSettings.backgroundChatEnabled !== false ? 'block' : 'none';
                }
            }
            
            const backgroundMomentsEnabledCheckbox = document.getElementById('background-moments-enabled');
            if (backgroundMomentsEnabledCheckbox) {
                backgroundMomentsEnabledCheckbox.checked = chatSettings.backgroundMomentsEnabled !== false;
                // ÊéßÂà∂Áõ∏ÂÖ≥ËÆæÁΩÆÊòæÁ§∫
                const momentsEnabled = chatSettings.backgroundMomentsEnabled !== false;
                const momentsFrequencySetting = document.getElementById('moments-frequency-setting');
                const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                const testPublishSetting = document.getElementById('test-publish-setting');
                
                if (momentsFrequencySetting) {
                    momentsFrequencySetting.style.display = momentsEnabled ? 'flex' : 'none';
                }
                if (scheduledMomentsSetting) {
                    scheduledMomentsSetting.style.display = momentsEnabled ? 'flex' : 'none';
                }
                if (testPublishSetting) {
                    testPublishSetting.style.display = momentsEnabled ? 'flex' : 'none';
                }
            }
            
            const backgroundMomentsFrequencySelect = document.getElementById('background-moments-frequency');
            if (backgroundMomentsFrequencySelect) {
                backgroundMomentsFrequencySelect.value = chatSettings.backgroundMomentsFrequency || 'low';
            }
            
            const scheduledMomentsEnabledCheckbox = document.getElementById('scheduled-moments-enabled');
            if (scheduledMomentsEnabledCheckbox) {
                scheduledMomentsEnabledCheckbox.checked = chatSettings.scheduledMomentsEnabled || false;
                // ÊéßÂà∂Êó∂Èó¥ËÆæÁΩÆÊåâÈíÆÊòæÁ§∫
                const scheduledTimesButton = document.querySelector('button[onclick="showScheduleTimesModal()"]');
                if (scheduledTimesButton) {
                    scheduledTimesButton.style.display = chatSettings.scheduledMomentsEnabled ? 'inline-block' : 'none';
                }
            }
            
            // Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÊòæÁ§∫
            updateScheduleTimesDisplay();
            
            // Êõ¥Êñ∞Êó∂Èó¥Êà≥ËÆæÁΩÆ
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                timestampCheckbox.checked = chatSettings.timestampEnabled;
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®Êù•‰øùÂ≠òËÆæÁΩÆÂèòÂåñ
            bindChatSettingsEvents();
        }
        
        // ÁªëÂÆöËÅäÂ§©ËÆæÁΩÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function bindChatSettingsEvents() {
            // Êó∂Èó¥ÊÑüÁü•ÂºÄÂÖ≥
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timeAwarenessEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                };
            }
            
            // ÈÄöËØùËÆæÁΩÆ
            const aiCallCheckboxes = document.querySelectorAll('.ai-call-enabled-checkbox');
            aiCallCheckboxes.forEach(checkbox => {
                checkbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiCallEnabled = this.checked;
                    
                    // ÂêåÊ≠•ÊâÄÊúâÁõ∏ÂÖ≥Â§çÈÄâÊ°ÜÁöÑÁä∂ÊÄÅ
                    aiCallCheckboxes.forEach(cb => {
                        if (cb !== this) {
                            cb.checked = this.checked;
                        }
                    });
                    
                    await saveCurrentChatSettings(chatSettings);
                };
            });
            
            // ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiHeartrateEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // Á´ãÂç≥Êõ¥Êñ∞ÂøÉÁéáÊòæÁ§∫Áä∂ÊÄÅ
                    if (currentChatCharacter) {
                        updateAiHeartrate();
                    }
                    
                    showToast(`ËßíËâ≤ÂøÉÁéáÁõëÊµãÂ∑≤${this.checked ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`, 'success');
                };
            }
            

            
            // ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundInteractionEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    // ÊòæÁ§∫/ÈöêËóèËØ¶ÁªÜËÆæÁΩÆ
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }
                };
            }
            
            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundChatFrequency = this.value;
                    await saveCurrentChatSettings(chatSettings);
                };
            }
            
            const backgroundChatEnabledCheckbox = document.getElementById('background-chat-enabled');
            if (backgroundChatEnabledCheckbox) {
                backgroundChatEnabledCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundChatEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // ÊéßÂà∂È¢ëÁéáËÆæÁΩÆÊòæÁ§∫
                    const chatFrequencySetting = document.getElementById('chat-frequency-setting');
                    if (chatFrequencySetting) {
                        chatFrequencySetting.style.display = this.checked ? 'block' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    initBackgroundInteractionSystem();
                };
            }
            
            const backgroundMomentsEnabledCheckbox = document.getElementById('background-moments-enabled');
            if (backgroundMomentsEnabledCheckbox) {
                backgroundMomentsEnabledCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundMomentsEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // ÊéßÂà∂Áõ∏ÂÖ≥ËÆæÁΩÆÊòæÁ§∫
                    const momentsFrequencySetting = document.getElementById('moments-frequency-setting');
                    const scheduledMomentsSetting = document.getElementById('scheduled-moments-setting');
                    const testPublishSetting = document.getElementById('test-publish-setting');
                    
                    if (momentsFrequencySetting) {
                        momentsFrequencySetting.style.display = this.checked ? 'flex' : 'none';
                    }
                    if (scheduledMomentsSetting) {
                        scheduledMomentsSetting.style.display = this.checked ? 'flex' : 'none';
                    }
                    if (testPublishSetting) {
                        testPublishSetting.style.display = this.checked ? 'flex' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    initBackgroundInteractionSystem();
                };
            }
            
            const backgroundMomentsFrequencySelect = document.getElementById('background-moments-frequency');
            if (backgroundMomentsFrequencySelect) {
                backgroundMomentsFrequencySelect.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundMomentsFrequency = this.value;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    initBackgroundInteractionSystem();
                };
            }
            
            const scheduledMomentsEnabledCheckbox = document.getElementById('scheduled-moments-enabled');
            if (scheduledMomentsEnabledCheckbox) {
                scheduledMomentsEnabledCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.scheduledMomentsEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // ÊéßÂà∂Êó∂Èó¥ËÆæÁΩÆÊåâÈíÆÊòæÁ§∫
                    const scheduledTimesButton = document.querySelector('button[onclick="showScheduleTimesModal()"]');
                    if (scheduledTimesButton) {
                        scheduledTimesButton.style.display = this.checked ? 'inline-block' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂÆöÊó∂ÂèëÂ∏ÉÁ≥ªÁªü
                    initScheduledMomentsSystem();
                };
            }
            
            // Êó∂Èó¥Êà≥ËÆæÁΩÆ
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                timestampCheckbox.onchange = async function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timestampEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }
                };
            }
            
            // ËßíËâ≤Áä∂ÊÄÅÊòæÁ§∫ËÆæÁΩÆ
            const characterStatusCheckbox = document.getElementById('character-status-enabled');
            if (characterStatusCheckbox) {
                characterStatusCheckbox.onchange = async function() {
                    console.log('Áä∂ÊÄÅÊòæÁ§∫ÂºÄÂÖ≥Ë¢´ÁÇπÂáª:', this.checked);
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.characterStatusEnabled = this.checked;
                    await saveCurrentChatSettings(chatSettings);
                    
                    // üî•„ÄêÊñ∞Â¢û„ÄëÊéßÂà∂Áä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáËÆæÁΩÆÁöÑÊòæÁ§∫
                    const statusFrequencySetting = document.getElementById('status-frequency-setting');
                    if (statusFrequencySetting) {
                        statusFrequencySetting.style.display = this.checked ? 'flex' : 'none';
                    }
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢‰ª•ÊòæÁ§∫/ÈöêËóèÁä∂ÊÄÅ
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                        // Êõ¥Êñ∞ËÅäÂ§©Ê†áÈ¢òÂå∫ÂüüÁöÑÁä∂ÊÄÅÊòæÁ§∫
                        const headerContainer = document.querySelector('#api-chat-screen .header');
                        if (headerContainer) {
                            renderCharacterStatus(currentChatCharacter.id, headerContainer);
                        }
                    }
                    
                    // üî•„ÄêÊñ∞Â¢û„ÄëÈáçÂêØÁä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®‰ª•Â∫îÁî®Êñ∞ËÆæÁΩÆ
                    restartCharacterStatusTimer();
                    
                    showToast(`ËßíËâ≤Áä∂ÊÄÅÊòæÁ§∫Â∑≤${this.checked ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`, 'success');
                };
            } else {
                console.warn('Êâæ‰∏çÂà∞character-status-enabledÂÖÉÁ¥†');
            }
            
            // üî•„Äê‰øÆÂ§ç„ÄëÁä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáËÆæÁΩÆ - ‰øùÂ≠ò‰∏∫ÂÖ®Â±ÄËÆæÁΩÆ
            const statusUpdateFrequencySelect = document.getElementById('status-update-frequency');
            if (statusUpdateFrequencySelect) {
                statusUpdateFrequencySelect.onchange = async function() {
                    // üî•„Äê‰øÆÂ§ç„Äë‰øùÂ≠ò‰∏∫ÂÖ®Â±ÄËÆæÁΩÆÔºåËÄå‰∏çÊòØËßíËâ≤‰∏ìÂ±ûËÆæÁΩÆ
                    localStorage.setItem('globalStatusUpdateFrequency', this.value);

                    // ÂêåÊó∂Êõ¥Êñ∞ÂΩìÂâçËßíËâ≤ÁöÑËÆæÁΩÆ‰ª•‰øùÊåÅ‰∏ÄËá¥ÊÄß
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.statusUpdateFrequency = this.value;
                    await saveCurrentChatSettings(chatSettings);

                    // ÈáçÂêØÁä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®‰ª•Â∫îÁî®Êñ∞È¢ëÁéá
                    restartCharacterStatusTimer();

                    const frequencyNames = {
                        'high': 'È´òÈ¢ë',
                        'medium-high': '‰∏≠È´òÈ¢ë',
                        'medium': '‰∏≠È¢ë',
                        'medium-low': '‰∏≠‰ΩéÈ¢ë',
                        'low': '‰ΩéÈ¢ë'
                    };

                    showToast(`Áä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáÂ∑≤ËÆæÁΩÆ‰∏∫${frequencyNames[this.value]}`, 'success');
                };
            }
        }

        // ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢
        async function initializeChatSettings() {
            console.log("ÂºÄÂßãÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢");
            
            // ÂàùÂßãÂåñUIÁõ∏ÂÖ≥‰∫ã‰ª∂
            initChatSettingsUIEvents();
            
            // Â¶ÇÊûúÊ≤°ÊúâcurrentChatCharacterÔºåÂè™ÂàùÂßãÂåñUI‰∫ã‰ª∂Ôºå‰∏çÂä†ËΩΩËÆæÁΩÆ
            if (!currentChatCharacter) {
                console.log("ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢ÔºöÊó†ÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåÂè™ÂàùÂßãÂåñUI‰∫ã‰ª∂");
                return;
            }
            
            // Êõ¥Êñ∞Ë∫´‰ªΩÊòæÁ§∫
            await updateChatIdentityDisplay();
            
            // Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑ÂºèÊòæÁ§∫
            await updateBubbleStyleDisplay();
            
            // Êõ¥Êñ∞ÊâÄÊúâËÆæÁΩÆÊòæÁ§∫Áä∂ÊÄÅ
            await updateChatSettingsDisplay();
            
            // Âä†ËΩΩÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆ
            if (currentChatCharacter) {
                const chatSettings = await getAsyncChatSettings();
                
                // ËÆæÁΩÆËÅäÂ§©Ê®°Âºè
                const chatMode = chatSettings.chatMode || 'online';
                const onlineRadio = document.getElementById('chat-mode-online');
                const offlineRadio = document.getElementById('chat-mode-offline');
                
                if (onlineRadio && offlineRadio) {
                    if (chatMode === 'online') {
                        onlineRadio.checked = true;
                    } else {
                        offlineRadio.checked = true;
                    }
                    
                    // ÊòæÁ§∫/ÈöêËóèÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÊéßÂà∂
                    const offlineLengthControl = document.getElementById('offline-length-control');
                    if (offlineLengthControl) {
                        offlineLengthControl.style.display = chatMode === 'offline' ? 'flex' : 'none';
                    }
                    
                    // ËÆæÁΩÆÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂
                    const maxLengthInput = document.getElementById('offline-mode-max-length');
                    if (maxLengthInput) {
                        maxLengthInput.value = chatSettings.offlineModeMaxLength || 100;
                    }
                    }
                }
            }
            
        // ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆUIÁõ∏ÂÖ≥‰∫ã‰ª∂
        function initChatSettingsUIEvents() {
            // ÁªëÂÆöËÅäÂ§©Ê®°ÂºèÂàáÊç¢‰∫ã‰ª∂
            const chatModeRadios = document.querySelectorAll('input[name="chat-mode"]');
            chatModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const offlineLengthControl = document.getElementById('offline-length-control');
                    if (offlineLengthControl) {
                        offlineLengthControl.style.display = this.value === 'offline' ? 'flex' : 'none';
                    }
                    
                    // ‰øùÂ≠òËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ
                    if (currentChatCharacter) {
                    saveChatModeSettings();
                    }
                });
            });
            
            // ÁªëÂÆöÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂ÂèòÂåñ‰∫ã‰ª∂
            const maxLengthInput = document.getElementById('offline-mode-max-length');
            if (maxLengthInput) {
                maxLengthInput.addEventListener('change', saveChatModeSettings);
            }
            

            
            // ÁªëÂÆöÂêéÂè∞‰∫íÂä®ÂºÄÂÖ≥‰∫ã‰ª∂
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.addEventListener('change', function() {
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }
                    
                    // Â¶ÇÊûúÂÖ≥Èó≠ÂêéÂè∞‰∫íÂä®ÔºåÊ∏ÖÈô§ÊâÄÊúâÂÆöÊó∂Âô®
                    if (!this.checked) {
                        clearAllBackgroundTimers();
                    } else {
                        // Â¶ÇÊûúÂºÄÂêØÂêéÂè∞‰∫íÂä®ÔºåÈáçÊñ∞ÂàùÂßãÂåñÁ≥ªÁªü
                        initBackgroundInteractionSystem();
                    }
                });
            }
            
            // ÁªëÂÆö‰∏ªÂä®ËÅäÂ§©ÂºÄÂÖ≥‰∫ã‰ª∂
            const backgroundChatCheckbox = document.getElementById('background-chat-enabled');
            if (backgroundChatCheckbox) {
                backgroundChatCheckbox.addEventListener('change', function() {
                    const frequencySetting = document.getElementById('chat-frequency-setting');
                    if (frequencySetting) {
                        frequencySetting.style.display = this.checked ? 'block' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    if (currentChatCharacter) {
                        initBackgroundInteractionSystem();
                    }
                });
            }
            
            // ÁªëÂÆö‰∏ªÂä®ÂèëÂä®ÊÄÅÂºÄÂÖ≥‰∫ã‰ª∂
            const backgroundMomentsCheckbox = document.getElementById('background-moments-enabled');
            if (backgroundMomentsCheckbox) {
                backgroundMomentsCheckbox.addEventListener('change', function() {
                    const frequencySetting = document.getElementById('moments-frequency-setting');
                    if (frequencySetting) {
                        frequencySetting.style.display = this.checked ? 'flex' : 'none';
                    }
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
                    if (currentChatCharacter) {
                        initBackgroundInteractionSystem();
                    }
                });
            }
            
            // ÁªëÂÆö‰∏ªÂä®Êã®ÊâìÁîµËØùÂºÄÂÖ≥‰∫ã‰ª∂
            const aiCallEnabledCheckboxes = document.querySelectorAll('.ai-call-enabled-checkbox');
            aiCallEnabledCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // ‰øùÂ≠òËÆæÁΩÆ
                    if (currentChatCharacter) {
                        const chatSettings = getCurrentChatSettings();
                        chatSettings.aiCallEnabled = this.checked;
                        
                        // ÂêåÊ≠•ÊâÄÊúâÁõ∏ÂÖ≥Â§çÈÄâÊ°ÜÁöÑÁä∂ÊÄÅ
                        aiCallEnabledCheckboxes.forEach(cb => {
                            if (cb !== this) {
                                cb.checked = this.checked;
                            }
                        });
                        
                        saveChatSettings();
                    }
                });
            });
            
            // ÁªëÂÆöÊà≥‰∏ÄÊà≥ÂäüËÉΩÂºÄÂÖ≥‰∫ã‰ª∂
            const pokeEnabledCheckbox = document.getElementById('poke-enabled');
            if (pokeEnabledCheckbox) {
                pokeEnabledCheckbox.addEventListener('change', function() {
                    const pokeSuffixSettings = document.getElementById('poke-suffix-settings');
                    if (pokeSuffixSettings) {
                        pokeSuffixSettings.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // ÁªëÂÆöÈÄâÊã©Ê®°ÂºèÊåâÈíÆ‰∫ã‰ª∂
            const selectionCancelBtn = document.getElementById('selection-cancel-btn');
            const selectionDeleteBtn = document.getElementById('selection-delete-btn');
            
            if (selectionCancelBtn) {
                selectionCancelBtn.addEventListener('click', exitMessageSelectionMode);
            }
            
            if (selectionDeleteBtn) {
                selectionDeleteBtn.addEventListener('click', function() {
                    if (selectedMessages.size === 0) return;
                    
                    deleteSelectedMessages();
                });
            }
        }
        
        // Êà≥‰∏ÄÊà≥ÂäüËÉΩ
        function pokeCharacter(characterId) {
            if (!currentChatCharacter || currentChatCharacter.id !== characterId) {
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const pokeSuffix = chatSettings.myPokeSuffix || '';
            const characterName = chatSettings.aiChatNickname || currentChatCharacter.name;
            
            // ÂàõÂª∫Êà≥‰∏ÄÊà≥Á≥ªÁªüÊ∂àÊÅØ
            const pokeMessage = {
                id: Date.now().toString(),
                sender: 'system',
                content: `‰Ω†Êà≥‰∫ÜÊà≥${characterName}${pokeSuffix}`,
                timestamp: Date.now(),
                isPoke: true
            };
            
            // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
            if (!chatMessages[characterId]) {
                chatMessages[characterId] = [];
            }
            
            chatMessages[characterId].push(pokeMessage);
            saveChatMessages();
            
            // Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages(characterId);
            
            // Ê®°ÊãüËßíËâ≤ÂõûÂ∫îÔºà40%Ê¶ÇÁéáÔºâ
            if (Math.random() < 0.4) {
                setTimeout(() => {
                    const aiPokeSuffix = chatSettings.aiPokeSuffix || '';
                    const aiPokeMessage = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `${characterName}Êà≥‰∫ÜÊà≥‰Ω†${aiPokeSuffix}`,
                        timestamp: Date.now(),
                        isPoke: true
                    };
                    
                    chatMessages[characterId].push(aiPokeMessage);
                    saveChatMessages();
                    renderChatMessages(characterId);
                }, 1000 + Math.random() * 2000);
            }
        }
        
        // ÊòæÁ§∫ËÅäÂ§©ÈÄâÈ°π
        function showChatOptions() {
            showModal('chat-options-modal');
        }
        
        // ÊòæÁ§∫ÂçïËÅäË∫´‰ªΩÈÄâÊã©ÔºàÁ¨¨‰∏ÄÊ≠•Ôºâ
        function showSingleChatSelector() {
            hideModal('chat-options-modal');
            showPersonaSelectionForSingleChat();
        }
        
        // ÊòæÁ§∫ÂçïËÅäË∫´‰ªΩÈÄâÊã©
        function showPersonaSelectionForSingleChat() {
            const modalHTML = `
                <div class="modal" id="persona-selection-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">ÈÄâÊã©Ë∫´‰ªΩ</h3>
                            <button class="modal-close" onclick="hidePersonaSelectionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p class="selection-description">ËØ∑ÈÄâÊã©‰Ω†Âú®ËøôÊ¨°ÂØπËØù‰∏≠‰ΩøÁî®ÁöÑË∫´‰ªΩÈù¢ÂÖ∑</p>
                            <div class="persona-selection-list" id="persona-selection-list">
                                ${personas.map(persona => `
                                    <div class="persona-selection-item" data-persona-id="${persona.id}">
                                        <div class="persona-selection-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                                            ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                                        </div>
                                        <div class="persona-selection-info">
                                            <div class="persona-selection-name">${persona.name}</div>
                                            <div class="persona-selection-desc">${truncateText(persona.description || 'ÊöÇÊó†ÊèèËø∞', 100)}</div>
                                        </div>
                                        <div class="persona-selection-check">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-secondary" onclick="hidePersonaSelectionModal()">ÂèñÊ∂à</button>
                            <button class="modal-primary" id="confirm-persona-btn" onclick="confirmPersonaAndShowCharacters()" disabled>‰∏ã‰∏ÄÊ≠•ÔºöÈÄâÊã©ËßíËâ≤</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊ®°ÊÄÅÊ°Ü
            const existingModal = document.getElementById('persona-selection-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
            document.querySelectorAll('.persona-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.persona-selection-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    window.selectedPersonaForChat = this.dataset.personaId;
                    document.getElementById('confirm-persona-btn').disabled = false;
                });
            });
        }
        
        // ÈöêËóèË∫´‰ªΩÈÄâÊã©Ê®°ÊÄÅÊ°Ü
        function hidePersonaSelectionModal() {
            const modal = document.getElementById('persona-selection-modal');
            if (modal) {
                modal.remove();
            }
            window.selectedPersonaForChat = null;
        }
        
        // Á°ÆËÆ§Ë∫´‰ªΩÈÄâÊã©Âπ∂ÊòæÁ§∫ËßíËâ≤ÈÄâÊã©
        function confirmPersonaAndShowCharacters() {
            if (!window.selectedPersonaForChat) return;
            
            hidePersonaSelectionModal();
            showCharacterSelectionForSingleChat();
        }
        
        // ÊòæÁ§∫ÂçïËÅäËßíËâ≤ÈÄâÊã©ÔºàÁ¨¨‰∫åÊ≠•Ôºâ
        function showCharacterSelectionForSingleChat() {
            // üî•„Äê‰øÆÂ§ç„Äë‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑË∫´‰ªΩIDÔºåÈò≤Ê≠¢Âú®ÂêéÁª≠ÊµÅÁ®ã‰∏≠‰∏¢Â§±
            const savedPersonaId = window.selectedPersonaForChat;
            console.log('=== showCharacterSelectionForSingleChat ===');
            console.log('‰øùÂ≠òÁöÑË∫´‰ªΩID:', savedPersonaId);
            
            const modalBody = document.getElementById('single-chat-body');
            modalBody.innerHTML = '';
            
            if (characters.length === 0) {
                modalBody.innerHTML = '<p class="empty-mount-chats">ËøòÊ≤°ÊúâËßíËâ≤ÔºåËØ∑ÂÖàÂàõÂª∫ËßíËâ≤</p>';
            } else {
                characters.forEach(character => {
                    const chatOption = document.createElement('div');
                    // üî•„ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•ËßíËâ≤ÊòØÂê¶Â∑≤Â≠òÂú®ÂØπËØùÔºåÊ∑ªÂä†‰∏çÂêåÁöÑCSSÁ±ª
                    const hasExistingChat = contacts.includes(character.id);
                    chatOption.className = `chat-option-item ${hasExistingChat ? 'has-existing-chat' : ''}`;
                    
                    chatOption.onclick = () => {
                        // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®‰øùÂ≠òÁöÑË∫´‰ªΩIDËÄå‰∏çÊòØÂÖ®Â±ÄÂèòÈáè
                        console.log('=== ËßíËâ≤ÈÄâÊã©ÁÇπÂáª‰∫ã‰ª∂ ===');
                        console.log('ÈÄâ‰∏≠ÁöÑËßíËâ≤:', character.name);
                        console.log('‰ΩøÁî®ÁöÑË∫´‰ªΩID:', savedPersonaId);
                        
                        hideModal('single-chat-modal');
                        // ËÆæÁΩÆÈÄâÊã©ÁöÑË∫´‰ªΩÂπ∂ÂºÄÂßãËÅäÂ§©
                        startChatWithPersona(character, savedPersonaId);
                        
                        // Ê∏ÖÁêÜ‰∏¥Êó∂ÂèòÈáè
                        window.selectedPersonaForChat = null;
                    };
                    
                    // üî•„ÄêÊñ∞Â¢û„Äë‰∏∫Â∑≤Â≠òÂú®ÂØπËØùÁöÑËßíËâ≤Ê∑ªÂä†Áä∂ÊÄÅÊèêÁ§∫
                    const statusIndicator = hasExistingChat ? `
                        <div class="chat-status-indicator">
                            <i class="fas fa-comments"></i>
                            <span>Â∑≤ÊúâÂØπËØù</span>
                        </div>
                    ` : '';
                    
                    chatOption.innerHTML = `
                        <div class="chat-option-icon" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}${hasExistingChat ? ' <span class="chat-exists-badge">Â∑≤ÊúâÂØπËØù</span>' : ''}</div>
                            <div class="chat-option-desc">${truncateText(character.bio || 'ÊöÇÊó†ÊèèËø∞', 80)}</div>
                        </div>
                        ${statusIndicator}
                    `;
                    
                    modalBody.appendChild(chatOption);
                });
            }
            
            showModal('single-chat-modal');
        }
        
        async function startChatWithPersona(character, personaId) {
            console.log('‚úÖ[‰øÆÂ§ç] startChatWithPersona Ë¢´Ë∞ÉÁî®');
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•ËØ•ËßíËâ≤ÊòØÂê¶Â∑≤Â≠òÂú®ÂØπËØù
            if (contacts.includes(character.id)) {
                // ËßíËâ≤Â∑≤Â≠òÂú®ÂØπËØùÔºåËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶Ë¶ÅÁªßÁª≠ÊàñÂèñÊ∂à
                const existingSettings = chatSettings[character.id] || {};
                const existingPersona = personas.find(p => p.id === existingSettings.selectedIdentityId);
                const existingIdentityName = existingPersona ? existingPersona.name : 'Êú™Áü•Ë∫´‰ªΩ';
                
                const confirmed = confirm(
                    `ËßíËâ≤„Äå${character.name}„ÄçÂ∑≤Â≠òÂú®ÂØπËØùÔºÅ\n` +
                    `ÂΩìÂâçÂØπËØù‰ΩøÁî®ÁöÑË∫´‰ªΩÔºö${existingIdentityName}\n\n` +
                    `ÈÄâÊã©„ÄåÁ°ÆÂÆö„ÄçÔºöÁªßÁª≠‰ΩøÁî®Áé∞ÊúâÂØπËØù\n` +
                    `ÈÄâÊã©„ÄåÂèñÊ∂à„ÄçÔºöÊîæÂºÉÊú¨Ê¨°Êìç‰Ωú`
                );
                
                if (confirmed) {
                    // Áî®Êà∑ÈÄâÊã©ÁªßÁª≠‰ΩøÁî®Áé∞ÊúâÂØπËØùÔºåÁõ¥Êé•ÂºÄÂßãËÅäÂ§©
                    startChat(character);
                    return;
                } else {
                    // Áî®Êà∑ÈÄâÊã©ÂèñÊ∂àÔºå‰∏çËøõË°å‰ªª‰ΩïÊìç‰Ωú
                    return;
                }
            }
            
            // üî•„ÄêÊñ∞Â¢ûË∫´‰ªΩËÆæÁΩÆÈÄªËæë„ÄëËßíËâ≤‰∏çÂ≠òÂú®ÂØπËØùÔºåÂàõÂª∫Êñ∞ÂØπËØùÂπ∂ËÆæÁΩÆË∫´‰ªΩ
            if (personaId) {
                // Ëé∑ÂèñÊàñÂàõÂª∫Ê≠§ËÅäÂ§©ÁöÑ‰∏ìÂ±ûËÆæÁΩÆ
                let settings = chatSettings[character.id] || {};
                settings.selectedIdentityId = personaId;
                const selectedPersona = personas.find(p => p.id === personaId);
                if (selectedPersona) {
                    settings.myChatAvatar = selectedPersona.avatarUrl || '';
                    settings.myChatNickname = selectedPersona.name || '';
                    chatSettings[character.id] = settings;
                    await saveCurrentChatSettings(settings);
                }
            }
            
            // Ê∑ªÂä†Âà∞ËÅîÁ≥ª‰∫∫ÂàóË°®
            console.log('‚úÖ[‰øÆÂ§ç] ÂèëÁé∞Êñ∞ËÅîÁ≥ª‰∫∫ÔºåÊ≠£Âú®ÂêåÊ≠•‰øùÂ≠ò...');
            contacts.push(character.id);
            // ‰ΩøÁî® await Á°Æ‰øù‰øùÂ≠òÊìç‰ΩúÂÆåÊàêÂêéÂÜçÁªßÁª≠
            await saveContacts();
            console.log('‚úÖ[‰øÆÂ§ç] Êñ∞ËÅîÁ≥ª‰∫∫‰øùÂ≠òÊàêÂäüÔºåÂÜÖÂ≠ò‰∏≠ÁöÑ contacts ÂàóË°®:', contacts);
            // ‰øùÂ≠òÊàêÂäüÂêéÔºåÁ´ãÂç≥Âà∑Êñ∞‰∏ÄÊ¨°Ê∂àÊÅØÂàóË°®ÁöÑÂêéÂè∞Êï∞ÊçÆ
            renderMessageList();
            
            // ÂºÄÂßãËÅäÂ§©
            startChat(character);
        }
        
        
        // ÂàáÊç¢Áæ§ËÅäÊàêÂëòÈÄâÊã©
        function toggleGroupMemberSelection(characterId) {
            const index = selectedGroupMembers.indexOf(characterId);
            const checkbox = document.getElementById(`checkbox-${characterId}`);
            const memberItem = checkbox.closest('.group-member-item');
            
            if (index > -1) {
                selectedGroupMembers.splice(index, 1);
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                memberItem.classList.remove('selected');
            } else {
                if (selectedGroupMembers.length >= 8) {
                    alert('ÊúÄÂ§öÂè™ËÉΩÈÄâÊã©8‰∏™ÊàêÂëò');
                    return;
                }
                selectedGroupMembers.push(characterId);
                checkbox.classList.add('checked');
                checkbox.innerHTML = '<i class="fas fa-check"></i>';
                memberItem.classList.add('selected');
            }
        }
        
 // --- ËØ∑‰ªéËøôÈáåÂºÄÂßãÔºåÂÆåÊï¥Â§çÂà∂ÊâÄÊúâ‰ª£Á†Å ---

// 1. ÊòæÁ§∫ËÅäÂ§©ÈÄâÈ°πÔºàÂÖ•Âè£ÂáΩÊï∞Ôºå‰øùÊåÅ‰∏çÂèòÔºâ
        function showGroupChatSelector() {
            hideModal('chat-options-modal');
            showPersonaSelectionForGroupChat();
        }
        
// 2. ÊòæÁ§∫Áæ§ËÅäË∫´‰ªΩÈÄâÊã©
        function showPersonaSelectionForGroupChat() {
            const modalHTML = `
                <div class="modal" id="persona-selection-group-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">ÈÄâÊã©Ë∫´‰ªΩ</h3>
                            <button class="modal-close" onclick="hidePersonaSelectionGroupModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p class="selection-description">ËØ∑ÈÄâÊã©‰Ω†Âú®Ëøô‰∏™Áæ§ËÅä‰∏≠‰ΩøÁî®ÁöÑË∫´‰ªΩÈù¢ÂÖ∑</p>
                            <div class="persona-selection-list" id="persona-selection-group-list">
                                ${personas.map(persona => `
                                    <div class="persona-selection-item" data-persona-id="${persona.id}">
                                <div class="persona-selection-avatar" style="${persona.avatarUrl ? `background-image: url('${persona.avatarUrl}'); background-size: cover; background-position: center;` : ''}">
                                            ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                                        </div>
                                        <div class="persona-selection-info">
                                            <div class="persona-selection-name">${persona.name}</div>
                                            <div class="persona-selection-desc">${truncateText(persona.description || 'ÊöÇÊó†ÊèèËø∞', 100)}</div>
                                        </div>
                                <div class="persona-selection-check"><i class="fas fa-check"></i></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-secondary" onclick="hidePersonaSelectionGroupModal()">ÂèñÊ∂à</button>
                    <button class="modal-primary" id="confirm-group-persona-btn" disabled>‰∏ã‰∏ÄÊ≠•ÔºöËÆæÁΩÆÁæ§ËÅä</button>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('persona-selection-group-modal');
    if (existingModal) existingModal.remove();
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
    let selectedPersonaId = null;

            document.querySelectorAll('#persona-selection-group-modal .persona-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('#persona-selection-group-modal .persona-selection-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
            selectedPersonaId = this.dataset.personaId;
                    document.getElementById('confirm-group-persona-btn').disabled = false;
                    console.log('‚úÖ ÈÄâÊã©‰∫ÜË∫´‰ªΩ:', selectedPersonaId, 'Ë∫´‰ªΩÂêçÁß∞:', this.querySelector('.persona-selection-name').textContent);
                });
            });

    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöËÆ©‚Äú‰∏ã‰∏ÄÊ≠•‚ÄùÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂Áõ¥Êé•Ë∞ÉÁî®‰∏ã‰∏ÄÊ≠•ÂáΩÊï∞ÔºåÂπ∂ÊääID‰º†ËøáÂéª
    document.getElementById('confirm-group-persona-btn').onclick = () => {
        console.log('‚úÖ ÁÇπÂáª‰∏ã‰∏ÄÊ≠•ÊåâÈíÆÔºåÂΩìÂâçselectedPersonaIdÂÄº‰∏∫:', selectedPersonaId);
        if (selectedPersonaId) {
            console.log('‚úÖ ÂáÜÂ§áË∞ÉÁî®confirmPersonaAndShowGroupSettingsÔºå‰º†ÈÄíID:', selectedPersonaId);
            confirmPersonaAndShowGroupSettings(selectedPersonaId);
        } else {
            console.error('‚ùå Êú™ÈÄâÊã©Ë∫´‰ªΩÂ∞±ÁÇπÂáª‰∫Ü‰∏ã‰∏ÄÊ≠•');
            alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë∫´‰ªΩÈù¢ÂÖ∑');
        }
    };
}

// 3. ÈöêËóèË∫´‰ªΩÈÄâÊã©Ê®°ÊÄÅÊ°ÜÁöÑÂáΩÊï∞
        function hidePersonaSelectionGroupModal() {
            const modal = document.getElementById('persona-selection-group-modal');
    if (modal) modal.remove();
}

// 4. Á°ÆËÆ§Ë∫´‰ªΩÂπ∂ÊòæÁ§∫Áæ§ÊàêÂëòÈÄâÊã©
function confirmPersonaAndShowGroupSettings(personaId) {
    console.log('‚úÖ confirmPersonaAndShowGroupSettingsË¢´Ë∞ÉÁî®ÔºåÊé•Êî∂Âà∞ÁöÑpersonaId:', personaId);
            hidePersonaSelectionGroupModal();
    showGroupChatMemberSelection(personaId); // Â∞ÜÈÄâÊã©ÁöÑID‰Ωú‰∏∫ÂèÇÊï∞‰º†ÈÄíÁªô‰∏ã‰∏ÄÊ≠•
        }
        
// 5. ÊòæÁ§∫Áæ§ÊàêÂëòÈÄâÊã© (Â∑≤ÊÅ¢Â§çÁÆÄ‰ªãÊòæÁ§∫)
function showGroupChatMemberSelection(personaId) {
    console.log('‚úÖ showGroupChatMemberSelectionË¢´Ë∞ÉÁî®ÔºåÊé•Êî∂Âà∞ÁöÑpersonaId:', personaId);
    
    // Á´ãÂç≥Â∞ÜpersonaIdÂ≠òÂÇ®Âà∞ÂÖ®Â±ÄÂèòÈáè‰∏≠ÔºåÁ°Æ‰øù‰∏ç‰ºö‰∏¢Â§±
    window.currentGroupPersonaId = personaId;
            document.getElementById('group-chat-name').value = '';
            selectedGroupMembers = [];
            
            const membersContainer = document.getElementById('group-chat-members');
            membersContainer.innerHTML = '';
            
            if (characters.length < 2) {
                membersContainer.innerHTML = '<p class="empty-mount-chats">Ëá≥Â∞ëÈúÄË¶Å2‰∏™ËßíËâ≤ÊâçËÉΩÂàõÂª∫Áæ§ËÅä</p>';
            } else {
                characters.forEach(character => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.onclick = () => toggleGroupMemberSelection(character.id);
            // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊÅ¢Â§ç‰∫ÜÊòæÁ§∫ËßíËâ≤ÁÆÄ‰ªãÁöÑHTML‰ª£Á†Å
                    memberItem.innerHTML = `
                <div class="group-member-checkbox" id="checkbox-${character.id}"></div>
                <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url('${character.avatarUrl}');` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}</div>
                    <div class="chat-option-desc">${truncateText(character.bio || 'ÊöÇÊó†ÁÆÄ‰ªã', 80)}</div>
                </div>`;
                    membersContainer.appendChild(memberItem);
                });
            }

    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂ∞Ü personaId ÁªëÂÆöÂà∞ÊúÄÁªàÁöÑ‚ÄúÂàõÂª∫Áæ§ËÅä‚ÄùÊåâÈíÆ‰∏ä
    console.log('‚úÖ Âú®Á¨¨‰∏Ä‰∏™‰ΩçÁΩÆÁªëÂÆöÂàõÂª∫ÊåâÈíÆÔºåpersonaId:', personaId);
    const createBtn = document.getElementById('group-chat-modal').querySelector('.modal-primary');
    createBtn.onclick = () => {
        console.log('‚úÖ Á¨¨‰∏Ä‰∏™‰ΩçÁΩÆÁöÑÂàõÂª∫Áæ§ËÅäÊåâÈíÆË¢´ÁÇπÂáªÔºåÁõ¥Êé•‰ΩøÁî®ÂèÇÊï∞personaId:', personaId);
        createGroupChat(personaId);
    }; // ÁªëÂÆöÂ∏¶ÂèÇÊï∞ÁöÑÂàõÂª∫ÂáΩÊï∞
            
            showModal('group-chat-modal');
        }
        
// 6. ÂàáÊç¢Áæ§ÊàêÂëòÈÄâÊã©Áä∂ÊÄÅ (Êó†‰øÆÊîπÔºå‰ΩÜ‰∏∫‰∫ÜÂÆåÊï¥ÊÄßÂåÖÂê´Âú®Ê≠§)
        function toggleGroupMemberSelection(characterId) {
            const index = selectedGroupMembers.indexOf(characterId);
            const checkbox = document.getElementById(`checkbox-${characterId}`);
            const memberItem = checkbox.closest('.group-member-item');
            
            if (index > -1) {
                selectedGroupMembers.splice(index, 1);
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                memberItem.classList.remove('selected');
            } else {
                if (selectedGroupMembers.length >= 8) {
                    alert('ÊúÄÂ§öÂè™ËÉΩÈÄâÊã©8‰∏™ÊàêÂëò');
                    return;
                }
                selectedGroupMembers.push(characterId);
                checkbox.classList.add('checked');
                checkbox.innerHTML = '<i class="fas fa-check"></i>';
                memberItem.classList.add('selected');
            }
        }
        

// 7. ÂàõÂª∫Áæ§ËÅäÔºàÊúÄÁªàÁâàÊú¨Ôºâ
async function createGroupChat(personaId) {
    console.log(`‚úÖ createGroupChatË¢´Ë∞ÉÁî®ÔºåË∫´‰ªΩID: ${personaId}`);

    const groupName = document.getElementById('group-chat-name').value.trim();
    if (!groupName) return alert('ËØ∑ËæìÂÖ•Áæ§ËÅäÂêçÁß∞');
    if (selectedGroupMembers.length < 2) return alert('Ëá≥Â∞ëÈúÄË¶ÅÈÄâÊã©2‰∏™ÊàêÂëò');



            const memberDetails = selectedGroupMembers.map(memberId => {
                const character = characters.find(c => c.id === memberId);
        return { id: character.id, name: character.name, bio: character.bio, avatarUrl: character.avatarUrl, color: character.color };
    });

            const groupChat = {
                id: 'group_' + Date.now().toString(),
                name: groupName,
                members: memberDetails,
                isGroup: true,
                createdAt: new Date().toISOString()
            };
            
    // Âè™ÊúâÂú® personaId Â≠òÂú®Êó∂Êâç‰øùÂ≠òË∫´‰ªΩËÆæÁΩÆ
    if (personaId) {
        const selectedPersona = personas.find(p => p.id === personaId);
                if (selectedPersona) {
                    const chatSettings = {
                selectedIdentityId: personaId,
                        myChatAvatar: selectedPersona.avatarUrl,
                        myChatNickname: selectedPersona.name,
                selectedPersonaData: { ...selectedPersona }
            };
                    // Á°Æ‰øù window.chatSettings Â∑≤ÂàùÂßãÂåñ
                    if (!window.chatSettings) {
                        window.chatSettings = {};
                    }
                    window.chatSettings[groupChat.id] = chatSettings;
            await db.chatSettings.put({ id: groupChat.id, chatId: groupChat.id, settings: chatSettings });
            console.log('‚úÖ Áæ§ËÅäË∫´‰ªΩËÆæÁΩÆÂ∑≤ÊàêÂäü‰øùÂ≠ò');
                } else {
            console.error('‚ùå ÂàõÂª∫Áæ§ËÅäÊó∂Êú™ÊâæÂà∞ID‰∏∫ ' + personaId + ' ÁöÑË∫´‰ªΩ„ÄÇ');
                }
            }
            
            if (!groupChats) groupChats = [];
            groupChats.push(groupChat);
            await saveGroupChats();
            hideModal('group-chat-modal');
            renderMessageList();
            alert(`Áæ§ËÅä"${groupName}"ÂàõÂª∫ÊàêÂäüÔºÅ`);
        }

// --- ËØ∑Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ---
        
        // ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ - ‰ΩøÁî®IndexedDB
        async function saveGroupChats() {
            try {
                console.log('‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆÂà∞IndexedDB:', groupChats);
                
                // Ê£ÄÊü•Êï∞ÊçÆÂÆåÊï¥ÊÄß
                if (!groupChats || !Array.isArray(groupChats)) {
                    console.error('Áæ§ËÅäÊï∞ÊçÆÊó†Êïà:', groupChats);
                    groupChats = [];
                }
                
                // È™åËØÅÊØè‰∏™Áæ§ËÅäÂØπË±°ÁöÑÂÆåÊï¥ÊÄß
                const validGroupChats = groupChats.filter(chat => {
                    if (!chat || !chat.id || !chat.name) {
                        console.warn('ÂèëÁé∞Êó†ÊïàÁöÑÁæ§ËÅäÂØπË±°:', chat);
                        return false;
                    }
                    return true;
                });
                
                // Â¶ÇÊûúÊúâÊó†ÊïàÊï∞ÊçÆÔºåÊõ¥Êñ∞Êï∞ÁªÑ
                if (validGroupChats.length !== groupChats.length) {
                    groupChats = validGroupChats;
                    console.log('Â∑≤ËøáÊª§Êó†ÊïàÊï∞ÊçÆÔºåÊúâÊïàÁæ§ËÅäÊï∞Èáè:', groupChats.length);
                }
                
                // ‰ΩøÁî®‰∫ãÂä°Êù•Á°Æ‰øùÊï∞ÊçÆ‰∏ÄËá¥ÊÄß
                await db.transaction('rw', db.groupChats, async () => {
                // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
                await db.groupChats.clear();
                
                    // ÈÄê‰∏™ÊèíÂÖ•Êï∞ÊçÆ‰ª•ÈÅøÂÖçÊâπÈáèÊèíÂÖ•ÁöÑIDÂÜ≤Á™ÅÈóÆÈ¢ò
                    for (const chat of groupChats) {
                        try {
                            await db.groupChats.add(chat);
                        } catch (addError) {
                            console.warn('ÊèíÂÖ•Áæ§ËÅäÂ§±Ë¥•ÔºåÂ∞ùËØïÊõ¥Êñ∞:', chat.id, addError);
                            // Â¶ÇÊûúÊ∑ªÂä†Â§±Ë¥•ÔºåÂ∞ùËØïÊõ¥Êñ∞
                            await db.groupChats.put(chat);
                        }
                    }
                });
                
                console.log('Áæ§ËÅäÊï∞ÊçÆ‰øùÂ≠òÊàêÂäüÂà∞IndexedDB');
                
                // ÂêåÊó∂‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫Â§á‰ªΩ
                try {
                    localStorage.setItem('groupChats', JSON.stringify(groupChats));
                    console.log('Áæ§ËÅäÊï∞ÊçÆÂ§á‰ªΩÂà∞localStorageÊàêÂäü');
                } catch (storageError) {
                    console.warn('localStorageÂ§á‰ªΩÂ§±Ë¥•:', storageError);
                    // localStorageÂ§±Ë¥•‰∏çÂ∫îËØ•ÈòªÊ≠¢IndexedDBÁöÑÊàêÂäü‰øùÂ≠ò
                }
                
            } catch (error) {
                console.error('‰øùÂ≠òÁæ§ËÅäÂà∞IndexedDBÂ§±Ë¥•:', error);
                console.error('ÈîôËØØËØ¶ÊÉÖ:', error.name, error.message);
                
                // Â¶ÇÊûúIndexedDBÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorage
                try {
                    localStorage.setItem('groupChats', JSON.stringify(groupChats || []));
                    console.log('Áæ§ËÅäÊï∞ÊçÆÂõûÈÄÄ‰øùÂ≠òÂà∞localStorageÊàêÂäü');
                    showToast('Áæ§ËÅäÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®', 'info');
                } catch (localError) {
                    console.error('localStorage‰øùÂ≠ò‰πüÂ§±Ë¥•:', localError);
                    console.error('localStorageÈîôËØØËØ¶ÊÉÖ:', localError.name, localError.message);
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ≠òÂÇ®Á©∫Èó¥‰∏çË∂≥
                    if (localError.name === 'QuotaExceededError') {
                        alert('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåËØ∑Ê∏ÖÁêÜ‰∏Ä‰∫õÊï∞ÊçÆÂêéÈáçËØï');
                    } else {
                        alert('‰øùÂ≠òÁæ§ËÅäÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÂà∑Êñ∞È°µÈù¢ÈáçÊñ∞Êìç‰Ωú');
                    }
                    
                    // ÊÅ¢Â§çÂà∞‰πãÂâçÁöÑÁä∂ÊÄÅ
                    groupChats.pop(); // ÁßªÈô§ÂàöÊ∑ªÂä†ÁöÑÁæ§ËÅä
                    throw localError;
                }
            }
        }
        
        // Ê∏≤ÊüìÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function renderScheduleTimes() {
            const container = document.getElementById('schedule-times-container');
            if (!container) return;
            
            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduleTimes || [];
            
            container.innerHTML = '';
            
            scheduleTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'schedule-time-item';
                timeItem.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${index}, this.value)">
                    <button onclick="removeScheduleTime(${index})">√ó</button>
                `;
                container.appendChild(timeItem);
            });
        }
        
        // Ê∑ªÂä†ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        async function addScheduleTime() {
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduleTimes) {
                chatSettings.scheduleTimes = [];
            }
            
            if (chatSettings.scheduleTimes.length >= 10) {
                alert('ÊúÄÂ§öÂè™ËÉΩËÆæÁΩÆ10‰∏™Êó∂Èó¥ÁÇπ');
                return;
            }
            
            chatSettings.scheduleTimes.push('09:00');
            await saveCurrentChatSettings(chatSettings);
            renderScheduleTimes();
        }
        
        // Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        async function updateScheduleTime(index, newTime) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes[index] = newTime;
                await saveCurrentChatSettings(chatSettings);
            }
        }
        
        // ÁßªÈô§ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        async function removeScheduleTime(index) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes.splice(index, 1);
                await saveCurrentChatSettings(chatSettings);
                renderScheduleTimes();
            }
        }
        
        // ‰øùÂ≠òÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ
        async function saveScheduleSettings() {
            const chatSettings = getCurrentChatSettings();
            chatSettings.scheduleEnabled = document.getElementById('schedule-enabled').checked;
            
            await saveCurrentChatSettings(chatSettings);
            hideModal('schedule-settings-modal');
            showToast('ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ÊòæÁ§∫‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆ
        function showWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            document.getElementById('worldbook-mount-enabled').checked = chatSettings.worldbookMountEnabled || false;
            
            // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÁöÑÊòæÁ§∫
            toggleWorldbookMountDetails();
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('worldbook-mount-enabled').onchange = toggleWorldbookMountDetails;
            
            // Ê∏≤Êüì‰∏ñÁïå‰π¶ÂàóË°®
            renderWorldbookMountList();
            
            showModal('worldbook-mount-modal');
        }
        
        // ÂàáÊç¢‰∏ñÁïå‰π¶ÊåÇËΩΩËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
        function toggleWorldbookMountDetails() {
            const enabled = document.getElementById('worldbook-mount-enabled').checked;
            document.getElementById('worldbook-mount-details').style.display = enabled ? 'block' : 'none';
            
            // Êõ¥Êñ∞‰∏ªËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫
            updateWorldbookMountDisplay();
        }
        
        // Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫Áä∂ÊÄÅ
        function updateWorldbookMountDisplay() {
            // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåË∑≥Ëøá
            if (!currentChatCharacter) {
                console.log("Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫ÔºöÊó†ÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåË∑≥ËøáÊìç‰Ωú");
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const displayElement = document.getElementById('current-worldbook-mount');
            
            if (!displayElement) {
                console.log("Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫ÔºöÊó†ÊòæÁ§∫ÂÖÉÁ¥†ÔºåË∑≥ËøáÊìç‰Ωú");
                return;
            }
            
            if (!chatSettings.worldbookMountEnabled) {
                displayElement.textContent = 'Êú™ÊåÇËΩΩ';
                return;
            }
            
            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];
            if (selectedWorldbooks.length === 0) {
                displayElement.textContent = 'Â∑≤ÂêØÁî®‰ΩÜÊú™ÈÄâÊã©';
            } else if (selectedWorldbooks.length === 1) {
                const worldbook = worldbooks.find(w => w.id === selectedWorldbooks[0]);
                displayElement.textContent = worldbook ? `Â∑≤ÊåÇËΩΩ: ${worldbook.title}` : 'Â∑≤ÊåÇËΩΩ: 1‰∏™';
            } else {
                displayElement.textContent = `Â∑≤ÊåÇËΩΩ: ${selectedWorldbooks.length}‰∏™`;
            }
        }
        
        // Ê∏≤Êüì‰∏ñÁïå‰π¶ÊåÇËΩΩÂàóË°®
        function renderWorldbookMountList() {
            const container = document.getElementById('worldbook-mount-list');
            container.innerHTML = '';
            
            // ËøáÊª§ÊéâÂÖ®Â±Ä‰∏ñÁïå‰π¶ÔºåÂè™ÊòæÁ§∫Â±ÄÈÉ®‰∏ñÁïå‰π¶
            const localWorldbooks = worldbooks.filter(w => !w.isGlobal);
            
            if (localWorldbooks.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">ÊöÇÊó†Â±ÄÈÉ®‰∏ñÁïå‰π¶ÔºåËØ∑ÂÖàÂú®‰∏ñÁïå‰π¶Â∫îÁî®‰∏≠ÂàõÂª∫</p>';
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];
            
            localWorldbooks.forEach(worldbook => {
                const item = document.createElement('div');
                item.className = 'mount-item worldbook-mount-item';
                
                const isSelected = selectedWorldbooks.includes(worldbook.id);
                
                item.innerHTML = `
                    <input type="checkbox" id="worldbook-${worldbook.id}" value="${worldbook.id}" ${isSelected ? 'checked' : ''} class="worldbook-checkbox">
                    <div class="worldbook-content-flex">
                        <div class="worldbook-title-text">
                            ${worldbook.title}
                        </div>
                        <div class="worldbook-desc-text">
                            ${worldbook.content.length > 100 ? worldbook.content.substring(0, 100) + '...' : worldbook.content}
                        </div>
                        <div class="worldbook-date-text">
                            ÂàõÂª∫‰∫é: ${new Date(worldbook.createdAt).toLocaleDateString('zh-CN')} | 
                            Â≠óÊï∞: ${worldbook.content.length}
                        </div>
                    </div>
                `;
                
                // ÁÇπÂáªÊï¥‰∏™Êù°ÁõÆ‰πüËÉΩÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
                item.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                };
                
                container.appendChild(item);
            });
            
            // Ê∑ªÂä†ÊèêÁ§∫ËØ¥ÊòéÂÖ®Â±Ä‰∏ñÁïå‰π¶Ëá™Âä®Â∫îÁî®
            const globalInfo = document.createElement('div');
            globalInfo.className = 'worldbook-global-info';
            globalInfo.innerHTML = '<p class="global-worldbook-note">Ê≥®ÊÑèÔºöÂÖ®Â±Ä‰∏ñÁïå‰π¶Â∑≤Ëá™Âä®Â∫îÁî®‰∫éÊâÄÊúâËÅäÂ§©ÔºåÊó†ÈúÄÊâãÂä®ÊåÇËΩΩ„ÄÇ</p>';
            container.appendChild(globalInfo);
        }
        
        // ‰øùÂ≠ò‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆ
        function saveWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.worldbookMountEnabled = document.getElementById('worldbook-mount-enabled').checked;
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑ‰∏ñÁïå‰π¶
            const checkboxes = document.querySelectorAll('#worldbook-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedWorldbooks = Array.from(checkboxes).map(cb => cb.value);
            
            saveCurrentChatSettings(chatSettings);
            updateWorldbookMountDisplay();
            hideModal('worldbook-mount-modal');
            
            const selectedCount = chatSettings.selectedWorldbooks ? chatSettings.selectedWorldbooks.length : 0;
            if (chatSettings.worldbookMountEnabled && selectedCount > 0) {
                showToast(`‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÂ∑≤ÊåÇËΩΩ ${selectedCount} ‰∏™‰∏ñÁïå‰π¶`, 'success');
            } else if (chatSettings.worldbookMountEnabled) {
                showToast('‰∏ñÁïå‰π¶ÊåÇËΩΩÂ∑≤ÂêØÁî®Ôºå‰ΩÜÊú™ÈÄâÊã©‰ªª‰Ωï‰∏ñÁïå‰π¶', 'info');
            } else {
                showToast('‰∏ñÁïå‰π¶ÊåÇËΩΩÂ∑≤ÂÖ≥Èó≠', 'info');
            }
        }
        
        // Ë∫´‰ªΩÈÄâÊã©Âô®ÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåË∫´‰ªΩÂú®ÂàõÂª∫ÂØπËØùÊó∂ÈÄâÊã©
        
        // ÂéãÁº©ÂõæÁâá‰ª•ÂáèÂ∞ëÂ≠òÂÇ®Á©∫Èó¥
        function compressImage(dataUrl, maxWidth = 300, quality = 0.8) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ËÆ°ÁÆóÊñ∞ÁöÑÂ∞∫ÂØ∏Ôºå‰øùÊåÅÂÆΩÈ´òÊØî
                    let { width, height } = img;
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxWidth) {
                            width = (width * maxWidth) / height;
                            height = maxWidth;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ÁªòÂà∂Âπ∂ÂéãÁº©
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    console.log(`ÂõæÁâáÂéãÁº©Ôºö${Math.round(dataUrl.length/1024)}KB -> ${Math.round(compressedDataUrl.length/1024)}KB`);
                    resolve(compressedDataUrl);
                };
                img.src = dataUrl;
            });
        }
        

        
        // üî•„ÄêÁ¥ßÊÄ•‰øÆÂ§ç„ÄëÊÅ¢Â§çËÆæÁΩÆÂπ∂Âà∑Êñ∞ÁïåÈù¢
        function recoverAndRefreshSettings() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©Á™óÂè£', 'warning');
                return;
            }
            
            const chatId = currentChatCharacter.id;
            console.log(`ÂºÄÂßãÊÅ¢Â§çËÅäÂ§©ËÆæÁΩÆ: ${chatId}`);
            console.log('ÂΩìÂâçËÆæÁΩÆÁä∂ÊÄÅ:', JSON.stringify(chatSettings[chatId], null, 2));
            
            // ÊòæÁ§∫ÊÅ¢Â§çËøõÂ∫¶
            showToast('Ê≠£Âú®Â∞ùËØïÊÅ¢Â§çËÆæÁΩÆ...', 'info');
            
            // üî•„ÄêÁõ¥Êé•ÊÅ¢Â§çÊñπÊ≥ï„ÄëÂº∫Âà∂‰ªélocalStorageÊÅ¢Â§çÔºå‰∏çÈÄöËøágetCurrentChatSettings
            const savedLocalStorage = localStorage.getItem(`chatSettings_${chatId}`);
            if (savedLocalStorage) {
                try {
                    const recoveredSettings = JSON.parse(savedLocalStorage);
                    console.log('‰ªélocalStorageÊÅ¢Â§çÁöÑËÆæÁΩÆ:', JSON.stringify(recoveredSettings, null, 2));
                    
                    // Áõ¥Êé•Ë¶ÜÁõñÂÖ®Â±ÄËÆæÁΩÆ
                    chatSettings[chatId] = recoveredSettings;
                    
                    // Á´ãÂç≥Âà∑Êñ∞ÂΩìÂâçÁïåÈù¢ÁöÑÊòæÁ§∫ÔºàÂ¶ÇÊûúÂú®ËÆæÁΩÆÁïåÈù¢Ôºâ
                    if (document.getElementById('api-chat-settings-screen').style.display !== 'none') {
                        updateChatSettingsDisplay();
                    }
                    
                    // Âà∑Êñ∞ËÅäÂ§©Ê∂àÊÅØÁïåÈù¢
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }
                    
                    showToast('ËÆæÁΩÆÊÅ¢Â§çÊàêÂäüÔºÅ', 'success');
                    console.log('ËÆæÁΩÆÊÅ¢Â§çÂÆåÊàêÔºåÂΩìÂâçËÆæÁΩÆ:', JSON.stringify(chatSettings[chatId], null, 2));
                    return;
                } catch (error) {
                    console.error('Ëß£ÊûêlocalStorageËÆæÁΩÆÂ§±Ë¥•:', error);
                }
            }
            
            // Â¶ÇÊûúlocalStorageÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªéIndexedDBÊÅ¢Â§ç
            db.chatSettings.get(chatId).then(dbSettings => {
                if (dbSettings && dbSettings.settings) {
                    console.log('‰ªéIndexedDBÊÅ¢Â§çÁöÑËÆæÁΩÆ:', JSON.stringify(dbSettings.settings, null, 2));
                    
                    // Áõ¥Êé•Ë¶ÜÁõñÂÖ®Â±ÄËÆæÁΩÆ
                    chatSettings[chatId] = dbSettings.settings;
                    
                    // ÂêåÊ≠•Âà∞localStorage
                    localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(dbSettings.settings));
                    
                    // Á´ãÂç≥Âà∑Êñ∞ÁïåÈù¢
                    if (document.getElementById('api-chat-settings-screen').style.display !== 'none') {
                        updateChatSettingsDisplay();
                    }
                    
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }
                    
                    showToast('‰ªéÂ§á‰ªΩÊï∞ÊçÆÊÅ¢Â§çËÆæÁΩÆÊàêÂäüÔºÅ', 'success');
                    console.log('‰ªéIndexedDBÊÅ¢Â§çËÆæÁΩÆÊàêÂäü:', JSON.stringify(dbSettings.settings, null, 2));
                } else {
                    showToast('Êú™ÊâæÂà∞Â§á‰ªΩÊï∞ÊçÆÔºåËÆæÁΩÆÂèØËÉΩÂ∑≤Ê∞∏‰πÖ‰∏¢Â§±', 'error');
                    console.log('Êú™ÊâæÂà∞‰ªª‰ΩïÂ§á‰ªΩÊï∞ÊçÆ');
                }
            }).catch(error => {
                console.error('‰ªéIndexedDBÊÅ¢Â§çËÆæÁΩÆÂ§±Ë¥•:', error);
                showToast('ÊÅ¢Â§çËÆæÁΩÆÂ§±Ë¥•ÔºåËØ∑ËÅîÁ≥ªÊäÄÊúØÊîØÊåÅ', 'error');
            });
        }
        
        // üî•„ÄêÁ¥ßÊÄ•‰øÆÂ§ç„ÄëÂ∞ùËØïÊÅ¢Â§çË¢´Ë¶ÜÁõñÁöÑËÅäÂ§©ËÆæÁΩÆ
        function recoverChatSettings() {
            if (!currentChatCharacter) return false;
            
            const chatId = currentChatCharacter.id;
            console.log('Â∞ùËØïÊÅ¢Â§çËÅäÂ§©ËÆæÁΩÆ...');
            
            // Â∞ùËØï‰ªélocalStorageÊÅ¢Â§ç
            const savedSettings = localStorage.getItem(`chatSettings_${chatId}`);
            if (savedSettings) {
                try {
                    const userSettings = JSON.parse(savedSettings);
                    chatSettings[chatId] = userSettings;
                    console.log('‰ªélocalStorageÊÅ¢Â§çËÅäÂ§©ËÆæÁΩÆÊàêÂäü:', userSettings);
                    return true;
                } catch (error) {
                    console.error('‰ªélocalStorageÊÅ¢Â§çËÆæÁΩÆÂ§±Ë¥•:', error);
                }
            }
            
            // Â∞ùËØï‰ªéIndexedDBÊÅ¢Â§ç
            db.chatSettings.get(chatId).then(dbSettings => {
                if (dbSettings && dbSettings.settings) {
                    chatSettings[chatId] = dbSettings.settings;
                    console.log('‰ªéIndexedDBÊÅ¢Â§çËÅäÂ§©ËÆæÁΩÆÊàêÂäü:', dbSettings.settings);
                    // ÂêåÊ≠•Âà∞localStorage
                    localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(dbSettings.settings));
                    return true;
                }
            }).catch(error => {
                console.error('‰ªéIndexedDBÊÅ¢Â§çËÆæÁΩÆÂ§±Ë¥•:', error);
            });
            
            return false;
        }
        
        // Âº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÂ§¥ÂÉèÊòæÁ§∫
        function forceRefreshAvatars() {
            const chatSettings = getCurrentChatSettings();
            const currentAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || currentChatCharacter.avatarUrl;
            
            console.log('Âº∫Âà∂Âà∑Êñ∞Â§¥ÂÉèÊòæÁ§∫ÔºåÂΩìÂâçÂ§¥ÂÉè:', currentAvatar ? currentAvatar.substring(0, 50) + '...' : 'Êó†Â§¥ÂÉè');
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰∏≠ÊâÄÊúâËßíËâ≤Â§¥ÂÉè
            const messageAvatars = document.querySelectorAll('.message-avatar');
            messageAvatars.forEach(avatar => {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂΩìÂâçËßíËâ≤ÁöÑÂ§¥ÂÉèÔºàÈÄöËøáÁÇπÂáª‰∫ã‰ª∂Âà§Êñ≠Ôºâ
                const onclickAttr = avatar.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${currentChatCharacter.id}'`)) {
                    if (currentAvatar && currentAvatar !== 'undefined') {
                        avatar.style.backgroundImage = `url(${currentAvatar})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                        avatar.innerHTML = '';
                    } else {
                        avatar.style.backgroundImage = 'none';
                        avatar.innerHTML = currentChatCharacter.name.charAt(0);
                    }
                }
            });
            
            // Â¶ÇÊûúÂΩìÂâçÂú®Â§¥ÂÉèËÆæÁΩÆÁïåÈù¢Ôºå‰πüÂà∑Êñ∞È¢ÑËßà
            const aiAvatarPreview = document.getElementById('ai-chat-avatar-preview');
            if (aiAvatarPreview && currentAvatar && currentAvatar !== 'undefined') {
                aiAvatarPreview.style.backgroundImage = `url(${currentAvatar})`;
                aiAvatarPreview.style.backgroundSize = 'cover';
                aiAvatarPreview.style.backgroundPosition = 'center';
                aiAvatarPreview.innerHTML = '';
                
                // Êõ¥Êñ∞ÊèêÁ§∫‰ø°ÊÅØ
                if (chatSettings.aiDynamicAvatar) {
                    aiAvatarPreview.title = 'ÂΩìÂâçÊòæÁ§∫Âä®ÊÄÅÂ§¥ÂÉèÔºàËßíËâ≤Âú®ËÅäÂ§©‰∏≠Êõ¥Êç¢ÁöÑÔºâ';
                } else {
                    aiAvatarPreview.title = 'ÂΩìÂâçÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆÂ§¥ÂÉè';
                }
            }
        }
        
        // üìä ËÆ°ÁÆóÂ≠òÂÇ®Á©∫Èó¥‰ΩøÁî®ÊÉÖÂÜµ
        async function calculateStorageUsage() {
            try {
                let chatSize = 0;
                let characterSize = 0;
                let settingsSize = 0;
                let emojiSize = 0;

                // ËÆ°ÁÆóËÅäÂ§©ËÆ∞ÂΩïÂ§ßÂ∞è
                const chatMessagesData = await db.chatMessages.toArray();
                chatSize = JSON.stringify(chatMessagesData).length;

                // ËÆ°ÁÆóËßíËâ≤Êï∞ÊçÆÂ§ßÂ∞è
                const charactersData = await db.characters.toArray();
                characterSize = JSON.stringify(charactersData).length;

                // ËÆ°ÁÆóËÅäÂ§©ËÆæÁΩÆÂ§ßÂ∞è
                const chatSettingsData = await db.chatSettings.toArray();
                settingsSize = JSON.stringify(chatSettingsData).length;

                // ËÆ°ÁÆóË°®ÊÉÖÂåÖÂ§ßÂ∞è
                const emojisData = await db.customEmojis.toArray();
                emojiSize = JSON.stringify(emojisData).length;

                const total = chatSize + characterSize + settingsSize + emojiSize;

                // Êõ¥Êñ∞ÊòæÁ§∫
                document.getElementById('chat-storage-size').textContent = formatBytes(chatSize);
                document.getElementById('character-storage-size').textContent = formatBytes(characterSize);
                document.getElementById('settings-storage-size').textContent = formatBytes(settingsSize);
                document.getElementById('emoji-storage-size').textContent = formatBytes(emojiSize);
                document.getElementById('total-storage-size').textContent = formatBytes(total);

                return { chatSize, characterSize, settingsSize, emojiSize, total };
            } catch (error) {
                console.error('ËÆ°ÁÆóÂ≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµÂ§±Ë¥•:', error);
                return null;
            }
        }

        // Ê†ºÂºèÂåñÂ≠óËäÇÊï∞‰∏∫ÂèØËØªÊ†ºÂºè
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // üßπ ÂéãÁº©ÊâÄÊúâÂõæÁâá
        async function compressAllImages() {
            if (!confirm('Â∞ÜÂéãÁº©ÊâÄÊúâÂ§¥ÂÉèÂíåËÉåÊôØÂõæÁâáÔºåËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥„ÄÇÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü')) {
                return;
            }

            showToast('Ê≠£Âú®ÂéãÁº©ÂõæÁâá...', 'info');
            let compressedCount = 0;

            try {
                // ÂéãÁº©ËßíËâ≤Â§¥ÂÉè
                for (const character of characters) {
                    if (character.avatarUrl && character.avatarUrl.length > 50000) {
                        character.avatarUrl = await compressImage(character.avatarUrl, 150, 0.6);
                        compressedCount++;
                    }
                }
                await saveCharacters();

                // ÂéãÁº©ËÅäÂ§©ËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉè
                for (const chatId of Object.keys(chatSettings)) {
                    const settings = chatSettings[chatId];
                    if (settings) {
                        if (settings.aiChatAvatar && settings.aiChatAvatar.length > 50000) {
                            settings.aiChatAvatar = await compressImage(settings.aiChatAvatar, 150, 0.6);
                            compressedCount++;
                        }
                        if (settings.myChatAvatar && settings.myChatAvatar.length > 50000) {
                            settings.myChatAvatar = await compressImage(settings.myChatAvatar, 150, 0.6);
                            compressedCount++;
                        }
                        if (settings.chatBackground && settings.chatBackground.length > 100000) {
                            settings.chatBackground = await compressImage(settings.chatBackground, 800, 0.7);
                            compressedCount++;
                        }
                    }
                }
                await saveChatSettings();

                // Êõ¥Êñ∞Â≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµ
                calculateStorageUsage();

                showToast(`ÂõæÁâáÂéãÁº©ÂÆåÊàêÔºÅÂÖ±Â§ÑÁêÜ‰∫Ü ${compressedCount} Âº†ÂõæÁâá`, 'success');
            } catch (error) {
                console.error('ÂéãÁº©ÂõæÁâáÂ§±Ë¥•:', error);
                showToast('ÂéãÁº©ËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ', 'error');
            }
        }

        // üßπ ÊóßÁâàÊ∏ÖÁêÜÂ≠òÂÇ®Á©∫Èó¥Ôºà‰øùÁïôÂÖºÂÆπÊÄßÔºâ
        async function cleanupStorageSpace() {
            if (!confirm('Â∞ÜÊ∏ÖÁêÜ‰ª•‰∏ãÊï∞ÊçÆ‰ª•ÈáäÊîæÂ≠òÂÇ®Á©∫Èó¥Ôºö\n\n‚Ä¢ ÊâÄÊúâËßíËâ≤ÁöÑÂä®ÊÄÅÂ§¥ÂÉè\n‚Ä¢ localStorage‰∏≠ÁöÑËøáÊúüÊï∞ÊçÆ\n‚Ä¢ ÂéãÁº©Áé∞ÊúâÂ§¥ÂÉèÊï∞ÊçÆ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü')) {
                return;
            }
            
            showToast('Ê≠£Âú®Ê∏ÖÁêÜÂ≠òÂÇ®Á©∫Èó¥...', 'info');
            let cleanedSize = 0;
            let cleanedItems = 0;
            
            try {
                // 1. Ê∏ÖÈô§ÊâÄÊúâÂä®ÊÄÅÂ§¥ÂÉè
                Object.keys(chatSettings).forEach(chatId => {
                    if (chatSettings[chatId] && chatSettings[chatId].aiDynamicAvatar) {
                        delete chatSettings[chatId].aiDynamicAvatar;
                        cleanedItems++;
                    }
                });
                
                // 2. Ê∏ÖÁêÜlocalStorage‰∏≠ÁöÑËøáÊúüchatSettings
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('chatSettings_')) {
                        const value = localStorage.getItem(key);
                        if (value) {
                            cleanedSize += value.length;
                            localStorage.removeItem(key);
                            cleanedItems++;
                        }
                    }
                }
                
                // 3. ÂéãÁº©ÊâÄÊúâÁé∞ÊúâÂ§¥ÂÉèÊï∞ÊçÆ
                for (const chatId of Object.keys(chatSettings)) {
                    const settings = chatSettings[chatId];
                    if (settings) {
                        if (settings.aiChatAvatar && settings.aiChatAvatar.length > 50000) {
                            settings.aiChatAvatar = await compressImage(settings.aiChatAvatar, 150, 0.6);
                            cleanedItems++;
                        }
                        if (settings.myChatAvatar && settings.myChatAvatar.length > 50000) {
                            settings.myChatAvatar = await compressImage(settings.myChatAvatar, 150, 0.6);
                            cleanedItems++;
                        }
                    }
                }
                
                // 4. ÈáçÊñ∞‰øùÂ≠òÂéãÁº©ÂêéÁöÑËÆæÁΩÆÂà∞IndexedDB
                await saveChatSettings();
                
                // 5. Âà∑Êñ∞ÂΩìÂâçÁïåÈù¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                const sizeKB = Math.round(cleanedSize / 1024);
                showToast(`Ê∏ÖÁêÜÂÆåÊàêÔºÅÈáäÊîæ‰∫ÜÁ∫¶ ${sizeKB}KB Á©∫Èó¥ÔºåÂ§ÑÁêÜ‰∫Ü ${cleanedItems} È°πÊï∞ÊçÆ`, 'success');
                
            } catch (error) {
                console.error('Ê∏ÖÁêÜÂ≠òÂÇ®Á©∫Èó¥Â§±Ë¥•:', error);
                showToast('Ê∏ÖÁêÜËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØÔºåËØ∑ÈáçËØï', 'error');
            }
        }
        
        // Ê∏ÖÈô§AIÂä®ÊÄÅÂ§¥ÂÉè
        function clearAiDynamicAvatar() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.aiDynamicAvatar) {
                delete chatSettings.aiDynamicAvatar;
                saveCurrentChatSettings(chatSettings);
                
                // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                showToast('Âä®ÊÄÅÂ§¥ÂÉèÂ∑≤Ê∏ÖÈô§ÔºåÊÅ¢Â§ç‰∏∫ËÅäÂ§©ËÆæÁΩÆÂ§¥ÂÉè', 'success');
            } else {
                showToast('ÂΩìÂâçÊ≤°ÊúâÂä®ÊÄÅÂ§¥ÂÉè', 'info');
            }
        }
        
        // ‰øùÂ≠òËÅäÂ§©Ë∫´‰ªΩÈÄâÊã©
        function saveChatIdentity() {
            if (!window.selectedChatIdentityId) {
                alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ë∫´‰ªΩ');
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const selectedPersona = personas.find(p => p.id === window.selectedChatIdentityId);
            
            if (selectedPersona) {
                chatSettings.selectedIdentityId = selectedPersona.id;
                
                // Â¶ÇÊûúÈÄâ‰∏≠ÁöÑË∫´‰ªΩÊúâÂ§¥ÂÉèÔºåËá™Âä®ËÆæÁΩÆ‰∏∫ËÅäÂ§©Â§¥ÂÉèÔºàÂ¶ÇÊûúÂΩìÂâçÊ≤°ÊúâËÆæÁΩÆÁöÑËØùÔºâ
                if (selectedPersona.avatarUrl && !chatSettings.myChatAvatar) {
                    chatSettings.myChatAvatar = selectedPersona.avatarUrl;
                }
                
                // Â¶ÇÊûúÈÄâ‰∏≠ÁöÑË∫´‰ªΩÊúâÂêçÁß∞ÔºåËá™Âä®ËÆæÁΩÆ‰∏∫ËÅäÂ§©ÊòµÁß∞ÔºàÂ¶ÇÊûúÂΩìÂâçÊ≤°ÊúâËÆæÁΩÆÁöÑËØùÔºâ
                if (selectedPersona.name && !chatSettings.myChatNickname) {
                    chatSettings.myChatNickname = selectedPersona.name;
                }
                
                saveCurrentChatSettings(chatSettings);
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                updateChatIdentityDisplay();
                
                // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                hideModal('identity-selector-modal');
                showToast(`Â∑≤ÈÄâÊã©Ë∫´‰ªΩ"${selectedPersona.name}"`, 'success');
            }
        }
        
        // Êõ¥Êñ∞ËÅäÂ§©Ë∫´‰ªΩÊòæÁ§∫
        async function updateChatIdentityDisplay() {
            // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåÂ∞±‰∏çÊâßË°åÂêéÁª≠Êìç‰Ωú
            if (!currentChatCharacter) {
                console.log("Êõ¥Êñ∞ËÅäÂ§©Ë∫´‰ªΩÊòæÁ§∫ÔºöÊó†ÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåË∑≥ËøáÊìç‰Ωú");
                return;
            }
            
            const chatSettings = await getAsyncChatSettings();
            const selectedIdentityId = chatSettings.selectedIdentityId || 'default';
            const selectedPersona = personas.find(p => p.id === selectedIdentityId);
            
            const displayElement = document.getElementById('current-chat-identity');
            if (displayElement && selectedPersona) {
                displayElement.textContent = selectedPersona.name;
            }
        }
        
        // Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑ÂºèÊòæÁ§∫
        async function updateBubbleStyleDisplay() {
            // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåÂ∞±‰∏çÊâßË°åÂêéÁª≠Êìç‰Ωú
            if (!currentChatCharacter) {
                console.log("Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑ÂºèÊòæÁ§∫ÔºöÊó†ÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåË∑≥ËøáÊìç‰Ωú");
                return;
            }
            
            const chatSettings = await getAsyncChatSettings();
            const styleNames = {
                'default': 'ÈªòËÆ§Ê†∑Âºè',
                'glass': 'ÊØõÁéªÁíÉ',
                'shadow': 'ÁªèÂÖ∏Èò¥ÂΩ±',
                'tail': 'ÁªèÂÖ∏Ê∞îÊ≥°',
                'gradient': 'Ê∏êÂèòÊ†∑Âºè',
                'minimal': 'ÊûÅÁÆÄÊ†∑Âºè',
                'neon': 'ÈúìËôπÊ†∑Âºè',
                'paper': 'Á∫∏Âº†Ê†∑Âºè'
            };
            
            const displayElement = document.getElementById('current-bubble-style');
            if (displayElement) {
                const currentStyle = chatSettings.bubbleStyle || 'default';
                displayElement.textContent = styleNames[currentStyle] || 'ÈªòËÆ§Ê†∑Âºè';
            }
        }
        
        // ÂÖ®Â±ÄÂ§¥ÂÉè‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function handleAvatarUploadClick() {
            console.log('ÁÇπÂáª‰∫Ü‰∏ä‰º†Â§¥ÂÉèÊåâÈíÆ');
            const input = document.getElementById('avatar-upload');
            if (input) {
                console.log('ÊâæÂà∞‰∫ÜinputÂÖÉÁ¥†ÔºåÂáÜÂ§áËß¶ÂèëÁÇπÂáª');
                input.click();
            } else {
                console.error('Êâæ‰∏çÂà∞avatar-uploadÂÖÉÁ¥†');
                alert('Êâæ‰∏çÂà∞Êñá‰ª∂‰∏ä‰º†ÂÖÉÁ¥†ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        // ËØ•ÂáΩÊï∞Â∑≤Ë¢´Âà†Èô§Ôºå‰ΩøÁî®‰∏äÈù¢ÁöÑÂºÇÊ≠•IndexedDBÁâàÊú¨
        
        // üî•„Äê‰øÆÂ§ç„ÄëÊ∑ªÂä†Ê∂àÊÅØÈïøÊåâÁõëÂê¨Âô® - ÊîØÊåÅÊâãÊú∫Á´ØËèúÂçïÊìç‰Ωú
        function addMessageLongPressListener(messageContainer, messageId) {
            let pressTimer = null;
            let isLongPress = false;
            
            // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                             'ontouchstart' in window || 
                             navigator.maxTouchPoints > 0;
            
            const startLongPress = (e) => {
                if (isMessageSelectionMode) {
                    // Âú®ÈÄâÊã©Ê®°Âºè‰∏ãÔºåÂè™Â§ÑÁêÜÁÇπÂáªÈÄâÊã©Ôºå‰∏çÂ§ÑÁêÜÈïøÊåâ
                    return;
                }
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    
                    // üî•„ÄêÊñ∞Â¢û„ÄëÊâãÊú∫Á´ØÊòæÁ§∫Êìç‰ΩúËèúÂçïÔºåÊ°åÈù¢Á´ØËøõÂÖ•Â§öÈÄâÊ®°Âºè
                    if (isMobile) {
                        showMobileMessageMenu(messageId, e);
                    } else {
                    enterMessageSelectionMode(messageId);
                    }
                    e.preventDefault();
                }, 500);
            };
            
            const cancelLongPress = () => {
                clearTimeout(pressTimer);
                // ÈáçÁΩÆÈïøÊåâÊ†áËÆ∞ÔºåÂª∂ËøüÈáçÁΩÆ‰ª•ÈÅøÂÖçÁ´ãÂç≥Ëß¶ÂèëÁÇπÂáª
                setTimeout(() => {
                    isLongPress = false;
                }, 50);
            };
            
            const handleClick = (e) => {
                // Âú®ÈÄâÊã©Ê®°Âºè‰∏ãÔºåÊâÄÊúâÊ∂àÊÅØÈÉΩÂèØ‰ª•ÁÇπÂáªÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
                if (isMessageSelectionMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMessageSelection(messageId);
                    return;
                }
                
                // Â¶ÇÊûúÊòØÈïøÊåâËß¶ÂèëÂêéÁöÑÁÇπÂáªÔºå‰∏çÂ§ÑÁêÜ
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            };
            
            // Ëß¶Êë∏‰∫ã‰ª∂
            messageContainer.addEventListener('touchstart', startLongPress, { passive: false });
            messageContainer.addEventListener('touchend', cancelLongPress);
            messageContainer.addEventListener('touchmove', cancelLongPress);
            
            // Èº†Ê†á‰∫ã‰ª∂ÔºàÁî®‰∫éÊ°åÈù¢Á´ØÊµãËØïÔºâ
            messageContainer.addEventListener('mousedown', startLongPress);
            messageContainer.addEventListener('mouseup', cancelLongPress);
            messageContainer.addEventListener('mouseleave', cancelLongPress);
            
            // ÁÇπÂáª‰∫ã‰ª∂ - ‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµÁ°Æ‰øù‰ºòÂÖàÂ§ÑÁêÜ
            messageContainer.addEventListener('click', handleClick, true);
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÊòæÁ§∫ÊâãÊú∫Á´ØÊ∂àÊÅØÊìç‰ΩúËèúÂçï
        function showMobileMessageMenu(messageId, event) {
            selectedMessageId = messageId;
            
            // Ê£ÄÊü•Ê∂àÊÅØÊòØÂê¶ÊòØÁî®Êà∑ÂèëÈÄÅÁöÑÔºàÂè™ÊúâÁî®Êà∑Ê∂àÊÅØÂèØ‰ª•Êí§ÂõûÔºâ
            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === messageId);
            const isUserMessage = message && message.sender === 'sent';
            
            // ÈöêËóèÂ∑≤Â≠òÂú®ÁöÑËèúÂçï
            hideMobileMessageMenu();
            
            // ÂàõÂª∫ÁßªÂä®Á´ØËèúÂçï
            const menu = document.createElement('div');
            menu.id = 'mobile-message-menu';
            menu.className = 'mobile-message-menu';
            
            const menuItems = [
                { text: 'ÂºïÁî®', action: 'replyToMessage(selectedMessageId)', icon: '‚Ü©Ô∏è', className: 'reply-btn' },
                { text: 'Â§çÂà∂', action: 'copyMessage()', icon: 'üìã', className: 'copy-btn' },
                { text: 'ÁºñËæë', action: 'showEditMessageModal(selectedMessageId)', icon: '‚úèÔ∏è', className: 'edit-btn' },
                { text: 'ÈÄâÊã©', action: 'enterMessageSelectionMode(selectedMessageId)', icon: '‚òëÔ∏è', className: 'select-btn' }
            ];
            
            // Â¶ÇÊûúÊòØÁî®Êà∑Ê∂àÊÅØÔºåÊ∑ªÂä†Êí§ÂõûÈÄâÈ°π
            if (isUserMessage) {
                menuItems.splice(3, 0, { text: 'Êí§Âõû', action: 'deleteMessage()', icon: 'üóëÔ∏è', className: 'recall-btn', danger: true });
            }
            
            menu.innerHTML = `
                <div class="mobile-menu-overlay" onclick="hideMobileMessageMenu()"></div>
                <div class="mobile-menu-content">
                    <div class="mobile-menu-header">Ê∂àÊÅØÊìç‰Ωú</div>
                    ${menuItems.map(item => `
                        <div class="mobile-menu-item ${item.className || ''} ${item.danger ? 'danger' : ''}" onclick="${item.action}; hideMobileMessageMenu();">
                            <span class="menu-icon">${item.icon}</span>
                            <span class="menu-text">${item.text}</span>
                        </div>
                    `).join('')}
                    <div class="mobile-menu-item cancel-btn" onclick="hideMobileMessageMenu()">
                        <span class="menu-icon">‚ùå</span>
                        <span class="menu-text">ÂèñÊ∂à</span>
                    </div>
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // Ê∑ªÂä†ÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                menu.classList.add('show');
            }, 10);
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÈöêËóèÊâãÊú∫Á´ØÊ∂àÊÅØÊìç‰ΩúËèúÂçï
        function hideMobileMessageMenu() {
            const menu = document.getElementById('mobile-message-menu');
            if (menu) {
                menu.classList.remove('show');
                setTimeout(() => {
                    if (menu.parentNode) {
                        menu.parentNode.removeChild(menu);
                    }
                }, 300);
            }
        }
        
        // ËøõÂÖ•Ê∂àÊÅØÈÄâÊã©Ê®°Âºè
        function enterMessageSelectionMode(initialMessageId) {
            if (isMessageSelectionMode) {
                return;
            }
            
            isMessageSelectionMode = true;
            selectedMessages.clear();
            selectedMessages.add(initialMessageId);
            
            // Ê∑ªÂä†ÈÄâÊã©Ê®°ÂºèCSSÁ±ª
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.add('selection-mode');
            }
            
            updateMessageSelectionUI();
        }
        
        // ÂàáÊç¢Ê∂àÊÅØÈÄâÊã©Áä∂ÊÄÅ
        function toggleMessageSelection(messageId) {
            if (!isMessageSelectionMode) return;
            
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
            } else {
                selectedMessages.add(messageId);
            }
            
            updateMessageSelectionUI();
            
            // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÔºåÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
            if (selectedMessages.size === 0) {
                exitMessageSelectionMode();
            }
        }
        
        // ÈÄÄÂá∫Ê∂àÊÅØÈÄâÊã©Ê®°Âºè
        function exitMessageSelectionMode() {
            if (!isMessageSelectionMode) return;
            
            isMessageSelectionMode = false;
            
            // ÁßªÈô§ÈÄâÊã©Ê®°ÂºèCSSÁ±ª
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.remove('selection-mode');
            }
            
            // üî•„Äê‰øÆÂ§ç„ÄëÊ∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅÔºåÂåÖÊã¨Êí§ÂõûÊ∂àÊÅØ
            const selectedContainers = document.querySelectorAll('[data-message-id].selected');
            selectedContainers.forEach(container => {
                container.classList.remove('selected');
            });
            
            selectedMessages.clear();
            updateMessageSelectionUI();
        }
        

        
        // Êõ¥Êñ∞Ê∂àÊÅØÈÄâÊã©UI
        function updateMessageSelectionUI() {
            // üî•„Äê‰øÆÂ§ç„ÄëÊü•ÊâæÊâÄÊúâÂ∏¶ÊúâmessageIdÁöÑÂÆπÂô®ÔºåÂåÖÊã¨Êí§ÂõûÊ∂àÊÅØ
            const allContainers = document.querySelectorAll('[data-message-id]');
            
            allContainers.forEach(container => {
                const messageId = container.dataset.messageId;
                if (messageId) {
                    if (selectedMessages.has(messageId)) {
                        container.classList.add('selected');
                    } else {
                        container.classList.remove('selected');
                    }
                }
            });
            
            // Êõ¥Êñ∞ÈÄâÊã©ËÆ°Êï∞ÊòæÁ§∫
            const countElement = document.getElementById('selection-count');
            if (countElement) {
                countElement.textContent = `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`;
            }
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØ
        function deleteSelectedMessages() {
            if (selectedMessages.size === 0) return;
            
            if (!currentChatCharacter) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                const characterId = currentChatCharacter.id;
                
                if (chatMessages[characterId]) {
                    // üî•„Äê‰øÆÂ§ç„ÄëËøáÊª§ÊéâÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÔºåÂêåÊó∂Âà†Èô§Áõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫
                    const messagesToDelete = new Set(selectedMessages);
                    
                    // Êü•ÊâæÊâÄÊúâË¶ÅÂà†Èô§ÁöÑÊ∂àÊÅØÂÜÖÂÆπÔºåÁî®‰∫éÂåπÈÖçÁõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫
                    const deleteContentSet = new Set();
                    chatMessages[characterId].forEach(message => {
                        if (selectedMessages.has(message.id) && message.content) {
                            deleteContentSet.add(message.content);
                        }
                    });
                    
                    // ËøáÊª§Ê∂àÊÅØÔºöÂà†Èô§ÈÄâ‰∏≠Ê∂àÊÅØ + Áõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫
                    chatMessages[characterId] = chatMessages[characterId].filter(message => {
                        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØ
                        if (selectedMessages.has(message.id)) {
                            return false;
                        }
                        
                        // Âà†Èô§Áõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫ÔºàÁ≥ªÁªüÊ∂àÊÅØÁ±ªÂûãÔºå‰∏îÂéüÊñáÂåπÈÖçË¶ÅÂà†Èô§ÁöÑÊ∂àÊÅØÔºâ
                        if (message.sender === 'system' && message.type === 'recalled_message' && message.originalContent) {
                            if (deleteContentSet.has(message.originalContent)) {
                                console.log('Âà†Èô§Áõ∏ÂÖ≥ÁöÑÊí§ÂõûÊèêÁ§∫:', message.content);
                                return false;
                            }
                        }
                        
                        return true;
                    });
                    
                    saveChatMessages();
                    renderChatMessages(characterId);
                    renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                }
                
                // ÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
                exitMessageSelectionMode();
            }
        }

        // ÊÇ¨ÊµÆÊåâÈíÆÂäüËÉΩ
        // ÂèòÈáèÊéßÂà∂Á≠âÂæÖÂõûÂ§çÁä∂ÊÄÅ
        let isWaitingForReply = false;
        let pendingUserMessage = null;

      // Áî®ËøôÊÆµÊñ∞‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊóßÁöÑ regenerateLastResponse ÂáΩÊï∞
        async function regenerateLastResponse() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            // Èò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
            if (window._isRegenerating) {
                console.log('ÈáçÊñ∞ÁîüÊàêÊ≠£Âú®ËøõË°å‰∏≠ÔºåÂøΩÁï•ÈáçÂ§çË∞ÉÁî®');
                return;
            }
            window._isRegenerating = true;

            const characterId = currentChatCharacter.id;
            const messages = chatMessages[characterId] || [];
            
            // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØÂèäÂÖ∂ÂØπÂ∫îÁöÑÁî®Êà∑Ê∂àÊÅØ
            let lastAiMessageIndex = -1;
            let lastUserMessageIndex = -1;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender === 'received' && lastAiMessageIndex === -1) {
                    lastAiMessageIndex = i;
                }
                if (lastAiMessageIndex !== -1 && messages[i].sender === 'sent' && lastUserMessageIndex === -1) {
                    lastUserMessageIndex = i;
                    break;
                }
            }
            
            if (lastAiMessageIndex === -1) {
                alert('Ê≤°ÊúâÊâæÂà∞AIÂõûÂ§çÂèØ‰ª•ÈáçÊñ∞ÁîüÊàê');
                return;
            }
            
            if (lastUserMessageIndex === -1) {
                alert('Ê≤°ÊúâÊâæÂà∞ÂØπÂ∫îÁöÑÁî®Êà∑Ê∂àÊÅØ');
                return;
            }

            const userMessage = messages[lastUserMessageIndex];
            
            // Âà†Èô§‰ªéÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÂêéÁöÑÊâÄÊúâAIÊ∂àÊÅØ
            chatMessages[characterId] = messages.slice(0, lastUserMessageIndex + 1);
    await saveChatMessages(); // ‰ΩøÁî® await Á°Æ‰øù‰øùÂ≠òÂÆåÊàê
            renderChatMessages(characterId);
            
            showTypingIndicator();
            
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
            
            try {
                let response;
                
                // üî•„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë‰ΩøÁî®Êñ∞ÁöÑÂ§öÊ®°ÊÄÅÂ§ÑÁêÜÈÄªËæë
                if (Array.isArray(userMessage.content)) {
                    // ËøôÊòØÂ§öÊ®°ÊÄÅÊ∂àÊÅØÔºàÂõæÊñáÔºâ
                    response = await callChatAPI(userMessage.content, currentChatCharacter);
                } else if (userMessage.image) {
                    // ÂÖºÂÆπÊóßÁöÑÂõæÁâáÊ∂àÊÅØÊ†ºÂºè
                    const messageContent = [
                        { type: 'text', text: userMessage.content || "" },
                        { type: 'image_url', image_url: { url: userMessage.image } }
                    ];
                    response = await callChatAPI(messageContent, currentChatCharacter);
                    } else {
                    // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                    response = await callChatAPI(userMessage.content, currentChatCharacter);
                }
                const aiMessages = parseAiResponse(response);
                
                hideTypingIndicator();
                
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
            if (typeof msgData === 'object' && msgData !== null) {
                if (msgData.type === 'voice_message') {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'voice_message', content: msgData.content, timestamp: Date.now() + i * 100 };
                } else if (msgData.type === 'ai_image') {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'ai_image', content: '', image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`, imageDescription: msgData.description, timestamp: Date.now() + i * 100 };
                } else if (msgData.type === 'transfer') {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'transfer', amount: msgData.amount, note: msgData.note, timestamp: Date.now() + i * 100 };
                } else if (msgData.type === 'emoji') {
                    const matchingEmoji = customEmojis.find(emoji => emoji.description === msgData.description);
                    if (matchingEmoji) {
                        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '', image: matchingEmoji.url, isEmoji: true, emojiDescription: matchingEmoji.description, timestamp: Date.now() + i * 100 };
                        addToRecentEmojis({ id: matchingEmoji.id, url: matchingEmoji.url, description: matchingEmoji.description });
                    } else {
                        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: `[Ë°®ÊÉÖÂåÖ"${msgData.description}"‰∏çÂ≠òÂú®]`, timestamp: Date.now() + i * 100 };
                    }
                } else if (msgData.type === 'change_avatar') {
                        if (msgData.avatar_url) {
                            const isValidAvatar = await validateAvatarSource(msgData.avatar_url);
                            if (isValidAvatar) {
                                const success = await changeCharacterAvatarByAI(msgData.avatar_url, msgData.reason || 'ÂøÉÊÉÖÂèòÂåñ');
                            if (success) continue; 
                            else aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[Â§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', timestamp: Date.now() + i * 100 };
                                } else {
                            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[Êó†ÊïàÁöÑÂ§¥ÂÉèÊù•Ê∫êÔºåÂ§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', timestamp: Date.now() + i * 100 };
                                }
                            } else {
                        continue;
                    }
                } else if (msgData.name && msgData.message) {
                    // ËøôÊòØÁæ§ËÅäÁöÑÁâπÊÆäÊ†ºÂºè
                    let senderId = null;
                    if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                        const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                        if (member) senderId = member.id;
                    }

                    // --- ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊ£ÄÊü•Áæ§ËÅäÊ∂àÊÅØÂÜÖÂÆπÊòØÂê¶‰∏∫ÁâπÊÆäÁ±ªÂûã ---
                    if (typeof msgData.message === 'object' && msgData.message.type === 'voice_message') {
                        // Â¶ÇÊûúÊ∂àÊÅØÂÜÖÂÆπÊòØ‰∏Ä‰∏™ËØ≠Èü≥Ê∂àÊÅØÂØπË±°
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', // Âú®Â§ñÂ±ÇÊ∂àÊÅØ‰∏äËÆæÁΩÆÊ≠£Á°ÆÁöÑÁ±ªÂûã
                            name: msgData.name,
                            senderId: senderId,
                            content: msgData.message.content, // ÊèêÂèñÁúüÊ≠£ÁöÑËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData.message === 'object' && msgData.message.type === 'transfer') {
                        // üî•„Äê‰øÆÂ§ç„ÄëÂ¶ÇÊûúÊ∂àÊÅØÂÜÖÂÆπÊòØ‰∏Ä‰∏™ËΩ¨Ë¥¶ÂØπË±°
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', // Âú®Â§ñÂ±ÇÊ∂àÊÅØ‰∏äËÆæÁΩÆÊ≠£Á°ÆÁöÑÁ±ªÂûã
                            name: msgData.name,
                            senderId: senderId,
                            amount: msgData.message.amount, // ÊèêÂèñËΩ¨Ë¥¶ÈáëÈ¢ù
                            note: msgData.message.note, // ÊèêÂèñËΩ¨Ë¥¶Â§áÊ≥®
                            timestamp: Date.now() + i * 100
                        };
                    } else {
                        // ÂØπ‰∫éÊôÆÈÄöÁöÑÊñáÊú¨Ê∂àÊÅØ
                        aiMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            name: msgData.name,
                            senderId: senderId,
                            content: msgData.message, // ÂÜÖÂÆπÊú¨Ë∫´ÊòØÂ≠óÁ¨¶‰∏≤
                            timestamp: Date.now() + i * 100
                        };
                    }
                    // --- ‰øÆÂ§çÁªìÊùü ---
                        } else {
                    // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÊ£ÄÊü•ÊòØÂê¶ÊòØÁâπÊÆäÁ±ªÂûãÂØπË±°‰ΩÜÊú™Ë¢´‰∏äÈù¢ÁöÑÊù°‰ª∂ÊçïËé∑
                    if (typeof msgData === 'object' && msgData !== null) {
                        if (msgData.type === 'transfer') {
                            // ËΩ¨Ë¥¶ÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                            aiMessage = { 
                                id: (Date.now() + i).toString(), 
                                sender: 'received', 
                                type: 'transfer', 
                                amount: msgData.amount, 
                                note: msgData.note, 
                                timestamp: Date.now() + i * 100 
                            };
                        } else if (msgData.type === 'voice_message') {
                            // ËØ≠Èü≥Ê∂àÊÅØÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                            aiMessage = { 
                                id: (Date.now() + i).toString(), 
                                sender: 'received', 
                                type: 'voice_message', 
                                content: msgData.content, 
                                timestamp: Date.now() + i * 100 
                            };
                        } else if (msgData.type === 'ai_image') {
                            // AIÂõæÁâáÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                            aiMessage = { 
                                id: (Date.now() + i).toString(), 
                                sender: 'received', 
                                type: 'ai_image', 
                                content: '', 
                                image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`, 
                                imageDescription: msgData.description, 
                                timestamp: Date.now() + i * 100 
                            };
                        } else if (msgData.type === 'emoji') {
                            // Ë°®ÊÉÖÂåÖÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                            const matchingEmoji = customEmojis.find(emoji => emoji.description === msgData.description);
                            if (matchingEmoji) {
                                aiMessage = { 
                                    id: (Date.now() + i).toString(), 
                                    sender: 'received', 
                                    content: '', 
                                    image: matchingEmoji.url, 
                                    isEmoji: true, 
                                    emojiDescription: matchingEmoji.description, 
                                    timestamp: Date.now() + i * 100 
                                };
                                addToRecentEmojis({ id: matchingEmoji.id, url: matchingEmoji.url, description: matchingEmoji.description });
                            } else {
                                aiMessage = { 
                                    id: (Date.now() + i).toString(), 
                                    sender: 'received', 
                                    content: `[Ë°®ÊÉÖÂåÖ"${msgData.description}"‰∏çÂ≠òÂú®]`, 
                                    timestamp: Date.now() + i * 100 
                                };
                            }
                        } else {
                            // ÂÖ∂‰ªñÂØπË±°Á±ªÂûãÔºåÂ∞ùËØïÊèêÂèñÊñáÊú¨ÂÜÖÂÆπ
                            const displayContent = msgData.content || msgData.message || msgData.text || msgData.reply || '[‰∏çÊîØÊåÅÁöÑÊ∂àÊÅØÊ†ºÂºè]';
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                        }
                                            } else {
                        // ÊôÆÈÄöÂ≠óÁ¨¶‰∏≤ÊàñÂÖ∂‰ªñÂü∫Êú¨Á±ªÂûã
                        const displayContent = String(msgData);
                        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                    }
                        }
                                            } else {
                // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç - regenerateLastResponseÁâàÊú¨„ÄëÊ£ÄÊü•ÊòØÂê¶ÊòØÁâπÊÆäÁ±ªÂûãÂØπË±°‰ΩÜÊú™Ë¢´‰∏äÈù¢ÁöÑÊù°‰ª∂ÊçïËé∑
                if (typeof msgData === 'object' && msgData !== null) {
                    if (msgData.type === 'transfer') {
                        // ËΩ¨Ë¥¶ÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                        aiMessage = { 
                            id: (Date.now() + i).toString(), 
                            sender: 'received', 
                            type: 'transfer', 
                            amount: msgData.amount, 
                            note: msgData.note, 
                            timestamp: Date.now() + i * 100 
                        };
                    } else if (msgData.type === 'voice_message') {
                        // ËØ≠Èü≥Ê∂àÊÅØÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                        aiMessage = { 
                            id: (Date.now() + i).toString(), 
                            sender: 'received', 
                            type: 'voice_message', 
                            content: msgData.content, 
                            timestamp: Date.now() + i * 100 
                        };
                    } else if (msgData.type === 'ai_image') {
                        // AIÂõæÁâáÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                        aiMessage = { 
                            id: (Date.now() + i).toString(), 
                            sender: 'received', 
                            type: 'ai_image', 
                            content: '', 
                            image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`, 
                            imageDescription: msgData.description, 
                            timestamp: Date.now() + i * 100 
                        };
                    } else if (msgData.type === 'emoji') {
                        // Ë°®ÊÉÖÂåÖÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                        const matchingEmoji = customEmojis.find(emoji => emoji.description === msgData.description);
                        if (matchingEmoji) {
                            aiMessage = { 
                                id: (Date.now() + i).toString(), 
                                sender: 'received', 
                                content: '', 
                                image: matchingEmoji.url, 
                                isEmoji: true, 
                                emojiDescription: matchingEmoji.description, 
                                timestamp: Date.now() + i * 100 
                            };
                            addToRecentEmojis({ id: matchingEmoji.id, url: matchingEmoji.url, description: matchingEmoji.description });
                        } else {
                            aiMessage = { 
                                id: (Date.now() + i).toString(), 
                                sender: 'received', 
                                content: `[Ë°®ÊÉÖÂåÖ"${msgData.description}"‰∏çÂ≠òÂú®]`, 
                                timestamp: Date.now() + i * 100 
                            };
                        }
                    } else {
                        // ÂÖ∂‰ªñÂØπË±°Á±ªÂûãÔºåÂ∞ùËØïÊèêÂèñÊñáÊú¨ÂÜÖÂÆπ
                        const displayContent = msgData.content || msgData.message || msgData.text || msgData.reply || '[‰∏çÊîØÊåÅÁöÑÊ∂àÊÅØÊ†ºÂºè]';
                        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                    }
                } else if (typeof msgData === 'string') {
                    // ÊôÆÈÄöÂ≠óÁ¨¶‰∏≤
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: msgData, timestamp: Date.now() + i * 100 };
                } else {
                    // ÂÖ∂‰ªñÂü∫Êú¨Á±ªÂûã
                aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: String(msgData), timestamp: Date.now() + i * 100 };
                }
                    }
                    
                    chatMessages[characterId].push(aiMessage);
            await saveChatMessages();

            // üî•„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂΩïAIÂõûÂ§çÂà∞ÂÖ®Â±ÄËÆ∞ÂøÜ‰∫ã‰ª∂
            const character = characters.find(c => c.id === characterId);
            if (character) {
                await recordMemoryEvent(
                    [characterId, 'user'],
                    {
                        type: character.isGroup ? 'group_chat' : 'private_chat',
                        id: characterId
                    },
                    'message',
                    {
                        sender: characterId,
                        content: aiMessage.content || '[ÁâπÊÆäÊ∂àÊÅØ]',
                        messageType: aiMessage.type || 'text'
                    },
                    0.7 // AIÊ∂àÊÅØÈáçË¶ÅÊÄß
                );
            }
                    renderChatMessages(characterId);
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•:', error);
                hideTypingIndicator();
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•: ${error.message}]`,
                    timestamp: Date.now()
                };
                chatMessages[characterId].push(errorMessage);
        await saveChatMessages();
                renderChatMessages(characterId);
            } finally {
                // ÈáçÁΩÆÈáçÊñ∞ÁîüÊàêÊ†áÂøó
                window._isRegenerating = false;
            }
            
            updateFloatingButtonsVisibility();
        }

        // Êô∫ËÉΩÂõûÂ§çÂäüËÉΩ
        function triggerSmartReply() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            if (isWaitingForReply) {
                // üî•„Äê‰øÆÂ§ç„Äë‰∏ç‰ΩøÁî®ÂºπÁ™óÔºåÊîπ‰∏∫ÊòæÁ§∫ÊåâÈíÆÁä∂ÊÄÅÊèêÁ§∫
                return;
            }

            const messages = chatMessages[currentChatCharacter.id] || [];
            
            // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
            let lastUserMessage = null;
            let hasUnrepliedUserMessage = false;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender === 'sent') {
                    lastUserMessage = messages[i];
                    
                    // Ê£ÄÊü•ËøôÊù°Áî®Êà∑Ê∂àÊÅØÂêéÊòØÂê¶ÊúâAIÂõûÂ§ç
                    hasUnrepliedUserMessage = true;
                    for (let j = i + 1; j < messages.length; j++) {
                        if (messages[j].sender === 'received') {
                            hasUnrepliedUserMessage = false;
                            break;
                        }
                    }
                    break;
                }
            }
            
            // ÊÉÖÂÜµ1ÔºöÊúâÊú™ÂõûÂ§çÁöÑÁî®Êà∑Ê∂àÊÅØ
            if (lastUserMessage && hasUnrepliedUserMessage) {
                pendingUserMessage = lastUserMessage;
            processAIReply();
                return;
            }
            
            // ÊÉÖÂÜµ2ÔºöÊúÄÂêéÁöÑÁî®Êà∑Ê∂àÊÅØÂ∑≤ÊúâAIÂõûÂ§çÔºåÈúÄË¶ÅAIÁª≠ÂÜô
            if (lastUserMessage && !hasUnrepliedUserMessage) {
                // Ê£ÄÊü•‰ªéÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÂêéÁöÑAIÂõûÂ§çËΩÆÊï∞
                let aiReplyRounds = 0;
                let lastUserMessageIndex = -1;
                
                // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÁöÑÁ¥¢Âºï
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].sender === 'sent') {
                        lastUserMessageIndex = i;
                        break;
                    }
                }
                
                // ËÆ°ÁÆó‰ªéÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÂêéÁöÑAIÂõûÂ§çËΩÆÊï∞
                // ‰∏ÄËΩÆ = ËøûÁª≠ÁöÑAIÊ∂àÊÅØÁõ¥Âà∞‰∏ã‰∏Ä‰∏™Êñ≠ÁÇπ
                if (lastUserMessageIndex !== -1) {
                    let inAIReplyRound = false;
                    
                    for (let i = lastUserMessageIndex + 1; i < messages.length; i++) {
                        if (messages[i].sender === 'received') {
                            if (!inAIReplyRound) {
                                // ÂºÄÂßãÊñ∞ÁöÑAIÂõûÂ§çËΩÆ
                                aiReplyRounds++;
                                inAIReplyRound = true;
                            }
                            // ÁªßÁª≠ÂΩìÂâçÂõûÂêàÔºàÂ§öÊù°ËøûÁª≠AIÊ∂àÊÅØÁÆó‰∏ÄËΩÆÔºâ
                        } else {
                            // Â¶ÇÊûúÊúâÂÖ∂‰ªñÁ±ªÂûãÊ∂àÊÅØÔºåÁªìÊùüÂΩìÂâçÂõûÂêà
                            inAIReplyRound = false;
                        }
                    }
                }
                
                // AIÂõûÂ§çÈÄªËæëÔºö
                // aiReplyRounds = 0: Ê≤°ÊúâÂõûÂ§çÁî®Êà∑Ê∂àÊÅØÔºå‰∏çÂ∫îËØ•Âà∞ËøôÈáå
                // aiReplyRounds = 1: Â∑≤ÂõûÂ§çÁî®Êà∑Ê∂àÊÅØ1ËΩÆÔºåÁé∞Âú®ÊòØÁ¨¨1Ê¨°Áª≠ÂÜôÔºàÁ¨¨2ËΩÆÔºâ
                // aiReplyRounds = 2: Â∑≤ÂõûÂ§ç+Áª≠ÂÜô1ËΩÆÔºåÁé∞Âú®ÊòØÁ¨¨2Ê¨°Áª≠ÂÜôÔºàÁ¨¨3ËΩÆÔºâ
                // aiReplyRounds >= 3: Â∑≤ÂõûÂ§ç+Áª≠ÂÜô2ËΩÆÔºåÊèêÁ§∫Áî®Êà∑ÂèëÊ∂àÊÅØ
                
                if (aiReplyRounds >= 3) {
                    const characterName = currentChatCharacter.name;
                    alert(`${characterName}Â∑≤ÁªèËØ¥‰∫ÜÂæàÂ§öËØù‰∫ÜÔºåÂÖàÂíå${characterName}ËØ¥ËØ¥ËØùÂêß~`);
                    return;
                }
                
                // üî•„Äê‰øÆÂ§ç„ÄëÂú®Áª≠ÂÜôÂâç‰πüË¶ÅÊ£ÄÊü•ÊòØÂê¶ÊúâÊú™Â§ÑÁêÜÁöÑËΩ¨Ë¥¶
                const lastUserTransfer = messages.slice().reverse().find(msg => 
                    msg.sender === 'sent' && msg.type === 'transfer' && !msg.status);
                if (lastUserTransfer) {
                    // Â¶ÇÊûúÊúâÊú™Â§ÑÁêÜÁöÑËΩ¨Ë¥¶ÔºåÂÖàËÆæÁΩÆ‰∏∫ÂæÖÂ§ÑÁêÜÔºåÁÑ∂ÂêéÂ§ÑÁêÜÂõûÂ§ç
                    pendingUserMessage = lastUserTransfer;
                    processAIReply();
                    return;
                }
                
                // AIÁª≠ÂÜôÂØπËØùÔºàÁ¨¨1Ê¨°ÊàñÁ¨¨2Ê¨°Áª≠ÂÜôÔºâ
                processAIContinuation();
                return;
            }
            
            // ÊÉÖÂÜµ3ÔºöÊ≤°ÊúâÁî®Êà∑Ê∂àÊÅØ
            alert('ËØ∑ÂÖàÂèëÈÄÅ‰∏ÄÊù°Ê∂àÊÅØÔºåÁÑ∂ÂêéÁÇπÂáªÊ≠§ÊåâÈíÆÊù•Ëé∑ÂèñAIÂõûÂ§ç');
        }

                // Â§ÑÁêÜAIÁª≠ÂÜôÂØπËØù
        async function processAIContinuation() {
            if (!currentChatCharacter) return;
            
            // Èò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
            if (isWaitingForReply) {
                console.log('AIÊ≠£Âú®Áª≠ÂÜô‰∏≠ÔºåÂøΩÁï•ÈáçÂ§çË∞ÉÁî®');
                return;
            }
            
            // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëËÆ∞ÂΩïÂΩìÂâçËÅäÂ§©ËßíËâ≤IDÔºåÁ°Æ‰øùAIÁª≠ÂÜôÊ∂àÊÅØÂΩíÂ±ûÂà∞Ê≠£Á°ÆÁöÑËÅäÂ§©Á™óÂè£
            const continuingCharacterId = currentChatCharacter.id;

            isWaitingForReply = true;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = true;
                smartReplyBtn.style.opacity = '0.65';
                smartReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
            showTypingIndicator();
            
            // Ê∑ªÂä†ÈöèÊú∫Âª∂Ëøü
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                // Ëé∑ÂèñAIÊúÄÂêéÁöÑÊ∂àÊÅØÂÜÖÂÆπÔºå‰ª•‰æøÂü∫‰∫éÊ≠§Áª≠ÂÜô
                const messages = chatMessages[continuingCharacterId] || [];
                let lastAIMessage = "";
                
                // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØ
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].sender === 'received') {
                        lastAIMessage = messages[i].content || "";
                        break;
                    }
                }
                
                // ÊûÑÂª∫Áª≠ÂÜôÊèêÁ§∫ËØçÔºåÂü∫‰∫éAIËá™Â∑±ÊúÄÂêéÁöÑËØùÊù•Áª≠ÂÜô
                let continuationPrompt = "‰Ω†ÂàöÊâçËØ¥‰∫ÜÔºö\"" + lastAIMessage + "\"\n\n";
                continuationPrompt += "Áé∞Âú®ËØ∑Âü∫‰∫é‰Ω†ÂàöÊâçËØ¥ÁöÑËØùÔºå‰∏ªÂä®ÁªßÁª≠Ëøô‰∏™ËØùÈ¢òÊàñËÄÖËá™ÁÑ∂Âú∞ËΩ¨Âà∞Áõ∏ÂÖ≥ËØùÈ¢ò„ÄÇÂ∞±ÂÉèÁúüÂÆûËÅäÂ§©‰∏≠Ôºå‰Ω†ÊÉ≥Ë¶ÅÁªßÁª≠Ë°®ËææÊõ¥Â§öÊÉ≥Ê≥ïÔºåÊàñËÄÖËØ¢ÈóÆÂØπÊñπÁöÑÁúãÊ≥ïÔºåÊàñËÄÖÂàÜ‰∫´Áõ∏ÂÖ≥ÁöÑÂÜÖÂÆπ„ÄÇËØ∑Ëá™ÁÑ∂Âú∞ÁªßÁª≠ÂØπËØùÔºå‰∏çË¶ÅÈáçÂ§ç‰πãÂâçËØ¥ËøáÁöÑËØù„ÄÇ";
                continuationPrompt += "\n\nüö® ÈáçË¶ÅÊèêÈÜíÔºöËØ∑‰∏•Ê†ºÈÅµÂÆàJSONÊ†ºÂºèÔºåÊØèÊù°Ê∂àÊÅØÂøÖÈ°ªÂàÜÂºÄÂèëÈÄÅÔºåÁªùÂØπ‰∏çËÉΩÂ∞ÜÂ§öÊù°Ê∂àÊÅØÂêàÂπ∂Âú®‰∏Ä‰∏™ÂÖÉÁ¥†‰∏≠ÔºÅÊ≠£Á°ÆÊ†ºÂºèÔºö[\"Ê∂àÊÅØ1\", \"Ê∂àÊÅØ2\"]ÔºåÈîôËØØÊ†ºÂºèÔºö[\"Ê∂àÊÅØ1\\nÊ∂àÊÅØ2\"]";
                
                const response = await callChatAPI(continuationPrompt, currentChatCharacter);
                const aiMessages = parseAiResponse(response);
                
                // üî•„Äê‰øÆÂ§ç„ÄëÂú®Áª≠ÂÜôÊó∂‰πüË¶ÅÊ£ÄÊü•ÊòØÂê¶ÊúâËΩ¨Ë¥¶ÈúÄË¶ÅÂ§ÑÁêÜ
                const chatHistory = chatMessages[continuingCharacterId] || [];
                const lastUserMessage = chatHistory.slice().reverse().find(msg => 
                    msg.sender === 'sent' && msg.type === 'transfer' && !msg.status);
                if (lastUserMessage) {
                    console.log('üî• [Áª≠ÂÜô] Ê£ÄÊµãÂà∞Áî®Êà∑ËΩ¨Ë¥¶Ê∂àÊÅØÔºåÂºÄÂßãÂ§ÑÁêÜËΩ¨Ë¥¶:', {
                        lastUserMessage,
                        aiMessages,
                        characterName: currentChatCharacter?.name
                    });
                    await processUserTransfer(lastUserMessage, aiMessages);
                }
                
                hideTypingIndicator();
                
                // ÈÄêÊù°ÂèëÈÄÅÊ∂àÊÅØ
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
                    if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', 
                            content: msgData.content, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image', 
                            content: '',
                            image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`,
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', 
                            amount: msgData.amount, 
                            note: msgData.note, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'emoji') {
                        // Â§ÑÁêÜAIÂèëÈÄÅÁöÑË°®ÊÉÖÂåÖ - ‰ªéÊú¨Âú∞Ë°®ÊÉÖÂåÖÂ∫ì‰∏≠Êü•Êâæ
                        const matchingEmoji = customEmojis.find(emoji => 
                            emoji.description === msgData.description
                        );
                        
                        if (matchingEmoji) {
                            aiMessage = { 
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: '',
                                image: matchingEmoji.url,
                                isEmoji: true,
                                emojiDescription: matchingEmoji.description,
                                timestamp: Date.now() + i * 100
                            };
                            
                            // Â∞ÜË°®ÊÉÖÂåÖÊ∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®
                            addToRecentEmojis({
                                id: matchingEmoji.id,
                                url: matchingEmoji.url,
                                description: matchingEmoji.description
                            });
                        } else {
                            // Â¶ÇÊûúÊâæ‰∏çÂà∞Ë°®ÊÉÖÂåÖÔºåÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                            aiMessage = { 
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: `[Ë°®ÊÉÖÂåÖ"${msgData.description}"‰∏çÂ≠òÂú®]`,
                                timestamp: Date.now() + i * 100
                            };
                        }
                    } else if (typeof msgData === 'object' && msgData.type === 'change_avatar') {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÂ§¥ÂÉèÊõ¥Êç¢ÂØπË±°
                        console.log('Â§ÑÁêÜÂ§¥ÂÉèÊõ¥Êç¢Ê∂àÊÅØ(Áª≠ÂÜô):', msgData);
                        if (msgData.avatar_url) {
                            // È™åËØÅÂ§¥ÂÉèURLÊòØÂê¶Êù•Ëá™Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáÊàñ‰∏ñÁïå‰π¶‰∏≠ÁöÑURL
                            const isValidAvatar = await validateAvatarSource(msgData.avatar_url);
                            console.log('Â§¥ÂÉèÊù•Ê∫êÈ™åËØÅÁªìÊûú(Áª≠ÂÜô):', isValidAvatar, 'Â§¥ÂÉèURL:', msgData.avatar_url);
                            
                            if (isValidAvatar) {
                                // ÊâßË°åÂ§¥ÂÉèÊõ¥Êç¢
                                const success = await changeCharacterAvatarByAI(msgData.avatar_url, msgData.reason || 'ÂøÉÊÉÖÂèòÂåñ');
                                console.log('Â§¥ÂÉèÊõ¥Êç¢ÊâßË°åÁªìÊûú(Áª≠ÂÜô):', success);
                                if (success) {
                                    // Ë∑≥ËøáËøôÊù°Ê∂àÊÅØÔºåÂè™ÊâßË°åÂ§¥ÂÉèÊõ¥Êç¢ÔºåÁ≥ªÁªüÊ∂àÊÅØÂ∑≤Âú®changeCharacterAvatarByAI‰∏≠Ê∑ªÂä†
                                    continue;
                                } else {
                                    aiMessage = { 
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: '[Â§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', 
                                        timestamp: Date.now() + i * 100
                                    };
                                }
                            } else {
                                aiMessage = { 
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: '[Êó†ÊïàÁöÑÂ§¥ÂÉèÊù•Ê∫êÔºåÂ§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', 
                                    timestamp: Date.now() + i * 100
                                };
                            }
                        } else {
                            console.log('Â§¥ÂÉèÊõ¥Êç¢Ê∂àÊÅØÁº∫Â∞ëavatar_url(Áª≠ÂÜô)');
                            continue; // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁöÑÂ§¥ÂÉèURLÔºåË∑≥ËøáÊ≠§Ê∂àÊÅØ
                        }
                    } else if (typeof msgData === 'object' && msgData !== null && msgData.name && msgData.message) {
                        // üî•„ÄêÁæ§ËÅäÊ∂àÊÅØÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÁæ§ËÅäÊ∂àÊÅØÊ†ºÂºè: {name: "ËßíËâ≤Âêç", message: "Ê∂àÊÅØÂÜÖÂÆπ"}
                        console.log('üî• [‰øÆÂ§çcontinuation] ÂèëÁé∞Áæ§ËÅäÊ∂àÊÅØ:', msgData);
                        
                        // Êü•ÊâæÁæ§ÊàêÂëòID
                        let senderId = null;
                        if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                            const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                            if (member) {
                                senderId = member.id;
                            }
                        }
                        
                        // --- ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊ£ÄÊü•Áæ§ËÅäÊ∂àÊÅØÂÜÖÂÆπÊòØÂê¶‰∏∫ÁâπÊÆäÁ±ªÂûã ---
                        if (typeof msgData.message === 'object' && msgData.message.type === 'voice_message') {
                            // Â¶ÇÊûúÊ∂àÊÅØÂÜÖÂÆπÊòØ‰∏Ä‰∏™ËØ≠Èü≥Ê∂àÊÅØÂØπË±°
                            aiMessage = {
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                type: 'voice_message', // Âú®Â§ñÂ±ÇÊ∂àÊÅØ‰∏äËÆæÁΩÆÊ≠£Á°ÆÁöÑÁ±ªÂûã
                                name: msgData.name,
                                senderId: senderId,
                                content: msgData.message.content, // ÊèêÂèñÁúüÊ≠£ÁöÑËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ
                                timestamp: Date.now() + i * 100
                            };
                        } else {
                            // ÂØπ‰∫éÊôÆÈÄöÁöÑÊñáÊú¨Ê∂àÊÅØ
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            name: msgData.name,          // ‰øùÂ≠òÂèëË®ÄËÄÖÂêçÂ≠ó
                            senderId: senderId,          // ‰øùÂ≠òÂèëË®ÄËÄÖID
                            content: msgData.message,    // ‰ΩøÁî®messageÂ≠óÊÆµ‰Ωú‰∏∫ÂÜÖÂÆπ
                            timestamp: Date.now() + i * 100
                        };
                        }
                        // --- ‰øÆÂ§çÁªìÊùü ---
                        console.log('‚úÖ [‰øÆÂ§çcontinuation] Áæ§ËÅäÊ∂àÊÅØÂ∑≤Ê≠£Á°ÆËß£Êûê:', aiMessage);
                                            } else {
                        // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç - Áª≠ÂÜôÁâàÊú¨„ÄëÊ£ÄÊü•ÊòØÂê¶ÊòØÁâπÊÆäÁ±ªÂûãÂØπË±°‰ΩÜÊú™Ë¢´‰∏äÈù¢ÁöÑÊù°‰ª∂ÊçïËé∑
                        if (typeof msgData === 'object' && msgData !== null) {
                            if (msgData.type === 'transfer') {
                                // ËΩ¨Ë¥¶ÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                                aiMessage = { 
                                    id: (Date.now() + i).toString(), 
                                    sender: 'received', 
                                    type: 'transfer', 
                                    amount: msgData.amount, 
                                    note: msgData.note, 
                                    timestamp: Date.now() + i * 100 
                                };
                            } else if (msgData.type === 'voice_message') {
                                // ËØ≠Èü≥Ê∂àÊÅØÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                                aiMessage = { 
                                    id: (Date.now() + i).toString(), 
                                    sender: 'received', 
                                    type: 'voice_message', 
                                    content: msgData.content, 
                                    timestamp: Date.now() + i * 100 
                                };
                            } else if (msgData.type === 'ai_image') {
                                // AIÂõæÁâáÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                                aiMessage = { 
                                    id: (Date.now() + i).toString(), 
                                    sender: 'received', 
                                    type: 'ai_image', 
                                    content: '', 
                                    image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`, 
                                    imageDescription: msgData.description, 
                                    timestamp: Date.now() + i * 100 
                                };
                            } else if (msgData.type === 'emoji') {
                                // Ë°®ÊÉÖÂåÖÂØπË±°Ë¢´ÈÅóÊºè‰∫ÜÔºåÈáçÊñ∞Â§ÑÁêÜ
                                const matchingEmoji = customEmojis.find(emoji => emoji.description === msgData.description);
                                if (matchingEmoji) {
                                    aiMessage = { 
                                        id: (Date.now() + i).toString(), 
                                        sender: 'received', 
                                        content: '', 
                                        image: matchingEmoji.url, 
                                        isEmoji: true, 
                                        emojiDescription: matchingEmoji.description, 
                                        timestamp: Date.now() + i * 100 
                                    };
                                    addToRecentEmojis({ id: matchingEmoji.id, url: matchingEmoji.url, description: matchingEmoji.description });
                                } else {
                                    aiMessage = { 
                                        id: (Date.now() + i).toString(), 
                                        sender: 'received', 
                                        content: `[Ë°®ÊÉÖÂåÖ"${msgData.description}"‰∏çÂ≠òÂú®]`, 
                                        timestamp: Date.now() + i * 100 
                                    };
                                }
                            } else {
                                // ÂÖ∂‰ªñÂØπË±°Á±ªÂûãÔºåÂ∞ùËØïÊèêÂèñÊñáÊú¨ÂÜÖÂÆπ
                                const displayContent = msgData.content || msgData.message || msgData.text || msgData.reply || '[‰∏çÊîØÊåÅÁöÑÊ∂àÊÅØÊ†ºÂºè]';
                                aiMessage = { 
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: displayContent, 
                                    timestamp: Date.now() + i * 100
                                };
                            }
                        } else if (typeof msgData === 'string') {
                            // ÊôÆÈÄöÂ≠óÁ¨¶‰∏≤
                            aiMessage = { 
                                id: (Date.now() + i).toString(),
                                sender: 'received',
                                content: msgData, 
                                timestamp: Date.now() + i * 100
                            };
                        } else {
                            // ÂÖ∂‰ªñÂü∫Êú¨Á±ªÂûã
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: String(msgData), 
                            timestamp: Date.now() + i * 100
                        };
                        }
                    }
                    
                    chatMessages[continuingCharacterId].push(aiMessage);
                    saveChatMessages();
                    addMessageWithAnimation(aiMessage, continuingCharacterId);
                    
                    // üî•„ÄêÊñ∞Â¢û„Äë‰∏∫Áª≠ÂÜôÁöÑÊØèÊù°Ê∂àÊÅØÂàõÂª∫Êé®ÈÄÅÈÄöÁü•
                    if (typeof msgData === 'string' || 
                        (typeof msgData === 'object' && (msgData.type || (msgData.name && msgData.message)))) {
                        console.log('üî• [Êé®ÈÄÅÈÄöÁü•] Áª≠ÂÜôÊ∂àÊÅØÔºåÂàõÂª∫Êé®ÈÄÅÈÄöÁü•:', msgData);
                        createPushNotification(currentChatCharacter, msgData, i * 500);
                    }
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('AIÁª≠ÂÜôÂ§±Ë¥•:', error);
                hideTypingIndicator();
                
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[Áª≠ÂÜôÂ§±Ë¥•: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[continuingCharacterId].push(errorMessage);
                saveChatMessages();
                addMessageWithAnimation(errorMessage, continuingCharacterId);
            } finally {
                // ÈáçÁΩÆÁä∂ÊÄÅ
                isWaitingForReply = false;
                pendingUserMessage = null;
                
                // ÊÅ¢Â§çÊô∫ËÉΩÂõûÂ§çÊåâÈíÆ
                if (smartReplyBtn) {
                    smartReplyBtn.disabled = false;
                    smartReplyBtn.style.opacity = '';
                    smartReplyBtn.style.animation = 'none';
                    smartReplyBtn.classList.remove('waiting');
                    smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    smartReplyBtn.title = 'Ëé∑ÂèñAIÂõûÂ§ç';
                }
                
                // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
                updateFloatingButtonsVisibility();
            }
        }

        // Â§ÑÁêÜAIÂõûÂ§ç
        async function processAIReply() {
            if (!currentChatCharacter) return;
            
            // Èò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
            if (isWaitingForReply) {
                console.log('AIÊ≠£Âú®ÂõûÂ§ç‰∏≠ÔºåÂøΩÁï•ÈáçÂ§çË∞ÉÁî®');
                return;
            }
            
            // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëËÆ∞ÂΩïÂΩìÂâçËÅäÂ§©ËßíËâ≤IDÔºåÁ°Æ‰øùAIÂõûÂ§çÂΩíÂ±ûÂà∞Ê≠£Á°ÆÁöÑËÅäÂ§©Á™óÂè£
            const replyingCharacterId = currentChatCharacter.id;
            
            // Êô∫ËÉΩÈÄâÊã©ÊúÄ‰Ω≥ÁöÑÁî®Êà∑Ê∂àÊÅØÔºà‰ºòÂÖàÂõæÁâáÊ∂àÊÅØÔºâ
            const messages = chatMessages[replyingCharacterId] || [];
            const userMessages = messages.filter(msg => msg.sender === 'sent');
            
            // ‰ºòÂÖàÊü•ÊâæÊúÄËøëÁöÑÂåÖÂê´ÂõæÁâáÁöÑÊ∂àÊÅØÔºà5Êù°Ê∂àÊÅØÂÜÖÔºâ
            const recentMessages = userMessages.slice(-5);
            const imageMessage = recentMessages.reverse().find(msg => 
                Array.isArray(msg.content) || msg.image
            );
            
            if (imageMessage) {
                pendingUserMessage = imageMessage;
            } else if (!pendingUserMessage) {
                // Â¶ÇÊûúÊ≤°ÊúâÂõæÁâáÊ∂àÊÅØ‰∏îÊ≤°ÊúâÂæÖÂõûÂ§çÊ∂àÊÅØÔºå‰ΩøÁî®ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                const lastUserMessage = userMessages.pop();
                if (lastUserMessage) {
                    pendingUserMessage = lastUserMessage;
                } else {
                    return;
                }
            }

            isWaitingForReply = true;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = true;
                smartReplyBtn.style.opacity = '0.65';
                smartReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
            showTypingIndicator();
            
            // Ê∑ªÂä†ÈöèÊú∫Âª∂Ëøü
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                // Ë∞ÉÁî®APIÔºåÊîØÊåÅÂõæÁâáÂíåË°®ÊÉÖÂåÖ
                // üî•„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊ≠£Á°ÆÂ§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØ
                let response;
                

                
                // Ê†∏ÂøÉ‰øÆÂ§çÔºöÁõ¥Êé•Â∞Ü pendingUserMessage.content (ÂèØËÉΩÊòØÊï∞ÁªÑ) ‰º†ÈÄíÁªô callChatAPI
                if (Array.isArray(pendingUserMessage.content)) {
                    // ËøôÊòØÂ§öÊ®°ÊÄÅÊ∂àÊÅØÔºàÂõæÊñáÔºâ
                    response = await callChatAPI(pendingUserMessage.content, currentChatCharacter);
                } else if (pendingUserMessage.image) {
                    // ÂÖºÂÆπÊóßÁöÑÂõæÁâáÊ∂àÊÅØÊ†ºÂºè
                    const messageContent = [
                        { type: 'text', text: pendingUserMessage.content || "" },
                        { type: 'image_url', image_url: { url: pendingUserMessage.image } }
                    ];
                    response = await callChatAPI(messageContent, currentChatCharacter);
                        } else {
                    // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ„ÄÅ‰ΩçÁΩÆÊ∂àÊÅØ„ÄÅËØ≠Èü≥Ê∂àÊÅØÁ≠â
                    response = await callChatAPI(pendingUserMessage.content, currentChatCharacter);
                }
                
                const aiMessages = parseAiResponse(response);
                
                for (const msgData of aiMessages) {
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊãâÈªëÊåá‰ª§ÂØπË±°
    if (typeof msgData === 'object' && msgData !== null && msgData.type === 'block_user') {
        console.log('üö´ Ê£ÄÊµãÂà∞AIÊãâÈªëÊåá‰ª§ÂØπË±°:', msgData);
        // ‰ΩøÁî®Êåá‰ª§‰∏≠ÁöÑ reason ‰Ωú‰∏∫ÊãâÈªëÁêÜÁî±
        await aiBlockUser(currentChatCharacter.id, msgData.reason || 'ÂØπÊñπÊú™ËØ¥ÊòéÁêÜÁî±');
        // ÊãâÈªëÂêéÔºåÈÄöÂ∏∏‰∏çÈúÄË¶ÅÂÜçÊòæÁ§∫ÂêéÁª≠Ê∂àÊÅØÔºåÁõ¥Êé•Ë∑≥Âá∫Âæ™ÁéØ
        break; 
    }
}
                
                // üî•„Äê‰øÆÂ§çËΩ¨Ë¥¶Â§ÑÁêÜ„ÄëÂ¶ÇÊûúÁî®Êà∑ÂèëÁöÑÊòØËΩ¨Ë¥¶Ê∂àÊÅØÔºåÈúÄË¶ÅÂàÜÊûêAIÁöÑÂõûÂ§çÊù•Â§ÑÁêÜËΩ¨Ë¥¶
                if (pendingUserMessage && pendingUserMessage.type === 'transfer') {
                    console.log('üî• Ê£ÄÊµãÂà∞Áî®Êà∑ËΩ¨Ë¥¶Ê∂àÊÅØÔºåÂºÄÂßãÂ§ÑÁêÜËΩ¨Ë¥¶:', {
                        pendingUserMessage,
                        aiMessages,
                        characterName: currentChatCharacter?.name
                    });
                    await processUserTransfer(pendingUserMessage, aiMessages);
                }
                
                // üî•„ÄêÁ¥ßÊÄ•‰øÆÂ§ç„ÄëÊó†ËÆ∫Â¶Ç‰ΩïÔºåÊØèÊ¨°AIÂõûÂ§çÂêéÈÉΩÊ£ÄÊü•ÊòØÂê¶ÊúâÊú™Â§ÑÁêÜÁöÑËΩ¨Ë¥¶
                console.log('üî• [Á¥ßÊÄ•‰øÆÂ§ç] AIÂõûÂ§çÂÆåÊàêÔºåÊ£ÄÊü•Êú™Â§ÑÁêÜËΩ¨Ë¥¶');
                const allMessages = chatMessages[replyingCharacterId] || [];
                const unprocessedTransfer = allMessages.slice().reverse().find(msg => 
                    msg.sender === 'sent' && msg.type === 'transfer' && !msg.status);
                if (unprocessedTransfer) {
                    console.log('üî• [Á¥ßÊÄ•‰øÆÂ§ç] ÂèëÁé∞Êú™Â§ÑÁêÜËΩ¨Ë¥¶ÔºåÁ´ãÂç≥Â§ÑÁêÜ:', unprocessedTransfer);
                    await processUserTransfer(unprocessedTransfer, aiMessages);
                }
                
                // üî•„ÄêÁßªÈô§ÂÖ≥ÈîÆËØçËß¶ÂèëÊú∫Âà∂„ÄëÁé∞Âú®AI‰ºöÊ†πÊçÆËá™Â∑±ÁöÑÂà§Êñ≠‰∏ªÂä®ÂèëËµ∑ÈÄöËØùÔºå‰∏çÂÜçÈúÄË¶ÅÂ§ñÈÉ®Ëß¶ÂèëÈÄªËæë
                
                // üî•„ÄêÊñ∞Â¢û„Äë‰∏∫AIÁöÑÊØèÊù°ÂõûÂ§çÂàõÂª∫Êé®ÈÄÅÈÄöÁü•
                console.log('üîî [Êé®ÈÄÅÈÄöÁü•] AIÂõûÂ§çÂÆåÊàêÔºåÂáÜÂ§áÂàõÂª∫Êé®ÈÄÅÈÄöÁü•ÔºåÊ∂àÊÅØÊï∞Èáè:', aiMessages.length);
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    console.log('üîî [Êé®ÈÄÅÈÄöÁü•] Â§ÑÁêÜÊ∂àÊÅØ', i, ':', msgData);
                    if (typeof msgData === 'string' ||
                        (typeof msgData === 'object' && (msgData.type || (msgData.name && msgData.message)))) {
                        createPushNotification(currentChatCharacter, msgData, i * 500);
                    }
                }

                // üî•„Äê‰øÆÂ§ç„ÄëËÆ∞ÂΩïAIÂõûÂ§çÁöÑË∑®Â∫îÁî®Êó∂Èó¥Á∫ø‰∫ã‰ª∂
                setTimeout(async () => {
                    try {
                        for (let i = 0; i < aiMessages.length; i++) {
                            const msgData = aiMessages[i];
                            let eventContent = '';
                            let characterId = replyingCharacterId;

                            if (typeof msgData === 'string') {
                                eventContent = msgData;
                            } else if (typeof msgData === 'object' && msgData.name && msgData.message) {
                                // Áæ§ËÅäÊ∂àÊÅØÊ†ºÂºè
                                eventContent = msgData.message;
                                // Êü•ÊâæÁæ§ÊàêÂëòID
                                if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                                    const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                                    if (member) characterId = member.id;
                                }
                            } else if (typeof msgData === 'object' && msgData.content) {
                                eventContent = msgData.content;
                            }

                            if (eventContent && characterId) {
                                await recordCrossAppEvent(
                                    characterId,
                                    'chat',
                                    'ai_message',
                                    {
                                        id: currentChatCharacter.id,
                                        type: currentChatCharacter?.isGroup ? 'group_chat' : 'private_chat',
                                        sender: 'ai',
                                        content: eventContent,
                                        chatType: currentChatCharacter?.isGroup ? 'group' : 'single'
                                    }
                                );
                                console.log(`üî• [‰øÆÂ§ç] Â∑≤ËÆ∞ÂΩïAIÂõûÂ§çÊó∂Èó¥Á∫ø‰∫ã‰ª∂ - ËßíËâ≤: ${characterId}, ÂÜÖÂÆπ: ${eventContent.substring(0, 50)}...`);
                            }
                        }
                    } catch (error) {
                        console.error('ËÆ∞ÂΩïAIÂõûÂ§çÊó∂Èó¥Á∫ø‰∫ã‰ª∂Â§±Ë¥•:', error);
                    }
                }, 2000); // Âª∂Ëøü2ÁßíÊâßË°å
                
// --- ËØ∑Áî®ËøôÊÆµÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÊõøÊç¢ ---
                hideTypingIndicator();
                
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
    let aiMessage; // ÂÖàÂ£∞ÊòéÂèòÈáè

    // üî•„Äê‰øÆÂ§ç„ÄëË∑≥ËøáÊãâÈªëÊåá‰ª§ÂØπË±°ÔºåÈÅøÂÖçÊòæÁ§∫"‰∏çÊîØÊåÅÁöÑÊ∂àÊÅØÊ†ºÂºè"
    if (typeof msgData === 'object' && msgData !== null && msgData.type === 'block_user') {
        console.log('üö´ Ë∑≥ËøáÊãâÈªëÊåá‰ª§ÂØπË±°Ôºå‰∏çÊòæÁ§∫‰∏∫Ê∂àÊÅØ:', msgData);
        continue;
    }

    if (typeof msgData === 'object' && msgData !== null) {
        if (msgData.type === 'voice_message') {
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'voice_message', content: msgData.content, timestamp: Date.now() + i * 100 };
        } else if (msgData.type === 'ai_image') {
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'ai_image', content: '', image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`, imageDescription: msgData.description, timestamp: Date.now() + i * 100 };
        } else if (msgData.type === 'ai_photo') {
            // ËßíËâ≤ÂèëÈÄÅÁöÑ"‰º™ÁÖßÁâá"
            console.log('Â§ÑÁêÜËßíËâ≤ÁÖßÁâáÊ∂àÊÅØ:', msgData);
            // Á°Æ‰øùÊàë‰ª¨Êúâ‰∏Ä‰∏™ÊúâÊïàÁöÑÊèèËø∞
            const photoDesc = msgData.description || msgData.content || msgData.photoDescription || 'ËßíËâ≤ÂèëÈÄÅÁöÑÁÖßÁâá';
            console.log('ÁÖßÁâáÊèèËø∞:', photoDesc);
            aiMessage = { 
                id: (Date.now() + i).toString(), 
                sender: 'received', 
                type: 'user_photo', // ‰ΩøÁî®‰∏éÁî®Êà∑ÁÖßÁâáÁõ∏ÂêåÁöÑÁ±ªÂûã‰ª•‰æøÂ§çÁî®Ê∏≤ÊüìÈÄªËæë
                content: photoDesc,
                photoDescription: photoDesc,
                timestamp: Date.now() + i * 100 
            };
        } else if (msgData.type === 'location') {
            // ËßíËâ≤ÂèëÈÄÅÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ
            console.log('Â§ÑÁêÜËßíËâ≤‰ΩçÁΩÆÊ∂àÊÅØ:', msgData);
            // Á°Æ‰øùÊàë‰ª¨Êúâ‰∏Ä‰∏™ÊúâÊïàÁöÑ‰ΩçÁΩÆÂêçÁß∞
            const locationName = msgData.locationName || msgData.name || 'Êú™Áü•‰ΩçÁΩÆ';
            console.log('‰ΩçÁΩÆÂêçÁß∞:', locationName, 'ÂùêÊ†á:', msgData.coordinates || 'Êú™Áü•ÂùêÊ†á');
            aiMessage = { 
                id: (Date.now() + i).toString(), 
                sender: 'received', 
                type: 'location', // ‰øùÊåÅÁ±ªÂûã‰∏∫location
                locationName: locationName,
                coordinates: msgData.coordinates || 'Êú™Áü•ÂùêÊ†á',
                content: `[ËßíËâ≤ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ‰ø°ÊÅØÔºö${locationName}]`,
                timestamp: Date.now() + i * 100 
            };
        } else if (msgData.type === 'transfer') {
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', type: 'transfer', amount: msgData.amount, note: msgData.note, timestamp: Date.now() + i * 100 };
        } else if (msgData.type === 'emoji') {
            const matchingEmoji = customEmojis.find(emoji => emoji.description === msgData.description);
                        if (matchingEmoji) {
                aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '', image: matchingEmoji.url, isEmoji: true, emojiDescription: matchingEmoji.description, timestamp: Date.now() + i * 100 };
                addToRecentEmojis({ id: matchingEmoji.id, url: matchingEmoji.url, description: matchingEmoji.description });
                        } else {
                aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: `[Ë°®ÊÉÖÂåÖ"${msgData.description}"‰∏çÂ≠òÂú®]`, timestamp: Date.now() + i * 100 };
            }
        } else if (msgData.type === 'change_avatar') {
                        if (msgData.avatar_url) {
                            const isValidAvatar = await validateAvatarSource(msgData.avatar_url);
                            if (isValidAvatar) {
                                const success = await changeCharacterAvatarByAI(msgData.avatar_url, msgData.reason || 'ÂøÉÊÉÖÂèòÂåñ');
                    if (success) continue; 
                    else aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[Â§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', timestamp: Date.now() + i * 100 };
                                } else {
                    aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: '[Êó†ÊïàÁöÑÂ§¥ÂÉèÊù•Ê∫êÔºåÂ§¥ÂÉèÊõ¥Êç¢Â§±Ë¥•]', timestamp: Date.now() + i * 100 };
                                }
                            } else {
                continue;
            }
        } else if (msgData.type === 'voice_call') {
            // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAI‰∏ªÂä®ÂèëËµ∑ËØ≠Èü≥ÈÄöËØù
            console.log('üîî AIËØ∑Ê±ÇÂèëËµ∑ËØ≠Èü≥ÈÄöËØù:', msgData);
            setTimeout(() => {
                initiateAICall(currentChatCharacter, msgData.reason || 'ÊÉ≥Âíå‰Ω†ËÅäËÅä');
            }, 100 + Math.random() * 200); // Ëøõ‰∏ÄÊ≠•ÂáèÂ∞ëÂª∂ËøüÂà∞0.1-0.3Áßí
            continue; // Ë∑≥ËøáÊ∂àÊÅØÊòæÁ§∫ÔºåÂõ†‰∏∫ËøôÊòØ‰∏Ä‰∏™Âä®‰ΩúÊåá‰ª§
        } else if (msgData.name && msgData.message) {
            // ËøôÊòØÁæ§ËÅäÁöÑÁâπÊÆäÊ†ºÂºè
            let senderId = null;
            if (currentChatCharacter && currentChatCharacter.isGroup && currentChatCharacter.members) {
                const member = currentChatCharacter.members.find(m => m.name === msgData.name);
                if (member) senderId = member.id;
            }

            // --- ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊ£ÄÊü•Áæ§ËÅäÊ∂àÊÅØÂÜÖÂÆπÊòØÂê¶‰∏∫ÁâπÊÆäÁ±ªÂûã ---
            if (typeof msgData.message === 'object' && msgData.message.type === 'voice_message') {
                // Â¶ÇÊûúÊ∂àÊÅØÂÜÖÂÆπÊòØ‰∏Ä‰∏™ËØ≠Èü≥Ê∂àÊÅØÂØπË±°
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    type: 'voice_message', // Âú®Â§ñÂ±ÇÊ∂àÊÅØ‰∏äËÆæÁΩÆÊ≠£Á°ÆÁöÑÁ±ªÂûã
                    name: msgData.name,
                    senderId: senderId,
                    content: msgData.message.content, // ÊèêÂèñÁúüÊ≠£ÁöÑËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ
                    timestamp: Date.now() + i * 100
                };
            } else if (typeof msgData.message === 'object' && msgData.message.type === 'transfer') {
                // üî•„Äê‰øÆÂ§ç„ÄëÂ¶ÇÊûúÊ∂àÊÅØÂÜÖÂÆπÊòØ‰∏Ä‰∏™ËΩ¨Ë¥¶ÂØπË±°
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    type: 'transfer', // Âú®Â§ñÂ±ÇÊ∂àÊÅØ‰∏äËÆæÁΩÆÊ≠£Á°ÆÁöÑÁ±ªÂûã
                    name: msgData.name,
                    senderId: senderId,
                    amount: msgData.message.amount, // ÊèêÂèñËΩ¨Ë¥¶ÈáëÈ¢ù
                    note: msgData.message.note, // ÊèêÂèñËΩ¨Ë¥¶Â§áÊ≥®
                    timestamp: Date.now() + i * 100
                };
            } else {
                // ÂØπ‰∫éÊôÆÈÄöÁöÑÊñáÊú¨Ê∂àÊÅØ
                aiMessage = {
                    id: (Date.now() + i).toString(),
                    sender: 'received',
                    name: msgData.name,
                    senderId: senderId,
                    content: msgData.message, // ÂÜÖÂÆπÊú¨Ë∫´ÊòØÂ≠óÁ¨¶‰∏≤
                    timestamp: Date.now() + i * 100
                };
            }
            // --- ‰øÆÂ§çÁªìÊùü ---
                    } else {
            // ÂÖ∂‰ªñÊâÄÊúâÊú™Áü•ÂØπË±°ÁöÑÂ§ÑÁêÜ - ‰øÆÂ§ç[object Object]ÈóÆÈ¢ò
            let displayContent;
            if (msgData.content && typeof msgData.content === 'string') {
                displayContent = msgData.content;
            } else if (msgData.message && typeof msgData.message === 'string') {
                displayContent = msgData.message;
            } else if (msgData.text && typeof msgData.text === 'string') {
                displayContent = msgData.text;
            } else if (msgData.reply && typeof msgData.reply === 'string') {
                displayContent = msgData.reply;
            } else if (typeof msgData === 'string') {
                displayContent = msgData;
            } else {
                // ÂØπ‰∫éÂÖ∂‰ªñÂ§çÊùÇÂØπË±°ÔºåÊèêÂèñÊúâÁî®‰ø°ÊÅØÊàñÊòæÁ§∫Á±ªÂûãÊèêÁ§∫
                console.warn('Êú™Â§ÑÁêÜÁöÑÂØπË±°Á±ªÂûã:', msgData);
                displayContent = '[‰∏çÊîØÊåÅÁöÑÊ∂àÊÅØÊ†ºÂºè]';
            }
            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: displayContent, timestamp: Date.now() + i * 100 };
                            }
                        } else if (typeof msgData === 'string') {
                            // ÊôÆÈÄöÂ≠óÁ¨¶‰∏≤
                            aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: msgData, timestamp: Date.now() + i * 100 };
                        } else {
                            // ÂÖ∂‰ªñÁ±ªÂûãÔºåÂº∫Âà∂ËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
        aiMessage = { id: (Date.now() + i).toString(), sender: 'received', content: String(msgData), timestamp: Date.now() + i * 100 };
                    }
                    
                    chatMessages[replyingCharacterId].push(aiMessage);
    await saveChatMessages();
                    addMessageWithAnimation(aiMessage, replyingCharacterId);
                    
                    // üî•„ÄêÊñ∞Â¢û„ÄëËß¶ÂèëËßíËâ≤Áä∂ÊÄÅÊõ¥Êñ∞
                    triggerStatusUpdateAfterMessage(replyingCharacterId);

                    // üî•„ÄêÊñ∞Â¢û„ÄëÂú®ÊúÄÂêé‰∏ÄÊù°AIÂõûÂ§çÂêéËÆ∞ÂΩïÊó∂Èó¥Á∫ø
                    if (i === aiMessages.length - 1) {
                        setTimeout(async () => {
                            try {
                                // ËÆ∞ÂΩïAIÂõûÂ§çÁöÑÊó∂Èó¥Á∫ø‰∫ã‰ª∂
                                await recordCrossAppEvent(
                                    replyingCharacterId,
                                    'chat',
                                    'ai_reply',
                                    {
                                        id: currentChatCharacter.id,
                                        type: currentChatCharacter?.isGroup ? 'group_chat' : 'private_chat',
                                        sender: 'ai',
                                        content: aiMessage.content,
                                        chatType: currentChatCharacter?.isGroup ? 'group' : 'single'
                                    },
                                    aiMessage.id
                                );
                            } catch (error) {
                                console.error('AIÂõûÂ§çÂêéËÆ∞ÂøÜÂ§ÑÁêÜÂ§±Ë¥•:', error);
                            }
                        }, 2000); // Âª∂Ëøü2ÁßíÊâßË°åÔºåÈÅøÂÖçÈòªÂ°ûUI
                    }

                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('AIÂõûÂ§çÂ§±Ë¥•:', error);
                hideTypingIndicator();
                
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[ÂõûÂ§çÂ§±Ë¥•: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[replyingCharacterId].push(errorMessage);
                saveChatMessages();
                addMessageWithAnimation(errorMessage, replyingCharacterId);
            } finally {
                // ÈáçÁΩÆÁä∂ÊÄÅ
                isWaitingForReply = false;
                pendingUserMessage = null;
                
                // ÊÅ¢Â§çÊô∫ËÉΩÂõûÂ§çÊåâÈíÆ
                if (smartReplyBtn) {
                    smartReplyBtn.disabled = false;
                    smartReplyBtn.style.opacity = '';
                    smartReplyBtn.style.animation = 'none';
                    smartReplyBtn.classList.remove('waiting');
                    smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    smartReplyBtn.title = 'Ëé∑ÂèñAIÂõûÂ§ç';
                }
                
                // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
                updateFloatingButtonsVisibility();
            }
        }

        // ÈáçÁΩÆÊÇ¨ÊµÆÊåâÈíÆÁä∂ÊÄÅ
        function resetFloatingButtonsState() {
            // ÈáçÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = null;
            isWaitingForReply = false;
            
            // ÈáçÁΩÆÊô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = false;
                smartReplyBtn.style.opacity = '';
                smartReplyBtn.style.animation = 'none';
                smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                smartReplyBtn.title = 'Ëé∑ÂèñAIÂõûÂ§ç';
                smartReplyBtn.classList.remove('waiting');
            }
            
            // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
            updateFloatingButtonsVisibility();
        }

        // Êõ¥Êñ∞ÊÇ¨ÊµÆÊåâÈíÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        function updateFloatingButtonsVisibility() {
            if (!currentChatCharacter) return;
            
            const regenerateBtn = document.getElementById('regenerate-btn');
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            const messages = chatMessages[currentChatCharacter.id] || [];
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâAIÊ∂àÊÅØÂèØ‰ª•ÈáçÊñ∞ÁîüÊàê
            const hasAIMessages = messages.some(msg => msg.sender === 'received');
            
            if (regenerateBtn) {
                if (hasAIMessages) {
                    regenerateBtn.classList.remove('hidden');
                } else {
                    regenerateBtn.classList.add('hidden');
                }
            }
            
            if (smartReplyBtn) {
                // Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÊÄªÊòØÊòæÁ§∫
                smartReplyBtn.classList.remove('hidden');
            }
        }

        // @Áæ§ÊàêÂëòÂäüËÉΩÁõ∏ÂÖ≥ÂáΩÊï∞
        function handleMentionInput(e) {
            const input = e.target;
            const text = input.value;
            const cursorPos = input.selectionStart;

            // Êü•ÊâæÊúÄËøëÁöÑ@Á¨¶Âè∑‰ΩçÁΩÆ
            let atPos = -1;
            for (let i = cursorPos - 1; i >= 0; i--) {
                if (text[i] === '@') {
                    atPos = i;
                    break;
                } else if (text[i] === ' ' || text[i] === '\n') {
                    break;
                }
            }

            if (atPos !== -1 && isGroupChat()) {
                // ÊâæÂà∞@Á¨¶Âè∑ÔºåÊòæÁ§∫Áæ§ÊàêÂëòÂàóË°®
                const query = text.substring(atPos + 1, cursorPos);
                mentionStartPos = atPos;
                currentMentionQuery = query;
                showMentionDropdown(query);
            } else {
                // Ê≤°Êúâ@Á¨¶Âè∑Êàñ‰∏çÊòØÁæ§ËÅäÔºåÈöêËóè‰∏ãÊãâÊ°Ü
                hideMentionDropdown();
            }
        }

        function handleMentionKeydown(e) {
            const dropdown = document.getElementById('mention-dropdown');
            const items = dropdown.querySelectorAll('.mention-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedMentionIndex = Math.min(selectedMentionIndex + 1, items.length - 1);
                updateMentionSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedMentionIndex = Math.max(selectedMentionIndex - 1, 0);
                updateMentionSelection(items);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                if (selectedMentionIndex >= 0 && items[selectedMentionIndex]) {
                    selectMention(items[selectedMentionIndex]);
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideMentionDropdown();
            }
        }

        function isGroupChat() {
            return currentChatCharacter && groupChats.find(g => g.id === currentChatCharacter.id);
        }

        function showMentionDropdown(query) {
            if (!isGroupChat()) return;

            const group = groupChats.find(g => g.id === currentChatCharacter.id);
            if (!group || !group.members) return;

            const dropdown = document.getElementById('mention-dropdown');
            const filteredMembers = group.members.filter(member =>
                member.name.toLowerCase().includes(query.toLowerCase())
            );

            if (filteredMembers.length === 0) {
                hideMentionDropdown();
                return;
            }

            dropdown.innerHTML = '';
            filteredMembers.forEach((member, index) => {
                const item = document.createElement('div');
                item.className = 'mention-item';
                item.innerHTML = `
                    <div class="mention-avatar" style="background-color: ${member.color || '#4CAF50'}; ${member.avatarUrl ? `background-image: url(${member.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${member.avatarUrl ? '' : member.name.charAt(0)}
                    </div>
                    <div class="mention-name">${member.name}</div>
                `;
                item.onclick = () => selectMention(item);
                item.dataset.memberName = member.name;
                item.dataset.memberId = member.id;
                dropdown.appendChild(item);
            });

            selectedMentionIndex = 0;
            updateMentionSelection(dropdown.querySelectorAll('.mention-item'));
            dropdown.style.display = 'block';
            mentionDropdownVisible = true;
        }

        function hideMentionDropdown() {
            const dropdown = document.getElementById('mention-dropdown');
            dropdown.style.display = 'none';
            mentionDropdownVisible = false;
            selectedMentionIndex = -1;
            mentionStartPos = -1;
            currentMentionQuery = '';
        }

        function updateMentionSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedMentionIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectMention(item) {
            const memberName = item.dataset.memberName;
            const input = document.getElementById('api-chat-input');
            const text = input.value;

            // ÊõøÊç¢@Êü•ËØ¢ÊñáÊú¨‰∏∫@Êüê‰∫∫
            const beforeMention = text.substring(0, mentionStartPos);
            const afterMention = text.substring(mentionStartPos + 1 + currentMentionQuery.length);
            const newText = beforeMention + `@${memberName} ` + afterMention;

            input.value = newText;

            // ËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆÂà∞@Êüê‰∫∫ÂêéÈù¢
            const newCursorPos = mentionStartPos + memberName.length + 2;
            input.setSelectionRange(newCursorPos, newCursorPos);

            hideMentionDropdown();
            input.focus();
        }

        // Â§ÑÁêÜÊ∂àÊÅØ‰∏≠ÁöÑ@ÂÜÖÂÆπÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫Â∏¶Ê†∑ÂºèÁöÑHTML
        function processMentions(content) {
            if (!content || typeof content !== 'string') return content;

            // ÂåπÈÖç@Êüê‰∫∫ÁöÑÊ®°Âºè
            return content.replace(/@([^\s@]+)/g, '<span class="mention-text">@$1</span>');
        }

        // ‰øÆÊîπÂéüÊù•ÁöÑsendApiMessageÂáΩÊï∞Ôºå‰ΩøÂÖ∂Âè™ÂèëÈÄÅÊ∂àÊÅØÂà∞ÁïåÈù¢Ôºå‰∏çËß¶ÂèëAIÂõûÂ§ç
        async function sendApiMessage() {
            const input = document.getElementById('api-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            // üî•„ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•ÊòØÂê¶Ë¢´ÊãâÈªëÔºåÈòªÊ≠¢ÂèëÈÄÅÊ∂àÊÅØ
            if (isBlocked(currentChatCharacter.id, 'user')) {
                showToast('‰Ω†Ë¢´ÂØπÊñπÊãâÈªë‰∫ÜÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ', 'warning');
                return;
            }

            // Èò≤Ê≠¢ÈáçÂ§çÂèëÈÄÅ
            if (input._isProcessing) return;
            input._isProcessing = true;

            try {
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            const messageId = Date.now().toString();
            const userMessage = {
                id: messageId,
                sender: 'sent',
                content: message,
                timestamp: Date.now(),
                // Â¶ÇÊûúÊúâÂºïÁî®Ê∂àÊÅØÔºåÊ∑ªÂä†ÂºïÁî®‰ø°ÊÅØ
                replyTo: currentReplyTo ? {
                    id: currentReplyTo.id,
                    content: currentReplyTo.content,
                    senderName: currentReplyTo.senderName
                } : null
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(userMessage);
            saveChatMessages();
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            input.value = '';
            
            // Ê∏ÖÈô§ÂºïÁî®Áä∂ÊÄÅ
            cancelReply();
            
            // üî•„ÄêÊñ∞Â¢û„ÄëË∞ÉÊï¥ÂøÉÁéáÔºàÁî®Êà∑ÂèëÊ∂àÊÅØÔºâ
            adjustHeartrateForMessage(message, true);
            
            // ‰ΩøÁî®Âä®ÁîªÊ∑ªÂä†Ê∂àÊÅØËÄå‰∏çÊòØÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®
            addMessageWithAnimation(userMessage, currentChatCharacter.id);
            
            // ËÆæÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = userMessage;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
                }

            // üî•„ÄêÊñ∞Â¢û„ÄëËß¶ÂèëËÆ∞ÂøÜÂ§ÑÁêÜÔºàÁÆÄÂåñÁâàÔºâ
            setTimeout(async () => {
                try {
                    const messages = chatMessages[currentChatCharacter.id] || [];

                    // ËÆ∞ÂΩïËÅäÂ§©Êó∂Èó¥Á∫ø‰∫ã‰ª∂ÔºàÁ°Æ‰øùËßíËâ≤ÈöîÁ¶ªÔºâ
                    await recordCrossAppEvent(
                        currentChatCharacter.id,
                        'chat',
                        'user_message',
                        {
                            id: currentChatCharacter.id,
                            type: currentChatCharacter?.isGroup ? 'group_chat' : 'private_chat',
                            sender: 'user',
                            content: input.value.trim(),
                            chatType: currentChatCharacter?.isGroup ? 'group' : 'single'
                        },
                        messages[messages.length - 1]?.id
                    );

                    // AIËÆ∞ÂøÜÊèêÂèñÔºàÊ†πÊçÆÁî®Êà∑ËÆæÁΩÆÁöÑÈó¥ÈöîÔºâ
                    if (messages.length % MEMORY_CONFIG.AI_EXTRACT_INTERVAL === 0) {
                        const recentMessages = messages.slice(-MEMORY_CONFIG.AI_EXTRACT_INTERVAL);
                        await extractMemoriesWithAI(currentChatCharacter.id, recentMessages);
                        console.log(`üß† Ëß¶ÂèëËÆ∞ÂøÜÊèêÂèñ - ËßíËâ≤: ${currentChatCharacter.name}, Ê∂àÊÅØÊï∞: ${messages.length}`);
                    }
                } catch (error) {
                    console.error('ËÆ∞ÂøÜÂ§ÑÁêÜÂ§±Ë¥•:', error);
                }
            }, 1000); // Âª∂Ëøü1ÁßíÊâßË°åÔºåÈÅøÂÖçÈòªÂ°ûUI

            } finally {
                // Á°Æ‰øùÂ§ÑÁêÜÂÆåÊàêÂêéÈáçÁΩÆÊ†áÂøó
                setTimeout(() => {
                    input._isProcessing = false;
                }, 100);
            }
        }

        // ËØ≠Èü≥ÂΩïÈü≥Áõ∏ÂÖ≥ÂèòÈáè
        let isRecording = false;
        let recordingStartTime = 0;

        // Â§ÑÁêÜËØ≠Èü≥ÂΩïÈü≥
        async function handleVoiceRecording() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            // üî•„Äê‰øÆÂ§ç„ÄëÁßªÈô§ÂØπ‰∏çÂ≠òÂú®ÊåâÈíÆÁöÑ‰æùËµñÔºåÁõ¥Êé•ÊòæÁ§∫ËØ≠Èü≥ËæìÂÖ•ÂØπËØùÊ°Ü
                try {
                    const voiceText = await showVoiceInputDialog();
                    if (voiceText && voiceText.trim()) {
                        sendVoiceMessage(voiceText.trim());
                        console.log('ËØ≠Èü≥Ê∂àÊÅØÂèëÈÄÅÊàêÂäü');
                    }
                } catch (error) {
                    // Âè™ÊúâÂú®ÁúüÊ≠£ÂèñÊ∂àÊó∂ÊâçÊòæÁ§∫ÂèñÊ∂àÊ∂àÊÅØ
                    if (error.message === 'Áî®Êà∑ÂèñÊ∂à') {
                        console.log('Áî®Êà∑ÂèñÊ∂à‰∫ÜËØ≠Èü≥ËæìÂÖ•');
                    } else {
                        console.error('ËØ≠Èü≥Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•:', error);
                    }
            }
        }

        // ÈáçÁΩÆÂΩïÈü≥Áä∂ÊÄÅ - üî•„Äê‰øÆÂ§ç„ÄëÁßªÈô§ÂØπ‰∏çÂ≠òÂú®ÊåâÈíÆÁöÑ‰æùËµñ
        function resetRecordingState() {
            isRecording = false;
            // ‰∏çÂÜçÈúÄË¶ÅÊìç‰ΩúÊåâÈíÆÁä∂ÊÄÅÔºåÂõ†‰∏∫Êàë‰ª¨‰ΩøÁî®ÁöÑÊòØÂ∑•ÂÖ∑Èù¢Êùø‰∏≠ÁöÑËØ≠Èü≥ÊåâÈíÆ
        }

        // ÊòæÁ§∫ËØ≠Èü≥ËæìÂÖ•ÂØπËØùÊ°Ü
        function showVoiceInputDialog() {
            return new Promise((resolve, reject) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    width: 280px;
                    max-width: 90%;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                `;

                dialog.innerHTML = `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #333;">ËØ≠Èü≥ËΩ¨ÊñáÂ≠ó</h3>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">ËØ∑ËæìÂÖ•ÊÇ®ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºö</p>
                    </div>
                    <textarea id="voice-text-input" placeholder="Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ..." style="
                        width: 100%;
                        height: 80px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        padding: 10px;
                        font-size: 14px;
                        resize: none;
                        box-sizing: border-box;
                        outline: none;
                    "></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button id="voice-cancel-btn" style="
                            flex: 1;
                            padding: 10px;
                            border: 1px solid #ddd;
                            background: white;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">ÂèñÊ∂à</button>
                        <button id="voice-send-btn" style="
                            flex: 1;
                            padding: 10px;
                            border: none;
                            background: #4a84c1;
                            color: white;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">ÂèëÈÄÅ</button>
                    </div>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                const textInput = dialog.querySelector('#voice-text-input');
                const cancelBtn = dialog.querySelector('#voice-cancel-btn');
                const sendBtn = dialog.querySelector('#voice-send-btn');

                // Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
                setTimeout(() => textInput.focus(), 100);

                // ÂèñÊ∂àÊåâÈíÆ
                cancelBtn.onclick = () => {
                    document.body.removeChild(overlay);
                    reject(new Error('Áî®Êà∑ÂèñÊ∂à'));
                };

                // ÂèëÈÄÅÊåâÈíÆ
                sendBtn.onclick = () => {
                    const text = textInput.value.trim();
                    if (text) {
                        console.log('ËØ≠Èü≥ËæìÂÖ•ÂØπËØùÊ°ÜÔºöÁî®Êà∑ÁÇπÂáªÂèëÈÄÅÔºåÂÜÖÂÆπ:', text);
                        document.body.removeChild(overlay);
                        resolve(text);
                    } else {
                        console.log('ËØ≠Èü≥ËæìÂÖ•ÂØπËØùÊ°ÜÔºöÂÜÖÂÆπ‰∏∫Á©∫ÔºåËÅöÁÑ¶ËæìÂÖ•Ê°Ü');
                        textInput.focus();
                    }
                };

                // ÁÇπÂáªÈÅÆÁΩ©ÂÖ≥Èó≠
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        reject(new Error('Áî®Êà∑ÂèñÊ∂à'));
                    }
                };

                // ÊîØÊåÅÂõûËΩ¶ÂèëÈÄÅ
                textInput.onkeydown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log('ËØ≠Èü≥ËæìÂÖ•Ê°ÜÔºöÁî®Êà∑ÊåâÂõûËΩ¶ÈîÆÂèëÈÄÅ');
                        sendBtn.click();
                    }
                };
            });
        }

                 // ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ
        function sendVoiceMessage(text) {
            console.log('ÂºÄÂßãÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ:', text);
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÊ£ÄÊü•ÊòØÂê¶Ë¢´ÊãâÈªëÔºåÈòªÊ≠¢ÂèëÈÄÅÊ∂àÊÅØ
            if (currentChatCharacter && isBlocked(currentChatCharacter.id, 'user')) {
                showToast('‰Ω†Ë¢´ÂØπÊñπÊãâÈªë‰∫ÜÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ', 'warning');
                return;
            }
            
            const messageId = Date.now().toString();
            const duration = Math.max(1, Math.ceil(text.length / 8)); // Ê†πÊçÆÊñáÂ≠óÈïøÂ∫¶ËÆ°ÁÆó"ËØ≠Èü≥"Êó∂Èïø
            
            const voiceMessage = {
                id: messageId,
                sender: 'sent',
                type: 'voice',
                content: text,
                duration: duration,
                timestamp: Date.now()
            };

            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }

            chatMessages[currentChatCharacter.id].push(voiceMessage);
            console.log('ËØ≠Èü≥Ê∂àÊÅØÂ∑≤Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï');
            
            saveChatMessages();
            console.log('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò');

            // üî•„ÄêÊñ∞Â¢û„ÄëË∞ÉÊï¥ÂøÉÁéáÔºàÁî®Êà∑ÂèëËØ≠Èü≥Ê∂àÊÅØÔºâ
            adjustHeartrateForMessage(text, true);

            // Ê∑ªÂä†ËØ≠Èü≥Ê∂àÊÅØÂà∞ÁïåÈù¢
            addMessageWithAnimation(voiceMessage, currentChatCharacter.id);
            console.log('ËØ≠Èü≥Ê∂àÊÅØÂ∑≤Ê∑ªÂä†Âà∞ÁïåÈù¢');
            
            // üî•„ÄêÊñ∞Â¢û„ÄëËß¶ÂèëËßíËâ≤Áä∂ÊÄÅÊõ¥Êñ∞
            triggerStatusUpdateAfterMessage(currentChatCharacter.id);

            // ËÆæÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = voiceMessage;

            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
            
            console.log('ËØ≠Èü≥Ê∂àÊÅØÂèëÈÄÅÊµÅÁ®ãÂÆåÊàê');
        }

        // ÂàáÊç¢ËØ≠Èü≥ÊñáÊú¨ÊòæÁ§∫
        function toggleVoiceText(voiceElement) {
            const container = voiceElement.closest('.voice-message-container') || voiceElement.closest('.message-container');
            if (!container) return;

            const textContent = container.querySelector('.voice-text-content');
            if (!textContent) {
                // Â¶ÇÊûúÊ≤°ÊúâÊñáÊú¨ÂÆπÂô®ÔºåÂàõÂª∫‰∏Ä‰∏™
                const text = voiceElement.getAttribute('data-text');
                if (!text) return;

                const newTextContent = document.createElement('div');
                newTextContent.className = 'voice-text-content';
                newTextContent.textContent = text;
                
                // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÂÜ≥ÂÆöÊèíÂÖ•‰ΩçÁΩÆ
                if (container.classList.contains('voice-message-container')) {
                    container.appendChild(newTextContent);
                } else {
                    // ‰∏∫ÊóßÊ†ºÂºèÂàõÂª∫ËØ≠Èü≥ÂÆπÂô®
                    const voiceContainer = document.createElement('div');
                    voiceContainer.className = container.classList.contains('sent') ? 'voice-message-container sent' : 'voice-message-container received';
                    
                    // ÁßªÂä®Áé∞ÊúâÁöÑÊ∂àÊÅØÊ∞îÊ≥°Âà∞ËØ≠Èü≥ÂÆπÂô®‰∏≠
                    const bubble = container.querySelector('.message-bubble');
                    if (bubble) {
                        container.removeChild(bubble);
                        voiceContainer.appendChild(bubble);
                        voiceContainer.appendChild(newTextContent);
                        container.appendChild(voiceContainer);
                    }
                }
                
                // ÊòæÁ§∫ÊñáÊú¨
                setTimeout(() => {
                    newTextContent.classList.add('visible');
                }, 10);
                
                return;
            }

            // ÂàáÊç¢ÊñáÊú¨ÊòæÁ§∫/ÈöêËóè
            if (textContent.classList.contains('visible')) {
                textContent.classList.remove('visible');
                setTimeout(() => {
                    textContent.style.display = 'none';
                }, 300);
            } else {
                textContent.style.display = 'block';
                setTimeout(() => {
                    textContent.classList.add('visible');
                }, 10);
            }
        }
        
        // Âä†ËΩΩÂä®ÊÄÅ
        async function loadMoments() {
            try {
                    const momentsList = document.getElementById('moments-list');
                if (!momentsList) return;
                    
                        // Ê∏ÖÁ©∫Áé∞ÊúâÁöÑÂä®ÊÄÅ
                        momentsList.innerHTML = '';
                        
                // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÂä®ÊÄÅÊï∞ÊçÆ
                const momentsData = await db.moments.orderBy('timestamp').reverse().toArray();
                
                if (momentsData.length > 0) {
                    for (const momentData of momentsData) {
                        // Ëé∑ÂèñÁÇπËµûÊï∞
                        const likesCount = await db.momentLikes.where('momentId').equals(momentData.id).count();
                        
                        // Ëé∑ÂèñËØÑËÆ∫Êï∞
                        const commentsCount = await db.momentComments.where('momentId').equals(momentData.id).count();
                        
                        // Ëé∑ÂèñËØÑËÆ∫ÂàóË°®
                        const comments = await db.momentComments.where('momentId').equals(momentData.id).toArray();
                        comments.sort((a, b) => a.timestamp - b.timestamp); // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫è
                        
                            // üî•„Äê‰øÆÂ§ç„ÄëÈ™åËØÅÂπ∂Â§ÑÁêÜÂ§¥ÂÉè
                            let avatarToUse = null;
                            if (momentData.avatar && isValidAvatarUrl(momentData.avatar)) {
                                avatarToUse = momentData.avatar;
                            } else {
                                // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®awaitËé∑ÂèñÈªòËÆ§Â§¥ÂÉè
                                avatarToUse = await getDefaultAvatar();
                                // Â¶ÇÊûúÊï∞ÊçÆÂ∫ì‰∏≠Â≠òÂÇ®ÁöÑÂ§¥ÂÉèÊó†ÊïàÔºåÊõ¥Êñ∞Êï∞ÊçÆÂ∫ìËÆ∞ÂΩï
                                if (momentData.avatar && !isValidAvatarUrl(momentData.avatar)) {
                                    console.log(`Ê∏ÖÁêÜÂä®ÊÄÅ ${momentData.id} ÁöÑÊó†ÊïàÂ§¥ÂÉè`);
                                    try {
                                        await db.moments.update(momentData.id, { avatar: avatarToUse });
                                    } catch (error) {
                                        console.error('Êõ¥Êñ∞Âä®ÊÄÅÂ§¥ÂÉèÂ§±Ë¥•:', error);
                                    }
                                }
                            }
                        
                            const momentElement = createMomentElement({
                            id: momentData.id,
                                nickname: momentData.nickname,
                                avatar: avatarToUse,
                                text: momentData.text,
                                images: momentData.images || [],
                                time: momentData.time,
                            timestamp: momentData.timestamp,
                            likes: likesCount,
                            comments: comments
                            });
                            
                            // Ê∑ªÂä†Âà∞Âä®ÊÄÅÂàóË°®
                            momentsList.appendChild(momentElement);
                            
                            // Êõ¥Êñ∞ÁÇπËµûÊòæÁ§∫
                        updateMomentLikeDisplay(momentData.id);
                            
                            // ÊòæÁ§∫Â∑≤ÊúâËØÑËÆ∫
                        if (comments && comments.length > 0) {
                            comments.forEach(comment => {
                                // Á°Æ‰øùËØÑËÆ∫ÊúâtimeÂ≠óÊÆµÔºåÂ¶ÇÊûúÊ≤°ÊúâÂ∞±‰ªétimestampÁîüÊàê
                                if (!comment.time && comment.timestamp) {
                                    comment.time = formatTime(new Date(comment.timestamp));
                                }
                                displayCommentUnderMoment(momentData.id, comment);
                                });
                            }
                    }
                        
                        console.log('ÊàêÂäüÂä†ËΩΩ', momentsData.length, 'Êù°Âä®ÊÄÅ');
                } else {
                    console.log('Ê≤°ÊúâÊâæÂà∞‰øùÂ≠òÁöÑÂä®ÊÄÅÊï∞ÊçÆ');
                }
                
                // ÂêØÂä®Êó∂Èó¥Êõ¥Êñ∞
                startTimeUpdater();
            } catch (error) {
                console.error('Âä†ËΩΩÂä®ÊÄÅÂ§±Ë¥•:', error);
            }
        }
        
        // ÂèëÂ∏ÉÂä®ÊÄÅÁõ∏ÂÖ≥ÂèòÈáè
        let momentImages = [];
        
        // ÊòæÁ§∫ÂèëÂ∏ÉÂä®ÊÄÅÁïåÈù¢
        function showPublishMoment() {
            showApp('publish-moment-screen');
            // ÈáçÁΩÆË°®Âçï
            document.getElementById('moment-text').value = '';
            momentImages = [];
            updateMomentImagesGrid();
            
            // ÈáçÁΩÆÂèëÂ∏ÉÊåâÈíÆÁä∂ÊÄÅ
            const publishBtn = document.querySelector('.publish-btn');
            if (publishBtn) {
                publishBtn.disabled = false;
                publishBtn.textContent = 'ÂèëË°®';
            }
        }
        
        // ÈöêËóèÂèëÂ∏ÉÂä®ÊÄÅÁïåÈù¢
        function hidePublishMoment() {
            showApp('chat-screen');
                                    // ÂàáÊç¢ÂõûÂä®ÊÄÅÊ†áÁ≠æ
            switchChatTab('moments-page');
            // ‰∏çÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩÔºåÂä®ÊÄÅÂ∑≤ÁªèÂú®Êï∞ÊçÆÂ∫ì‰∏≠
        }
        
        // Ê∑ªÂä†ÂõæÁâáÂà∞Âä®ÊÄÅ
        function addMomentImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = function(event) {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    if (momentImages.length < 9) { // ÊúÄÂ§ö9Âº†ÂõæÁâá
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                // ÂéãÁº©ÂõæÁâá
                                const compressedImage = await compressImage(e.target.result, 800, 0.8);
                                momentImages.push(compressedImage);
                                updateMomentImagesGrid();
                            } catch (error) {
                                showToast("ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");                                console.error("ÂéãÁº©ÂõæÁâáÂ§±Ë¥•:", error);
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };
            input.click();
        }
        
        // Âà†Èô§ÂõæÁâá
        function removeMomentImage(index) {
            momentImages.splice(index, 1);
            updateMomentImagesGrid();
        }
        
        // Êõ¥Êñ∞ÂõæÁâáÁΩëÊ†ºÊòæÁ§∫
        function updateMomentImagesGrid() {
            const grid = document.getElementById('moment-images-grid');
            grid.innerHTML = '';
            
            momentImages.forEach((imageData, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'moment-image-item';
                imageItem.innerHTML = `
                    <img src="${imageData}" alt="Âä®ÊÄÅÂõæÁâá">
                    <button class="remove-image-btn" onclick="removeMomentImage(${index})">√ó</button>
                `;
                grid.appendChild(imageItem);
            });
        }
        
        // ÂèëÂ∏ÉÂä®ÊÄÅ
        
        // Ëé∑ÂèñÈªòËÆ§Â§¥ÂÉè - ‰øÆÂ§çÂºÇÊ≠•ÈóÆÈ¢ò
        async function getDefaultAvatar() {
            try {
                // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®awaitËé∑ÂèñÂä®ÊÄÅÂ§¥ÂÉèÔºåÁ°Æ‰øùÂºÇÊ≠•Êìç‰ΩúÊ≠£Á°ÆÂÆåÊàê
                const momentsAvatar = await getMomentsImage("avatarImage");
                if (momentsAvatar && isValidAvatarUrl(momentsAvatar)) {
                    console.log('‰ΩøÁî®Âä®ÊÄÅÈ°µÈù¢ËÆæÁΩÆÁöÑÂ§¥ÂÉè');
                    return momentsAvatar;
                }
                
                // Â∞ùËØïËé∑ÂèñÁî®Êà∑Â§¥ÂÉèÔºå‰ΩÜË¶ÅÈ™åËØÅÂÖ∂ÊúâÊïàÊÄß
                if (window.userAvatar && isValidAvatarUrl(window.userAvatar)) {
                    console.log('‰ΩøÁî®ÂÖ®Â±ÄÁî®Êà∑Â§¥ÂÉè');
                    return window.userAvatar;
                }
                
                // Ê∏ÖÁêÜÊó†ÊïàÁöÑÁî®Êà∑Â§¥ÂÉèÊï∞ÊçÆ
                if (window.userAvatar && !isValidAvatarUrl(window.userAvatar)) {
                    console.log('Ê∏ÖÁêÜÊó†ÊïàÁöÑÁî®Êà∑Â§¥ÂÉèÊï∞ÊçÆ');
                    window.userAvatar = null;
                }
                
                // Ê∏ÖÁêÜÊó†ÊïàÁöÑÂä®ÊÄÅÂ§¥ÂÉèÊï∞ÊçÆ
                if (momentsAvatar && !isValidAvatarUrl(momentsAvatar)) {
                    console.log('Ê∏ÖÁêÜÊó†ÊïàÁöÑÂä®ÊÄÅÂ§¥ÂÉèÊï∞ÊçÆ');
                    // ËøôÈáåÈúÄË¶ÅË∞ÉÁî®Ê∏ÖÁêÜÂáΩÊï∞Ôºå‰ΩÜÁî±‰∫égetMomentsImageÁöÑÂ≠òÂÇ®Êú∫Âà∂ÔºåÊàë‰ª¨ÂÖàË∑≥Ëøá
                }
                
                console.log('‰ΩøÁî®ÈªòËÆ§ÁîüÊàêÁöÑÂ§¥ÂÉè');
                // ËøîÂõûÈªòËÆ§Â§¥ÂÉèÔºà‰ΩøÁî®CSSÁîüÊàêÁöÑÁÆÄÂçïÂ§¥ÂÉèÔºâ
                return "data:image/svg+xml;base64," + btoa(`<svg width="50" height="50" xmlns="http://www.w3.org/2000/svg"><rect width="50" height="50" fill="#f0f0f0"/><circle cx="25" cy="20" r="8" fill="#999"/><circle cx="25" cy="40" r="12" fill="#999"/></svg>`);
            } catch (error) {
                console.error('Ëé∑ÂèñÈªòËÆ§Â§¥ÂÉèÂ§±Ë¥•:', error);
                return "data:image/svg+xml;base64," + btoa(`<svg width="50" height="50" xmlns="http://www.w3.org/2000/svg"><rect width="50" height="50" fill="#f0f0f0"/><circle cx="25" cy="20" r="8" fill="#999"/><circle cx="25" cy="40" r="12" fill="#999"/></svg>`);
            }
        }        async function publishMoment() {
            const text = document.getElementById('moment-text').value.trim();
            const publishBtn = document.querySelector('.publish-btn');
            
            if (!text && momentImages.length === 0) {
                showToast('ËØ∑ËæìÂÖ•ÊñáÂ≠óÊàñÈÄâÊã©ÂõæÁâá');
                return;
            }
            
            // Á¶ÅÁî®ÂèëÂ∏ÉÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§
            publishBtn.disabled = true;
            publishBtn.textContent = 'ÂèëÂ∏É‰∏≠...';
            
            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÊòµÁß∞
            const nickname = document.getElementById('moments-username')?.textContent || 'Êàë';
            
            // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®awaitËé∑ÂèñÁî®Êà∑Â§¥ÂÉè
            const userAvatar = await getDefaultAvatar();
            
            // ÂàõÂª∫Êñ∞Âä®ÊÄÅ
            const now = new Date();
            const newMoment = {
                id: Date.now(),
                authorId: 'user',
                nickname: nickname,
                avatar: userAvatar,
                text: text,
                images: [...momentImages],
                time: formatTime(now),
                timestamp: now.getTime()
            };
            
            try {
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await db.moments.add(newMoment);
                
                // ÊÅ¢Â§çÂèëÂ∏ÉÊåâÈíÆÁä∂ÊÄÅ
                publishBtn.disabled = false;
                publishBtn.textContent = 'ÂèëË°®';
                
                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                showToast('ÂèëÂ∏ÉÊàêÂäüÔºÅ');
                
                // Ê∏ÖÁ©∫Ë°®Âçï
                document.getElementById('moment-text').value = '';
                momentImages = [];
                updateMomentImagesGrid();
                
                // ËøîÂõûÂä®ÊÄÅÈ°µÈù¢
                    hidePublishMoment();
                
                // Áõ¥Êé•Ê∑ªÂä†Âà∞Âä®ÊÄÅÂàóË°®ÔºàÈÅøÂÖçÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™ÂàóË°®Ôºâ
                addMomentToList(newMoment);
                
                // ÂêØÂä®Êó∂Èó¥Êõ¥Êñ∞Âô®
                startTimeUpdater();
                
                // Âª∂ËøüËß¶ÂèëAIËßíËâ≤ÁöÑ‰∫íÂä®
                setTimeout(() => {
                    triggerAIInteractions(newMoment.id, 'like');
                }, 1000);
                setTimeout(() => {
                    triggerAIInteractions(newMoment.id, 'comment');
                }, 3000);
                
            } catch (error) {
                console.error('ÂèëÂ∏ÉÂä®ÊÄÅÂ§±Ë¥•:', error);
                showToast('ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                
                // ÊÅ¢Â§çÂèëÂ∏ÉÊåâÈíÆ
                publishBtn.disabled = false;
                publishBtn.textContent = 'ÂèëË°®';
            }
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // Â∞è‰∫é1ÂàÜÈíü
                return 'ÂàöÂàö';
            } else if (diff < 3600000) { // Â∞è‰∫é1Â∞èÊó∂
                return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
            } else if (diff < 86400000) { // Â∞è‰∫é1Â§©
                return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
            } else if (diff < 604800000) { // Â∞è‰∫é1Âë®
                return Math.floor(diff / 86400000) + 'Â§©Ââç';
            } else {
                return date.toLocaleDateString();
            }
        }
        
        // Ê∑ªÂä†Âä®ÊÄÅÂà∞ÂàóË°®
        function addMomentToList(moment) {
            const momentsList = document.getElementById('moments-list');
            const momentElement = createMomentElement(moment);
            
            // ÊèíÂÖ•Âà∞ÂàóË°®ÊúÄÂâçÈù¢
            if (momentsList.firstChild) {
                momentsList.insertBefore(momentElement, momentsList.firstChild);
            } else {
                momentsList.appendChild(momentElement);
            }
        }
        
        // ÂàõÂª∫Âä®ÊÄÅÂÖÉÁ¥†
        function createMomentElement(moment) {
            const momentDiv = document.createElement('div');
            momentDiv.className = 'moment-item';
            
            // ËÆæÁΩÆÂä®ÊÄÅIDÂíåÊó∂Èó¥Êà≥
            momentDiv.setAttribute('data-moment-id', moment.id);
            if (moment.timestamp) {
                momentDiv.setAttribute('data-timestamp', moment.timestamp);
            }
            
            let imagesHtml = '';
            if (moment.images && moment.images.length > 0) {
                imagesHtml = `
                    <div class="moment-images">
                        ${moment.images.map(img => `<img src="${img}" alt="Âä®ÊÄÅÂõæÁâá" onclick="previewImage('${img}')">`).join('')}
                    </div>
                `;
            }
            // üî•„Äê‰øÆÂ§ç„ÄëÊ≠£Á°ÆËé∑ÂèñËßíËâ≤Â§¥ÂÉè
            let finalAvatar = null;
            if (moment.authorId === 'user') {
                // Áî®Êà∑Âä®ÊÄÅÔºöÁõ¥Êé•‰ΩøÁî®‰øùÂ≠òÁöÑÂ§¥ÂÉèÔºàÂ∑≤Âú®ÂèëÂ∏ÉÊó∂Ê≠£Á°ÆËÆæÁΩÆÔºâ
                finalAvatar = moment.avatar;
            } else {
                // ËßíËâ≤Âä®ÊÄÅÔºö‰ºòÂÖàÂä®ÊÄÅÂ§¥ÂÉèÔºåÁÑ∂ÂêéËßíËâ≤Âç°Â§¥ÂÉè
                finalAvatar = moment.avatar;
                if (!finalAvatar && moment.characterId) {
                    const character = characters.find(c => c.id === moment.characterId);
                    if (character && character.avatarUrl) {
                        finalAvatar = character.avatarUrl;
                    }
                }
            }
            
            momentDiv.innerHTML = `
                <div class="moment-avatar">
                    ${finalAvatar ? 
                        `<img src="${finalAvatar}" alt="Â§¥ÂÉè" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'width: 40px; height: 40px; background-color: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px;\\'>${moment.nickname ? moment.nickname.charAt(0) : '?'}</div>'">` :
                        `<div style="width: 40px; height: 40px; background-color: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px;">${moment.nickname ? moment.nickname.charAt(0) : '?'}</div>`
                    }
                </div>
                <div class="moment-content">
                    <div class="moment-username">${moment.nickname}</div>
                    <div class="moment-text">${formatMomentText(moment.text)}</div>
                    ${imagesHtml}
                    <div class="moment-time-actions" style="margin-top: 8px; padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div class="moment-time">${moment.time}</div>
                        <div class="moment-actions" style="display: flex;">
                        <button class="moment-action-btn" onclick="toggleMomentLike('${moment.id}')" style="margin-right: 8px;">
                            <i class="far fa-heart"></i>
                            <span>${moment.likes || 0}</span>
                        </button>
                        <button class="moment-action-btn" onclick="showMomentComments('${moment.id}')">
                            <i class="far fa-comment"></i>
                            <span>${moment.comments ? moment.comments.length : 0}</span>
                        </button>
                    </div>
                    </div>
                    <div class="moment-footer" style="display: none;">
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®
            addLongPressListener(momentDiv, moment.id);
            
            // ÂºÇÊ≠•Ê£ÄÊü•Âπ∂ËÆæÁΩÆÁî®Êà∑ÁÇπËµûÁä∂ÊÄÅ
            (async () => {
                try {
                    const userLike = await db.momentLikes
                        .where('[momentId+authorId]')
                        .equals([moment.id, 'user'])
                        .first();
                    
                    if (userLike) {
                    const likeBtn = momentDiv.querySelector('.moment-action-btn');
                    const likeIcon = likeBtn.querySelector('i');
                    likeIcon.classList.remove('far');
                    likeIcon.classList.add('fas');
                    likeBtn.classList.add('liked');
                }
                } catch (error) {
                    console.error('Ê£ÄÊü•Áî®Êà∑ÁÇπËµûÁä∂ÊÄÅÂ§±Ë¥•:', error);
            }
            })();
            
            return momentDiv;
        }
        
        // È¢ÑËßàÂõæÁâá
        function previewImage(imageSrc) {
            // ÂàõÂª∫È¢ÑËßàÈÅÆÁΩ©
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            overlay.appendChild(img);
            overlay.onclick = () => document.body.removeChild(overlay);
            document.body.appendChild(overlay);
        }
        
        // Ê≥®ÊÑèÔºösaveMomentsDataÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®DexieÊï∞ÊçÆÂ∫ìÁõ¥Êé•Â≠òÂÇ®
        // Êõ¥Êñ∞ÊñáÂ≠óËÆ°Êï∞
        function updateTextCount() {
            const textarea = document.getElementById('moment-text');
            const countElement = document.getElementById('text-count');
            
            if (textarea && countElement) {
                const currentLength = textarea.value.length;
                const maxLength = 500;
                
                countElement.textContent = `${currentLength}/${maxLength}`;
                
                // ÂΩìÊé•ËøëÈôêÂà∂Êó∂ÊîπÂèòÈ¢úËâ≤
                if (currentLength > maxLength * 0.9) {
                    countElement.style.color = '#ff6b6b';
                } else if (currentLength > maxLength * 0.8) {
                    countElement.style.color = '#ffa500';
                } else {
                    countElement.style.color = '#999';
                }
            }
        }
        
        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 10000;
                font-size: 14px;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }
        
        // Êó∂Èó¥Êõ¥Êñ∞Âô®
        let timeUpdateInterval = null;
        
        function startTimeUpdater() {
            // Ê∏ÖÈô§Â∑≤Â≠òÂú®ÁöÑÂÆöÊó∂Âô®
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
            }
            
            // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°
            updateMomentTimes();
            
            // ÊØèÂàÜÈíüÊõ¥Êñ∞‰∏ÄÊ¨°Êó∂Èó¥ÊòæÁ§∫
            timeUpdateInterval = setInterval(updateMomentTimes, 60000);
        }
        
        function stopTimeUpdater() {
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
                timeUpdateInterval = null;
            }
        }
        
        function updateMomentTimes() {
            try {
                const momentItems = document.querySelectorAll('.moment-item[data-timestamp]');
                
                momentItems.forEach(item => {
                    const timestamp = parseInt(item.getAttribute('data-timestamp'));
                    if (timestamp) {
                        const timeElement = item.querySelector('.moment-time');
                        if (timeElement) {
                            const newTime = formatTime(new Date(timestamp));
                            timeElement.textContent = newTime;
                        }
                    }
                });
            } catch (error) {
                console.error('Êõ¥Êñ∞Âä®ÊÄÅÊó∂Èó¥Â§±Ë¥•:', error);
            }
        }
        
        // Âä®ÊÄÅÈÄâÊã©Ê®°ÂºèÁõ∏ÂÖ≥ÂèòÈáè
        let isSelectionMode = false;
        let selectedMoments = new Set();
        
        // ÂàáÊç¢Âä®ÊÄÅÁÇπËµûÁä∂ÊÄÅ
        async function toggleMomentLike(momentId) {
            if (isSelectionMode) return; // ÈÄâÊã©Ê®°Âºè‰∏ã‰∏çÂìçÂ∫îÁÇπËµû
            
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            const likeBtn = momentElement.querySelector('.moment-action-btn');
            const likeIcon = likeBtn.querySelector('i');
            
            try {
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁÇπËµû
                const existingLike = await db.momentLikes
                    .where('[momentId+authorId]')
                    .equals([parseInt(momentId), 'user'])
                    .first();
            
                if (existingLike) {
                // ÂèñÊ∂àÁÇπËµû
                likeIcon.classList.remove('fas');
                likeIcon.classList.add('far');
                likeBtn.classList.remove('liked');
                    await db.momentLikes.delete([parseInt(momentId), 'user']);
            } else {
                // ÁÇπËµû
                likeIcon.classList.add('fas');
                likeIcon.classList.remove('far');
                likeBtn.classList.add('liked');
                    await db.momentLikes.add({
                        momentId: parseInt(momentId),
                        authorId: 'user',
                    characterId: 'user',
                    name: document.getElementById('moments-username')?.textContent || 'Êàë',
                    timestamp: Date.now()
                });
                
                // Ëß¶ÂèëAIËßíËâ≤Ëá™Âä®ÁÇπËµû
                triggerAIInteractions(momentId, 'like');
            }
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateMomentLikeDisplay(momentId);
            } catch (error) {
                console.error('ÁÇπËµûÊìç‰ΩúÂ§±Ë¥•:', error);
            }
        }
        
        // ÊòæÁ§∫Âä®ÊÄÅËØÑËÆ∫
        function showMomentComments(momentId) {
            if (isSelectionMode) return; // ÈÄâÊã©Ê®°Âºè‰∏ã‰∏çÂìçÂ∫îËØÑËÆ∫
            
            // ÊòæÁ§∫ÁÆÄÂçïËØÑËÆ∫ËæìÂÖ•Ê°Ü
            showSimpleCommentInput(momentId);
            
            // Ëß¶ÂèëAIËßíËâ≤Ëá™Âä®ËØÑËÆ∫
            triggerAIInteractions(momentId, 'comment');
        }
        
        // ÊòæÁ§∫ÁÆÄÂçïËØÑËÆ∫ËæìÂÖ•Ê°Ü
        function showSimpleCommentInput(momentId, replyToNickname = null) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâËæìÂÖ•Ê°Ü
            if (document.querySelector('.simple-comment-input')) {
                closeSimpleCommentInput();
            }
            
            const placeholder = replyToNickname ? `ÂõûÂ§ç ${replyToNickname}...` : 'ÂÜôËØÑËÆ∫...';
            
            const input = document.createElement('div');
            input.className = 'simple-comment-input';
            input.innerHTML = `
                <div class="comment-input-container">
                    <input type="text" placeholder="${placeholder}" maxlength="200" id="simple-comment-${momentId}" data-reply-to="${replyToNickname || ''}">
                    <button onclick="submitSimpleComment('${momentId}')">ÂèëÈÄÅ</button>
                    <button onclick="closeSimpleCommentInput()" class="cancel-btn">ÂèñÊ∂à</button>
                </div>
            `;
            
            input.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #ddd;
                padding: 12px;
                z-index: 1000;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                max-width: 360px;
                margin: 0 auto;
            `;
            
            const container = input.querySelector('.comment-input-container');
            container.style.cssText = `
                display: flex;
                gap: 8px;
                align-items: center;
                max-width: 360px;
                margin: 0 auto;
            `;
            
            const textInput = input.querySelector('input');
            textInput.style.cssText = `
                flex: 1;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 20px;
                font-size: 14px;
            `;
            
            const sendBtn = input.querySelector('button');
            sendBtn.style.cssText = `
                background: #1da1f2;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 16px;
                font-size: 14px;
                cursor: pointer;
            `;
            
            const cancelBtn = input.querySelector('.cancel-btn');
            cancelBtn.style.cssText = `
                background: #f0f0f0;
                color: #666;
                border: none;
                padding: 8px 16px;
                border-radius: 16px;
                font-size: 14px;
                cursor: pointer;
            `;
            
            document.body.appendChild(input);
            
            // Ëá™Âä®ËÅöÁÑ¶
            setTimeout(() => textInput.focus(), 100);
            
            // ÂõûËΩ¶ÂèëÈÄÅ
            textInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitSimpleComment(momentId);
                }
            });
        }
        
        // ÂÖ≥Èó≠ÁÆÄÂçïËØÑËÆ∫ËæìÂÖ•Ê°Ü
        function closeSimpleCommentInput() {
            const input = document.querySelector('.simple-comment-input');
            if (input) {
                document.body.removeChild(input);
            }
        }
        
        // Êèê‰∫§ÁÆÄÂçïËØÑËÆ∫
        async function submitSimpleComment(momentId) {
            const input = document.getElementById(`simple-comment-${momentId}`);
            const text = input.value.trim();
            const replyTo = input.getAttribute('data-reply-to');
            
            if (!text) {
                showToast('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ');
                return;
            }
            
            // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®awaitËé∑ÂèñÁî®Êà∑Â§¥ÂÉè
            const userAvatar = await getDefaultAvatar();
            
            const comment = {
                id: Date.now() + Math.random(),
                nickname: document.getElementById('moments-username')?.textContent || 'Êàë',
                avatar: userAvatar,
                text: text,
                time: formatTime(new Date()),
                timestamp: Date.now(),
                replyTo: replyTo || null
            };
            
            // ‰øùÂ≠òËØÑËÆ∫Âà∞Âä®ÊÄÅÊï∞ÊçÆ
            saveCommentToMoment(momentId, comment);
            
            // Êõ¥Êñ∞Âä®ÊÄÅÂàóË°®‰∏≠ÁöÑËØÑËÆ∫Êï∞
            updateMomentCommentCount(momentId);
            
            // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫Êñ∞ËØÑËÆ∫
            displayCommentUnderMoment(momentId, comment);
            
            // ÂÖ≥Èó≠ËæìÂÖ•Ê°Ü
            closeSimpleCommentInput();
            
            showToast('ËØÑËÆ∫ÊàêÂäüÔºÅ');
            
            // Â¶ÇÊûúÁî®Êà∑ÂõûÂ§ç‰∫ÜÊüê‰∏™AIËßíËâ≤ÔºåÊ£ÄÊü•ËΩÆÊ¨°Âπ∂Ëß¶ÂèëËØ•ËßíËâ≤ÁöÑÂõûÂ§ç
            if (replyTo && replyTo !== 'Êàë') {
                const conversationKey = `${momentId}-${replyTo}`;
                const currentRounds = commentConversationRounds.get(conversationKey) || 0;
                
                if (currentRounds < 10) {
                    console.log(`Áî®Êà∑ÂõûÂ§ç‰∫Ü ${replyTo}ÔºåÂΩìÂâçÂØπËØùËΩÆÊ¨°: ${currentRounds}/10ÔºåÂ∞ÜÂú®2-5ÁßíÂêéËß¶ÂèëAIÂõûÂ§ç`);
                    
                    // Áî®Êà∑ÂõûÂ§çÊó∂‰πüË¶ÅÂ¢ûÂä†ËΩÆÊ¨°
                    commentConversationRounds.set(conversationKey, currentRounds + 1);
                    console.log(`Áî®Êà∑ÂõûÂ§çÂêéÔºå${replyTo} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùËΩÆÊ¨°Êõ¥Êñ∞‰∏∫: ${currentRounds + 1}/10`);
                    
                setTimeout(() => {
                    console.log(`ÂºÄÂßãËß¶Âèë ${replyTo} ÂõûÂ§çÁî®Êà∑ËØÑËÆ∫: "${text}"`);
                    triggerAIReplyToUser(momentId, replyTo, text);
                }, Math.random() * 3000 + 2000); // 2-5ÁßíÂêéAIÂõûÂ§ç
                } else {
                    console.log(`${replyTo} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùÂ∑≤ËææÂà∞10ËΩÆ‰∏äÈôêÔºå‰∏çÂÜçÂõûÂ§ç`);
                }
            } else {
                console.log(`Áî®Êà∑ÂèëË°®‰∫ÜËØÑËÆ∫ÔºåreplyTo: ${replyTo}`);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂØπËßíËâ≤Âä®ÊÄÅÁöÑÁõ¥Êé•ËØÑËÆ∫Ôºà‰∏çÊòØÂõûÂ§çÔºâ
                if (!replyTo) {
                    checkAndTriggerCharacterMomentReply(momentId, text);
                }
            }
        }
        
        // Ê£ÄÊü•Âπ∂Ëß¶ÂèëËßíËâ≤Âä®ÊÄÅÁöÑÂõûÂ§ç
        async function checkAndTriggerCharacterMomentReply(momentId, userCommentText) {
            try {
                // Ëé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ
                const moment = await db.moments.get(parseInt(momentId));
                if (!moment || !moment.characterId || moment.characterId === 'user') {
                    console.log('‰∏çÊòØËßíËâ≤ÂèëÂ∏ÉÁöÑÂä®ÊÄÅÔºåË∑≥ËøáËßíËâ≤ÂõûÂ§ç');
                    return;
                }
                
                // Ëé∑ÂèñÂèëÂ∏ÉÂä®ÊÄÅÁöÑËßíËâ≤
                const character = characters.find(c => c.id === moment.characterId);
                if (!character) {
                    console.log(`Êú™ÊâæÂà∞Âä®ÊÄÅÂèëÂ∏ÉËÄÖËßíËâ≤: ${moment.characterId}`);
                    return;
                }
                
                // Ê£ÄÊü•ÂØπËØùËΩÆÊ¨°
                const conversationKey = `${momentId}-${character.name}`;
                const currentRounds = commentConversationRounds.get(conversationKey) || 0;
                
                if (currentRounds >= 10) {
                    console.log(`${character.name} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùÂ∑≤ËææÂà∞10ËΩÆ‰∏äÈôêÔºå‰∏çÂÜçÂõûÂ§ç`);
                    return;
                }
                
                console.log(`Áî®Êà∑ËØÑËÆ∫‰∫Ü ${character.name} ÁöÑÂä®ÊÄÅÔºåÂΩìÂâçÂØπËØùËΩÆÊ¨°: ${currentRounds}/10ÔºåÂ∞ÜÂú®2-5ÁßíÂêéËß¶ÂèëÂõûÂ§ç`);
                
                // Â¢ûÂä†ÂØπËØùËΩÆÊ¨°
                commentConversationRounds.set(conversationKey, currentRounds + 1);
                console.log(`Áî®Êà∑ËØÑËÆ∫ÂêéÔºå${character.name} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùËΩÆÊ¨°Êõ¥Êñ∞‰∏∫: ${currentRounds + 1}/10`);
                
                // Âª∂ËøüÂõûÂ§ç
                setTimeout(() => {
                    console.log(`ÂºÄÂßãËß¶Âèë ${character.name} ÂõûÂ§çÁî®Êà∑ÂØπÂÖ∂Âä®ÊÄÅÁöÑËØÑËÆ∫: "${userCommentText}"`);
                    triggerAIReplyToUser(momentId, character.name, userCommentText);
                }, Math.random() * 3000 + 2000); // 2-5ÁßíÂêéAIÂõûÂ§ç
                
            } catch (error) {
                console.error('Ê£ÄÊü•ËßíËâ≤Âä®ÊÄÅÂõûÂ§çÂ§±Ë¥•:', error);
            }
        }
        
        // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫ËØÑËÆ∫
        function displayCommentUnderMoment(momentId, comment) {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            // Êü•ÊâæÊàñÂàõÂª∫ËØÑËÆ∫Âå∫Âüü
            let commentsSection = momentElement.querySelector('.moment-comments-section');
            if (!commentsSection) {
                commentsSection = document.createElement('div');
                commentsSection.className = 'moment-comments-section';
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÁÇπËµûÂå∫ÂüüÔºåÂÜ≥ÂÆömargin-top
                const likesDisplay = momentElement.querySelector('.likes-display');
                const marginTop = likesDisplay ? '0' : '0';
                
                commentsSection.style.cssText = `
                    margin-top: ${marginTop};
                    padding: 8px 12px;
                    background: #f8f9fa;
                    font-size: 13px;
                `;
                
                // ÊèíÂÖ•Âà∞Ê≠£Á°Æ‰ΩçÁΩÆÔºöÁÇπËµûÂå∫ÂêéÈù¢ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâÔºåÂê¶ÂàôÂú®Êó∂Èó¥Êìç‰ΩúÂå∫ÂêéÈù¢
                const momentContent = momentElement.querySelector('.moment-content');
                const momentTimeActions = momentElement.querySelector('.moment-time-actions');
                
                if (momentContent && momentTimeActions) {
                if (likesDisplay) {
                        // Â¶ÇÊûúÊúâÁÇπËµûÂå∫ÔºåÊèíÂÖ•Âà∞ÁÇπËµûÂå∫ÂêéÈù¢
                    likesDisplay.parentNode.insertBefore(commentsSection, likesDisplay.nextSibling);
                    } else {
                        // Ê≤°ÊúâÁÇπËµûÂå∫ÔºåÊèíÂÖ•Âà∞Êó∂Èó¥Êìç‰ΩúÂå∫ÂêéÈù¢
                    momentTimeActions.parentNode.insertBefore(commentsSection, momentTimeActions.nextSibling);
                    }
                }
            }
            
            // ÂàõÂª∫ËØÑËÆ∫ÂÖÉÁ¥†
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-item';
            commentDiv.style.cssText = `
                display: flex;
                gap: 8px;
                margin-bottom: 8px;
                align-items: flex-start;
            `;
            
            // Â§ÑÁêÜÂõûÂ§çÊ†ºÂºè
            let commentText = comment.text;
            if (comment.replyTo) {
                commentText = `ÂõûÂ§ç<span style="margin: 0 2px; color: #576b95; font-weight: 600;">${comment.replyTo}</span>: ${comment.text}`;
            }
            
            commentDiv.innerHTML = `
                <img src="${comment.avatar}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
                <div style="flex: 1; line-height: 1.4; cursor: pointer;" onclick="replyToMomentComment('${momentId}', '${comment.nickname}')">
                    <span style="color: #576b95; font-weight: 600;">${comment.nickname}${comment.replyTo ? '' : 'Ôºö'}</span><span style="margin-left: 2px; color: #333;">${commentText}</span>
                    <div style="color: #999; font-size: 11px; margin-top: 2px;">${comment.time}</div>
                </div>
            `;
            
            commentsSection.appendChild(commentDiv);
        }
        
        // ÂõûÂ§çÂä®ÊÄÅËØÑËÆ∫
        function replyToMomentComment(momentId, nickname) {
            // ÊòæÁ§∫ËØÑËÆ∫ËæìÂÖ•Ê°ÜÔºåÂπ∂ËÆæÁΩÆ‰∏∫ÂõûÂ§çÊ®°Âºè
            showSimpleCommentInput(momentId, nickname);
        }
        

        
        // ‰øùÂ≠òËØÑËÆ∫Âà∞Âä®ÊÄÅÊï∞ÊçÆ
        async function saveCommentToMoment(momentId, comment) {
            try {
                const commentData = {
                    id: comment.id,
                    momentId: parseInt(momentId),
                    authorId: comment.characterId || 'user',
                    nickname: comment.nickname,
                    avatar: comment.avatar,
                    text: comment.text,
                    timestamp: comment.timestamp,
                    replyTo: comment.replyTo || null
                };
                
                await db.momentComments.add(commentData);
                console.log('ËØÑËÆ∫Â∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÂä®ÊÄÅID:', momentId);
            } catch (error) {
                console.error('‰øùÂ≠òËØÑËÆ∫Â§±Ë¥•:', error);
            }
        }
        
        // Êõ¥Êñ∞Âä®ÊÄÅËØÑËÆ∫Êï∞
        async function updateMomentCommentCount(momentId) {
            try {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
                const commentsCount = await db.momentComments.where('momentId').equals(parseInt(momentId)).count();
            
                const commentBtn = momentElement.querySelectorAll('.moment-action-btn')[1];
                const commentCount = commentBtn.querySelector('span');
                commentCount.textContent = commentsCount;
            } catch (error) {
                console.error('Êõ¥Êñ∞ËØÑËÆ∫Êï∞Â§±Ë¥•:', error);
            }
        }
        
        // Ëß¶ÂèëAIËßíËâ≤‰∫íÂä®
        async function triggerAIInteractions(momentId, type) {
            try {
            if (!characters || characters.length === 0) return;
            
            // Ëé∑ÂèñÂΩìÂâçÂä®ÊÄÅ‰ø°ÊÅØ
                const moment = await db.moments.get(parseInt(momentId));
            if (!moment) return;
            
                const publisherCharacterId = moment.characterId;
                
                // Â¶ÇÊûúÊòØÁî®Êà∑ÂèëÁöÑÂä®ÊÄÅ
                if (!publisherCharacterId || publisherCharacterId === 'user') {
                    console.log('Áî®Êà∑ÂèëÂ∏ÉÂä®ÊÄÅÔºåÊâÄÊúâËßíËâ≤80%Ê¶ÇÁéá‰∫íÂä®');
                    // Áî®Êà∑ÂèëÂä®ÊÄÅÔºöÊâÄÊúâËÅîÁ≥ª‰∫∫ËßíËâ≤ÈÉΩÊúâ80%Ê¶ÇÁéá‰∫íÂä®
            const contactCharacters = characters.filter(char => contacts.includes(char.id));
            
            if (type === 'like') {
                for (const character of contactCharacters) {
                    if (Math.random() < 0.8) {
                                setTimeout(() => {
                                    addAILike(momentId, character, moment);
                                }, Math.random() * 3000 + 1000);
                    }
                }
            } else if (type === 'comment') {
                for (const character of contactCharacters) {
                    if (Math.random() < 0.8) {
                            setTimeout(async () => {
                                await addAIComment(momentId, character, moment);
                                }, Math.random() * 5000 + 2000);
                    }
                }
                    }
                } else {
                    console.log('ËßíËâ≤ÂèëÂ∏ÉÂä®ÊÄÅÔºåÂêå‰∏ÄÂàÜÁªÑ‰∏ãËßíËâ≤60%Ê¶ÇÁéá‰∫íÂä®');
                    // ËßíËâ≤ÂèëÂä®ÊÄÅÔºö‰ΩøÁî®ÂàÜÁªÑÂÖ≥Á≥ªËÄå‰∏çÊòØÁæ§ËÅäÂÖ≥Á≥ª
                    const publisherCharacter = characters.find(c => c.id === publisherCharacterId);
                    
                    // Ëé∑Âèñ‰∏éÂèëÂ∏ÉËÄÖÂú®Âêå‰∏ÄÂàÜÁªÑÁöÑËßíËâ≤
                    const sameGroupCharacters = characters.filter(c => 
                        c.id !== publisherCharacterId && c.groupId === publisherCharacter.groupId
                    );
                
                    if (type === 'like') {
                        for (const character of sameGroupCharacters) {
                            if (Math.random() < 0.4) { // 40%Ê¶ÇÁéá‰∫íÂä®Ôºå‰øùÊåÅÂéüÊúâÁöÑËÆæÁΩÆÊ¶ÇÁéá
                    setTimeout(() => {
                                    addAILike(momentId, character, moment);
                                }, Math.random() * 3000 + 1000);
                            }
                        }
                    } else if (type === 'comment') {
                        for (const character of sameGroupCharacters) {
                            if (Math.random() < 0.4) { // 40%Ê¶ÇÁéá‰∫íÂä®Ôºå‰øùÊåÅÂéüÊúâÁöÑËÆæÁΩÆÊ¶ÇÁéá
                                setTimeout(async () => {
                                    await addAIComment(momentId, character, moment);
                                }, Math.random() * 5000 + 2000);
                            }
                        }
                        
                        // Ëß¶ÂèëÂêåÂàÜÁªÑËßíËâ≤Èó¥ÁöÑ40%Ê¶ÇÁéá‰∫íÂä®  
                        setTimeout(() => {
                            // Â∞ÜÂèëÂ∏ÉËÄÖËßíËâ≤‰πüÂä†ÂÖ•Âà∞‰∫íÂä®ËßíËâ≤ÂàóË°®‰∏≠
                            const allInteractionCharacters = [...sameGroupCharacters];
                            if (publisherCharacter) {
                                allInteractionCharacters.push(publisherCharacter);
                            }
                            triggerAiToAiInteraction(momentId, allInteractionCharacters);
                        }, Math.random() * 8000 + 5000);
                    }
                }
            } catch (error) {
                console.error('Ëß¶ÂèëAI‰∫íÂä®Â§±Ë¥•:', error);
            }
        }
        
        // Ëé∑Âèñ‰∏éÊåáÂÆöËßíËâ≤Âú®Âêå‰∏Ä‰∏™Áæ§ËÅäÁöÑÂÖ∂‰ªñËßíËâ≤
        function getCharactersInSameGroups(characterId) {
            const sameGroupCharacters = [];
            
            // ÈÅçÂéÜÊâÄÊúâÁæ§ËÅä
            groupChats.forEach(group => {
                if (group.members && group.members.includes(characterId)) {
                    // ÊâæÂà∞ÂåÖÂê´ËØ•ËßíËâ≤ÁöÑÁæ§ËÅäÔºåËé∑ÂèñÁæ§ÂÜÖÂÖ∂‰ªñËßíËâ≤
                    group.members.forEach(memberId => {
                        if (memberId !== characterId && memberId !== 'user') {
                            const character = characters.find(c => c.id === memberId);
                            if (character && !sameGroupCharacters.find(c => c.id === character.id)) {
                                sameGroupCharacters.push(character);
                            }
                        }
                    });
                }
            });
            
            return sameGroupCharacters;
        }
        
        // AIËßíËâ≤ÁÇπËµû
        async function addAILike(momentId, character, moment) {
            try {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÁÇπËµûËøá
                const existingLike = await db.momentLikes
                    .where('[momentId+authorId]')
                    .equals([parseInt(momentId), character.id])
                    .first();
                
                if (existingLike) return;
            
                // Âü∫‰∫éËßíËâ≤‰∫∫ËÆæÂÜ≥ÂÆöÊòØÂê¶ÁúüÁöÑÁÇπËµû
                const shouldLike = await shouldCharacterLikeMoment(character, moment);
                if (!shouldLike) {
                    console.log(`${character.name} Âü∫‰∫é‰∫∫ËÆæÈÄâÊã©‰∏çÁÇπËµûËøôÊù°Âä®ÊÄÅ`);
                    return;
                }
            
            // Ê∑ªÂä†ÁÇπËµûËÆ∞ÂΩï
                await db.momentLikes.add({
                    momentId: parseInt(momentId),
                    authorId: character.id,
                characterId: character.id,
                name: character.name,
                timestamp: Date.now()
            });
            
            // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
            updateMomentLikeDisplay(momentId);
            
            // ÊòæÁ§∫ÁÇπËµûÊèêÁ§∫
            showToast(`${character.name} Ëµû‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`);
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂ¶ÇÊûúÊòØÁÇπËµûÁî®Êà∑ÁöÑÂä®ÊÄÅÔºåÂàõÂª∫Êé®ÈÄÅÈÄöÁü•
            if (moment.authorId === 'user') {
                createPushNotification(character, `Ëµû‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`, 100);
            }
            } catch (error) {
                console.error('AIÁÇπËµûÂ§±Ë¥•:', error);
            }
        }
        
        // Âà§Êñ≠ËßíËâ≤ÊòØÂê¶‰ºöÁÇπËµûËøôÊù°Âä®ÊÄÅ
        async function shouldCharacterLikeMoment(character, moment) {
            try {
                // Âü∫‰∫éËßíËâ≤‰∫∫ËÆæÂíåÂä®ÊÄÅÂÜÖÂÆπÁöÑÁÆÄÂçïÂà§Êñ≠
                const characterBio = (character.bio || '').toLowerCase();
                const momentText = (moment.text || '').toLowerCase();
                
                // Â¶ÇÊûúËßíËâ≤‰∫∫ËÆæ‰∏≠ÂåÖÂê´Ë¥üÈù¢ËØçÊ±áÔºåÈôç‰ΩéÁÇπËµûÊ¶ÇÁéá
                const negativeTraits = ['ÂÜ∑Êº†', '‰∏•ËÇÉ', '‰∏çÂñÑ‰∫§ÈôÖ', 'ÂÜÖÂêë', 'Ê≤âÈªò'];
                const hasNegativeTraits = negativeTraits.some(trait => characterBio.includes(trait));
                
                if (hasNegativeTraits && Math.random() < 0.7) {
                    return false; // 70%Ê¶ÇÁéá‰∏çÁÇπËµû
                }
                
                // Â¶ÇÊûúÂä®ÊÄÅÂÜÖÂÆπ‰∏éËßíËâ≤ÂÖ¥Ë∂£Áõ∏ÂÖ≥ÔºåÂ¢ûÂä†ÁÇπËµûÊ¶ÇÁéá
                const characterInterests = extractInterestsFromBio(characterBio);
                const hasRelatedContent = characterInterests.some(interest => 
                    momentText.includes(interest)
                );
                
                if (hasRelatedContent) {
                    return Math.random() < 0.9; // 90%Ê¶ÇÁéáÁÇπËµû
                }
                
                // ÈªòËÆ§ÊÉÖÂÜµ
                return Math.random() < 0.7; // 70%Ê¶ÇÁéáÁÇπËµû
            } catch (error) {
                console.error('Âà§Êñ≠ËßíËâ≤ÁÇπËµûÂÅèÂ•ΩÂ§±Ë¥•:', error);
                return Math.random() < 0.6; // ÈªòËÆ§60%Ê¶ÇÁéá
            }
        }
        
        // ‰ªéËßíËâ≤‰∫∫ËÆæ‰∏≠ÊèêÂèñÂÖ¥Ë∂£ÂÖ≥ÈîÆËØç
        function extractInterestsFromBio(bio) {
            const interests = [];
            const interestKeywords = [
                'Èü≥‰πê', 'ÁîµÂΩ±', 'ËØª‰π¶', 'ËøêÂä®', 'Ê∏∏Êàè', 'ÁæéÈ£ü', 'ÊóÖË°å', 'ÊëÑÂΩ±',
                'ÁªòÁîª', 'ÂÜô‰Ωú', '‰ª£Á†Å', 'ÁßëÊäÄ', 'Âä®Êº´', 'Â∞èËØ¥', 'ÂíñÂï°', 'Ëå∂',
                'ÂÆ†Áâ©', 'Ëä±', 'ÊòüÁ©∫', 'Èõ®Â§©', 'Èò≥ÂÖâ', 'Â≠¶‰π†', 'Â∑•‰Ωú', 'ÊúãÂèã'
            ];
            
            interestKeywords.forEach(keyword => {
                if (bio.includes(keyword)) {
                    interests.push(keyword);
                }
            });
            
            return interests;
        }
        
        // Êõ¥Êñ∞Âä®ÊÄÅÁÇπËµûÊòæÁ§∫
        async function updateMomentLikeDisplay(momentId) {
            try {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
                const momentLikes = await db.momentLikes.where('momentId').equals(parseInt(momentId)).toArray();
            
            // Êõ¥Êñ∞ÁÇπËµûÊåâÈíÆÊï∞Â≠ó
            const likeBtn = momentElement.querySelector('.moment-action-btn[onclick*="toggleMomentLike"]');
            if (likeBtn) {
                const likeCount = likeBtn.querySelector('span');
                if (likeCount) {
                    likeCount.textContent = momentLikes.length;
                }
            }
            
            // Êõ¥Êñ∞ÊàñÂàõÂª∫ÁÇπËµûÁî®Êà∑ÂêçÁß∞ÊòæÁ§∫
            let likesDisplay = momentElement.querySelector('.likes-display');
            
            if (momentLikes.length > 0) {
                if (!likesDisplay) {
                    likesDisplay = document.createElement('div');
                    likesDisplay.className = 'likes-display';
                    
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâËØÑËÆ∫Âå∫ÂüüÔºåÂ¶ÇÊûúÊúâÂ∞±‰∏çËÆæÁΩÆmargin-top
                        const existingCommentsSection = momentElement.querySelector('.moment-comments-section');
                        const marginTop = existingCommentsSection ? '0' : '0';
                    
                    likesDisplay.style.cssText = `
                        margin-top: ${marginTop};
                        padding: 8px 12px;
                        background: #f8f9fa;
                        font-size: 13px;
                        color: #666;
                        line-height: 1.4;
                    `;
                    
                        // ÊèíÂÖ•Âà∞Êìç‰ΩúÊåâÈíÆ‰∏ãÈù¢ÔºåËØÑËÆ∫Âå∫ÂâçÈù¢ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâÔºåÂê¶ÂàôÂú®Êó∂Èó¥Êìç‰ΩúÂå∫ÂêéÈù¢
                    const momentContent = momentElement.querySelector('.moment-content');
                    const momentTimeActions = momentElement.querySelector('.moment-time-actions');
                        const commentsSection = momentElement.querySelector('.moment-comments-section');
                        
                    if (momentContent && momentTimeActions) {
                            if (commentsSection) {
                                // Â¶ÇÊûúÂ∑≤ÊúâËØÑËÆ∫Âå∫ÔºåÊèíÂÖ•Âà∞ËØÑËÆ∫Âå∫ÂâçÈù¢
                                momentContent.insertBefore(likesDisplay, commentsSection);
                            } else {
                                // Ê≤°ÊúâËØÑËÆ∫Âå∫ÔºåÊèíÂÖ•Âà∞Êó∂Èó¥Êìç‰ΩúÂå∫ÂêéÈù¢
                        momentTimeActions.parentNode.insertBefore(likesDisplay, momentTimeActions.nextSibling);
                            }
                    }
                }
                
                // ‰ΩøÁî®ÂíåÁî®Êà∑ÊòµÁß∞Áõ∏ÂêåÈ¢úËâ≤ÁöÑÁ©∫ÂøÉÁà±ÂøÉ
                const likeIcon = '<svg width="14" height="14" style="margin-right: 4px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="#576b95" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>';
                const names = momentLikes.map(like => like.name).join('„ÄÅ');
                likesDisplay.innerHTML = `${likeIcon}<span style="color: #576b95; font-weight: 600;">${names}</span>`;
                likesDisplay.style.display = 'block';
            } else if (likesDisplay) {
                likesDisplay.style.display = 'none';
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÁÇπËµûÊòæÁ§∫Â§±Ë¥•:', error);
            }
        }
        
        // AIËßíËâ≤ËØÑËÆ∫
        async function addAIComment(momentId, character, moment) {
            try {
                // ÁîüÊàêÁ¨¶ÂêàËßíËâ≤‰∫∫ËÆæÁöÑËØÑËÆ∫
                const comments = await generateCharacterComment(character, moment);
                if (!comments || comments.length === 0) return;
                
                const randomComment = comments[Math.floor(Math.random() * comments.length)];
                
                const comment = {
                    id: Date.now() + Math.random(),
                    nickname: character.name,
                    avatar: character.avatarUrl,
                    text: randomComment,
                    time: formatTime(new Date()),
                    timestamp: Date.now(),
                    characterId: character.id
                };
                
                // ‰øùÂ≠òËØÑËÆ∫
                saveCommentToMoment(momentId, comment);
                
                // Êõ¥Êñ∞ËØÑËÆ∫Êï∞
                updateMomentCommentCount(momentId);
                
                // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫Êñ∞ËØÑËÆ∫
                displayCommentUnderMoment(momentId, comment);
                
                // ÊòæÁ§∫ËØÑËÆ∫ÊèêÁ§∫
                showToast(`${character.name} ËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`);
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÂ¶ÇÊûúÊòØËØÑËÆ∫Áî®Êà∑ÁöÑÂä®ÊÄÅÔºåÂàõÂª∫Êé®ÈÄÅÈÄöÁü•
                if (moment.authorId === 'user') {
                    createPushNotification(character, `ËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅÔºö${randomComment.length > 15 ? randomComment.substring(0, 15) + '...' : randomComment}`, 200);
                }
            } catch (error) {
                console.error('AIËßíËâ≤ËØÑËÆ∫Â§±Ë¥•:', error);
            }
        }
        
        // AIËßíËâ≤Èó¥ÁöÑÊ•º‰∏≠Ê•º‰∫íÂä®ÔºàÂ•óÁî®ÂÆåÊàê.htmlÈÄªËæëÔºâ
        async function triggerAiToAiInteraction(momentId, relatedCharacters) {
            try {
                // Ëé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ
                const momentsData = JSON.parse(sessionStorage.getItem('momentsData') || '[]');
                const moment = momentsData.find(m => (m.id == momentId) || (m.timestamp == momentId));
                if (!moment || !moment.comments) return;
                
                const comments = moment.comments;
                if (comments.length < 2) return; // Ëá≥Â∞ëÈúÄË¶Å2Êù°ËØÑËÆ∫ÊâçËÉΩËß¶ÂèëËßíËâ≤Èó¥‰∫íÂä®
                
                // Ëé∑ÂèñÂú®ÂêåÁæ§ÁöÑÂèÇ‰∏éËØÑËÆ∫AIËßíËâ≤
                const participatingAis = [...new Set(comments
                    .filter(comment => comment.characterId && comment.characterId !== 'user')
                    .map(comment => comment.characterId)
                )];
                
                // ËøáÊª§Âá∫Âè™ÊúâÂú®ÂêåÁæ§ÁöÑAIËßíËâ≤
                const sameGroupParticipants = participatingAis.filter(aiId => 
                    relatedCharacters.some(char => char.id === aiId)
                );
                
                if (sameGroupParticipants.length < 2) {
                    console.log('ÂèÇ‰∏éËØÑËÆ∫ÁöÑÂêåÁæ§AIËßíËâ≤Â∞ë‰∫é2‰∏™ÔºåË∑≥ËøáËßíËâ≤Èó¥‰∫íÂä®');
                    return;
                }
                
                console.log(`ÂèëÁé∞ ${sameGroupParticipants.length} ‰∏™ÂêåÁæ§AIËßíËâ≤ÂèÇ‰∏é‰∫ÜËØÑËÆ∫ÔºåÂºÄÂßãËßíËâ≤Èó¥‰∫íÂä®`);
                
                // ÈöèÊú∫ÈÄâÊã©‰∏§‰∏™ÂêåÁæ§AIËøõË°å‰∫íÂä®
                const aiA = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                let aiB = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                
                // Á°Æ‰øùÈÄâÊã©‰∏çÂêåÁöÑAI
                while (aiB === aiA && sameGroupParticipants.length > 1) {
                    aiB = sameGroupParticipants[Math.floor(Math.random() * sameGroupParticipants.length)];
                }
                
                if (aiA === aiB) return;
                
                // Ê£ÄÊü•ËßíËâ≤ÂÖ≥Á≥ªÂíå‰∫íÂä®Ê¶ÇÁéá (40%Ê¶ÇÁéáÔºå‰øùÊåÅÂéüÊúâËÆæÁΩÆÊ¶ÇÁéá)
                if (Math.random() > 0.4) {
                    console.log('Âü∫‰∫éÊ¶ÇÁéáÈÄâÊã©‰∏çËøõË°åËßíËâ≤Èó¥‰∫íÂä®');
                    return;
                }
                
                // ÈÄâÊã©‰∏Ä‰∏™Áé∞ÊúâËØÑËÆ∫‰Ωú‰∏∫‰∫íÂä®Ëµ∑ÁÇπ
                const targetComment = comments.find(comment => 
                    comment.characterId === aiA || comment.characterId === aiB
                );
                
                if (!targetComment) return;
                
                // ÂÜ≥ÂÆöË∞ÅÂÖàÂõûÂ§çË∞Å
                const responderCharId = targetComment.characterId === aiA ? aiB : aiA;
                const targetCharId = targetComment.characterId;
                
                // Ëé∑ÂèñËßíËâ≤‰ø°ÊÅØ
                const responderChar = characters.find(c => c.id === responderCharId);
                const targetChar = characters.find(c => c.id === targetCharId);
                
                if (!responderChar || !targetChar) return;
                
                console.log(`${responderChar.name} Â∞ÜÂõûÂ§ç ${targetChar.name} ÁöÑËØÑËÆ∫`);
                
                // ÁîüÊàêAIÈó¥ÁöÑ‰∫íÂä®ÂõûÂ§ç
                await generateAiToAiReply(momentId, targetComment, responderChar, targetChar);
                
            } catch (error) {
                console.error('ËßíËâ≤Èó¥‰∫íÂä®Â§±Ë¥•:', error);
            }
        }
        

        
        // ËßíËâ≤‰πãÈó¥‰∫íÂä®Ôºà‰øùÁïôÂéüÂáΩÊï∞Ôºå‰ΩÜ‰∏çÂÜç‰ΩøÁî®Ôºâ
        function triggerCharacterInteractions(momentId, characters) {
            if (characters.length < 2) return;
            
            // Ëé∑ÂèñÂ∑≤Âú®Âêå‰∏ÄÁæ§ÁöÑËßíËâ≤ÂÖ≥Á≥ª
            const groupRelations = getGroupRelations(characters);
            
            for (let i = 0; i < characters.length - 1; i++) {
                for (let j = i + 1; j < characters.length; j++) {
                    const char1 = characters[i];
                    const char2 = characters[j];
                    
                    // Ê£ÄÊü•ÊòØÂê¶Âú®Âêå‰∏Ä‰∏™Áæ§Èáå
                    const inSameGroup = groupRelations.some(group => 
                        group.includes(char1.id) && group.includes(char2.id)
                    );
                    
                    if (inSameGroup && Math.random() < 0.6) {
                        addCharacterInteraction(momentId, char1, char2);
                    }
                }
            }
        }
        
        // Ëé∑ÂèñÂàÜÁªÑÂÖ≥Á≥ª - Âü∫‰∫éËßíËâ≤ÂàÜÁªÑËÄå‰∏çÊòØÁæ§ËÅä
        function getGroupRelations(characters) {
            const groups = [];
            
            // ÊåâÂàÜÁªÑIDÂàÜÁªÑËßíËâ≤
            const groupedCharacters = {};
            characters.forEach(character => {
                const groupId = character.groupId || 'my_friends';
                if (!groupedCharacters[groupId]) {
                    groupedCharacters[groupId] = [];
                }
                groupedCharacters[groupId].push(character.id);
            });
            
            // Âè™ËøîÂõûÂèØ‰ª•‰∫íÂä®ÁöÑÂàÜÁªÑÔºàÈùûÈªòËÆ§ÂàÜÁªÑ‰∏îÂÖÅËÆ∏‰∫íÂä®Ôºâ
            Object.entries(groupedCharacters).forEach(([groupId, characterIds]) => {
                const group = characterGroups.find(g => g.id === groupId);
                
                // Âè™ÊúâÈùûÈªòËÆ§ÂàÜÁªÑ‰∏îÂÖÅËÆ∏‰∫íÂä®ÁöÑÂàÜÁªÑ‰∏≠ÁöÑËßíËâ≤ÊâçËÉΩÁõ∏‰∫í‰∫íÂä®
                if (group && !group.isDefault && group.canInteract && characterIds.length >= 2) {
                    groups.push(characterIds);
                }
            });
            
            return groups;
        }
        
        // ÁîüÊàêAIÈó¥ÁöÑÂõûÂ§çÔºà‰ΩøÁî®Êñ∞ÁöÑËÆ∞ÂøÜÁ≥ªÁªüÔºâ
        async function generateAiToAiReply(momentId, targetComment, responderChar, targetChar) {
            try {
                // Ëé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ
                const momentsData = JSON.parse(sessionStorage.getItem('momentsData') || '[]');
                const moment = momentsData.find(m => (m.id == momentId) || (m.timestamp == momentId));
                if (!moment) return;

                const targetPersona = targetChar.prompt || '';
                
                // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®Êñ∞ÁöÑËÆ∞ÂøÜÁ≥ªÁªü
                const promptText = `Áé∞Âú®Âú®‰∏Ä‰∏™Âä®ÊÄÅ‰∏ãÔºå${targetChar.name}Ôºà‰∫∫ËÆæÔºö${targetPersona}ÔºâÂàöÂàöËØÑËÆ∫‰∫ÜÔºö"${targetComment.text}"„ÄÇ

ÂéüÂä®ÊÄÅÂÜÖÂÆπÔºö${moment.text}

‰Ω†Ë¶Å‰Ωú‰∏∫${responderChar.name}ÔºåÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÂíå‰∏é${targetChar.name}ÁöÑÂÖ≥Á≥ªÔºåÂØπtaÁöÑËØÑËÆ∫ËøõË°åÂõûÂ∫î„ÄÇË¶ÅÊ±ÇÔºö
1. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæËøõË°åÂõûÂ§çÔºå‰∏çËÉΩÊ∑∑Ê∑ÜËßíËâ≤
2. ÂõûÂ§çË¶ÅËá™ÁÑ∂„ÄÅÁ¨¶ÂêàÊúãÂèãÂúàËØÑËÆ∫È£éÊ†º
3. ÂèØ‰ª•ÊòØËµûÂêå„ÄÅ‰∏çÂêåËßÇÁÇπ„ÄÅË°•ÂÖÖ„ÄÅÊèêÈóÆÊàñÂºÄÁé©Á¨ë
4. Ë¶Å‰ΩìÁé∞Âá∫‰Ω†Âíå${targetChar.name}‰πãÈó¥ÁöÑ‰∫íÂä®ÂÖ≥Á≥ª
5. ÂõûÂ§çÁÆÄÁü≠ÊúâË∂£ÔºåÁ¨¶ÂêàÁ§æ‰∫§Â™í‰ΩìÁöÑÁâπÁÇπ
6. Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÈÄâÊã©ÂêàÈÄÇÁöÑËØ≠Ê∞îÂíåÁî®ËØç
7. ‰∏çË¶Å‰ΩøÁî®‰∏éËßíËâ≤ÊÄßÊ†º‰∏çÁ¨¶ÁöÑË°®ÊÉÖÁ¨¶Âè∑

ËØ∑ÂõûÂ§ç${targetChar.name}ÁöÑËØÑËÆ∫Ôºö`;

                // üî•„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂΩïË∑®Â∫îÁî®Êó∂Èó¥Á∫ø‰∫ã‰ª∂
                await recordCrossAppEvent(
                    responderChar.id,
                    'moments',
                    'ai_to_ai_reply',
                    {
                        targetCharacter: targetChar.name,
                        originalComment: targetComment.text,
                        momentContent: moment.text
                    }
                );

                // ‰ΩøÁî®Êñ∞ÁöÑËÆ∞ÂøÜÁ≥ªÁªü
                const response = await callChatAPI(promptText, responderChar);
                const replyText = Array.isArray(response) ? response[0] : response;

                if (replyText && replyText.trim()) {
                    // ÂàõÂª∫ÂõûÂ§çËØÑËÆ∫
                    const replyComment = {
                        id: Date.now() + Math.random(),
                        nickname: responderChar.name,
                        avatar: responderChar.avatarUrl,
                        text: replyText.trim(),
                    time: formatTime(new Date()),
                    timestamp: Date.now(),
                        replyTo: targetChar.name,
                        characterId: responderChar.id
                };
                
                    // ‰øùÂ≠òËØÑËÆ∫
                    saveCommentToMoment(momentId, replyComment);
                
                    // Êõ¥Êñ∞ËØÑËÆ∫Êï∞
                updateMomentCommentCount(momentId);
                
                    // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫Êñ∞ËØÑËÆ∫
                    displayCommentUnderMoment(momentId, replyComment);
                
                    showToast(`${responderChar.name} ÂõûÂ§ç‰∫Ü ${targetChar.name}`);
                }

            } catch (error) {
                console.error('ÁîüÊàêAIÈó¥ÂõûÂ§çÂ§±Ë¥•:', error);
            }
        }
        
        // AIÂõûÂ§çÁî®Êà∑ËØÑËÆ∫Ôºà‰ΩøÁî®Êñ∞ÁöÑËÆ∞ÂøÜÁ≥ªÁªüÔºâ
        async function triggerAIReplyToUser(momentId, aiCharacterName, userCommentText) {
            try {
                console.log(`triggerAIReplyToUserË¢´Ë∞ÉÁî®: momentId=${momentId}, aiCharacterName=${aiCharacterName}, userCommentText="${userCommentText}"`);

                // ÊâæÂà∞ÂØπÂ∫îÁöÑAIËßíËâ≤
                const character = characters.find(c => c.name === aiCharacterName);
                if (!character) {
                    console.log(`Êú™ÊâæÂà∞ËßíËâ≤ ${aiCharacterName}ÔºåÂèØÁî®ËßíËâ≤:`, characters.map(c => c.name));
                    return;
                }

                // Ëé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ
                const moment = await db.moments.get(parseInt(momentId));
                if (!moment) {
                    console.log(`Êú™ÊâæÂà∞Âä®ÊÄÅ ${momentId}`);
                    return;
                }

                // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®Êñ∞ÁöÑËÆ∞ÂøÜÁ≥ªÁªü
                const promptText = `Âú®‰∏Ä‰∏™Âä®ÊÄÅ‰∏ãÔºåÁî®Êà∑ÂàöÂàöÂõûÂ§ç‰∫Ü‰Ω†ÁöÑËØÑËÆ∫Ôºö"${userCommentText}"„ÄÇ

ÂéüÂä®ÊÄÅÂÜÖÂÆπÔºö${moment.text}

ËØ∑‰Ωú‰∏∫${character.name}ÔºåÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÂØπÁî®Êà∑ÁöÑÂõûÂ§çÂÅöÂá∫Ëá™ÁÑ∂ÁöÑÂèçÂ∫î„ÄÇË¶ÅÊ±ÇÔºö
1. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæËøõË°åÂõûÂ§çÔºå‰øùÊåÅËßíËâ≤‰∏ÄËá¥ÊÄß
2. ÂõûÂ§çË¶ÅËá™ÁÑ∂„ÄÅÁ¨¶ÂêàÊúãÂèãÂúàËØÑËÆ∫È£éÊ†ºÔºåÁÆÄÁü≠ÊúâË∂£
3. ÂèØ‰ª•ÊòØÁªßÁª≠ËÆ®ËÆ∫„ÄÅË°®ËææÊÑüË∞¢„ÄÅÂºÄÁé©Á¨ëÊàñËÄÖÂàÜ‰∫´Êõ¥Â§öÊÉ≥Ê≥ï
4. ‰ΩìÁé∞Âá∫‰Ω†ÂíåÁî®Êà∑‰πãÈó¥ÁöÑÂèãÂ•Ω‰∫íÂä®
5. Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÈÄâÊã©ÂêàÈÄÇÁöÑËØ≠Ê∞îÂíåÁî®ËØç
6. ‰∏çË¶Å‰ΩøÁî®‰∏éËßíËâ≤ÊÄßÊ†º‰∏çÁ¨¶ÁöÑË°®ÊÉÖÁ¨¶Âè∑

ËØ∑ÂõûÂ§çÁî®Êà∑ÁöÑËØÑËÆ∫Ôºö`;

                // üî•„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂΩïË∑®Â∫îÁî®Êó∂Èó¥Á∫ø‰∫ã‰ª∂
                await recordCrossAppEvent(
                    character.id,
                    'moments',
                    'reply_to_user',
                    {
                        userComment: userCommentText,
                        momentContent: moment.text
                    }
                );

                // üîç ÁªüËÆ°Âä®ÊÄÅÂõûÂ§çÁöÑËÆ∞ÂøÜ‰ΩøÁî®ÊÉÖÂÜµ
                await logMemoryUsageStats(character, 'moments_reply_to_user');

                // ‰ΩøÁî®Êñ∞ÁöÑËÆ∞ÂøÜÁ≥ªÁªü
                const response = await callChatAPI(promptText, character);
                const replyText = Array.isArray(response) ? response[0] : response;

                console.log(`ÊâæÂà∞ËßíËâ≤ ${character.name}ÔºåÂáÜÂ§áÁîüÊàêÂõûÂ§ç`);

                if (replyText && replyText.trim()) {
                    // ÂàõÂª∫AIÂõûÂ§çËØÑËÆ∫
                    const replyComment = {
                        id: Date.now() + Math.random(),
                        nickname: character.name,
                        avatar: character.avatarUrl,
                        text: replyText.trim(),
                        time: formatTime(new Date()),
                        timestamp: Date.now(),
                        replyTo: 'Êàë', // ÂõûÂ§çÁî®Êà∑
                        characterId: character.id
                    };

                    // ‰øùÂ≠òËØÑËÆ∫
                    saveCommentToMoment(momentId, replyComment);

                    // Êõ¥Êñ∞ËØÑËÆ∫Êï∞
                    updateMomentCommentCount(momentId);

                    // Âú®Âä®ÊÄÅ‰∏ãÊñπÊòæÁ§∫Êñ∞ËØÑËÆ∫
                    displayCommentUnderMoment(momentId, replyComment);

                    // Â¢ûÂä†ÂØπËØùËΩÆÊ¨°
                    const conversationKey = `${momentId}-${character.name}`;
                    const currentRounds = commentConversationRounds.get(conversationKey) || 0;
                    commentConversationRounds.set(conversationKey, currentRounds + 1);
                    console.log(`${character.name} Âú®Âä®ÊÄÅ ${momentId} ‰∏≠ÁöÑÂØπËØùËΩÆÊ¨°Êõ¥Êñ∞‰∏∫: ${currentRounds + 1}/10`);

                    showToast(`${character.name} ÂõûÂ§ç‰∫Ü‰Ω†`);

                    // üî•„ÄêÊñ∞Â¢û„Äë‰∏∫ËßíËâ≤ÂõûÂ§çÁî®Êà∑ËØÑËÆ∫ÂàõÂª∫Êé®ÈÄÅÈÄöÁü•
                    createPushNotification(character, `ÂõûÂ§ç‰∫Ü‰Ω†Ôºö${replyText.trim().length > 15 ? replyText.trim().substring(0, 15) + '...' : replyText.trim()}`, 200);
                }

            } catch (error) {
                console.error('AIÂõûÂ§çÁî®Êà∑Â§±Ë¥•:', error);
            }
        }
        
        // ÁîüÊàêÁ¨¶ÂêàËßíËâ≤‰∫∫ËÆæÁöÑËØÑËÆ∫ - Áõ¥Êé•Â•óÁî®ÂÆåÊàê.htmlÁöÑÈÄªËæë
        async function generateCharacterComment(character, moment) {
            try {
                // Ëé∑ÂèñËßíËâ≤ÂØπÂ∫îÁöÑËÅäÂ§©ËÆæÁΩÆ
                let chatSettings = null;
                try {
                    chatSettings = await db.chatSettings.get(character.id);
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
                
                const persona = chatSettings?.aiPersona || character.prompt || `‰Ω†ÊòØ${character.name}„ÄÇ`;
                
                // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                    const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                    );
                    const validWorldBooks = worldBooks.filter(book => book && book.content);
                    if (validWorldBooks.length > 0) {
                        worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                            validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
                    }
                    } catch (error) {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    }
                }
                
                // Ëé∑ÂèñÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩï‰Ωú‰∏∫‰∏ä‰∏ãÊñáÔºàÊ†πÊçÆÁî®Êà∑ËÆæÁΩÆÁöÑÊù°Êï∞Ôºâ
                let chatContext = '';
                const characterMessages = chatMessages[character.id] || [];
                if (characterMessages.length > 0) {
                    const maxMemory = parseInt(chatSettings?.maxMemory) || 10;
                    const recentHistory = characterMessages.slice(-maxMemory);
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                        recentHistory.map(msg => {
                            if (msg.role === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            return `${character.name}Ôºö${msg.content}`;
                        }).join('\n');
                }
                
                // ÂàÜÊûêÂä®ÊÄÅÂÜÖÂÆπÔºåÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ
                const momentText = moment.text || '';
                const momentAuthor = moment.nickname || 'Áî®Êà∑';
                const isUserMoment = !moment.characterId || moment.characterId === 'user';
                
                // Âà§Êñ≠ËØÑËÆ∫ÁöÑÁ±ªÂûãÂíåÈ£éÊ†º
                let commentStyle = '';
                const bio = (character.bio || '').toLowerCase();
                
                if (bio.includes('Ê¥ªÊ≥º') || bio.includes('ÂºÄÊúó') || bio.includes('Â§ñÂêë')) {
                    commentStyle = 'ÁÉ≠ÊÉÖÊ¥ªÊ≥ºÔºåÁî®ËØçËΩªÊùæÊúâË∂£';
                } else if (bio.includes('ÂÜ∑Èùô') || bio.includes('ÁêÜÊÄß') || bio.includes('‰∏•Ë∞®')) {
                    commentStyle = 'ÁêÜÊÄßÂÆ¢ËßÇÔºåË°®ËææÁÆÄÊ¥Å';
                } else if (bio.includes('Ê∏©Êüî') || bio.includes('ÂñÑËâØ') || bio.includes('‰ΩìË¥¥')) {
                    commentStyle = 'Ê∏©ÊöñÂÖ≥ÊÄÄÔºåËØ≠Ê∞îÊüîÂíå';
                } else if (bio.includes('ÂπΩÈªò') || bio.includes('ÊêûÁ¨ë') || bio.includes('È£éË∂£')) {
                    commentStyle = 'ÂπΩÈªòÈ£éË∂£ÔºåÂñÑ‰∫éË∞É‰æÉ';
                } else if (bio.includes('ÂÜÖÂêë') || bio.includes('ÂÆâÈùô') || bio.includes('ÂÆ≥Áæû')) {
                    commentStyle = 'ÁÆÄÊ¥ÅÂê´ËìÑÔºå‰∏çÂ§öËØù‰ΩÜÁúüËØö';
                } else {
                    commentStyle = 'Ëá™ÁÑ∂ÁúüÂÆûÔºåÁ¨¶ÂêàÊÄßÊ†º';
                }

                let systemPrompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${persona}„ÄÇ${worldBookContent}${chatContext}

‰Ω†Âú®ÊúãÂèãÂúàÁúãÂà∞‰∫Ü${momentAuthor}ÂèëÂ∏ÉÁöÑÂä®ÊÄÅÔºö"${momentText}"

ËØ∑‰Ωú‰∏∫${character.name}ÔºåÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÂíå‰∏éÂèëÂ∏ÉËÄÖÁöÑÂÖ≥Á≥ªÔºåÂØπËøôÊù°Âä®ÊÄÅÂèëË°®ËØÑËÆ∫„ÄÇ

## ËØÑËÆ∫È£éÊ†ºË¶ÅÊ±ÇÔºö
- ${commentStyle}
- 10-30Â≠óÂ∑¶Âè≥ÔºåÁÆÄÊ¥ÅÊúâÂäõ
- Ë¶Å‰ΩìÁé∞Âá∫‰Ω†ÁöÑÁúüÂÆûÂèçÂ∫îÂíåÊÉÖÊÑü
- ÂèØ‰ª•ÊòØÔºöËµûÁæéËÆ§Âêå„ÄÅÂñÑÊÑèË∞É‰æÉ„ÄÅÂÖ≥ÂøÉËØ¢ÈóÆ„ÄÅÂàÜ‰∫´ÊÑüÂèó„ÄÅÊèêÂá∫Âª∫ËÆÆÁ≠â

## ËßíËâ≤Ë°®ËææË¶ÅÊ±ÇÔºö
1. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊÄßÊ†ºÁâπÁÇπ
2. Áî®ËØçË¶ÅÁ¨¶Âêà‰Ω†ÁöÑË∫´‰ªΩÂíåËØ¥ËØù‰π†ÊÉØ
3. Ë°®ËææË¶ÅËá™ÁÑ∂Ôºå‰∏çË¶ÅËøá‰∫éÂàªÊÑè
4. Â¶ÇÊûú‰Ω†‰ª¨ÂÖ≥Á≥ª‰∫≤ÂØÜÔºåÂèØ‰ª•Êõ¥ÈöèÊÑè‰∏Ä‰∫õ
5. Ê†πÊçÆÂä®ÊÄÅÂÜÖÂÆπÈÄâÊã©ÂêàÈÄÇÁöÑÂõûÂ∫îËßíÂ∫¶
6. ÈÅøÂÖç‰ΩøÁî®‰∏éËßíËâ≤ÊÄßÊ†º‰∏çÁ¨¶ÁöÑË°®ÊÉÖÁ¨¶Âè∑
7. ‰∏çË¶ÅÁîüÁ°¨Âú∞ÈáçÂ§çÂä®ÊÄÅÂÜÖÂÆπÔºåË¶ÅÊúâËá™Â∑±ÁöÑËßÇÁÇπ

## ‰∫íÂä®ÂÖ≥Á≥ªÔºö
- Â¶ÇÊûúÊòØÁî®Êà∑ÂèëÁöÑÂä®ÊÄÅÔºö‰ª•ÊúãÂèãË∫´‰ªΩÊ∏©È¶®‰∫íÂä®
- Â¶ÇÊûúÊòØÂÖ∂‰ªñËßíËâ≤ÂèëÁöÑÂä®ÊÄÅÔºöÂü∫‰∫é‰Ω†‰ª¨ÁöÑÂÖ≥Á≥ªÂíå‰∫∫ËÆæ‰∫íÂä®

ËØ∑ÁîüÊàê‰∏ÄÊù°Ëá™ÁÑ∂„ÄÅÊúâ‰∏™ÊÄß„ÄÅË¥¥Âêà‰Ω†‰∫∫ËÆæÁöÑËØÑËÆ∫Ôºö`;
                
                // ÊûÑÂª∫Áî®Êà∑Ê∂àÊÅØÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÂõæÁâáÈúÄË¶ÅËØÜÂà´
                let postDescription = `ÂéüÂä®ÊÄÅÔºö${momentText}`;
                let hasImages = moment.images && moment.images.length > 0;
                
                if (hasImages) {
                    postDescription += `\n[ËØ•Âä®ÊÄÅÂåÖÂê´${moment.images.length}Âº†ÂõæÁâá]`;
                }
                
                const userMsg = `${postDescription}\nËØ∑ÂèëË°®‰Ω†ÁöÑÁúãÊ≥ïÔºö`;
                
                // Ê£ÄÊü•ÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÊîØÊåÅËßÜËßâËØÜÂà´
                const supportsVision = isVisionModelSupported();
                let messages;
                
                if (hasImages && supportsVision) {
                    // ‰ΩøÁî®Â§öÊ®°ÊÄÅÊ∂àÊÅØÊ†ºÂºèÔºåÂåÖÂê´ÂõæÁâá
                    const firstImage = moment.images[0]; // ‰ΩøÁî®Á¨¨‰∏ÄÂº†ÂõæÁâá
                    console.log(`‰∏∫ËßíËâ≤ ${character.name} ‰ΩøÁî®ÂõæÁâáËØÜÂà´ÂäüËÉΩËØÑËÆ∫Âä®ÊÄÅ`);
                    
                    messages = [
                        { role: 'system', content: systemPrompt },
                        { 
                            role: 'user', 
                            content: [
                                { type: 'text', text: `ÂéüÂä®ÊÄÅÊñáÂ≠óÔºö${momentText}\n\nËøôÊù°Âä®ÊÄÅËøòÂåÖÂê´‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåËØ∑‰ªîÁªÜËßÇÂØüÂõæÁâáÂÜÖÂÆπÔºåÁÑ∂ÂêéÂèëË°®‰Ω†ÁöÑÁúãÊ≥ïÔºö` },
                                { type: 'image_url', image_url: { url: firstImage } }
                            ]
                        }
                    ];
                } else {
                    // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                    if (hasImages && !supportsVision) {
                        console.log(`ÂΩìÂâçÊ®°Âûã‰∏çÊîØÊåÅÂõæÁâáËØÜÂà´Ôºå${character.name} Â∞ÜÂü∫‰∫éÊñáÂ≠óÂÜÖÂÆπËØÑËÆ∫`);
                        // ‰øÆÊîπÊèêÁ§∫ÔºåËÆ©AIÁü•ÈÅìÊúâÂõæÁâá‰ΩÜÊó†Ê≥ïÁúãÂà∞
                        const textOnlyMsg = `${postDescription}\n\nÊ≥®ÊÑèÔºöËøôÊù°Âä®ÊÄÅÂåÖÂê´ÂõæÁâáÔºå‰ΩÜÁî±‰∫éÂΩìÂâçÊ®°ÂûãÈôêÂà∂Ôºå‰Ω†Êó†Ê≥ïÁúãÂà∞ÂõæÁâáÂÜÖÂÆπ„ÄÇËØ∑Âü∫‰∫éÊñáÂ≠óÈÉ®ÂàÜÂèëË°®‰Ω†ÁöÑÁúãÊ≥ïÔºåÂèØ‰ª•ÈÄÇÂΩìËØ¢ÈóÆÂõæÁâáÁõ∏ÂÖ≥ÂÜÖÂÆπ„ÄÇ`;
                        messages = [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: textOnlyMsg }
                        ];
                    } else {
                        // Á∫ØÊñáÂ≠óÂä®ÊÄÅ
                        messages = [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userMsg }
                        ];
                    }
                }
                
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑAPIË∞ÉÁî®ÈÄªËæëÔºà‰∏éËÅäÂ§©Áõ∏ÂêåÔºâ
                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáAIËØÑËÆ∫');
                    return [];
                }
                
                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                
                // Ê£ÄÊµãÊòØÂê¶ÊòØGeminiÂÆòÊñπAPI
                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');
                
                let response;
                if (isGeminiOfficial) {
                    // ‰ΩøÁî®GeminiÂÆòÊñπAPIÊ†ºÂºè
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
                    
                    // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè‰∏∫GeminiÊ†ºÂºè
                    const geminiMessages = [];
                    
                    // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                        });
                    }
                    
                    // ËΩ¨Êç¢ÂÖ∂‰ªñÊ∂àÊÅØ
                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;
                        
                        // Â§ÑÁêÜÂ§öÊ®°ÊÄÅÂÜÖÂÆπÔºàÂåÖÂê´ÂõæÁâáÔºâ
                        if (Array.isArray(msg.content)) {
                            const parts = [];
                            msg.content.forEach(item => {
                                if (item.type === 'text') {
                                    parts.push({ text: item.text });
                                } else if (item.type === 'image_url') {
                                    // Â§ÑÁêÜÂõæÁâáÔºåÈúÄË¶ÅËΩ¨Êç¢Ê†ºÂºè
                                    const imageUrl = item.image_url.url;
                                    if (imageUrl.startsWith('data:')) {
                                        // Base64ÂõæÁâá
                                        const [mimeInfo, base64Data] = imageUrl.split(',');
                                        const mimeType = mimeInfo.match(/data:([^;]+)/)?.[1] || 'image/jpeg';
                                        parts.push({
                                            inline_data: {
                                                mime_type: mimeType,
                                                data: base64Data
                                            }
                                        });
                                    } else {
                                        // URLÂõæÁâáÔºåGeminiÂèØËÉΩ‰∏çÊîØÊåÅÔºåÊ∑ªÂä†ÊñáÊú¨ËØ¥Êòé
                                        parts.push({ text: '[ÂõæÁâáÔºö' + imageUrl + ']' });
                                    }
                                }
                            });
                            geminiMessages.push({
                                role: msg.role === 'user' ? 'user' : 'model',
                                parts: parts
                            });
                        } else {
                            // ÊñáÊú¨Ê∂àÊÅØ
                            geminiMessages.push({
                                role: msg.role === 'user' ? 'user' : 'model',
                                parts: [{ text: msg.content }]
                            });
                        }
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ‰ΩøÁî®OpenAIÊ†ºÂºè
                    // Êô∫ËÉΩÂ§ÑÁêÜURLÊãºÊé•
                    let apiUrl;
                    if (proxyUrl.endsWith('/v1')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else if (proxyUrl.includes('/v1/')) {
                        // Â¶ÇÊûúURL‰∏≠Â∑≤ÁªèÂåÖÂê´/v1/Ë∑ØÂæÑÔºåÁõ¥Êé•Ê∑ªÂä†chat/completions
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else {
                        apiUrl = `${proxyUrl}/v1/chat/completions`;
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
                    return [];
                }
                
                const data = await response.json();
                let content;
                
                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return [];
                    }
                } else {
                    // Ëß£ÊûêOpenAIÊ†ºÂºèÂìçÂ∫î
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        // Â∞ùËØïÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑÂÄº
                        for (const key in data) {
                            if (typeof data[key] === 'string' && data[key].trim()) {
                                content = data[key];
                                console.log(`AIËØÑËÆ∫API‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                                break;
                            }
                        }
                    }
                    
                    if (!content) {
                        console.error('AIËØÑËÆ∫APIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return [];
                    }
                }
                
                if (content && content.trim().length > 0) {
                    return [content.trim()];
                }
                
                return [];
                
            } catch (error) {
                console.error('ÁîüÊàêAIËØÑËÆ∫Â§±Ë¥•:', error);
                return [];
            }
        }
        

        
        // ÁîüÊàêËßíËâ≤Èó¥‰∫íÂä®ËØÑËÆ∫ - ‰ΩøÁî®ÂÆåÊï¥ÁöÑAIËÅäÂ§©ÈÄªËæë
        async function generateCharacterInteraction(char1, char2, momentId) {
            try {
                // Ëé∑ÂèñÂä®ÊÄÅÂíå‰πãÂâçÁöÑËØÑËÆ∫‰∏ä‰∏ãÊñá
                const momentsData = JSON.parse(sessionStorage.getItem('momentsData') || '[]');
                const moment = momentsData.find(m => (m.id == momentId) || (m.timestamp == momentId));
                if (!moment) return '';
                
                // Ëé∑ÂèñËßíËâ≤ÂØπÂ∫îÁöÑËÅäÂ§©ËÆæÁΩÆ
                let chatSettings1 = null;
                let chatSettings2 = null;
                try {
                    chatSettings1 = await db.chatSettings.get(char1.id);
                    chatSettings2 = await db.chatSettings.get(char2.id);
                } catch (error) {
                    console.error('Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
                
                // Ëé∑Âèñchar2ÁöÑÊúÄÊñ∞ËØÑËÆ∫‰Ωú‰∏∫‰∏ä‰∏ãÊñá
                const char2Comments = (moment.comments || []).filter(c => c.characterId === char2.id);
                const latestChar2Comment = char2Comments[char2Comments.length - 1];
                
                // ÊûÑÂª∫ÂØπËØù‰∏ä‰∏ãÊñá
                let conversationContext = `Áî®Êà∑ÂèëÂ∏É‰∫ÜÂä®ÊÄÅÔºö${moment.text}\n`;
                if (latestChar2Comment) {
                    conversationContext += `${char2.name}ËØÑËÆ∫ËØ¥Ôºö${latestChar2Comment.text}\n`;
                }
                
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑAI‰∫∫ËÆæÂíåËÆ∞ÂøÜÁ≥ªÁªü
                const persona1 = chatSettings1?.aiPersona || char1.prompt || `‰Ω†ÊòØ${char1.name}„ÄÇ`;
                
                // Ëé∑ÂèñÂéÜÂè≤ËÅäÂ§©ËÆ∞ÂΩï
                const maxMemory = parseInt(chatSettings1?.maxMemory) || 10;
                const char1Messages = chatMessages[char1.id] || [];
                const recentMessages = char1Messages.slice(-maxMemory);
                
                let chatSummary = '';
                if (recentMessages.length > 0) {
                    chatSummary = '‰Ω†ÂíåÁî®Êà∑ÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰æõÂèÇËÄÉÔºâÔºö\n';
                    chatSummary += recentMessages.map(msg => {
                        if (msg.role === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                        if (msg.role === 'assistant') return `${char1.name}Ôºö${msg.content}`;
                        return '';
                    }).filter(line => line).join('\n');
                }
                
                // Ëé∑ÂèñÊåÇËΩΩÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chatSettings1?.linkedWorldBookIds && chatSettings1.linkedWorldBookIds.length > 0) {
                    try {
                    const worldBooks = await Promise.all(
                            chatSettings1.linkedWorldBookIds.map(async id => {
                                try {
                                    return await db.worldbooks.get(id);
                                } catch (error) {
                                    console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                                    return null;
                                }
                            })
                    );
                    const validWorldBooks = worldBooks.filter(book => book && book.content);
                    if (validWorldBooks.length > 0) {
                        worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                            validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
                    }
                    } catch (error) {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    }
                }
                
                let systemPrompt = `‰Ω†ÊòØ${char1.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${persona1}„ÄÇ${worldBookContent}${chatSummary}\n\n`;
                systemPrompt += `ËøôÊòØ‰∏Ä‰∏™Ê•º‰∏≠Ê•ºËÆ®ËÆ∫ÔºåËØ∑Âü∫‰∫é‰ª•‰∏ãÂØπËØù‰∏ä‰∏ãÊñáÔºåÁªßÁª≠ÂèÇ‰∏éËÆ®ËÆ∫„ÄÇË¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÔºåÂõûÂ§çË¶ÅÁÆÄÁü≠ÊúâË∂£„ÄÇ`;
                if (chatSettings2?.aiPersona) {
                    systemPrompt += ` Ôºà${char2.name}ÁöÑËÆæÂÆöÔºö${chatSettings2.aiPersona}Ôºâ`;
                }
                systemPrompt += `\n\nË¶ÅÊ±ÇÔºö
1. ÂõûÂ§çË¶ÅÁ¨¶ÂêàÊúãÂèãÂúàËØÑËÆ∫ÁöÑÈ£éÊ†ºÔºåÁÆÄÁü≠„ÄÅËá™ÁÑ∂
2. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæÊù•ÈÄâÊã©ÊòØÂê¶‰ΩøÁî®Ë°®ÊÉÖÁ¨¶Âè∑Ôºå‰∏çË¶Å‰ΩøÁî®‰∏éËßíËâ≤ÊÄßÊ†º‰∏çÁ¨¶ÁöÑemoji
3. ‰∏çË¶ÅËøá‰∫éÊ≠£ÂºèÊàñÂÆ¢Â•óÔºåË¶ÅÂÉèÁúüÂÆûÁöÑÊúãÂèã‰∏ÄÊ†∑‰∫íÂä®`;
                
                // ÊûÑÂª∫Ê∂àÊÅØ
                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: conversationContext }
                ];
                
                // ‰ΩøÁî®ÂÆåÊï¥ÁöÑAPIË∞ÉÁî®ÈÄªËæëÔºà‰∏éËÅäÂ§©Áõ∏ÂêåÔºâ
                const { base: proxyUrl, key: apiKey, model } = apiSettings;
                if (!proxyUrl || !apiKey || !model) {
                    console.log('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáËßíËâ≤‰∫íÂä®');
                    return '';
                }
                
                const requestBody = {
                    model: model,
                    messages: messages,
                    temperature: 0.8,
                    stream: false
                };
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                // Ê£ÄÊµãÊòØÂê¶ÊòØGeminiÂÆòÊñπAPI
                const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');
                
                let response;
                if (isGeminiOfficial) {
                    // ‰ΩøÁî®GeminiÂÆòÊñπAPIÊ†ºÂºè
                    const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
                    
                    const geminiMessages = [];
                    if (requestBody.messages[0]?.role === 'system') {
                        geminiMessages.push({
                            role: 'user',
                            parts: [{ text: requestBody.messages[0].content }]
                        });
                        geminiMessages.push({
                            role: 'model',
                            parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                        });
                    }
                    
                    for (let i = 1; i < requestBody.messages.length; i++) {
                        const msg = requestBody.messages[i];
                        if (msg.role === 'system') continue;
                        
                        geminiMessages.push({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: geminiMessages,
                            generationConfig: {
                                temperature: requestBody.temperature || 0.8
                            }
                        }),
                        signal: controller.signal
                    });
                } else {
                    // ‰øÆÂ§çÔºöÊô∫ËÉΩÂ§ÑÁêÜURLÊãºÊé•
                    let apiUrl;
                    if (proxyUrl.endsWith('/v1')) {
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else if (proxyUrl.includes('/v1/')) {
                        // Â¶ÇÊûúURL‰∏≠Â∑≤ÁªèÂåÖÂê´/v1/Ë∑ØÂæÑÔºåÁõ¥Êé•Ê∑ªÂä†chat/completions
                        apiUrl = `${proxyUrl}/chat/completions`;
                    } else {
                        apiUrl = `${proxyUrl}/v1/chat/completions`;
                    }
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                }
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    let errorText = await response.text();
                    console.error(`ËßíËâ≤‰∫íÂä®APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
                    return '';
                }
                
                const data = await response.json();
                let content;
                
                if (isGeminiOfficial) {
                    content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!content) {
                        console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                        return '';
                    }
                } else {
                    // Ëß£ÊûêOpenAIÊ†ºÂºèÂìçÂ∫î
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        content = data.choices[0].message.content;
                    } else if (data.message) {
                        content = data.message;
                    } else if (data.text) {
                        content = data.text;
                    } else if (data.response) {
                        content = data.response;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.result) {
                        content = data.result;
                    } else {
                        // Â∞ùËØïÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑÂÄº
                        for (const key in data) {
                            if (typeof data[key] === 'string' && data[key].trim()) {
                                content = data[key];
                                console.log(`ËßíËâ≤‰∫íÂä®API‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                                break;
                            }
                        }
                    }
                    
                    if (!content) {
                        console.error('ËßíËâ≤‰∫íÂä®APIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                return '';
                    }
                }
                
                return content ? content.trim() : '';
                
            } catch (error) {
                console.error('ÁîüÊàêËßíËâ≤‰∫íÂä®Â§±Ë¥•:', error);
                return '';
            }
        }
        

        
        // ÈïøÊåâÈÄâÊã©ÂäüËÉΩ
        function addLongPressListener(element, momentId) {
            let pressTimer = null;
            let startY = 0;
            let moved = false;
            
            const startPress = (e) => {
                if (isSelectionMode) return;
                
                startY = e.touches ? e.touches[0].clientY : e.clientY;
                moved = false;
                
                pressTimer = setTimeout(() => {
                    if (!moved) {
                        enterSelectionMode();
                        selectMoment(momentId);
                    }
                }, 500); // 500msÈïøÊåâ
            };
            
            const endPress = () => {
                clearTimeout(pressTimer);
                pressTimer = null;
            };
            
            const movePress = (e) => {
                const currentY = e.touches ? e.touches[0].clientY : e.clientY;
                if (Math.abs(currentY - startY) > 10) {
                    moved = true;
                    endPress();
                }
            };
            
            element.addEventListener('touchstart', startPress);
            element.addEventListener('touchend', endPress);
            element.addEventListener('touchmove', movePress);
            element.addEventListener('mousedown', startPress);
            element.addEventListener('mouseup', endPress);
            element.addEventListener('mousemove', movePress);
        }
        
        // ËøõÂÖ•ÈÄâÊã©Ê®°Âºè
        function enterSelectionMode() {
            isSelectionMode = true;
            selectedMoments.clear();
            
            // ÊòæÁ§∫ÈÄâÊã©Ê®°ÂºèUI
            showSelectionModeUI();
            
            // Ê∑ªÂä†ÈÄâÊã©Ê°ÜÂà∞ÊâÄÊúâÂä®ÊÄÅ
            const momentItems = document.querySelectorAll('.moment-item');
            momentItems.forEach(item => {
                const checkbox = document.createElement('div');
                checkbox.className = 'moment-checkbox';
                checkbox.innerHTML = '<i class="far fa-circle"></i>';
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    const momentId = item.getAttribute('data-moment-id');
                    toggleMomentSelection(momentId);
                };
                item.appendChild(checkbox);
                item.classList.add('selection-mode');
            });
        }
        
        // ÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
        function exitSelectionMode() {
            isSelectionMode = false;
            selectedMoments.clear();
            
            // ÈöêËóèÈÄâÊã©Ê®°ÂºèUI
            hideSelectionModeUI();
            
            // ÁßªÈô§ÈÄâÊã©Ê°Ü
            const checkboxes = document.querySelectorAll('.moment-checkbox');
            checkboxes.forEach(checkbox => checkbox.remove());
            
            const momentItems = document.querySelectorAll('.moment-item');
            momentItems.forEach(item => {
                item.classList.remove('selection-mode', 'selected');
            });
        }
        
        // ÊòæÁ§∫ÈÄâÊã©Ê®°ÂºèUI
        function showSelectionModeUI() {
            const selectionBar = document.createElement('div');
            selectionBar.className = 'selection-bar';
            selectionBar.innerHTML = `
                <div class="selection-actions">
                    <button class="cancel-btn" onclick="exitSelectionMode()">ÂèñÊ∂à</button>
                    <span class="selection-count">Â∑≤ÈÄâÊã© 0 Êù°Âä®ÊÄÅ</span>
                    <button class="delete-btn" onclick="deleteSelectedMoments()" disabled>Âà†Èô§</button>
                </div>
            `;
            
            const momentsPage = document.getElementById('moments-page');
            momentsPage.insertBefore(selectionBar, momentsPage.firstChild);
        }
        
        // ÈöêËóèÈÄâÊã©Ê®°ÂºèUI
        function hideSelectionModeUI() {
            const selectionBar = document.querySelector('.selection-bar');
            if (selectionBar) {
                selectionBar.remove();
            }
        }
        
        // ÂàáÊç¢Âä®ÊÄÅÈÄâÊã©Áä∂ÊÄÅ
        function toggleMomentSelection(momentId) {
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            const checkbox = momentElement.querySelector('.moment-checkbox i');
            
            if (selectedMoments.has(momentId)) {
                selectedMoments.delete(momentId);
                checkbox.className = 'far fa-circle';
                momentElement.classList.remove('selected');
            } else {
                selectedMoments.add(momentId);
                checkbox.className = 'fas fa-check-circle';
                momentElement.classList.add('selected');
            }
            
            updateSelectionUI();
        }
        
        // ÈÄâÊã©Âä®ÊÄÅ
        function selectMoment(momentId) {
            if (!selectedMoments.has(momentId)) {
                toggleMomentSelection(momentId);
            }
        }
        
        // Êõ¥Êñ∞ÈÄâÊã©UI
        function updateSelectionUI() {
            const countSpan = document.querySelector('.selection-count');
            const deleteBtn = document.querySelector('.delete-btn');
            
            if (countSpan) {
                countSpan.textContent = `Â∑≤ÈÄâÊã© ${selectedMoments.size} Êù°Âä®ÊÄÅ`;
            }
            
            if (deleteBtn) {
                deleteBtn.disabled = selectedMoments.size === 0;
            }
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂä®ÊÄÅ
        async function deleteSelectedMoments() {
            if (selectedMoments.size === 0) return;
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ ${selectedMoments.size} Êù°Âä®ÊÄÅÂêóÔºü`)) {
                return;
            }
            
            try {
                // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§
                for (const momentId of selectedMoments) {
                    try {
                        // Â∞ùËØïÂ§öÁßçIDÊ†ºÂºèËøõË°åÂà†Èô§
                        let deleted = false;
                        const possibleIds = [momentId, parseInt(momentId), String(momentId), Number(momentId)];
                        
                        for (const id of possibleIds) {
                            try {
                                await db.moments.delete(id);
                                console.log(`‚úì ÊàêÂäüÂà†Èô§Âä®ÊÄÅ ${id} (Á±ªÂûã: ${typeof id})`);
                                deleted = true;
                                break;
                            } catch (error) {
                                console.log(`Âà†Èô§ID ${id} (${typeof id}) Â§±Ë¥•: ${error.message}`);
                            }
                        }
                        
                        if (!deleted) {
                            // Â∞ùËØï‰ΩøÁî®whereÊù°‰ª∂Âà†Èô§
                            await db.moments.where('id').equals(momentId).delete();
                            console.log(`‚úì ‰ΩøÁî®whereÊù°‰ª∂Âà†Èô§Âä®ÊÄÅ ${momentId} ÊàêÂäü`);
                        }
                        
                        // Âà†Èô§Áõ∏ÂÖ≥ÁÇπËµûÔºàÂ∞ùËØï‰∏çÂêåIDÊ†ºÂºèÔºâ
                        const numericId = parseInt(momentId);
                        await db.momentLikes.where('momentId').equals(numericId).delete();
                        await db.momentLikes.where('momentId').equals(momentId).delete();
                        
                        // Âà†Èô§Áõ∏ÂÖ≥ËØÑËÆ∫ÔºàÂ∞ùËØï‰∏çÂêåIDÊ†ºÂºèÔºâ
                        await db.momentComments.where('momentId').equals(numericId).delete();
                        await db.momentComments.where('momentId').equals(momentId).delete();
                        
                    } catch (error) {
                        console.error(`Âà†Èô§Âä®ÊÄÅ ${momentId} Â§±Ë¥•:`, error);
                        throw error; // ÈáçÊñ∞ÊäõÂá∫ÈîôËØØ‰ª•‰æø‰∏äÂ±ÇÂ§ÑÁêÜ
                    }
                    
                    // Ê∏ÖÁêÜÂØπËØùËΩÆÊ¨°ËÆ∞ÂΩï
                    for (const [key, value] of commentConversationRounds.entries()) {
                        if (key.startsWith(`${momentId}-`)) {
                            commentConversationRounds.delete(key);
                        }
                    }
            }
            
            // ‰ªéDOM‰∏≠ÁßªÈô§
            selectedMoments.forEach(momentId => {
                const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
                if (momentElement) {
                    momentElement.remove();
                }
            });
                
                // Ê∏ÖÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑsessionStorageÁºìÂ≠òÊï∞ÊçÆ
                try {
                    const sessionMomentsData = sessionStorage.getItem('momentsData');
                    if (sessionMomentsData) {
                        const momentsArray = JSON.parse(sessionMomentsData);
                        const filteredMoments = momentsArray.filter(moment => 
                            !selectedMoments.has(moment.id.toString()) && 
                            !selectedMoments.has(moment.timestamp?.toString())
                        );
                        sessionStorage.setItem('momentsData', JSON.stringify(filteredMoments));
                    }
                } catch (error) {
                    console.warn('Ê∏ÖÁêÜsessionStorageÂä®ÊÄÅÊï∞ÊçÆÊó∂Âá∫Èîô:', error);
                }
            
            showToast(`Â∑≤Âà†Èô§ ${selectedMoments.size} Êù°Âä®ÊÄÅ`);
            
            // ÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
            exitSelectionMode();
                
                // Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÂä®ÊÄÅÂàóË°®ÔºåÁ°Æ‰øùÂà†Èô§ÁîüÊïà
                setTimeout(() => {
                    loadMoments();
                }, 500);
                
            } catch (error) {
                console.error('Âà†Èô§Âä®ÊÄÅÂ§±Ë¥•:', error);
                showToast('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Âº∫Âà∂Ê∏ÖÁêÜÊåáÂÆöÂä®ÊÄÅÁöÑÊâÄÊúâÁõ∏ÂÖ≥Êï∞ÊçÆ
        async function forceCleanMoment(momentId) {
            try {
                const numericId = parseInt(momentId);
                console.log(`ÂºÄÂßãÂΩªÂ∫ïÊ∏ÖÁêÜÂä®ÊÄÅ: ${momentId}`);
                
                // 1. ‰ªéIndexedDBÂà†Èô§ÔºàÂ∞ùËØïÂ§öÁßçIDÊ†ºÂºèÔºâ
                let deleted = false;
                const possibleIds = [momentId, numericId, String(momentId), Number(momentId)];
                
                for (const id of possibleIds) {
                    try {
                        await db.moments.delete(id);
                        console.log(`‚úì Âà†Èô§Âä®ÊÄÅÊàêÂäüÔºå‰ΩøÁî®ID: ${id} (Á±ªÂûã: ${typeof id})`);
                        deleted = true;
                        break;
                    } catch (error) {
                        console.log(`Âà†Èô§ID ${id} Â§±Ë¥•: ${error.message}`);
                    }
                }
                
                if (!deleted) {
                    await db.moments.where('id').equals(momentId).delete();
                }
                
                // Âà†Èô§Áõ∏ÂÖ≥Êï∞ÊçÆÔºàÂ∞ùËØï‰∏çÂêåÊ†ºÂºèÔºâ
                await db.momentLikes.where('momentId').equals(numericId).delete();
                await db.momentLikes.where('momentId').equals(momentId).delete();
                await db.momentComments.where('momentId').equals(numericId).delete();
                await db.momentComments.where('momentId').equals(momentId).delete();
                
                // 2. Ê∏ÖÁêÜÂØπËØùËΩÆÊ¨°ËÆ∞ÂΩï
                for (const [key, value] of commentConversationRounds.entries()) {
                    if (key.startsWith(`${momentId}-`)) {
                        commentConversationRounds.delete(key);
                    }
                }
                
                // 3. ‰ªéDOMÁßªÈô§
                const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
                if (momentElement) {
                    momentElement.remove();
                }
                
                // 4. Ê∏ÖÁêÜsessionStorageÁºìÂ≠ò
                const sessionMomentsData = sessionStorage.getItem('momentsData');
                if (sessionMomentsData) {
                    const momentsArray = JSON.parse(sessionMomentsData);
                    const filteredMoments = momentsArray.filter(moment => 
                        moment.id != momentId && 
                        moment.timestamp != momentId &&
                        moment.id.toString() !== momentId.toString()
                    );
                    sessionStorage.setItem('momentsData', JSON.stringify(filteredMoments));
                }
                
                console.log(`Âä®ÊÄÅ ${momentId} Ê∏ÖÁêÜÂÆåÊàê`);
                return true;
            } catch (error) {
                console.error('Âº∫Âà∂Ê∏ÖÁêÜÂä®ÊÄÅÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // Ê∏ÖÁêÜÊâÄÊúâÊúâÈóÆÈ¢òÁöÑÂä®ÊÄÅÔºà‰øÆÂ§çÂ∑•ÂÖ∑Ôºâ
        async function cleanupCorruptedMoments() {
            if (!confirm('ËøôÂ∞ÜÊ∏ÖÁêÜÊâÄÊúâÂèØËÉΩÊúâÈóÆÈ¢òÁöÑÂä®ÊÄÅÊï∞ÊçÆÔºåÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü')) {
                return;
            }
            
            try {
                let cleanupCount = 0;
                
                // Ëé∑ÂèñÊâÄÊúâÂä®ÊÄÅ
                const allMoments = await db.moments.toArray();
                
                for (const moment of allMoments) {
                    // Ê£ÄÊü•Âä®ÊÄÅÊòØÂê¶ÊúâÊó†ÊïàÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                    if (moment.avatar && !isValidAvatarUrl(moment.avatar)) {
                        console.log(`ÂèëÁé∞Êó†ÊïàÂ§¥ÂÉèÁöÑÂä®ÊÄÅ: ${moment.id}`);
                        
                        // ‰øÆÂ§çÂ§¥ÂÉèÊàñÂà†Èô§Âä®ÊÄÅ
                        const shouldDelete = confirm(`Âä®ÊÄÅ "${moment.text?.substring(0, 30)}..." ÂåÖÂê´Êó†ÊïàÂ§¥ÂÉèÊï∞ÊçÆÔºåÊòØÂê¶Âà†Èô§Ê≠§Âä®ÊÄÅÔºü\nÁÇπÂáª"ÂèñÊ∂à"Â∞Ü‰øÆÂ§çÂ§¥ÂÉèÊï∞ÊçÆ„ÄÇ`);
                        
                        if (shouldDelete) {
                            await forceCleanMoment(moment.id);
                            cleanupCount++;
                        } else {
                            // ‰øÆÂ§çÂ§¥ÂÉè
                            await db.moments.update(moment.id, { avatar: getDefaultAvatar() });
                        }
                    }
                }
                
                if (cleanupCount > 0) {
                    showToast(`Â∑≤Ê∏ÖÁêÜ ${cleanupCount} Êù°ÊúâÈóÆÈ¢òÁöÑÂä®ÊÄÅ`);
                    // ÈáçÊñ∞Âä†ËΩΩÂä®ÊÄÅÂàóË°®
                    loadMoments();
                } else {
                    showToast('Ê≤°ÊúâÂèëÁé∞ÈúÄË¶ÅÊ∏ÖÁêÜÁöÑÂä®ÊÄÅ');
                }
                
            } catch (error) {
                console.error('Ê∏ÖÁêÜÊçüÂùèÂä®ÊÄÅÂ§±Ë¥•:', error);
                showToast('Ê∏ÖÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Êõ¥Êç¢Âä®ÊÄÅÂ∞ÅÈù¢ÂõæÁâá
        function changeCoverImage() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedImage = await compressImage(file, 1200, 0.8);
                        
                        const coverImage = document.getElementById("cover-image");
                        const coverPlaceholder = document.getElementById("cover-placeholder");
                        
                        if (coverImage && coverPlaceholder) {
                            coverImage.src = compressedImage;
                            coverImage.classList.remove("hide");
                            coverPlaceholder.classList.add("hide");
                        }
                        
                        saveMomentsImage("coverImage", compressedImage);
                        showToast("Â∞ÅÈù¢Â∑≤Êõ¥Êñ∞ÔºÅ", "success");
                    } catch (error) {
                        console.error("Â§ÑÁêÜÂ∞ÅÈù¢ÂõæÁâáÂ§±Ë¥•:", error);
                        showToast("Â∞ÅÈù¢Êõ¥Êñ∞Â§±Ë¥•ÔºÅ", "error");
                    }
                }
            };
            input.click();
        }
        
        // Êõ¥Êç¢Âä®ÊÄÅÂ§¥ÂÉè
        function changeAvatarImage(event) {
            event.stopPropagation();
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        // ÂéãÁº©Â§¥ÂÉèÂõæÁâá
                        const compressedImage = await compressImage(file, 400, 0.9);
                        
                        const avatar = document.getElementById('moments-avatar');
                        const avatarIcon = avatar.querySelector('.moments-avatar-icon');
                        
                        avatar.style.backgroundImage = `url(${compressedImage})`;
                        avatarIcon.style.display = 'none';
                        
                        // ‰øùÂ≠òÂéãÁº©ÂêéÁöÑÂõæÁâá
                        saveMomentsImage('avatarImage', compressedImage);
                        
                        showToast('Â§¥ÂÉèÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
                    } catch (error) {
                        console.error('Â§ÑÁêÜÂ§¥ÂÉèÂõæÁâáÂ§±Ë¥•:', error);
                        showToast('Â§¥ÂÉèÊõ¥Êñ∞Â§±Ë¥•ÔºÅ', 'error');
                    }
                }
            };
            input.click();
        }
        
        // üî•„Äê‰øÆÂ§ç„ÄëÂä†ËΩΩÂä®ÊÄÅÂõæÁâáËÆæÁΩÆÔºàÂºÇÊ≠•ÁâàÊú¨Ôºâ
        async function loadMomentsImages() {
            try {
                // Âä†ËΩΩÂ∞ÅÈù¢ÂõæÁâá
                const savedCover = await getMomentsImage('coverImage');
                if (savedCover) {
                    const coverImage = document.getElementById('cover-image');
                    const coverPlaceholder = document.getElementById('cover-placeholder');
                    
                    if (coverImage && coverPlaceholder) {
                        coverImage.src = savedCover;
                        coverImage.classList.remove('hide');
                        coverPlaceholder.classList.add('hide');
                    }
                }
                
                // Âä†ËΩΩÂ§¥ÂÉèÂõæÁâá
                const savedAvatar = await getMomentsImage('avatarImage');
                if (savedAvatar) {
                    const avatar = document.getElementById('moments-avatar');
                    const avatarIcon = avatar?.querySelector('.moments-avatar-icon');
                    
                    if (avatar) {
                        avatar.style.backgroundImage = `url(${savedAvatar})`;
                        if (avatarIcon) {
                            avatarIcon.style.display = 'none';
                        }
                    }
                }
                
                // Âä†ËΩΩÁî®Êà∑Âêç
                const savedUsername = await getMomentsImage('username');
                if (savedUsername) {
                    const usernameElement = document.getElementById('moments-username');
                    if (usernameElement) {
                        usernameElement.textContent = savedUsername;
                    }
                }
                
                console.log('Âä®ÊÄÅÂõæÁâáÂä†ËΩΩÂÆåÊàê');
            } catch (error) {
                console.error('Âä†ËΩΩÂä®ÊÄÅÂõæÁâáÂ§±Ë¥•:', error);
            }
        }
        
        // Êõ¥ÊîπÁî®Êà∑Âêç
        function changeUsername(event) {
            event.stopPropagation();
            
            const currentUsername = document.getElementById('moments-username').textContent;
            const newUsername = prompt('ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊòµÁß∞:', currentUsername);
            
            if (newUsername !== null && newUsername.trim() !== '') {
                const usernameElement = document.getElementById('moments-username');
                usernameElement.textContent = newUsername.trim();
                
                // ‰øùÂ≠òÁî®Êà∑Âêç
                saveMomentsImage('username', newUsername.trim());
                
                showToast('ÊòµÁß∞Â∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            }
        }
        
        // ÂéãÁº©ÂõæÁâá
        function compressImage(fileOrDataUrl, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // ËÆ°ÁÆóÂéãÁº©ÂêéÁöÑÂ∞∫ÂØ∏
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ÁªòÂà∂ÂéãÁº©ÂêéÁöÑÂõæÁâá
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ËΩ¨Êç¢‰∏∫base64ÔºåÈôç‰ΩéË¥®Èáè‰ª•ÂáèÂ∞ëÂ§ßÂ∞è
                    const compressedData = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedData);
                };
                
                // Âà§Êñ≠ËæìÂÖ•Á±ªÂûãÔºöFileÂØπË±°ËøòÊòØbase64Â≠óÁ¨¶‰∏≤
                if (typeof fileOrDataUrl === 'string') {
                    // Â¶ÇÊûúÊòØbase64Â≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•‰ΩøÁî®
                    img.src = fileOrDataUrl;
                } else {
                    // Â¶ÇÊûúÊòØFileÂØπË±°ÔºåÂàõÂª∫URL
                    img.src = URL.createObjectURL(fileOrDataUrl);
                }
            });
        }
        
        // üî•„Äê‰øÆÂ§ç„Äë‰øùÂ≠òÂä®ÊÄÅÂõæÁâáÔºà‰ΩøÁî®IndexedDBÊåÅ‰πÖÂåñÂ≠òÂÇ®Ôºâ
        async function saveMomentsImage(imageType, imageData) {
            try {
                // ÂéãÁº©ÂõæÁâáÊï∞ÊçÆ‰ª•ËäÇÁúÅÂ≠òÂÇ®Á©∫Èó¥
                let compressedData = imageData;
                if (imageData.startsWith('data:image/')) {
                    try {
                        compressedData = await compressImage(imageData, 800, 0.8);
                    } catch (error) {
                        console.warn('ÂõæÁâáÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂõæ:', error);
                    }
                }
                
                // ‰øùÂ≠òÂà∞IndexedDB
                await db.globalSettings.put({
                    id: `moments_${imageType}`,
                    type: 'moments_setting',
                    data: compressedData
                });
                
                console.log(`Âä®ÊÄÅÂõæÁâáÂ∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì: ${imageType}`);
            } catch (error) {
                console.error('‰øùÂ≠òÂä®ÊÄÅÂõæÁâáÂ§±Ë¥•:', error);
                // Â¶ÇÊûúÊï∞ÊçÆÂ∫ì‰øùÂ≠òÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞sessionStorage
                try {
                    sessionStorage.setItem(`moments_${imageType}`, imageData);
                    console.log(`Âä®ÊÄÅÂõæÁâáÂ∑≤‰øùÂ≠òÂà∞‰ºöËØùÂ≠òÂÇ®: ${imageType}`);
                } catch (sessionError) {
                    // Â¶ÇÊûúsessionStorage‰πüÊª°‰∫ÜÔºåÂè™Âú®ÂÜÖÂ≠ò‰∏≠‰øùÂ≠ò
                    window.momentsImages = window.momentsImages || {};
                    window.momentsImages[imageType] = imageData;
                    console.log(`Âä®ÊÄÅÂõæÁâáÂ∑≤‰øùÂ≠òÂà∞ÂÜÖÂ≠ò: ${imageType}`);
                }
            }
        }
        
        // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñÂä®ÊÄÅÂõæÁâáÔºà‰ªéIndexedDBËé∑ÂèñÔºâ
        async function getMomentsImage(imageType) {
            try {
                // ÂÖà‰ªéIndexedDBËé∑Âèñ
                const dbData = await db.globalSettings.get(`moments_${imageType}`);
                if (dbData && dbData.data) {
                    return dbData.data;
                }
                
                // ÂÖºÂÆπÊÄßÔºö‰ªésessionStorageËé∑Âèñ
                const sessionData = sessionStorage.getItem(`moments_${imageType}`);
                if (sessionData) {
                    // Â¶ÇÊûú‰ªésessionStorageËé∑ÂèñÂà∞Êï∞ÊçÆÔºåËøÅÁßªÂà∞IndexedDB
                    await saveMomentsImage(imageType, sessionData);
                    return sessionData;
                }
                
                // ÊúÄÂêé‰ªéÂÜÖÂ≠òËé∑Âèñ
                if (window.momentsImages && window.momentsImages[imageType]) {
                    return window.momentsImages[imageType];
                }
                
                return null;
            } catch (error) {
                console.error('Ëé∑ÂèñÂä®ÊÄÅÂõæÁâáÂ§±Ë¥•:', error);
                // ÂõûÈÄÄÂà∞sessionStorage
                try {
                    return sessionStorage.getItem(`moments_${imageType}`);
                } catch (sessionError) {
                    return null;
                }
            }
        }
        
        // ÈáçÁΩÆÊï∞ÊçÆÂ∫ìÔºàÂ¶ÇÊûúÂá∫Áé∞schemaÈîôËØØÔºâ
        async function resetDatabase() {
            try {
                await db.delete();
                console.log('Êï∞ÊçÆÂ∫ìÂ∑≤ÈáçÁΩÆ');
                location.reload(); // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
            } catch (error) {
                console.error('ÈáçÁΩÆÊï∞ÊçÆÂ∫ìÂ§±Ë¥•:', error);
            }
        }
        
        // üéÆ„ÄêÊñ∞Â¢û„ÄëÊ∏∏ÊàèË∑®Â∫îÁî®ËÆ∞ÂøÜËÆ∞ÂΩïÂáΩÊï∞
        async function recordGameEvent(characterId, eventType, gameData) {
            try {
                await recordCrossAppEvent(
                    characterId,
                    'game',
                    eventType,
                    {
                        id: `game_${Date.now()}`,
                        type: 'game_session',
                        gameName: gameData.gameName,
                        action: eventType,
                        result: gameData.result,
                        score: gameData.score,
                        chatContent: gameData.chatContent,
                        timestamp: Date.now()
                    }
                );
                console.log(`üéÆ Â∑≤ËÆ∞ÂΩïÊ∏∏Êàè‰∫ã‰ª∂: ${eventType} - ${gameData.gameName}`);
            } catch (error) {
                console.error('ËÆ∞ÂΩïÊ∏∏Êàè‰∫ã‰ª∂Â§±Ë¥•:', error);
            }
        }

        // üéÆ„ÄêÊñ∞Â¢û„ÄëÊ∏∏ÊàèËÅäÂ§©ËÆ∞ÂΩïÂáΩÊï∞
        async function recordGameChat(characterId, sender, message, gameContext) {
            try {
                await recordCrossAppEvent(
                    characterId,
                    'game',
                    'game_chat',
                    {
                        id: `game_chat_${Date.now()}`,
                        type: 'game_chat',
                        sender: sender,
                        content: message,
                        gameName: gameContext.gameName,
                        gameState: gameContext.gameState,
                        timestamp: Date.now()
                    }
                );
                console.log(`üéÆ Â∑≤ËÆ∞ÂΩïÊ∏∏ÊàèËÅäÂ§©: ${sender} - ${message.substring(0, 30)}...`);
            } catch (error) {
                console.error('ËÆ∞ÂΩïÊ∏∏ÊàèËÅäÂ§©Â§±Ë¥•:', error);
            }
        }

        // ÂºÄÂßãÊ∏∏Êàè
        function startGame(gameName) {
            if (gameName === 'witchPotion') {
                // TODO: ÂÆûÁé∞Â•≥Â∑´ÁöÑËß£ËçØÊ∏∏Êàè
                alert('Â•≥Â∑´ÁöÑËß£ËçØÊ∏∏ÊàèÊ≠£Âú®ÂºÄÂèë‰∏≠...\n\nËøôÂ∞ÜÊòØ‰∏Ä‰∏™‰∏éAIËßíËâ≤‰∫íÂä®ÁöÑËß£Ë∞úÊ∏∏ÊàèÔºÅ\n\nüéÆ Ê∏∏ÊàèÂäüËÉΩÈ¢ÑËßàÔºö\n- ‰∏éAIËßíËâ≤‰∏ÄËæπÊ∏∏Êàè‰∏ÄËæπËÅäÂ§©\n- Ê∏∏ÊàèÁªìÊûúÂíåËÅäÂ§©ÂÜÖÂÆπÈÉΩ‰ºöËÆ∞ÂΩïÂà∞Â∑•‰ΩúËÆ∞ÂøÜ‰∏≠\n- ÊåâÊó∂Èó¥È°∫Â∫è‰∏éÊôÆÈÄöËÅäÂ§©ËÆ∞ÂΩïÂêàÂπ∂ÊòæÁ§∫');

                // üéÆ„ÄêÁ§∫‰æã„ÄëËÆ∞ÂΩïÊ∏∏ÊàèÂºÄÂßã‰∫ã‰ª∂
                if (currentChatCharacter && !currentChatCharacter.isGroup) {
                    recordGameEvent(currentChatCharacter.id, 'game_start', {
                        gameName: 'Â•≥Â∑´ÁöÑËß£ËçØ',
                        result: null,
                        score: null,
                        chatContent: null
                    });
                }
            } else {
                alert('Ê∏∏ÊàèÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...');
            }
        }
        
                // ÂàáÊç¢ÊâãÊú∫ËæπÊ°ÜÊòæÁ§∫
        function togglePhoneBorder() {
            const phoneFrame = document.getElementById('phone-frame');
            const phoneScreen = document.getElementById('phone-screen');
            const toggle = document.getElementById('phone-border-toggle');
            const body = document.body;
            
            if (toggle.checked) {
                // ÊòæÁ§∫ÁúüÂÆûÊâãÊú∫ËæπÊ°Ü
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '12px';
                phoneFrame.style.backgroundColor = '#fff';
                phoneFrame.style.borderRadius = '50px';
                phoneFrame.style.boxShadow = '0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1)';
                phoneScreen.style.borderRadius = '40px';
                phoneScreen.style.border = '2px solid #333';
                body.style.background = 'var(--body-bg, #dcdcdc)';
                body.style.padding = '20px';
            } else {
                // ÈöêËóèËæπÊ°ÜÔºå‰ΩÜ‰øùÊåÅphone-screenÁöÑÂúÜËßíÂíåÈò¥ÂΩ±
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '0';
                phoneFrame.style.backgroundColor = 'transparent';
                phoneFrame.style.borderRadius = '0';
                phoneFrame.style.boxShadow = 'none';
                phoneScreen.style.borderRadius = '25px';
                phoneScreen.style.border = 'none';
                phoneScreen.style.boxShadow = 'var(--shadow-phone)';
                body.style.background = 'var(--body-bg, #1a1a1a)';
                body.style.padding = '0';
            }
            
            // ‰øùÂ≠òËÆæÁΩÆÂà∞localStorage
            localStorage.setItem('phoneBorderEnabled', toggle.checked);
            
            // ÊòæÁ§∫ÊèêÁ§∫
            const message = toggle.checked ? 'ÊâãÊú∫ËæπÊ°ÜÂ∑≤ÂºÄÂêØÔºÅ' : 'ÊâãÊú∫ËæπÊ°ÜÂ∑≤ÂÖ≥Èó≠ÔºÅ';
            showToast(message, 'success');
        }
        
        // ÊòæÁ§∫Â±èÂπïÂ∞∫ÂØ∏ÈÄâÊã©
        function showScreenSizeOptions() {
            showApp('screen-size-screen');
        }
        
        // ÊîπÂèòÂ±èÂπïÂ∞∫ÂØ∏
        function changeScreenSize(width, height, name) {
            const phoneScreen = document.getElementById('phone-screen');
            
            // Â∫îÁî®Êñ∞Â∞∫ÂØ∏
            phoneScreen.style.width = width + 'px';
            phoneScreen.style.height = height + 'px';
            
            // Êõ¥Êñ∞Â§ñËßÇËÆæÁΩÆ‰∏≠ÁöÑÊòæÁ§∫ÊñáÊú¨
            const currentSizeDesc = document.getElementById('current-screen-size');
            if (currentSizeDesc) {
                currentSizeDesc.textContent = `ÂΩìÂâçÔºö${width}√ó${height} (${name})`;
            }
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.size-option .check-icon').forEach(icon => {
                icon.style.display = 'none';
            });
            document.querySelectorAll('.size-option').forEach(option => {
                option.style.backgroundColor = '';
            });
            
            // ÊòæÁ§∫ÂΩìÂâçÈÄâ‰∏≠È°πÁöÑÂãæÈÄâÂõæÊ†á
            const currentOption = event.target.closest('.size-option');
            if (currentOption) {
                const checkIcon = currentOption.querySelector('.check-icon');
                if (checkIcon) {
                    checkIcon.style.display = 'block';
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÂãæÈÄâÂõæÊ†áÔºåÂàõÂª∫‰∏Ä‰∏™
                    const newCheckIcon = document.createElement('i');
                    newCheckIcon.className = 'fas fa-check check-icon';
                    newCheckIcon.style.display = 'block';
                    currentOption.appendChild(newCheckIcon);
                }
                currentOption.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
            }
            
            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('screenSize', JSON.stringify({width, height, name}));
            
            // ÊòæÁ§∫ÊèêÁ§∫
            showToast(`Â±èÂπïÂ∞∫ÂØ∏Â∑≤ÂàáÊç¢‰∏∫${name}ÔºÅ`, 'success');
            
            // Âª∂Ëøü‰∏ÄÁÇπÂÜçËøîÂõûÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÈÄâÊã©ÊïàÊûú
            setTimeout(() => {
                showApp('appearance-screen');
            }, 300);
        }
        
        // Âä†ËΩΩÂ±èÂπïÂ∞∫ÂØ∏ËÆæÁΩÆ
        function loadScreenSize() {
            const saved = localStorage.getItem('screenSize');
            if (saved) {
                const {width, height, name} = JSON.parse(saved);
                const phoneScreen = document.getElementById('phone-screen');
                phoneScreen.style.width = width + 'px';
                phoneScreen.style.height = height + 'px';
                
                const currentSizeDesc = document.getElementById('current-screen-size');
                if (currentSizeDesc) {
                    currentSizeDesc.textContent = `ÂΩìÂâçÔºö${width}√ó${height} (${name})`;
                }
            }
        }
        
        // Âä†ËΩΩËæπÊ°ÜËÆæÁΩÆ
        function loadPhoneBorderSetting() {
            const saved = localStorage.getItem('phoneBorderEnabled');
            const toggle = document.getElementById('phone-border-toggle');
            
            // ÈªòËÆ§ÂÖ≥Èó≠ËæπÊ°Ü
            const enabled = saved !== null ? saved === 'true' : false;
            
            if (toggle) {
                toggle.checked = enabled;
            }
            
            // Â∫îÁî®ËÆæÁΩÆ
            const phoneFrame = document.getElementById('phone-frame');
            const phoneScreen = document.getElementById('phone-screen');
            const body = document.body;
            
            if (enabled) {
                // ÊòæÁ§∫ÁúüÂÆûÊâãÊú∫ËæπÊ°Ü
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '12px';
                phoneFrame.style.backgroundColor = '#fff';
                phoneFrame.style.borderRadius = '50px';
                phoneFrame.style.boxShadow = '0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1)';
                phoneScreen.style.borderRadius = '40px';
                phoneScreen.style.border = '2px solid #333';
                body.style.background = 'var(--body-bg, #dcdcdc)';
                body.style.padding = '20px';
            } else {
                // ÈöêËóèËæπÊ°ÜÔºå‰ΩÜ‰øùÊåÅphone-screenÁöÑÂúÜËßíÂíåÈò¥ÂΩ±
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '0';
                phoneFrame.style.backgroundColor = 'transparent';
                phoneFrame.style.borderRadius = '0';
                phoneFrame.style.boxShadow = 'none';
                phoneScreen.style.borderRadius = '25px';
                phoneScreen.style.border = 'none';
                phoneScreen.style.boxShadow = 'var(--shadow-phone)';
                body.style.background = 'var(--body-bg, #1a1a1a)';
                body.style.padding = '0';
            }
        }
        
        // Ê∑ªÂä†ToastÊèêÁ§∫ÂáΩÊï∞
        function showToast(message, type = 'info') {
            // ÂàõÂª∫toastÂÖÉÁ¥†
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                opacity: 0;
                transition: opacity 0.3s ease;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // ÊòæÁ§∫toast
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // ÊñáÊú¨Êà™Êñ≠ÂáΩÊï∞
        function truncateText(text, maxLength = 50) {
    // --- Êñ∞Â¢ûÁöÑÂÆâÂÖ®Ê£ÄÊü• ---
    let textStr = '';
    if (typeof text === 'string') {
        textStr = text;
    } else if (text && typeof text === 'object') {
        // Â¶ÇÊûúÊî∂Âà∞‰∫Ü‰∏Ä‰∏™ÂØπË±°ÔºåÂèØËÉΩÊòØ[object Object]ÈóÆÈ¢òÁöÑÊ†πÊ∫êÔºå
        // Êàë‰ª¨‰∏çÂÜçËÆ©ÂÆÉÂ¥©Ê∫ÉÔºåËÄåÊòØÊòæÁ§∫‰∏Ä‰∏™ÈÄöÁî®Âç†‰ΩçÁ¨¶„ÄÇ
        console.warn("truncateText ÂáΩÊï∞Êî∂Âà∞‰∫Ü‰∏Ä‰∏™ÂØπË±°ÔºåÂ∑≤Ëá™Âä®Â§ÑÁêÜ:", text);
        return '[Â§öÂ™í‰ΩìÊ∂àÊÅØ]';
    } else {
        // ÂØπ‰∫éÂÖ∂‰ªñÊÑèÂ§ñÊÉÖÂÜµ (Â¶Ç null Êàñ undefined)ÔºåËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤„ÄÇ
        return '';
    }
    // --- ÂÆâÂÖ®Ê£ÄÊü•ÁªìÊùü ---

    // Áé∞Âú® textStr ‰øùËØÅÊòØ‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÔºåÂêéÁª≠‰ª£Á†ÅÂèØ‰ª•ÂÆâÂÖ®ÊâßË°å
            const plainText = textStr.replace(/<[^>]*>/g, '');
            const cleanText = plainText.replace(/\s+/g, ' ').trim();
            
            if (cleanText.length <= maxLength) {
                return cleanText;
            }
            
            return cleanText.substring(0, maxLength) + '...';
        }

        // Ê∑ªÂä†Âçï‰∏™Ê∂àÊÅØÂπ∂Â∫îÁî®Âä®ÁîªÊïàÊûú
        function addMessageWithAnimation(message, characterId) {
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer || !currentChatCharacter || characterId !== currentChatCharacter.id) return;
            
            const chatSettings = getCurrentChatSettings();
            const typingIndicator = document.getElementById('typing-indicator');
            
            // Â§ÑÁêÜÁ≥ªÁªüÊ∂àÊÅØ
            if (message.sender === 'system') {
                let systemElement;
                
                if (message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    systemContainer.appendChild(systemMessage);
                    systemElement = systemContainer;
                } else if (message.type === 'recalled_message') {
                    const centerContainer = document.createElement('div');
                    centerContainer.style.display = 'flex';
                    centerContainer.style.justifyContent = 'center';
                    centerContainer.style.margin = '4px 0';
                    centerContainer.dataset.messageId = message.id;
                    
                    const recallElement = document.createElement('div');
                    recallElement.className = 'recalled-message';
                    
                    const lines = message.content.split('\n');
                    const mainText = lines[0];
                    const originalText = lines[1];
                    
                    recallElement.textContent = mainText;
                    
                    if (originalText && originalText.startsWith('ÂéüÊñáÔºö')) {
                        const originalDiv = document.createElement('div');
                        originalDiv.className = 'original-text';
                        originalDiv.textContent = originalText;
                        recallElement.appendChild(originalDiv);
                    }
                    
                    centerContainer.appendChild(recallElement);
                    systemElement = centerContainer;
                    addMessageLongPressListener(centerContainer, message.id);
                } else {
                    const centerContainer = document.createElement('div');
                    centerContainer.style.display = 'flex';
                    centerContainer.style.justifyContent = 'center';
                    centerContainer.style.margin = '4px 0';
                    
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'system-message';
                    systemContainer.textContent = message.content;
                    
                    centerContainer.appendChild(systemContainer);
                    systemElement = centerContainer;
                }
                
                // ‰∏∫Á≥ªÁªüÊ∂àÊÅØÊ∑ªÂä†ÊªëÂÖ•Âä®Áîª
                systemElement.style.opacity = '0';
                systemElement.style.transform = 'translateY(20px)';
                
                messagesContainer.insertBefore(systemElement, typingIndicator);
                
                // Ëß¶ÂèëÂä®Áîª
                requestAnimationFrame(() => {
                    systemElement.classList.add('message-slide-in');
                });
                
                return;
            }
            
            // ÂàõÂª∫ÊôÆÈÄöÊ∂àÊÅØÂÆπÂô®
            let messageContainer = document.createElement('div');
            const isEmojiOnly = message.isEmoji && !message.content;
            messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
            messageContainer.dataset.messageId = message.id;
            
            if (message.sender === 'received') {
                // ==== Áæ§ËÅäÊîØÊåÅ ====
                let character = characters.find(c => c.id === characterId);
                let isGroup = false;
                let group = null;
                if (!character) {
                    group = groupChats.find(g => g.id === characterId);
                    if (group) {
                        isGroup = true;
                    }
                }
                
                let displayAvatar = '';
                let displayName = '';
                let color = '#4CAF50';
                
                if (isGroup && group) {
                    // Áæ§ËÅäÔºöÊ†πÊçÆÊ∂àÊÅØÁöÑsenderIdÊàñnameÊü•ÊâæÊàêÂëò
                    let member = null;
                    if (message.senderId) {
                        member = group.members.find(m => m.id === message.senderId);
                    } else if (message.name) {
                        member = group.members.find(m => m.name === message.name);
                    }
                    displayAvatar = member?.avatarUrl || '';
                    displayName = member?.name || 'Áæ§ÊàêÂëò';
                    color = member?.color || '#4CAF50';
                } else if (character) {
                    // ÂçïËÅä
                    displayAvatar = chatSettings.aiDynamicAvatar || chatSettings.aiChatAvatar || character.avatarUrl;
                    displayName = chatSettings.aiChatNickname || character.name;
                    color = character.color || '#4CAF50';
                } else {
                    // ÂÖúÂ∫ïÔºåÈò≤Ê≠¢Êä•Èîô
                    displayAvatar = '';
                    displayName = 'Êú™Áü•';
                    color = '#4CAF50';
                }
                
                // üî•„ÄêÊñ∞Â¢û„ÄëËé∑ÂèñÊ∞îÊ≥°Ê†∑Âºè - Áæ§ËÅä‰∏≠‰ΩøÁî®ÊàêÂëò‰∏ìÂ±ûÈ¢úËâ≤
                let bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                
                // Â¶ÇÊûúÊòØÁæ§ËÅä‰∏îÊúâÊàêÂëò‰∏ìÂ±ûÈ¢úËâ≤ËÆæÁΩÆÔºå‰ΩøÁî®ÊàêÂëò‰∏ìÂ±ûÈ¢úËâ≤
                if (isGroup && group && message.senderId && chatSettings.memberBubbleColors) {
                    const memberColor = chatSettings.memberBubbleColors[message.senderId];
                    if (memberColor) {
                        bubbleColor = memberColor;
                    }
                }
                
                const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                const bubblePadding = chatSettings.bubblePadding || '12';
                
                // Â§ÑÁêÜÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                let messageContent = '';
                
                if (message.type === 'voice_message') {
                    // AIËØ≠Èü≥Ê∂àÊÅØÁõ¥Êé•ÂàõÂª∫voice-message-containerÁªìÊûÑÔºå‰∏çÈúÄË¶ÅÂú®ËøôÈáåÂàõÂª∫messageContent
                    messageContent = '';
                } else if (message.type === 'ai_image') {
                    messageContent = `
                        <div class="ai-image-container">
                            <img src="${message.image}" class="message-image" onclick="showImage('${message.image}')" alt="AIÁîüÊàêÁöÑÂõæÁâá">
                            <div class="image-description">${message.imageDescription || ''}</div>
                        </div>
                    `;
                } else if (message.type === 'transfer') {
                    // ËΩ¨Ë¥¶Ê∂àÊÅØ
                    const isUser = message.role === 'user';
                    const heartIcon = isUser ? 'üíï' : 'üíñ';
                    const titleText = isUser ? '‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶' : 'Êî∂Âà∞ËΩ¨Ë¥¶';
                    let cardClass = '';
                    let statusHtml = '';
                    let clickHandler = '';
                    
                    if (message.status === 'accepted') {
                        statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ' : 'Â∑≤Êî∂Ê¨æ'}</div>`;
                        cardClass = 'accepted';
                    } else if (message.status === 'rejected') {
                        statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤ÈÄÄÂõû' : 'Â∑≤ÈÄÄÂõû'}</div>`;
                        cardClass = 'rejected';
                    } else if (!isUser) {
                        // AIÂèëÊù•ÁöÑËΩ¨Ë¥¶‰∏îÊú™Â§ÑÁêÜÔºåÊ∑ªÂä†ÁÇπÂáªÂ§ÑÁêÜ
                        clickHandler = `onclick="showTransferConfirmDialog(${JSON.stringify(message).replace(/"/g, '&quot;')})"`;
                    }
                    
                    messageContent = `
                        <div class="transfer-message-container received">
                            <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}" ${clickHandler}>
                                <div class="transfer-title">${heartIcon} ${titleText}</div>
                                <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                ${statusHtml}
                            </div>
                        </div>
                    `;
                } else {
                    const chatMode = chatSettings.chatMode || 'online';
                    let processedContent = message.content;
                    
                    if (chatMode === 'offline') {
                        processedContent = processOfflineContent(message.content);
                    }
                    
                    // Â¶ÇÊûúÊúâÂºïÁî®Ê∂àÊÅØÔºåÂú®ÂÜÖÂÆπÂâçÊ∑ªÂä†ÂºïÁî®ÊòæÁ§∫
                    if (message.replyTo) {
                        messageContent = generateReplyHTML(message.replyTo) + processedContent;
                    } else {
                    messageContent = processedContent;
                    }
                }
                
                let avatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    avatarHtml = `
                        <div class="message-avatar" style="background-color: ${color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" ${character ? `onclick="pokeCharacter('${character.id}')" title="Êà≥‰∏ÄÊà≥"` : `title="${displayName}"`}>
                            ${displayAvatar ? '' : displayName.charAt(0)}
                        </div>
                    `;
                }
                
                const transparentBubbleColor = convertColorWithOpacity(bubbleColor, bubbleOpacity);
                
                let bubbleHtml = '';
                if (message.type === 'transfer') {
                    // ËΩ¨Ë¥¶Ê∂àÊÅØ‰∏çÈúÄË¶ÅÊ∞îÊ≥°ÂåÖË£π
                    bubbleHtml = messageContent;
                } else {
                    // ÊôÆÈÄöÊ∂àÊÅØÁî®Ê∞îÊ≥°ÂåÖË£π
                    bubbleHtml = `
                    <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                        ${messageContent}
                        ${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                        ${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ''}
                    </div>
                `;
                }
                
          // üî•„Äê‰øÆÂ§ç„ÄëÁæ§ËÅäÊòµÁß∞ÊòæÁ§∫ ÔºàÁ¨¨‰∏â‰∏™Ê∏≤ÊüìÂáΩÊï∞ÁâàÊú¨Ôºâ- ÁâπÂà´Â§ÑÁêÜËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØ
          if (isGroup && group && displayName !== 'Áæ§ÊàêÂëò') {
    messageContainer.classList.add('group-message-item');
    const senderNameHtml = `<div class="sender-name">${displayName}</div>`;
    
    if (message.type === 'voice_message' || message.type === 'transfer') {
        // üî•„Äê‰øÆÂ§ç„ÄëÂØπ‰∫éËØ≠Èü≥Ê∂àÊÅØÂíåËΩ¨Ë¥¶Ê∂àÊÅØÔºåÊòµÁß∞ÈúÄË¶ÅÂú®ÂÆπÂô®Â§ñÈÉ®
    messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    } else {
        // ÊôÆÈÄöÊ∂àÊÅØÁöÑÂ§ÑÁêÜ
        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${bubbleHtml}</div>`;
    }
} else {
                messageContainer.innerHTML = avatarHtml + bubbleHtml;
}
                
                // üî•„Äê‰øÆÂ§ç„ÄëÂ¶ÇÊûúÊòØËØ≠Èü≥Ê∂àÊÅØÔºåÊåâÁÖßrenderChatMessagesÁöÑÁªìÊûÑÂàõÂª∫Ôºå‰ΩÜË¶Å‰øùÁïôÁæ§ËÅäÊòµÁß∞
                if (message.type === 'voice_message') {
                    // ËøáÊª§ÊéâÊã¨Âè∑‰∏≠ÁöÑÊèèËø∞ÊÄßÂÜÖÂÆπÔºå‰øùÁïôÂÆûÈôÖËØ¥ËØùÂÜÖÂÆπ
                    const cleanVoiceContent = message.content.replace(/\([^)]*\)\s*/g, '').trim();
                    const duration = message.duration || Math.max(1, Math.ceil(cleanVoiceContent.length / 8));
                    const durationFormatted = duration < 60 ? `0:${String(duration).padStart(2, '0')}''` : `${Math.floor(duration/60)}:${String(duration%60).padStart(2, '0')}''`;
                    
                    const voiceMessageHTML = `
                        <div class="voice-message-container received">
                            <div class="message-bubble" style="background-color: ${transparentBubbleColor}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                                <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${cleanVoiceContent}">
                                    <div class="voice-wave">
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                    </div>
                                    <div class="voice-duration">${durationFormatted}</div>
                                    ${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ""}
                                </div>
                            </div>
                            <div class="voice-text-content">${cleanVoiceContent}</div>
                        </div>
                    `;
                    
                    // üî•„Äê‰øÆÂ§ç„Äë‰øùÁïôÁæ§ËÅäÊòµÁß∞ÊòæÁ§∫
                    if (isGroup && group && displayName !== 'Áæ§ÊàêÂëò') {
                        const senderNameHtml = `<div class="sender-name">${displayName}</div>`;
                        messageContainer.innerHTML = avatarHtml + `<div class="bubble-wrapper">${senderNameHtml}${voiceMessageHTML}</div>`;
                    } else {
                    messageContainer.innerHTML = avatarHtml + voiceMessageHTML;
                    }
                }
            } else {
                // Áî®Êà∑Ê∂àÊÅØ
                let myDisplayAvatar = chatSettings.myChatAvatar;
                
                if (!myDisplayAvatar && chatSettings.selectedIdentityId) {
                    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                    if (selectedPersona && selectedPersona.avatarUrl) {
                        myDisplayAvatar = selectedPersona.avatarUrl;
                    }
                }
                
                const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                const myBubblePadding = chatSettings.bubblePadding || '12';
                
                const transparentMyBubbleColor = convertColorWithOpacity(myBubbleColor, myBubbleOpacity);
                
                let myBubbleHtml = '';
                if (message.type === 'voice') {
                    const duration = message.duration || Math.max(1, Math.ceil(message.content.length / 8));
                    
                    myBubbleHtml = `
                        <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                            <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                <div class="voice-wave">
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                    <div class="wave-bar"></div>
                                </div>
                                <div class="voice-duration">${duration}"</div>
                            ${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ""}
                            </div>
                        </div>
                    `;
                } else if (message.type === 'location') {
                    // ‰ΩçÁΩÆÊ∂àÊÅØ
                    myBubbleHtml = `
                        <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                            <div class="location-title">${message.locationName}</div>
                            <div class="location-card-map">
                                ${generateRealisticMapHTML()}
                            </div>
                        </div>
                    `;
                } else if (message.type === 'transfer') {
                    // Áî®Êà∑ËΩ¨Ë¥¶Ê∂àÊÅØ
                    let cardClass = '';
                    let statusHtml = '';
                    
                    if (message.status === 'accepted') {
                        statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤Êî∂Ê¨æ</div>`;
                        cardClass = 'accepted';
                    } else if (message.status === 'rejected') {
                        statusHtml = `<div class="transfer-status">ÂØπÊñπÂ∑≤ÈÄÄÂõû</div>`;
                        cardClass = 'rejected';
                    }
                    
                    myBubbleHtml = `
                        <div class="transfer-message-container sent">
                            <div class="transfer-card ${cardClass}" data-transfer-id="${message.timestamp}">
                                <div class="transfer-title">üíï ‰Ω†ÂèëËµ∑ÁöÑËΩ¨Ë¥¶</div>
                                <div class="transfer-amount">¬• ${Number(message.amount).toFixed(2)}</div>
                                <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                ${statusHtml}
                            </div>
                        </div>
                    `;
                } else {
                    // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØÊàñÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ (Á¨¨‰∏â‰∏™Ê∏≤ÊüìÂáΩÊï∞ÁâàÊú¨)
                    let messageContentStr = '';
                    if (Array.isArray(message.content)) {
                        // Êñ∞ÁöÑÂ§öÊ®°ÊÄÅÊ†ºÂºè
                        const textPart = message.content.find(p => p.type === 'text');
                        const imagePart = message.content.find(p => p.type === 'image_url');
                        
                        messageContentStr = textPart?.text || '';
                        
                        // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáÊòæÁ§∫
                        if (imagePart?.image_url?.url) {
                            if (messageContentStr) {
                                messageContentStr += '<br>';
                            }
                            messageContentStr += `<img src="${imagePart.image_url.url}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${imagePart.image_url.url}')">`;
                        }
                    } else {
                        // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØÊàñÊóßÊ†ºÂºè
                        let baseContent = message.content;
                        
                        // Â¶ÇÊûúÊúâÂºïÁî®Ê∂àÊÅØÔºåÂú®ÂÜÖÂÆπÂâçÊ∑ªÂä†ÂºïÁî®ÊòæÁ§∫
                        if (message.replyTo) {
                            messageContentStr = generateReplyHTML(message.replyTo) + baseContent;
                        } else {
                            messageContentStr = baseContent;
                        }
                    }
                    
                    myBubbleHtml = `
                    <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                        ${messageContentStr}
                        ${message.image && !Array.isArray(message.content) ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                    </div>
                `;
                }
                
                let myAvatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    myAvatarHtml = `
                        <div class="message-avatar" style="background-color: #007AFF; ${myDisplayAvatar ? `background-image: url(${myDisplayAvatar}); background-size: cover; background-position: center;` : ''}">
                            ${myDisplayAvatar ? '' : '<i class="fas fa-user"></i>'}
                        </div>
                    `;
                }
                
                messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                
                // Â¶ÇÊûúÊòØËØ≠Èü≥Ê∂àÊÅØÔºåÊåâÁÖßrenderChatMessagesÁöÑÁªìÊûÑÂàõÂª∫
                if (message.type === 'voice') {
                    // ÂàõÂª∫ÂÆåÊï¥ÁöÑËØ≠Èü≥Ê∂àÊÅØHTMLÔºåÂíårenderChatMessages‰øùÊåÅ‰∏ÄËá¥
                    const voiceMessageHTML = `
                        <div class="voice-message-container sent">
                            <div class="message-bubble" style="background-color: ${transparentMyBubbleColor}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                                <div class="voice-message" onclick="toggleVoiceText(this)" data-text="${message.content}">
                                    <div class="voice-wave">
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                        <div class="wave-bar"></div>
                                    </div>
                                    <div class="voice-duration">${message.duration || Math.max(1, Math.ceil(message.content.length / 8))}"</div>
                                    ${message.edited ? `<div class="message-edited-indicator">Â∑≤ÁºñËæë</div>` : ""}
                                </div>
                            </div>
                            <div class="voice-text-content">${message.content}</div>
                        </div>
                    `;
                    
                    messageContainer.innerHTML = voiceMessageHTML + myAvatarHtml;
                }
                
                // Â¶ÇÊûúÊòØ‰ΩçÁΩÆÊ∂àÊÅØÔºåÊåâÁÖßrenderChatMessagesÁöÑÁªìÊûÑÂàõÂª∫
                if (message.type === 'location') {
                    // ÂàõÂª∫ÂÆåÊï¥ÁöÑ‰ΩçÁΩÆÊ∂àÊÅØHTMLÔºåÁ°Æ‰øù‰∏çË¢´ÂåÖË£ÖÂú®Ê∞îÊ≥°‰∏≠
                    const locationMessageHTML = `
                        <div class="location-card" onclick="showLocationDetail('${message.locationName}')">
                            <div class="location-title">${message.locationName}</div>
                            <div class="location-card-map">
                                ${generateRealisticMapHTML()}
                            </div>
                        </div>
                    `;
                    
                    messageContainer.innerHTML = locationMessageHTML + myAvatarHtml;
                }
            }
            
            // Ê∑ªÂä†ÊªëÂÖ•Âä®ÁîªÊïàÊûú - ÁÆÄÂçïËá™ÁÑ∂ÁöÑÊªëÂÖ•
            messageContainer.style.opacity = '0';
            messageContainer.style.transform = 'translateY(20px)';
            
            messagesContainer.insertBefore(messageContainer, typingIndicator);
            
            // Ëß¶ÂèëÊªëÂÖ•Âä®Áîª
            requestAnimationFrame(() => {
                messageContainer.classList.add('message-slide-in');
            });
            
            // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®
            addMessageLongPressListener(messageContainer, message.id);
            
            // Ê∑ªÂä†Âè≥ÈîÆËèúÂçïÂäüËÉΩ
            const bubble = messageContainer.querySelector('.message-bubble');
            if (bubble) {
                bubble.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showMessageMenu(message.id, e);
                });
                
                bubble.onclick = (e) => {
                    if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                        showImage(e.target.src);
                    }
                };
            }
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂ¶ÇÊûúÊòØAIÊ∂àÊÅØÔºåË∞ÉÊï¥ÂøÉÁéá
            if (message.sender === 'received' && typeof message.content === 'string') {
                adjustHeartrateForMessage(message.content, false);
            }
            
            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // Â∞ÜÈ¢úËâ≤ÂíåÈÄèÊòéÂ∫¶ËΩ¨Êç¢‰∏∫rgbaÊ†ºÂºè
        function convertColorWithOpacity(color, opacity) {
            // Â¶ÇÊûúÈ¢úËâ≤Â∑≤ÁªèÊòØrgbaÊ†ºÂºèÔºåÁõ¥Êé•ËøîÂõû
            if (color.startsWith('rgba')) {
                return color;
            }
            
            // Â¶ÇÊûúÊòØÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤ÔºåËΩ¨Êç¢‰∏∫rgba
            if (color.startsWith('#')) {
                const hex = color.slice(1);
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            
            // Â¶ÇÊûúÊòØrgbÊ†ºÂºèÔºåËΩ¨Êç¢‰∏∫rgba
            if (color.startsWith('rgb(')) {
                const rgbValues = color.match(/\d+/g);
                return `rgba(${rgbValues[0]}, ${rgbValues[1]}, ${rgbValues[2]}, ${opacity})`;
            }
            
            // Â¶ÇÊûúÊòØÈ¢úËâ≤ÂêçÁß∞ÔºåÂ∞ùËØïËΩ¨Êç¢ÔºàÁÆÄÂçïÂÆûÁé∞Ôºâ
            const colorMap = {
                'red': '255, 0, 0',
                'green': '0, 128, 0',
                'blue': '0, 0, 255',
                'white': '255, 255, 255',
                'black': '0, 0, 0',
                'gray': '128, 128, 128',
                'yellow': '255, 255, 0',
                'cyan': '0, 255, 255',
                'magenta': '255, 0, 255'
            };
            
            if (colorMap[color.toLowerCase()]) {
                return `rgba(${colorMap[color.toLowerCase()]}, ${opacity})`;
            }
            
            // Â¶ÇÊûúÊó†Ê≥ïËØÜÂà´ÔºåËøîÂõûÂéüËâ≤Âä†ÈÄèÊòéÂ∫¶Ôºà‰Ωú‰∏∫Â§áÁî®Ôºâ
            return color;
        }

        // Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆÂäüËÉΩ
        function changeFontSize(size) {
            const fontSize = parseInt(size);
            
            // Êõ¥Êñ∞È¢ÑËßàÊñáÂ≠ó
            const preview = document.getElementById('font-size-preview');
            const valueDisplay = document.getElementById('font-size-value');
            
            if (preview) {
                preview.style.fontSize = fontSize + 'px';
            }
            
            if (valueDisplay) {
                valueDisplay.textContent = fontSize + 'px';
            }
            
            // ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂÖ®Â±ÄÂ≠ó‰ΩìÂ§ßÂ∞èCSSÂèòÈáè
            document.documentElement.style.setProperty('--global-font-size', fontSize + 'px');
            
            // Â∫îÁî®Âà∞ËÅäÂ§©Ê∂àÊÅØ
            applyFontSizeToMessages(fontSize);
            
            // Â∫îÁî®Âà∞Á§æ‰∫§Âä®ÊÄÅ
            applyFontSizeToMoments(fontSize);
            
            // Â¶ÇÊûúÂΩìÂâçÊúâËÅäÂ§©ËßíËâ≤ÔºåÈáçÊñ∞Ê∏≤ÊüìÊ∂àÊÅØ‰ª•Á°Æ‰øùÊñ∞Â≠ó‰ΩìÂ§ßÂ∞èÁîüÊïà
            if (currentChatCharacter && typeof renderChatMessages === 'function') {
                setTimeout(() => {
                    renderChatMessages(currentChatCharacter.id);
                }, 100);
            }
            
            // ‰øùÂ≠òËÆæÁΩÆ
            localStorage.setItem('globalFontSize', fontSize);
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            showToast('Â≠óÂè∑ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ', 'success');
        }
        
        // Â≠óË∑ùËÆæÁΩÆÂäüËÉΩ
        function changeLetterSpacing(spacing) {
            const letterSpacing = parseFloat(spacing);
            
            // Êõ¥Êñ∞È¢ÑËßàÊñáÂ≠ó
            const preview = document.getElementById('font-size-preview');
            const valueDisplay = document.getElementById('letter-spacing-value');
            
            if (preview) {
                preview.style.letterSpacing = letterSpacing + 'px';
            }
            
            if (valueDisplay) {
                // Ê†πÊçÆÊï∞ÂÄºÊòæÁ§∫ÂØπÂ∫îÁöÑÊñáÂ≠óÊèèËø∞
                let description;
                if (letterSpacing < -0.2) {
                    description = 'ÂæàÁ¥ßÂáë';
                } else if (letterSpacing < 0.2) {
                    description = 'Ê†áÂáÜ';
                } else if (letterSpacing < 0.8) {
                    description = 'ËàíÈÄÇ';
                } else if (letterSpacing < 1.5) {
                    description = 'ÂÆΩÊùæ';
                } else {
                    description = 'ÂæàÂÆΩÊùæ';
                }
                valueDisplay.textContent = `${description} (${letterSpacing}px)`;
            }
            
            // ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂÖ®Â±ÄÂ≠óË∑ùCSSÂèòÈáè
            document.documentElement.style.setProperty('--global-letter-spacing', letterSpacing + 'px');
            
            // Â∫îÁî®Âà∞ËÅäÂ§©Ê∂àÊÅØ
            applyLetterSpacingToMessages(letterSpacing);
            
            // Â∫îÁî®Âà∞Á§æ‰∫§Âä®ÊÄÅ
            applyLetterSpacingToMoments(letterSpacing);
            
            // Â¶ÇÊûúÂΩìÂâçÊúâËÅäÂ§©ËßíËâ≤ÔºåÈáçÊñ∞Ê∏≤ÊüìÊ∂àÊÅØ‰ª•Á°Æ‰øùÊñ∞Â≠óË∑ùÁîüÊïà
            if (currentChatCharacter && typeof renderChatMessages === 'function') {
                setTimeout(() => {
                    renderChatMessages(currentChatCharacter.id);
                }, 100);
            }
            
            // ‰øùÂ≠òËÆæÁΩÆ
            localStorage.setItem('globalLetterSpacing', letterSpacing);
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            showToast('Â≠óË∑ùËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ', 'success');
        }
        
        function applyFontSizeToMessages(fontSize) {
            // Â∫îÁî®Âà∞ÊâÄÊúâËÅäÂ§©Ê∂àÊÅØÔºå‰ΩøÁî®!importantÂº∫Âà∂Ë¶ÜÁõñÂÜÖËÅîÊ†∑Âºè
            const messageBubbles = document.querySelectorAll('.message-bubble');
            messageBubbles.forEach(bubble => {
                bubble.style.setProperty('font-size', fontSize + 'px', 'important');
            });
            
            // Â∫îÁî®Âà∞ËÅäÂ§©ËæìÂÖ•Ê°Ü
            const chatInput = document.getElementById('api-chat-input');
            if (chatInput) {
                chatInput.style.fontSize = fontSize + 'px';
            }
        }
        
        function applyFontSizeToMoments(fontSize) {
            // Â∫îÁî®Âà∞ÂæÆÂçöÂä®ÊÄÅÂÜÖÂÆπ
            const postContents = document.querySelectorAll('.post-content');
            postContents.forEach(content => {
                content.style.fontSize = fontSize + 'px';
            });
            
            // Â∫îÁî®Âà∞ÂæÆÂçöËæìÂÖ•Ê°Ü
            const weiboTextarea = document.getElementById('weibo-text');
            if (weiboTextarea) {
                weiboTextarea.style.fontSize = fontSize + 'px';
            }
        }
        
        function applyLetterSpacingToMessages(letterSpacing) {
            // Â∫îÁî®Âà∞ÊâÄÊúâËÅäÂ§©Ê∂àÊÅØ
            const messageBubbles = document.querySelectorAll('.message-bubble');
            messageBubbles.forEach(bubble => {
                bubble.style.setProperty('letter-spacing', letterSpacing + 'px', 'important');
            });
            
            // Â∫îÁî®Âà∞ËÅäÂ§©ËæìÂÖ•Ê°Ü
            const chatInput = document.getElementById('api-chat-input');
            if (chatInput) {
                chatInput.style.letterSpacing = letterSpacing + 'px';
            }
        }
        
        function applyLetterSpacingToMoments(letterSpacing) {
            // Â∫îÁî®Âà∞ÂæÆÂçöÂä®ÊÄÅÂÜÖÂÆπ
            const postContents = document.querySelectorAll('.post-content');
            postContents.forEach(content => {
                content.style.letterSpacing = letterSpacing + 'px';
            });
            
            // Â∫îÁî®Âà∞ÂæÆÂçöËæìÂÖ•Ê°Ü
            const weiboTextarea = document.getElementById('weibo-text');
            if (weiboTextarea) {
                weiboTextarea.style.letterSpacing = letterSpacing + 'px';
            }
        }
        
        function toggleAutoScale() {
            const toggle = document.getElementById('auto-scale-toggle');
            const isEnabled = toggle.checked;
            
            // ‰øùÂ≠òËá™Âä®Áº©ÊîæËÆæÁΩÆ
            localStorage.setItem('autoScaleFont', isEnabled);
            
            if (isEnabled) {
                // Ê†πÊçÆÂ±èÂπïÂ∞∫ÂØ∏Ëá™Âä®Ë∞ÉÊï¥Â≠ó‰Ωì
                autoAdjustFontSize();
                showToast('Â≠ó‰ΩìËá™Âä®Áº©ÊîæÂ∑≤ÂºÄÂêØÔºÅ', 'success');
            } else {
                showToast('Â≠ó‰ΩìËá™Âä®Áº©ÊîæÂ∑≤ÂÖ≥Èó≠ÔºÅ', 'success');
            }
        }
        
        function autoAdjustFontSize() {
            const phoneScreen = document.getElementById('phone-screen');
            if (!phoneScreen) return;
            
            const screenWidth = parseInt(phoneScreen.style.width) || 350;
            
            // Ê†πÊçÆÂ±èÂπïÂÆΩÂ∫¶ËÆ°ÁÆóÊé®ËçêÂ≠ó‰ΩìÂ§ßÂ∞è
            let recommendedSize = 15; // ÈªòËÆ§Â§ßÂ∞è
            
            if (screenWidth <= 320) {
                recommendedSize = 13; // Â∞èÂ±èÂπïÁî®Â∞èÂ≠ó‰Ωì
            } else if (screenWidth <= 350) {
                recommendedSize = 14;
            } else if (screenWidth <= 375) {
                recommendedSize = 15;
            } else if (screenWidth <= 390) {
                recommendedSize = 16;
            } else {
                recommendedSize = 17; // Â§ßÂ±èÂπïÁî®Â§ßÂ≠ó‰Ωì
            }
            
            // Êõ¥Êñ∞ÊªëÂùóÂíåÂ∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞è
            const slider = document.getElementById('font-size-slider');
            if (slider) {
                slider.value = recommendedSize;
                changeFontSize(recommendedSize);
            }
        }
        
        function loadFontSizeSettings() {
            // Âä†ËΩΩÂ≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ
            const savedSize = localStorage.getItem('globalFontSize');
            const fontSize = savedSize ? parseInt(savedSize) : 15;
            
            const slider = document.getElementById('font-size-slider');
            const preview = document.getElementById('font-size-preview');
            const valueDisplay = document.getElementById('font-size-value');
            
            if (slider) {
                slider.value = fontSize;
            }
            
            if (preview) {
                preview.style.fontSize = fontSize + 'px';
            }
            
            if (valueDisplay) {
                valueDisplay.textContent = fontSize + 'px';
            }
            
            // Â∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞è
            document.documentElement.style.setProperty('--global-font-size', fontSize + 'px');
            
            // Âä†ËΩΩÂ≠óË∑ùËÆæÁΩÆ
            const savedSpacing = localStorage.getItem('globalLetterSpacing');
            const letterSpacing = savedSpacing ? parseFloat(savedSpacing) : 0;
            
            const spacingSlider = document.getElementById('letter-spacing-slider');
            const spacingValueDisplay = document.getElementById('letter-spacing-value');
            
            if (spacingSlider) {
                spacingSlider.value = letterSpacing;
            }
            
            if (preview) {
                preview.style.letterSpacing = letterSpacing + 'px';
            }
            
            if (spacingValueDisplay) {
                // Ê†πÊçÆÊï∞ÂÄºÊòæÁ§∫ÂØπÂ∫îÁöÑÊñáÂ≠óÊèèËø∞
                let description;
                if (letterSpacing < -0.2) {
                    description = 'ÂæàÁ¥ßÂáë';
                } else if (letterSpacing < 0.2) {
                    description = 'Ê†áÂáÜ';
                } else if (letterSpacing < 0.8) {
                    description = 'ËàíÈÄÇ';
                } else if (letterSpacing < 1.5) {
                    description = 'ÂÆΩÊùæ';
                } else {
                    description = 'ÂæàÂÆΩÊùæ';
                }
                spacingValueDisplay.textContent = `${description} (${letterSpacing}px)`;
            }
            
            // Â∫îÁî®Â≠óË∑ù
            document.documentElement.style.setProperty('--global-letter-spacing', letterSpacing + 'px');
            
            // Âª∂ËøüÂ∫îÁî®ÔºåÁ°Æ‰øùDOMÂÖÉÁ¥†Â∑≤ÁªèÂä†ËΩΩ
            setTimeout(() => {
                applyFontSizeToMessages(fontSize);
                applyFontSizeToMoments(fontSize);
                applyLetterSpacingToMessages(letterSpacing);
                applyLetterSpacingToMoments(letterSpacing);
            }, 500);
            
            // Âä†ËΩΩËá™Âä®Áº©ÊîæËÆæÁΩÆ
            const autoScale = localStorage.getItem('autoScaleFont');
            const autoScaleToggle = document.getElementById('auto-scale-toggle');
            if (autoScaleToggle) {
                autoScaleToggle.checked = autoScale === 'true';
            }
        }



        // Â∑•ÂÖ∑Ê†èÂäüËÉΩ
        function triggerVoiceMessage() {
            showToast('ËØ≠Èü≥ÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ËØ≠Èü≥ÂΩïÂà∂ÂäüËÉΩ
        }

        // ËÅäÂ§©ÁïåÈù¢ÊãçÁÖßÂäüËÉΩ - ÊñáÂ≠óÊèèËø∞ÂõæÁâáÂèëÈÄÅÁªôAI
        async function openCamera() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©ÂØπË±°', 'error');
                return;
            }
            
            const description = await showCustomPrompt("ÂèëÈÄÅÁÖßÁâá", "ËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÁÖßÁâáÔºö");
            if (description && description.trim()) {
                const msg = {
                    id: Date.now().toString(),
                    sender: 'sent',
                    type: 'user_photo',
                    content: description.trim(),
                    timestamp: Date.now(),
                    photoDescription: description.trim() // ‰øùÂ≠òÂéüÂßãÊèèËø∞Áî®‰∫éÁÇπÂáªÊü•Áúã
                };
                
                // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }
                chatMessages[currentChatCharacter.id].push(msg);
                await saveChatMessages();
                
                // Âà∑Êñ∞ÁïåÈù¢
                renderChatMessages(currentChatCharacter.id);
                renderMessageList();
                
                showToast('ÁÖßÁâáÂ∑≤ÂèëÈÄÅ', 'success');
            }
        }

        function openTransfer() {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂΩìÂâçËÅäÂ§©ËßíËâ≤
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ËÅäÂ§©ÂØπË±°', 'warning');
                return;
            }
            
            // ÊòæÁ§∫ËΩ¨Ë¥¶ÂØπËØùÊ°Ü
            document.getElementById('transfer-modal').classList.add('visible');
        }

        // ÈÄöËØùÁä∂ÊÄÅÂèòÈáè
        let isInCall = false;
        let callTimer = null;
        let callStartTime = null;
        let callDuration = 0;
        let isMuted = false;
        let isSpeakerOn = false;
        let currentCallCharacter = null;
        
        // ÁîüÊàêÊ∂àÊÅØIDÂáΩÊï∞
        function generateMessageId() {
            return Date.now().toString() + Math.floor(Math.random() * 1000).toString();
        }
        
        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
        function addMessageToChat(message) {
            if (!currentChatCharacter) return;
            
            const characterId = currentChatCharacter.id;
            if (!chatMessages[characterId]) {
                chatMessages[characterId] = [];
            }
            
            chatMessages[characterId].push(message);
            saveChatMessages();
            
            // Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢
            renderChatMessages(characterId);
        }

        function makeCall() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'error');
                return;
            }
            
            // Ê£ÄÊü•ËßíËâ≤‰∏ªÂä®Êã®ÊâìÁîµËØùÂºÄÂÖ≥ÔºåÁî®Êà∑‰∏ªÂä®Êã®ÊâìÊó∂‰∏çÂèóÊ≠§ÈôêÂà∂
            const currentChatSettings = getCurrentChatSettings();
            console.log('üìû Áî®Êà∑‰∏ªÂä®Êã®ÊâìÁîµËØùÔºåÂºÄÂÖ≥Áä∂ÊÄÅ:', currentChatSettings.aiCallEnabled);
            
            currentCallCharacter = currentChatCharacter;
            
            // ËÆæÁΩÆÈÄöËØùÁïåÈù¢
            const avatarSrc = currentCallCharacter.avatar || currentCallCharacter.avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightgray"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="gray">Â§¥ÂÉè</text></svg>';
            document.getElementById('call-avatar-img').src = avatarSrc;
            document.getElementById('call-name').textContent = currentCallCharacter.name;
            document.getElementById('call-status').textContent = 'Ê≠£Âú®ÈÄöËØù‰∏≠...';
            document.getElementById('call-timer').textContent = '00:00';
            
            // Ê∏ÖÁ©∫ÈÄöËØùÊ∂àÊÅØÂÆπÂô®
            document.getElementById('call-message-container').innerHTML = '';
            
            // ÊòæÁ§∫ÈÄöËØùÁïåÈù¢
            showApp('phone-call-screen');
            
            // ÂºÄÂßãËÆ°Êó∂
            startCallTimer();
            
            // ËÆæÁΩÆÈÄöËØùÁä∂ÊÄÅ
            isInCall = true;
            
            // ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
            const callStartMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `[ËØ≠Èü≥ÈÄöËØù] ‰∏é${currentCallCharacter.name}ÁöÑÈÄöËØùÂ∑≤ÂºÄÂßã`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'outgoing',
                callStatus: 'started'
            };
            
            addMessageToChat(callStartMessage);
            
            // Áî®Êà∑‰∏ªÂä®Êã®ÊâìÁîµËØùÊó∂‰∏çËá™Âä®Ê∑ªÂä†ËßíËâ≤ÂõûÂ∫îÔºåÁ≠âÂæÖÁî®Êà∑ÂÖàËØ¥ËØù
            // ËÆæÁΩÆÊ†áÂøóÔºåË°®ÊòéËøôÊòØÁî®Êà∑‰∏ªÂä®Êã®ÊâìÁöÑÁîµËØù
            window.isUserInitiatedCall = true;
        }
        
        // ËßíËâ≤‰∏ªÂä®Êã®ÊâìÁîµËØù
        async function initiateAICall(character, callReason) {
            if (isInCall) return; // Â¶ÇÊûúÂ∑≤ÁªèÂú®ÈÄöËØù‰∏≠Ôºå‰∏çÂÜçÂèëËµ∑
            
            currentCallCharacter = character;
            
            // üî•„ÄêÊÅ¢Â§ç„ÄëÂÖàÁîüÊàêËßíËâ≤ÁöÑÂºÄÂú∫ÁôΩÔºåÂÜçÊòæÁ§∫Êù•ÁîµÁïåÈù¢
            let characterGreeting = '';
            try {
                const prompt = `‰Ω†ÊòØ${character.name}ÔºåÂàöÂàöÂÜ≥ÂÆöÁªôÁî®Êà∑ÊâìÁîµËØù„ÄÇ

ËØ∑ÁîüÊàê‰∏ÄÂè•ÁÆÄÁü≠Ëá™ÁÑ∂ÁöÑÂºÄÂú∫ÁôΩÔºåËØ¥Êòé‰Ω†‰∏∫‰ªÄ‰πàË¶ÅÊâìËøô‰∏™ÁîµËØùÔºö
- Ë¶ÅÁ¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºÁâπÁÇπ
- ÂÉèÁúüÂÆûÈÄöËØùÂºÄÂßãÊó∂ÁöÑËá™ÁÑ∂Ë°®Ëææ
- 1Âè•ËØùÂç≥ÂèØÔºå‰∏çË¶ÅË∂ÖËøá20Â≠ó
- Áõ¥Êé•ËØ¥ËØùÔºå‰∏çË¶Å‰ªª‰ΩïÊ†ºÂºèÊ†áËÆ∞

‰æãÂ¶ÇÔºö
- "ÊàëÊÉ≥Âíå‰Ω†ËÅäËÅä‰ªäÂ§©ÁöÑ‰∫ãÊÉÖ"
- "Êúâ‰∏™Â•ΩÊ∂àÊÅØÊÉ≥ÂëäËØâ‰Ω†"
- "ÊÉ≥Âê¨Âê¨‰Ω†ÁöÑÂ£∞Èü≥"

ËØ∑Âè™ÂõûÂ§çÂºÄÂú∫ÁôΩÂÜÖÂÆπÔºö`;

                const response = await callChatAPI(prompt, character);
                
                // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë‰ΩøÁî®parseAiResponseËß£ÊûêÂºÄÂú∫ÁôΩ
                const parsedMessages = parseAiResponse(response);
                console.log('üîî ÂºÄÂú∫ÁôΩAIÂõûÂ§çËß£ÊûêÁªìÊûú:', parsedMessages);
                
                if (Array.isArray(parsedMessages) && parsedMessages.length > 0) {
                    // ÊâæÂà∞Á¨¨‰∏ÄÊù°Á∫ØÊñáÊú¨Ê∂àÊÅØ
                    const firstTextMessage = parsedMessages.find(msg => typeof msg === 'string');
                    if (firstTextMessage) {
                        characterGreeting = firstTextMessage.trim();
                    } else {
                        // Â¶ÇÊûúÊ≤°ÊúâÁ∫ØÊñáÊú¨ÔºåÂ∞ùËØïÊèêÂèñÂØπË±°‰∏≠ÁöÑÂÜÖÂÆπ
                        const firstMessage = parsedMessages[0];
                        if (typeof firstMessage === 'object' && firstMessage.content) {
                            characterGreeting = firstMessage.content.trim();
                        }
                    }
                } else if (typeof response === 'string') {
                    // Â§áÁî®ÔºöÂ¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÔºåÊ∏ÖÁêÜÂéüÂßãÂ≠óÁ¨¶‰∏≤
                    characterGreeting = cleanCallResponse(response).trim();
                }
                
                if (!characterGreeting || characterGreeting.length > 30) {
                    characterGreeting = callReason || 'ÊÉ≥Âíå‰Ω†ÈÄöËØù...';
                }
            } catch (error) {
                console.error('ÁîüÊàêËßíËâ≤ÂºÄÂú∫ÁôΩÂ§±Ë¥•:', error);
                characterGreeting = callReason || 'ÊÉ≥Âíå‰Ω†ÈÄöËØù...';
            }
            
            // ËÆæÁΩÆÊù•ÁîµÊòæÁ§∫ÁïåÈù¢
            const avatarSrc = character.avatar || character.avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightgray"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="gray">Â§¥ÂÉè</text></svg>';
            document.getElementById('incoming-call-avatar').src = avatarSrc;
            document.getElementById('incoming-call-name').textContent = character.name;
            document.getElementById('incoming-call-text').textContent = characterGreeting;
            
            // üî•„Äê‰øùÂ≠òÂºÄÂú∫ÁôΩ‰æõÊé•Âê¨Âêé‰ΩøÁî®„Äë
            window.aiCallGreeting = characterGreeting;
            
            // Ê∑ªÂä†ÊåØÈìÉÂä®Áîª
            document.getElementById('incoming-call-avatar').classList.add('ringing-animation');
            
            // ÊòæÁ§∫Êù•ÁîµÁïåÈù¢
            showApp('incoming-call-screen');
            
            // Êí≠ÊîæÊù•ÁîµÈìÉÂ£∞ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
            // playRingtone();
            
            // ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
            const incomingCallMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `[ËØ≠Èü≥ÈÄöËØù] ${character.name}Ê≠£Âú®ÂëºÂè´‰Ω†`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'incoming',
                callStatus: 'ringing'
            };
            
            addMessageToChat(incomingCallMessage);
            
            // Â¶ÇÊûú30ÁßíÂÜÖÊ≤°ÊúâÊé•Âê¨ÔºåËá™Âä®ÊåÇÊñ≠
            setTimeout(() => {
                if (document.getElementById('incoming-call-screen').style.display !== 'none') {
                    rejectCall();
                }
            }, 30000);
        }
        
        // Êé•ÂèóÊù•Áîµ
        function acceptCall() {
            // ÂÅúÊ≠¢ÊåØÈìÉÂä®Áîª
            document.getElementById('incoming-call-avatar').classList.remove('ringing-animation');
            
            // ÈöêËóèÊù•ÁîµÁïåÈù¢
            hideApp('incoming-call-screen');
            
            // ËÆæÁΩÆÈÄöËØùÁïåÈù¢
            const avatarSrc = currentCallCharacter.avatar || currentCallCharacter.avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="lightgray"/><text x="50" y="60" font-size="30" text-anchor="middle" fill="gray">Â§¥ÂÉè</text></svg>';
            document.getElementById('call-avatar-img').src = avatarSrc;
            document.getElementById('call-name').textContent = currentCallCharacter.name;
            document.getElementById('call-status').textContent = 'Ê≠£Âú®ÈÄöËØù‰∏≠...';
            document.getElementById('call-timer').textContent = '00:00';
            
            // Ê∏ÖÁ©∫ÈÄöËØùÊ∂àÊÅØÂÆπÂô®
            document.getElementById('call-message-container').innerHTML = '';
            
            // ÊòæÁ§∫ÈÄöËØùÁïåÈù¢
            showApp('phone-call-screen');
            
            // ÂºÄÂßãËÆ°Êó∂
            startCallTimer();
            
            // ËÆæÁΩÆÈÄöËØùÁä∂ÊÄÅ
            isInCall = true;
            
            // ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
            const callAcceptedMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `[ËØ≠Èü≥ÈÄöËØù] Â∑≤Êé•Âê¨${currentCallCharacter.name}ÁöÑÊù•Áîµ`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'incoming',
                callStatus: 'accepted'
            };
            
            addMessageToChat(callAcceptedMessage);
            
            // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®AIÁîüÊàêÁöÑÂºÄÂú∫ÁôΩÊàñÈªòËÆ§ÈóÆÂÄô
            setTimeout(() => {
                let initialResponse = window.aiCallGreeting || getRandomCallGreeting(currentCallCharacter.name);
                addCallMessage(initialResponse, 'received');
                // Ê∏ÖÁêÜÂºÄÂú∫ÁôΩÁºìÂ≠ò
                window.aiCallGreeting = null;
            }, 1000);
        }
        
        // ÊãíÁªùÊù•Áîµ
        function rejectCall() {
            // ÂÅúÊ≠¢ÊåØÈìÉÂä®Áîª
            document.getElementById('incoming-call-avatar').classList.remove('ringing-animation');
            
            // ÈöêËóèÊù•ÁîµÁïåÈù¢
            hideApp('incoming-call-screen');
            
            // ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
            const callRejectedMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `[ËØ≠Èü≥ÈÄöËØù] Â∑≤ÊãíÁªù${currentCallCharacter.name}ÁöÑÊù•Áîµ`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'incoming',
                callStatus: 'rejected'
            };
            
            addMessageToChat(callRejectedMessage);
            
            currentCallCharacter = null;
        }
        
        // ÁªìÊùüÈÄöËØù
        function endCall() {
            if (!isInCall) return;
            
            // ÂÅúÊ≠¢ËÆ°Êó∂
            stopCallTimer();
            
            // ÈöêËóèÈÄöËØùÁïåÈù¢
            hideApp('phone-call-screen');
            
            // ËøîÂõûËÅäÂ§©ÁïåÈù¢
            showApp('api-chat-screen');
            
            // ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
            const formattedDuration = formatCallDuration(callDuration);
            const callEndedMessage = {
                id: generateMessageId(),
                sender: 'system',
                content: `[ËØ≠Èü≥ÈÄöËØù] ‰∏é${currentCallCharacter.name}ÁöÑÈÄöËØùÂ∑≤ÁªìÊùü`,
                timestamp: Date.now(),
                type: 'call_record',
                callType: 'ended',
                callStatus: 'completed',
                duration: formattedDuration
            };
            
            addMessageToChat(callEndedMessage);
            
            // ÈáçÁΩÆÈÄöËØùÁä∂ÊÄÅ
            isInCall = false;
            isMuted = false;
            isSpeakerOn = false;
            
            currentCallCharacter = null;
        }
        
        // ÈùôÈü≥/ÂèñÊ∂àÈùôÈü≥
        function toggleMute() {
            isMuted = !isMuted;
            const muteBtn = document.getElementById('mute-btn');
            
            if (isMuted) {
                muteBtn.classList.add('muted');
                muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                showToast('Â∑≤ÈùôÈü≥', 'info');
            } else {
                muteBtn.classList.remove('muted');
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                showToast('Â∑≤ÂèñÊ∂àÈùôÈü≥', 'info');
            }
        }
        
        // Êâ¨Â£∞Âô®ÂºÄÂÖ≥
        function toggleSpeaker() {
            isSpeakerOn = !isSpeakerOn;
            const speakerBtn = document.getElementById('speaker-btn');
            
            if (isSpeakerOn) {
                speakerBtn.classList.add('active');
                showToast('Â∑≤ÂºÄÂêØÊâ¨Â£∞Âô®', 'info');
            } else {
                speakerBtn.classList.remove('active');
                showToast('Â∑≤ÂÖ≥Èó≠Êâ¨Â£∞Âô®', 'info');
            }
        }
        
        // ÂºÄÂßãÈÄöËØùËÆ°Êó∂Âô®
        function startCallTimer() {
            callStartTime = new Date();
            callDuration = 0;
            
            callTimer = setInterval(() => {
                callDuration = Math.floor((new Date() - callStartTime) / 1000);
                document.getElementById('call-timer').textContent = formatCallDuration(callDuration);
            }, 1000);
        }
        
        // ÂÅúÊ≠¢ÈÄöËØùËÆ°Êó∂Âô®
        function stopCallTimer() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
        }
        
        // Ê†ºÂºèÂåñÈÄöËØùÊó∂Èïø
        function formatCallDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // Âú®ÈÄöËØùÁïåÈù¢ÂèëÈÄÅÊ∂àÊÅØ
        function sendCallMessage() {
            const input = document.getElementById('call-input');
            if (!input) {
                console.error('Êâæ‰∏çÂà∞ÈÄöËØùËæìÂÖ•Ê°ÜÂÖÉÁ¥†');
                return;
            }
            
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÈÄöËØùÁïåÈù¢
            addCallMessage(message, 'sent');
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            input.value = '';
            
            // ÊòæÁ§∫AIÊ≠£Âú®ËØ¥ËØùÁöÑÊåáÁ§∫Âô®
            const typingIndicator = showCallTypingIndicator();
            
            // Ê†πÊçÆÈÄöËØùÁ±ªÂûãÂÜ≥ÂÆöÊòØÂê¶ÂõûÂ§ç
            if (currentCallCharacter) {
                setTimeout(async () => {
                    try {
                        // üî•„Äê‰øÆÂ§ç„ÄëÊûÑÂª∫Êõ¥Â•ΩÁöÑËØ≠Èü≥ÈÄöËØùÊèêÁ§∫ËØç
                        const prompt = `‰Ω†ÊòØ${currentCallCharacter.name}ÔºåÊ≠£Âú®‰∏éÁî®Êà∑ËøõË°åËØ≠Èü≥ÈÄöËØù„ÄÇ
Áî®Êà∑ÂàöËØ¥Ôºö"${message}"

ËØ∑Áî®ÁÆÄÁü≠Ëá™ÁÑ∂ÁöÑÂè£ËØ≠ÊñπÂºèÂõûÂ§çÔºåÂ∞±ÂÉèÁúüÂÆûÁöÑÁîµËØùÂØπËØù‰∏ÄÊ†∑Ôºö
- Áõ¥Êé•ËØ¥ËØùÔºå‰∏çË¶Å‰ªª‰ΩïÊèèËø∞ÊÄßÊñáÂ≠ó
- ‰øùÊåÅËá™ÁÑ∂ÁöÑËØ≠Èü≥ÂØπËØùÈ£éÊ†º
- ÂõûÂ§çË¶ÅÁÆÄÊ¥ÅÔºå1-2Âè•ËØùÂç≥ÂèØ
- Á¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºËÆæÂÆö

ËØ∑Âè™ÂõûÂ§çÂØπËØùÂÜÖÂÆπÔºå‰∏çË¶ÅJSONÊ†ºÂºèÔºå‰∏çË¶ÅÂÖ∂‰ªñÊ†ºÂºèÔºö`;
                        
                        try {
                            const response = await callChatAPI(prompt, currentCallCharacter);
                            
                            // ÁßªÈô§ËæìÂÖ•ÊåáÁ§∫Âô®
                            hideCallTypingIndicator(typingIndicator);
                            
                            // üî•„ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë‰ΩøÁî®parseAiResponseËß£ÊûêÂõûÂ§çÔºåÊòæÁ§∫ÊâÄÊúâÊñáÊú¨Ê∂àÊÅØ
                            const parsedMessages = parseAiResponse(response);
                            console.log('üîî ÈÄöËØùAIÂõûÂ§çËß£ÊûêÁªìÊûú:', parsedMessages);
                            
                            let hasValidMessage = false;
                            if (Array.isArray(parsedMessages) && parsedMessages.length > 0) {
                                // ÈÅçÂéÜÊâÄÊúâÊ∂àÊÅØÔºåÊòæÁ§∫ÊØè‰∏ÄÊù°ÊñáÊú¨Ê∂àÊÅØ
                                for (const msg of parsedMessages) {
                                    let replyText = '';
                                    if (typeof msg === 'string') {
                                        replyText = msg.trim();
                                    } else if (typeof msg === 'object' && msg.content) {
                                        replyText = msg.content.trim();
                                    }
                                    
                                    if (replyText) {
                                        addCallMessage(replyText, 'received');
                                        hasValidMessage = true;
                                        // Ê∑ªÂä†Áü≠ÊöÇÂª∂ËøüÔºåËÆ©Â§öÊù°Ê∂àÊÅØÂàÜÂºÄÊòæÁ§∫
                                        await new Promise(resolve => setTimeout(resolve, 300));
                                    }
                                }
                            }
                            
                            // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÊ∂àÊÅØÔºå‰ΩøÁî®Â§áÁî®ÂõûÂ§ç
                            if (!hasValidMessage) {
                                if (typeof response === 'string') {
                                    const cleanedText = cleanCallResponse(response);
                                    if (cleanedText) {
                                        addCallMessage(cleanedText, 'received');
                                    } else {
                                        addCallMessage(getRandomCallResponse(), 'received');
                                    }
                                } else {
                                    addCallMessage(getRandomCallResponse(), 'received');
                                }
                            }
                            
                        } catch (error) {
                            console.error('Ëé∑ÂèñAIÂõûÂ§çÂ§±Ë¥•:', error);
                            hideCallTypingIndicator(typingIndicator);
                            addCallMessage(getRandomCallResponse(), 'received');
                        }
                        
                    } catch (error) {
                        console.error('ÈÄöËØùÂõûÂ§çÈîôËØØ:', error);
                        hideCallTypingIndicator(typingIndicator);
                        addCallMessage('ÊàëÊòéÁôΩ‰∫Ü', 'received');
                    }
                }, 1000 + Math.random() * 1000);
            }
        }
        
        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÈÄöËØùÁïåÈù¢
        function addCallMessage(message, type) {
            const container = document.getElementById('call-message-container');
            const messageElement = document.createElement('div');
            messageElement.className = `call-message ${type}`;
            messageElement.textContent = message;
            
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
            
            // üî•„Äê‰øÆÂ§ç„ÄëÂêåÊó∂Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩïÔºå‰ΩÜÊ†áËÆ∞‰∏∫ÈÄöËØùÊ∂àÊÅØ
            if (currentChatCharacter && currentChatCharacter.id) {
                const callMessage = {
                    id: generateMessageId(),
                    sender: type === 'sent' ? 'sent' : 'received',  // ‰øÆÂ§çÔºö‰ΩøÁî®Ê≠£Á°ÆÁöÑsenderÊ†ºÂºè
                    content: message,
                    timestamp: Date.now(),
                    isCallMessage: true,
                    type: 'call_message'  // Ê∑ªÂä†ÁâπÊÆäÁ±ªÂûãÊ†áËÆ∞
                };
                
                if (!chatMessages[currentChatCharacter.id]) {
                    chatMessages[currentChatCharacter.id] = [];
                }
                
                chatMessages[currentChatCharacter.id].push(callMessage);
                saveChatMessages();
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊòæÁ§∫AIÊ≠£Âú®ËØ¥ËØùÁöÑÊåáÁ§∫Âô®
        function showCallTypingIndicator() {
            const container = document.getElementById('call-message-container');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'call-typing-indicator';
            typingIndicator.innerHTML = `
                <div class="call-typing-dots">
                    <div class="call-typing-dot"></div>
                    <div class="call-typing-dot"></div>
                    <div class="call-typing-dot"></div>
                </div>
            `;
            
            container.appendChild(typingIndicator);
            container.scrollTop = container.scrollHeight;
            
            return typingIndicator;
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÈöêËóèAIÊ≠£Âú®ËØ¥ËØùÁöÑÊåáÁ§∫Âô®
        function hideCallTypingIndicator(indicator) {
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }

        // üî•„ÄêÁÆÄÂåñ„ÄëÊ∏ÖÁêÜÈÄöËØùÂõûÂ§çÊñáÊú¨ - Âõ†‰∏∫Â∑≤ÁªèÁî®parseAiResponseÂ§ÑÁêÜJSONÊ†ºÂºè
        function cleanCallResponse(text) {
            if (!text) return '';
            
            console.log('üßπ ÂéüÂßãÊñáÊú¨:', text);
            
            // Âü∫Á°ÄÊ∏ÖÁêÜÔºöÁßªÈô§Â§ö‰ΩôÁ©∫Ê†ºÂíåÊç¢Ë°å
            text = text.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
            
            // ÁßªÈô§Â∏∏ËßÅÁöÑÊèèËø∞ÊÄßÂâçÁºÄ
            text = text.replace(/^(ËßíËâ≤ËØ¥|ÊàëËØ¥|ÂõûÂ§ç|Á≠îÊ°à|ÂõûÁ≠î)[:Ôºö]\s*/i, '');
            
            // ÁßªÈô§Êã¨Âè∑‰∏≠ÁöÑÊèèËø∞ÊÄßÂÜÖÂÆπ
            text = text.replace(/\([^)]*\)/g, '');
            text = text.replace(/„Äê[^„Äë]*„Äë/g, '');
            text = text.replace(/\[[^\]]*\]/g, '');
            
            // Â¶ÇÊûúÊñáÊú¨‰ª•Ê†áÁÇπÁ¨¶Âè∑ÂºÄÂ§¥ÔºåÁßªÈô§ÂÆÉ
            text = text.replace(/^[Ôºå„ÄÇÔºÅÔºüÔºõÔºö,.!?;:\s]*/, '');
            
            console.log('üßπ Ê∏ÖÁêÜÂêéÊñáÊú¨:', text);
            
            // È™åËØÅÊ∏ÖÁêÜÁªìÊûú
            if (!text || text.length < 2) {
                console.log('üßπ ÊñáÊú¨Êó†ÊïàÔºå‰ΩøÁî®Â§áÁî®ÂõûÂ§ç');
                return getRandomCallResponse();
            }
            
            // Â¶ÇÊûúÊñáÊú¨Â§™ÈïøÔºåÊà™ÂèñÂâçÈù¢ÈÉ®ÂàÜ
            if (text.length > 60) {
                text = text.substring(0, 60) + '...';
            }
            
            return text;
        }
        
        // ÈöèÊú∫ÈÄöËØùÈóÆÂÄôËØ≠
        function getRandomCallGreeting(characterName) {
            const greetings = [
                `‰Ω†Â•ΩÔºåÊàëÊòØ${characterName}ÔºåÂæàÈ´òÂÖ¥ËÉΩÂíå‰Ω†ÈÄöËØù„ÄÇ`,
                `Âó®ÔºåÁªà‰∫éËÉΩÂê¨Âà∞‰Ω†ÁöÑÂ£∞Èü≥‰∫ÜÔºÅ`,
                `ÂñÇÔºå‰Ω†Â•ΩÂïäÔºåÂê¨ÂæóÂà∞ÊàëËØ¥ËØùÂêóÔºü`,
                `‰Ω†Â•ΩÔºåË∞¢Ë∞¢‰Ω†Êé•ÊàëÁîµËØù„ÄÇ`,
                `Âó®ÔºåÂæàÈ´òÂÖ¥ËÉΩÂíå‰Ω†ÈÄöËØù„ÄÇ`
            ];
            
            return greetings[Math.floor(Math.random() * greetings.length)];
        }
        
        // ÈöèÊú∫ÈÄöËØùÂõûÂ§çÔºàÂ§áÁî®Ôºâ
        function getRandomCallResponse() {
            const responses = [
                'ÂóØÔºåÊàëÊòéÁôΩ‰∫Ü„ÄÇ',
                'Â•ΩÁöÑÔºåÊàëÁü•ÈÅì‰∫Ü„ÄÇ',
                'ÊòØÁöÑÔºå‰Ω†ËØ¥ÂæóÂØπ„ÄÇ',
                'ÊàëËßâÂæóËøô‰∏™ÊÉ≥Ê≥ï‰∏çÈîô„ÄÇ',
                'ÂóØÔºåÊúâÈÅìÁêÜ„ÄÇ',
                'Âì¶ÔºåÁúüÁöÑÂêóÔºü',
                'ÊàëÊòéÁôΩ‰Ω†ÁöÑÊÑèÊÄù‰∫Ü„ÄÇ',
                'ËøôÊ†∑ÂïäÔºåÊàëÊáÇ‰∫Ü„ÄÇ',
                'Á°ÆÂÆûÂ¶ÇÊ≠§„ÄÇ',
                'ÊàëÂêåÊÑè‰Ω†ÁöÑÁúãÊ≥ï„ÄÇ'
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // Ê£ÄÊµãÊòØÂê¶Â∫îËØ•Ëß¶ÂèëAI‰∏ªÂä®Êã®ÊâìÁîµËØù
        function checkForAICallTrigger(userMessage, aiResponse) {
            // Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ËÆæÁΩÆ
            const currentChatSettings = getCurrentChatSettings();
            
            // Â¶ÇÊûúÊú™ÂêØÁî®AI‰∏ªÂä®Êã®ÊâìÁîµËØùÂäüËÉΩÔºåÁõ¥Êé•ËøîÂõû
            if (!currentChatSettings.aiCallEnabled) {
                console.log('üîî AI‰∏ªÂä®Êã®ÊâìÁîµËØùÂäüËÉΩÊú™ÂºÄÂêØÔºåËßíËâ≤‰∏ç‰ºö‰∏ªÂä®Êã®ÊâìÁîµËØù');
                return false;
            }
            
            // Â¶ÇÊûúÂ∑≤ÁªèÂú®ÈÄöËØù‰∏≠Ôºå‰∏çÂÜçËß¶Âèë
            if (isInCall) {
                console.log('üîî ÂΩìÂâçÊ≠£Âú®ÈÄöËØù‰∏≠Ôºå‰∏çËß¶ÂèëÊñ∞ÁöÑÊù•Áîµ');
                return false;
            }
            
            // Á°Æ‰øùÊúâÂΩìÂâçËÅäÂ§©ËßíËâ≤
            if (!currentChatCharacter) {
                console.log('üîî Ê≤°ÊúâÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåÊó†Ê≥ïËß¶ÂèëÊù•Áîµ');
                return false;
            }
            
            // ÈÄöËØùÂÖ≥ÈîÆËØç
            const callKeywords = ['ÈÄöËØù', 'ÁîµËØù', 'ËßÜÈ¢ë', 'ËØ≠Èü≥', 'ÊâìÁªô‰Ω†', 'ÊÉ≥Âê¨', 'ÊÉ≥Áúã', 'ËÅäÂ§©', 'ËØ¥ËØù', 'ÊµãËØï', 'ËØïËØï', 'ÊâìÁîµËØù'];
            
            // Ê£ÄÊü•Áî®Êà∑Ê∂àÊÅØÂíåAIÂõûÂ§ç‰∏≠ÊòØÂê¶ÂåÖÂê´ÈÄöËØùÂÖ≥ÈîÆËØç
            const userMessageHasCallKeyword = callKeywords.some(keyword => userMessage.includes(keyword));
            const aiResponseHasCallKeyword = callKeywords.some(keyword => aiResponse.includes(keyword));
            
            console.log('üîî Ê£ÄÊü•AI‰∏ªÂä®Êã®ÊâìËß¶ÂèëÊù°‰ª∂:', {
                userMessage,
                aiResponse,
                userHasKeyword: userMessageHasCallKeyword,
                aiHasKeyword: aiResponseHasCallKeyword,
                aiCallEnabled: currentChatSettings.aiCallEnabled
            });
            
            // Ê†πÊçÆÂÖ≥ÈîÆËØçÂá∫Áé∞ÊÉÖÂÜµÂíåËßíËâ≤ÊÄßÊ†ºÂÜ≥ÂÆöËß¶ÂèëÊ¶ÇÁéá
            let triggerProbability = 0;
            if (userMessageHasCallKeyword) {
                // Âü∫Á°ÄÊ¶ÇÁéáÔºöÁî®Êà∑ÊèêÂà∞ÈÄöËØùÂÖ≥ÈîÆËØçÊó∂20%
                triggerProbability = 0.2;
                
                // Â¶ÇÊûúAIÂõûÂ§ç‰πüÂåÖÂê´ÈÄöËØùÂÖ≥ÈîÆËØçÔºåÂ§ßÂπÖÊèêÂçáÊ¶ÇÁéáÂà∞60%
                if (aiResponseHasCallKeyword) {
                    triggerProbability = 0.6;
                }
                
                // Ê†πÊçÆËßíËâ≤ÊÄßÊ†ºË∞ÉÊï¥Ê¶ÇÁéáÔºàÂ¶ÇÊûúËßíËâ≤ËÆæÂÆö‰∏≠ÂåÖÂê´‰∏ªÂä®„ÄÅÂ§ñÂêëÁ≠âÁâπË¥®Ôºâ
                const characterBio = currentChatCharacter.bio || '';
                if (characterBio.includes('‰∏ªÂä®') || characterBio.includes('Â§ñÂêë') || characterBio.includes('ÁÉ≠ÊÉÖ')) {
                    triggerProbability += 0.1;
                }
                
                // ÈôêÂà∂ÊúÄÂ§ßÊ¶ÇÁéá‰∏∫70%
                triggerProbability = Math.min(triggerProbability, 0.7);
            }
            
            // Â¢ûÂä†ÈöèÊú∫Âõ†Á¥†ÔºöÂç≥‰ΩøÊ≤°ÊúâÂÖ≥ÈîÆËØçÔºå‰πüÊúâÊûÅÂ∞èÊ¶ÇÁéá(2%)Ëß¶ÂèëÔºåÊ®°ÊãüÁúüÂÆûÁöÑÁ™ÅÁÑ∂Êù•Áîµ
            if (triggerProbability === 0 && Math.random() < 0.02) {
                triggerProbability = 0.02;
                console.log('üîî ÈöèÊú∫Ëß¶ÂèëAIÊù•ÁîµÔºàÊ®°ÊãüÁ™ÅÁÑ∂ÊÉ≥Âà∞Ë¶ÅÊâìÁîµËØùÔºâ');
            }
            
            if (triggerProbability > 0 && Math.random() < triggerProbability) {
                console.log('üîî AI‰∏ªÂä®Êã®ÊâìÁîµËØùË¢´Ëß¶ÂèëÔºÅÊ¶ÇÁéá:', triggerProbability);
                
                // ‰ªéAIÂõûÂ§ç‰∏≠ÊèêÂèñ‰∏Ä‰∏™ÂêàÁêÜÁöÑÈÄöËØùÁêÜÁî±
                let callReason = extractCallReason(aiResponse);
                
                // Âª∂Ëøü2-5ÁßíÂêéËß¶ÂèëÊù•Áîµ
                const delay = 2000 + Math.random() * 3000;
                console.log(`üîî Â∞ÜÂú®${Math.round(delay/1000)}ÁßíÂêéÂèëËµ∑Êù•ÁîµÔºåÁêÜÁî±: ${callReason}`);
                
                setTimeout(() => {
                    console.log('üîî ÂºÄÂßãÂèëËµ∑AIÊù•Áîµ');
                    initiateAICall(currentChatCharacter, callReason);
                }, delay);
                
                return true;
            } else {
                console.log('üîî AI‰∏ªÂä®Êã®ÊâìÊú™Ëß¶ÂèëÔºåÊ¶ÇÁéá:', triggerProbability);
            }
            
            return false;
        }
        
        // ‰ªéAIÂõûÂ§ç‰∏≠ÊèêÂèñÈÄöËØùÁêÜÁî±
        function extractCallReason(aiResponse) {
            // ÈªòËÆ§ÁêÜÁî±
            let defaultReasons = [
                'ÊÉ≥Âíå‰Ω†ËÅäËÅäÂ§©',
                'Êúâ‰∫ãÊÉÖÊÉ≥ÂëäËØâ‰Ω†',
                'ÊÉ≥Âê¨Âê¨‰Ω†ÁöÑÂ£∞Èü≥',
                'ÊÉ≥Âíå‰Ω†ËØ¥ËØ¥ËØù'
            ];
            
            // Â∞ùËØï‰ªéÂõûÂ§ç‰∏≠ÊèêÂèñ‰∏Ä‰∏™ÂêàÁêÜÁöÑÂè•Â≠ê‰Ωú‰∏∫ÁêÜÁî±
            const sentences = aiResponse.split(/[„ÄÇÔºÅÔºü.!?]/);
            const validSentences = sentences.filter(s => {
                const trimmed = s.trim();
                return trimmed.length > 5 && trimmed.length < 20 && !trimmed.includes('Êàë');
            });
            
            if (validSentences.length > 0) {
                return validSentences[Math.floor(Math.random() * validSentences.length)].trim();
            }
            
            return defaultReasons[Math.floor(Math.random() * defaultReasons.length)];
        }

        function openVideoCall() {
            showToast('ËßÜÈ¢ëÈÄöËØùÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ËßÜÈ¢ëÈÄöËØùÂäüËÉΩ
        }

        function shareLocation() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }
            
            // ÈáçÁΩÆËæìÂÖ•Ê°Ü
            document.getElementById('location-address').value = '';
            document.getElementById('map-location-display').textContent = 'ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞';
            
            // ÈöèÊú∫ÂåñÂú∞ÂõæÊòæÁ§∫
            randomizeMapPosition();
            
            // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
            renderLocationHistory();
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('location-modal').style.display = 'flex';
        }

        function hideLocationModal() {
            document.getElementById('location-modal').style.display = 'none';
        }

        function setLocationAddress(address) {
            document.getElementById('location-address').value = address;
            document.getElementById('map-location-display').textContent = address;
            
            // ÁîüÊàêÈöèÊú∫ÂùêÊ†á
            const lat = (39.8 + Math.random() * 0.4).toFixed(4);
            const lng = (116.2 + Math.random() * 0.4).toFixed(4);
            document.querySelector('.map-coordinates').textContent = `${lng}¬∞E, ${lat}¬∞N`;
        }

        function randomizeMapPosition() {
            const marker = document.getElementById('location-marker');
            const buildings = document.querySelectorAll('.building');
            
            // ÈöèÊú∫ÁßªÂä®Ê†áËÆ∞‰ΩçÁΩÆ
            const newTop = 20 + Math.random() * 60; // 20% - 80%
            const newLeft = 20 + Math.random() * 60; // 20% - 80%
            marker.style.top = newTop + '%';
            marker.style.left = newLeft + '%';
            
            // ÈöèÊú∫ÁßªÂä®Âª∫Á≠ëÁâ©
            buildings.forEach(building => {
                const top = Math.random() * 85; // 0% - 85%
                const left = Math.random() * 85; // 0% - 85%
                building.style.top = top + '%';
                building.style.left = left + '%';
            });
            
            // Êõ¥Êñ∞ÂùêÊ†á
            const lat = (39.8 + Math.random() * 0.4).toFixed(4);
            const lng = (116.2 + Math.random() * 0.4).toFixed(4);
            document.querySelector('.map-coordinates').textContent = `${lng}¬∞E, ${lat}¬∞N`;
        }

        // ÁîüÊàêÈÄºÁúüÁöÑÂú∞ÂõæHTMLÂÜÖÂÆπ
        function generateRealisticMapHTML() {
            return `
                <div class="map-background"></div>
                <!-- ÂºØÊõ≤Ê≤≥ÊµÅ -->
                <div class="river" style="top: 5%; left: 60%; width: 20px; height: 3px; transform: rotate(35deg);"></div>
                <div class="river-curve" style="top: 12%; left: 72%; width: 18px; height: 3px; transform: rotate(15deg);"></div>
                <div class="river" style="top: 18%; left: 80%; width: 16px; height: 3px; transform: rotate(-5deg);"></div>
                <div class="river-curve" style="top: 22%; left: 85%; width: 15px; height: 3px; transform: rotate(-25deg);"></div>
                <div class="river" style="top: 55%; left: 2%; width: 22px; height: 3px; transform: rotate(-10deg);"></div>
                <div class="river-curve" style="top: 62%; left: 18%; width: 20px; height: 3px; transform: rotate(8deg);"></div>
                <div class="river" style="top: 68%; left: 32%; width: 18px; height: 3px; transform: rotate(25deg);"></div>
                <!-- ÂÖ¨Âõ≠ÁªøÂú∞ -->
                <div class="park" style="top: 20%; left: 65%; width: 18px; height: 15px;"></div>
                <div class="park" style="top: 45%; left: 10%; width: 22px; height: 18px;"></div>
                <!-- ÈÅìË∑Ø -->
                <div class="map-roads">
                    <div class="road road-horizontal" style="top: 35%; width: 100%;"></div>
                    <div class="road road-vertical" style="left: 40%; height: 100%;"></div>
                    <div class="road road-horizontal" style="top: 65%; width: 70%; left: 30%;"></div>
                </div>
                <!-- Âª∫Á≠ëÁâ© -->
                <div class="map-buildings">
                    <div class="building house" style="top: 15%; left: 20%; width: 12px; height: 10px;"></div>
                    <div class="building office" style="top: 25%; left: 45%; width: 8px; height: 16px;"></div>
                    <div class="building shop" style="top: 50%; left: 50%; width: 14px; height: 8px;"></div>
                    <div class="building house" style="top: 70%; left: 75%; width: 10px; height: 8px;"></div>
                    <div class="building office" style="top: 8%; left: 85%; width: 6px; height: 12px;"></div>
                </div>
                <!-- Ê†ëÊú® -->
                <div class="tree big" style="top: 25%; left: 15%; width: 6px; height: 6px;"></div>
                <div class="tree small" style="top: 55%; left: 25%; width: 4px; height: 4px;"></div>
                <div class="tree big" style="top: 10%; left: 70%; width: 5px; height: 5px;"></div>
                <div class="tree small" style="top: 75%; left: 85%; width: 3px; height: 3px;"></div>
                <div class="tree small" style="top: 40%; left: 80%; width: 4px; height: 4px;"></div>
                <!-- ‰ΩçÁΩÆÊ†áËÆ∞ -->
                <div class="map-marker">
                    <div class="marker-pin" style="color: #1890ff;">üìç</div>
                </div>
            `;
        }

        // ÂéÜÂè≤Âú∞ÁÇπÁÆ°ÁêÜ
        let locationHistory = JSON.parse(localStorage.getItem('locationHistory') || '[]');

        function saveLocationHistory() {
            localStorage.setItem('locationHistory', JSON.stringify(locationHistory));
        }

        function addToLocationHistory(locationName) {
            if (!locationName.trim()) return;
            
            // ÁßªÈô§ÈáçÂ§çÈ°π
            locationHistory = locationHistory.filter(name => name !== locationName);
            // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
            locationHistory.unshift(locationName);
            // ÈôêÂà∂ÊúÄÂ§ö‰øùÂ≠ò10‰∏™
            if (locationHistory.length > 10) {
                locationHistory = locationHistory.slice(0, 10);
            }
            
            saveLocationHistory();
            renderLocationHistory();
        }

        function removeFromLocationHistory(locationName) {
            locationHistory = locationHistory.filter(name => name !== locationName);
            saveLocationHistory();
            renderLocationHistory();
        }

        function renderLocationHistory() {
            const container = document.getElementById('location-history-items');
            if (!container) return;

            if (locationHistory.length === 0) {
                container.innerHTML = '<div class="location-history-empty">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>';
                return;
            }

            container.innerHTML = locationHistory.map(location => 
                `<div class="location-history-item" data-location="${location}" onclick="setLocationAddress('${location}')">
                    <span class="location-text">${location}</span>
                    <span class="delete-btn" onclick="event.stopPropagation(); confirmDeleteLocation('${location}')" title="Âà†Èô§">√ó</span>
                </div>`
            ).join('');
        }

        // ÈïøÊåâÂà†Èô§Â§ÑÁêÜ
        let touchTimer = null;
        let touchedElement = null;

        function handleLocationTouchStart(event, location) {
            touchedElement = event.target;
            touchTimer = setTimeout(() => {
                confirmDeleteLocation(location);
            }, 800); // 800msÈïøÊåâ
        }

        function handleLocationTouchEnd(event) {
            if (touchTimer) {
                clearTimeout(touchTimer);
                touchTimer = null;
            }
            if (touchedElement) {
                touchedElement.classList.remove('deleting');
                touchedElement = null;
            }
        }

        function confirmDeleteLocation(location) {
            if (touchedElement) {
                touchedElement.classList.add('deleting');
            }
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‰ΩçÁΩÆ"${location}"ÂêóÔºü`)) {
                removeFromLocationHistory(location);
                showToast('‰ΩçÁΩÆÂ∑≤Âà†Èô§', 'success');
            } else if (touchedElement) {
                touchedElement.classList.remove('deleting');
            }
        }

        function sendLocationMessage() {
            const address = document.getElementById('location-address').value.trim();
            if (!address) {
                alert('ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞');
                return;
            }

            // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            addToLocationHistory(address);

            // ÂàõÂª∫‰ΩçÁΩÆÊ∂àÊÅØ
            const locationMessage = {
                id: Date.now().toString(),
                sender: 'sent',
                type: 'location',
                locationName: address,
                coordinates: document.querySelector('.map-coordinates').textContent,
                content: `[Áî®Êà∑ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ‰ø°ÊÅØÔºö${address}ÔºåÂùêÊ†áÔºö${document.querySelector('.map-coordinates').textContent}]`,
                timestamp: Date.now()
            };

            console.log('üó∫Ô∏è ÂàõÂª∫‰ΩçÁΩÆÊ∂àÊÅØ:', locationMessage);
            
            // üî•„ÄêË∞ÉËØï„ÄëÊ£ÄÊü•Ê∂àÊÅØÊï∞ÊçÆ
            if (!locationMessage.locationName || !locationMessage.coordinates) {
                console.error('‚ùå ‰ΩçÁΩÆÊ∂àÊÅØÊï∞ÊçÆ‰∏çÂÆåÊï¥:', {
                    locationName: locationMessage.locationName,
                    coordinates: locationMessage.coordinates
                });
                alert('‰ΩçÁΩÆ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåËØ∑ÈáçËØï');
                return;
            }

            // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(locationMessage);

            // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
            saveChatMessages();

            // ‰ΩøÁî®Âä®ÁîªÊ∑ªÂä†Ê∂àÊÅØËÄå‰∏çÊòØÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®
            addMessageWithAnimation(locationMessage, currentChatCharacter.id);

            // ËÆæÁΩÆ‰∏∫ÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = locationMessage;

            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }

            // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
            renderMessageList();

            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            hideLocationModal();

            showToast('‰ΩçÁΩÆÂ∑≤ÂàÜ‰∫´', 'success');
        }

        // Êõ¥Êñ∞Â∑≤Â≠òÂú®ÁöÑ‰ΩçÁΩÆÂç°ÁâáÂú∞Âõæ
        function updateExistingLocationMaps() {
            const locationMaps = document.querySelectorAll('.location-card-map');
            locationMaps.forEach(mapElement => {
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ÔºàÊ≤°ÊúâÊñ∞ÁöÑÂú∞ÂõæÂÖÉÁ¥†Ôºâ
                if (!mapElement.querySelector('.river')) {
                    mapElement.innerHTML = generateRealisticMapHTML();
                }
            });
        }

        // ÁõëÂê¨‰ΩçÁΩÆËæìÂÖ•Ê°ÜÁöÑÂèòÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const locationInput = document.getElementById('location-address');
            if (locationInput) {
                locationInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    if (value) {
                        document.getElementById('map-location-display').textContent = value;
                        
                        // ÁîüÊàêÈöèÊú∫ÂùêÊ†á
                        const lat = (39.8 + Math.random() * 0.4).toFixed(4);
                        const lng = (116.2 + Math.random() * 0.4).toFixed(4);
                        document.querySelector('.map-coordinates').textContent = `${lng}¬∞E, ${lat}¬∞N`;
                    } else {
                        document.getElementById('map-location-display').textContent = 'ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞';
                    }
                });
            }
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
            document.getElementById('location-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('location-modal')) {
                    hideLocationModal();
                }
            });

            // ÂÆöÊúüÊõ¥Êñ∞Áé∞ÊúâÁöÑ‰ΩçÁΩÆÂç°ÁâáÂú∞Âõæ
            setInterval(updateExistingLocationMaps, 1000);
        });

        // ÊòæÁ§∫‰ΩçÁΩÆËØ¶ÊÉÖ
        function showLocationDetail(locationName) {
            alert(`üìç ${locationName}`);
        }
 
        // üìä Êï∞ÊçÆÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞
        
        // ËÆ°ÁÆóÂ≠òÂÇ®Á©∫Èó¥‰ΩøÁî®ÊÉÖÂÜµ
        async function calculateStorageUsage() {
            try {
                let chatSize = 0, characterSize = 0, settingsSize = 0, emojiSize = 0;

                const [chatData, charData, settingsData, emojiData] = await Promise.all([
                    db.chatMessages.toArray(),
                    db.characters.toArray(), 
                    db.chatSettings.toArray(),
                    db.customEmojis.toArray()
                ]);

                chatSize = JSON.stringify(chatData).length;
                characterSize = JSON.stringify(charData).length;
                settingsSize = JSON.stringify(settingsData).length;
                emojiSize = JSON.stringify(emojiData).length;
                const total = chatSize + characterSize + settingsSize + emojiSize;

                // Êõ¥Êñ∞ÊòæÁ§∫
                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };

                if (document.getElementById('chat-storage-size')) {
                    document.getElementById('chat-storage-size').textContent = formatBytes(chatSize);
                    document.getElementById('character-storage-size').textContent = formatBytes(characterSize);
                    document.getElementById('settings-storage-size').textContent = formatBytes(settingsSize);
                    document.getElementById('emoji-storage-size').textContent = formatBytes(emojiSize);
                    document.getElementById('total-storage-size').textContent = formatBytes(total);
                }
            } catch (error) {
                console.error('ËÆ°ÁÆóÂ≠òÂÇ®Â§±Ë¥•:', error);
            }
        }

        // ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ
        async function exportAllData() {
            try {
                showToast('Ê≠£Âú®ÂØºÂá∫Êï∞ÊçÆ...', 'info');
                
                // üî•„Äê‰øÆÂ§ç„ÄëÂØºÂá∫ÊâÄÊúâÈáçË¶ÅÊï∞ÊçÆË°®
                const exportData = {
                    version: '2.0', // Êõ¥Êñ∞ÁâàÊú¨Âè∑
                    exportTime: new Date().toISOString(),
                    characters: await db.characters.toArray(),
                    chatMessages: await db.chatMessages.toArray(),
                    chatSettings: await db.chatSettings.toArray(),
                    customEmojis: await db.customEmojis.toArray(),
                    wallpapers: await db.wallpapers.toArray(),
                    worldbooks: await db.worldbooks.toArray(),
                    characterGroups: await db.characterGroups.toArray(),
                    groupChats: await db.groupChats.toArray(),
                    personas: await db.personas.toArray(),
                    apiSettings: await db.apiSettings.toArray(),
                    globalSettings: await db.globalSettings.toArray(),
                    recentEmojis: await db.recentEmojis.toArray(),
                    contacts: await db.contacts.toArray(),
                    appIcons: await db.appIcons.toArray()
                };

                // ÊòæÁ§∫ÂØºÂá∫ÁªüËÆ°
                const stats = [];
                if (exportData.characters?.length) stats.push(`ËßíËâ≤: ${exportData.characters.length}‰∏™`);
                if (exportData.chatMessages?.length) stats.push(`Ê∂àÊÅØ: ${exportData.chatMessages.length}Êù°`);
                if (exportData.chatSettings?.length) stats.push(`ËÆæÁΩÆ: ${exportData.chatSettings.length}‰∏™`);
                if (exportData.wallpapers?.length) stats.push(`Â£ÅÁ∫∏: ${exportData.wallpapers.length}‰∏™`);
                if (exportData.worldbooks?.length) stats.push(`‰∏ñÁïå‰π¶: ${exportData.worldbooks.length}‰∏™`);
                if (exportData.characterGroups?.length) stats.push(`ÂàÜÁªÑ: ${exportData.characterGroups.length}‰∏™`);
                if (exportData.groupChats?.length) stats.push(`Áæ§ËÅä: ${exportData.groupChats.length}‰∏™`);
                if (exportData.personas?.length) stats.push(`Èù¢ÂÖ∑: ${exportData.personas.length}‰∏™`);
                if (exportData.customEmojis?.length) stats.push(`Ë°®ÊÉÖ: ${exportData.customEmojis.length}‰∏™`);
                
                console.log('ÂØºÂá∫Êï∞ÊçÆÁªüËÆ°:', stats.join(', '));

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ÂÆåÊï¥Â§á‰ªΩ_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                const statsText = stats.length > 0 ? `\n${stats.join('\n')}` : '';
                showToast(`ÂØºÂá∫ÊàêÂäüÔºÅ${statsText}`, 'success');
            } catch (error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                showToast('ÂØºÂá∫Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ÂØºÂÖ•Êï∞ÊçÆ
        // üî•„Äê‰øÆÂ§ç„ÄëÂØºÂÖ•Êï∞ÊçÆ - Â¢ûÂº∫ÈîôËØØÂ§ÑÁêÜÂíåÊï∞ÊçÆÈ™åËØÅ
        function importDataFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    showToast('Ê≠£Âú®ÂØºÂÖ•...', 'info');
                    const text = await file.text();
                    
                    // Â∞ùËØïËß£ÊûêJSON
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        throw new Error('JSONÊ†ºÂºèÈîôËØØÔºö' + parseError.message);
                    }
                    
                    // Ê£ÄÊü•Êï∞ÊçÆÊ†ºÂºè
                    if (!data || typeof data !== 'object') {
                        throw new Error('Êó†ÊïàÁöÑÂ§á‰ªΩÊñá‰ª∂Ê†ºÂºè');
                    }
                    
                    // ÊòæÁ§∫ÂØºÂÖ•È¢ÑËßà
                    const dataPreview = [];
                    if (data.characters?.length) dataPreview.push(`ËßíËâ≤: ${data.characters.length}‰∏™`);
                    if (data.chatMessages?.length) dataPreview.push(`ËÅäÂ§©Ê∂àÊÅØ: ${data.chatMessages.length}Êù°`);
                    if (data.chatSettings?.length) dataPreview.push(`ËÅäÂ§©ËÆæÁΩÆ: ${data.chatSettings.length}‰∏™`);
                    if (data.worldbooks?.length) dataPreview.push(`‰∏ñÁïå‰π¶: ${data.worldbooks.length}‰∏™`);
                    if (data.customEmojis?.length) dataPreview.push(`Ëá™ÂÆö‰πâË°®ÊÉÖ: ${data.customEmojis.length}‰∏™`);
                    if (data.wallpapers?.length) dataPreview.push(`Â£ÅÁ∫∏: ${data.wallpapers.length}‰∏™`);
                    if (data.characterGroups?.length) dataPreview.push(`ËßíËâ≤ÂàÜÁªÑ: ${data.characterGroups.length}‰∏™`);
                    if (data.groupChats?.length) dataPreview.push(`Áæ§ËÅä: ${data.groupChats.length}‰∏™`);
                    if (data.personas?.length) dataPreview.push(`Áî®Êà∑Èù¢ÂÖ∑: ${data.personas.length}‰∏™`);
                    if (data.apiSettings?.length) dataPreview.push(`APIËÆæÁΩÆ: ${data.apiSettings.length}‰∏™`);
                    if (data.globalSettings?.length) dataPreview.push(`ÂÖ®Â±ÄËÆæÁΩÆ: ${data.globalSettings.length}‰∏™`);
                    if (data.contacts?.length) dataPreview.push(`ËÅîÁ≥ª‰∫∫: ${data.contacts.length}‰∏™`);
                    if (data.appIcons?.length) dataPreview.push(`Â∫îÁî®ÂõæÊ†á: ${data.appIcons.length}‰∏™`);
                    
                    const previewText = dataPreview.length > 0 ? 
                        `Â∞ÜÂØºÂÖ•‰ª•‰∏ãÊï∞ÊçÆÔºö\n${dataPreview.join('\n')}\n\nÂØºÂÖ•Â∞ÜË¶ÜÁõñÁé∞ÊúâÊï∞ÊçÆÔºåÁ°ÆÂÆöÁªßÁª≠Ôºü` : 
                        'Â§á‰ªΩÊñá‰ª∂‰∏≠Ê≤°ÊúâÊâæÂà∞ÊúâÊïàÊï∞ÊçÆÔºåÁ°ÆÂÆöÁªßÁª≠Ôºü';
                    
                    if (!confirm(previewText)) return;
                    
                    // üî•„Äê‰øÆÂ§ç„Äë‰ΩøÁî®bulkPut‰ª£ÊõøbulkAddÈÅøÂÖç‰∏ªÈîÆÂÜ≤Á™Å
                    let importedTables = 0;
                    
                    // ÂØºÂÖ•ËßíËâ≤Êï∞ÊçÆ
                    if (data.characters?.length) {
                        try {
                        await db.characters.clear();
                            // Á°Æ‰øùÊØè‰∏™ËßíËâ≤ÈÉΩÊúâÊúâÊïàID
                            const validCharacters = data.characters.map(char => ({
                                ...char,
                                id: char.id || `char_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.characters.bulkPut(validCharacters);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validCharacters.length} ‰∏™ËßíËâ≤`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•ËßíËâ≤Â§±Ë¥•:', error);
                            showToast('ËßíËâ≤ÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•ËÅäÂ§©Ê∂àÊÅØ
                    if (data.chatMessages?.length) {
                        try {
                        await db.chatMessages.clear();
                            // Á°Æ‰øùÊØèÊù°Ê∂àÊÅØÈÉΩÊúâÊúâÊïàID
                            const validMessages = data.chatMessages.map(msg => ({
                                ...msg,
                                id: msg.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.chatMessages.bulkPut(validMessages);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validMessages.length} Êù°ËÅäÂ§©Ê∂àÊÅØ`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•ËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•:', error);
                            showToast('ËÅäÂ§©Ê∂àÊÅØÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•ËÅäÂ§©ËÆæÁΩÆ
                    if (data.chatSettings?.length) {
                        try {
                        await db.chatSettings.clear();
                            // Á°Æ‰øùÊØè‰∏™ËÆæÁΩÆÈÉΩÊúâÊúâÊïàID
                            const validSettings = data.chatSettings.map(setting => ({
                                ...setting,
                                id: setting.id || `setting_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.chatSettings.bulkPut(validSettings);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validSettings.length} ‰∏™ËÅäÂ§©ËÆæÁΩÆ`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•ËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:', error);
                            showToast('ËÅäÂ§©ËÆæÁΩÆÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•ÂÖ∂‰ªñÂèØËÉΩÁöÑÊï∞ÊçÆ
                    if (data.worldbooks?.length) {
                        try {
                            await db.worldbooks.clear();
                            const validWorldbooks = data.worldbooks.map(wb => ({
                                ...wb,
                                id: wb.id || `wb_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.worldbooks.bulkPut(validWorldbooks);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validWorldbooks.length} ‰∏™‰∏ñÁïå‰π¶`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                            showToast('‰∏ñÁïå‰π¶ÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    if (data.customEmojis?.length) {
                        try {
                            await db.customEmojis.clear();
                            const validEmojis = data.customEmojis.map(emoji => ({
                                ...emoji,
                                id: emoji.id || `emoji_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.customEmojis.bulkPut(validEmojis);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validEmojis.length} ‰∏™Ëá™ÂÆö‰πâË°®ÊÉÖ`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•Ëá™ÂÆö‰πâË°®ÊÉÖÂ§±Ë¥•:', error);
                            showToast('Ëá™ÂÆö‰πâË°®ÊÉÖÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•Â£ÅÁ∫∏
                    if (data.wallpapers?.length) {
                        try {
                            await db.wallpapers.clear();
                            const validWallpapers = data.wallpapers.map(wp => ({
                                ...wp,
                                id: wp.id || `wp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.wallpapers.bulkPut(validWallpapers);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validWallpapers.length} ‰∏™Â£ÅÁ∫∏`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•Â£ÅÁ∫∏Â§±Ë¥•:', error);
                            showToast('Â£ÅÁ∫∏ÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•ËßíËâ≤ÂàÜÁªÑ
                    if (data.characterGroups?.length) {
                        try {
                            await db.characterGroups.clear();
                            const validGroups = data.characterGroups.map(group => ({
                                ...group,
                                id: group.id || `group_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.characterGroups.bulkPut(validGroups);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validGroups.length} ‰∏™ËßíËâ≤ÂàÜÁªÑ`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•ËßíËâ≤ÂàÜÁªÑÂ§±Ë¥•:', error);
                            showToast('ËßíËâ≤ÂàÜÁªÑÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•Áæ§ËÅä
                    if (data.groupChats?.length) {
                        try {
                            await db.groupChats.clear();
                            const validGroups = data.groupChats.map(chat => ({
                                ...chat,
                                id: chat.id || `chat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.groupChats.bulkPut(validGroups);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validGroups.length} ‰∏™Áæ§ËÅä`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•Áæ§ËÅäÂ§±Ë¥•:', error);
                            showToast('Áæ§ËÅäÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•Áî®Êà∑Èù¢ÂÖ∑
                    if (data.personas?.length) {
                        try {
                            await db.personas.clear();
                            const validPersonas = data.personas.map(persona => ({
                                ...persona,
                                id: persona.id || `persona_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.personas.bulkPut(validPersonas);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validPersonas.length} ‰∏™Áî®Êà∑Èù¢ÂÖ∑`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•Áî®Êà∑Èù¢ÂÖ∑Â§±Ë¥•:', error);
                            showToast('Áî®Êà∑Èù¢ÂÖ∑ÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•APIËÆæÁΩÆ
                    if (data.apiSettings?.length) {
                        try {
                            await db.apiSettings.clear();
                            const validApiSettings = data.apiSettings.map(setting => ({
                                ...setting,
                                id: setting.id || `api_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.apiSettings.bulkPut(validApiSettings);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validApiSettings.length} ‰∏™APIËÆæÁΩÆ`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•APIËÆæÁΩÆÂ§±Ë¥•:', error);
                            showToast('APIËÆæÁΩÆÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•ÂÖ®Â±ÄËÆæÁΩÆ
                    if (data.globalSettings?.length) {
                        try {
                            await db.globalSettings.clear();
                            const validGlobalSettings = data.globalSettings.map(setting => ({
                                ...setting,
                                id: setting.id || `global_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.globalSettings.bulkPut(validGlobalSettings);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validGlobalSettings.length} ‰∏™ÂÖ®Â±ÄËÆæÁΩÆ`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•ÂÖ®Â±ÄËÆæÁΩÆÂ§±Ë¥•:', error);
                            showToast('ÂÖ®Â±ÄËÆæÁΩÆÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•ÊúÄËøëË°®ÊÉÖ
                    if (data.recentEmojis?.length) {
                        try {
                            await db.recentEmojis.clear();
                            const validRecentEmojis = data.recentEmojis.map(emoji => ({
                                ...emoji,
                                id: emoji.id || `recent_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.recentEmojis.bulkPut(validRecentEmojis);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validRecentEmojis.length} ‰∏™ÊúÄËøëË°®ÊÉÖ`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•ÊúÄËøëË°®ÊÉÖÂ§±Ë¥•:', error);
                            showToast('ÊúÄËøëË°®ÊÉÖÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•ËÅîÁ≥ª‰∫∫
                    if (data.contacts?.length) {
                        try {
                            await db.contacts.clear();
                            const validContacts = data.contacts.map(contact => ({
                                ...contact,
                                id: contact.id || `contact_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.contacts.bulkPut(validContacts);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validContacts.length} ‰∏™ËÅîÁ≥ª‰∫∫`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•ËÅîÁ≥ª‰∫∫Â§±Ë¥•:', error);
                            showToast('ËÅîÁ≥ª‰∫∫ÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    
                    // ÂØºÂÖ•Â∫îÁî®ÂõæÊ†á
                    if (data.appIcons?.length) {
                        try {
                            await db.appIcons.clear();
                            const validAppIcons = data.appIcons.map(icon => ({
                                ...icon,
                                id: icon.id || `icon_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                            }));
                            await db.appIcons.bulkPut(validAppIcons);
                            importedTables++;
                            console.log(`ÂØºÂÖ•‰∫Ü ${validAppIcons.length} ‰∏™Â∫îÁî®ÂõæÊ†á`);
                        } catch (error) {
                            console.error('ÂØºÂÖ•Â∫îÁî®ÂõæÊ†áÂ§±Ë¥•:', error);
                            showToast('Â∫îÁî®ÂõæÊ†áÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'warning');
                        }
                    }
                    

                    
                    // ÈáçÊñ∞Âä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
                    await loadCharacterGroups();
                    await loadCharacters();
                    await loadChatMessages();
                    await loadChatSettings();
                    await loadPersonas();
                    await loadGroupChats();
                    await loadWallpaper();
                    await loadAppIcons();
                    await loadWorldbooks();
                    renderCharacterList();
                    renderMessageList();
                    renderPersonaList();
                    calculateStorageUsage();
                    
                    showToast(`ÂØºÂÖ•ÊàêÂäüÔºÅÂÖ±ÂØºÂÖ• ${importedTables} ‰∏™Êï∞ÊçÆË°®`, 'success');
                    console.log(`Êï∞ÊçÆÂØºÂÖ•ÂÆåÊàêÔºåÂÖ±ÂØºÂÖ• ${importedTables} ‰∏™Êï∞ÊçÆË°®`);
                } catch (error) {
                    console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                    showToast('ÂØºÂÖ•Â§±Ë¥•Ôºö' + error.message, 'error');
                }
            };
            input.click();
        }

        // ÊòæÁ§∫Ê∏ÖÁêÜÈÄâÈ°π
        function showCleanupOptions() {
            const choice = prompt('ÈÄâÊã©Ê∏ÖÁêÜÈ°πÁõÆÔºö\n1. Ê∏ÖÈô§Âä®ÊÄÅÂ§¥ÂÉè\n2. Âà†Èô§Á©∫ËÅäÂ§©ËÆ∞ÂΩï\n3. Ê∏ÖÁêÜlocalStorage\n4. ÂéãÁº©ÂõæÁâá\n\nËæìÂÖ•Êï∞Â≠óÔºàÈÄóÂè∑ÂàÜÈöîÔºâÔºö');
            if (choice) executeCleanupOptions(choice);
        }

        // ÊâßË°åÊ∏ÖÁêÜ
        async function executeCleanupOptions(choice) {
            const selections = choice.split(',').map(s => parseInt(s.trim())).filter(n => n >= 1 && n <= 4);
            if (!selections.length) return;
            
            showToast('Ê∏ÖÁêÜ‰∏≠...', 'info');
            let count = 0;
            
            for (const option of selections) {
                switch (option) {
                    case 1:
                        Object.keys(chatSettings).forEach(id => {
                            if (chatSettings[id]?.aiDynamicAvatar) {
                                delete chatSettings[id].aiDynamicAvatar;
                                count++;
                            }
                        });
                        break;
                    case 2:
                        Object.keys(chatMessages).forEach(id => {
                            if (!chatMessages[id]?.length) {
                                delete chatMessages[id];
                                count++;
                            }
                        });
                        break;
                    case 3:
                        for (let i = localStorage.length - 1; i >= 0; i--) {
                            const key = localStorage.key(i);
                            if (key?.startsWith('chatSettings_')) {
                                localStorage.removeItem(key);
                                count++;
                            }
                        }
                        break;
                    case 4:
                        await compressAllImages();
                        break;
                }
            }
            
            await saveChatSettings();
            await saveChatMessages();
            calculateStorageUsage();
            showToast(`Ê∏ÖÁêÜÂÆåÊàêÔºÅÂ§ÑÁêÜ ${count} È°π`, 'success');
        }

        // ÂéãÁº©ÂõæÁâá
        async function compressAllImages() {
            showToast('ÂéãÁº©‰∏≠...', 'info');
            let count = 0;
            
            // ÂéãÁº©ËßíËâ≤Â§¥ÂÉè
            for (const char of characters) {
                if (char.avatarUrl?.length > 50000) {
                    char.avatarUrl = await compressImage(char.avatarUrl, 150, 0.6);
                    count++;
                }
            }
            await saveCharacters();
            
            // ÂéãÁº©ËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉè
            for (const id of Object.keys(chatSettings)) {
                const settings = chatSettings[id];
                if (settings?.aiChatAvatar?.length > 50000) {
                    settings.aiChatAvatar = await compressImage(settings.aiChatAvatar, 150, 0.6);
                    count++;
                }
                if (settings?.myChatAvatar?.length > 50000) {
                    settings.myChatAvatar = await compressImage(settings.myChatAvatar, 150, 0.6);
                    count++;
                }
            }
            await saveChatSettings();
            calculateStorageUsage();
            showToast(`ÂéãÁº©ÂÆåÊàêÔºÅÂ§ÑÁêÜ ${count} Âº†ÂõæÁâá`, 'success');
        }

        // Ë∞ÉËØïÁî®ÔºöÂàóÂá∫ÊâÄÊúâËßíËâ≤IDÂíåÂêçÁß∞ÔºåÂ∏ÆÂä©ËØÜÂà´ÂπΩÁÅµËßíËâ≤
        async function debugListAllCharacters() {
            try {
                console.log('=== ÊâÄÊúâËßíËâ≤Êï∞ÊçÆ ===');
                
                // 1. Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑËßíËâ≤
                const dbChars = await db.characters.toArray();
                console.log('Êï∞ÊçÆÂ∫ìËßíËâ≤Ë°®:', dbChars.map(c => `${c.name} (ID: ${c.id})`));
                
                // 2. ÂÜÖÂ≠ò‰∏≠ÁöÑËßíËâ≤
                if (window.characters) {
                    console.log('ÂÜÖÂ≠òËßíËâ≤ÂàóË°®:', window.characters.map(c => `${c.name} (ID: ${c.id})`));
                }
                
                // 3. ËÅîÁ≥ª‰∫∫ÂàóË°®
                if (window.contacts) {
                    console.log('ËÅîÁ≥ª‰∫∫IDÂàóË°®:', window.contacts);
                }
                
                // 4. Âä®ÊÄÅËØÑËÆ∫‰∏≠ÁöÑËßíËâ≤
                const comments = await db.momentComments.toArray();
                const commentAuthors = [...new Set(comments.map(c => `${c.nickname} (ID: ${c.authorId})`))];
                console.log('Âä®ÊÄÅËØÑËÆ∫‰∏≠ÁöÑËßíËâ≤:', commentAuthors);
                
                // 5. Âä®ÊÄÅÁÇπËµû‰∏≠ÁöÑËßíËâ≤
                const likes = await db.momentLikes.toArray();
                const likeAuthors = [...new Set(likes.map(l => `${l.name} (ID: ${l.authorId})`))];
                console.log('Âä®ÊÄÅÁÇπËµû‰∏≠ÁöÑËßíËâ≤:', likeAuthors);
                
                return {dbChars, comments, likes};
            } catch (error) {
                console.error('Ë∞ÉËØïÂ§±Ë¥•:', error);
            }
        }
        
        // Ë∞ÉËØïÁî®ÔºöÁ≤æÁ°ÆÂà†Èô§ÊåáÂÆöIDÁöÑËßíËâ≤Êï∞ÊçÆ
        async function debugDeleteCharacterById(characterId) {
            if (!characterId) {
                console.log('Áî®Ê≥ï: debugDeleteCharacterById("ËßíËâ≤ID")');
                return;
            }
            
            try {
                console.log(`ÂºÄÂßãÂà†Èô§ËßíËâ≤ID: ${characterId}`);
                let deleteCount = 0;
                
                // 1. ‰ªéÂä®ÊÄÅËØÑËÆ∫‰∏≠Âà†Èô§
                const comments = await db.momentComments.where('authorId').equals(characterId).toArray();
                for (const comment of comments) {
                    await db.momentComments.delete(comment.id);
                    deleteCount++;
                    console.log(`Âà†Èô§ËØÑËÆ∫: ${comment.nickname} - ${comment.text}`);
                }
                
                // 2. ‰ªéÂä®ÊÄÅÁÇπËµû‰∏≠Âà†Èô§
                const likes = await db.momentLikes.where('authorId').equals(characterId).toArray();
                for (const like of likes) {
                    await db.momentLikes.delete([like.momentId, like.authorId]);
                    deleteCount++;
                    console.log(`Âà†Èô§ÁÇπËµû: ${like.name}`);
                }
                
                // 3. ‰ªéÂÖ∂‰ªñË°®‰∏≠Âà†Èô§
                const chatMsgs = await db.chatMessages.where('characterId').equals(characterId).toArray();
                for (const msg of chatMsgs) {
                    await db.chatMessages.delete(msg.id);
                    deleteCount++;
                }
                
                const chatSets = await db.chatSettings.toArray();
                for (const setting of chatSets) {
                    if (setting.characterId === characterId) {
                        await db.chatSettings.delete(setting.id);
                        deleteCount++;
                    }
                }
                
                await db.characters.delete(characterId);
                deleteCount++;
                
                // 4. ‰ªéÂÜÖÂ≠òÊï∞ÁªÑ‰∏≠Âà†Èô§
                if (window.contacts) {
                    window.contacts = window.contacts.filter(id => id !== characterId);
                    await saveContacts();
                }
                if (window.characters) {
                    window.characters = window.characters.filter(char => char.id !== characterId);
                }
                
                console.log(`Âà†Èô§ÂÆåÊàêÔºÅÂÖ±Âà†Èô§ ${deleteCount} Êù°Áõ∏ÂÖ≥Êï∞ÊçÆ`);
                
                // Âà∑Êñ∞ÁïåÈù¢
                if (window.renderContactList) window.renderContactList();
                if (window.renderMessageList) window.renderMessageList();
                
            } catch (error) {
                console.error('Âà†Èô§Â§±Ë¥•:', error);
            }
        }
        
        // Âº∫Âà∂Âà†Èô§ÊåáÂÆöËßíËâ≤ÔºàÁî®‰∫éÊ∏ÖÁêÜÂπΩÁÅµËßíËâ≤Ôºâ
        async function forceDeleteCharacter() {
            const characterName = prompt('ËæìÂÖ•Ë¶ÅÂº∫Âà∂Âà†Èô§ÁöÑËßíËâ≤ÂêçÁß∞ÔºàÂ¶ÇÔºöÊñπÂõûÔºâÔºö');
            if (!characterName || !characterName.trim()) return;
            
            try {
                showToast(`Ê≠£Âú®Âº∫Âà∂Âà†Èô§ËßíËâ≤ "${characterName}"...`, 'info');
                let deleteCount = 0;
                
                // 1. ‰ªéÂä®ÊÄÅËØÑËÆ∫‰∏≠Âà†Èô§
                const comments = await db.momentComments.toArray();
                for (const comment of comments) {
                    if (comment.nickname === characterName || (comment.authorId && comment.authorId.includes(characterName))) {
                        await db.momentComments.delete(comment.id);
                        deleteCount++;
                        console.log(`Âà†Èô§ËØÑËÆ∫Ôºö${comment.nickname} - ${comment.text}`);
                    }
                }
                
                // 2. ‰ªéÂä®ÊÄÅÁÇπËµû‰∏≠Âà†Èô§
                const likes = await db.momentLikes.toArray();
                for (const like of likes) {
                    if (like.name === characterName || (like.authorId && like.authorId.includes(characterName))) {
                        await db.momentLikes.delete([like.momentId, like.authorId]);
                        deleteCount++;
                        console.log(`Âà†Èô§ÁÇπËµûÔºö${like.name}`);
                    }
                }
                
                // 3. ‰ªéËÅäÂ§©Ê∂àÊÅØ‰∏≠Âà†Èô§
                const chatMsgs = await db.chatMessages.toArray();
                for (const msg of chatMsgs) {
                    if (msg.characterId && msg.characterId.includes(characterName)) {
                        await db.chatMessages.delete(msg.id);
                        deleteCount++;
                    }
                }
                
                // 4. ‰ªéËÅäÂ§©ËÆæÁΩÆ‰∏≠Âà†Èô§
                const chatSets = await db.chatSettings.toArray();
                for (const setting of chatSets) {
                    if (setting.characterId && setting.characterId.includes(characterName)) {
                        await db.chatSettings.delete(setting.id);
                        deleteCount++;
                    }
                }
                
                // 5. ‰ªécharactersË°®‰∏≠Âà†Èô§
                const chars = await db.characters.toArray();
                for (const char of chars) {
                    if (char.name === characterName || char.id.includes(characterName)) {
                        await db.characters.delete(char.id);
                        deleteCount++;
                        console.log(`Âà†Èô§ËßíËâ≤Ôºö${char.name} (${char.id})`);
                    }
                }
                
                // 6. ‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠Âà†Èô§
                if (window.contacts) {
                    window.contacts = window.contacts.filter(id => !id.includes(characterName));
                    await saveContacts();
                }
                
                // 7. Ê∏ÖÁêÜÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆ
                if (window.characters) {
                    window.characters = window.characters.filter(char => char.name !== characterName);
                }
                if (window.chatMessages) {
                    Object.keys(window.chatMessages).forEach(key => {
                        if (key.includes(characterName)) {
                            delete window.chatMessages[key];
                        }
                    });
                }
                if (window.chatSettings) {
                    Object.keys(window.chatSettings).forEach(key => {
                        if (key.includes(characterName)) {
                            delete window.chatSettings[key];
                        }
                    });
                }
                
                // Âà∑Êñ∞ÁïåÈù¢
                if (window.renderContactList) window.renderContactList();
                if (window.renderMessageList) window.renderMessageList();
                
                showToast(`Âº∫Âà∂Âà†Èô§ÂÆåÊàêÔºÅÂÖ±Âà†Èô§ ${deleteCount} Êù°Áõ∏ÂÖ≥Êï∞ÊçÆ`, 'success');
                console.log(`Âº∫Âà∂Âà†Èô§ËßíËâ≤ "${characterName}" ÂÆåÊàêÔºåÂà†Èô§‰∫Ü ${deleteCount} Êù°ËÆ∞ÂΩï`);
                
            } catch (error) {
                console.error('Âº∫Âà∂Âà†Èô§Â§±Ë¥•:', error);
                showToast('Âº∫Âà∂Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // Ê∏ÖÁêÜÂ≠§Á´ãËÅîÁ≥ª‰∫∫ÂíåÈáçÂ§çÊï∞ÊçÆ
        async function cleanupOrphanedContacts() {
            try {
                showToast('Ê≠£Âú®Ê∏ÖÁêÜÂ≠§Á´ãÊï∞ÊçÆ...', 'info');
                
                let cleanupCount = 0;
                
                // 1. Ê∏ÖÁêÜËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠‰∏çÂ≠òÂú®ÁöÑËßíËâ≤ID
                const validCharacterIds = characters.map(char => char.id);
                const originalContactsLength = contacts.length;
                contacts = contacts.filter(contactId => {
                    const isValid = validCharacterIds.includes(contactId);
                    if (!isValid) cleanupCount++;
                    return isValid;
                });
                
                // 2. ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Ê∏ÖÁêÜÂ≠§Á´ãÁöÑËÅîÁ≥ª‰∫∫ËÆ∞ÂΩï
                const dbContacts = await db.contacts.toArray();
                for (const contact of dbContacts) {
                    if (!validCharacterIds.includes(contact.characterId)) {
                        await db.contacts.delete(contact.id);
                        cleanupCount++;
                    }
                }
                
                // 3. Ê∏ÖÁêÜËÅäÂ§©Ê∂àÊÅØ‰∏≠‰∏çÂ≠òÂú®ËßíËâ≤ÁöÑËÆ∞ÂΩï
                const chatMessageKeys = Object.keys(chatMessages);
                for (const characterId of chatMessageKeys) {
                    if (!validCharacterIds.includes(characterId)) {
                        delete chatMessages[characterId];
                        cleanupCount++;
                    }
                }
                
                // 4. Ê∏ÖÁêÜÊï∞ÊçÆÂ∫ì‰∏≠Â≠§Á´ãÁöÑËÅäÂ§©Ê∂àÊÅØ
                const dbChatMessages = await db.chatMessages.toArray();
                for (const msgRecord of dbChatMessages) {
                    if (!validCharacterIds.includes(msgRecord.characterId)) {
                        await db.chatMessages.delete(msgRecord.id);
                        cleanupCount++;
                    }
                }
                
                // 5. Ê∏ÖÁêÜËÅäÂ§©ËÆæÁΩÆ‰∏≠‰∏çÂ≠òÂú®ËßíËâ≤ÁöÑËÆ∞ÂΩï
                const chatSettingsKeys = Object.keys(chatSettings);
                for (const characterId of chatSettingsKeys) {
                    if (!validCharacterIds.includes(characterId)) {
                        delete chatSettings[characterId];
                        cleanupCount++;
                    }
                }
                
                // 6. Ê∏ÖÁêÜÊï∞ÊçÆÂ∫ì‰∏≠Â≠§Á´ãÁöÑËÅäÂ§©ËÆæÁΩÆ
                const dbChatSettings = await db.chatSettings.toArray();
                for (const setting of dbChatSettings) {
                    if (!validCharacterIds.includes(setting.characterId)) {
                        await db.chatSettings.delete(setting.id);
                        cleanupCount++;
                    }
                }
                
                // 7. Ê∏ÖÁêÜÂä®ÊÄÅËØÑËÆ∫‰∏≠‰∏çÂ≠òÂú®ËßíËâ≤ÁöÑËÆ∞ÂΩï
                const dbMomentComments = await db.momentComments.toArray();
                for (const comment of dbMomentComments) {
                    // Ê∏ÖÁêÜauthorId‰∏çÂú®ËßíËâ≤ÂàóË°®‰∏≠‰∏î‰∏çÊòØÁî®Êà∑ÁöÑËØÑËÆ∫
                    if (comment.authorId !== 'user' && !validCharacterIds.includes(comment.authorId)) {
                        await db.momentComments.delete(comment.id);
                        cleanupCount++;
                        console.log(`Âà†Èô§‰∫ÜÂ≠§Á´ãËØÑËÆ∫Ôºö${comment.nickname}(${comment.authorId})`);
                    }
                }
                
                // 8. Ê∏ÖÁêÜÂä®ÊÄÅÁÇπËµû‰∏≠‰∏çÂ≠òÂú®ËßíËâ≤ÁöÑËÆ∞ÂΩï
                const dbMomentLikes = await db.momentLikes.toArray();
                for (const like of dbMomentLikes) {
                    // Ê∏ÖÁêÜauthorId‰∏çÂú®ËßíËâ≤ÂàóË°®‰∏≠‰∏î‰∏çÊòØÁî®Êà∑ÁöÑÁÇπËµû
                    if (like.authorId !== 'user' && !validCharacterIds.includes(like.authorId)) {
                        await db.momentLikes.delete([like.momentId, like.authorId]);
                        cleanupCount++;
                        console.log(`Âà†Èô§‰∫ÜÂ≠§Á´ãÁÇπËµûÔºö${like.name}(${like.authorId})`);
                    }
                }
                
                // 9. ‰øùÂ≠òÊ∏ÖÁêÜÂêéÁöÑÊï∞ÊçÆ
                await Promise.all([
                    saveContacts(),
                    saveChatMessages(),
                    saveChatSettings()
                ]);
                
                // 10. ÈáçÊñ∞Ê∏≤ÊüìÁïåÈù¢
                renderContactList();
                renderMessageList();
                
                showToast(`Ê∏ÖÁêÜÂÆåÊàêÔºÅÂÖ±Ê∏ÖÁêÜ‰∫Ü ${cleanupCount} Êù°Â≠§Á´ãÊï∞ÊçÆ`, 'success');
                
                console.log('Ê∏ÖÁêÜÁªìÊûú:', {
                    ÊúâÊïàËßíËâ≤Êï∞: validCharacterIds.length,
                    Ê∏ÖÁêÜÂâçËÅîÁ≥ª‰∫∫Êï∞: originalContactsLength,
                    Ê∏ÖÁêÜÂêéËÅîÁ≥ª‰∫∫Êï∞: contacts.length,
                    ÊÄªÊ∏ÖÁêÜÈ°πÁõÆ: cleanupCount
                });
                
            } catch (error) {
                console.error('Ê∏ÖÁêÜÂ≠§Á´ãÊï∞ÊçÆÂ§±Ë¥•:', error);
                showToast('Ê∏ÖÁêÜÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
        async function clearAllData() {
            const confirm = prompt('Ë≠¶ÂëäÔºöÂ∞ÜÂà†Èô§ÊâÄÊúâÊï∞ÊçÆ‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ\nËæìÂÖ•"Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ"Á°ÆËÆ§Ôºö');
            if (confirm !== 'Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ') return;
            
            try {
                showToast('Ê∏ÖÁ©∫‰∏≠...', 'info');
                
                // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÂ∫ìË°®
                await Promise.all([
                    db.characters.clear(),
                    db.chatMessages.clear(), 
                    db.chatSettings.clear(),
                    db.customEmojis.clear(),
                    db.worldbooks.clear() // Á°Æ‰øù‰πüÊ∏ÖÁ©∫‰∏ñÁïå‰π¶Êï∞ÊçÆ
                ]);
                
                // ÈáçÁΩÆÂÜÖÂ≠ò‰∏≠ÁöÑÂÖ®Â±ÄÂèòÈáè
                characters = [];
                chatMessages = {};
                chatSettings = {};
                customEmojis = [];
                contacts = [];
                groupChats = [];
                currentChatCharacter = null;
                
                // Ê∏ÖÁêÜlocalStorage‰∏≠ÁöÑÂ§á‰ªΩÊï∞ÊçÆ
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    // Ê∏ÖÈô§ÊâÄÊúâËÅäÂ§©ËÆæÁΩÆÂíåÂÖ∂‰ªñÂ∫îÁî®Êï∞ÊçÆ
                    if (key?.startsWith('chatSettings_') || 
                        key?.startsWith('contacts') || 
                        key?.startsWith('characters') || 
                        key?.startsWith('chatMessages')) {
                        localStorage.removeItem(key);
                    }
                }
                
                // Âà∑Êñ∞ÁïåÈù¢
                renderCharacterList();
                renderMessageList();
                renderContactList();
                calculateStorageUsage();
                
                showToast('Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ', 'success');
                console.log('‚úÖ ÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫ÔºåÂåÖÊã¨ËÅäÂ§©ËÆæÁΩÆ„ÄÅËßíËâ≤Êï∞ÊçÆ„ÄÅËÅäÂ§©ËÆ∞ÂΩïÂíå‰∏ñÁïå‰π¶');
                
                // ËøîÂõû‰∏ªÁïåÈù¢
                setTimeout(() => {
                    hideApp('data-management-screen');
                    hideApp('settings-screen');
                    showApp('chat-screen');
                }, 2000);
            } catch (error) {
                console.error('Ê∏ÖÁ©∫Êï∞ÊçÆÂ§±Ë¥•:', error);
                showToast('Ê∏ÖÁ©∫Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ÈáçÂ§çÂáΩÊï∞Â∑≤Âà†Èô§

        // ËΩ¨Ë¥¶Áõ∏ÂÖ≥ÂèòÈáè
        let currentTransferMsg = null;
        
        // Â§ÑÁêÜÁî®Êà∑ÂèëÈÄÅÁªôAIÁöÑËΩ¨Ë¥¶
        async function processUserTransfer(userTransferMsg, aiMessages) {
            console.log('üöÄ processUserTransfer Ë¢´Ë∞ÉÁî®:', {
                userTransferMsg,
                aiMessages,
                currentCharacter: currentChatCharacter?.name
            });
            
            if (!userTransferMsg || !currentChatCharacter) {
                console.log('‚ùå processUserTransfer ÈÄÄÂá∫ÔºöÁº∫Â∞ëÂøÖË¶ÅÂèÇÊï∞');
                return;
            }
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            
            // ÂàÜÊûêAIÁöÑÂõûÂ§çÂÜÖÂÆπÔºåÂà§Êñ≠ÊòØÂê¶ÊúâËΩ¨Ë¥¶Áõ∏ÂÖ≥Êìç‰Ωú
            let transferAction = null;
            let transferActionReason = '';
            
            for (const msgData of aiMessages) {
                // Ê£ÄÊü•AIÊòØÂê¶Âú®ÂõûÂ§ç‰∏≠ÊòéÁ°ÆÂ§ÑÁêÜ‰∫ÜËΩ¨Ë¥¶
                if (typeof msgData === 'object' && msgData.type === 'transfer_action') {
                    transferAction = msgData.action; // 'accept', 'reject', 'ignore'
                    transferActionReason = msgData.reason || '';
                    break;
                }
                
                // Ê£ÄÊü•AIÁöÑÊôÆÈÄöÂõûÂ§ç‰∏≠ÊòØÂê¶ÂåÖÂê´ËΩ¨Ë¥¶Â§ÑÁêÜÁöÑÂÖ≥ÈîÆËØç
                if (typeof msgData === 'string') {
                    const content = msgData.toLowerCase();
                    console.log('üî• [ËΩ¨Ë¥¶Â§ÑÁêÜ] ÂàÜÊûêAIÂõûÂ§çÂÜÖÂÆπ:', content);
                    
                    if (content.includes('Êî∂‰∏ã') || content.includes('Ë∞¢Ë∞¢') || content.includes('Êî∂Ê¨æ') || content.includes('Êé•Âèó') || 
                        content.includes('Á°ÆËÆ§Êî∂Ê¨æ') || content.includes('Â∑≤Êî∂Ê¨æ') || content.includes('Êî∂Âà∞‰∫Ü') || content.includes('Êî∂Âà∞') ||
                        content.includes('ÊÑüË∞¢') || content.includes('Â•ΩÁöÑ') || content.includes('ok') || 
                        content.includes('Ê≤°ÈóÆÈ¢ò') || content.includes('ÂèØ‰ª•')) {
                        transferAction = 'accept';
                        transferActionReason = 'ËßíËâ≤ÂêåÊÑèÊî∂Ê¨æ';
                        console.log('üî• [ËΩ¨Ë¥¶Â§ÑÁêÜ] Ê£ÄÊµãÂà∞Êî∂Ê¨æÂÖ≥ÈîÆËØçÔºåËÆæÁΩÆ‰∏∫accept');
                        break;
                    } else if (content.includes('ÈÄÄÂõû') || content.includes('‰∏çË¶Å') || content.includes('ÊãíÁªù') || 
                              content.includes('‰∏çÈúÄË¶Å') || content.includes('‰∏çÊî∂') || content.includes('ÁÆó‰∫Ü')) {
                        transferAction = 'reject';
                        transferActionReason = 'ËßíËâ≤ÊãíÁªùÊî∂Ê¨æ';
                        console.log('üî• [ËΩ¨Ë¥¶Â§ÑÁêÜ] Ê£ÄÊµãÂà∞ÊãíÁªùÂÖ≥ÈîÆËØçÔºåËÆæÁΩÆ‰∏∫reject');
                        break;
                    } else {
                        console.log('üî• [ËΩ¨Ë¥¶Â§ÑÁêÜ] Êú™Ê£ÄÊµãÂà∞Áõ∏ÂÖ≥ÂÖ≥ÈîÆËØç');
                    }
                }
            }
            
            // Â¶ÇÊûúAIÊòéÁ°ÆË°®Á§∫‰∫ÜËΩ¨Ë¥¶Â§ÑÁêÜÊÑèÂõæÔºåÂàôÊâßË°åÁõ∏Â∫îÊìç‰Ωú
            console.log('üî• [ËΩ¨Ë¥¶Â§ÑÁêÜ] ÊúÄÁªàËΩ¨Ë¥¶Êìç‰ΩúÂÜ≥ÂÆö:', transferAction);
            if (transferAction === 'accept' || transferAction === 'reject') {
                const transferIndex = messages.findIndex(msg => 
                    msg.timestamp === userTransferMsg.timestamp && msg.type === 'transfer' && msg.sender === 'sent');
                    
                if (transferIndex !== -1) {
                    // Êõ¥Êñ∞ËΩ¨Ë¥¶Áä∂ÊÄÅ
                    const newStatus = transferAction === 'accept' ? 'accepted' : 'rejected';
                    messages[transferIndex].status = newStatus;
                    
                    console.log('‚úÖ ËΩ¨Ë¥¶Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞:', {
                        oldStatus: userTransferMsg.status,
                        newStatus: newStatus,
                        message: messages[transferIndex]
                    });
                    
                    // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                    await saveChatMessages();
                    
                    // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
                    const actionText = transferAction === 'accept' ? 'Â∑≤Êî∂Ê¨æ' : 'Â∑≤ÈÄÄÂõû';
                    const systemMsg = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `${currentChatCharacter.name}${actionText} ¬•${Number(userTransferMsg.amount).toFixed(2)}`,
                        timestamp: Date.now()
                    };
                    
                    messages.push(systemMsg);
                    await saveChatMessages();
                    
                    console.log('üì± Á≥ªÁªüÊ∂àÊÅØÂ∑≤Ê∑ªÂä†:', systemMsg);
                    
                    // Á´ãÂç≥ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢‰ª•ÊòæÁ§∫Êõ¥Êñ∞
                    renderChatMessages(currentChatCharacter.id);
                    
                    // ÊòæÁ§∫Á°ÆËÆ§ÊèêÁ§∫
                    const toastText = transferAction === 'accept' ? 'ËΩ¨Ë¥¶Â∑≤Ë¢´Êé•Âèó' : 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÈÄÄÂõû';
                    showToast(toastText, 'success');
                    
                    console.log('üéâ ËΩ¨Ë¥¶Â§ÑÁêÜÂÆåÊàê');
                } else {
                    console.error('‚ùå Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑËΩ¨Ë¥¶Ê∂àÊÅØ');
                }
            } else {
                console.log('‚ÑπÔ∏è AIÊ≤°ÊúâÊòéÁ°ÆË°®ÊÄÅÔºåËΩ¨Ë¥¶‰øùÊåÅpendingÁä∂ÊÄÅ');
            }
            // Â¶ÇÊûúAIÊ≤°ÊúâÊòéÁ°ÆË°®ÊÄÅÔºåËΩ¨Ë¥¶‰øùÊåÅpendingÁä∂ÊÄÅÔºåÁ≠âÂæÖÁî®Êà∑ÊâãÂä®Â§ÑÁêÜÊàñ‰∏ãÊ¨°AIÂõûÂ§ç
        }
        
        // ËΩ¨Ë¥¶Áõ∏ÂÖ≥ÂáΩÊï∞
        function sendTransfer() {
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            const note = document.getElementById('transfer-note').value.trim();
            
            if (!amount || amount <= 0) {
                showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËΩ¨Ë¥¶ÈáëÈ¢ù', 'warning');
                return;
            }
            
            if (amount > 1000000000) {
                showToast('ËΩ¨Ë¥¶ÈáëÈ¢ù‰∏çËÉΩË∂ÖËøá10‰∫øÂÖÉ', 'warning');
                return;
            }
            
            // ÂàõÂª∫ËΩ¨Ë¥¶Ê∂àÊÅØ - ‰øÆÂ§çÊï∞ÊçÆÁªìÊûÑÂíåËÆæÁΩÆpendingUserMessage
            const transferMessage = {
                id: Date.now().toString(),
                sender: 'sent',  // ‰øÆÂ§çÔºö‰ΩøÁî® sender ËÄå‰∏çÊòØ role
                type: 'transfer',
                amount: amount,
                note: note || 'ËΩ¨Ë¥¶',
                timestamp: Date.now()
            };
            
            // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(transferMessage);
            
            // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
            saveChatMessages();
            
            // ‰ΩøÁî®Âä®ÁîªÊ∑ªÂä†Ê∂àÊÅØËÄå‰∏çÊòØÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®
            addMessageWithAnimation(transferMessage, currentChatCharacter.id);
            
            // üî• „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëËÆæÁΩÆ‰∏∫ÂæÖÂõûÂ§çÊ∂àÊÅØÔºåËÆ©AIËÉΩÁúãÂà∞ËΩ¨Ë¥¶
            pendingUserMessage = transferMessage;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
            
            // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
            renderMessageList();
            
            // ÂÖ≥Èó≠ËΩ¨Ë¥¶ÂØπËØùÊ°Ü
            document.getElementById('transfer-modal').classList.remove('visible');
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('transfer-amount').value = '';
            document.getElementById('transfer-note').value = '';
            
            showToast('ËΩ¨Ë¥¶Â∑≤ÂèëÈÄÅ', 'success');
        }
        
        function showTransferConfirmDialog(transferMsg) {
            if (!transferMsg || transferMsg.status) return;
            
            const modal = document.getElementById('transfer-confirm-modal');
            const amountEl = modal.querySelector('.transfer-confirm-amount');
            const noteEl = modal.querySelector('.transfer-confirm-note');
            
            // ËÆæÁΩÆËΩ¨Ë¥¶‰ø°ÊÅØ
            amountEl.textContent = `¬• ${Number(transferMsg.amount).toFixed(2)}`;
            noteEl.textContent = `Â§áÊ≥®Ôºö${transferMsg.note || 'Êó†'}`;
            
            // Â≠òÂÇ®ÂΩìÂâçÂ§ÑÁêÜÁöÑËΩ¨Ë¥¶‰ø°ÊÅØ
            currentTransferMsg = transferMsg;
            
            // ÊòæÁ§∫ÂØπËØùÊ°Ü
            modal.classList.add('visible');
        }
        
        async function acceptTransfer() {
            if (!currentTransferMsg || !currentChatCharacter) return;
            
            // Âú®ËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
            const messages = chatMessages[currentChatCharacter.id] || [];
            const transferIndex = messages.findIndex(msg => 
                msg.timestamp === currentTransferMsg.timestamp && msg.type === 'transfer');
                
            if (transferIndex !== -1) {
                // Êõ¥Êñ∞ËΩ¨Ë¥¶Áä∂ÊÄÅ
                messages[transferIndex].status = 'accepted';
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await saveChatMessages();
                
                // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢
                renderChatMessages(currentChatCharacter.id);
                
                // Ê∑ªÂä†‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÔºåË°®Á§∫Â∑≤Êî∂Ê¨æ
                const systemMsg = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `‰Ω†Â∑≤Á°ÆËÆ§Êî∂Ê¨æ ¬•${Number(currentTransferMsg.amount).toFixed(2)}`,
                    timestamp: Date.now()
                };
                
                messages.push(systemMsg);
                await saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
            }
            
            // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;
            
            showToast('Â∑≤Á°ÆËÆ§Êî∂Ê¨æ', 'success');
        }
        
        async function rejectTransfer() {
            if (!currentTransferMsg || !currentChatCharacter) return;
            
            // Âú®ËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
            const messages = chatMessages[currentChatCharacter.id] || [];
            const transferIndex = messages.findIndex(msg => 
                msg.timestamp === currentTransferMsg.timestamp && msg.type === 'transfer');
                
            if (transferIndex !== -1) {
                // Êõ¥Êñ∞ËΩ¨Ë¥¶Áä∂ÊÄÅ
                messages[transferIndex].status = 'rejected';
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await saveChatMessages();
                
                // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢
                renderChatMessages(currentChatCharacter.id);
                
                // Ê∑ªÂä†‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÔºåË°®Á§∫Â∑≤ÈÄÄÂõû
                const systemMsg = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `‰Ω†Â∑≤ÈÄÄÂõû ¬•${Number(currentTransferMsg.amount).toFixed(2)}`,
                    timestamp: Date.now()
                };
                
                messages.push(systemMsg);
                await saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
            }
            
            // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;
            
            showToast('Â∑≤ÈÄÄÂõûËΩ¨Ë¥¶', 'success');
        }

        // ÁõëÂê¨appÊòæÁ§∫‰∫ã‰ª∂
        const originalShowApp = window.showApp;
        if (originalShowApp) {
            window.showApp = function(appId) {
                originalShowApp(appId);
                if (appId === 'data-management-screen') calculateStorageUsage();
            };
        }

        // ÊòæÁ§∫ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function showScheduleTimesModal() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduledMomentsTimes || [];
            
            const container = document.getElementById('schedule-times-modal-container');
            container.innerHTML = '';
            
            // Ê∏≤ÊüìÂ∑≤ÊúâÊó∂Èó¥ÁÇπ
            scheduleTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'schedule-time-item';
                timeItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    margin-bottom: 10px;
                    gap: 10px;
                `;
                timeItem.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${index}, this.value)" 
                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <button onclick="removeScheduleTime(${index})" 
                            style="padding: 8px 12px; background: #ff3b30; color: white; border: none; border-radius: 6px; cursor: pointer;">√ó</button>
                `;
                container.appendChild(timeItem);
            });
            
            showModal('schedule-times-modal');
        }
        
        // Ê∑ªÂä†ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function addScheduleTime() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduledMomentsTimes) {
                chatSettings.scheduledMomentsTimes = [];
            }
            
            if (chatSettings.scheduledMomentsTimes.length >= 10) {
                alert('ÊúÄÂ§öÂè™ËÉΩËÆæÁΩÆ10‰∏™Êó∂Èó¥ÁÇπ');
                return;
            }
            
            chatSettings.scheduledMomentsTimes.push('09:00');
            saveCurrentChatSettings(chatSettings);
            showScheduleTimesModal(); // ÈáçÊñ∞Ê∏≤Êüì
        }
        
        // Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function updateScheduleTime(index, newTime) {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduledMomentsTimes && chatSettings.scheduledMomentsTimes[index] !== undefined) {
                chatSettings.scheduledMomentsTimes[index] = newTime;
                saveCurrentChatSettings(chatSettings);
            }
        }
        
        // ÁßªÈô§ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function removeScheduleTime(index) {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduledMomentsTimes && chatSettings.scheduledMomentsTimes[index] !== undefined) {
                chatSettings.scheduledMomentsTimes.splice(index, 1);
                saveCurrentChatSettings(chatSettings);
                showScheduleTimesModal(); // ÈáçÊñ∞Ê∏≤Êüì
            }
        }
        
        // ‰øùÂ≠òÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ
        function saveScheduleTimes() {
            if (!currentChatCharacter) return;
            
            const container = document.getElementById('schedule-times-modal-container');
            const timeInputs = container.querySelectorAll('input[type="time"]');
            const times = Array.from(timeInputs).map(input => input.value).filter(time => time);
            
            const chatSettings = getCurrentChatSettings();
            chatSettings.scheduledMomentsTimes = times;
            saveCurrentChatSettings(chatSettings);
            
            updateScheduleTimesDisplay();
            hideModal('schedule-times-modal');
            
            // ÈáçÊñ∞ÂàùÂßãÂåñÂÖ®Â±ÄÂä®ÊÄÅÂèëÂ∏ÉÁ≥ªÁªü‰ª•Â∫îÁî®Êñ∞ËÆæÁΩÆ
            setTimeout(async () => {
                try {
                    await initGlobalMomentsSystem();
                    console.log('‚úÖ ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆÂ∑≤Êõ¥Êñ∞');
                } catch (error) {
                    console.error('‚ùå Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆÂ§±Ë¥•:', error);
                }
            }, 500);
            
            showToast(`Â∑≤‰øùÂ≠ò ${times.length} ‰∏™ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ`, 'success');
        }
        
        // Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÊòæÁ§∫
        function updateScheduleTimesDisplay() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduledMomentsTimes || [];
            const displayElement = document.getElementById('schedule-times-display');
            
            if (scheduleTimes.length === 0) {
                displayElement.textContent = 'Êú™ËÆæÁΩÆ';
            } else if (scheduleTimes.length === 1) {
                displayElement.textContent = `1‰∏™Êó∂Èó¥ÁÇπ (${scheduleTimes[0]})`;
            } else {
                displayElement.textContent = `${scheduleTimes.length}‰∏™Êó∂Èó¥ÁÇπ`;
            }
        }
        
        // ÊµãËØïÂèëÂ∏ÉÂä®ÊÄÅ
        async function testPublishMoment() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }
            
            const button = document.querySelector('button[onclick="testPublishMoment()"]');
            const originalText = button.textContent;
            button.textContent = 'ÂèëÂ∏É‰∏≠...';
            button.disabled = true;
            
            try {
                await triggerBackgroundMomentsTest(currentChatCharacter.id);
                showToast('ÊµãËØïÂä®ÊÄÅÂèëÂ∏ÉÊàêÂäüÔºÅ', 'success');
            } catch (error) {
                console.error('ÊµãËØïÂèëÂ∏ÉÂ§±Ë¥•:', error);
                showToast('ÊµãËØïÂèëÂ∏ÉÂ§±Ë¥•', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // ÂàùÂßãÂåñÂÆöÊó∂ÂèëÂ∏ÉÁ≥ªÁªü
        function initScheduledMomentsSystem() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduledMomentsEnabled || !chatSettings.scheduledMomentsTimes?.length) {
                return;
            }
            
            // ‰∏∫ÊØè‰∏™ËÆæÂÆöÊó∂Èó¥ÂàõÂª∫ÂÆöÊó∂Âô®
            chatSettings.scheduledMomentsTimes.forEach(time => {
                if (!time) return;
                
                const [hours, minutes] = time.split(':').map(Number);
                const now = new Date();
                const scheduledTime = new Date();
                
                scheduledTime.setHours(hours, minutes, 0, 0);
                
                // Â¶ÇÊûúÊó∂Èó¥Â∑≤ËøáÔºåËÆæÁΩÆ‰∏∫ÊòéÂ§©
                if (scheduledTime <= now) {
                    scheduledTime.setDate(scheduledTime.getDate() + 1);
                }
                
                const delay = scheduledTime.getTime() - now.getTime();
                
                setTimeout(() => {
                    // ÊâßË°åÂÆöÊó∂ÂèëÂ∏É
                    triggerBackgroundMoments(currentChatCharacter.id);
                    
                    // ËÆæÁΩÆÊØè24Â∞èÊó∂ÈáçÂ§çÊâßË°å
                    setInterval(() => {
                        triggerBackgroundMoments(currentChatCharacter.id);
                    }, 24 * 60 * 60 * 1000);
                }, delay);
            });
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊé®ÈÄÅÈÄöÁü•ÂäüËÉΩ
        // üî•„ÄêÊñ∞Â¢û„ÄëÈÄöÁü•ÈòüÂàóÂíåÂçï‰∏™ÈÄöÁü•ÁÆ°ÁêÜ
        let notificationQueue = [];
        let currentNotification = null;
        let isProcessingQueue = false;

        // üî•„Äê‰øÆÂ§ç„ÄëÂàõÂª∫Êé®ÈÄÅÈÄöÁü• - Êîπ‰∏∫ÈòüÂàóÊñπÂºèÔºåÂçï‰∏™ÊòæÁ§∫
        function createPushNotification(character, messageData, delay = 0) {
            // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•Áî®Êà∑ÊòØÂê¶Âú®ËÅäÂ§©ÁïåÈù¢ - ‰ΩøÁî®Êõ¥ÂèØÈù†ÁöÑÊñπÊ≥ï
            
            // ÊñπÊ≥ï1ÔºöÊ£ÄÊü•‰∏ªÂ±èÂπïÊòØÂê¶ÂèØËßÅÔºàÊõ¥ÂèØÈù†Ôºâ
            const phoneScreen = document.getElementById('phone-screen');
            const isOnMainScreen = phoneScreen && window.getComputedStyle(phoneScreen).display !== 'none';
            
            // ÊñπÊ≥ï2ÔºöÊ£ÄÊü•ËÅäÂ§©ÁïåÈù¢ÊòØÂê¶ÂèØËßÅ
            const chatScreen = document.getElementById('api-chat-screen');
            const isChatVisible = chatScreen && window.getComputedStyle(chatScreen).display !== 'none';
            
            console.log('üîî [Êé®ÈÄÅÈÄöÁü•] Ê£ÄÊü•ÁïåÈù¢Áä∂ÊÄÅ:', {
                mainScreenVisible: isOnMainScreen,
                chatScreenVisible: isChatVisible,
                shouldShowNotification: isOnMainScreen && !isChatVisible
            });
            
            // Âè™ÊúâÂú®‰∏ªÂ±èÂπïÂèØËßÅ‰∏îËÅäÂ§©ÁïåÈù¢‰∏çÂèØËßÅÊó∂ÊâçÊòæÁ§∫Êé®ÈÄÅ
            if (!isOnMainScreen || isChatVisible) {
                console.log('üîî [Êé®ÈÄÅÈÄöÁü•] Áî®Êà∑‰∏çÂú®‰∏ªÂ±èÂπïÊàñÊ≠£Âú®ËÅäÂ§©ÁïåÈù¢Ôºå‰∏çÊòæÁ§∫Êé®ÈÄÅ');
                return;
            }
            
            // Ê∑ªÂä†Âà∞ÈòüÂàó
            notificationQueue.push({
                character,
                messageData,
                delay
            });
            
            console.log('üîî [Êé®ÈÄÅÈÄöÁü•] Ê∑ªÂä†ÈÄöÁü•Âà∞ÈòüÂàóÔºåÂΩìÂâçÈòüÂàóÈïøÂ∫¶:', notificationQueue.length);
            
            // ÂºÄÂßãÂ§ÑÁêÜÈòüÂàó
            processNotificationQueue();
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÈÄöÁü•ÈòüÂàó
        function processNotificationQueue() {
            if (isProcessingQueue || notificationQueue.length === 0) {
                return;
            }
            
            isProcessingQueue = true;
            console.log('üîî [Êé®ÈÄÅÈÄöÁü•] ÂºÄÂßãÂ§ÑÁêÜÈòüÂàóÔºåÂâ©‰ΩôÈÄöÁü•Êï∞:', notificationQueue.length);
            
            const processNext = () => {
                if (notificationQueue.length === 0) {
                    isProcessingQueue = false;
                    console.log('üîî [Êé®ÈÄÅÈÄöÁü•] ÈòüÂàóÂ§ÑÁêÜÂÆåÊàê');
                    return;
                }
                
                const { character, messageData, delay } = notificationQueue.shift();
                
                setTimeout(() => {
                    showSingleNotification(character, messageData);
                    
                    // 1.5ÁßíÂêéÂ§ÑÁêÜ‰∏ã‰∏Ä‰∏™ÈÄöÁü•
                    setTimeout(() => {
                        processNext();
                    }, 1500);
                }, delay);
            };
            
            processNext();
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊòæÁ§∫Âçï‰∏™ÈÄöÁü•
        function showSingleNotification(character, messageData) {
            console.log('üîî [Êé®ÈÄÅÈÄöÁü•] ÊòæÁ§∫Âçï‰∏™ÈÄöÁü•ÔºåËßíËâ≤:', character.name);
            
            const container = document.getElementById('notification-container');
            if (!container) {
                console.error('üîî [Êé®ÈÄÅÈÄöÁü•] Êâæ‰∏çÂà∞ÈÄöÁü•ÂÆπÂô®!');
                return;
            }
            
            // Â¶ÇÊûúÊúâÁé∞ÊúâÈÄöÁü•ÔºåÂÖàÁßªÈô§
            if (currentNotification) {
                hideNotification(currentNotification, true);
            }
            
            // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = 'push-notification';
            currentNotification = notification;
            
            // ÁîüÊàêÈÄöÁü•ÂÜÖÂÆπ
            let notificationText = '';
            let notificationType = 'message';
            let senderName = character.name;
            
            if (typeof messageData === 'string') {
                notificationText = messageData;
            } else if (typeof messageData === 'object') {
                // üî•„Äê‰øÆÂ§ç„ÄëÂ§ÑÁêÜÁæ§ËÅäÊ∂àÊÅØÊ†ºÂºè
                if (messageData.name && messageData.message) {
                    // Áæ§ËÅäÊ∂àÊÅØÊ†ºÂºè: {name: "ËßíËâ≤Âêç", message: "Ê∂àÊÅØÂÜÖÂÆπ"}
                    senderName = messageData.name;
                    
                    if (typeof messageData.message === 'string') {
                        notificationText = messageData.message;
                    } else if (typeof messageData.message === 'object' && messageData.message.type) {
                        // Áæ§ËÅä‰∏≠ÁöÑÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                        switch (messageData.message.type) {
                            case 'transfer':
                                notificationText = `Âêë‰Ω†ËΩ¨Ë¥¶‰∫Ü ¬•${messageData.message.amount}`;
                                notificationType = 'transfer';
                                break;
                            case 'voice_message':
                                notificationText = '[ËØ≠Èü≥Ê∂àÊÅØ]';
                                notificationType = 'voice';
                                break;
                            default:
                                notificationText = messageData.message.content || '[Ê∂àÊÅØ]';
                        }
                    } else {
                        notificationText = String(messageData.message);
                    }
                } else if (messageData.type) {
                    // ÊôÆÈÄöÁöÑÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                    switch (messageData.type) {
                        case 'transfer':
                            notificationText = `Âêë‰Ω†ËΩ¨Ë¥¶‰∫Ü ¬•${messageData.amount}`;
                            notificationType = 'transfer';
                            break;
                        case 'voice_message':
                            notificationText = '[ËØ≠Èü≥Ê∂àÊÅØ]';
                            notificationType = 'voice';
                            break;
                        case 'ai_image':
                            notificationText = '[ÂõæÁâá]';
                            notificationType = 'image';
                            break;
                        case 'emoji':
                            notificationText = `ÂèëÈÄÅ‰∫ÜË°®ÊÉÖÂåÖÔºö${messageData.description}`;
                            notificationType = 'emoji';
                            break;
                        default:
                            notificationText = messageData.content || '[Ê∂àÊÅØ]';
                    }
                } else {
                    notificationText = messageData.content || messageData.message || '[Ê∂àÊÅØ]';
                }
            }
            
            // ÈôêÂà∂ÈÄöÁü•ÊñáÊú¨ÈïøÂ∫¶
            if (notificationText.length > 25) {
                notificationText = notificationText.substring(0, 25) + '...';
            }
            
            // ÁîüÊàêÊó∂Èó¥
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // ËÆæÁΩÆÈÄöÁü•HTML
            notification.innerHTML = `
                <img class="notification-avatar" src="${character.avatarUrl || 'https://via.placeholder.com/28'}" alt="${senderName}">
                <div class="notification-content">
                    <div class="notification-title">${senderName}</div>
                    <div class="notification-message">${notificationText}</div>
                </div>
                <div class="notification-time">${timeString}</div>
            `;
            
            // ÁÇπÂáªÈÄöÁü•ÊâìÂºÄËÅäÂ§©
            notification.onclick = () => {
                console.log('üîî [Êé®ÈÄÅÈÄöÁü•] Áî®Êà∑ÁÇπÂáª‰∫ÜÊé®ÈÄÅÈÄöÁü•ÔºåË∑≥ËΩ¨Âà∞ËÅäÂ§©ÁïåÈù¢');
                
                // Â¶ÇÊûúÊúâËßíËâ≤‰ø°ÊÅØÔºåÁ°Æ‰øùÂàáÊç¢Âà∞ÂØπÂ∫îËßíËâ≤
                if (character && character.id) {
                    console.log('üîî [Êé®ÈÄÅÈÄöÁü•] ÂàáÊç¢Âà∞ËßíËâ≤:', character.name, character.id);
                    // ËÆæÁΩÆÂΩìÂâçËÅäÂ§©ËßíËâ≤
                    currentChatCharacter = character;
                    // Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢Ê†áÈ¢ò
                    const chatTitle = document.getElementById('api-chat-title');
                    if (chatTitle) {
                        chatTitle.textContent = character.name;
                    }
                    // Ê∏≤ÊüìËØ•ËßíËâ≤ÁöÑËÅäÂ§©ËÆ∞ÂΩï
                    renderChatMessages(character.id);
                }
                
                // ÂàáÊç¢Âà∞ËÅäÂ§©ÁïåÈù¢
                showApp('api-chat-screen');
                
                // ÁßªÈô§ÈÄöÁü•
                hideNotification(notification);
                
                console.log('üîî [Êé®ÈÄÅÈÄöÁü•] Ë∑≥ËΩ¨ÂÆåÊàê');
            };
            
            // Ê∑ªÂä†Âà∞ÂÆπÂô®
            container.appendChild(notification);
            
            // ÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                notification.classList.add('show');
            }, 50);
            
            // Ëá™Âä®ÈöêËóè - 1.5ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                if (currentNotification === notification) {
                    hideNotification(notification);
                }
            }, 1500);
        }
        
        function hideNotification(notification, immediate = false) {
            if (notification && notification.parentNode) {
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                // Â¶ÇÊûúÊòØÂΩìÂâçÈÄöÁü•ÔºåÊ∏ÖÈô§ÂºïÁî®
                if (currentNotification === notification) {
                    currentNotification = null;
                }
                
                const removeDelay = immediate ? 0 : 250;
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, removeDelay);
            }
        }
        
        // üî•„ÄêÊñ∞Â¢û„Äë‰∏∫Âä®ÊÄÅ‰∫íÂä®ÂàõÂª∫Êé®ÈÄÅÈÄöÁü•
        function createMomentInteractionNotification(character, interactionType, momentText) {
            let notificationText = '';
            switch (interactionType) {
                case 'like':
                    notificationText = `Ëµû‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`;
                    break;
                case 'comment':
                    notificationText = `ËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`;
                    break;
                default:
                    notificationText = `‰∏é‰Ω†ÁöÑÂä®ÊÄÅ‰∫íÂä®‰∫Ü`;
            }
            
            createPushNotification(character, notificationText);
        }

        // ÂàùÂßãÂåñËΩ¨Ë¥¶ÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('DOMContentLoaded', function() {
            // Ê∑ªÂä†ËΩ¨Ë¥¶Áõ∏ÂÖ≥‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('transfer-cancel-btn')?.addEventListener('click', () => {
                document.getElementById('transfer-modal').classList.remove('visible');
            });
            
            document.getElementById('transfer-confirm-btn')?.addEventListener('click', sendTransfer);
            document.getElementById('transfer-accept-btn')?.addEventListener('click', acceptTransfer);
            document.getElementById('transfer-reject-btn')?.addEventListener('click', rejectTransfer);
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
            document.getElementById('transfer-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('transfer-modal')) {
                    document.getElementById('transfer-modal').classList.remove('visible');
                }
            });
            
            document.getElementById('transfer-confirm-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('transfer-confirm-modal')) {
                    document.getElementById('transfer-confirm-modal').classList.remove('visible');
                    currentTransferMsg = null;
                }
            });
        });

        // Áæ§ËÅäÁõ∏ÂÖ≥ÂáΩÊï∞
        function updateGroupChatInfo() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            // Êõ¥Êñ∞Áæ§ËÅäÂ§¥ÂÉèÈ¢ÑËßà
            const groupAvatarPreview = document.getElementById('group-avatar-preview');
            if (groupAvatarPreview) {
                if (currentChatCharacter.avatarUrl) {
                    groupAvatarPreview.src = currentChatCharacter.avatarUrl;
                } else {
                    // ‰ΩøÁî®ÈªòËÆ§ÁöÑÁæ§ËÅäÂ§¥ÂÉè - ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑCanvasÂ§¥ÂÉè
                    const canvas = document.createElement('canvas');
                    canvas.width = 40;
                    canvas.height = 40;
                    const ctx = canvas.getContext('2d');
                    
                    // ÁªòÂà∂ËìùËâ≤ÂúÜÂΩ¢ËÉåÊôØ
                    ctx.beginPath();
                    ctx.arc(20, 20, 20, 0, 2 * Math.PI);
                    ctx.fillStyle = '#4a84c1';
                    ctx.fill();
                    
                    // ÁªòÂà∂ÁôΩËâ≤"Áæ§"Â≠ó
                    ctx.fillStyle = 'white';
                    ctx.font = '18px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('Áæ§', 20, 20);
                    
                    groupAvatarPreview.src = canvas.toDataURL();
                }
            }
            
            // Êõ¥Êñ∞Áæ§ËÅäÂêçÁß∞ÊòæÁ§∫
            const groupNameDisplay = document.getElementById('group-name-display');
            if (groupNameDisplay) {
                groupNameDisplay.textContent = currentChatCharacter.name || 'Áæ§ËÅäÂêçÁß∞';
            }
            
            // Êõ¥Êñ∞Áæ§ÊàêÂëòÊï∞ÈáèÊòæÁ§∫
            const groupMemberCountDisplay = document.getElementById('group-member-count-display');
            if (groupMemberCountDisplay) {
                const memberCount = currentChatCharacter.members ? currentChatCharacter.members.length : 0;
                // Áæ§ÊàêÂëòÊï∞Èáè = ËßíËâ≤Êï∞Èáè + 1‰∏™Áî®Êà∑
                const totalMemberCount = memberCount + 1;
                groupMemberCountDisplay.textContent = `${totalMemberCount}ÂêçÊàêÂëò`;
            }
            
            // Êõ¥Êñ∞Áæ§ÂÖ¨ÂëäÊòæÁ§∫
            const groupDescriptionDisplay = document.getElementById('group-description-display');
            if (groupDescriptionDisplay) {
                groupDescriptionDisplay.textContent = currentChatCharacter.description || 'Áæ§ÂÖ¨ÂëäÔºöÁÇπÂáªËÆæÁΩÆÁæ§ÂÖ¨Âëä';
            }
            
            // Êõ¥Êñ∞ÊàëÂú®Áæ§ÈáåÁöÑÊòµÁß∞ - ‰ΩøÁî®ÂΩìÂâçÈÄâÊã©ÁöÑÈù¢ÂÖ∑ÂêçÁß∞‰Ωú‰∏∫ÈªòËÆ§ÂÄº
            const currentMyGroupNickname = document.getElementById('current-my-group-nickname');
            if (currentMyGroupNickname) {
                let defaultNickname = 'Êú™ÈÄâÊã©';
        
        // --- Êñ∞Â¢û‰ª£Á†ÅÂºÄÂßã ---
        const chatSettings = getCurrentChatSettings();
        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
        // --- Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ---

                // Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©‰∫ÜÈù¢ÂÖ∑Ôºå‰ΩøÁî®Èù¢ÂÖ∑ÂêçÁß∞
        if (selectedPersona && selectedPersona.name) { // <--- ‰øÆÊîπËøôÈáå
            defaultNickname = selectedPersona.name;
                }
        
        // ‰ºòÂÖàÊòæÁ§∫Áî®Êà∑Âú®Áæ§ËÅä‰∏≠Ëá™Â∑±ËÆæÁΩÆÁöÑÊòµÁß∞ÔºåÂ¶ÇÊûúÊ≤°ÊúâÔºåÂàôÊòæÁ§∫ÂàõÂª∫Áæ§ËÅäÊó∂ÈÄâÊã©ÁöÑË∫´‰ªΩÊòµÁß∞
        currentMyGroupNickname.textContent = chatSettings.myChatNickname || defaultNickname;
            }
            
            // Ê∏≤ÊüìÁæ§ÊàêÂëòÁΩëÊ†º
            renderGroupMembersGrid();
        }
        
        function changeGroupAvatar() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            const tempInput = document.createElement('input');
            tempInput.type = 'file';
            tempInput.accept = 'image/*';
            tempInput.style.display = 'none';
            document.body.appendChild(tempInput);
            
            tempInput.onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËßíËâ≤ÁöÑÂ§¥ÂÉè
                        currentChatCharacter.avatarUrl = event.target.result;
                        
                        // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÈúÄË¶ÅÊõ¥Êñ∞Áæ§ËÅäÊï∞ÊçÆ
                        if (groupChats) {
                            const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                            if (groupIndex !== -1) {
                                groupChats[groupIndex].avatarUrl = event.target.result;
                                await saveGroupChats(groupChats);
                            }
                        }
                        
                        // Êõ¥Êñ∞UIÊòæÁ§∫
                        updateGroupChatInfo();
                        document.getElementById('api-chat-title').textContent = currentChatCharacter.name;
                        
                        // Êõ¥Êñ∞Â§¥ÂÉèÊòæÁ§∫
                        const chatAvatarElement = document.querySelector('#api-chat-screen .message-avatar img');
                        if (chatAvatarElement) {
                            chatAvatarElement.src = event.target.result;
                        }
                        
                        // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®ÂíåËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅäÂ§¥ÂÉè
                        renderContactList();
                        renderMessageList();
                        
                        document.body.removeChild(tempInput);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                } else {
                    document.body.removeChild(tempInput);
                }
            };
            
            tempInput.click();
        }
        
        function changeGroupName() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁæ§ËÅäÂêçÁß∞:', currentChatCharacter.name);
            if (newName && newName.trim() !== '') {
                const trimmedName = newName.trim();
                
                // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËßíËâ≤ÁöÑÂêçÁß∞
                currentChatCharacter.name = trimmedName;
                
                // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÈúÄË¶ÅÊõ¥Êñ∞Áæ§ËÅäÊï∞ÊçÆ
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                        groupChats[groupIndex].name = trimmedName;
                        saveGroupChats(groupChats);
                    }
                }
                
                // Êõ¥Êñ∞UIÊòæÁ§∫
                updateGroupChatInfo();
                document.getElementById('api-chat-title').textContent = trimmedName;
                renderContactList();
                renderMessageList();
            }
        }
        
// --- ËØ∑‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ÔºåÊõøÊç¢ÊéâÊóßÁöÑ showGroupChatMemberSelection Âíå renderGroupMembersGrid ÂáΩÊï∞ ---

// 5. ÊòæÁ§∫Áæ§ÊàêÂëòÈÄâÊã© (Â∑≤‰øÆÊ≠£ÁâàÊú¨)
function showGroupChatMemberSelection(personaId) {
    console.log('‚úÖ Á¨¨‰∫å‰∏™showGroupChatMemberSelectionË¢´Ë∞ÉÁî®ÔºåÊé•Êî∂Âà∞ÁöÑpersonaId:', personaId);
    
    // Á´ãÂç≥Â∞ÜpersonaIdÂ≠òÂÇ®Âà∞ÂÖ®Â±ÄÂèòÈáè‰∏≠ÔºåÁ°Æ‰øù‰∏ç‰ºö‰∏¢Â§±
    window.currentGroupPersonaId = personaId;
    
    // ÈáçÁΩÆË°®Âçï
    document.getElementById('group-chat-name').value = '';
    selectedGroupMembers = [];
    
    const membersContainer = document.getElementById('group-chat-members');
    membersContainer.innerHTML = '';
    
    if (characters.length < 2) {
        membersContainer.innerHTML = '<p class="empty-mount-chats">Ëá≥Â∞ëÈúÄË¶Å2‰∏™ËßíËâ≤ÊâçËÉΩÂàõÂª∫Áæ§ËÅä</p>';
    } else {
        characters.forEach(character => {
            const memberItem = document.createElement('div');
            memberItem.className = 'group-member-item';
            memberItem.onclick = () => toggleGroupMemberSelection(character.id);
            // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÈáçÊñ∞Ê∑ªÂä†‰∫ÜÊòæÁ§∫ËßíËâ≤ÁÆÄ‰ªãÁöÑHTML‰ª£Á†Å
            memberItem.innerHTML = `
                <div class="group-member-checkbox" id="checkbox-${character.id}"></div>
                <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url('${character.avatarUrl}'); background-size: cover; background-position: center;` : ''}">
                    ${character.avatarUrl ? '' : character.name.charAt(0)}
                </div>
                <div class="chat-option-text">
                    <div class="chat-option-title">${character.name}</div>
                    <div class="chat-option-desc">${truncateText(character.bio || 'ÊöÇÊó†ÁÆÄ‰ªã', 80)}</div>
                </div>`;
            membersContainer.appendChild(memberItem);
        });
    }

    // Â∞Ü personaId ÈôÑÂä†Âà∞ÂàõÂª∫ÊåâÈíÆ‰∏ä
    console.log('‚úÖ Âú®Á¨¨‰∫å‰∏™‰ΩçÁΩÆÁªëÂÆöÂàõÂª∫ÊåâÈíÆÔºåpersonaId:', personaId);
    const createBtn = document.getElementById('group-chat-modal').querySelector('.modal-primary');
    createBtn.onclick = () => {
        console.log('‚úÖ Á¨¨‰∫å‰∏™‰ΩçÁΩÆÁöÑÂàõÂª∫Áæ§ËÅäÊåâÈíÆË¢´ÁÇπÂáªÔºåÁõ¥Êé•‰ΩøÁî®ÂèÇÊï∞personaId:', personaId);
        createGroupChat(personaId);
    }; // ÁªëÂÆöÂ∏¶ÂèÇÊï∞ÁöÑÂàõÂª∫ÂáΩÊï∞

    showModal('group-chat-modal');
}


// Ê∏≤ÊüìÁæ§ÊàêÂëòÁΩëÊ†º (Â∑≤‰øÆÊ≠£ÁâàÊú¨)
        function renderGroupMembersGrid() {
            const groupMembersGrid = document.getElementById('group-members-grid');
            if (!groupMembersGrid || !currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
            groupMembersGrid.innerHTML = '';
            
    // --- ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊ≠£Á°ÆËé∑ÂèñÂπ∂ÊòæÁ§∫Áî®Êà∑Âú®ÂΩìÂâçÁæ§ËÅä‰∏≠ÁöÑË∫´‰ªΩ ---
    const chatSettings = getCurrentChatSettings(); // Ëé∑ÂèñÂΩìÂâçÁæ§ËÅäÁöÑ‰∏ìÂ±ûËÆæÁΩÆ
    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    
            let userName = 'Áî®Êà∑';
            let userAvatar = '';
            
    if (selectedPersona) {
        // ‰ºòÂÖà‰ΩøÁî®Áæ§ËÅäËÆæÁΩÆÈáå‰∏∫‚ÄúÊàë‚ÄùÂçïÁã¨ËÆæÁΩÆÁöÑÊòµÁß∞ÂíåÂ§¥ÂÉè
        userName = chatSettings.myChatNickname || selectedPersona.name;
        userAvatar = chatSettings.myChatAvatar || selectedPersona.avatarUrl;
    }
    
    // Ê∑ªÂä†Áî®Êà∑Ëá™Â∑±ÔºàÊéíÂú®Á¨¨‰∏Ä‰ΩçÔºâ
    const userItem = document.createElement('div');
    userItem.className = 'member-item user-member';
    userItem.onclick = () => changeMyGroupAvatar();
            userItem.innerHTML = `
                <img class="member-avatar" src="${userAvatar || createDefaultAvatar(userName)}" alt="${userName}">
                <div class="member-name">${userName}</div>
            `;
            groupMembersGrid.appendChild(userItem);
    // --- ‰øÆÂ§çÁªìÊùü ---
            
            // ÁÑ∂ÂêéÊ∑ªÂä†Áæ§ÂÜÖÁé∞ÊúâËßíËâ≤
            if (currentChatCharacter.members && currentChatCharacter.members.length > 0) {
                currentChatCharacter.members.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    
                    memberItem.innerHTML = `
                        <div class="member-avatar-wrapper">
                            <img class="member-avatar clickable-avatar" 
                                 src="${member.avatarUrl || createDefaultAvatar(member.name)}" 
                                 alt="${member.name}"
                                 onclick="changeMemberAvatar('${member.id}', event)"
                                 title="ÁÇπÂáªÊõ¥Êç¢${member.name}ÁöÑÂ§¥ÂÉè">
                            <div class="avatar-hover-hint">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="member-name">${member.name}</div>
                    `;
                    groupMembersGrid.appendChild(memberItem);
                });
            }
            
            // Ê∑ªÂä†ÈÇÄËØ∑ÊåâÈíÆ
            const addMemberBtn = document.createElement('div');
            addMemberBtn.className = 'member-item add-member';
            addMemberBtn.onclick = () => addGroupMember();
            addMemberBtn.innerHTML = `
                <div class="member-avatar add-avatar">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="member-name">ÈÇÄËØ∑</div>
            `;
            groupMembersGrid.appendChild(addMemberBtn);
            
            // Âè™Ë¶ÅÁæ§ÂÜÖÊúâËßíËâ≤ÊàêÂëòÂ∞±ÊòæÁ§∫ÁßªÈô§ÊåâÈíÆ
            if (currentChatCharacter.members && currentChatCharacter.members.length > 0) {
                const removeMemberBtn = document.createElement('div');
                removeMemberBtn.className = 'member-item remove-member';
                removeMemberBtn.onclick = () => removeGroupMember();
                removeMemberBtn.innerHTML = `
                    <div class="member-avatar remove-avatar">
                        <i class="fas fa-minus"></i>
                    </div>
                    <div class="member-name">ÁßªÈô§</div>
                `;
                groupMembersGrid.appendChild(removeMemberBtn);
            }
        }

// --- ËØ∑Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ---
        
        // ÊòæÁ§∫ÊàêÂëòËØ¶ÊÉÖ
        function showMemberProfile(member) {
            alert(`üë§ Áæ§ÊàêÂëò‰ø°ÊÅØ\n\nÊòµÁß∞Ôºö${member.name}\nËßíËâ≤IDÔºö${member.id}\n\nÁÇπÂáªÂ§¥ÂÉèÂèØ‰ª•Êü•ÁúãËßíËâ≤ËØ¶ÁªÜ‰ø°ÊÅØ`);
        }
        
        // ÊòæÁ§∫Áî®Êà∑Ëá™Â∑±ÁöÑËµÑÊñô
        function showUserProfile() {
            let userName = 'Áî®Êà∑';
            let userInfo = 'Áæ§ËÅäÊàêÂëò';
            
            if (currentPersona) {
                userName = currentPersona.name;
                userInfo = `ÂΩìÂâçÈù¢ÂÖ∑Ôºö${currentPersona.name}`;
                if (currentPersona.description) {
                    userInfo += `\nÈù¢ÂÖ∑ÊèèËø∞Ôºö${currentPersona.description}`;
                }
            } else if (currentChatCharacter.myNickname) {
                userName = currentChatCharacter.myNickname;
                userInfo = `Áæ§ÊòµÁß∞Ôºö${currentChatCharacter.myNickname}`;
            }
            
            alert(`üë§ ÊàëÁöÑ‰ø°ÊÅØ\n\nÊòµÁß∞Ôºö${userName}\nË∫´‰ªΩÔºö${userInfo}\n\nËøôÊòØ‰Ω†Ëá™Â∑±Âú®Áæ§ËÅä‰∏≠ÁöÑ‰ø°ÊÅØ`);
        }
        
        // ÂàõÂª∫ÈªòËÆ§Â§¥ÂÉè
        function createDefaultAvatar(name) {
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            
            // ÈöèÊú∫ËÉåÊôØÈ¢úËâ≤
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF'];
            const bgColor = colors[name.charCodeAt(0) % colors.length];
            
            // ÁªòÂà∂ÂúÜÂΩ¢ËÉåÊôØ
            ctx.beginPath();
            ctx.arc(25, 25, 25, 0, 2 * Math.PI);
            ctx.fillStyle = bgColor;
            ctx.fill();
            
            // ÁªòÂà∂ÊñáÂ≠ó
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(name.charAt(0), 25, 25);
            
            return canvas.toDataURL();
        }
        
        function showGroupMembers() {
            alert('üë• Áæ§ÊàêÂëòÁÆ°ÁêÜÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂ∞ÜÊîØÊåÅ‰ª•‰∏ãÂäüËÉΩÔºö\n‚Ä¢ Êü•ÁúãÁæ§ÊàêÂëòÂàóË°®\n‚Ä¢ ËÆæÁΩÆÁæ§ÁÆ°ÁêÜÂëò\n‚Ä¢ ÁÆ°ÁêÜÁæ§ÊàêÂëòÊùÉÈôê\n‚Ä¢ Á¶ÅË®Ä/Ë∏¢Âá∫Áæ§ËÅä');
        }
        
        async function changeMyGroupNickname() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
    const chatSettings = getCurrentChatSettings();
    const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
    
    const currentNickname = chatSettings.myChatNickname || (selectedPersona ? selectedPersona.name : 'Áî®Êà∑');
    const newNickname = prompt('ËØ∑ËæìÂÖ•ÊàëÂú®Êú¨Áæ§ÁöÑÊòµÁß∞:', currentNickname);

    if (newNickname && newNickname.trim() !== '' && newNickname.trim() !== currentNickname) {
                const trimmedNickname = newNickname.trim();
                
        // 1. Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËÆæÁΩÆ‰∏≠ÁöÑÊòµÁß∞
        chatSettings.myChatNickname = trimmedNickname;
        await saveCurrentChatSettings(chatSettings);
        
        // 2. ÂàõÂª∫Âπ∂Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
        const systemMessage = {
            id: 'system_' + Date.now(),
            sender: 'system',
            content: `‰Ω†Â∑≤Â∞ÜÁæ§ÊòµÁß∞‰øÆÊîπ‰∏∫ "${trimmedNickname}"`,
            timestamp: Date.now()
        };
        
        if (!chatMessages[currentChatCharacter.id]) {
            chatMessages[currentChatCharacter.id] = [];
        }
        chatMessages[currentChatCharacter.id].push(systemMessage);
        await saveChatMessages();
        
        // 3. Êõ¥Êñ∞UI
        updateGroupChatInfo(); // Ëøô‰ºöÂà∑Êñ∞ËÆæÁΩÆÈ°µÈù¢ÁöÑÊòæÁ§∫
        renderChatMessages(currentChatCharacter.id); // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ

        showToast('Áæ§ÊòµÁß∞‰øÆÊîπÊàêÂäüÔºÅ', 'success');
    }
}
// --- Êñ∞Â¢ûÂáΩÊï∞ ---
async function changeMyGroupAvatar() {
    if (!currentChatCharacter) return;

    // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.style.display = 'none';

    // ÂΩìÁî®Êà∑ÈÄâÊã©‰∫ÜÊñá‰ª∂Âêé
    input.onchange = async (e) => {
        if (!e.target.files || !e.target.files[0]) return;
        
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = async (event) => {
            const newAvatarUrl = event.target.result;

            // 1. Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉè
            const chatSettings = getCurrentChatSettings();
            chatSettings.myChatAvatar = newAvatarUrl;
            await saveCurrentChatSettings(chatSettings);
            
            // 2. ÂàõÂª∫Âπ∂Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
            const systemMessage = {
                id: 'system_' + Date.now(),
                sender: 'system',
                content: `‰Ω†Êõ¥Êç¢‰∫ÜÊñ∞Â§¥ÂÉè`,
                timestamp: Date.now()
            };

            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(systemMessage);
            await saveChatMessages();

            // 3. Êõ¥Êñ∞UI
            updateGroupChatInfo(); // Âà∑Êñ∞ËÆæÁΩÆÈ°µÈù¢ÁöÑÊàêÂëòÂàóË°®
            renderChatMessages(currentChatCharacter.id); // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫Êñ∞Â§¥ÂÉèÂíåÁ≥ªÁªüÊ∂àÊÅØ

            showToast('Áæ§Â§¥ÂÉèÊõ¥Êç¢ÊàêÂäüÔºÅ', 'success');
        };
        
        reader.readAsDataURL(file);
        document.body.removeChild(input); // Ê∏ÖÁêÜ‰∏¥Êó∂ÁöÑinputÂÖÉÁ¥†
    };

    document.body.appendChild(input);
    input.click(); // ÂºπÂá∫Êñá‰ª∂ÈÄâÊã©Á™óÂè£
        }
        
        // ÁºñËæëÁæ§ÂÖ¨Âëä
        function editGroupDescription() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            showGroupNoticeModal();
        }
        
        // ÊòæÁ§∫Áæ§ÂÖ¨ÂëäÁºñËæëÊ®°ÊÄÅÊ°Ü
        function showGroupNoticeModal() {
            const modal = document.getElementById('group-notice-modal');
            const textarea = document.getElementById('group-notice-content');
            const charCount = document.getElementById('notice-char-current');
            
            // ËÆæÁΩÆÂΩìÂâçÁæ§ÂÖ¨ÂëäÂÜÖÂÆπ
            const currentDescription = currentChatCharacter?.description || '';
            textarea.value = currentDescription;
            charCount.textContent = currentDescription.length;
            
            // ÁõëÂê¨Â≠óÁ¨¶Êï∞ÂèòÂåñ
            textarea.addEventListener('input', updateNoticeCharCount);
            
            modal.style.display = 'flex';
            setTimeout(() => textarea.focus(), 100);
        }
        
        // ÈöêËóèÁæ§ÂÖ¨ÂëäÁºñËæëÊ®°ÊÄÅÊ°Ü
        function hideGroupNoticeModal() {
            const modal = document.getElementById('group-notice-modal');
            const textarea = document.getElementById('group-notice-content');
            
            // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
            textarea.removeEventListener('input', updateNoticeCharCount);
            
            modal.style.display = 'none';
        }
        
        // Êõ¥Êñ∞Â≠óÁ¨¶ËÆ°Êï∞
        function updateNoticeCharCount() {
            const textarea = document.getElementById('group-notice-content');
            const charCount = document.getElementById('notice-char-current');
            charCount.textContent = textarea.value.length;
            
            // Â¶ÇÊûúË∂ÖËøáÈôêÂà∂ÔºåÂèòËâ≤ÊèêÁ§∫
            if (textarea.value.length > 500) {
                charCount.style.color = '#ff3b30';
            } else if (textarea.value.length > 450) {
                charCount.style.color = '#ff9500';
            } else {
                charCount.style.color = '#007AFF';
            }
        }
        
        // ‰øùÂ≠òÁæ§ÂÖ¨Âëä
        function saveGroupNotice() {
            const textarea = document.getElementById('group-notice-content');
            const newDescription = textarea.value.trim();
            
            if (newDescription.length > 500) {
                alert('Áæ§ÂÖ¨ÂëäÂÜÖÂÆπ‰∏çËÉΩË∂ÖËøá500Â≠ó');
                return;
            }
            
                // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäËßíËâ≤ÁöÑÊèèËø∞
            currentChatCharacter.description = newDescription;
                
                // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÈúÄË¶ÅÊõ¥Êñ∞Áæ§ËÅäÊï∞ÊçÆ
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                    groupChats[groupIndex].description = newDescription;
                        saveGroupChats(groupChats);
                    }
                }
                
                // Êõ¥Êñ∞UIÊòæÁ§∫
                updateGroupChatInfo();
            hideGroupNoticeModal();
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            showToast('‚úÖ Áæ§ÂÖ¨Âëä‰øùÂ≠òÊàêÂäü', 'success');
        }
        
        // Ê∑ªÂä†Áæ§ÊàêÂëò - ‰ªéÁé∞ÊúâËßíËâ≤‰∏≠ÈÄâÊã©
        function addGroupMember() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup) return;
            
            // Ëé∑ÂèñÊâÄÊúâËßíËâ≤ÂàóË°®
            if (!characters || characters.length === 0) {
                alert('ÊöÇÊó†ÂèØÈÇÄËØ∑ÁöÑËßíËâ≤ÔºåËØ∑ÂÖàÂàõÂª∫ËßíËâ≤');
                return;
            }
            
            // ËøáÊª§ÊéâÂ∑≤ÁªèÂú®Áæ§ÈáåÁöÑËßíËâ≤
            const currentMemberIds = currentChatCharacter.members ? currentChatCharacter.members.map(m => m.id) : [];
            const availableCharacters = characters.filter(char => !currentMemberIds.includes(char.id));
            
            if (availableCharacters.length === 0) {
                alert('ÊâÄÊúâËßíËâ≤ÈÉΩÂ∑≤ÁªèÂú®Áæ§Èáå‰∫Ü');
                return;
            }
            
            // ÂàõÂª∫ÁæéËßÇÁöÑÈÄâÊã©ÁïåÈù¢
            showCharacterSelectionModal(availableCharacters, 'ÈÇÄËØ∑Áæ§ÊàêÂëò', 'ËØ∑ÈÄâÊã©Ë¶ÅÈÇÄËØ∑ËøõÁæ§ÁöÑËßíËâ≤Ôºö', (selectedCharacter) => {
                // Ê∑ªÂä†Âà∞Áæ§ÊàêÂëòÂàóË°®
                if (!currentChatCharacter.members) {
                    currentChatCharacter.members = [];
                }
                currentChatCharacter.members.push({
                    id: selectedCharacter.id,
                    name: selectedCharacter.name,
                    avatarUrl: selectedCharacter.avatarUrl
                });
                
                // ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                        groupChats[groupIndex].members = currentChatCharacter.members;
                        saveGroupChats(groupChats);
                    }
                }
                
                // Êõ¥Êñ∞UI
                updateGroupChatInfo();
                renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                showToast(`‚úÖ ${selectedCharacter.name} Â∑≤Âä†ÂÖ•Áæ§ËÅä`, 'success');
            });
        }
        
        // ÁßªÈô§Áæ§ÊàêÂëò
        function removeGroupMember() {
            if (!currentChatCharacter || !currentChatCharacter.isGroup || !currentChatCharacter.members) return;
            
            if (currentChatCharacter.members.length <= 1) {
                alert('Áæ§ËÅäËá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏Ä‰∏™ËßíËâ≤ÊàêÂëòÔºà‰∏çÂåÖÊã¨Áî®Êà∑Ëá™Â∑±Ôºâ');
                return;
            }
            
            // ÂàõÂª∫ÁæéËßÇÁöÑÈÄâÊã©ÁïåÈù¢
            showCharacterSelectionModal(currentChatCharacter.members, 'ÁßªÈô§Áæ§ÊàêÂëò', 'ËØ∑ÈÄâÊã©Ë¶ÅÁßªÂá∫Áæ§ËÅäÁöÑÊàêÂëòÔºö', (selectedMember) => {
                if (confirm(`Á°ÆÂÆöË¶ÅÂ∞Ü ${selectedMember.name} ÁßªÂá∫Áæ§ËÅäÂêóÔºü`)) {
                    // ‰ªéÁæ§ÊàêÂëòÂàóË°®‰∏≠ÁßªÈô§
                    const memberIndex = currentChatCharacter.members.findIndex(m => m.id === selectedMember.id);
                    if (memberIndex !== -1) {
                        currentChatCharacter.members.splice(memberIndex, 1);
                        
                        // ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ
                        if (groupChats) {
                            const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                            if (groupIndex !== -1) {
                                groupChats[groupIndex].members = currentChatCharacter.members;
                                saveGroupChats(groupChats);
                            }
                        }
                        
                        // Êõ¥Êñ∞UI
                        updateGroupChatInfo();
                        renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                        showToast(`‚úÖ ${selectedMember.name} Â∑≤Ë¢´ÁßªÂá∫Áæ§ËÅä`, 'success');
                    }
                }
            });
        }
        
        // Áæ§ÂÖ¨ÂëäÂäüËÉΩ
        function showGroupNotice() {
            const notice = currentChatCharacter?.description || 'ÊöÇÊó†Áæ§ÂÖ¨Âëä';
            alert(`üì¢ Áæ§ÂÖ¨Âëä\n\n${notice}\n\nÁÇπÂáªÁæ§‰ø°ÊÅØÂç°ÁâáÁöÑÂÖ¨ÂëäÂå∫ÂüüÂèØ‰ª•ÁºñËæëÁæ§ÂÖ¨Âëä`);
        }
        

        
        // Áæ§Â∫îÁî®ÂäüËÉΩ
        function showGroupVote() {
            alert('üó≥Ô∏è Áæ§ÊäïÁ•®ÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂ∞ÜÊîØÊåÅ‰ª•‰∏ãÂäüËÉΩÔºö\n‚Ä¢ ÂàõÂª∫ÊäïÁ•®ËØùÈ¢ò\n‚Ä¢ ËÆæÁΩÆÊäïÁ•®ÈÄâÈ°π\n‚Ä¢ ÂÆûÊó∂ÊäïÁ•®ÁªìÊûú\n‚Ä¢ ÊäïÁ•®Êà™Ê≠¢Êó∂Èó¥');
        }
        
        function showGroupActivity() {
            alert('üìÖ Áæ§Ê¥ªÂä®ÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂ∞ÜÊîØÊåÅ‰ª•‰∏ãÂäüËÉΩÔºö\n‚Ä¢ ÂàõÂª∫Áæ§Ê¥ªÂä®\n‚Ä¢ Ê¥ªÂä®Êä•ÂêçÁªüËÆ°\n‚Ä¢ Ê¥ªÂä®ÊèêÈÜí\n‚Ä¢ Ê¥ªÂä®Á≠æÂà∞');
        }
        
        function showGroupTask() {
            alert('‚úÖ Áæ§‰ªªÂä°ÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂ∞ÜÊîØÊåÅ‰ª•‰∏ãÂäüËÉΩÔºö\n‚Ä¢ ÂèëÂ∏ÉÁæ§‰ªªÂä°\n‚Ä¢ ‰ªªÂä°ËÆ§È¢Ü\n‚Ä¢ ÂÆåÊàêÁä∂ÊÄÅË∑üË∏™\n‚Ä¢ ÁßØÂàÜÂ•ñÂä±Á≥ªÁªü');
        }
        
        function showMoreApps() {
            alert('üîß Êõ¥Â§öÁæ§Â∫îÁî®\n\nÂç≥Â∞ÜÊé®Âá∫Ôºö\n‚Ä¢ Áæ§Áõ¥Êí≠\n‚Ä¢ Áæ§Ê∏∏Êàè\n‚Ä¢ Áæ§Á∫¢ÂåÖ\n‚Ä¢ Áæ§Êú∫Âô®‰∫∫\n‚Ä¢ Áæ§Êó•Á®ã\n‚Ä¢ Áæ§Á¨îËÆ∞');
        }
        
        // ÊòæÁ§∫ËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü
        function showCharacterSelectionModal(characterList, title, description, onSelect) {
            const modalHTML = `
                <div class="modal character-selection-modal" id="character-selection-modal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="hideCharacterSelectionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p class="selection-description">${description}</p>
                            <div class="character-selection-grid" id="character-selection-grid">
                                ${characterList.map(char => `
                                    <div class="character-selection-item" data-character-id="${char.id}">
                                        <div class="character-selection-avatar">
                                            <img src="${char.avatarUrl || createDefaultAvatar(char.name)}" alt="${char.name}">
                                        </div>
                                        <div class="character-selection-info">
                                            <div class="character-selection-name">${char.name}</div>
                                            <div class="character-selection-bio">${(char.description || char.bio || 'ÊöÇÊó†ÁÆÄ‰ªã').substring(0, 30)}${(char.description || char.bio || '').length > 30 ? '...' : ''}</div>
                                        </div>
                                        <div class="character-selection-check">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-secondary" onclick="hideCharacterSelectionModal()">ÂèñÊ∂à</button>
                            <button class="modal-primary" id="confirm-selection-btn" onclick="confirmCharacterSelection()" disabled>Á°ÆÂÆö</button>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('character-selection-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            window.characterSelectionCallback = onSelect;
            window.selectedCharacterId = null;
            
            document.querySelectorAll('.character-selection-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.character-selection-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    window.selectedCharacterId = this.dataset.characterId;
                    document.getElementById('confirm-selection-btn').disabled = false;
                });
            });
        }
        
        // ÈöêËóèËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü
        function hideCharacterSelectionModal() {
            const modal = document.getElementById('character-selection-modal');
            if (modal) {
                modal.remove();
            }
            window.characterSelectionCallback = null;
            window.selectedCharacterId = null;
        }
        
        // Á°ÆËÆ§ËßíËâ≤ÈÄâÊã©
        function confirmCharacterSelection() {
            if (!window.selectedCharacterId || !window.characterSelectionCallback) return;
            
            const allCharacters = [...characters, ...(currentChatCharacter.members || [])];
            const selectedCharacter = allCharacters.find(char => char.id === window.selectedCharacterId);
            
            if (selectedCharacter) {
                window.characterSelectionCallback(selectedCharacter);
                hideCharacterSelectionModal();
            }
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÁæ§ÊàêÂëòÂ§¥ÂÉèÊõ¥Êç¢ÂäüËÉΩ
        function changeMemberAvatar(memberId, event) {
            event.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
            
            const member = currentChatCharacter.members.find(m => m.id === memberId);
            if (!member) return;
            
            // ÊòæÁ§∫Â§¥ÂÉèÊõ¥Êç¢Ê®°ÊÄÅÊ°Ü
            showMemberAvatarModal(member);
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊòæÁ§∫Áæ§ÊàêÂëòÂ§¥ÂÉèÊõ¥Êç¢Ê®°ÊÄÅÊ°Ü
        function showMemberAvatarModal(member) {
            const modal = document.getElementById('member-avatar-modal');
            const preview = document.getElementById('member-avatar-preview');
            const memberName = document.getElementById('member-avatar-name');
            const uploadInput = document.getElementById('member-avatar-upload');
            
            // ËÆæÁΩÆÂΩìÂâçÊàêÂëò‰ø°ÊÅØ
            window.currentEditingMember = member;
            memberName.textContent = member.name;
            preview.src = member.avatarUrl || createDefaultAvatar(member.name);
            
            // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
            uploadInput.value = '';
            
            modal.style.display = 'flex';
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÈöêËóèÁæ§ÊàêÂëòÂ§¥ÂÉèÊõ¥Êç¢Ê®°ÊÄÅÊ°Ü
        function hideMemberAvatarModal() {
            const modal = document.getElementById('member-avatar-modal');
            modal.style.display = 'none';
            window.currentEditingMember = null;
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÁæ§ÊàêÂëòÂ§¥ÂÉè‰∏ä‰º†
        function handleMemberAvatarUpload() {
            const uploadInput = document.getElementById('member-avatar-upload');
            uploadInput.click();
        }

        // üî•„ÄêÊñ∞Â¢û„Äë‰øùÂ≠òÁæ§ÊàêÂëòÂ§¥ÂÉè
        function saveMemberAvatar() {
            if (!window.currentEditingMember) return;
            
            const preview = document.getElementById('member-avatar-preview');
            const newAvatarUrl = preview.src;
            
            // Êõ¥Êñ∞Áæ§ÊàêÂëòÂ§¥ÂÉè
            const memberIndex = currentChatCharacter.members.findIndex(m => m.id === window.currentEditingMember.id);
            if (memberIndex !== -1) {
                currentChatCharacter.members[memberIndex].avatarUrl = newAvatarUrl;
                
                // ÂêåÊó∂Êõ¥Êñ∞ÂÖ®Â±ÄËßíËâ≤ÂàóË°®‰∏≠ÁöÑÂ§¥ÂÉè
                const characterIndex = characters.findIndex(c => c.id === window.currentEditingMember.id);
                if (characterIndex !== -1) {
                    characters[characterIndex].avatarUrl = newAvatarUrl;
                    saveCharacters(characters);
                }
                
                // ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ
                if (groupChats) {
                    const groupIndex = groupChats.findIndex(g => g.id === currentChatCharacter.id);
                    if (groupIndex !== -1) {
                        groupChats[groupIndex].members = currentChatCharacter.members;
                        saveGroupChats(groupChats);
                    }
                }
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÂú®Áæ§ËÅäÊ∂àÊÅØ‰∏≠Ê∑ªÂä†Â§¥ÂÉèÊõ¥Êç¢ÊèêÁ§∫
                addAvatarChangeMessage(window.currentEditingMember.name);
                
                // Êõ¥Êñ∞UI
                updateGroupChatInfo();
                renderGroupMembersGrid();
                refreshChatMessages(); // Âà∑Êñ∞ËÅäÂ§©Ê∂àÊÅØÊòæÁ§∫Êñ∞Â§¥ÂÉè
                
                showToast(`‚úÖ ${window.currentEditingMember.name} ÁöÑÂ§¥ÂÉèÂ∑≤Êõ¥Êñ∞`, 'success');
            }
            
            hideMemberAvatarModal();
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∑ªÂä†Â§¥ÂÉèÊõ¥Êç¢Á≥ªÁªüÊ∂àÊÅØ
        function addAvatarChangeMessage(memberName) {
            if (!currentChatCharacter || !chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            const systemMessage = {
                id: 'system_' + Date.now(),
                sender: 'system',
                content: `${memberName} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè`,
                timestamp: Date.now(),
                isSystem: true
            };
            
            chatMessages[currentChatCharacter.id].push(systemMessage);
            saveChatMessages();
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÂà∑Êñ∞ËÅäÂ§©Ê∂àÊÅØ‰ª•ÊòæÁ§∫Êñ∞Â§¥ÂÉè
        function refreshChatMessages() {
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÈáçÁΩÆÁæ§ÊàêÂëòÂ§¥ÂÉè‰∏∫ÈªòËÆ§
        function resetMemberAvatar() {
            if (!window.currentEditingMember) return;
            
            const preview = document.getElementById('member-avatar-preview');
            const defaultAvatar = createDefaultAvatar(window.currentEditingMember.name);
            preview.src = defaultAvatar;
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊï∞ÊçÆÊÅ¢Â§çÊ£ÄÊü•Âíå‰øÆÂ§çÂäüËÉΩ
        async function checkAndFixChatHistory() {
            try {
                console.log('ÂºÄÂßãÊ£ÄÊü•ËÅäÂ§©ÂéÜÂè≤Êï∞ÊçÆ...');
                
                // Ê£ÄÊü•IndexedDB‰∏≠ÁöÑÊï∞ÊçÆ
                const dbMessages = await db.chatMessages.toArray();
                const memoryMessages = chatMessages;
                
                console.log('IndexedDB‰∏≠ÁöÑÊ∂àÊÅØÊï∞:', dbMessages.length);
                console.log('ÂÜÖÂ≠ò‰∏≠ÁöÑËÅäÂ§©Êï∞:', Object.keys(memoryMessages).length);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâlocalStorageÁöÑÂ§á‰ªΩÊï∞ÊçÆ
                const localStorageBackup = localStorage.getItem('chatMessages');
                if (localStorageBackup) {
                    try {
                        const backupData = JSON.parse(localStorageBackup);
                        console.log('ÊâæÂà∞localStorageÂ§á‰ªΩÊï∞ÊçÆ');
                        
                        // ÊØîËæÉÊï∞ÊçÆÊó∂Èó¥Êà≥ÔºåÈÄâÊã©ÊúÄÊñ∞ÁöÑ
                        let shouldUseBackup = false;
                        let newerMessagesCount = 0;
                        
                        for (const [characterId, messages] of Object.entries(backupData)) {
                            if (messages && messages.length > 0) {
                                const latestBackupTime = Math.max(...messages.map(m => m.timestamp || 0));
                                const currentMessages = memoryMessages[characterId] || [];
                                const latestCurrentTime = currentMessages.length > 0 ? 
                                    Math.max(...currentMessages.map(m => m.timestamp || 0)) : 0;
                                
                                if (latestBackupTime > latestCurrentTime) {
                                    console.log(`ËßíËâ≤ ${characterId} ÁöÑÂ§á‰ªΩÊï∞ÊçÆÊõ¥Êñ∞ (Â§á‰ªΩ:${new Date(latestBackupTime)}, ÂΩìÂâç:${new Date(latestCurrentTime)})`);
                                    shouldUseBackup = true;
                                    newerMessagesCount += messages.length - currentMessages.length;
                                }
                            }
                        }
                        
                        if (shouldUseBackup) {
                            const confirmRestore = confirm(`Ê£ÄÊµãÂà∞localStorage‰∏≠ÊúâÊõ¥Êñ∞ÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºÅ\n\nÂèëÁé∞ ${newerMessagesCount} Êù°Êõ¥Êñ∞ÁöÑÊ∂àÊÅØ\n\nÊòØÂê¶ÊÅ¢Â§çËøô‰∫õÊï∞ÊçÆÔºü`);
                            if (confirmRestore) {
                                // ÊÅ¢Â§çÊï∞ÊçÆ
                                Object.assign(chatMessages, backupData);
                                await saveChatMessages();
                                
                                // ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçËÅäÂ§©
                                if (currentChatCharacter) {
                                    renderChatMessages(currentChatCharacter.id);
                                }
                                
                                showToast(`Â∑≤ÊÅ¢Â§ç ${newerMessagesCount} Êù°Ê∂àÊÅØÔºÅ`, 'success');
                                return true;
                            }
                        }
                    } catch (e) {
                        console.error('Ëß£ÊûêÂ§á‰ªΩÊï∞ÊçÆÂ§±Ë¥•:', e);
                    }
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂºÇÂ∏∏ÁöÑÊó∂Èó¥Êà≥ÔºàÊú™Êù•Êó∂Èó¥ÊàñËøáËÄÅÊó∂Èó¥Ôºâ
                let fixedCount = 0;
                const now = Date.now();
                const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);
                
                for (const [characterId, messages] of Object.entries(chatMessages)) {
                    if (messages && Array.isArray(messages)) {
                        for (let i = 0; i < messages.length; i++) {
                            const msg = messages[i];
                            if (!msg.timestamp || msg.timestamp > now || msg.timestamp < oneWeekAgo) {
                                // ‰øÆÂ§çÂºÇÂ∏∏Êó∂Èó¥Êà≥
                                const correctedTime = now - (messages.length - i) * 60000; // ÊåâÈ°∫Â∫èÈÄíÂáè1ÂàÜÈíü
                                console.log(`‰øÆÂ§çÊ∂àÊÅØÊó∂Èó¥Êà≥: ${msg.timestamp} -> ${correctedTime}`);
                                msg.timestamp = correctedTime;
                                fixedCount++;
                            }
                        }
                        
                        // ÈáçÊñ∞ÊéíÂ∫èÊ∂àÊÅØ
                        messages.sort((a, b) => a.timestamp - b.timestamp);
                    }
                }
                
                if (fixedCount > 0) {
                    await saveChatMessages();
                    showToast(`‰øÆÂ§ç‰∫Ü ${fixedCount} Êù°Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥`, 'info');
                }
                
                return false;
            } catch (error) {
                console.error('Ê£ÄÊü•ËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', error);
                return false;
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 14px;
                z-index: 10000;
                opacity: 0;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(10px)';
            }, 100);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ÊñáÊú¨Êà™Êñ≠ÂáΩÊï∞
        function truncateText(text, maxLength = 80) {
            // üî•„Äê‰øÆÂ§ç„ÄëÁ°Æ‰øùtextÊòØÂ≠óÁ¨¶‰∏≤Á±ªÂûã
            if (text === null || text === undefined) {
                return '';
            }
            
            // Â¶ÇÊûú‰∏çÊòØÂ≠óÁ¨¶‰∏≤ÔºåËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
            if (typeof text !== 'string') {
                text = String(text);
            }
            
            if (!text || text.length <= maxLength) return text;
            
            // ÊåâË°åÂàÜÂâ≤ÊñáÊú¨
            const lines = text.split('\n');
            let result = '';
            let lineCount = 0;
            
            for (const line of lines) {
                // ÈôêÂà∂ÊúÄÂ§öÊòæÁ§∫3Ë°å
                if (lineCount >= 3) break;
                
                if (result.length + line.length + 1 <= maxLength) {
                    result += (result ? '\n' : '') + line;
                    lineCount++;
                } else {
                    // Â¶ÇÊûúËøô‰∏ÄË°å‰ºöË∂ÖÂá∫ÈïøÂ∫¶ÈôêÂà∂ÔºåÊà™Êñ≠Âπ∂Ê∑ªÂä†ÁúÅÁï•Âè∑
                    const remaining = maxLength - result.length - 1;
                    if (remaining > 10) { // Á°Æ‰øùÊúâË∂≥Â§üÁ©∫Èó¥ÊòæÁ§∫ÊúâÊÑè‰πâÁöÑÂÜÖÂÆπ
                        result += (result ? '\n' : '') + line.substring(0, remaining - 3) + '...';
                    } else if (!result) {
                        // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄË°åÂ∞±Ë∂ÖÈïøÔºåÁõ¥Êé•Êà™Êñ≠
                        result = line.substring(0, maxLength - 3) + '...';
                    } else {
                        // Âê¶ÂàôÂú®ÂΩìÂâçÁªìÊûúÂêéÂä†ÁúÅÁï•Âè∑
                        result += '...';
                    }
                    break;
                }
            }
            
            return result;
        }
        
        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∂àÊÅØÂàóË°®Â§öÈÄâÂà†Èô§ÂäüËÉΩ
        
        // ËøõÂÖ•Ê∂àÊÅØÂàóË°®Â§öÈÄâÊ®°Âºè
        function enterMessageListMultiSelectMode(conversationId) {
            console.log('Ëß¶ÂèëÈïøÊåâÂ§öÈÄâÊ®°ÂºèÔºåÂØπËØùID:', conversationId); // Ë∞ÉËØï‰ø°ÊÅØ
            isMessageListMultiSelectMode = true;
            selectedConversations = [conversationId]; // Â∞ÜËß¶ÂèëÈïøÊåâÁöÑÂØπËØùÊ∑ªÂä†Âà∞ÈÄâ‰∏≠ÂàóË°®
            renderMessageList(); // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®‰ª•ÊòæÁ§∫Â§öÈÄâÁïåÈù¢
            showToast('Â∑≤ËøõÂÖ•Â§öÈÄâÊ®°ÂºèÔºåÂèØ‰ª•ÈÄâÊã©Â§ö‰∏™ÂØπËØùËøõË°åÂà†Èô§', 'info');
        }
        
        // ÈÄÄÂá∫Ê∂àÊÅØÂàóË°®Â§öÈÄâÊ®°Âºè
        function exitMessageListMultiSelectMode() {
            isMessageListMultiSelectMode = false;
            selectedConversations = [];
            renderMessageList(); // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®ÊÅ¢Â§çÊ≠£Â∏∏Áä∂ÊÄÅ
        }
        
        // ÂàáÊç¢ÂØπËØùÈÄâÊã©Áä∂ÊÄÅ
        function toggleConversationSelection(conversationId) {
            const index = selectedConversations.indexOf(conversationId);
            if (index > -1) {
                selectedConversations.splice(index, 1);
            } else {
                selectedConversations.push(conversationId);
            }
            renderMessageList(); // ÈáçÊñ∞Ê∏≤Êüì‰ª•Êõ¥Êñ∞ÈÄâÊã©Áä∂ÊÄÅ
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂØπËØù
        async function deleteSelectedConversations() {
            if (selectedConversations.length === 0) {
                showToast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÂØπËØù', 'error');
                return;
            }
            
            const count = selectedConversations.length;
            const confirmText = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${count} ‰∏™ÂØπËØùÂêóÔºü\n\nÂà†Èô§ÂêéÂ∞ÜÊ∏ÖÁ©∫ÂØπËØùÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂíå‰∏ìÂ±ûËÆæÁΩÆÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`;
            
            if (confirm(confirmText)) {
                try {
                    // ‰ΩøÁî® for...of Âæ™ÁéØÊù•Á°Æ‰øùÂºÇÊ≠•Êìç‰Ωú‰∏Ä‰∏™Êé•‰∏Ä‰∏™ÂÆåÊàê
                    for (const conversationId of selectedConversations) {
                        // 1. Âà†Èô§ËÅäÂ§©Ê∂àÊÅØ
                    if (chatMessages[conversationId]) {
                        delete chatMessages[conversationId];
                    }
                    
                        // 2. [Ê†∏ÂøÉ‰øÆÂ§ç] ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§Ê≠§ÂØπËØùÁöÑËÆæÁΩÆ
                        await db.chatSettings.delete(conversationId);
                        //    ÂêåÊó∂‰ªéÂÜÖÂ≠ò‰∏≠‰πüÂà†Èô§Ôºå‰øùÊåÅÂêåÊ≠•
                        if (chatSettings[conversationId]) {
                            delete chatSettings[conversationId];
                        }
                        
                        // 2.1 [È¢ùÂ§ñ‰øÆÂ§ç] Âà†Èô§localStorage‰∏≠ÁöÑÂ§á‰ªΩËÆæÁΩÆ
                        localStorage.removeItem(`chatSettings_${conversationId}`);
                        
                        // 2.2 [ÂΩªÂ∫ï‰øÆÂ§ç] Âà†Èô§ËßíËâ≤ÂØπË±°‰∏≠ÁöÑËÉåÊôØËÆæÁΩÆ
                        const character = characters.find(c => c.id === conversationId);
                        if (character) {
                            character.background = null;
                            // ËøôÈáå‰∏çÈúÄË¶ÅÁ´ãÂç≥‰øùÂ≠òÔºåÂêéÈù¢‰ºöÁªü‰∏Ä‰øùÂ≠ò
                        }

                        // 3. Ê≠£Á°ÆÂ§ÑÁêÜÂçïËÅäÂíåÁæ§ËÅäÁöÑÂà†Èô§
                    const groupIndex = groupChats.findIndex(g => g.id === conversationId);
                    if (groupIndex > -1) {
                            // Â¶ÇÊûúÊòØÁæ§ËÅäÔºå‰ªéÁæ§ËÅäÂàóË°®‰∏≠Âà†Èô§
                        groupChats.splice(groupIndex, 1);
                    } else {
                            // Â¶ÇÊûúÊòØÂçïËÅäÔºå‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁßªÈô§
                        const contactIndex = contacts.indexOf(conversationId);
                        if (contactIndex > -1) {
                            contacts.splice(contactIndex, 1);
                        }
                    }
                    }

                    // 4. [ÂºÇÊ≠•‰øùÂ≠ò] Á≠âÂæÖÊâÄÊúâÊï∞ÊçÆ‰øùÂ≠òÊìç‰ΩúÂÆåÊàê
                    await Promise.all([
                        saveChatMessages(),
                        saveGroupChats(),
                        saveContacts(),
                        saveCharacters() // Á°Æ‰øù‰øùÂ≠òËßíËâ≤Êï∞ÊçÆÔºåÂåÖÊã¨ËÉåÊôØËÆæÁΩÆ
                    ]);

                    // 5. ÈÄÄÂá∫Â§öÈÄâÊ®°ÂºèÂπ∂Âà∑Êñ∞UI
                    exitMessageListMultiSelectMode(); // Ëøô‰∏™ÂáΩÊï∞ÂÜÖÈÉ®‰ºöË∞ÉÁî® renderMessageList()
                
                showToast(`‚úÖ Â∑≤Âà†Èô§ ${count} ‰∏™ÂØπËØù`, 'success');

                } catch (error) {
                    console.error("Âà†Èô§ÂØπËØùÊó∂Âá∫Èîô:", error);
                    showToast('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞ÈîôËØØ‰ø°ÊÅØ', 'error');
                }
            }
        }

    </script>
    
    <!-- üî•„ÄêÊñ∞Â¢û„ÄëÁæ§ÊàêÂëòÂ§¥ÂÉèÊõ¥Êç¢Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="member-avatar-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Êõ¥Êç¢ÊàêÂëòÂ§¥ÂÉè</h3>
                <button class="modal-close" onclick="hideMemberAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="member-avatar-form">
                    <div class="current-member-info">
                        <h4 id="member-avatar-name" class="member-name-title">ËßíËâ≤ÂêçÁß∞</h4>
                        <p class="member-info-desc">‰∏∫ËØ•ËßíËâ≤ËÆæÁΩÆÊñ∞ÁöÑÂ§¥ÂÉèÔºåÂ∞ÜÂú®Áæ§ËÅä‰∏≠Á´ãÂç≥ÁîüÊïà</p>
                    </div>
                    
                    <div class="avatar-upload-section">
                        <div class="avatar-preview-large">
                            <img id="member-avatar-preview" src="" alt="Â§¥ÂÉèÈ¢ÑËßà" class="preview-image">
                        </div>
                        
                        <div class="upload-buttons">
                            <button class="upload-btn primary" onclick="handleMemberAvatarUpload()">
                                <i class="fas fa-upload"></i>
                                ÈÄâÊã©Êñ∞Â§¥ÂÉè
                            </button>
                            <button class="upload-btn secondary" onclick="resetMemberAvatar()">
                                <i class="fas fa-undo"></i>
                                ÈáçÁΩÆÈªòËÆ§
                            </button>
                        </div>
                        
                        <input type="file" id="member-avatar-upload" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="avatar-tips">
                        <div class="tips-header">
                            <i class="fas fa-info-circle"></i>
                            <span>Â§¥ÂÉèÊõ¥Êç¢ËØ¥Êòé</span>
                        </div>
                        <div class="tips-content">
                            ‚Ä¢ ÊîØÊåÅJPG„ÄÅPNGÁ≠âÂ∏∏ËßÅÂõæÁâáÊ†ºÂºè<br>
                            ‚Ä¢ Âª∫ËÆÆ‰ΩøÁî®Ê≠£ÊñπÂΩ¢ÂõæÁâáÔºåÊïàÊûúÊõ¥‰Ω≥<br>
                            ‚Ä¢ Â§¥ÂÉèÊõ¥Êç¢ÂêéÂ∞ÜÂú®Áæ§ËÅä‰∏≠Á´ãÂç≥ÊòæÁ§∫<br>
                            ‚Ä¢ ËßíËâ≤‰πüÂèØ‰ª•Âú®ËÅäÂ§©Êó∂Ëá™‰∏ªÊõ¥Êç¢Â§¥ÂÉè
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-secondary" onclick="hideMemberAvatarModal()">ÂèñÊ∂à</button>
                <button class="modal-button modal-primary" onclick="saveMemberAvatar()">‰øùÂ≠òÊõ¥Êîπ</button>
            </div>
        </div>
    </div>

    <!-- Áæ§ÂÖ¨ÂëäÁºñËæëÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="group-notice-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÁºñËæëÁæ§ÂÖ¨Âëä</h3>
                <button class="modal-close" onclick="hideGroupNoticeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="group-notice-form">
                    <div class="form-group">
                        <label class="form-label">Áæ§ÂÖ¨ÂëäÂÜÖÂÆπ</label>
                        <textarea 
                            id="group-notice-content" 
                            class="form-textarea group-notice-textarea" 
                            placeholder="ËæìÂÖ•Áæ§ÂÖ¨ÂëäÂÜÖÂÆπ...&#10;&#10;ÂèØ‰ª•ÂåÖÊã¨Ôºö&#10;‚Ä¢ Áæ§ËßÑÂàôËØ¥Êòé&#10;‚Ä¢ ÈáçË¶ÅÈÄöÁü•&#10;‚Ä¢ Ê¥ªÂä®ÂÆâÊéí&#10;‚Ä¢ ÂÖ∂‰ªñ‰∫ãÈ°π"
                            maxlength="500"></textarea>
                        <div class="notice-char-count">
                            <span id="notice-char-current">0</span>/500Â≠ó
                        </div>
                    </div>
                    <div class="notice-tips">
                        <div class="tips-header">
                            <i class="fas fa-lightbulb"></i>
                            <span>ÂÖ¨ÂëäÂ∞èË¥¥Â£´</span>
                        </div>
                        <div class="tips-content">
                            ‚Ä¢ ÁÆÄÊ¥ÅÊòé‰∫ÜÔºåÁ™ÅÂá∫ÈáçÁÇπ<br>
                            ‚Ä¢ ‰ΩøÁî®ÂèãÂ•ΩÁöÑËØ≠Ë∞É<br>
                            ‚Ä¢ ÂÆöÊúüÊõ¥Êñ∞ÈáçË¶Å‰ø°ÊÅØ<br>
                            ‚Ä¢ ÂèØ‰ª•‰ΩøÁî®emojiÂ¢ûÂä†Ë∂£Âë≥ÊÄß
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideGroupNoticeModal()">ÂèñÊ∂à</button>
                <button class="modal-primary" onclick="saveGroupNotice()">‰øùÂ≠òÂÖ¨Âëä</button>
            </div>
        </div>
    </div>
    
    <!-- ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="schedule-times-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ËÆæÁΩÆ</h3>
                <button class="modal-close" onclick="hideModal('schedule-times-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    ËÆæÁΩÆËßíËâ≤ÊØèÂ§©Ëá™Âä®ÂèëÂ∏ÉÂä®ÊÄÅÁöÑÊó∂Èó¥ÁÇπÔºàÊúÄÂ§ö10‰∏™Ôºâ
                </p>
                <div id="schedule-times-modal-container">
                    <!-- Êó∂Èó¥ËæìÂÖ•È°πÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                </div>
                <button onclick="addScheduleTime()" style="margin-top: 10px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    + Ê∑ªÂä†Êó∂Èó¥ÁÇπ
                </button>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideModal('schedule-times-modal')">ÂèñÊ∂à</button>
                <button class="modal-primary" onclick="saveScheduleTimes()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- Êó•ËÆ∞ÂäüËÉΩÊ®°ÊÄÅÊ°Ü -->
    <div id="diary-menu-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Êó•ËÆ∞</h3>
                <button class="modal-close" onclick="hideDiaryMenu()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="diary-menu-options">
                    <div class="diary-option" onclick="showTodayDiary()">
                        <div class="diary-option-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="diary-option-content">
                            <div class="diary-option-title">‰ªäÊó•Êó•ËÆ∞</div>
                            <div class="diary-option-desc">Êü•Áúã‰ªäÂ§©ÁöÑÊó•ËÆ∞Ôºà‰∏ÄÂ§©Âè™ËÉΩ‰øùÁïô‰∏Ä‰ªΩÔºâ</div>
                        </div>
                    </div>
                    <div class="diary-option" onclick="showPastDiaries()">
                        <div class="diary-option-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="diary-option-content">
                            <div class="diary-option-title">ËøáÂæÄÊó•ËÆ∞</div>
                            <div class="diary-option-desc">Êü•ÁúãÂéÜÂè≤Êó•ËÆ∞ËÆ∞ÂΩï</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰ªäÊó•Êó•ËÆ∞ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü -->
    <div id="today-diary-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‰ªäÊó•Êó•ËÆ∞</h3>
                <div class="diary-actions">
                    <button class="diary-action-btn" onclick="generateTodayDiary()" id="generate-diary-btn" title="ÁîüÊàêÊó•ËÆ∞">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="diary-action-btn secondary edit-btn" onclick="editTodayDiary()" id="edit-diary-btn" title="ÁºñËæëÊó•ËÆ∞" style="display: none;">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
                <button class="modal-close" onclick="hideTodayDiary()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="today-diary-content" class="diary-paper">
                    <!-- Êó•ËÆ∞ÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>

            </div>
        </div>
    </div>

    <!-- ËøáÂæÄÊó•ËÆ∞ÂàóË°®Ê®°ÊÄÅÊ°Ü -->
    <div id="past-diaries-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ËøáÂæÄÊó•ËÆ∞</h3>
                <button class="modal-close" onclick="hidePastDiaries()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="past-diaries-list">
                    <!-- ËøáÂæÄÊó•ËÆ∞ÂàóË°®Â∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ‰ΩçÁΩÆÂàÜ‰∫´Ê®°ÊÄÅÊ°Ü -->
    <div id="location-modal" class="modal" style="display: none;">
        <div class="modal-content location-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÂàÜ‰∫´‰ΩçÁΩÆ</h3>
                <button class="modal-close" onclick="hideLocationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="location-input-section">
                    <label for="location-address">‰ΩçÁΩÆÂêçÁß∞</label>
                    <input type="text" id="location-address" placeholder="ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞ÔºåÂ¶ÇÔºöÂíñÂï°ÂéÖ„ÄÅÂ≠¶Ê†°„ÄÅÂÆ∂..." maxlength="50">
                    
                    <!-- ÊúÄËøë‰ΩøÁî®ÂéÜÂè≤ËÆ∞ÂΩï -->
                    <div class="location-history" id="location-history">
                        <div class="location-history-title">üìç ÊúÄËøë‰ΩøÁî®</div>
                        <div class="location-history-items" id="location-history-items">
                            <div class="location-history-empty">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>
                        </div>
                    </div>
                </div>
                <div class="virtual-map-container">
                    <div class="map-header" style="background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 100%);">
                        <div class="map-location-name" id="map-location-display" style="color: #52c41a;">ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞</div>
                        <div class="map-coordinates" style="color: #73d13d;">116.4074¬∞E, 39.9042¬∞N</div>
                    </div>
                    <div class="virtual-map">
                        <div class="map-background"></div>
                        <!-- ÂºØÊõ≤Ê≤≥ÊµÅ -->
                        <div class="river" style="top: 8%; left: 55%; width: 25px; height: 4px; transform: rotate(30deg);"></div>
                        <div class="river-curve" style="top: 18%; left: 68%; width: 22px; height: 4px; transform: rotate(10deg);"></div>
                        <div class="river" style="top: 26%; left: 78%; width: 20px; height: 4px; transform: rotate(-10deg);"></div>
                        <div class="river-curve" style="top: 32%; left: 85%; width: 18px; height: 4px; transform: rotate(-30deg);"></div>
                        <div class="river" style="top: 60%; left: 5%; width: 28px; height: 4px; transform: rotate(-15deg);"></div>
                        <div class="river-curve" style="top: 68%; left: 25%; width: 25px; height: 4px; transform: rotate(5deg);"></div>
                        <div class="river" style="top: 75%; left: 42%; width: 22px; height: 4px; transform: rotate(20deg);"></div>
                        <!-- ÂÖ¨Âõ≠ÁªøÂú∞ -->
                        <div style="position: absolute; top: 25%; left: 65%; width: 25px; height: 20px; background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 50%, #b7eb8f 100%); border-radius: 3px; opacity: 0.6; z-index: 1;"></div>
                        <div style="position: absolute; top: 50%; left: 15%; width: 30px; height: 25px; background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 50%, #b7eb8f 100%); border-radius: 3px; opacity: 0.6; z-index: 1;"></div>
                        <!-- ÈÅìË∑Ø -->
                        <div class="map-roads">
                            <div class="road road-horizontal" style="top: 30%; left: 0; width: 100%;"></div>
                            <div class="road road-vertical" style="left: 25%; top: 0; height: 100%;"></div>
                            <div class="road road-horizontal" style="top: 70%; left: 0; width: 100%;"></div>
                            <div class="road road-vertical" style="left: 75%; top: 0; height: 100%;"></div>
                        </div>
                        <!-- Âª∫Á≠ëÁâ© -->
                        <div class="map-buildings">
                            <div class="building" style="top: 10%; left: 35%; width: 20px; height: 15px; background: linear-gradient(135deg, #f0f0f0 0%, #d9d9d9 100%); border: 1px solid #bfbfbf; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 15%; left: 55%; width: 25px; height: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border: 1px solid #91d5ff; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 40%; left: 10%; width: 18px; height: 12px; background: linear-gradient(135deg, #fff1f0 0%, #ffd8d6 100%); border: 1px solid #ffaaa5; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 45%; left: 85%; width: 22px; height: 18px; background: linear-gradient(135deg, #f0f0f0 0%, #d9d9d9 100%); border: 1px solid #bfbfbf; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 75%; left: 40%; width: 30px; height: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border: 1px solid #91d5ff; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                            <div class="building" style="top: 80%; left: 15%; width: 20px; height: 15px; background: linear-gradient(135deg, #fff1f0 0%, #ffd8d6 100%); border: 1px solid #ffaaa5; border-radius: 1px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);"></div>
                        </div>
                        <!-- Ê†ëÊú® -->
                        <div style="position: absolute; top: 35%; left: 20%; width: 8px; height: 8px; background: radial-gradient(circle, #52c41a 0%, #389e0d 70%, #237804 100%); border-radius: 50%; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); z-index: 3;"></div>
                        <div style="position: absolute; top: 60%; left: 30%; width: 6px; height: 6px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <div style="position: absolute; top: 12%; left: 70%; width: 7px; height: 7px; background: radial-gradient(circle, #52c41a 0%, #389e0d 70%, #237804 100%); border-radius: 50%; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); z-index: 3;"></div>
                        <div style="position: absolute; top: 85%; left: 90%; width: 5px; height: 5px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <div style="position: absolute; top: 50%; left: 90%; width: 6px; height: 6px; background: radial-gradient(circle, #73d13d 0%, #52c41a 70%, #389e0d 100%); border-radius: 50%; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); z-index: 3;"></div>
                        <!-- ‰ΩçÁΩÆÊ†áËÆ∞ -->
                        <div class="map-marker" id="location-marker">
                            <div class="marker-pin" style="color: #1890ff;">üìç</div>
                        </div>
                        <div class="map-current-location">
                            <div class="current-location-dot"></div>
                        </div>
                    </div>
                    <div class="map-footer">
                        <div class="map-scale">500m</div>
                        <div class="map-controls">
                            <button class="map-control-btn" onclick="randomizeMapPosition()">üéØ ÈáçÊñ∞ÂÆö‰Ωç</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideLocationModal()">ÂèñÊ∂à</button>
                <button class="modal-primary" onclick="sendLocationMessage()">ÂèëÈÄÅ‰ΩçÁΩÆ</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // üî•„ÄêÊñ∞Â¢û„ÄëÁæ§ÊàêÂëòÂ§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨
        document.addEventListener('DOMContentLoaded', function() {
            const memberAvatarUpload = document.getElementById('member-avatar-upload');
            if (memberAvatarUpload) {
                memberAvatarUpload.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('member-avatar-preview');
                            if (preview) {
                                preview.src = event.target.result;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
    </script>

    <!-- üî•„ÄêÊ∞∏‰πÖ‰øÆÂ§ç„ÄëË∫´‰ªΩÈÄâÊã©ÂäüËÉΩËá™Âä®‰øÆÂ§çËÑöÊú¨ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß ÂºÄÂßãÂ∫îÁî®Ë∫´‰ªΩÈÄâÊã©ÂäüËÉΩÊ∞∏‰πÖ‰øÆÂ§ç...');
            
            // ‰øÆÂ§ç1: ÈáçÂÜôshowPersonaSelectionForSingleChatÂáΩÊï∞
            if (typeof showPersonaSelectionForSingleChat === 'function') {
                const originalShowPersonaSelectionForSingleChat = showPersonaSelectionForSingleChat;
                showPersonaSelectionForSingleChat = function() {
                    originalShowPersonaSelectionForSingleChat();
                    
                    // Âª∂Ëøü‰øÆÂ§ç‰∫ã‰ª∂ÁªëÂÆöÔºåÁ°Æ‰øùDOMÂ∑≤ÁîüÊàê
                    setTimeout(() => {
                        const items = document.querySelectorAll('#persona-selection-modal .persona-selection-item');
                        console.log('üîß ‰øÆÂ§çË∫´‰ªΩÈÄâÊã©‰∫ã‰ª∂ÁªëÂÆöÔºåÊâæÂà∞ÂÖÉÁ¥†:', items.length);
                        
                        items.forEach(item => {
                            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                            item.onclick = null;
                            
                            // Ê∑ªÂä†Êñ∞ÁöÑÁÇπÂáª‰∫ã‰ª∂
                            item.addEventListener('click', function() {
                                console.log('Ë∫´‰ªΩÈÄâÊã©ÁÇπÂáª:', this.dataset.personaId);
                                
                                // ÁßªÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                                document.querySelectorAll('#persona-selection-modal .persona-selection-item').forEach(i => {
                                    i.classList.remove('selected');
                                });
                                
                                // ËÆæÁΩÆÂΩìÂâçÂÖÉÁ¥†‰∏∫ÈÄâ‰∏≠
                                this.classList.add('selected');
                                
                                // ‰øùÂ≠òË∫´‰ªΩID
                                window.selectedPersonaForChat = this.dataset.personaId;
                                console.log('ËÆæÁΩÆselectedPersonaForChat:', window.selectedPersonaForChat);
                                
                                // ÂêØÁî®Á°ÆËÆ§ÊåâÈíÆ
                                const confirmBtn = document.getElementById('confirm-persona-btn');
                                if (confirmBtn) {
                                    confirmBtn.disabled = false;
                                }
                            });
                        });
                    }, 100);
                };
            }
            
            // ‰øÆÂ§ç2: ÈáçÂÜôconfirmPersonaAndShowCharactersÂáΩÊï∞
            if (typeof confirmPersonaAndShowCharacters === 'function') {
                confirmPersonaAndShowCharacters = function() {
                    console.log('confirmPersonaAndShowCharactersË∞ÉÁî®ÔºåË∫´‰ªΩID:', window.selectedPersonaForChat);
                    
                    if (!window.selectedPersonaForChat) {
                        console.error('Ë∫´‰ªΩID‰∏∫Á©∫ÔºÅ');
                        return;
                    }
                    
                    // ‰øùÂ≠òË∫´‰ªΩID
                    const savedPersonaId = window.selectedPersonaForChat;
                    
                    // ÈöêËóèÊ®°ÊÄÅÊ°Ü
                    const modal = document.getElementById('persona-selection-modal');
                    if (modal) {
                        modal.remove();
                    }
                    
                    // ÊÅ¢Â§çË∫´‰ªΩID
                    window.selectedPersonaForChat = savedPersonaId;
                    console.log('‰øùÊä§ÂêéÁöÑË∫´‰ªΩID:', window.selectedPersonaForChat);
                    
                    showCharacterSelectionForSingleChat();
                };
            }
            
            // ‰øÆÂ§ç3: ÈáçÂÜôbuildCharacterPromptÂáΩÊï∞
            if (typeof buildCharacterPrompt === 'function') {
                const originalBuildCharacterPrompt = buildCharacterPrompt;
                buildCharacterPrompt = function(character, hasImage = false) {
                    // Ë∞ÉÁî®ÂéüÂáΩÊï∞Ëé∑ÂèñÂü∫Á°Äprompt
                    let characterPrompt = originalBuildCharacterPrompt(character, hasImage);
                    
                    // ÁßªÈô§ÂéüÊúâÁöÑcurrentPersonaÈÄªËæëÔºåÊõøÊç¢‰∏∫‰ªéËÅäÂ§©ËÆæÁΩÆËØªÂèñ
                    const chatSettings = getCurrentChatSettings();
                    if (chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona) {
                            console.log('üîß ‰∏∫ËßíËâ≤', character.name, '‰ΩøÁî®Ë∫´‰ªΩ:', selectedPersona.name);
                            
                            // ÁßªÈô§ÊóßÁöÑË∫´‰ªΩ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
                            const personaRegex = /\n\n# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö[\s\S]*?ËØ∑Ê†πÊçÆÁî®Êà∑ÁöÑËøô‰∏™Èù¢ÂÖ∑Ë∫´‰ªΩÊù•ËøõË°åÂØπËØù„ÄÇ/;
                            characterPrompt = characterPrompt.replace(personaRegex, '');
                            
                            // Ê∑ªÂä†Êñ∞ÁöÑË∫´‰ªΩ‰ø°ÊÅØ
                            const personaInfo = `\n\n# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö\nÁî®Êà∑ÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑ÊòØ"${selectedPersona.name}"${selectedPersona.description ? `Ôºö${selectedPersona.description}` : ''}\nËØ∑Ê†πÊçÆÁî®Êà∑ÁöÑËøô‰∏™Èù¢ÂÖ∑Ë∫´‰ªΩÊù•ËøõË°åÂØπËØù„ÄÇ`;
                            
                            // Âú®ËßíËâ≤ËÆæÂÆöÂêéÊèíÂÖ•Ë∫´‰ªΩ‰ø°ÊÅØ
                            const insertPoint = characterPrompt.indexOf('\n# üî•„Äê‰øÆÂ§ç„ÄëË°®ÊÉÖÂåÖÂ∫ì‰ø°ÊÅØ');
                            if (insertPoint !== -1) {
                                characterPrompt = characterPrompt.slice(0, insertPoint) + personaInfo + characterPrompt.slice(insertPoint);
                            } else {
                                characterPrompt += personaInfo;
                            }
                        }
                    }
                    
                    return characterPrompt;
                };
            }
            
            console.log('‚úÖ Ë∫´‰ªΩÈÄâÊã©ÂäüËÉΩÊ∞∏‰πÖ‰øÆÂ§çÂ∑≤Â∫îÁî®');
        });
    </script>

    <!-- üîß„ÄêÁÆÄÂçï‰øÆÂ§ç„ÄëÁæ§ËÅäË∫´‰ªΩËÆæÁΩÆÁõ¥Êé•‰øÆÂ§ç -->
    <script>
        // ÁÆÄÂçïÁõ¥Êé•ÁöÑÁæ§ËÅäË∫´‰ªΩ‰øÆÂ§ç
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß [ÁÆÄÂçï‰øÆÂ§ç] Áæ§ËÅäË∫´‰ªΩËÆæÁΩÆ‰øÆÂ§çÂêØÂä®...');
            
            // ÈáçÂÜôcreateGroupChatÂáΩÊï∞ÔºåÁ°Æ‰øùË∫´‰ªΩËÆæÁΩÆÁ´ãÂç≥ÁîüÊïà
            if (typeof window.createGroupChat === 'function') {
                const originalCreateGroupChat = window.createGroupChat;
                window.createGroupChat = async function(personaId) {
                    console.log('üîß [‰øÆÂ§ç] createGroupChatË¢´Ë∞ÉÁî®ÔºåË∫´‰ªΩID:', personaId);
                    
                    // Ë∞ÉÁî®ÂéüÂáΩÊï∞Ôºå‰º†ÈÄípersonaIdÂèÇÊï∞
                    await originalCreateGroupChat.call(this, personaId);
                    
                    // Â¶ÇÊûúÊúâÈÄâÊã©Ë∫´‰ªΩÔºåÁ´ãÂç≥Âä†ËΩΩÂà∞ÂÜÖÂ≠ò
                    if (personaId && groupChats && groupChats.length > 0) {
                        const latestGroup = groupChats[groupChats.length - 1];
                        const savedSettings = localStorage.getItem(`chatSettings_${latestGroup.id}`);
                        
                        if (savedSettings) {
                            try {
                                const settings = JSON.parse(savedSettings);
                                window.chatSettings[latestGroup.id] = settings;
                                console.log('üîß [‰øÆÂ§ç] Áæ§ËÅäË∫´‰ªΩËÆæÁΩÆÂ∑≤Âä†ËΩΩÂà∞ÂÜÖÂ≠ò:', settings);
                            } catch (error) {
                                console.error('üîß [‰øÆÂ§ç] Ëß£ÊûêÁæ§ËÅäËÆæÁΩÆÂ§±Ë¥•:', error);
                            }
                        }
                    }
                };
            }
            
            console.log('üîß [ÁÆÄÂçï‰øÆÂ§ç] Áæ§ËÅäË∫´‰ªΩËÆæÁΩÆ‰øÆÂ§çÂÆåÊàê');
        });
    </script>

    <!-- üì±„ÄêÁßªÂä®Á´Ø‰ºòÂåñ„ÄëËæìÂÖ•Ê°ÜviewportË°å‰∏∫‰øÆÂ§ç -->
    <script>
        // ÁßªÂä®Á´ØËæìÂÖ•Ê°Ü‰ºòÂåñ
        (function() {
            'use strict';
            
            console.log('üì± [ÁßªÂä®Á´Ø‰ºòÂåñ] ËæìÂÖ•Ê°ÜviewportË°å‰∏∫‰øÆÂ§çÂêØÂä®...');
            
            let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            let isAndroid = /Android/.test(navigator.userAgent);
            let isMobile = isIOS || isAndroid;
            
            if (!isMobile) {
                console.log('üì± ÈùûÁßªÂä®Á´ØËÆæÂ§áÔºåË∑≥ËøáÁßªÂä®Á´Ø‰ºòÂåñ');
                return;
            }
            
            // Ëé∑ÂèñÊâÄÊúâÂèØËÉΩÁöÑËæìÂÖ•Ê°Ü
            function getAllInputs() {
                return document.querySelectorAll('textarea, input[type="text"], input[type="password"], input[type="email"], input[type="number"]');
            }
            
            // Èò≤Ê≠¢iOS SafariËá™Âä®Áº©Êîæ
            function preventZoom() {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                if (viewportMeta) {
                    viewportMeta.setAttribute('content', 
                        'width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no'
                    );
                }
            }
            
            // ÊÅ¢Â§çÁº©ÊîæÂäüËÉΩ
            function restoreZoom() {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                if (viewportMeta) {
                    viewportMeta.setAttribute('content', 
                        'width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=3.0, user-scalable=yes'
                    );
                }
            }
            
            // ËæìÂÖ•Ê°ÜÁÑ¶ÁÇπÂ§ÑÁêÜ
            function handleInputFocus(e) {
                console.log('üì± ËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπÔºåÈò≤Ê≠¢Ëá™Âä®Áº©Êîæ');
                
                // Èò≤Ê≠¢iOSËá™Âä®Áº©Êîæ
                if (isIOS) {
                    preventZoom();
                }
                
                // Á°Æ‰øùËæìÂÖ•Ê°ÜÂèØËßÅ
                setTimeout(() => {
                    e.target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }, 300);
            }
            
            // ËæìÂÖ•Ê°ÜÂ§±ÁÑ¶Â§ÑÁêÜ
            function handleInputBlur(e) {
                console.log('üì± ËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπÔºåÊÅ¢Â§çÁº©ÊîæÂäüËÉΩ');
                
                // ÊÅ¢Â§çÁº©ÊîæÂäüËÉΩ
                if (isIOS) {
                    setTimeout(() => {
                        restoreZoom();
                    }, 100);
                }
                
                // ÊªöÂä®ÂõûÈ°∂ÈÉ®
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 100);
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂Âà∞ÊâÄÊúâËæìÂÖ•Ê°Ü
            function bindInputEvents() {
                const inputs = getAllInputs();
                console.log(`üì± ÊâæÂà∞ ${inputs.length} ‰∏™ËæìÂÖ•Ê°ÜÔºåÊ≠£Âú®ÁªëÂÆö‰∫ã‰ª∂...`);
                
                inputs.forEach(input => {
                    // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                    input.removeEventListener('focus', handleInputFocus);
                    input.removeEventListener('blur', handleInputBlur);
                    
                    // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    input.addEventListener('focus', handleInputFocus, { passive: true });
                    input.addEventListener('blur', handleInputBlur, { passive: true });
                    
                    // Á°Æ‰øùËæìÂÖ•Ê°ÜÂ≠ó‰ΩìÂ§ßÂ∞èËá≥Â∞ë16pxÔºàÈò≤Ê≠¢iOSÁº©ÊîæÔºâ
                    const computedStyle = window.getComputedStyle(input);
                    const fontSize = parseInt(computedStyle.fontSize);
                    if (fontSize < 16) {
                        input.style.fontSize = '16px';
                        console.log('üì± Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÂ≠ó‰ΩìÂ§ßÂ∞è‰∏∫16pxÔºåÈò≤Ê≠¢iOSÁº©Êîæ');
                    }
                });
            }
            
            // ÁõëÂê¨DOMÂèòÂåñÔºåÂ§ÑÁêÜÂä®ÊÄÅÊ∑ªÂä†ÁöÑËæìÂÖ•Ê°Ü
            const observer = new MutationObserver(function(mutations) {
                let shouldRebind = false;
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                if (node.matches && (node.matches('textarea') || node.matches('input'))) {
                                    shouldRebind = true;
                                } else if (node.querySelector) {
                                    const inputs = node.querySelectorAll('textarea, input');
                                    if (inputs.length > 0) {
                                        shouldRebind = true;
                                    }
                                }
                            }
                        });
                    }
                });
                
                if (shouldRebind) {
                    console.log('üì± Ê£ÄÊµãÂà∞Êñ∞ÁöÑËæìÂÖ•Ê°ÜÔºåÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂...');
                    setTimeout(bindInputEvents, 100);
                }
            });
            
            // ÂºÄÂßãÁõëÂê¨DOMÂèòÂåñ
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁªëÂÆö‰∫ã‰ª∂
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', bindInputEvents);
            } else {
                bindInputEvents();
            }
            
            // È°µÈù¢ÊòæÁ§∫Êó∂ÈáçÊñ∞ÁªëÂÆöÔºàÂ§ÑÁêÜ‰ªéÂêéÂè∞ËøîÂõûÁöÑÊÉÖÂÜµÔºâ
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    setTimeout(bindInputEvents, 100);
                }
            });
            
            console.log('üì± [ÁßªÂä®Á´Ø‰ºòÂåñ] ËæìÂÖ•Ê°ÜviewportË°å‰∏∫‰øÆÂ§çÂ∑≤ÂêØÂä®');
        })();
    </script>

    <!-- üí∞„ÄêËΩ¨Ë¥¶ÂäüËÉΩ‰ºòÂåñ„ÄëËÆ©AIÊ†πÊçÆ‰∫∫ËÆæËá™ÁÑ∂ÂõûÂ∫î -->
    <script>
        // ËΩ¨Ë¥¶ÂäüËÉΩ‰ºòÂåñ - ÁßªÈô§Ëá™Âä®Êî∂Ê¨æÔºåËÆ©AIÊ†πÊçÆ‰∫∫ËÆæËá™ÁÑ∂ÂõûÂ∫î
        (function() {
            'use strict';
            
            console.log('üí∞ [ËΩ¨Ë¥¶‰ºòÂåñ] ÁßªÈô§Ëá™Âä®Êî∂Ê¨æÈÄªËæëÔºåËÆ©AIÊ†πÊçÆ‰∫∫ËÆæËá™ÁÑ∂ÂõûÂ∫î...');
            
            // üî•„ÄêÈáçË¶Å‰øÆÊîπ„ÄëÁßªÈô§Ëá™Âä®Êî∂Ê¨æÈÄªËæëÔºåËÆ©AIÊ†πÊçÆËßíËâ≤‰∫∫ËÆæËá™ÁÑ∂ÂÜ≥ÂÆö
            // ËΩ¨Ë¥¶Áä∂ÊÄÅÂèòÂåñÂ∫îËØ•Áî±AIÁöÑËá™ÁÑ∂ÂõûÂ§çËß¶ÂèëÔºåËÄå‰∏çÊòØËá™Âä®Â§ÑÁêÜ
            // AI‰ºöÊ†πÊçÆËá™Â∑±ÁöÑ‰∫∫ËÆæÔºàÊØîÂ¶ÇÈ´òÂÜ∑„ÄÅÊ∏©Êüî„ÄÅÂÇ≤Â®áÁ≠âÔºâÊù•ÂÜ≥ÂÆöÊòØÂê¶Êî∂Ê¨æ
            
            console.log('üí∞ [ËΩ¨Ë¥¶‰ºòÂåñ] AIÂ∞ÜÊ†πÊçÆËßíËâ≤‰∫∫ËÆæËá™ÁÑ∂ÂõûÂ∫îËΩ¨Ë¥¶Ôºå‰∏çÂÜçËá™Âä®Êî∂Ê¨æ');
        })();
    </script>

    <!-- üö´„ÄêÊãâÈªëÁ≥ªÁªü„ÄëÊ®°ÊÄÅÊ°Ü -->
    <div id="blacklist-settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÊãâÈªëÁÆ°ÁêÜ</h3>
                <button class="modal-close" onclick="hideBlacklistSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="section-header">
                        <i class="fas fa-user-slash section-icon"></i>
                        <span class="section-title">ÂΩìÂâçÁä∂ÊÄÅ</span>
                    </div>
                    <div class="setting-card">
                        <div class="setting-item" id="current-blacklist-status">
                            <div class="setting-left">
                                <div class="setting-label">ÊãâÈªëÁä∂ÊÄÅ</div>
                                <div class="setting-desc" id="blacklist-status-desc">Ê≠£Â∏∏ËÅäÂ§©‰∏≠</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="section-header">
                        <i class="fas fa-cog section-icon"></i>
                        <span class="section-title">ÊãâÈªëËÆæÁΩÆ</span>
                    </div>
                    <div class="setting-card">
                        <div class="setting-item">
                            <div class="setting-left">
                                <div class="setting-label">ÂÜ∑ÈùôÊó∂Èó¥ÔºàÂàÜÈíüÔºâ</div>
                                <div class="setting-desc">ÊãâÈªëÂêéÈúÄË¶ÅÁ≠âÂæÖÁöÑÊó∂Èó¥ÊâçËÉΩÁî≥ËØ∑Â•ΩÂèã</div>
                            </div>
                            <div class="setting-right">
                                <input type="number" id="cooldown-minutes" min="5" max="1440" value="30" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="section-header">
                        <i class="fas fa-exclamation-triangle section-icon danger-section-icon"></i>
                        <span class="section-title danger-section-title">Êìç‰Ωú</span>
                    </div>
                    <div class="setting-card">
                        <div class="setting-item danger-item" id="block-action-item" onclick="performBlockAction()">
                            <div class="setting-left">
                                <div class="setting-label danger-color" id="block-action-label">ÊãâÈªëÊ≠§ËßíËâ≤</div>
                                <div class="setting-desc" id="block-action-desc">ÈòªÊ≠¢ËØ•ËßíËâ≤Âêë‰Ω†ÂèëÈÄÅÊ∂àÊÅØ</div>
                            </div>
                            <div class="setting-right">
                                <i class="fas fa-chevron-right danger-color"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideBlacklistSettings()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <!-- üö´„ÄêÂ•ΩÂèãÁî≥ËØ∑„ÄëÊ®°ÊÄÅÊ°Ü -->
    <div id="friend-request-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Â•ΩÂèãÁî≥ËØ∑</h3>
                <button class="modal-close" onclick="hideFriendRequestModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Áî≥ËØ∑ÁêÜÁî±ÔºàÂèØÈÄâÔºâ</label>
                    <textarea id="friend-request-message" class="form-textarea" placeholder="ËØ∑ËæìÂÖ•Áî≥ËØ∑ÁêÜÁî±..." maxlength="200"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-secondary" onclick="hideFriendRequestModal()">ÂèñÊ∂à</button>
                <button class="modal-primary" onclick="sendFriendRequestConfirm()">ÂèëÈÄÅÁî≥ËØ∑</button>
            </div>
        </div>
    </div>

    <!-- üö´„ÄêÊãâÈªëÁ≥ªÁªü„ÄëJavaScriptÊ†∏ÂøÉÂäüËÉΩ -->
    <script>
        // ÊãâÈªëÁ≥ªÁªüÂÖ®Â±ÄÂèòÈáè - Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÔºåÈÅøÂÖçÈáçÂ§çÂ£∞Êòé
        if (typeof blacklistData === 'undefined') {
            var blacklistData = []; 
            var friendRequestsData = []; 
            var characterStatusData = [];
            var defaultCooldownMinutes = 30;
        }

        // Âä†ËΩΩÊãâÈªëÁ≥ªÁªüÊï∞ÊçÆ
        async function loadBlacklistData() {
            try {
                blacklistData = await db.blacklist.orderBy('timestamp').reverse().toArray();
                console.log('ÊãâÈªëÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', blacklistData);
            } catch (error) {
                console.error('Âä†ËΩΩÊãâÈªëÊï∞ÊçÆÂ§±Ë¥•:', error);
                blacklistData = [];
            }
        }

        // Ê£ÄÊü•ÊòØÂê¶Ë¢´ÊãâÈªë
        function isBlocked(blockerId, blockedId) {
            return blacklistData.some(record => 
                record.blockerId === blockerId && 
                record.blockedId === blockedId && 
                !record.unblocked
            );
        }

        // Ê£ÄÊü•ÊòØÂê¶Âú®ÂÜ∑ÈùôÊúü
        function isInCooldown(blockerId, blockedId) {
            const record = blacklistData.find(r => 
                r.blockerId === blockerId && 
                r.blockedId === blockedId && 
                r.unblocked
            );
            
            if (!record || !record.unblockTimestamp) return false;
            
            const cooldownEnd = new Date(new Date(record.unblockTimestamp).getTime() + (record.cooldownMinutes * 60 * 1000));
            return new Date() < cooldownEnd;
        }

        // ÊãâÈªëËßíËâ≤
        async function blockCharacter(characterId, reason = '', cooldownMinutes = null) {
            try {
                const now = new Date();
                const cooldown = cooldownMinutes || defaultCooldownMinutes;
                
                if (isBlocked('user', characterId)) {
                    showToast('ËØ•ËßíËâ≤Â∑≤Ë¢´ÊãâÈªë', 'warning');
                    return;
                }
                
                const blockRecord = {
                    id: `block_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    blockerId: 'user',
                    blockedId: characterId,
                    timestamp: now.toISOString(),
                    reason: reason,
                    cooldownMinutes: cooldown,
                    unblocked: false
                };
                
                blacklistData.unshift(blockRecord);
                await db.blacklist.add(blockRecord);
                
                const character = characters.find(c => c.id === characterId);
                showToast(`Â∑≤ÊãâÈªë ${character?.name || 'ËßíËâ≤'}`, 'success');
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÈÄöÁü•ËßíËâ≤Ë¢´ÊãâÈªë‰∫Ü
                await notifyCharacterBlocked(characterId, reason);
                
                // Á´ãÂç≥Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫
                if (currentChatCharacter && currentChatCharacter.id === characterId) {
                    updateChatBlockedStatus();
                }
                
                renderContactList();
                renderMessageList();
                
            } catch (error) {
                console.error('ÊãâÈªëËßíËâ≤Â§±Ë¥•:', error);
                showToast('ÊãâÈªëÂ§±Ë¥•', 'error');
            }
        }

        // Ëß£Èô§ÊãâÈªë
        async function unblockCharacter(characterId) {
            try {
                const blockRecord = blacklistData.find(r => 
                    r.blockerId === 'user' && 
                    r.blockedId === characterId && 
                    !r.unblocked
                );
                
                if (!blockRecord) {
                    showToast('ËØ•ËßíËâ≤Êú™Ë¢´ÊãâÈªë', 'warning');
                    return;
                }
                
                blockRecord.unblocked = true;
                blockRecord.unblockTimestamp = new Date().toISOString();
                
                await db.blacklist.put(blockRecord);
                
                const character = characters.find(c => c.id === characterId);
                showToast(`Â∑≤Ëß£Èô§ÂØπ ${character?.name || 'ËßíËâ≤'} ÁöÑÊãâÈªë`, 'success');
                
                // üî•„ÄêÊñ∞Â¢û„ÄëÈÄöÁü•ËßíËâ≤Ë¢´Ëß£Èô§ÊãâÈªë‰∫Ü
                await notifyCharacterUnblocked(characterId);
                
                // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫
                if (currentChatCharacter && currentChatCharacter.id === characterId) {
                    renderChatMessages(currentChatCharacter.id);
                    updateChatBlockedStatus();
                }
                
                renderContactList();
                renderMessageList();
                
            } catch (error) {
                console.error('Ëß£Èô§ÊãâÈªëÂ§±Ë¥•:', error);
                showToast('Ëß£Èô§ÊãâÈªëÂ§±Ë¥•', 'error');
            }
        }

        // Êõ¥Êñ∞ËßíËâ≤Áä∂ÊÄÅ
        async function updateCharacterStatus(characterId, status, activity = '', location = '') {
            try {
                let statusRecord = characterStatusData.find(s => s.characterId === characterId);
                
                if (!statusRecord) {
                    statusRecord = {
                        id: `status_${characterId}`,
                        characterId: characterId,
                        status: status,
                        activity: activity,
                        location: location,
                        lastUpdate: new Date().toISOString()
                    };
                    characterStatusData.push(statusRecord);
                } else {
                    statusRecord.status = status;
                    statusRecord.activity = activity;
                    statusRecord.location = location;
                    statusRecord.lastUpdate = new Date().toISOString();
                }
                
                await db.characterStatus.put(statusRecord);
                
            } catch (error) {
                console.error('Êõ¥Êñ∞ËßíËâ≤Áä∂ÊÄÅÂ§±Ë¥•:', error);
            }
        }

        // Ëé∑ÂèñËßíËâ≤Áä∂ÊÄÅ
        function getCharacterStatus(characterId) {
            return characterStatusData.find(s => s.characterId === characterId) || {
                status: 'online',
                activity: 'Âú®Á∫ø',
                location: '',
                lastUpdate: new Date().toISOString()
            };
        }

        // ËßíËâ≤ÊãâÈªëÁî®Êà∑
        async function aiBlockUser(characterId, reason = '') {
            try {
                const now = new Date();
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊãâÈªë
                if (isBlocked(characterId, 'user')) {
                    return;
                }
                
                const blockRecord = {
                    id: `block_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    blockerId: characterId,
                    blockedId: 'user',
                    timestamp: now.toISOString(),
                    reason: reason,
                    cooldownMinutes: 0, // ËßíËâ≤ÊãâÈªëÁî®Êà∑‰∏çÈúÄË¶ÅÂÜ∑ÈùôÊó∂Èó¥
                    unblocked: false
                };
                
                blacklistData.unshift(blockRecord);
                await db.blacklist.add(blockRecord);
                
                // Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫
                if (currentChatCharacter && currentChatCharacter.id === characterId) {
                    updateChatBlockedStatus();
                }
                
                const character = characters.find(c => c.id === characterId);
                showToast(`${character?.name || 'ËßíËâ≤'} Â∑≤Â∞Ü‰Ω†ÊãâÈªë`, 'warning');
                
            } catch (error) {
                console.error('ËßíËâ≤ÊãâÈªëÁî®Êà∑Â§±Ë¥•:', error);
            }
        }

        // ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑
        async function sendFriendRequest(characterId, message = '') {
            try {
                const request = {
                    id: `request_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    fromId: 'user',
                    toId: characterId,
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    type: 'friend',
                    message: message
                };
                
                friendRequestsData.unshift(request);
                await db.friendRequests.add(request);
                
                showToast('Â•ΩÂèãÁî≥ËØ∑Â∑≤ÂèëÈÄÅ', 'success');
                
            } catch (error) {
                console.error('ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑Â§±Ë¥•:', error);
                showToast('ÂèëÈÄÅÁî≥ËØ∑Â§±Ë¥•', 'error');
            }
        }

        // Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢ÁöÑÊãâÈªëÁä∂ÊÄÅÊòæÁ§∫
        function updateChatBlockedStatus() {
            if (!currentChatCharacter) return;
            
            const characterId = currentChatCharacter.id;
            const isUserBlocked = isBlocked('user', characterId);
            const isCharacterBlocked = isBlocked(characterId, 'user');
            
            // ÁßªÈô§Áé∞ÊúâÁöÑÊãâÈªëÊèêÁ§∫
            const existingBlockedUI = document.querySelector('.blocked-status-overlay');
            if (existingBlockedUI) {
                existingBlockedUI.remove();
            }
            
            if (isUserBlocked || isCharacterBlocked) {
                // ÂàõÂª∫ÊãâÈªëÁä∂ÊÄÅË¶ÜÁõñÂ±Ç
                const chatScreen = document.getElementById('api-chat-screen');
                const blockedOverlay = document.createElement('div');
                blockedOverlay.className = 'blocked-status-overlay';
                
                let statusText, buttonText, buttonAction, buttonClass;
                
                if (isUserBlocked) {
                    statusText = `‰Ω†Â∑≤Â∞Ü ${currentChatCharacter.name} ÊãâÈªë`;
                    buttonText = 'Ëß£Èô§ÊãâÈªë';
                    buttonAction = () => unblockCharacter(characterId);
                    buttonClass = 'blocked-status-button unblock-style';
                } else {
                    statusText = `‰Ω†Ë¢´ ${currentChatCharacter.name} ÊãâÈªë‰∫Ü`;
                    buttonText = 'ÈáçÊñ∞Áî≥ËØ∑Ê∑ªÂä†Â•ΩÂèã';
                    buttonAction = () => showFriendRequestModal();
                    buttonClass = 'blocked-status-button';
                }
                
                blockedOverlay.innerHTML = `
                    <div class="blocked-status-content">
                        <div class="blocked-status-text">${statusText}</div>
                        <button class="${buttonClass}" onclick="this.clickHandler()">${buttonText}</button>
                    </div>
                `;
                
                // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
                const button = blockedOverlay.querySelector('.blocked-status-button');
                button.clickHandler = buttonAction;
                
                chatScreen.appendChild(blockedOverlay);
            }
        }

        // ÊòæÁ§∫ÊãâÈªëËÆæÁΩÆ
        function showBlacklistSettings() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'warning');
                return;
            }
            
            const characterId = currentChatCharacter.id;
            const isUserBlocked = isBlocked('user', characterId);
            
            const statusDesc = document.getElementById('blacklist-status-desc');
            const actionLabel = document.getElementById('block-action-label');
            const actionDesc = document.getElementById('block-action-desc');
            
            if (isUserBlocked) {
                statusDesc.textContent = '‰Ω†Â∑≤ÊãâÈªëÊ≠§ËßíËâ≤';
                actionLabel.textContent = 'Ëß£Èô§ÊãâÈªë';
                actionDesc.textContent = 'ÊÅ¢Â§ç‰∏éËØ•ËßíËâ≤ÁöÑÊ≠£Â∏∏ËÅäÂ§©';
            } else {
                statusDesc.textContent = 'Ê≠£Â∏∏ËÅäÂ§©‰∏≠';
                actionLabel.textContent = 'ÊãâÈªëÊ≠§ËßíËâ≤';
                actionDesc.textContent = 'ÈòªÊ≠¢ËØ•ËßíËâ≤Âêë‰Ω†ÂèëÈÄÅÊ∂àÊÅØ';
            }
            
            document.getElementById('cooldown-minutes').value = defaultCooldownMinutes;
            document.getElementById('blacklist-settings-modal').style.display = 'flex';
        }

        // ÈöêËóèÊãâÈªëËÆæÁΩÆ
        function hideBlacklistSettings() {
            document.getElementById('blacklist-settings-modal').style.display = 'none';
        }

        // ÊòæÁ§∫Â•ΩÂèãÁî≥ËØ∑Ê®°ÊÄÅÊ°Ü
        function showFriendRequestModal() {
            if (!currentChatCharacter) return;
            
            // Ê£ÄÊü•ÊòØÂê¶Âú®ÂÜ∑ÈùôÊúü
            if (isInCooldown(currentChatCharacter.id, 'user')) {
                showToast('ËøòÂú®ÂÜ∑ÈùôÊúüÂÜÖÔºåËØ∑Á®çÂêéÂÜçËØï', 'warning');
                return;
            }
            
            document.getElementById('friend-request-message').value = '';
            document.getElementById('friend-request-modal').style.display = 'flex';
        }

        // ÈöêËóèÂ•ΩÂèãÁî≥ËØ∑Ê®°ÊÄÅÊ°Ü
        function hideFriendRequestModal() {
            document.getElementById('friend-request-modal').style.display = 'none';
        }

        // ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑Á°ÆËÆ§
        async function sendFriendRequestConfirm() {
    if (!currentChatCharacter) return;
    
    const message = document.getElementById('friend-request-message').value.trim();
    const characterId = currentChatCharacter.id;

    // 1. ÂÖàÂú®Êï∞ÊçÆÂ∫ì‰∏≠ËÆ∞ÂΩïËøô‰∏™Áî≥ËØ∑‰∫ã‰ª∂
    await sendFriendRequest(characterId, message);
    hideFriendRequestModal();
    
    // 2. üî•„ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÁ´ãÂàªË∞ÉÁî®APIÔºåËÆ©AIÂ§ÑÁêÜËøô‰∏™Â•ΩÂèãÁî≥ËØ∑
    showToast('Áî≥ËØ∑Â∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÂØπÊñπÂõûÂ∫î...', 'info');
    await processAIFriendRequestResponse(characterId, message); 
}

        // ÊâßË°åÊãâÈªëÊìç‰Ωú
        function performBlockAction() {
            if (!currentChatCharacter) return;
            
            const characterId = currentChatCharacter.id;
            const isUserBlocked = isBlocked('user', characterId);
            const cooldownMinutes = parseInt(document.getElementById('cooldown-minutes').value) || 30;
            
            if (isUserBlocked) {
                if (confirm(`Á°ÆÂÆöË¶ÅËß£Èô§ÂØπ ${currentChatCharacter.name} ÁöÑÊãâÈªëÂêóÔºü`)) {
                    unblockCharacter(characterId);
                    hideBlacklistSettings();
                }
            } else {
                if (confirm(`Á°ÆÂÆöË¶ÅÊãâÈªë ${currentChatCharacter.name} ÂêóÔºü\n\nÂÜ∑ÈùôÊó∂Èó¥Ôºö${cooldownMinutes}ÂàÜÈíü`)) {
                    blockCharacter(characterId, '', cooldownMinutes);
                    hideBlacklistSettings();
                }
            }
        }

        // Âú®Â∫îÁî®ÂàùÂßãÂåñÊó∂Âä†ËΩΩÊãâÈªëÁ≥ªÁªüÊï∞ÊçÆ
        document.addEventListener('DOMContentLoaded', async function() {
            setTimeout(async () => {
                try {
                    await Promise.all([
                        loadBlacklistData(),
                        loadFriendRequestsData(),
                        loadCharacterStatusData()
                    ]);
                    console.log('üö´ ÊãâÈªëÁ≥ªÁªüÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
                } catch (error) {
                    console.error('ÊãâÈªëÁ≥ªÁªüÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                }
            }, 1000);
        });

        // Âä†ËΩΩÂ•ΩÂèãÁî≥ËØ∑Êï∞ÊçÆ
        async function loadFriendRequestsData() {
            try {
                friendRequestsData = await db.friendRequests.orderBy('timestamp').reverse().toArray();
                console.log('Â•ΩÂèãÁî≥ËØ∑Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', friendRequestsData);
            } catch (error) {
                console.error('Âä†ËΩΩÂ•ΩÂèãÁî≥ËØ∑Êï∞ÊçÆÂ§±Ë¥•:', error);
                friendRequestsData = [];
            }
        }

        // Âä†ËΩΩËßíËâ≤Áä∂ÊÄÅÊï∞ÊçÆ
        async function loadCharacterStatusData() {
            try {
                characterStatusData = await db.characterStatus.toArray();
                console.log('ËßíËâ≤Áä∂ÊÄÅÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', characterStatusData);
            } catch (error) {
                console.error('Âä†ËΩΩËßíËâ≤Áä∂ÊÄÅÊï∞ÊçÆÂ§±Ë¥•:', error);
                characterStatusData = [];
            }
        }

        // üì±„ÄêËßíËâ≤Áä∂ÊÄÅÊòæÁ§∫„ÄëÁõ∏ÂÖ≥ÂäüËÉΩ
        // Ê∏≤ÊüìËßíËâ≤Áä∂ÊÄÅ
        function renderCharacterStatus(characterId, container) {
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.characterStatusEnabled) {
                // Â¶ÇÊûúÂÖ≥Èó≠‰∫ÜÁä∂ÊÄÅÊòæÁ§∫ÔºåÁßªÈô§Áé∞ÊúâÁöÑÁä∂ÊÄÅÂÖÉÁ¥†
                if (container) {
                    const existingStatus = container.querySelector('.character-status');
                    if (existingStatus) {
                        existingStatus.remove();
                    }
                }
                return; 
            }
            
            const status = getCharacterStatus(characterId);
            const isUserBlocked = isBlocked('user', characterId);
            const isCharacterBlocked = isBlocked(characterId, 'user');
            
            let statusClass = 'online';
            let statusText = status.activity || 'Âú®Á∫ø';
            
            if (isUserBlocked || isCharacterBlocked) {
                statusClass = 'blocked';
                statusText = 'Â∑≤ÊãâÈªë';
            } else if (status.status === 'busy') {
                statusClass = 'busy';
            }
            
            const statusHtml = `
                <div class="character-status">
                    <div class="status-indicator ${statusClass}"></div>
                    <span class="status-text">${statusText}</span>
                </div>
            `;
            
            // Â¶ÇÊûúÂÆπÂô®Â≠òÂú®ÔºåÊ∑ªÂä†Áä∂ÊÄÅÊòæÁ§∫
            if (container) {
                // ÂÖàÁßªÈô§Áé∞ÊúâÁöÑÁä∂ÊÄÅÊòæÁ§∫
                const existingStatus = container.querySelector('.character-status');
                if (existingStatus) {
                    existingStatus.remove();
                }
                
                // üî•„Äê‰øÆÂ§ç„ÄëÂà§Êñ≠ÂÆπÂô®Á±ªÂûãÔºå‰ΩøÁî®‰∏çÂêåÁöÑÊèíÂÖ•Á≠ñÁï•
                if (container.classList.contains('header')) {
                    // ËÅäÂ§©ÁïåÈù¢ÁöÑ.headerÂÆπÂô®ÔºöÁõ¥Êé•Ê∑ªÂä†Âà∞ÂÆπÂô®‰∏≠Ôºå‰ΩøÁî®CSSÁªùÂØπÂÆö‰Ωç
                    container.insertAdjacentHTML('beforeend', statusHtml);
                } else if (container.classList.contains('app-header')) {
                    // ÂÖ∂‰ªñÁïåÈù¢ÁöÑ.app-headerÂÆπÂô®ÔºöÊ∑ªÂä†Âà∞.app-titleÂÜÖÈÉ®
                    const titleElement = container.querySelector('.app-title');
                    if (titleElement) {
                        titleElement.insertAdjacentHTML('afterend', statusHtml);
                    } else {
                        container.insertAdjacentHTML('beforeend', statusHtml);
                    }
                } else {
                    // ÂÖ∂‰ªñÂÆπÂô®ÔºöÈªòËÆ§Ê∑ªÂä†Âà∞Êú´Â∞æ
                    container.insertAdjacentHTML('beforeend', statusHtml);
                }
            }
        }

        // AIÁîüÊàêËßíËâ≤Áä∂ÊÄÅ
        async function generateCharacterStatus(characterId) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;
                
                // Ëé∑ÂèñËÅäÂ§©ËÆæÁΩÆÂíåÊúÄËøëËÅäÂ§©ËÆ∞ÂΩï
                const chatSettings = await getAsyncChatSettings(characterId);
                const messages = chatMessages[characterId] || [];
                const recentMessages = messages.slice(-5); // ÊúÄËøë5Êù°Ê∂àÊÅØ
                
                // ÊûÑÂª∫‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = 'ÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºö\n' + 
                        recentMessages.map(msg => {
                            if (msg.sender === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            if (msg.sender === 'ai') return `${character.name}Ôºö${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n') + '\n\n';
                }
                
                // Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØ
                let worldBookContext = '';
                if (chatSettings?.linkedWorldBookIds && chatSettings.linkedWorldBookIds.length > 0) {
                    try {
                        const worldBooks = await Promise.all(
                            chatSettings.linkedWorldBookIds.map(id => db.worldbooks.get(id))
                        );
                        const validWorldBooks = worldBooks.filter(book => book && book.content);
                        if (validWorldBooks.length > 0) {
                            worldBookContext = 'ËÉåÊôØËÆæÂÆöÔºö\n' + 
                                validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n') + '\n\n';
                        }
                    } catch (error) {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    }
                }
                
                // ÈöèÊú∫ÈÄâÊã©Áä∂ÊÄÅÁ±ªÂûãÔºöÊ¥ªÂä®ÊàñÂøÉÊÉÖ
                const statusType = Math.random() < 0.5 ? 'activity' : 'mood';
                
                let prompt;
                if (statusType === 'activity') {
                    // ÁîüÊàêÊ¥ªÂä®Áä∂ÊÄÅ
                    prompt = `‰Ω†ÊòØ${character.name}Ôºå‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${character.bio}

${worldBookContext}${chatContext}ËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅÂΩìÂâçÂâßÊÉÖÂíåËÅäÂ§©ËÆ∞ÂΩïÔºåÁîüÊàê‰∏Ä‰∏™Á¨¶Âêà‰Ω†ÂΩìÂâçÁä∂ÂÜµÁöÑÊ¥ªÂä®Áä∂ÊÄÅ„ÄÇË¶ÅÊ±ÇÔºö
1. 10-20Â≠óÂÜÖÔºåÁÆÄÊ¥ÅÊòé‰∫Ü
2. Á¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºÂíåË∫´‰ªΩËÆæÂÆö
3. Âü∫‰∫éÊúÄËøëÁöÑËÅäÂ§©ÂÜÖÂÆπÊàñÂâßÊÉÖÂèëÂ±ï
4. Ê†ºÂºèÔºöÂú®[Âú∞ÁÇπ][ÂÅö‰ªÄ‰πà]
5. Ë¶ÅÁúüÂÆûÂèçÊò†ËßíËâ≤ÂΩì‰∏ãÂèØËÉΩÂú®ÂÅöÁöÑ‰∫ãÊÉÖ
6. Â¶ÇÊûúÊ≤°ÊúâÂÖ∑‰ΩìËÅäÂ§©ËÆ∞ÂΩïÔºåÂàôÊ†πÊçÆ‰∫∫ËÆæÊé®ÊµãÂêàÁêÜÁöÑÊó•Â∏∏Ê¥ªÂä®

Á§∫‰æãÊ†ºÂºèÔºöÂú®Âõæ‰π¶È¶ÜÊï¥ÁêÜËµÑÊñô„ÄÅÂú®ËÆ≠ÁªÉÂú∫ÁªÉ‰π†ÂâëÊúØ„ÄÅÂú®ÊàøÈó¥ÈáåÊ≤âÊÄù„ÄÅÂú®Ëä±Âõ≠‰∏≠Êï£Ê≠•Á≠â

ËØ∑ÁîüÊàê‰∏Ä‰∏™Ê¥ªÂä®Áä∂ÊÄÅÔºö`;
                } else {
                    // ÁîüÊàêÂøÉÊÉÖÁä∂ÊÄÅ
                    prompt = `‰Ω†ÊòØ${character.name}Ôºå‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${character.bio}

${worldBookContext}${chatContext}ËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅÂΩìÂâçÂâßÊÉÖÂíåËÅäÂ§©ËÆ∞ÂΩïÔºåÁîüÊàê‰∏Ä‰∏™Á¨¶Âêà‰Ω†ÂΩìÂâçÂøÉÊÉÖÁöÑÁä∂ÊÄÅ„ÄÇË¶ÅÊ±ÇÔºö
1. 10-20Â≠óÂÜÖÔºåÁÆÄÊ¥ÅÊòé‰∫Ü
2. Á¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºÁâπÁÇπ
3. Âü∫‰∫éÊúÄËøëÁöÑÂØπËØùÂÜÖÂÆπÊàñÊÉÖÊÑüÂèòÂåñ
4. Ë°®Ëææ‰Ω†ÂΩì‰∏ãÁöÑÁúüÂÆûÊÉÖÊÑüÁä∂ÊÄÅ
5. Ë¶ÅÊúâËßíËâ≤ÁöÑ‰∏™ÊÄßËâ≤ÂΩ©
6. Â¶ÇÊûúÊ≤°ÊúâÂÖ∑‰ΩìËÅäÂ§©ËÆ∞ÂΩïÔºåÂàôÊ†πÊçÆ‰∫∫ËÆæÊé®ÊµãÂü∫Êú¨ÂøÉÊÉÖ

Á§∫‰æãÊ†ºÂºèÔºöÂøÉÊÉÖÊÑâÊÇ¶„ÄÅÁï•ÊÑüÂõ∞ÊÉë„ÄÅÊ≠£Âú®‰∏ìÊ≥®ÊÄùËÄÉ„ÄÅÊÑüÂà∞Êúâ‰∫õÁñ≤ÊÉ´„ÄÅÂØπÊú™Êù•ÂÖÖÊª°ÊúüÂæÖÁ≠â

ËØ∑ÁîüÊàê‰∏Ä‰∏™ÂøÉÊÉÖÁä∂ÊÄÅÔºö`;
                }
                
                // ‰ΩøÁî®AIÁîüÊàêÁä∂ÊÄÅ
                const statusText = await generateAIResponse(prompt, character);
                
                if (statusText && statusText.trim()) {
                    const cleanStatus = statusText.trim().replace(/^["""''„Äå„Äç„Äé„Äè„Äê„Äë]|["""''„Äå„Äç„Äé„Äè„Äê„Äë]$/g, '');
                    await updateCharacterStatus(characterId, 'online', cleanStatus);
                    console.log(`‰∏∫${character.name}ÁîüÊàê${statusType === 'activity' ? 'Ê¥ªÂä®' : 'ÂøÉÊÉÖ'}Áä∂ÊÄÅ: ${cleanStatus}`);
                } else {
                    // Â¶ÇÊûúAIÁîüÊàêÂ§±Ë¥•Ôºå‰ΩøÁî®Âü∫‰∫é‰∫∫ËÆæÁöÑÈªòËÆ§Áä∂ÊÄÅ
                    const fallbackStatus = generateFallbackStatus(character, statusType);
                    await updateCharacterStatus(characterId, 'online', fallbackStatus);
                    console.log(`‰∏∫${character.name}‰ΩøÁî®ÈªòËÆ§${statusType === 'activity' ? 'Ê¥ªÂä®' : 'ÂøÉÊÉÖ'}Áä∂ÊÄÅ: ${fallbackStatus}`);
                }
                
            } catch (error) {
                console.error('ÁîüÊàêËßíËâ≤Áä∂ÊÄÅÂ§±Ë¥•:', error);
                // ÈîôËØØÊó∂‰ΩøÁî®ÁÆÄÂçïÁöÑÈªòËÆ§Áä∂ÊÄÅ
                const fallbackStatus = generateFallbackStatus(character, 'activity');
                await updateCharacterStatus(characterId, 'online', fallbackStatus);
            }
        }
        
        // ÁîüÊàêÂü∫‰∫é‰∫∫ËÆæÁöÑÂ§áÁî®Áä∂ÊÄÅ
        function generateFallbackStatus(character, statusType) {
            const bio = (character.bio || '').toLowerCase();
            
            if (statusType === 'activity') {
                // Âü∫‰∫é‰∫∫ËÆæÂÖ≥ÈîÆËØçÁöÑÊ¥ªÂä®Áä∂ÊÄÅ
                if (bio.includes('Â≠¶ËÄÖ') || bio.includes('Á†îÁ©∂') || bio.includes('‰π¶')) {
                    return 'Âú®‰π¶ÊàøÁ†îËØªÂÖ∏Á±ç';
                } else if (bio.includes('ÊàòÂ£´') || bio.includes('Ââë') || bio.includes('ÊàòÊñó')) {
                    return 'Âú®ËÆ≠ÁªÉÂú∫ÁªÉ‰π†';
                } else if (bio.includes('ÂåªÁîü') || bio.includes('Ê≤ªÁñó')) {
                    return 'Âú®ËØäÊâÄÊï¥ÁêÜËçØÂìÅ';
                } else if (bio.includes('ÂïÜ‰∫∫') || bio.includes('‰π∞Âçñ')) {
                    return 'Âú®Â∫óÈì∫ÂøôÁ¢å';
                } else if (bio.includes('Ëâ∫ÊúØ') || bio.includes('Áîª') || bio.includes('Èü≥‰πê')) {
                    return 'Âú®Â∑•‰ΩúÂÆ§Âàõ‰Ωú';
                } else if (bio.includes('Âé®') || bio.includes('ÊñôÁêÜ')) {
                    return 'Âú®Âé®ÊàøÂáÜÂ§áÈ£üÊùê';
                } else {
                    return 'Âú®ÊàøÈó¥Èáå‰ºëÊÅØ';
                }
            } else {
                // Âü∫‰∫é‰∫∫ËÆæÂÖ≥ÈîÆËØçÁöÑÂøÉÊÉÖÁä∂ÊÄÅ
                if (bio.includes('ÂºÄÊúó') || bio.includes('Ê¥ªÊ≥º') || bio.includes('‰πêËßÇ')) {
                    return 'ÂøÉÊÉÖÊÑâÊÇ¶';
                } else if (bio.includes('ÂÜ∑Èùô') || bio.includes('ÁêÜÊÄß') || bio.includes('Ê≤âÁùÄ')) {
                    return 'ÂÜÖÂøÉÂπ≥Èùô';
                } else if (bio.includes('‰∏•ËÇÉ') || bio.includes('ËÆ§Áúü')) {
                    return '‰∏ìÊ≥®ÊÄùËÄÉ‰∏≠';
                } else if (bio.includes('Ê∏©Êüî') || bio.includes('ÂñÑËâØ')) {
                    return 'ÂøÉÂ¢ÉÊ∏©Âíå';
                } else if (bio.includes('Á•ûÁßò') || bio.includes('Ê∑±Ê≤â')) {
                    return 'Ëã•ÊúâÊâÄÊÄù';
                } else {
                    return 'Áä∂ÊÄÅËâØÂ•Ω';
                }
            }
        }

        // üî•„Äê‰øÆÂ§ç„ÄëÁä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®ÁÆ°ÁêÜ
        let characterStatusTimer = null;
        
        // Ëé∑ÂèñÁä∂ÊÄÅÊõ¥Êñ∞Èó¥ÈöîÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ
        function getStatusUpdateInterval() {
            // üî•„Äê‰øÆÂ§ç„Äë‰ªélocalStorageËé∑ÂèñÂÖ®Â±ÄÁä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáËÆæÁΩÆ
            let frequency = 'medium'; // ÈªòËÆ§‰∏≠È¢ë

            try {
                // Â∞ùËØï‰ªélocalStorageËé∑ÂèñÂÖ®Â±ÄËÆæÁΩÆ
                const globalSettings = localStorage.getItem('globalStatusUpdateFrequency');
                if (globalSettings) {
                    frequency = globalSettings;
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÂÖ®Â±ÄËÆæÁΩÆÔºåÂ∞ùËØï‰ªéÂΩìÂâçËßíËâ≤ËÆæÁΩÆ‰∏≠Ëé∑Âèñ
                    if (currentChatCharacter) {
                        const chatSettings = getCurrentChatSettings();
                        frequency = chatSettings.statusUpdateFrequency || 'medium';
                        // ‰øùÂ≠ò‰∏∫ÂÖ®Â±ÄËÆæÁΩÆ
                        localStorage.setItem('globalStatusUpdateFrequency', frequency);
                    }
                }
            } catch (error) {
                console.warn('Ëé∑ÂèñÁä∂ÊÄÅÊõ¥Êñ∞È¢ëÁéáËÆæÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº:', error);
            }

            // üî•„Äê‰øÆÂ§ç„ÄëÂ∞ÜÈ¢ëÁéáËΩ¨Êç¢‰∏∫ÊØ´ÁßíÈó¥Èöî - ‰øÆÊ≠£È´òÈ¢ë‰∏∫30Áßí
            const intervals = {
                'high': 30000,      // 30ÁßíÔºàÁõÆÂâçÈ¢ëÁéáÔºâ
                'medium-high': 60000, // 1ÂàÜÈíü
                'medium': 180000,   // 3ÂàÜÈíü
                'medium-low': 300000, // 5ÂàÜÈíü
                'low': 600000       // 10ÂàÜÈíü
            };

            return intervals[frequency] || intervals['medium'];
        }
        
        // Ê∏ÖÈô§Áä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®
        function clearCharacterStatusTimer() {
            if (characterStatusTimer) {
                clearInterval(characterStatusTimer);
                characterStatusTimer = null;
                console.log('ËßíËâ≤Áä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®Â∑≤Ê∏ÖÈô§');
            }
        }
        
        // ÂêØÂä®Áä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®
        function startCharacterStatusTimer() {
            clearCharacterStatusTimer(); // ÂÖàÊ∏ÖÈô§Áé∞ÊúâÂÆöÊó∂Âô®
            
            const interval = getStatusUpdateInterval();
            console.log('ÂêØÂä®ËßíËâ≤Áä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®ÔºåÈó¥Èöî:', interval / 1000, 'Áßí');
            
            characterStatusTimer = setInterval(async () => {
                // üî•„Äê‰øÆÂ§ç„ÄëÈ¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶Êúâ‰ªª‰ΩïËßíËâ≤ÂêØÁî®‰∫ÜÁä∂ÊÄÅÊòæÁ§∫
                let hasStatusEnabled = false;
                
                for (const character of characters) {
                    if (contacts.includes(character.id)) {
                        // Ê£ÄÊü•ËØ•ËßíËâ≤ÁöÑËÅäÂ§©ËÆæÁΩÆ‰∏≠ÊòØÂê¶ÂêØÁî®‰∫ÜÁä∂ÊÄÅÊòæÁ§∫
                        const chatSettings = await getAsyncChatSettings(character.id);
                        if (chatSettings.characterStatusEnabled) {
                            hasStatusEnabled = true;
                            
                            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Áä∂ÊÄÅ
                            const shouldUpdate = await shouldUpdateCharacterStatus(character.id);
                            if (shouldUpdate) {
                                await generateCharacterStatus(character.id);
                            }
                        }
                    }
                }
                
                // Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïËßíËâ≤ÂêØÁî®Áä∂ÊÄÅÊòæÁ§∫ÔºåË∑≥ËøáÂêéÁª≠Êìç‰Ωú
                if (!hasStatusEnabled) {
                    return;
                }
                
                // Âà∑Êñ∞ÂΩìÂâçÊòæÁ§∫ÁöÑÁä∂ÊÄÅÔºà‰ªÖÂΩìÂΩìÂâçËßíËâ≤ÂêØÁî®‰∫ÜÁä∂ÊÄÅÊòæÁ§∫Êó∂Ôºâ
                if (currentChatCharacter) {
                    const currentChatSettings = getCurrentChatSettings();
                    if (currentChatSettings.characterStatusEnabled) {
                        const headerContainer = document.querySelector('#api-chat-screen .header');
                        if (headerContainer) {
                            renderCharacterStatus(currentChatCharacter.id, headerContainer);
                        }
                    }
                }
            }, interval);
        }
        
        // ÈáçÂêØÁä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®
        function restartCharacterStatusTimer() {
            console.log('ÈáçÂêØËßíËâ≤Áä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®');
            startCharacterStatusTimer();
        }
        
        // ÂêëÂêéÂÖºÂÆπÁöÑÂáΩÊï∞Âêç
        function startStatusUpdateTimer() {
            startCharacterStatusTimer();
        }

        // ================== ÂÖ®Â±ÄËÆ∞ÂøÜÁ≥ªÁªü ==================

        // ÂÖ®Â±ÄËÆ∞ÂøÜÊï∞ÊçÆÂ∫ìÁªìÊûÑ
        let globalMemoryDB = null;

        // ÂàùÂßãÂåñÂÖ®Â±ÄËÆ∞ÂøÜÊï∞ÊçÆÂ∫ì
        async function initGlobalMemoryDB() {
            try {
                // Êâ©Â±ïÁé∞ÊúâÊï∞ÊçÆÂ∫ìÔºåÊ∑ªÂä†ËÆ∞ÂøÜÁõ∏ÂÖ≥Ë°®
                if (!db.memorySummaries) {
                    // ÊÉÖÊôØËÆ∞ÂøÜË°® - Â≠òÂÇ®AIÁîüÊàêÁöÑÊó•ËÆ∞ÊëòË¶Å
                    db.memorySummaries = db.table('memorySummaries', '++id, characterId, date, summary, context, importance, timestamp');
                }

                if (!db.coreMemories) {
                    // Ê†∏ÂøÉËÆ∞ÂøÜË°® - Â≠òÂÇ®Ê∞∏‰πÖÈáçË¶Å‰ø°ÊÅØ
                    db.coreMemories = db.table('coreMemories', '++id, characterId, fact, category, importance, timestamp, lastAccessed');
                }

                if (!db.memoryEvents) {
                    // Áªü‰∏Ä‰∫ã‰ª∂Ë°® - ËÆ∞ÂΩïÊâÄÊúâË∑®Âú∫ÊôØ‰∫ã‰ª∂
                    db.memoryEvents = db.table('memoryEvents', '++id, timestamp, characterIds, context, eventType, eventData, importance');
                }

                console.log('‚úÖ ÂÖ®Â±ÄËÆ∞ÂøÜÊï∞ÊçÆÂ∫ìÂàùÂßãÂåñÂÆåÊàê');
            } catch (error) {
                console.error('‚ùå ÂÖ®Â±ÄËÆ∞ÂøÜÊï∞ÊçÆÂ∫ìÂàùÂßãÂåñÂ§±Ë¥•:', error);
            }
        }

        // ËÆ∞ÂΩïÁªü‰∏Ä‰∫ã‰ª∂
        async function recordMemoryEvent(characterIds, context, eventType, eventData, importance = 0.5) {
            try {
                const event = {
                    timestamp: Date.now(),
                    characterIds: Array.isArray(characterIds) ? characterIds : [characterIds],
                    context: context, // { type: 'private_chat', id: 'chat_id' }
                    eventType: eventType, // 'message', 'activity_start', 'group_create' Á≠â
                    eventData: eventData,
                    importance: importance
                };

                await db.memoryEvents.add(event);
                console.log('üìù ËÆ∞ÂΩï‰∫ã‰ª∂:', eventType, characterIds);
            } catch (error) {
                console.error('‚ùå ËÆ∞ÂΩï‰∫ã‰ª∂Â§±Ë¥•:', error);
            }
        }

        // Ê∑ªÂä†Ê†∏ÂøÉËÆ∞ÂøÜ
        async function addCoreMemory(characterId, fact, category = 'general', importance = 0.8) {
            try {
                const coreMemory = {
                    characterId: characterId,
                    fact: fact,
                    category: category, // 'personality', 'relationship', 'preference', 'general'
                    importance: importance,
                    timestamp: Date.now(),
                    lastAccessed: Date.now()
                };

                await db.coreMemories.add(coreMemory);
                console.log('üß† Ê∑ªÂä†Ê†∏ÂøÉËÆ∞ÂøÜ:', fact);
            } catch (error) {
                console.error('‚ùå Ê∑ªÂä†Ê†∏ÂøÉËÆ∞ÂøÜÂ§±Ë¥•:', error);
            }
        }

        // ÁîüÊàêÊÉÖÊôØËÆ∞ÂøÜÊëòË¶Å
        async function generateMemorySummary(characterId, startTime, endTime, context) {
            try {
                // Ëé∑ÂèñÊó∂Èó¥ÊÆµÂÜÖÁöÑ‰∫ã‰ª∂
                const events = await db.memoryEvents
                    .where('timestamp')
                    .between(startTime, endTime)
                    .and(event => event.characterIds.includes(characterId))
                    .toArray();

                if (events.length === 0) return null;

                // ÊûÑÂª∫AIÊëòË¶Åprompt
                const eventsText = events.map(event => {
                    const timeStr = new Date(event.timestamp).toLocaleTimeString();
                    return `[${timeStr}] ${event.eventType}: ${JSON.stringify(event.eventData)}`;
                }).join('\n');

                const character = characters.find(c => c.id === characterId);
                const summaryPrompt = `‰Ω†ÊòØ${character.name}ÔºåËØ∑‰∏∫‰ª•‰∏ãÊó∂Èó¥ÊÆµÁöÑÊ¥ªÂä®ÂÜô‰∏Ä‰ªΩÁÆÄÁü≠ÁöÑËÆ∞ÂøÜÊëòË¶ÅÔºà50-100Â≠óÔºâÔºö

Êó∂Èó¥ÊÆµÔºö${new Date(startTime).toLocaleString()} - ${new Date(endTime).toLocaleString()}
Ê¥ªÂä®ËÆ∞ÂΩïÔºö
${eventsText}

ËØ∑Áî®Á¨¨‰∏Ä‰∫∫Áß∞ÂÜô‰∏Ä‰ªΩÁÆÄÊ¥ÅÁöÑËÆ∞ÂøÜÊëòË¶ÅÔºåÈáçÁÇπËÆ∞ÂΩïÈáçË¶ÅÁöÑ‰∫ã‰ª∂ÂíåÊÑüÂèóÔºö`;

                // Ë∞ÉÁî®AIÁîüÊàêÊëòË¶Å
                const response = await callAI(summaryPrompt, character);

                if (response && response.trim()) {
                    const summary = {
                        characterId: characterId,
                        date: new Date(startTime).toISOString().split('T')[0],
                        summary: response.trim(),
                        context: context,
                        importance: calculateSummaryImportance(events),
                        timestamp: Date.now()
                    };

                    await db.memorySummaries.add(summary);
                    console.log('üìñ ÁîüÊàêËÆ∞ÂøÜÊëòË¶Å:', summary.summary);
                    return summary;
                }
            } catch (error) {
                console.error('‚ùå ÁîüÊàêËÆ∞ÂøÜÊëòË¶ÅÂ§±Ë¥•:', error);
            }
            return null;
        }

        // ËÆ°ÁÆóÊëòË¶ÅÈáçË¶ÅÊÄß
        function calculateSummaryImportance(events) {
            if (!events || events.length === 0) return 0.3;

            const avgImportance = events.reduce((sum, event) => sum + event.importance, 0) / events.length;
            const eventCount = events.length;

            // ‰∫ã‰ª∂Êï∞ÈáèÂíåÂπ≥ÂùáÈáçË¶ÅÊÄßÁöÑÁªºÂêàËØÑÂàÜ
            return Math.min(0.9, avgImportance + (eventCount * 0.05));
        }

        // Êô∫ËÉΩËÆ∞ÂøÜÊ£ÄÁ¥¢Á≥ªÁªü
        async function buildGlobalMemoryContext(characterId, currentContext, memoryDays = 7) {
            try {
                let memoryContext = '';

                // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•ÊòØÂê¶ÂêØÁî®ËÆ∞ÂøÜÂÖ±‰∫´ - ÈúÄË¶ÅËé∑ÂèñËßíËâ≤ÁöÑÂçïËÅäËÆæÁΩÆ
                let sharedGroupId = null;
                let contextIds = [currentContext.id]; // ÂΩìÂâçËÅäÂ§©Á™óÂè£

                // Â¶ÇÊûúÂΩìÂâçÂú®Áæ§ËÅä‰∏≠ÔºåÈúÄË¶ÅÊ£ÄÊü•ËØ•ËßíËâ≤Âú®ÂçïËÅä‰∏≠ÊòØÂê¶ËÆæÁΩÆ‰∫ÜËÆ∞ÂøÜÂÖ±‰∫´
                if (currentContext.type === 'group_chat') {
                    try {
                        // Ëé∑ÂèñËØ•ËßíËâ≤ÁöÑÂçïËÅäËÆæÁΩÆÔºàËßíËâ≤IDÂ∞±ÊòØÂçïËÅäIDÔºâ
                        const characterChatSettings = await getAsyncChatSettings(characterId);
                        sharedGroupId = characterChatSettings.memorySharedGroupId;

                        // Â¶ÇÊûúËßíËâ≤ËÆæÁΩÆ‰∫Ü‰∏éÂΩìÂâçÁæ§ËÅäÂÖ±‰∫´ËÆ∞ÂøÜÔºåÂàôÂåÖÂê´ÁßÅËÅäËÆ∞ÂøÜ
                        if (sharedGroupId === currentContext.id) {
                            contextIds.push(characterId); // ÁßÅËÅäÁöÑIDÂ∞±ÊòØËßíËâ≤ID
                            console.log('üîó Âú®ÂÖ±‰∫´Áæ§ËÅä‰∏≠ÔºåÂåÖÂê´ËßíËâ≤ÁßÅËÅäËÆ∞ÂøÜ:', characterId);
                        }
                    } catch (error) {
                        console.warn('Ëé∑ÂèñËßíËâ≤ÂçïËÅäËÆæÁΩÆÂ§±Ë¥•:', error);
                    }
                } else if (currentContext.type === 'private_chat') {
                    // Â¶ÇÊûúÂú®ÁßÅËÅä‰∏≠Ôºå‰ΩøÁî®ÂΩìÂâçËÅäÂ§©ËÆæÁΩÆ
                    const chatSettings = getCurrentChatSettings();
                    sharedGroupId = chatSettings.memorySharedGroupId;

                    // Â¶ÇÊûúÂêØÁî®‰∫ÜËÆ∞ÂøÜÂÖ±‰∫´ÔºåÊ∑ªÂä†ÂÖ±‰∫´ÁöÑÁæ§ËÅäID
                    if (sharedGroupId) {
                        contextIds.push(sharedGroupId);
                        console.log('üîó ÂêØÁî®ËÆ∞ÂøÜÂÖ±‰∫´ÔºåÂåÖÂê´Áæ§ËÅä:', sharedGroupId);
                    }
                }

                // 1. Ê£ÄÁ¥¢Ê†∏ÂøÉËÆ∞ÂøÜ
                const coreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                // ÊâãÂä®ÊéíÂ∫èÂπ∂ÈôêÂà∂Êï∞Èáè
                coreMemories.sort((a, b) => (b.importance || 0) - (a.importance || 0));
                const limitedCoreMemories = coreMemories.slice(0, 10);

                if (limitedCoreMemories.length > 0) {
                    memoryContext += '\n# Ê†∏ÂøÉËÆ∞ÂøÜ\n';
                    limitedCoreMemories.forEach(memory => {
                        memoryContext += `- ${memory.fact}\n`;
                    });
                }

                // 2. Ê£ÄÁ¥¢ÊÉÖÊôØËÆ∞ÂøÜÔºàÊúÄËøëNÂ§©Ôºâ
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - memoryDays);
                const cutoffTimestamp = cutoffDate.getTime();

                const episodicMemories = await db.episodicMemories
                    .where('characterId')
                    .equals(characterId)
                    .and(memory => memory.timestamp >= cutoffTimestamp)
                    .toArray();

                // ÊâãÂä®ÊéíÂ∫èÂπ∂ÈôêÂà∂Êï∞Èáè
                episodicMemories.sort((a, b) => b.timestamp - a.timestamp);
                const limitedEpisodicMemories = episodicMemories.slice(0, 15);

                if (limitedEpisodicMemories.length > 0) {
                    memoryContext += '\n# ÊÉÖÊôØËÆ∞ÂøÜ\n';
                    limitedEpisodicMemories.forEach(memory => {
                        const date = new Date(memory.timestamp).toLocaleDateString();
                        memoryContext += `[${date}] ${memory.fact}\n`;
                    });
                }

                // 3. Ê£ÄÁ¥¢Ë∑®Â∫îÁî®Êó∂Èó¥Á∫øËÆ∞ÂøÜÔºàÊîØÊåÅËÆ∞ÂøÜÂÖ±‰∫´Ôºâ
                const timelineCutoff = Date.now() - (memoryDays * 24 * 60 * 60 * 1000);
                let timelineMemories = [];

                for (const contextId of contextIds) {
                    const contextTimeline = await db.crossAppTimeline
                        .where('characterId')
                        .equals(characterId)
                        .and(event => {
                            if (event.timestamp < timelineCutoff) return false;
                            if (!event.context) return false;

                            // Ê£ÄÊü•‰∏ä‰∏ãÊñáIDÂåπÈÖç
                            return event.context.id === contextId ||
                                   (event.context.chatId === contextId) ||
                                   (event.context.groupId === contextId);
                        })
                        .toArray();
                    timelineMemories = timelineMemories.concat(contextTimeline);
                }

                // ÂéªÈáçÂπ∂ÊéíÂ∫è
                const uniqueTimelineMemories = timelineMemories.filter((memory, index, self) =>
                    index === self.findIndex(m => m.id === memory.id));
                uniqueTimelineMemories.sort((a, b) => b.timestamp - a.timestamp);
                const limitedTimelineMemories = uniqueTimelineMemories.slice(0, 20);

                if (limitedTimelineMemories.length > 0) {
                    memoryContext += '\n# ÊúÄËøëÊ¥ªÂä®Êó∂Èó¥Á∫ø\n';
                    limitedTimelineMemories.forEach(memory => {
                        const time = new Date(memory.timestamp).toLocaleString();
                        const contextInfo = memory.context?.type === 'group_chat' ? 'Áæ§ËÅä' : 'ÁßÅËÅä';

                        // ÊûÑÂª∫Êõ¥ÊúâÊÑè‰πâÁöÑ‰∫ã‰ª∂ÊèèËø∞
                        let eventDescription = '';
                        if (memory.action === 'user_message') {
                            if (memory.context?.content) {
                                eventDescription = `Áî®Êà∑ËØ¥: ${memory.context.content.substring(0, 50)}${memory.context.content.length > 50 ? '...' : ''}`;
                            } else {
                                eventDescription = `Áî®Êà∑ÂèëÈÄÅ‰∫ÜÊ∂àÊÅØ`;
                            }
                        } else if (memory.action === 'ai_message' && memory.context?.content) {
                            eventDescription = `AIÂõûÂ§ç: ${memory.context.content.substring(0, 50)}${memory.context.content.length > 50 ? '...' : ''}`;
                        } else if (memory.action === 'ai_reply' && memory.context?.content) {
                            eventDescription = `AIÂõûÂ§ç: ${memory.context.content.substring(0, 50)}${memory.context.content.length > 50 ? '...' : ''}`;
                        } else {
                            eventDescription = memory.action || memory.eventType || 'Êú™Áü•Ê¥ªÂä®';
                        }



                        memoryContext += `[${time}] Âú®${contextInfo}‰∏≠: ${eventDescription}\n`;
                    });
                }

                // 4. Ê£ÄÁ¥¢ËÆ∞ÂøÜÊëòË¶ÅÔºàÊúÄËøëNÂ§©ÁöÑÊëòË¶ÅÔºâ
                const cutoffDateStr = cutoffDate.toISOString().split('T')[0];

                const memorySummaries = await db.memorySummaries
                    .where('characterId')
                    .equals(characterId)
                    .and(summary => summary.date >= cutoffDateStr)
                    .toArray();

                // ÊâãÂä®ÊéíÂ∫èÂπ∂ÈôêÂà∂Êï∞Èáè
                memorySummaries.sort((a, b) => b.timestamp - a.timestamp);
                const limitedMemorySummaries = memorySummaries.slice(0, 10);

                if (limitedMemorySummaries.length > 0) {
                    memoryContext += '\n# ÂØπËØùÊëòË¶Å\n';
                    limitedMemorySummaries.forEach(summary => {
                        const date = new Date(summary.timestamp).toLocaleDateString();
                        memoryContext += `[${date}] ${summary.summary}\n`;
                    });
                }

                // 3. Ê£ÄÁ¥¢Ë∑®Âú∫ÊôØÁõ∏ÂÖ≥‰∫ã‰ª∂ÔºàÊîØÊåÅËÆ∞ÂøÜÂÖ±‰∫´Ôºâ
                const recentEvents = await db.memoryEvents
                    .where('timestamp')
                    .above(Date.now() - (24 * 60 * 60 * 1000)) // ÊúÄËøë24Â∞èÊó∂
                    .and(event => {
                        // Ê£ÄÊü•‰∫ã‰ª∂ÊòØÂê¶‰∏éÂΩìÂâçËßíËâ≤Áõ∏ÂÖ≥Ôºå‰∏îÂèëÁîüÂú®Áõ∏ÂÖ≥ÁöÑËÅäÂ§©Á™óÂè£‰∏≠
                        return event.characterIds.includes(characterId) &&
                               contextIds.includes(event.context.id);
                    })
                    .toArray();

                // ÊâãÂä®ÊéíÂ∫èÂπ∂ÈôêÂà∂Êï∞Èáè
                recentEvents.sort((a, b) => b.timestamp - a.timestamp);
                const limitedRecentEvents = recentEvents.slice(0, 15);

                if (limitedRecentEvents.length > 0) {
                    memoryContext += '\n# ÊúÄËøëÊ¥ªÂä®\n';
                    limitedRecentEvents.forEach(event => {
                        const time = new Date(event.timestamp).toLocaleTimeString();
                        const contextInfo = event.context.type === 'private_chat' ? 'ÁßÅËÅä' :
                                          event.context.type === 'group_chat' ? 'Áæ§ËÅä' :
                                          event.context.type === 'music_app' ? 'Èü≥‰πê' : 'ÂÖ∂‰ªñ';

                        // Â¶ÇÊûúÊòØË∑®Âú∫ÊôØÁöÑ‰∫ã‰ª∂ÔºåÊ†áÊòéÊù•Ê∫ê
                        const sourceInfo = event.context.id !== currentContext.id ? ` (Êù•Ëá™${contextInfo})` : '';
                        memoryContext += `[${time}] Âú®${contextInfo}‰∏≠${sourceInfo}: ${event.eventType}\n`;
                    });
                }

                return memoryContext;
            } catch (error) {
                console.error('‚ùå ÊûÑÂª∫ÂÖ®Â±ÄËÆ∞ÂøÜ‰∏ä‰∏ãÊñáÂ§±Ë¥•:', error);
                return '';
            }
        }

        // ËÆ∞ÂøÜËÆæÁΩÆÁÆ°ÁêÜ
        function showGlobalMemorySettings() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'error');
                return;
            }

            // ÂàõÂª∫ËÆ∞ÂøÜËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
            const modalHTML = `
                <div id="global-memory-modal" class="modal phone-modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">ÂÖ®Â±ÄËÆ∞ÂøÜËÆæÁΩÆ</h3>
                            <button class="modal-close" onclick="hideGlobalMemorySettings()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-section">
                                <h4>ËÆ∞ÂøÜ‰øùÁïôÊúüÈôê</h4>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="memoryDays" value="3">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">3Â§©ËÆ∞ÂøÜ</div>
                                            <div class="radio-desc">‰øùÁïôÊúÄËøë3Â§©ÁöÑÊÉÖÊôØËÆ∞ÂøÜ</div>
                                        </div>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="memoryDays" value="7" checked>
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">7Â§©ËÆ∞ÂøÜ</div>
                                            <div class="radio-desc">‰øùÁïôÊúÄËøë7Â§©ÁöÑÊÉÖÊôØËÆ∞ÂøÜÔºàÊé®ËçêÔºâ</div>
                                        </div>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="memoryDays" value="15">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">15Â§©ËÆ∞ÂøÜ</div>
                                            <div class="radio-desc">‰øùÁïôÊúÄËøë15Â§©ÁöÑÊÉÖÊôØËÆ∞ÂøÜ</div>
                                        </div>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="memoryDays" value="30">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">30Â§©ËÆ∞ÂøÜ</div>
                                            <div class="radio-desc">‰øùÁïôÊúÄËøë30Â§©ÁöÑÊÉÖÊôØËÆ∞ÂøÜ</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4>ËÆ∞ÂøÜÁÆ°ÁêÜ</h4>
                                <button class="modal-button modal-secondary" onclick="viewCoreMemories()">
                                    Êü•ÁúãÊ†∏ÂøÉËÆ∞ÂøÜ
                                </button>
                                <button class="modal-button modal-secondary" onclick="viewMemorySummaries()">
                                    Êü•ÁúãËÆ∞ÂøÜÊëòË¶Å
                                </button>
                                <button class="modal-button modal-secondary" onclick="generateDailySummary()">
                                    ÁîüÊàê‰ªäÊó•ÊëòË¶Å
                                </button>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="modal-button modal-secondary" onclick="hideGlobalMemorySettings()">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveGlobalMemorySettings()">‰øùÂ≠òËÆæÁΩÆ</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            const currentSettings = getGlobalMemorySettings();
            const radio = document.querySelector(`input[name="memoryDays"][value="${currentSettings.memoryDays}"]`);
            if (radio) radio.checked = true;
        }

        // Ëé∑ÂèñÂÖ®Â±ÄËÆ∞ÂøÜËÆæÁΩÆ
        function getGlobalMemorySettings() {
            const saved = localStorage.getItem('globalMemorySettings');
            return saved ? JSON.parse(saved) : {
                memoryDays: 7,
                autoSummary: true,
                coreMemoryEnabled: true
            };
        }

        // ‰øùÂ≠òÂÖ®Â±ÄËÆ∞ÂøÜËÆæÁΩÆ
        function saveGlobalMemorySettings() {
            const memoryDays = parseInt(document.querySelector('input[name="memoryDays"]:checked').value);

            const settings = {
                memoryDays: memoryDays,
                autoSummary: true,
                coreMemoryEnabled: true
            };

            localStorage.setItem('globalMemorySettings', JSON.stringify(settings));
            hideGlobalMemorySettings();
            showToast('ÂÖ®Â±ÄËÆ∞ÂøÜËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }

        // ÈöêËóèÂÖ®Â±ÄËÆ∞ÂøÜËÆæÁΩÆ
        function hideGlobalMemorySettings() {
            const modal = document.getElementById('global-memory-modal');
            if (modal) modal.remove();
        }

        // Êü•ÁúãÊ†∏ÂøÉËÆ∞ÂøÜ
        async function viewCoreMemories() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'error');
                return;
            }

            try {
                const coreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(currentChatCharacter.id)
                    .toArray();

                // ÊâãÂä®ÊéíÂ∫è
                coreMemories.sort((a, b) => (b.importance || 0) - (a.importance || 0));

                let content = '';
                if (coreMemories.length === 0) {
                    content = 'ÊöÇÊó†Ê†∏ÂøÉËÆ∞ÂøÜ';
                } else {
                    content = coreMemories.map((memory, index) => {
                        const date = new Date(memory.timestamp).toLocaleDateString();
                        return `${index + 1}. ${memory.fact} (${date})`;
                    }).join('\n');
                }

                alert(`${currentChatCharacter.name} ÁöÑÊ†∏ÂøÉËÆ∞ÂøÜÔºö\n\n${content}`);
            } catch (error) {
                console.error('Êü•ÁúãÊ†∏ÂøÉËÆ∞ÂøÜÂ§±Ë¥•:', error);
                showToast('Êü•ÁúãÊ†∏ÂøÉËÆ∞ÂøÜÂ§±Ë¥•', 'error');
            }
        }

        // Êü•ÁúãËÆ∞ÂøÜÊëòË¶Å
        async function viewMemorySummaries() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'error');
                return;
            }

            try {
                const memorySummaries = await db.memorySummaries
                    .where('characterId')
                    .equals(currentChatCharacter.id)
                    .toArray();

                // ÊâãÂä®ÊéíÂ∫èÂπ∂ÈôêÂà∂Êï∞Èáè
                memorySummaries.sort((a, b) => b.timestamp - a.timestamp);
                const limitedSummaries = memorySummaries.slice(0, 10);

                let content = '';
                if (limitedSummaries.length === 0) {
                    content = 'ÊöÇÊó†ËÆ∞ÂøÜÊëòË¶Å';
                } else {
                    content = limitedSummaries.map((summary, index) => {
                        return `${index + 1}. [${summary.date}] ${summary.summary}`;
                    }).join('\n\n');
                }

                alert(`${currentChatCharacter.name} ÁöÑËÆ∞ÂøÜÊëòË¶ÅÔºö\n\n${content}`);
            } catch (error) {
                console.error('Êü•ÁúãËÆ∞ÂøÜÊëòË¶ÅÂ§±Ë¥•:', error);
                showToast('Êü•ÁúãËÆ∞ÂøÜÊëòË¶ÅÂ§±Ë¥•', 'error');
            }
        }

        // ÁîüÊàê‰ªäÊó•ÊëòË¶Å
        async function generateDailySummary() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'error');
                return;
            }

            try {
                const today = new Date();
                const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
                const endTime = startTime + 24 * 60 * 60 * 1000;

                const summary = await generateMemorySummary(
                    currentChatCharacter.id,
                    startTime,
                    endTime,
                    {
                        type: currentChatCharacter.isGroup ? 'group_chat' : 'private_chat',
                        id: currentChatCharacter.id
                    }
                );

                if (summary) {
                    showToast('‰ªäÊó•ÊëòË¶ÅÁîüÊàêÊàêÂäü', 'success');
                    alert(`‰ªäÊó•ÊëòË¶ÅÂ∑≤ÁîüÊàêÔºö\n\n${summary.summary}`);
                } else {
                    showToast('‰ªäÂ§©ÊöÇÊó†Ê¥ªÂä®ÂèØÁîüÊàêÊëòË¶Å', 'warning');
                }
            } catch (error) {
                console.error('ÁîüÊàê‰ªäÊó•ÊëòË¶ÅÂ§±Ë¥•:', error);
                showToast('ÁîüÊàê‰ªäÊó•ÊëòË¶ÅÂ§±Ë¥•', 'error');
            }
        }

        // ËÆ∞ÂøÜÂÖ±‰∫´ËÆæÁΩÆ
        function showMemoryShareSettings() {
            if (!currentChatCharacter || currentChatCharacter.isGroup) {
                showToast('Ê≠§ÂäüËÉΩ‰ªÖÈÄÇÁî®‰∫éÂçïËÅä', 'error');
                return;
            }

            // Ëé∑ÂèñÂΩìÂâçËßíËâ≤ÂèÇ‰∏éÁöÑÊâÄÊúâÁæ§ËÅä
            const characterGroups = groupChats.filter(group =>
                group.members && group.members.some(member => member.id === currentChatCharacter.id)
            );

            if (characterGroups.length === 0) {
                showToast('ËØ•ËßíËâ≤ËøòÊ≤°ÊúâÂèÇ‰∏é‰ªª‰ΩïÁæ§ËÅä', 'warning');
                return;
            }

            const chatSettings = getCurrentChatSettings();
            const currentSharedGroup = chatSettings.memorySharedGroupId || '';

            const modalHTML = `
                <div id="memory-share-modal" class="modal phone-modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">ËÆ∞ÂøÜÂÖ±‰∫´ËÆæÁΩÆ</h3>
                            <button class="modal-close" onclick="hideMemoryShareSettings()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-section">
                                <h4>ÈÄâÊã©Ë¶ÅÂÖ±‰∫´ËÆ∞ÂøÜÁöÑÁæ§ËÅä</h4>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="sharedGroup" value="" ${!currentSharedGroup ? 'checked' : ''}>
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <div class="radio-title">ÂÖ≥Èó≠ÂÖ±‰∫´</div>
                                            <div class="radio-desc">ÂçïËÅäÂíåÁæ§ËÅäËÆ∞ÂøÜÁã¨Á´ã</div>
                                        </div>
                                    </label>
                                    ${characterGroups.map(group => `
                                        <label class="radio-option">
                                            <input type="radio" name="sharedGroup" value="${group.id}" ${currentSharedGroup === group.id ? 'checked' : ''}>
                                            <span class="radio-custom"></span>
                                            <div class="radio-content">
                                                <div class="radio-title">${group.name}</div>
                                                <div class="radio-desc">‰∏éÊ≠§Áæ§ËÅäÂÖ±‰∫´ËÆ∞ÂøÜ</div>
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4>ÂäüËÉΩËØ¥Êòé</h4>
                                <div class="info-text">
                                    ‚Ä¢ ÂºÄÂêØÂêéÔºåËßíËâ≤Âú®ÂçïËÅä‰∏≠ËÉΩËÆ∞‰ΩèÁæ§ËÅäÁöÑÂÜÖÂÆπ<br>
                                    ‚Ä¢ ËßíËâ≤Âú®Áæ§ËÅä‰∏≠‰πüËÉΩËÆ∞‰ΩèÂçïËÅäÁöÑÂÜÖÂÆπ<br>
                                    ‚Ä¢ ÂÆûÁé∞ÁúüÊ≠£ÁöÑË∑®Âú∫ÊôØËÆ∞ÂøÜËøûË¥ØÊÄß<br>
                                    ‚Ä¢ ÊØè‰∏™ËßíËâ≤Âè™ËÉΩÈÄâÊã©‰∏Ä‰∏™Áæ§ËÅäËøõË°åËÆ∞ÂøÜÂÖ±‰∫´
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="modal-button modal-secondary" onclick="hideMemoryShareSettings()">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveMemoryShareSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ‰øùÂ≠òËÆ∞ÂøÜÂÖ±‰∫´ËÆæÁΩÆ
        async function saveMemoryShareSettings() {
            const selectedGroup = document.querySelector('input[name="sharedGroup"]:checked').value;

            const chatSettings = getCurrentChatSettings();
            chatSettings.memorySharedGroupId = selectedGroup;

            await saveChatSettings();

            // Êõ¥Êñ∞ÊòæÁ§∫Áä∂ÊÄÅ
            updateMemoryShareStatus();

            hideMemoryShareSettings();

            if (selectedGroup) {
                const group = groupChats.find(g => g.id === selectedGroup);
                showToast(`Â∑≤ÂºÄÂêØ‰∏é"${group.name}"ÁöÑËÆ∞ÂøÜÂÖ±‰∫´`, 'success');
            } else {
                showToast('Â∑≤ÂÖ≥Èó≠ËÆ∞ÂøÜÂÖ±‰∫´', 'success');
            }
        }

        // ÈöêËóèËÆ∞ÂøÜÂÖ±‰∫´ËÆæÁΩÆ
        function hideMemoryShareSettings() {
            const modal = document.getElementById('memory-share-modal');
            if (modal) modal.remove();
        }

        // Êõ¥Êñ∞ËÆ∞ÂøÜÂÖ±‰∫´Áä∂ÊÄÅÊòæÁ§∫
        function updateMemoryShareStatus() {
            const statusElement = document.getElementById('memory-share-status');
            if (!statusElement) return;

            const chatSettings = getCurrentChatSettings();
            const sharedGroupId = chatSettings.memorySharedGroupId;

            if (sharedGroupId) {
                const group = groupChats.find(g => g.id === sharedGroupId);
                statusElement.textContent = group ? `‰∏é"${group.name}"ÂÖ±‰∫´` : 'Â∑≤ÂºÄÂêØ';
            } else {
                statusElement.textContent = 'Â∑≤ÂÖ≥Èó≠';
            }
        }

        // ================== Êó•ËÆ∞ÂäüËÉΩÁ≥ªÁªü ==================

        // ÊòæÁ§∫Êó•ËÆ∞ËèúÂçï
        function showDiaryMenu() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'error');
                return;
            }
            showModal('diary-menu-modal');
        }

        // ÈöêËóèÊó•ËÆ∞ËèúÂçï
        function hideDiaryMenu() {
            hideModal('diary-menu-modal');
        }

        // ÊòæÁ§∫‰ªäÊó•Êó•ËÆ∞
        async function showTodayDiary() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'error');
                return;
            }

            hideDiaryMenu();

            const today = new Date().toISOString().split('T')[0];
            const diaryKey = `diary_${currentChatCharacter.id}_${today}`;
            let todayDiary = localStorage.getItem(diaryKey);

            // üî•„ÄêÊï∞ÊçÆËøÅÁßª„ÄëÂ¶ÇÊûúÊñ∞Ê†ºÂºèÊ≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªéÊóßÊ†ºÂºèËøÅÁßª
            if (!todayDiary) {
                const oldToday = new Date().toDateString();
                const oldDiaryKey = `diary_${currentChatCharacter.id}_${oldToday}`;
                const oldDiary = localStorage.getItem(oldDiaryKey);

                if (oldDiary) {
                    // ËøÅÁßªÂà∞Êñ∞Ê†ºÂºè
                    localStorage.setItem(diaryKey, oldDiary);
                    todayDiary = oldDiary;

                    // ÂêåÊó∂ËøÅÁßªËøáÂæÄÊó•ËÆ∞ÂàóË°®
                    migratePastDiariesFormat(currentChatCharacter.id, oldToday, today, oldDiary);

                    console.log('‚úÖ Â∑≤ËøÅÁßªÊó•ËÆ∞Êï∞ÊçÆÂà∞Êñ∞Ê†ºÂºè');
                }
            }

            const contentDiv = document.getElementById('today-diary-content');
            const generateBtn = document.getElementById('generate-diary-btn');

            // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            const editBtn = document.getElementById('edit-diary-btn');
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            generateBtn.title = 'ÁîüÊàêÊó•ËÆ∞';

            if (todayDiary) {
                // ÊòæÁ§∫Â∑≤ÊúâÁöÑÊó•ËÆ∞ÔºåÂåÖÂê´Â§¥ÈÉ®‰ø°ÊÅØ
                const diaryWithHeader = createDiaryWithHeader(todayDiary);
                contentDiv.innerHTML = diaryWithHeader;
                contentDiv.classList.remove('empty');
                generateBtn.style.display = 'block';
                generateBtn.title = 'ÈáçÊñ∞ÁîüÊàêÊó•ËÆ∞';
                editBtn.style.display = 'block';
            } else {
                contentDiv.innerHTML = '‰ªäÂ§©ËøòÊ≤°ÊúâÂÜôÊó•ËÆ∞Âë¢...';
                contentDiv.classList.add('empty');
                generateBtn.style.display = 'block';
                generateBtn.title = 'ÁîüÊàêÊó•ËÆ∞';
                editBtn.style.display = 'none';
            }

            showModal('today-diary-modal');
        }

        // ÈöêËóè‰ªäÊó•Êó•ËÆ∞
        function hideTodayDiary() {
            hideModal('today-diary-modal');
        }

        // ÁîüÊàê‰ªäÊó•Êó•ËÆ∞
        async function generateTodayDiary() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'error');
                return;
            }

            const generateBtn = document.getElementById('generate-diary-btn');
            const contentDiv = document.getElementById('today-diary-content');

            // Ëé∑Âèñ‰ªäÊó•Êó•ËÆ∞ÁöÑÂ≠òÂÇ®ÈîÆ
            const today = new Date().toISOString().split('T')[0];
            const diaryKey = `diary_${currentChatCharacter.id}_${today}`;
            let existingDiary = localStorage.getItem(diaryKey);

            // üî•„ÄêÊï∞ÊçÆËøÅÁßª„ÄëÂ¶ÇÊûúÊñ∞Ê†ºÂºèÊ≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªéÊóßÊ†ºÂºèËøÅÁßª
            if (!existingDiary) {
                const oldToday = new Date().toDateString();
                const oldDiaryKey = `diary_${currentChatCharacter.id}_${oldToday}`;
                const oldDiary = localStorage.getItem(oldDiaryKey);

                if (oldDiary) {
                    // ËøÅÁßªÂà∞Êñ∞Ê†ºÂºè
                    localStorage.setItem(diaryKey, oldDiary);
                    existingDiary = oldDiary;

                    // ÂêåÊó∂ËøÅÁßªËøáÂæÄÊó•ËÆ∞ÂàóË°®
                    migratePastDiariesFormat(currentChatCharacter.id, oldToday, today, oldDiary);

                    console.log('‚úÖ Â∑≤ËøÅÁßªÊó•ËÆ∞Êï∞ÊçÆÂà∞Êñ∞Ê†ºÂºè');
                }
            }

            // Â¶ÇÊûúÂ∑≤ÊúâÊó•ËÆ∞ÔºåÊèêÁ§∫Áî®Êà∑Â∞ÜÈáçÊñ∞ÁîüÊàê
            if (existingDiary) {
                const confirmRegenerate = confirm('‰ªäÂ§©Â∑≤ÁªèÊúâÊó•ËÆ∞‰∫ÜÔºåÊòØÂê¶Ë¶ÅÈáçÊñ∞ÁîüÊàêÔºüËøôÂ∞ÜË¶ÜÁõñÂéüÊúâÁöÑÊó•ËÆ∞„ÄÇ');
                if (!confirmRegenerate) {
                    return;
                }
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            generateBtn.title = 'TAÂú®ÂÜôÂë¢...';
            contentDiv.innerHTML = 'Ê≠£Âú®ÂÜôÊó•ËÆ∞...';
            contentDiv.classList.remove('empty');

            try {
                const character = currentChatCharacter;
                const characterId = character.id;

                // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñËØ•ËßíËâ≤ÁöÑËÅäÂ§©ËÆæÁΩÆ
                const chatSettings = await getAsyncChatSettings(characterId);

                // Ëé∑ÂèñËÅäÂ§©ÂéÜÂè≤Ôºà‰ΩøÁî®ÂéÜÂè≤Ê∂àÊÅØËΩÆÊï∞ËÆæÁΩÆÔºâ
                const messages = chatMessages[characterId] || [];
                const historyCount = chatSettings.historyCount || 5;
                const recentMessages = messages.slice(-historyCount);

                // Ëé∑ÂèñË∑®Á™óÂè£ËÆ∞ÂøÜÊï∞ÈáèÁöÑÊúÄËøëÂä®ÊÄÅÂÜÖÂÆπ
                const crossWindowMemory = chatSettings.crossWindowMemory || 3;
                const recentMoments = await getRecentMoments(crossWindowMemory);

                // ÊûÑÂª∫ËÅäÂ§©ÂéÜÂè≤‰∏ä‰∏ãÊñá
                let chatContext = '';
                if (recentMessages.length > 0) {
                    chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºö\n' +
                        recentMessages.map(msg => {
                            if (msg.sender === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                            if (msg.sender === 'ai') return `${character.name}Ôºö${msg.content}`;
                            return '';
                        }).filter(Boolean).join('\n');
                }

                // ÊûÑÂª∫Âä®ÊÄÅ‰∏ä‰∏ãÊñáÔºàÂåÖÊã¨ËØÑËÆ∫Ôºâ
                let momentsContext = '';
                if (recentMoments.length > 0) {
                    momentsContext = '\n\nÊúÄËøëÁöÑÂä®ÊÄÅÂÜÖÂÆπÔºö\n' +
                        recentMoments.map(moment => {
                            let momentText = `${moment.nickname}: ${moment.text}`;
                            if (moment.comments && moment.comments.length > 0) {
                                const commentTexts = moment.comments.map(comment =>
                                    `  ${comment.nickname}: ${comment.text}`
                                ).join('\n');
                                momentText += '\nËØÑËÆ∫Ôºö\n' + commentTexts;
                            }
                            return momentText;
                        }).join('\n\n');
                }

                // Ëé∑Âèñ‰∏ñÁïå‰π¶‰ø°ÊÅØ
                let worldbookContext = '';
                if (character.worldbook && character.worldbook.length > 0) {
                    worldbookContext = '\n\n‰∏ñÁïå‰π¶‰ø°ÊÅØÔºö\n' +
                        character.worldbook.map(entry => `${entry.key}: ${entry.value}`).join('\n');
                }

                // ÊûÑÂª∫Êó•ËÆ∞ÁîüÊàêprompt
                const currentDate = new Date().toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });

                const prompt = `‰Ω†ÊòØ${character.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${character.bio}${worldbookContext}

Áé∞Âú®ÊòØ${currentDate}Ôºå‰Ω†ÈúÄË¶ÅÂÜô‰∏ÄÁØáÁßÅ‰∫∫Êó•ËÆ∞„ÄÇ

ÈáçË¶ÅË¶ÅÊ±ÇÔºö
- ËØ∑Áõ¥Êé•ËæìÂá∫Êó•ËÆ∞ÂÜÖÂÆπÔºå‰∏çË¶Å‰ΩøÁî®JSONÊ†ºÂºèÊàñ‰ªª‰Ωï‰ª£Á†ÅÂùó
- ‰∏çË¶ÅÂåÖÂê´Êó•ÊúüÊ†áÈ¢òÔºàÊó•Êúü‰ºöËá™Âä®ÊòæÁ§∫Âú®Êó•ËÆ∞Á∫∏‰∏äÔºâ
- Áî®‰Ω†ÁöÑÂè£ÂêªÂíåÊÄßÊ†ºÊù•ÂÜô
- ËÆ∞ÂΩï‰Ω†‰ªäÂ§©ÁöÑÊÉ≥Ê≥ï„ÄÅÊÑüÂèóÂíåÁªèÂéÜ
- ÂèØ‰ª•ÊèêÂèäÂØπÁî®Êà∑ÁöÑÁúüÂÆûÊÑüÊÉÖ
- Âü∫‰∫éÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÂíåÂä®ÊÄÅÂÜÖÂÆπ
- ‰øùÊåÅËßíËâ≤ÁöÑ‰∏ÄËá¥ÊÄßÂíåÁúüÂÆûÊÄß
- ÂÜÖÂÆπË¶ÅËá™ÁÑ∂„ÄÅÁúüÂÆûÔºåÂÉèÁúüÊ≠£ÁöÑÁßÅ‰∫∫Êó•ËÆ∞
- Â≠óÊï∞Âú®50-500Â≠ó‰πãÈó¥ÔºåÊ†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÂíåÂΩìÂ§©ÁöÑÂøÉÊÉÖËá™Áî±ÂèëÊå•${chatContext}${momentsContext}

ËØ∑Áõ¥Êé•ÂÜôÂá∫${character.name}ÁöÑÁßÅ‰∫∫Êó•ËÆ∞ÂÜÖÂÆπÔºàÁ∫ØÊñáÊú¨Ôºå‰∏çË¶Å‰ªª‰ΩïÊ†ºÂºèÊ†áËÆ∞ÔºâÔºö`;

                const diaryContent = await generateAIResponse(prompt, character);

                if (diaryContent && diaryContent.trim()) {
                    let finalDiary = diaryContent.trim();

                    // Ê∏ÖÁêÜÂèØËÉΩÁöÑJSONÊ†ºÂºèÂåÖË£Ö
                    finalDiary = cleanDiaryContent(finalDiary);

                    // ‰øùÂ≠ò‰ªäÊó•Êó•ËÆ∞
                    localStorage.setItem(diaryKey, finalDiary);

                    // Êõ¥Êñ∞ËøáÂæÄÊó•ËÆ∞ÂàóË°®
                    const pastDiariesKey = `past_diaries_${characterId}`;
                    let pastDiaries = JSON.parse(localStorage.getItem(pastDiariesKey) || '[]');

                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®‰ªäÂ§©ÁöÑÊó•ËÆ∞ËÆ∞ÂΩïÔºåÂ¶ÇÊûúÂ≠òÂú®ÂàôÊõ¥Êñ∞ÔºåÂê¶ÂàôÊ∑ªÂä†Êñ∞ËÆ∞ÂΩï
                    const existingIndex = pastDiaries.findIndex(diary => diary.date === today);
                    const diaryEntry = {
                        date: today,
                        content: finalDiary,
                        timestamp: Date.now()
                    };

                    if (existingIndex !== -1) {
                        // Êõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩï
                        pastDiaries[existingIndex] = diaryEntry;
                    } else {
                        // Ê∑ªÂä†Êñ∞ËÆ∞ÂΩïÂà∞ÂºÄÂ§¥
                        pastDiaries.unshift(diaryEntry);
                    }
                    localStorage.setItem(pastDiariesKey, JSON.stringify(pastDiaries));

                    // ÊòæÁ§∫Êó•ËÆ∞ÂÜÖÂÆπÔºåÂåÖÂê´Â§¥ÈÉ®‰ø°ÊÅØ
                    const diaryWithHeader = createDiaryWithHeader(finalDiary);
                    contentDiv.innerHTML = diaryWithHeader;
                    contentDiv.classList.remove('empty');
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                    generateBtn.title = 'ÈáçÊñ∞ÁîüÊàêÊó•ËÆ∞';

                    // ÊòæÁ§∫ÁºñËæëÊåâÈíÆ
                    const editBtn = document.getElementById('edit-diary-btn');
                    editBtn.style.display = 'block';

                    showToast(existingDiary ? 'Êó•ËÆ∞ÈáçÊñ∞ÁîüÊàêÂÆåÊàê' : 'Êó•ËÆ∞ÁîüÊàêÂÆåÊàê', 'success');
                } else {
                    throw new Error('ÁîüÊàêÊó•ËÆ∞Â§±Ë¥•');
                }
            } catch (error) {
                console.error('ÁîüÊàêÊó•ËÆ∞Â§±Ë¥•:', error);
                contentDiv.innerHTML = 'ÁîüÊàêÊó•ËÆ∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
                contentDiv.classList.add('empty');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                generateBtn.title = existingDiary ? 'ÈáçÊñ∞ÁîüÊàêÊó•ËÆ∞' : 'ÁîüÊàêÊó•ËÆ∞';
                showToast('ÁîüÊàêÊó•ËÆ∞Â§±Ë¥•', 'error');
            }
        }

        // ÊòæÁ§∫ËøáÂæÄÊó•ËÆ∞
        async function showPastDiaries() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤', 'error');
                return;
            }

            hideDiaryMenu();

            const characterId = currentChatCharacter.id;
            const pastDiariesKey = `past_diaries_${characterId}`;
            const pastDiaries = JSON.parse(localStorage.getItem(pastDiariesKey) || '[]');

            const listDiv = document.getElementById('past-diaries-list');

            if (pastDiaries.length === 0) {
                listDiv.innerHTML = `
                    <div class="no-diaries">
                        <i class="fas fa-book-open"></i>
                        <div>ËøòÊ≤°Êúâ‰ªª‰ΩïÊó•ËÆ∞ËÆ∞ÂΩï</div>
                    </div>
                `;
            } else {
                listDiv.innerHTML = pastDiaries.map((diary, index) => {
                    const date = new Date(diary.date).toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });

                    const preview = diary.content.length > 100 ?
                        diary.content.substring(0, 100) + '...' :
                        diary.content;

                    return `
                        <div class="diary-entry" onclick="toggleDiaryEntry(${index})">
                            <div class="diary-entry-date">${date}</div>
                            <div class="diary-entry-preview">${preview}</div>
                            <div class="diary-entry-full diary-paper">${createDiaryWithHeader(diary.content)}</div>
                        </div>
                    `;
                }).join('');
            }

            showModal('past-diaries-modal');
        }

        // ÈöêËóèËøáÂæÄÊó•ËÆ∞
        function hidePastDiaries() {
            hideModal('past-diaries-modal');
        }

        // ÂàáÊç¢Êó•ËÆ∞Êù°ÁõÆÁöÑÂ±ïÂºÄ/Êî∂Ëµ∑Áä∂ÊÄÅ
        function toggleDiaryEntry(index) {
            const entries = document.querySelectorAll('.diary-entry');
            const entry = entries[index];

            if (entry) {
                entry.classList.toggle('expanded');
            }
        }

        // ÂàõÂª∫Â∏¶Â§¥ÈÉ®‰ø°ÊÅØÁöÑÊó•ËÆ∞ÂÜÖÂÆπ
        function createDiaryWithHeader(diaryContent) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const weekdayStr = now.toLocaleDateString('zh-CN', { weekday: 'long' });

            // ÁÆÄÂçïÁöÑÂ§©Ê∞îÊ®°ÊãüÔºàÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÊîπËøõÔºâ
            const weathers = ['Êô¥', 'Â§ö‰∫ë', 'Èò¥', 'Â∞èÈõ®', 'Êô¥Êúó', 'ÂæÆÈ£é'];
            const weather = weathers[Math.floor(Math.random() * weathers.length)];

            return `<div class="diary-header">
                <span class="diary-date">${dateStr} ${weekdayStr}</span>
                <span class="diary-weather">Â§©Ê∞îÔºö${weather}</span>
            </div>${diaryContent}`;
        }

        // Ê∏ÖÁêÜÊó•ËÆ∞ÂÜÖÂÆπÔºåÁßªÈô§ÂèØËÉΩÁöÑJSONÊ†ºÂºèÂåÖË£Ö
        function cleanDiaryContent(content) {
            // ÁßªÈô§ÂèØËÉΩÁöÑJSONÂåÖË£Ö
            if (content.startsWith('```json') && content.endsWith('```')) {
                content = content.slice(7, -3).trim();
            }
            if (content.startsWith('```') && content.endsWith('```')) {
                content = content.slice(3, -3).trim();
            }

            // Â∞ùËØïËß£ÊûêJSONÊ†ºÂºèÁöÑÂÜÖÂÆπ
            try {
                const parsed = JSON.parse(content);
                if (typeof parsed === 'string') {
                    return parsed;
                } else if (parsed.content) {
                    return parsed.content;
                } else if (parsed.diary) {
                    return parsed.diary;
                } else if (parsed.text) {
                    return parsed.text;
                }
            } catch (e) {
                // ‰∏çÊòØJSONÊ†ºÂºèÔºåÁõ¥Êé•ËøîÂõûÂéüÂÜÖÂÆπ
            }

            // ÁßªÈô§ÂèØËÉΩÁöÑÂºïÂè∑ÂåÖË£Ö
            if ((content.startsWith('"') && content.endsWith('"')) ||
                (content.startsWith("'") && content.endsWith("'"))) {
                content = content.slice(1, -1);
            }

            return content;
        }

        // üî•„ÄêÊï∞ÊçÆËøÅÁßª„ÄëËøÅÁßªËøáÂæÄÊó•ËÆ∞Ê†ºÂºè - ‰∏ÄÊ¨°ÊÄßÊâßË°å
        function migratePastDiariesFormat(characterId, oldDateStr, newDateStr, diaryContent) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèËøÅÁßªËøá
            const migrationKey = `diary_migration_${characterId}`;
            if (localStorage.getItem(migrationKey)) {
                return; // Â∑≤ÁªèËøÅÁßªËøáÔºåË∑≥Ëøá
            }

            const pastDiariesKey = `past_diaries_${characterId}`;
            let pastDiaries = JSON.parse(localStorage.getItem(pastDiariesKey) || '[]');

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâ‰ªäÂ§©ÁöÑËÆ∞ÂΩïÔºàÊñ∞Ê†ºÂºèÔºâ
            const existingNewIndex = pastDiaries.findIndex(diary => diary.date === newDateStr);

            if (existingNewIndex === -1) {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊóßÊ†ºÂºèÁöÑËÆ∞ÂΩï
                const existingOldIndex = pastDiaries.findIndex(diary => diary.date === oldDateStr);

                if (existingOldIndex !== -1) {
                    // Êõ¥Êñ∞ÊóßËÆ∞ÂΩïÁöÑÊó•ÊúüÊ†ºÂºè
                    pastDiaries[existingOldIndex].date = newDateStr;
                    pastDiaries[existingOldIndex].content = diaryContent;
                    pastDiaries[existingOldIndex].timestamp = Date.now();
                } else {
                    // Ê∑ªÂä†Êñ∞ËÆ∞ÂΩï
                    pastDiaries.unshift({
                        date: newDateStr,
                        content: diaryContent,
                        timestamp: Date.now()
                    });
                }

                localStorage.setItem(pastDiariesKey, JSON.stringify(pastDiaries));
            }

            // Ê†áËÆ∞Â∑≤ÂÆåÊàêËøÅÁßª
            localStorage.setItem(migrationKey, 'completed');
        }

        // ÁºñËæë‰ªäÊó•Êó•ËÆ∞
        function editTodayDiary() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ËßíËâ≤', 'error');
                return;
            }
            const characterId = currentChatCharacter.id;

            const today = new Date().toISOString().split('T')[0];
            const diaryKey = `diary_${characterId}_${today}`;
            let todayDiary = localStorage.getItem(diaryKey);

            // üî•„ÄêÊï∞ÊçÆËøÅÁßª„ÄëÂ¶ÇÊûúÊñ∞Ê†ºÂºèÊ≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªéÊóßÊ†ºÂºèËøÅÁßª
            if (!todayDiary) {
                const oldToday = new Date().toDateString();
                const oldDiaryKey = `diary_${characterId}_${oldToday}`;
                const oldDiary = localStorage.getItem(oldDiaryKey);

                if (oldDiary) {
                    // ËøÅÁßªÂà∞Êñ∞Ê†ºÂºè
                    localStorage.setItem(diaryKey, oldDiary);
                    todayDiary = oldDiary;

                    // ÂêåÊó∂ËøÅÁßªËøáÂæÄÊó•ËÆ∞ÂàóË°®
                    migratePastDiariesFormat(characterId, oldToday, today, oldDiary);

                    console.log('‚úÖ Â∑≤ËøÅÁßªÊó•ËÆ∞Êï∞ÊçÆÂà∞Êñ∞Ê†ºÂºè');
                }
            }

            if (!todayDiary) {
                showToast('‰ªäÂ§©ËøòÊ≤°ÊúâÊó•ËÆ∞ÂèØ‰ª•ÁºñËæë', 'error');
                return;
            }

            // ÂàõÂª∫ÁºñËæëÊ®°ÊÄÅÊ°Ü
            const editModal = document.createElement('div');
            editModal.className = 'modal';
            editModal.style.display = 'block';
            editModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">ÁºñËæëÊó•ËÆ∞</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <textarea id="edit-diary-textarea" class="diary-edit-textarea" placeholder="ÁºñËæëÊó•ËÆ∞ÂÜÖÂÆπ...">${todayDiary}</textarea>
                        <div class="modal-actions">
                            <button class="modal-button modal-secondary" onclick="this.closest('.modal').remove()">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveDiaryEdit()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(editModal);

            // ËÅöÁÑ¶Âà∞ÊñáÊú¨Ê°Ü
            const textarea = editModal.querySelector('#edit-diary-textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        // ‰øùÂ≠òÊó•ËÆ∞ÁºñËæë
        function saveDiaryEdit() {
            if (!currentChatCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ËßíËâ≤', 'error');
                return;
            }
            const characterId = currentChatCharacter.id;
            const today = new Date().toISOString().split('T')[0];
            const diaryKey = `diary_${characterId}_${today}`;

            const textarea = document.getElementById('edit-diary-textarea');
            const newContent = textarea.value.trim();

            if (!newContent) {
                showToast('Êó•ËÆ∞ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'error');
                return;
            }

            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem(diaryKey, newContent);

            // Êõ¥Êñ∞ËøáÂæÄÊó•ËÆ∞ÂàóË°®
            const pastDiariesKey = `past_diaries_${characterId}`;
            let pastDiaries = JSON.parse(localStorage.getItem(pastDiariesKey) || '[]');

            const existingIndex = pastDiaries.findIndex(diary => diary.date === today);
            const diaryEntry = {
                date: today,
                content: newContent,
                timestamp: Date.now()
            };

            if (existingIndex !== -1) {
                pastDiaries[existingIndex] = diaryEntry;
            } else {
                pastDiaries.unshift(diaryEntry);
            }
            localStorage.setItem(pastDiariesKey, JSON.stringify(pastDiaries));

            // Êõ¥Êñ∞ÊòæÁ§∫
            const contentDiv = document.getElementById('today-diary-content');
            const diaryWithHeader = createDiaryWithHeader(newContent);
            contentDiv.innerHTML = diaryWithHeader;
            contentDiv.classList.remove('empty');

            // ÂÖ≥Èó≠ÁºñËæëÊ®°ÊÄÅÊ°Ü
            document.querySelector('.modal:last-child').remove();

            showToast('Êó•ËÆ∞‰øùÂ≠òÊàêÂäü', 'success');
        }
        
        // Âà§Êñ≠ÊòØÂê¶Â∫îËØ•Êõ¥Êñ∞ËßíËâ≤Áä∂ÊÄÅ
        async function shouldUpdateCharacterStatus(characterId) {
            try {
                const currentStatus = getCharacterStatus(characterId);
                const lastUpdate = new Date(currentStatus.lastUpdate);
                const now = new Date();
                const timeDiff = now - lastUpdate;
                
                // Â¶ÇÊûúÁä∂ÊÄÅË∂ÖËøá15ÂàÜÈíüÊ≤°Êõ¥Êñ∞ÔºåÊúâËæÉÈ´òÊ¶ÇÁéáÊõ¥Êñ∞
                if (timeDiff > 15 * 60 * 1000) {
                    return Math.random() < 0.3; // 30%Ê¶ÇÁéá
                }
                
                // Â¶ÇÊûúÊúÄËøëÊúâËÅäÂ§©Ê¥ªÂä®ÔºåÊèêÈ´òÊõ¥Êñ∞Ê¶ÇÁéá
                const messages = chatMessages[characterId] || [];
                if (messages.length > 0) {
                    const lastMessage = messages[messages.length - 1];
                    const lastMessageTime = new Date(lastMessage.timestamp);
                    const messageTimeDiff = now - lastMessageTime;
                    
                    // Â¶ÇÊûúÊúÄËøë5ÂàÜÈíüÂÜÖÊúâËÅäÂ§©ÔºåÊúâÊõ¥È´òÊ¶ÇÁéáÊõ¥Êñ∞Áä∂ÊÄÅ
                    if (messageTimeDiff < 5 * 60 * 1000) {
                        return Math.random() < 0.4; // 40%Ê¶ÇÁéá
                    }
                    
                    // Â¶ÇÊûúÊúÄËøë30ÂàÜÈíüÂÜÖÊúâËÅäÂ§©ÔºåÊúâ‰∏ÄÂÆöÊ¶ÇÁéáÊõ¥Êñ∞Áä∂ÊÄÅ
                    if (messageTimeDiff < 30 * 60 * 1000) {
                        return Math.random() < 0.2; // 20%Ê¶ÇÁéá
                    }
                }
                
                // ÈªòËÆ§Ê¶ÇÁéá
                return Math.random() < 0.1; // 10%Ê¶ÇÁéá
                
            } catch (error) {
                console.error('Âà§Êñ≠ËßíËâ≤Áä∂ÊÄÅÊõ¥Êñ∞Â§±Ë¥•:', error);
                return Math.random() < 0.05; // 5%Ê¶ÇÁéá
            }
        }
        
        // Âú®ÂèëÈÄÅ/Êé•Êî∂Ê∂àÊÅØÂêéËß¶ÂèëÁä∂ÊÄÅÊõ¥Êñ∞
        async function triggerStatusUpdateAfterMessage(characterId) {
            // üî•„Äê‰øÆÂ§ç„ÄëÈ¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶ÂºÄÂêØ‰∫ÜËßíËâ≤Áä∂ÊÄÅÊòæÁ§∫
            const chatSettings = await getAsyncChatSettings(characterId);
            if (!chatSettings.characterStatusEnabled) {
                console.log(`ËßíËâ≤ ${characterId} Êú™ÂêØÁî®Áä∂ÊÄÅÊòæÁ§∫ÔºåË∑≥ËøáÁä∂ÊÄÅÊõ¥Êñ∞`);
                return;
            }
            
            // Âª∂ËøüÊõ¥Êñ∞ÔºåÊ®°ÊãüËßíËâ≤ÂìçÂ∫îËÅäÂ§©ÂÜÖÂÆπÂêéÁöÑÁä∂ÊÄÅÂèòÂåñ
            setTimeout(async () => {
                // ÂÜçÊ¨°Ê£ÄÊü•Áä∂ÊÄÅÊòæÁ§∫ËÆæÁΩÆÔºàÈò≤Ê≠¢Âú®Âª∂ËøüÊúüÈó¥Ë¢´ÂÖ≥Èó≠Ôºâ
                const currentSettings = await getAsyncChatSettings(characterId);
                if (!currentSettings.characterStatusEnabled) {
                    console.log(`ËßíËâ≤ ${characterId} Áä∂ÊÄÅÊòæÁ§∫Â∑≤ÂÖ≥Èó≠ÔºåÂèñÊ∂àÁä∂ÊÄÅÊõ¥Êñ∞`);
                    return;
                }
                
                if (Math.random() < 0.6) { // 60%Ê¶ÇÁéáÂú®ËÅäÂ§©ÂêéÊõ¥Êñ∞Áä∂ÊÄÅ
                    await generateCharacterStatus(characterId);
                    
                    // Â¶ÇÊûúÊòØÂΩìÂâçËÅäÂ§©ËßíËâ≤ÔºåÂà∑Êñ∞ÊòæÁ§∫
                    if (currentChatCharacter && currentChatCharacter.id === characterId) {
                        const headerContainer = document.querySelector('#api-chat-screen .header');
                        if (headerContainer) {
                            renderCharacterStatus(characterId, headerContainer);
                        }
                    }
                }
            }, Math.random() * 10000 + 5000); // 5-15ÁßíÂêéÈöèÊú∫Êõ¥Êñ∞
        }

        // Âú®Â∫îÁî®ÂàùÂßãÂåñÊó∂ÂêØÂä®Áä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                startStatusUpdateTimer();
            }, 5000); // Âª∂Ëøü5ÁßíÂêØÂä®
        });

        console.log('üö´ ÊãâÈªëÁ≥ªÁªüÊ†∏ÂøÉÂäüËÉΩÂ∑≤Âä†ËΩΩ');

        // üîß„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂøÜËÆæÁΩÆÁïåÈù¢‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('DOMContentLoaded', function() {
            // Ê∑ªÂä†ÈòàÂÄºÊªëÂùó‰∫ã‰ª∂ÁõëÂê¨Âô®
            const coreThresholdSlider = document.getElementById('coreMemoryThreshold');
            const episodicThresholdSlider = document.getElementById('episodicMemoryThreshold');

            if (coreThresholdSlider) {
                coreThresholdSlider.addEventListener('input', updateThresholdDisplay);
            }
            if (episodicThresholdSlider) {
                episodicThresholdSlider.addEventListener('input', updateThresholdDisplay);
            }
        });

        // üî•„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂøÜÁÆ°ÁêÜÁ≥ªÁªü

        // ÊñáÊú¨Áõ∏‰ººÂ∫¶ËÆ°ÁÆóÂáΩÊï∞ÔºàÁÆÄÂçïÁöÑJaccardÁõ∏‰ººÂ∫¶Ôºâ
        function calculateTextSimilarity(text1, text2) {
            if (!text1 || !text2) return 0;

            // ËΩ¨Êç¢‰∏∫Â∞èÂÜôÂπ∂ÂàÜËØç
            const words1 = new Set(text1.toLowerCase().match(/[\u4e00-\u9fa5\w]+/g) || []);
            const words2 = new Set(text2.toLowerCase().match(/[\u4e00-\u9fa5\w]+/g) || []);

            // ËÆ°ÁÆó‰∫§ÈõÜÂíåÂπ∂ÈõÜ
            const intersection = new Set([...words1].filter(x => words2.has(x)));
            const union = new Set([...words1, ...words2]);

            // JaccardÁõ∏‰ººÂ∫¶
            return union.size === 0 ? 0 : intersection.size / union.size;
        }

        // ËÆ∞ÂøÜÁ≥ªÁªüÈÖçÁΩÆÔºàÂèØÁî±Áî®Êà∑ËÆæÁΩÆÔºâ
        let MEMORY_CONFIG = {
            // AIËÆ∞ÂøÜÊèêÂèñÈÖçÁΩÆ
            AI_EXTRACT_INTERVAL: 60, // ÈªòËÆ§ÊØè30ËΩÆÂØπËØùÔºà60Êù°Ê∂àÊÅØÔºâËøõË°åAIÊèêÂèñ

            // Ê†∏ÂøÉËÆ∞ÂøÜÈÖçÁΩÆ
            CORE_MEMORY_IMPORTANCE_THRESHOLD: 0.9, // Ê†∏ÂøÉËÆ∞ÂøÜÈáçË¶ÅÊÄßÈòàÂÄº90%

            // ÊÉÖÊôØËÆ∞ÂøÜÈÖçÁΩÆ
            EPISODIC_MEMORY_IMPORTANCE_THRESHOLD: 0.6, // ÊÉÖÊôØËÆ∞ÂøÜÈáçË¶ÅÊÄßÈòàÂÄº60%

            // Ë∑®Â∫îÁî®ËÆ∞ÂøÜÈÖçÁΩÆ
            CROSS_APP_TIMELINE_LIMIT: 20, // Ë∑®Â∫îÁî®Êó∂Èó¥Á∫øÂú®Â∑•‰ΩúËÆ∞ÂøÜ‰∏≠ÁöÑÊúÄÂ§ßÊù°Êï∞
        };

        // ‰ªéÁî®Êà∑ËÆæÁΩÆ‰∏≠Âä†ËΩΩËÆ∞ÂøÜÈÖçÁΩÆ
        async function loadMemoryConfig() {
            try {
                const settings = await db.globalSettings.get('memoryConfig');
                if (settings && settings.value) {
                    MEMORY_CONFIG = { ...MEMORY_CONFIG, ...settings.value };
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÆ∞ÂøÜÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }

        // ‰øùÂ≠òËÆ∞ÂøÜÈÖçÁΩÆÂà∞Áî®Êà∑ËÆæÁΩÆ
        async function saveMemoryConfig() {
            try {
                await db.globalSettings.put({
                    id: 'memoryConfig',
                    value: MEMORY_CONFIG
                });
            } catch (error) {
                console.error('‰øùÂ≠òËÆ∞ÂøÜÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }

        // Ëá™Âä®ÊëòË¶ÅÁîüÊàêÂäüËÉΩ
        async function generateConversationSummary(characterId, messages) {
            if (!messages || messages.length === 0) return null;

            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return null;

                // ÊûÑÂª∫ÊëòË¶ÅÁîüÊàêÁöÑprompt
                const summaryPrompt = `
# ÂØπËØùÊëòË¶Å‰ªªÂä°

‰Ω†ÈúÄË¶Å‰∏∫‰ª•‰∏ãÂØπËØùÁîüÊàê‰∏Ä‰∏™ÁÆÄÊ¥ÅÁöÑÊëòË¶Å„ÄÇ

## ËßíËâ≤‰ø°ÊÅØ
- ËßíËâ≤ÂêçÁß∞: ${character.name}
- ËßíËâ≤ËÆæÂÆö: ${character.bio || 'Êó†ÁâπÊÆäËÆæÂÆö'}

## ÂØπËØùÂÜÖÂÆπ
${messages.map(msg => {
    const sender = msg.sender === 'sent' ? 'Áî®Êà∑' : character.name;
    const content = typeof msg.content === 'string' ? msg.content : '[ÂõæÁâá/Êñá‰ª∂]';
    return `${sender}: ${content}`;
}).join('\n')}

## ÊëòË¶ÅË¶ÅÊ±Ç
ËØ∑ÁîüÊàê‰∏Ä‰∏™100-200Â≠óÁöÑÂØπËØùÊëòË¶ÅÔºåÂåÖÂê´Ôºö
1. ‰∏ªË¶ÅËØùÈ¢òÂíåËÆ®ËÆ∫ÂÜÖÂÆπ
2. ÈáçË¶ÅÁöÑÊÉÖÊÑüÂèòÂåñÊàñÂÖ≥ÈîÆ‰∫ã‰ª∂
3. ÂèåÊñπÁöÑÊÄÅÂ∫¶ÂíåÂÖ≥Á≥ªÂèòÂåñ
4. ‰ªª‰ΩïÈáçË¶ÅÁöÑÂÜ≥ÂÆöÊàñÁ∫¶ÂÆö

ËØ∑Áî®Á¨¨‰∏â‰∫∫Áß∞ÂÆ¢ËßÇÊèèËø∞Ôºå‰øùÊåÅÁÆÄÊ¥ÅÊòé‰∫Ü„ÄÇ`;

                // Ë∞ÉÁî®AIÊèêÂèñËÆ∞ÂøÜ
                const response = await callChatAPI(extractPrompt, character);
                const responseText = Array.isArray(response) ? response[0] : response;

                if (responseText && typeof responseText === 'string') {
                    try {
                        // ÊèêÂèñJSONÈÉ®ÂàÜ
                        const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const memories = JSON.parse(jsonMatch[0]);

                            // Ëé∑ÂèñÁé∞ÊúâËÆ∞ÂøÜÔºåÊ£ÄÊü•ÈáçÂ§ç
                            const existingMemories = await db.coreMemories
                                .where('characterId')
                                .equals(characterId)
                                .toArray();

                            // ‰øùÂ≠òÊ†∏ÂøÉËÆ∞ÂøÜÔºàÁ°Æ‰øùËßíËâ≤ÈöîÁ¶ªÔºâ
                            for (const memory of memories.core_memories || []) {
                                if (memory.importance >= MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD) {
                                    // Âè™Ê£ÄÊü•ËØ•ËßíËâ≤ÁöÑÁé∞ÊúâËÆ∞ÂøÜÔºåÈÅøÂÖçË∑®ËßíËâ≤Ê∑∑Ê∑Ü
                                    const isDuplicate = existingMemories.some(existing => {
                                        const similarity = calculateTextSimilarity(existing.fact, memory.fact);
                                        return similarity > 0.8;
                                    });

                                    if (!isDuplicate) {
                                        const coreMemory = {
                                            id: `core_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                            characterId: characterId, // ‰∏•Ê†ºÁªëÂÆöËßíËâ≤ID
                                            fact: memory.fact,
                                            importance: memory.importance,
                                            category: memory.category || 'other',
                                            timestamp: Date.now(),
                                            type: 'core',
                                            source: 'single_chat' // Ê†áËÆ∞Êù•Ê∫êÔºåÂå∫ÂàÜÂçïËÅäÂíåÁæ§ËÅä
                                        };

                                        await db.coreMemories.add(coreMemory);
                                        console.log(`‚úÖ [${character.name}] Ê†∏ÂøÉËÆ∞ÂøÜ: ${memory.fact}`);
                                    }
                                }
                            }

                            // ‰øùÂ≠òÊÉÖÊôØËÆ∞ÂøÜÔºàÁ°Æ‰øùËßíËâ≤ÈöîÁ¶ªÔºâ
                            for (const memory of memories.episodic_memories || []) {
                                if (memory.importance >= MEMORY_CONFIG.EPISODIC_MEMORY_IMPORTANCE_THRESHOLD) {
                                    const episodicMemory = {
                                        id: `episodic_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                        characterId: characterId, // ‰∏•Ê†ºÁªëÂÆöËßíËâ≤ID
                                        fact: memory.fact,
                                        importance: memory.importance,
                                        category: memory.category || 'other',
                                        timestamp: Date.now(),
                                        source: 'single_chat' // Ê†áËÆ∞Êù•Ê∫ê
                                    };

                                    await db.episodicMemories.add(episodicMemory);
                                    console.log(`‚úÖ [${character.name}] ÊÉÖÊôØËÆ∞ÂøÜ: ${memory.fact}`);
                                }
                            }
                        }
                    } catch (parseError) {
                        console.warn('Ëß£ÊûêËÆ∞ÂøÜJSONÂ§±Ë¥•:', parseError);
                    }
                }
            } catch (error) {
                console.error('AIËÆ∞ÂøÜÊèêÂèñÂ§±Ë¥•:', error);
            }
        }

        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÁîüÊàêÊëòË¶Å
        async function checkAndGenerateSummary(characterId) {
            try {
                const messages = chatMessages[characterId] || [];
                if (messages.length === 0) return;

                // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊ¨°ÊëòË¶ÅÁöÑÊó∂Èó¥
                const summaries = await db.memorySummaries
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const lastSummary = summaries.length > 0
                    ? summaries.sort((a, b) => b.timestamp - a.timestamp)[0]
                    : null;

                let shouldGenerate = false;
                let messagesToSummarize = [];

                if (!lastSummary) {
                    // Â¶ÇÊûú‰ªéÊú™ÁîüÊàêËøáÊëòË¶ÅÔºå‰∏îÊ∂àÊÅØÊï∞ÈáèËææÂà∞ÈòàÂÄº
                    if (messages.length >= MEMORY_CONFIG.SUMMARY_TRIGGER_MESSAGE_COUNT) {
                        messagesToSummarize = messages.slice(-MEMORY_CONFIG.SUMMARY_TRIGGER_MESSAGE_COUNT);
                        shouldGenerate = true;
                    }
                } else {
                    // ËÆ°ÁÆóËá™‰∏äÊ¨°ÊëòË¶ÅÂêéÁöÑÊñ∞Ê∂àÊÅØ
                    const lastSummaryTime = lastSummary.context?.endTime || lastSummary.timestamp;
                    const newMessages = messages.filter(msg => msg.timestamp > lastSummaryTime);

                    // Ê£ÄÊü•Ê∂àÊÅØÊï∞ÈáèÊàñÊó∂Èó¥Èó¥Èöî
                    const timeDiff = Date.now() - lastSummary.timestamp;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);

                    if (newMessages.length >= MEMORY_CONFIG.SUMMARY_TRIGGER_MESSAGE_COUNT ||
                        hoursDiff >= MEMORY_CONFIG.SUMMARY_TRIGGER_TIME_HOURS) {
                        messagesToSummarize = newMessages.slice(-MEMORY_CONFIG.SUMMARY_TRIGGER_MESSAGE_COUNT);
                        shouldGenerate = true;
                    }
                }

                if (shouldGenerate && messagesToSummarize.length > 0) {
                    await generateConversationSummary(characterId, messagesToSummarize);
                }
            } catch (error) {
                console.error('Ê£ÄÊü•ÊëòË¶ÅÁîüÊàêÂ§±Ë¥•:', error);
            }
        }

        // ÁßªÈô§ÂÖ≥ÈîÆËØçÊèêÂèñÂäüËÉΩÔºåÁÆÄÂåñ‰∏∫Á∫ØAIÊèêÂèñ

        // AIËÆ∞ÂøÜÊèêÂèñÂäüËÉΩÔºà‰∏•Ê†ºÁöÑÊ†∏ÂøÉËÆ∞ÂøÜÔºâ
        async function extractMemoriesWithAI(characterId, messages) {
            if (!messages || messages.length === 0) return;

            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // ÊûÑÂª∫Êõ¥‰∏•Ê†ºÁöÑËÆ∞ÂøÜÊèêÂèñprompt
                const extractPrompt = `
# ËÆ∞ÂøÜÊèêÂèñ‰ªªÂä°

‰Ω†ÈúÄË¶Å‰ªé‰ª•‰∏ãÂØπËØù‰∏≠ÊèêÂèñ‰∏§Á±ªËÆ∞ÂøÜÔºöÊ†∏ÂøÉËÆ∞ÂøÜÂíåÊÉÖÊôØËÆ∞ÂøÜ„ÄÇ

## ËßíËâ≤‰ø°ÊÅØ
- ËßíËâ≤ÂêçÁß∞: ${character.name}
- ËßíËâ≤ËÆæÂÆö: ${character.bio || 'Êó†ÁâπÊÆäËÆæÂÆö'}

## ÂØπËØùÂÜÖÂÆπ
${messages.map(msg => {
    const sender = msg.sender === 'sent' ? 'Áî®Êà∑' : character.name;
    const content = typeof msg.content === 'string' ? msg.content : '[ÂõæÁâá/Êñá‰ª∂]';
    return `${sender}: ${content}`;
}).join('\n')}

## ÊèêÂèñÊ†áÂáÜ

### Ê†∏ÂøÉËÆ∞ÂøÜÔºàimportance >= 0.9Ôºâ
Âè™Êúâ‰ª•‰∏ãÁ±ªÂûãÁöÑ‰ø°ÊÅØÊâçËÉΩÊàê‰∏∫Ê†∏ÂøÉËÆ∞ÂøÜÔºö
- Áî®Êà∑ÁöÑÂü∫Êú¨‰ø°ÊÅØÔºöÁúüÂÆûÂßìÂêç„ÄÅÁîüÊó•„ÄÅËÅå‰∏ö„ÄÅÂÆ∂Â∫≠ÊàêÂëò
- ÈáçÂ§ßÊÉÖÊÑüËΩ¨ÂèòÔºöË°®ÁôΩ„ÄÅÂàÜÊâã„ÄÅÂíåÂ•Ω„ÄÅÊ∑±Â∫¶ÊÉÖÊÑü‰∫§ÊµÅ
- ÈáçË¶ÅÊâøËØ∫ÂíåÁ∫¶ÂÆöÔºöÈïøÊúüËÆ°Âàí„ÄÅÈáçË¶ÅÁ∫¶ÂÆö
- ÂÖ≥ÈîÆ‰∫∫Áîü‰∫ã‰ª∂ÔºöÊØï‰∏ö„ÄÅÂ∑•‰ΩúÂèòÂä®„ÄÅÊê¨ÂÆ∂„ÄÅÈáçË¶ÅÁ∫™ÂøµÊó•
- ËßíËâ≤‰∏éÁî®Êà∑ÂÖ≥Á≥ªÁöÑÈáçÂ§ßÂèòÂåñ

### ÊÉÖÊôØËÆ∞ÂøÜÔºàimportance 0.6-0.8Ôºâ
Êó•Â∏∏‰ΩÜÊúâÊÑè‰πâÁöÑ‰∫ã‰ª∂Ôºö
- ‰∏ÄËµ∑ÂÅöÁöÑÊ¥ªÂä®Âíå‰ΩìÈ™å
- Áî®Êà∑ÁöÑ‰π†ÊÉØÂíåÂÅèÂ•Ω
- ÊúâË∂£ÁöÑÂØπËØùÂíå‰∫íÂä®
- Êó•Â∏∏ÁîüÊ¥ªÁöÑÂàÜ‰∫´

ËØ∑‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãJSONÊ†ºÂºèËøîÂõûÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÂÖ∂‰ªñÊñáÂ≠óÔºö

{
  "core_memories": [
    {"fact": "ÁÆÄÊ¥ÅÁöÑÊ†∏ÂøÉ‰∫ãÂÆû", "importance": 0.9, "category": "Á±ªÂà´"}
  ],
  "episodic_memories": [
    {"fact": "ÊÉÖÊôØÊèèËø∞", "importance": 0.7, "category": "Á±ªÂà´"}
  ]
}

Ê≥®ÊÑèÔºö
1. Âè™ËøîÂõûJSONÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïËß£ÈáäÊñáÂ≠ó
2. Â¶ÇÊûúÊ≤°ÊúâÁ¨¶ÂêàÊ†áÂáÜÁöÑËÆ∞ÂøÜÔºåÂØπÂ∫îÊï∞ÁªÑ‰∏∫Á©∫
3. importanceÂøÖÈ°ªÊòØÊï∞Â≠óÔºå‰∏çË¶ÅÁî®Â≠óÁ¨¶‰∏≤
4. Á°Æ‰øùJSONÊ†ºÂºèÂÆåÂÖ®Ê≠£Á°Æ`;

                // Ë∞ÉÁî®AIÊèêÂèñÊ†∏ÂøÉËÆ∞ÂøÜ
                const response = await callChatAPI(extractPrompt, character);
                let memories = [];

                try {
                    // Â∞ùËØïËß£ÊûêJSONÂìçÂ∫î
                    const responseText = Array.isArray(response) ? response[0] : response;
                    if (responseText && typeof responseText === 'string') {
                        console.log('üîç AIËÆ∞ÂøÜÊèêÂèñÂéüÂßãÂìçÂ∫î:', responseText);

                        // Â§öÁßçÊñπÂºèÂ∞ùËØïÊèêÂèñJSON
                        let jsonText = null;

                        // ÊñπÂºè1: ÊèêÂèñÂÆåÊï¥ÁöÑJSONÂØπË±°
                        const jsonObjectMatch = responseText.match(/\{[\s\S]*\}/);
                        if (jsonObjectMatch) {
                            jsonText = jsonObjectMatch[0];
                        } else {
                            // ÊñπÂºè2: ÊèêÂèñJSONÊï∞ÁªÑ
                            const jsonArrayMatch = responseText.match(/\[[\s\S]*\]/);
                            if (jsonArrayMatch) {
                                jsonText = jsonArrayMatch[0];
                            }
                        }

                        if (jsonText) {
                            console.log('üîç ÊèêÂèñÁöÑJSONÊñáÊú¨:', jsonText);
                            memories = JSON.parse(jsonText);
                        } else {
                            console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊ†ºÂºè');
                            return; // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞JSONÔºåÁõ¥Êé•ËøîÂõû
                        }
                    }
                } catch (parseError) {
                    console.warn('Ëß£ÊûêÊ†∏ÂøÉËÆ∞ÂøÜJSONÂ§±Ë¥•:', parseError);
                    console.warn('ÂéüÂßãÂìçÂ∫î:', responseText);
                    return; // Ëß£ÊûêÂ§±Ë¥•Êó∂Áõ¥Êé•ËøîÂõûÔºåÈÅøÂÖçÂêéÁª≠ÈîôËØØ
                    return;
                }

                // Ëé∑ÂèñÁé∞ÊúâÁöÑÊ†∏ÂøÉËÆ∞ÂøÜÔºåÊ£ÄÊü•ÈáçÂ§ç
                const existingMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                // ‰øùÂ≠òÊ†∏ÂøÉËÆ∞ÂøÜÂà∞Êï∞ÊçÆÂ∫ìÔºàÊ£ÄÊü•ÈáçÂ§çÔºâ
                for (const memory of memories) {
                    if (memory.importance >= MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD) {
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏‰ººÁöÑËÆ∞ÂøÜ
                        const isDuplicate = existingMemories.some(existing => {
                            const similarity = calculateTextSimilarity(existing.fact, memory.fact);
                            return similarity > 0.8; // Áõ∏‰ººÂ∫¶Ë∂ÖËøá80%ËÆ§‰∏∫ÊòØÈáçÂ§ç
                        });

                        if (!isDuplicate) {
                            const coreMemory = {
                                id: `core_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                characterId: characterId,
                                fact: memory.fact,
                                importance: memory.importance,
                                category: memory.category || 'other',
                                timestamp: Date.now()
                            };

                            await db.coreMemories.add(coreMemory);
                            console.log(`‚úÖ ‰∏∫ËßíËâ≤ ${character.name} Ê∑ªÂä†Ê†∏ÂøÉËÆ∞ÂøÜ: ${memory.fact}`);
                        } else {
                            console.log(`‚ö†Ô∏è Ë∑≥ËøáÈáçÂ§çËÆ∞ÂøÜ: ${memory.fact}`);
                        }
                    }
                }

                // Ê∏ÖÁêÜËøáÂ§öÁöÑÊ†∏ÂøÉËÆ∞ÂøÜ
                await cleanupCoreMemories(characterId);

            } catch (error) {
                console.error('ÊèêÂèñÊ†∏ÂøÉËÆ∞ÂøÜÂ§±Ë¥•:', error);
            }
        }

        // Ê∏ÖÁêÜËøáÂ§öÁöÑÊ†∏ÂøÉËÆ∞ÂøÜÔºå‰øùÁïôÊúÄÈáçË¶ÅÁöÑ
        async function cleanupCoreMemories(characterId) {
            try {
                const allMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const memories = allMemories.sort((a, b) => b.importance - a.importance);

                if (memories.length > MEMORY_CONFIG.MAX_CORE_MEMORIES_PER_CHARACTER) {
                    const toDelete = memories.slice(MEMORY_CONFIG.MAX_CORE_MEMORIES_PER_CHARACTER);
                    for (const memory of toDelete) {
                        await db.coreMemories.delete(memory.id);
                    }
                    console.log(`üßπ Ê∏ÖÁêÜ‰∫Ü ${toDelete.length} ‰∏™‰ΩéÈáçË¶ÅÊÄßÁöÑÊ†∏ÂøÉËÆ∞ÂøÜ`);
                }
            } catch (error) {
                console.error('Ê∏ÖÁêÜÊ†∏ÂøÉËÆ∞ÂøÜÂ§±Ë¥•:', error);
            }
        }

        // Ëé∑ÂèñËßíËâ≤ÁöÑÊ†∏ÂøÉËÆ∞ÂøÜÁî®‰∫éÂØπËØù
        async function getCoreMemoriesForChat(characterId, limit = 10) {
            try {
                const allMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const memories = allMemories
                    .sort((a, b) => b.importance - a.importance)
                    .slice(0, limit);

                return memories.map(m => m.fact).join('\n');
            } catch (error) {
                console.error('Ëé∑ÂèñÊ†∏ÂøÉËÆ∞ÂøÜÂ§±Ë¥•:', error);
                return '';
            }
        }

        // Ë∑®Â∫îÁî®Êó∂Èó¥Á∫øËÆ∞ÂΩïÂäüËÉΩ
        async function recordCrossAppEvent(characterId, appType, action, context, messageId = null) {
            try {
                // üî•„Äê‰øÆÂ§ç„ÄëÈ™åËØÅÂøÖÈúÄÂèÇÊï∞
                if (!characterId || !appType || !action) {
                    console.error('‚ùå ËÆ∞ÂΩï‰∫ã‰ª∂Â§±Ë¥•: Áº∫Â∞ëÂøÖÈúÄÂèÇÊï∞', {
                        characterId,
                        appType,
                        action
                    });
                    return;
                }

                // üî•„Äê‰øÆÂ§ç„ÄëÁ°Æ‰øùcontextÊòØÊúâÊïàÂØπË±°
                const validContext = context && typeof context === 'object' ? context : {};

                const timelineEvent = {
                    id: `timeline_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    characterId: String(characterId), // Á°Æ‰øùÊòØÂ≠óÁ¨¶‰∏≤
                    appType: String(appType),
                    action: String(action),
                    timestamp: Date.now(),
                    context: validContext,
                    messageId: messageId ? String(messageId) : null
                };

                // üî•„Äê‰øÆÂ§ç„ÄëÈ™åËØÅIDÂ≠óÊÆµ
                if (!timelineEvent.id || !timelineEvent.characterId) {
                    console.error('‚ùå ËÆ∞ÂΩï‰∫ã‰ª∂Â§±Ë¥•: IDÂ≠óÊÆµÊó†Êïà', timelineEvent);
                    return;
                }

                await db.crossAppTimeline.add(timelineEvent);
                console.log(`üìù ËÆ∞ÂΩïÊó∂Èó¥Á∫ø‰∫ã‰ª∂: ${appType}.${action}`, validContext);

            } catch (error) {
                console.error('‚ùå ËÆ∞ÂΩï‰∫ã‰ª∂Â§±Ë¥•:', error);
                console.error('‰∫ã‰ª∂Êï∞ÊçÆ:', {characterId, appType, action, context, messageId});
            }
        }

        // Ëé∑ÂèñËßíËâ≤ÁöÑË∑®Â∫îÁî®Êó∂Èó¥Á∫øÔºàÁî®‰∫éÊûÑÂª∫ËøûÁª≠ÁöÑÂ∑•‰ΩúËÆ∞ÂøÜÔºâ
        async function getCrossAppTimeline(characterId, limit = 20) {
            try {
                const timeline = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                return timeline
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, limit);
            } catch (error) {
                console.error('Ëé∑ÂèñË∑®Â∫îÁî®Êó∂Èó¥Á∫øÂ§±Ë¥•:', error);
                return [];
            }
        }

        // ÊûÑÂª∫ËøûÁª≠ÁöÑÂ∑•‰ΩúËÆ∞ÂøÜÔºàÂåÖÂê´Ë∑®Â∫îÁî®‰∫ã‰ª∂ÔºåÊåâÊó∂Èó¥ÊªöÂä®Ôºâ
        async function buildContinuousWorkingMemory(characterId, chatMessages, userSetLimit = 50) {
            try {
                // Ëé∑ÂèñËÅäÂ§©Ê∂àÊÅØ
                const messages = chatMessages.map(msg => ({
                    type: 'chat',
                    timestamp: msg.timestamp,
                    content: msg,
                    appType: 'chat',
                    characterId: characterId // Á°Æ‰øùËßíËâ≤ÈöîÁ¶ª
                }));

                // Ëé∑ÂèñËØ•ËßíËâ≤ÁöÑË∑®Â∫îÁî®Êó∂Èó¥Á∫øÔºàÂè™Ëé∑Âèñ‰∏éËØ•ËßíËâ≤Áõ∏ÂÖ≥ÁöÑÔºâ
                const timeline = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                // üî•„Äê‰øÆÂ§ç„ÄëÊ≠£Á°ÆÂå∫ÂàÜËÅäÂ§©‰∫ã‰ª∂ÂíåË∑®Â∫îÁî®‰∫ã‰ª∂
                const timelineEvents = timeline
                    .filter(event => event.appType !== 'chat') // ÊéíÈô§ËÅäÂ§©‰∫ã‰ª∂ÔºåÈÅøÂÖçÈáçÂ§ç
                    .map(event => ({
                        type: 'cross_app',
                        timestamp: event.timestamp,
                        content: event,
                        appType: event.appType,
                        characterId: characterId
                    }));

                // ÂêàÂπ∂ÊâÄÊúâ‰∫ã‰ª∂Âπ∂ÊåâÊó∂Èó¥ÊéíÂ∫è
                const allEvents = [...messages, ...timelineEvents]
                    .sort((a, b) => a.timestamp - b.timestamp);

                // ÊåâÁî®Êà∑ËÆæÁΩÆÁöÑÂ∑•‰ΩúËÆ∞ÂøÜÈôêÂà∂ËøõË°åÊªöÂä®
                // Ë∑®Â∫îÁî®‰∫ã‰ª∂‰ºöÈöèÁùÄÊó∂Èó¥Êé®ËøõËÄåËá™ÁÑ∂ÊªöÂä®Âá∫Âéª
                const recentEvents = allEvents.slice(-userSetLimit);

                return recentEvents;
            } catch (error) {
                console.error('ÊûÑÂª∫ËøûÁª≠Â∑•‰ΩúËÆ∞ÂøÜÂ§±Ë¥•:', error);
                return chatMessages.map(msg => ({
                    type: 'chat',
                    timestamp: msg.timestamp,
                    content: msg,
                    appType: 'chat',
                    characterId: characterId
                }));
            }
        }

        // ‰∏∫ËßíËâ≤ÁîüÊàêË∑®Â∫îÁî®ËÆ∞ÂøÜÊèèËø∞
        async function generateCrossAppMemoryDescription(characterId, memoryEvent) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                let memoryDescription = '';
                const context = memoryEvent.context;

                switch (memoryEvent.eventType) {
                    case 'music_interaction':
                        if (context.action === 'listen_together') {
                            memoryDescription = `ÂíåÁî®Êà∑‰∏ÄËµ∑Âê¨‰∫Ü„Ää${context.songTitle}„ÄãÔºå${context.duration || ''}`;
                        } else if (context.action === 'song_comment') {
                            memoryDescription = `ÂØπÊ≠åÊõ≤„Ää${context.songTitle}„ÄãÂèëË°®‰∫ÜÁúãÊ≥ïÔºö${context.comment}`;
                        }
                        break;

                    case 'game_interaction':
                        if (context.action === 'play_together') {
                            memoryDescription = `ÂíåÁî®Êà∑‰∏ÄËµ∑Áé©‰∫Ü${context.gameName}Ôºå${context.result || ''}`;
                        } else if (context.action === 'game_comment') {
                            memoryDescription = `ÂØπÊ∏∏Êàè${context.gameName}ÂèëË°®‰∫ÜÁúãÊ≥ïÔºö${context.comment}`;
                        }
                        break;

                    case 'forum_interaction':
                        if (context.action === 'post_comment') {
                            memoryDescription = `Âú®ËÆ∫ÂùõÂèëË°®‰∫ÜËØÑËÆ∫Ôºö${context.comment}`;
                        } else if (context.action === 'topic_discussion') {
                            memoryDescription = `ÂèÇ‰∏é‰∫ÜÂÖ≥‰∫é"${context.topic}"ÁöÑËÆ®ËÆ∫`;
                        }
                        break;
                }

                if (memoryDescription) {
                    // Â∞ÜË∑®Â∫îÁî®ËÆ∞ÂøÜ‰Ωú‰∏∫Ê†∏ÂøÉËÆ∞ÂøÜ‰øùÂ≠ò
                    const coreMemory = {
                        id: `cross_${characterId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        characterId: characterId,
                        fact: memoryDescription,
                        importance: 0.6, // Ë∑®Â∫îÁî®ËÆ∞ÂøÜÁöÑÈªòËÆ§ÈáçË¶ÅÊÄß
                        category: 'cross_app',
                        timestamp: Date.now(),
                        sourceEvent: memoryEvent.id
                    };

                    await db.coreMemories.add(coreMemory);
                    console.log(`‚úÖ ‰∏∫ËßíËâ≤ ${character.name} Ê∑ªÂä†Ë∑®Â∫îÁî®ËÆ∞ÂøÜ: ${memoryDescription}`);
                }

            } catch (error) {
                console.error('ÁîüÊàêË∑®Â∫îÁî®ËÆ∞ÂøÜÊèèËø∞Â§±Ë¥•:', error);
            }
        }

        // Ëé∑ÂèñËßíËâ≤ÁöÑË∑®Â∫îÁî®ËÆ∞ÂøÜ
        async function getCrossAppMemories(characterId, limit = 5) {
            try {
                const allMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const crossAppMemories = allMemories
                    .filter(memory => memory.category === 'cross_app')
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, limit);

                return crossAppMemories.map(m => m.fact);
            } catch (error) {
                console.error('Ëé∑ÂèñË∑®Â∫îÁî®ËÆ∞ÂøÜÂ§±Ë¥•:', error);
                return [];
            }
        }

        // Ê∏ÖÁêÜÈáçÂ§çËÆ∞ÂøÜÁöÑÂäüËÉΩ
        async function cleanupDuplicateMemories(characterId) {
            try {
                const memories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const duplicates = [];

                for (let i = 0; i < memories.length; i++) {
                    for (let j = i + 1; j < memories.length; j++) {
                        const similarity = calculateTextSimilarity(memories[i].fact, memories[j].fact);
                        if (similarity > 0.8) {
                            // ‰øùÁïôÈáçË¶ÅÊÄßÊõ¥È´òÁöÑÔºåÂà†Èô§ÈáçË¶ÅÊÄßËæÉ‰ΩéÁöÑ
                            const toDelete = memories[i].importance >= memories[j].importance ? memories[j] : memories[i];
                            if (!duplicates.find(d => d.id === toDelete.id)) {
                                duplicates.push(toDelete);
                            }
                        }
                    }
                }

                for (const duplicate of duplicates) {
                    await db.coreMemories.delete(duplicate.id);
                    console.log(`üßπ Âà†Èô§ÈáçÂ§çËÆ∞ÂøÜ: ${duplicate.fact}`);
                }

                if (duplicates.length > 0) {
                    console.log(`‚úÖ Ê∏ÖÁêÜ‰∫Ü ${duplicates.length} Êù°ÈáçÂ§çËÆ∞ÂøÜ`);
                }
            } catch (error) {
                console.error('Ê∏ÖÁêÜÈáçÂ§çËÆ∞ÂøÜÂ§±Ë¥•:', error);
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∏ÖÁêÜÈîôËØØÁöÑË∑®Â∫îÁî®Êó∂Èó¥Á∫øËÆ∞ÂΩï
        async function cleanupIncorrectTimelineRecords() {
            try {
                console.log('üßπ ÂºÄÂßãÊ∏ÖÁêÜÈîôËØØÁöÑË∑®Â∫îÁî®Êó∂Èó¥Á∫øËÆ∞ÂΩï...');

                // Âà†Èô§ÊâÄÊúâ appType ‰∏∫ 'chat' ÁöÑËÆ∞ÂΩïÔºàËøô‰∫õÂ∫îËØ•Âè™Â≠òÂú®‰∫éËÅäÂ§©ËÆ∞ÂΩï‰∏≠Ôºâ
                const chatRecords = await db.crossAppTimeline
                    .where('appType')
                    .equals('chat')
                    .toArray();

                for (const record of chatRecords) {
                    await db.crossAppTimeline.delete(record.id);
                }

                console.log(`‚úÖ Ê∏ÖÁêÜÂÆåÊàêÔºåÂà†Èô§‰∫Ü ${chatRecords.length} Êù°ÈîôËØØÁöÑËÅäÂ§©ËÆ∞ÂΩï`);
                return chatRecords.length;

            } catch (error) {
                console.error('Ê∏ÖÁêÜÈîôËØØËÆ∞ÂΩïÂ§±Ë¥•:', error);
                return 0;
            }
        }

        // üîç„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂøÜ‰ΩøÁî®ÊÉÖÂÜµÁªüËÆ°ÂáΩÊï∞
        async function logMemoryUsageStats(character, scenario) {
            try {
                const characterId = character.isGroup ? 'group' : character.id;
                const memorySettings = getGlobalMemorySettings();

                console.log(`\nüìä ===== ËÆ∞ÂøÜ‰ΩøÁî®ÁªüËÆ° (${scenario}) =====`);
                console.log(`üé≠ ËßíËâ≤: ${character.name} (${character.isGroup ? 'Áæ§ËÅä' : 'ÂçïËÅä'})`);
                console.log(`‚è∞ ËÆ∞ÂøÜÂ§©Êï∞ËÆæÁΩÆ: ${memorySettings.memoryDays}Â§©`);

                if (character.isGroup) {
                    // Áæ§ËÅäÔºöÁªüËÆ°ÊØè‰∏™ÊàêÂëòÁöÑËÆ∞ÂøÜ
                    for (const member of character.members) {
                        await logSingleCharacterMemoryStats(member.id, member.name, memorySettings.memoryDays);
                    }
                } else {
                    // ÂçïËÅäÔºöÁªüËÆ°Âçï‰∏™ËßíËâ≤ÁöÑËÆ∞ÂøÜ
                    await logSingleCharacterMemoryStats(character.id, character.name, memorySettings.memoryDays);
                }

                console.log(`üìä ===== ËÆ∞ÂøÜÁªüËÆ°ÁªìÊùü =====\n`);

            } catch (error) {
                console.error('ËÆ∞ÂøÜÁªüËÆ°Â§±Ë¥•:', error);
            }
        }

        // üîç„ÄêÊñ∞Â¢û„ÄëÂçï‰∏™ËßíËâ≤ÁöÑËÆ∞ÂøÜÁªüËÆ°
        async function logSingleCharacterMemoryStats(characterId, characterName, memoryDays) {
            try {
                // 1. Ê†∏ÂøÉËÆ∞ÂøÜÁªüËÆ°
                const coreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .toArray();
                const limitedCoreMemories = coreMemories.slice(0, 10);

                // 2. ÊÉÖÊôØËÆ∞ÂøÜÁªüËÆ°
                const cutoffTimestamp = Date.now() - (memoryDays * 24 * 60 * 60 * 1000);
                const episodicMemories = await db.episodicMemories
                    .where('characterId')
                    .equals(characterId)
                    .and(memory => memory.timestamp >= cutoffTimestamp)
                    .toArray();
                const limitedEpisodicMemories = episodicMemories.slice(0, 15);

                // 3. Êó∂Èó¥Á∫øËÆ∞ÂøÜÁªüËÆ°
                const timelineMemories = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .and(event => event.timestamp >= cutoffTimestamp)
                    .toArray();
                const limitedTimelineMemories = timelineMemories.slice(0, 20);

                // 4. ÂØπËØùÊëòË¶ÅÁªüËÆ°
                const cutoffDateStr = new Date(cutoffTimestamp).toISOString().split('T')[0];
                const memorySummaries = await db.memorySummaries
                    .where('characterId')
                    .equals(characterId)
                    .and(summary => summary.date >= cutoffDateStr)
                    .toArray();
                const limitedMemorySummaries = memorySummaries.slice(0, 10);

                // 5. ËÆ°ÁÆóÊÄªtoken‰º∞ÁÆóÔºàÊåâÊØè‰∏™‰∏≠ÊñáÂ≠óÁ¨¶1.5tokenËÆ°ÁÆóÔºâ
                const coreMemoryTokens = limitedCoreMemories.reduce((sum, m) => sum + (m.fact?.length || 0), 0) * 1.5;
                const episodicMemoryTokens = limitedEpisodicMemories.reduce((sum, m) => sum + (m.fact?.length || 0), 0) * 1.5;
                const timelineMemoryTokens = limitedTimelineMemories.reduce((sum, m) => sum + (m.context?.content?.length || 0), 0) * 1.5;
                const summaryMemoryTokens = limitedMemorySummaries.reduce((sum, m) => sum + (m.summary?.length || 0), 0) * 1.5;
                const totalMemoryTokens = coreMemoryTokens + episodicMemoryTokens + timelineMemoryTokens + summaryMemoryTokens;

                console.log(`\nüë§ ${characterName} (ID: ${characterId}):`);
                console.log(`  üî¥ Ê†∏ÂøÉËÆ∞ÂøÜ: ${limitedCoreMemories.length}Êù° (ÊÄªÂ∫ìÂ≠ò: ${coreMemories.length}Êù°) ~${Math.round(coreMemoryTokens)}tokens`);
                console.log(`  üü† ÊÉÖÊôØËÆ∞ÂøÜ: ${limitedEpisodicMemories.length}Êù° (ÊÄªÂ∫ìÂ≠ò: ${episodicMemories.length}Êù°) ~${Math.round(episodicMemoryTokens)}tokens`);
                console.log(`  üü£ Êó∂Èó¥Á∫øËÆ∞ÂøÜ: ${limitedTimelineMemories.length}Êù° (ÊÄªÂ∫ìÂ≠ò: ${timelineMemories.length}Êù°) ~${Math.round(timelineMemoryTokens)}tokens`);
                console.log(`  üîµ ÂØπËØùÊëòË¶Å: ${limitedMemorySummaries.length}Êù° (ÊÄªÂ∫ìÂ≠ò: ${memorySummaries.length}Êù°) ~${Math.round(summaryMemoryTokens)}tokens`);
                console.log(`  üí∞ ËÆ∞ÂøÜÊÄªÊ∂àËÄó: ~${Math.round(totalMemoryTokens)}tokens`);

                // 6. Ê£ÄÊü•ÊòØÂê¶ÁÆóÂú®Â∑•‰ΩúËÆ∞ÂøÜ‰∏≠
                // 7. Ê£ÄÊü•Ë∑®Â∫îÁî®Â∑•‰ΩúËÆ∞ÂøÜÈõÜÊàê
                const userHistoryLimit = getCurrentChatSettings().historyCount || 5;
                const crossAppInWorkingMemory = Math.floor(userHistoryLimit * 0.3);
                const chatInWorkingMemory = userHistoryLimit - crossAppInWorkingMemory;

                console.log(`  ‚ö†Ô∏è  Ê≥®ÊÑè: Ëøô‰∫õËÆ∞ÂøÜÊòØÈ¢ùÂ§ñÊ∑ªÂä†ÁöÑÔºå‰∏çÂç†Áî®Áî®Êà∑ËÆæÁΩÆÁöÑ"ÈôÑÂ∏¶ÂéÜÂè≤Ê∂àÊÅØÊï∞"ÈÖçÈ¢ù`);
                console.log(`  üìù Â∑•‰ΩúËÆ∞ÂøÜÊûÑÊàê:`);
                console.log(`    - ËÅäÂ§©ÂéÜÂè≤: ${chatInWorkingMemory}Êù° (Áî®Êà∑ËÆæÁΩÆ: ${userHistoryLimit}Êù°)`);
                console.log(`    - Ë∑®Â∫îÁî®‰∫ã‰ª∂: ${crossAppInWorkingMemory}Êù° (Ëá™Âä®ÈõÜÊàê)`);
                console.log(`    - ÊÄªÂ∑•‰ΩúËÆ∞ÂøÜ: ${userHistoryLimit}Êù° (ÊåâÊó∂Èó¥È°∫Â∫èÊªöÂä®)`);

            } catch (error) {
                console.error(`ÁªüËÆ°ËßíËâ≤ ${characterName} ËÆ∞ÂøÜÂ§±Ë¥•:`, error);
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÂà†Èô§‰∏éÊ∂àÊÅØÁõ∏ÂÖ≥ÁöÑÊó∂Èó¥Á∫øËÆ∞ÂΩï
        async function deleteRelatedTimelineEvents(messageToDelete) {
            try {
                const characterId = currentChatCharacter.id;
                const messageContent = messageToDelete.content;
                const messageTimestamp = messageToDelete.timestamp;

                // Êü•ÊâæÁõ∏ÂÖ≥ÁöÑÊó∂Èó¥Á∫øËÆ∞ÂΩïÔºàÂü∫‰∫éÂÜÖÂÆπÂíåÊó∂Èó¥Êà≥ÂåπÈÖçÔºâ
                const relatedEvents = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .and(event => {
                        // Ê£ÄÊü•Êó∂Èó¥Êà≥ÊòØÂê¶Êé•ËøëÔºàÂÖÅËÆ∏5ÂàÜÈíüËØØÂ∑ÆÔºâ
                        const timeDiff = Math.abs(event.timestamp - messageTimestamp);
                        const isTimeMatch = timeDiff < 5 * 60 * 1000; // 5ÂàÜÈíü

                        // Ê£ÄÊü•ÂÜÖÂÆπÊòØÂê¶ÂåπÈÖç
                        const isContentMatch = event.context &&
                                             event.context.content &&
                                             event.context.content.includes(messageContent.substring(0, 30));

                        return isTimeMatch && isContentMatch;
                    })
                    .toArray();

                // Âà†Èô§ÂåπÈÖçÁöÑÊó∂Èó¥Á∫øËÆ∞ÂΩï
                for (const event of relatedEvents) {
                    await db.crossAppTimeline.delete(event.id);
                    console.log(`üóëÔ∏è Âà†Èô§Áõ∏ÂÖ≥Êó∂Èó¥Á∫øËÆ∞ÂΩï: ${event.action} - ${event.context?.content?.substring(0, 50)}...`);
                }

                console.log(`‚úÖ Âà†Èô§‰∫Ü ${relatedEvents.length} Êù°Áõ∏ÂÖ≥Êó∂Èó¥Á∫øËÆ∞ÂΩï`);

            } catch (error) {
                console.error('Âà†Èô§Áõ∏ÂÖ≥Êó∂Èó¥Á∫øËÆ∞ÂΩïÂ§±Ë¥•:', error);
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∏ÖÁêÜ‰ΩéË¥®ÈáèÊóßÁâàÊú¨ËÆ∞ÂøÜÁöÑÂáΩÊï∞
        async function cleanupLowQualityMemories(characterId) {
            try {
                console.log(`üßπ ÂºÄÂßãÊ∏ÖÁêÜËßíËâ≤ ${characterId} ÁöÑ‰ΩéË¥®ÈáèÊóßÁâàÊú¨ËÆ∞ÂøÜ...`);

                const currentThreshold = MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD;

                // Ê∏ÖÁêÜÈáçË¶ÅÊÄß‰Ωé‰∫éÂΩìÂâçÈòàÂÄºÁöÑÊ†∏ÂøÉËÆ∞ÂøÜ
                const lowQualityCoreMemories = await db.coreMemories
                    .where('characterId')
                    .equals(characterId)
                    .and(memory => (memory.importance || 0) < currentThreshold)
                    .toArray();

                for (const memory of lowQualityCoreMemories) {
                    await db.coreMemories.delete(memory.id);
                    console.log(`üóëÔ∏è Âà†Èô§‰ΩéË¥®ÈáèÊ†∏ÂøÉËÆ∞ÂøÜ (ÈáçË¶ÅÊÄß: ${memory.importance}): ${memory.fact}`);
                }

                console.log(`‚úÖ Ê∏ÖÁêÜÂÆåÊàêÔºåÂà†Èô§‰∫Ü ${lowQualityCoreMemories.length} Êù°‰ΩéË¥®ÈáèÊ†∏ÂøÉËÆ∞ÂøÜ`);
                return lowQualityCoreMemories.length;

            } catch (error) {
                console.error('Ê∏ÖÁêÜ‰ΩéË¥®ÈáèËÆ∞ÂøÜÂ§±Ë¥•:', error);
                return 0;
            }
        }

        // ËÆ∞ÂøÜÊü•ÁúãÂô®ÂäüËÉΩ
        let currentMemoryFilter = 'all';
        let currentMemoryCharacter = null;
        let allMemories = [];

        // ÂàùÂßãÂåñËÆ∞ÂøÜÊü•ÁúãÂô®
        async function initMemoryViewer() {
            await loadCharacterSelectOptions();
        }

        // Âä†ËΩΩËßíËâ≤ÈÄâÊã©ÈÄâÈ°π
        async function loadCharacterSelectOptions() {
            const select = document.getElementById('memory-character-select');
            if (!select) return;

            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            select.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ËßíËâ≤</option>';

            // Ê∑ªÂä†ËßíËâ≤ÈÄâÈ°π
            characters.forEach(character => {
                const option = document.createElement('option');
                option.value = character.id;
                option.textContent = character.name;
                select.appendChild(option);
            });
        }

        // Âä†ËΩΩËßíËâ≤ËÆ∞ÂøÜ
        async function loadCharacterMemories() {
            const select = document.getElementById('memory-character-select');
            const characterId = select.value;

            if (!characterId) {
                currentMemoryCharacter = null;
                allMemories = [];
                renderMemoryList();
                return;
            }

            currentMemoryCharacter = characterId;

            try {
                // Ëé∑ÂèñÊâÄÊúâÁ±ªÂûãÁöÑËÆ∞ÂøÜ
                const [coreMemories, episodicMemories, timeline] = await Promise.all([
                    db.coreMemories.where('characterId').equals(characterId).toArray(),
                    db.episodicMemories.where('characterId').equals(characterId).toArray(),
                    db.crossAppTimeline.where('characterId').equals(characterId).toArray()
                ]);

                // ÂêàÂπ∂ÊâÄÊúâËÆ∞ÂøÜÂπ∂Ê∑ªÂä†Á±ªÂûãÊ†áËØÜ
                allMemories = [
                    ...coreMemories.filter(m => m.type === 'core').map(m => ({...m, memoryType: 'core'})),
                    ...episodicMemories.map(m => ({...m, memoryType: 'episodic'})),
                    ...timeline.map(m => ({
                        ...m,
                        memoryType: 'timeline',
                        fact: formatTimelineEvent(m)
                    }))
                ];

                // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
                allMemories.sort((a, b) => b.timestamp - a.timestamp);

                renderMemoryList();
            } catch (error) {
                console.error('Âä†ËΩΩËßíËâ≤ËÆ∞ÂøÜÂ§±Ë¥•:', error);
                showToast('Âä†ËΩΩËÆ∞ÂøÜÂ§±Ë¥•', 'error');
            }
        }

        // ÂàáÊç¢ËÆ∞ÂøÜËøáÊª§Âô®
        function switchMemoryFilter(type) {
            currentMemoryFilter = type;

            // Êõ¥Êñ∞Ê†áÁ≠æÊ†∑Âºè
            document.querySelectorAll('.memory-filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            renderMemoryList();
        }

        // ËøáÊª§ËÆ∞ÂøÜ
        function filterMemories() {
            renderMemoryList();
        }

        // Ê∏≤ÊüìËÆ∞ÂøÜÂàóË°®
        function renderMemoryList() {
            const container = document.getElementById('memory-list');
            if (!container) return;

            if (!currentMemoryCharacter || allMemories.length === 0) {
                container.innerHTML = `
                    <div class="memory-empty-state">
                        <i class="fas fa-brain"></i>
                        <p>${currentMemoryCharacter ? 'ËØ•ËßíËâ≤ÊöÇÊó†ËÆ∞ÂøÜÊï∞ÊçÆ' : 'ËØ∑ÈÄâÊã©ËßíËâ≤Êü•ÁúãËÆ∞ÂøÜ'}</p>
                    </div>
                `;
                return;
            }

            // Ëé∑ÂèñÊêúÁ¥¢ÂÖ≥ÈîÆËØç
            const searchTerm = document.getElementById('memory-search-input').value.toLowerCase();

            // ËøáÊª§ËÆ∞ÂøÜ
            let filteredMemories = allMemories;

            // ÊåâÁ±ªÂûãËøáÊª§
            if (currentMemoryFilter !== 'all') {
                filteredMemories = filteredMemories.filter(memory => memory.memoryType === currentMemoryFilter);
            }

            // ÊåâÊêúÁ¥¢ËØçËøáÊª§
            if (searchTerm) {
                filteredMemories = filteredMemories.filter(memory => {
                    const content = memory.fact || memory.summary || '';
                    return content.toLowerCase().includes(searchTerm);
                });
            }

            if (filteredMemories.length === 0) {
                container.innerHTML = `
                    <div class="memory-empty-state">
                        <i class="fas fa-search"></i>
                        <p>Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑËÆ∞ÂøÜ</p>
                    </div>
                `;
                return;
            }

            // Ê∏≤ÊüìËÆ∞ÂøÜÈ°π
            const html = filteredMemories.map(memory => renderMemoryItem(memory)).join('');
            container.innerHTML = html;
        }

        // Ê∏≤ÊüìÂçï‰∏™ËÆ∞ÂøÜÈ°π
        function renderMemoryItem(memory) {
            const date = new Date(memory.timestamp).toLocaleDateString('zh-CN');
            const content = memory.fact || memory.summary || '';
            const importance = memory.importance || 0;
            const stars = '‚òÖ'.repeat(Math.round(importance * 5));

            const typeLabels = {
                'core': 'Ê†∏ÂøÉËÆ∞ÂøÜ',
                'episodic': 'ÊÉÖÊôØËÆ∞ÂøÜ',
                'timeline': 'Êó∂Èó¥Á∫ø'
            };

            return `
                <div class="memory-item" data-memory-id="${memory.id}">
                    <div class="memory-item-header">
                        <span class="memory-item-type ${memory.memoryType}">
                            <i class="fas fa-${getMemoryTypeIcon(memory.memoryType)}"></i>
                            ${typeLabels[memory.memoryType]}
                        </span>
                        <span class="memory-item-date">${date}</span>
                    </div>
                    <div class="memory-item-content">${content}</div>
                    ${memory.memoryType === 'core' || memory.memoryType === 'episodic' ? `
                        <div class="memory-item-importance">
                            <span>ÈáçË¶ÅÊÄß:</span>
                            <span class="importance-stars">${stars}</span>
                            <span>(${(importance * 100).toFixed(0)}%)</span>
                        </div>
                    ` : ''}
                    <div class="memory-item-actions">
                        <button class="memory-action-btn" onclick="editMemory('${memory.id}', '${memory.memoryType}')">
                            <i class="fas fa-edit"></i> ÁºñËæë
                        </button>
                        <button class="memory-action-btn delete" onclick="deleteMemory('${memory.id}', '${memory.memoryType}')">
                            <i class="fas fa-trash"></i> Âà†Èô§
                        </button>
                    </div>
                </div>
            `;
        }

        // Ëé∑ÂèñËÆ∞ÂøÜÁ±ªÂûãÂõæÊ†á
        function getMemoryTypeIcon(type) {
            const icons = {
                'core': 'star',
                'episodic': 'calendar-day',
                'timeline': 'clock'
            };
            return icons[type] || 'circle';
        }

        // üî•„ÄêÈáçÊñ∞ËÆæËÆ°„ÄëÊ†ºÂºèÂåñÊó∂Èó¥Á∫ø‰∫ã‰ª∂ÊòæÁ§∫ - ÁÆÄÂåñÁâàÊú¨ÔºåÈÅøÂÖçÊòæÁ§∫‰∏çÂÆåÊï¥ÂÜÖÂÆπ
        function formatTimelineEvent(event) {
            const appNames = {
                'chat': 'ËÅäÂ§©',
                'music': 'Èü≥‰πê',
                'moments': 'Âä®ÊÄÅ',
                'diary': 'Êó•ËÆ∞'
            };

            const appName = appNames[event.appType] || event.appType;
            let description = '';

            try {
                const context = typeof event.context === 'string' ? JSON.parse(event.context) : event.context;

                switch (event.appType) {
                    case 'chat':
                        if (event.action === 'ai_reply') {
                            description = `Âú®ÂçïËÅä‰∏≠ÂõûÂ§ç‰∫ÜÊ∂àÊÅØ`;
                        } else if (event.action === 'user_message') {
                            description = `Âú®ÂçïËÅä‰∏≠Êî∂Âà∞Áî®Êà∑Ê∂àÊÅØ`;
                        } else {
                            description = `ËøõË°å‰∫ÜËÅäÂ§©‰∫íÂä®`;
                        }
                        break;
                    case 'music':
                        if (context.action === 'listen_together') {
                            description = `‰∏éÁî®Êà∑‰∏ÄËµ∑Âê¨Ê≠åÔºö${context.songTitle || context.song || ''}`;
                        } else if (context.action === 'song_comment') {
                            description = `ÂØπÈü≥‰πêÂèëË°®‰∫ÜËØÑËÆ∫`;
                        } else {
                            description = `ËøõË°å‰∫ÜÈü≥‰πê‰∫íÂä®`;
                        }
                        break;
                    case 'moments':
                        if (event.action === 'ai_to_ai_reply') {
                            description = `Âú®Âä®ÊÄÅ‰∏≠ÂõûÂ§ç‰∫ÜÂÖ∂‰ªñËßíËâ≤`;
                        } else if (event.action === 'reply_to_user') {
                            description = `Âú®Âä®ÊÄÅ‰∏≠ÂõûÂ§ç‰∫ÜÁî®Êà∑`;
                        } else {
                            description = `ËøõË°å‰∫ÜÂä®ÊÄÅ‰∫íÂä®`;
                        }
                        break;
                    case 'diary':
                        description = `ÂÜô‰∫ÜÊó•ËÆ∞`;
                        break;
                    default:
                        description = `ËøõË°å‰∫Ü${event.action || 'Êú™Áü•'}Ê¥ªÂä®`;
                }
            } catch (e) {
                description = `ËøõË°å‰∫Ü${event.action || 'Êú™Áü•'}Ê¥ªÂä®`;
            }

            return `„Äê${appName}„Äë${description}`;
        }

        // Âà∑Êñ∞ËÆ∞ÂøÜÊï∞ÊçÆ
        async function refreshMemoryData() {
            if (currentMemoryCharacter) {
                await loadCharacterMemories();
                showToast('ËÆ∞ÂøÜÊï∞ÊçÆÂ∑≤Âà∑Êñ∞', 'success');
            }
        }

        // Ê∏ÖÁêÜÂΩìÂâçËßíËâ≤ÁöÑÈáçÂ§çËÆ∞ÂøÜ
        async function cleanupCurrentCharacterMemories() {
            if (!currentMemoryCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ËßíËâ≤', 'warning');
                return;
            }

            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÈáçÂ§çËÆ∞ÂøÜÂêóÔºüËøôÂ∞ÜÂà†Èô§Áõ∏‰ººÂ∫¶Ë∂ÖËøá80%ÁöÑÈáçÂ§çËÆ∞ÂøÜ„ÄÇ')) {
                return;
            }

            try {
                await cleanupDuplicateMemories(currentMemoryCharacter);
                await loadCharacterMemories();
                showToast('ÈáçÂ§çËÆ∞ÂøÜÊ∏ÖÁêÜÂÆåÊàê', 'success');
            } catch (error) {
                console.error('Ê∏ÖÁêÜÈáçÂ§çËÆ∞ÂøÜÂ§±Ë¥•:', error);
                showToast('Ê∏ÖÁêÜÂ§±Ë¥•', 'error');
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∏ÖÁêÜÂΩìÂâçËßíËâ≤ÁöÑÈáçÂ§çÊó∂Èó¥Á∫øËÆ∞ÂΩï
        async function cleanupCurrentCharacterTimeline() {
            if (!currentMemoryCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ËßíËâ≤', 'warning');
                return;
            }

            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÈáçÂ§çÁöÑÊó∂Èó¥Á∫øËÆ∞ÂΩïÂêóÔºüËøôÂ∞ÜÂà†Èô§ÂÜÖÂÆπÁõ∏‰ººÁöÑÈáçÂ§çÊó∂Èó¥Á∫ø‰∫ã‰ª∂„ÄÇ')) {
                return;
            }

            try {
                const deletedCount = await cleanupDuplicateTimelineEvents(currentMemoryCharacter);
                await loadCharacterMemories();
                showToast(`Êó∂Èó¥Á∫øÊ∏ÖÁêÜÂÆåÊàêÔºåÂà†Èô§‰∫Ü${deletedCount}Êù°ÈáçÂ§çËÆ∞ÂΩï`, 'success');
            } catch (error) {
                console.error('Ê∏ÖÁêÜÊó∂Èó¥Á∫øÂ§±Ë¥•:', error);
                showToast('Ê∏ÖÁêÜÂ§±Ë¥•', 'error');
            }
        }

        // üßπ„ÄêÊñ∞Â¢û„ÄëÊòæÁ§∫ËÆ∞ÂøÜÊ∏ÖÁêÜÂ∑•ÂÖ∑ÂºπÁ™ó
        function showMemoryToolsModal() {
            if (!currentMemoryCharacter) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ËßíËâ≤', 'warning');
                return;
            }

            const modal = document.getElementById('memory-tools-modal');
            if (modal) {
                modal.style.display = 'flex';
                // Ê∑ªÂä†Ê∑°ÂÖ•Âä®Áîª
                setTimeout(() => {
                    modal.style.opacity = '1';
                }, 10);
            }
        }

        // üßπ„ÄêÊñ∞Â¢û„ÄëÈöêËóèËÆ∞ÂøÜÊ∏ÖÁêÜÂ∑•ÂÖ∑ÂºπÁ™ó
        function hideMemoryToolsModal() {
            const modal = document.getElementById('memory-tools-modal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 200);
            }
        }

        // ÁÇπÂáªÂºπÁ™óËÉåÊôØÂÖ≥Èó≠ÂºπÁ™ó
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('memory-tools-modal');
            if (modal && event.target === modal) {
                hideMemoryToolsModal();
            }
        });

        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∏ÖÁêÜÈîôËØØÁöÑËÆ∞ÂΩï
        async function cleanupIncorrectRecords() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÈîôËØØÁöÑËÆ∞ÂΩïÂêóÔºüËøôÂ∞ÜÂà†Èô§Ë∑®Â∫îÁî®Êó∂Èó¥Á∫ø‰∏≠ÈîôËØØÁöÑËÅäÂ§©ËÆ∞ÂΩï„ÄÇ')) {
                return;
            }

            try {
                const deletedCount = await cleanupIncorrectTimelineRecords();
                await loadCharacterMemories();
                showToast(`ÈîôËØØËÆ∞ÂΩïÊ∏ÖÁêÜÂÆåÊàêÔºåÂà†Èô§‰∫Ü${deletedCount}Êù°ÈîôËØØËÆ∞ÂΩï`, 'success');
            } catch (error) {
                console.error('Ê∏ÖÁêÜÈîôËØØËÆ∞ÂΩïÂ§±Ë¥•:', error);
                showToast('Ê∏ÖÁêÜÂ§±Ë¥•', 'error');
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÊ∏ÖÁêÜÈáçÂ§çÁöÑÊó∂Èó¥Á∫ø‰∫ã‰ª∂
        async function cleanupDuplicateTimelineEvents(characterId) {
            try {
                console.log(`üßπ ÂºÄÂßãÊ∏ÖÁêÜËßíËâ≤ ${characterId} ÁöÑÈáçÂ§çÊó∂Èó¥Á∫øËÆ∞ÂΩï...`);

                const timelineEvents = await db.crossAppTimeline
                    .where('characterId')
                    .equals(characterId)
                    .toArray();

                const duplicates = [];
                const seenContents = new Map(); // ÂÜÖÂÆπ -> Á¨¨‰∏Ä‰∏™‰∫ã‰ª∂

                for (const event of timelineEvents) {
                    const content = event.context?.content;
                    if (content) {
                        const normalizedContent = content.toLowerCase().trim();
                        if (seenContents.has(normalizedContent)) {
                            // ÂèëÁé∞ÈáçÂ§çÔºå‰øùÁïôÊó∂Èó¥Êà≥ËæÉÊó©ÁöÑ
                            const existingEvent = seenContents.get(normalizedContent);
                            if (event.timestamp > existingEvent.timestamp) {
                                duplicates.push(event);
                            } else {
                                duplicates.push(existingEvent);
                                seenContents.set(normalizedContent, event);
                            }
                        } else {
                            seenContents.set(normalizedContent, event);
                        }
                    }
                }

                // Âà†Èô§ÈáçÂ§çÁöÑÊó∂Èó¥Á∫øËÆ∞ÂΩï
                for (const duplicate of duplicates) {
                    await db.crossAppTimeline.delete(duplicate.id);
                    console.log(`üóëÔ∏è Âà†Èô§ÈáçÂ§çÊó∂Èó¥Á∫øËÆ∞ÂΩï: ${duplicate.action} - ${duplicate.context?.content?.substring(0, 50)}...`);
                }

                console.log(`‚úÖ Ê∏ÖÁêÜÂÆåÊàêÔºåÂà†Èô§‰∫Ü ${duplicates.length} Êù°ÈáçÂ§çÊó∂Èó¥Á∫øËÆ∞ÂΩï`);
                return duplicates.length;

            } catch (error) {
                console.error('Ê∏ÖÁêÜÈáçÂ§çÊó∂Èó¥Á∫øËÆ∞ÂΩïÂ§±Ë¥•:', error);
                return 0;
            }
        }

        // ÊòæÁ§∫ËÆ∞ÂøÜËÆæÁΩÆ
        function showMemorySettings() {
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            document.getElementById('aiExtractInterval').value = MEMORY_CONFIG.AI_EXTRACT_INTERVAL / 2; // ËΩ¨Êç¢‰∏∫ËΩÆÊï∞
            document.getElementById('coreMemoryThreshold').value = MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD;
            document.getElementById('episodicMemoryThreshold').value = MEMORY_CONFIG.EPISODIC_MEMORY_IMPORTANCE_THRESHOLD;

            // Êõ¥Êñ∞ÊòæÁ§∫ÂÄº
            updateThresholdDisplay();

            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('memorySettingsModal').style.display = 'flex';
        }

        // ÂÖ≥Èó≠ËÆ∞ÂøÜËÆæÁΩÆ
        function closeMemorySettings() {
            document.getElementById('memorySettingsModal').style.display = 'none';
        }

        // Êõ¥Êñ∞ÈòàÂÄºÊòæÁ§∫
        function updateThresholdDisplay() {
            const coreThreshold = document.getElementById('coreMemoryThreshold').value;
            const episodicThreshold = document.getElementById('episodicMemoryThreshold').value;

            document.getElementById('coreThresholdValue').textContent = Math.round(coreThreshold * 100) + '%';
            document.getElementById('episodicThresholdValue').textContent = Math.round(episodicThreshold * 100) + '%';
        }

        // ‰øùÂ≠òËÆ∞ÂøÜËÆæÁΩÆ
        async function saveMemorySettings() {
            try {
                const aiInterval = parseInt(document.getElementById('aiExtractInterval').value);
                const coreThreshold = parseFloat(document.getElementById('coreMemoryThreshold').value);
                const episodicThreshold = parseFloat(document.getElementById('episodicMemoryThreshold').value);

                // Êõ¥Êñ∞ÈÖçÁΩÆ
                MEMORY_CONFIG.AI_EXTRACT_INTERVAL = aiInterval * 2; // ËΩ¨Êç¢‰∏∫Ê∂àÊÅØÊï∞
                MEMORY_CONFIG.CORE_MEMORY_IMPORTANCE_THRESHOLD = coreThreshold;
                MEMORY_CONFIG.EPISODIC_MEMORY_IMPORTANCE_THRESHOLD = episodicThreshold;

                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await saveMemoryConfig();

                closeMemorySettings();
                showToast('ËÆ∞ÂøÜËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
            } catch (error) {
                console.error('‰øùÂ≠òËÆ∞ÂøÜËÆæÁΩÆÂ§±Ë¥•:', error);
                showToast('‰øùÂ≠òÂ§±Ë¥•', 'error');
            }
        }

        // ÁºñËæëËÆ∞ÂøÜ
        async function editMemory(memoryId, memoryType) {
            try {
                // üî•„Äê‰øÆÂ§ç„ÄëÊó∂Èó¥Á∫øËÆ∞ÂøÜ‰∏çÂÖÅËÆ∏ÁºñËæë
                if (memoryType === 'timeline') {
                    showToast('Êó∂Èó¥Á∫øËÆ∞ÂøÜÊòØËá™Âä®ËÆ∞ÂΩïÁöÑÊ¥ªÂä®Êó•ÂøóÔºå‰∏çÊîØÊåÅÁºñËæë', 'warning');
                    return;
                }

                let memory;
                if (memoryType === 'summary') {
                    memory = await db.memorySummaries.get(memoryId);
                } else if (memoryType === 'core') {
                    memory = await db.coreMemories.get(memoryId);
                } else {
                    showToast('‰∏çÊîØÊåÅÁöÑËÆ∞ÂøÜÁ±ªÂûã', 'error');
                    return;
                }

                if (!memory) {
                    showToast('ËÆ∞ÂøÜ‰∏çÂ≠òÂú®', 'error');
                    return;
                }

                const content = memory.fact || memory.summary || '';
                const newContent = await showCustomPrompt('ÁºñËæëËÆ∞ÂøÜ', 'ËØ∑ËæìÂÖ•Êñ∞ÁöÑËÆ∞ÂøÜÂÜÖÂÆπ', content);

                if (newContent && newContent.trim() && newContent !== content) {
                    if (memoryType === 'summary') {
                        memory.summary = newContent.trim();
                        await db.memorySummaries.put(memory);
                    } else {
                        memory.fact = newContent.trim();
                        await db.coreMemories.put(memory);
                    }

                    await loadCharacterMemories();
                    showToast('ËÆ∞ÂøÜÂ∑≤Êõ¥Êñ∞', 'success');
                }
            } catch (error) {
                console.error('ÁºñËæëËÆ∞ÂøÜÂ§±Ë¥•:', error);
                showToast('ÁºñËæëËÆ∞ÂøÜÂ§±Ë¥•', 'error');
            }
        }

        // Âà†Èô§ËÆ∞ÂøÜ
        async function deleteMemory(memoryId, memoryType) {
            // üî•„Äê‰øÆÂ§ç„ÄëÊó∂Èó¥Á∫øËÆ∞ÂøÜÂà†Èô§Á°ÆËÆ§
            let confirmMessage = 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂøÜÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ';
            if (memoryType === 'timeline') {
                confirmMessage = 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Êó∂Èó¥Á∫øËÆ∞ÂΩïÂêóÔºüËøôÊòØËá™Âä®ËÆ∞ÂΩïÁöÑÊ¥ªÂä®Êó•ÂøóÔºåÂà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ';
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                if (memoryType === 'summary') {
                    await db.memorySummaries.delete(memoryId);
                } else if (memoryType === 'core') {
                    await db.coreMemories.delete(memoryId);
                } else if (memoryType === 'episodic') {
                    await db.episodicMemories.delete(memoryId);
                } else if (memoryType === 'timeline') {
                    await db.crossAppTimeline.delete(memoryId);
                } else {
                    showToast('‰∏çÊîØÊåÅÁöÑËÆ∞ÂøÜÁ±ªÂûã', 'error');
                    return;
                }

                await loadCharacterMemories();
                showToast('ËÆ∞ÂøÜÂ∑≤Âà†Èô§', 'success');
            } catch (error) {
                console.error('Âà†Èô§ËÆ∞ÂøÜÂ§±Ë¥•:', error);
                showToast('Âà†Èô§ËÆ∞ÂøÜÂ§±Ë¥•', 'error');
            }
        }

        // AIÂøÉÁéáÁÆ°ÁêÜÂäüËÉΩ
        let heartrateInterval = null;
        let currentHeartrate = 72; // Âü∫Á°ÄÂøÉÁéá

        function updateAiHeartrate() {
            const heartrateDisplay = document.getElementById('ai-heartrate-display');
            if (!heartrateDisplay) return;
            
            const chatSettings = getCurrentChatSettings();
            
            // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®ÂøÉÁéáÁõëÊµã‰∏î‰∏çÊòØÁæ§ËÅä
            if (!chatSettings.aiHeartrateEnabled || (currentChatCharacter && currentChatCharacter.isGroup)) {
                hideAiHeartrate();
                return;
            }
            
            // ÊòæÁ§∫ÂøÉÁéá
            heartrateDisplay.style.display = 'block';
            
            // ËÆ°ÁÆóÂü∫Á°ÄÂøÉÁéáÔºàÂü∫‰∫éËßíËâ≤‰∫∫ËÆæÔºâ
            const persona = (currentChatCharacter.bio || '').toLowerCase();
            const name = (currentChatCharacter.name || '').toLowerCase();
            let baseHeartrate = 72;
            
            // Ê†πÊçÆËßíËâ≤ÁâπÂæÅË∞ÉÊï¥Âü∫Á°ÄÂøÉÁéá
            if (persona.includes('Á¥ßÂº†') || persona.includes('ÂÆ≥Áæû') || persona.includes('ÊïèÊÑü') || 
                persona.includes('ÁæûÊ∂©') || persona.includes('ÂÆπÊòìËÑ∏Á∫¢') || persona.includes('ÂÜÖÂêë')) {
                baseHeartrate = 85; // ÂÆπÊòìÁ¥ßÂº†ÁöÑËßíËâ≤ÂøÉÁéáÊõ¥È´ò
            } else if (persona.includes('ÂÜ∑Èùô') || persona.includes('ÁêÜÊÄß') || persona.includes('ÊàêÁÜü') || 
                       persona.includes('Ê≤âÁ®≥') || persona.includes('ÂÜÖÊïõ') || persona.includes('‰∏•ËÇÉ')) {
                baseHeartrate = 65; // ÂÜ∑ÈùôÁöÑËßíËâ≤ÂøÉÁéáÊõ¥‰Ωé
            } else if (persona.includes('Ê¥ªÊ≥º') || persona.includes('ÂÖ¥Â•ã') || persona.includes('ÁÉ≠ÊÉÖ') || 
                       persona.includes('ÂºÄÊúó') || persona.includes('Â§ñÂêë') || persona.includes('Áà±Á¨ë')) {
                baseHeartrate = 82; // Ê¥ªÊ≥ºÁöÑËßíËâ≤ÂøÉÁéáÂÅèÈ´ò
            } else if (persona.includes('ËøêÂä®') || persona.includes('ÂÅ•Ë∫´') || persona.includes('‰ΩìËÇ≤') || 
                       persona.includes('ËøêÂä®Âëò') || persona.includes('Ê¥ªË∑É')) {
                baseHeartrate = 58; // ËøêÂä®ÂûãËßíËâ≤ÂøÉÁéáÊúÄ‰Ωé
            } else if (persona.includes('Ê∏©Êüî') || persona.includes('ÁîúÁæé') || persona.includes('ÂèØÁà±') || 
                       persona.includes('ËΩØËêå') || persona.includes('Â∞èÈ∏ü‰æù‰∫∫') || persona.includes('‰πñÂ∑ß')) {
                baseHeartrate = 75; // Ê∏©ÊüîÂûãËßíËâ≤ÂøÉÁéáÈÄÇ‰∏≠ÂÅèÈ´ò
            } else if (persona.includes('ÂÜ∑ÈÖ∑') || persona.includes('È´òÂÜ∑') || persona.includes('ÂÇ≤Â®á') || 
                       persona.includes('Â•≥Áéã') || persona.includes('Âº∫Âäø') || persona.includes('Èú∏ÈÅì')) {
                baseHeartrate = 68; // È´òÂÜ∑ÂûãËßíËâ≤ÂøÉÁéáÂÅè‰Ωé
            } else if (persona.includes('ÁÉ≠Ë°Ä') || persona.includes('ÂÜ≤Âä®') || persona.includes('ÊÄ•ÊÄßÂ≠ê') || 
                       persona.includes('ÁÅ´ÁàÜ') || persona.includes('Êö¥Ë∫Å') || persona.includes('ÊòìÊÄí')) {
                baseHeartrate = 88; // ÁÉ≠Ë°ÄÂûãËßíËâ≤ÂøÉÁéáÂæàÈ´ò
            } else if (persona.includes('Á•ûÁßò') || persona.includes('Ê∑±Ê≤â') || persona.includes('ÂÆâÈùô') || 
                       persona.includes('ÊñáÈùô') || persona.includes('ÂÜÖÂêë')) {
                baseHeartrate = 70; // Á•ûÁßòÂûãËßíËâ≤ÂøÉÁéáÊ≠£Â∏∏ÂÅè‰Ωé
            }
            
            // Ê†πÊçÆËßíËâ≤ÂêçÂ≠óËøõ‰∏ÄÊ≠•ÂæÆË∞É
            if (name.includes('Â∞è') || name.includes('Ëêå') || name.includes('ÂèØÁà±')) {
                baseHeartrate += 3; // ÂèØÁà±ÂêçÂ≠óÁöÑËßíËâ≤ÂøÉÁéáÁ®çÈ´ò
            } else if (name.includes('ÂÜ∞') || name.includes('Èõ™') || name.includes('Èùô') || 
                       name.includes('ÂÜ∑') || name.includes('Âáâ')) {
                baseHeartrate -= 5; // ÂÜ∑Á≥ªÂêçÂ≠óÁöÑËßíËâ≤ÂøÉÁéáÊõ¥‰Ωé
            } else if (name.includes('ÁÅ´') || name.includes('ÁÉ≠') || name.includes('ÁÉà')) {
                baseHeartrate += 5; // ÁÅ´Á≥ªÂêçÂ≠óÁöÑËßíËâ≤ÂøÉÁéáÊõ¥È´ò
            }
            
            // Ê†πÊçÆÊúÄËøëÂØπËØùÂÜÖÂÆπË∞ÉÊï¥ÂøÉÁéá
            const recentMessages = (chatMessages[currentChatCharacter.id] || []).slice(-8); // ÂàÜÊûêÊúÄËøë8Êù°Ê∂àÊÅØ
            let emotionAdjustment = 0;
            
            recentMessages.forEach(msg => {
                // ÂÆâÂÖ®Âú∞Â§ÑÁêÜÊ∂àÊÅØÂÜÖÂÆπ
                let content = '';
                if (typeof msg.content === 'string') {
                    content = msg.content.toLowerCase();
                } else if (Array.isArray(msg.content)) {
                    content = '';
                } else {
                    content = '';
                }
                
                // È´òÂ∫¶‰∫≤ÂØÜËØçÊ±á - Â§ßÂπÖÊèêÈ´òÂøÉÁéá
                if (content.includes('Áà±‰Ω†') || content.includes('ÊàëÁà±‰Ω†') || content.includes('love you') || 
                    content.includes('ÂñúÊ¨¢‰Ω†') || content.includes('ÊÉ≥‰Ω†') || content.includes('ÊÉ≥Êä±‰Ω†') ||
                    content.includes('ÊÉ≥Âêª‰Ω†') || content.includes('‰∫≤‰∫≤') || content.includes('Êä±Êä±') ||
                    content.includes('ÂÆùË¥ù') || content.includes('darling') || content.includes('honey') ||
                    content.includes('‰∫≤Áà±ÁöÑ') || content.includes('ÊÉ≥Ë¶Å‰Ω†') || content.includes('ÈúÄË¶Å‰Ω†') ||
                    content.includes('Á¶ª‰∏çÂºÄ‰Ω†') || content.includes('ÊÉ≥Âíå‰Ω†') || content.includes('ÊÉ≥ËßÅ‰Ω†')) {
                    emotionAdjustment += 15;
                }
                
                // Ë°®ÁôΩÂíåÁîúËúúËØçÊ±á
                if (content.includes('Ë°®ÁôΩ') || content.includes('ÂñúÊ¨¢') || content.includes('ÂøÉÂä®') || 
                    content.includes('ÂøÉË∑≥') || content.includes('ËÑ∏Á∫¢') || content.includes('ÂÆ≥Áæû') ||
                    content.includes('ÂèØÁà±') || content.includes('Áîú') || content.includes('Ê∏©Êüî') ||
                    content.includes('Áæé‰∏Ω') || content.includes('ÊºÇ‰∫Æ') || content.includes('Ëø∑‰∫∫') ||
                    content.includes('È≠ÖÂäõ') || content.includes('Âê∏Âºï') || content.includes('ÂøÉ‰ª™')) {
                    emotionAdjustment += 10;
                }
                
                // ÊííÂ®áÂíå‰∫≤ÊòµËØçÊ±á
                if (content.includes('ÊííÂ®á') || content.includes('Âò§Âò§') || content.includes('Âìº') ||
                    content.includes('‰∫∫ÂÆ∂') || content.includes('ËÆ®Âéå') || content.includes('‰∏çË¶Å') ||
                    content.includes('Â•Ω‰∏çÂ•Ω') || content.includes('Ê±Ç‰Ω†') || content.includes('ÊãúÊâò') ||
                    content.includes('Èô™Êàë') || content.includes('Èô™Èô™') || content.includes('‰∏ÄËµ∑')) {
                    emotionAdjustment += 8;
                }
                
                // ÂÖ¥Â•ãÂíåÂºÄÂøÉËØçÊ±á
                if (content.includes('ÂºÄÂøÉ') || content.includes('È´òÂÖ¥') || content.includes('Âø´‰πê') || 
                    content.includes('ÂÖ¥Â•ã') || content.includes('ÊøÄÂä®') || content.includes('Â•ΩÊ£í') || 
                    content.includes('ÂéâÂÆ≥') || content.includes('Âìá') || content.includes('Â§™Â•Ω‰∫Ü') ||
                    content.includes('amazing') || content.includes('wonderful') || content.includes('great')) {
                    emotionAdjustment += 6;
                }
                
                // Ë¥üÈù¢ÊÉÖÁª™ËØçÊ±á - ÂêåÊ†∑‰ºöËÆ©ÂøÉÁéáÂä†Âø´
                if (content.includes('ÈöæËøá') || content.includes('ÁîüÊ∞î') || content.includes('ÊãÖÂøÉ') || 
                    content.includes('ÂÆ≥ÊÄï') || content.includes('Á¥ßÂº†') || content.includes('ÁÑ¶Ëôë') ||
                    content.includes('‰∏çÂºÄÂøÉ') || content.includes('ÈÉÅÈó∑') || content.includes('ÁÉ¶') ||
                    content.includes('ÂéãÂäõ') || content.includes('Á¥Ø') || content.includes('Áñ≤ÊÉ´')) {
                    emotionAdjustment += 8;
                }
            });
            
            // ËÆ°ÁÆóÊúÄÁªàÂøÉÁéá
            currentHeartrate = Math.max(50, Math.min(140, baseHeartrate + emotionAdjustment));
            
            // ÂêØÂä®ÂøÉÁéáÊõ¥Êñ∞
            if (heartrateInterval) clearInterval(heartrateInterval);
            heartrateInterval = setInterval(() => {
                // Ê∑ªÂä†Ëá™ÁÑ∂ÁöÑÂøÉÁéáÊ≥¢Âä®Ôºà¬±4 bpmÔºâ
                const fluctuation = Math.floor(Math.random() * 9) - 4;
                const displayHeartrate = Math.max(50, Math.min(140, currentHeartrate + fluctuation));
                
                // Ê†πÊçÆÂøÉÁéáÈ´ò‰ΩéÊ∑ªÂä†ËßÜËßâÊïàÊûú
                heartrateDisplay.className = '';
                if (displayHeartrate >= 110) {
                    heartrateDisplay.classList.add('very-high-heartrate');
                } else if (displayHeartrate >= 95) {
                    heartrateDisplay.classList.add('high-heartrate');
                }
                
                heartrateDisplay.innerHTML = `‚ô•Ô∏è <span class="heartrate-number">${displayHeartrate}</span> <span class="heartrate-unit">bpm</span>`;
            }, 1500 + Math.random() * 1000); // 1.5-2.5ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
            
            // Á´ãÂç≥ÊòæÁ§∫ÂàùÂßãÂøÉÁéá
            heartrateDisplay.innerHTML = `‚ô•Ô∏è <span class="heartrate-number">${currentHeartrate}</span> <span class="heartrate-unit">bpm</span>`;
        }

        function hideAiHeartrate() {
            const heartrateDisplay = document.getElementById('ai-heartrate-display');
            if (heartrateDisplay) {
                heartrateDisplay.style.display = 'none';
            }
            
            if (heartrateInterval) {
                clearInterval(heartrateInterval);
                heartrateInterval = null;
            }
        }

        // ÂΩìÂèëÈÄÅÊ∂àÊÅØÊó∂Êõ¥Êñ∞ÂøÉÁéá
        function adjustHeartrateForMessage(content, isUserMessage = false) {
            if (!heartrateInterval) return; // ÂøÉÁéáÁõëÊµãÊú™ÂêØÁî®
            
            let adjustment = 0;
            let lowerContent = '';
            let recoveryTime = 3000; // ÈªòËÆ§ÊÅ¢Â§çÊó∂Èó¥
            
            // ÂÆâÂÖ®Âú∞Â§ÑÁêÜÂÜÖÂÆπ
            if (typeof content === 'string') {
                lowerContent = content.toLowerCase();
            } else if (Array.isArray(content)) {
                lowerContent = '';
            } else {
                lowerContent = '';
            }
            
            if (isUserMessage) {
                // Áî®Êà∑ÂèëÈÄÅÊ∂àÊÅØÊó∂ÔºåAIÁöÑÂøÉÁéá‰ºöÊúâÁõ∏Â∫îÂèçÂ∫î
                
                // È´òÂ∫¶‰∫≤ÂØÜËØçÊ±á - Âº∫ÁÉàÂøÉË∑≥Âä†ÈÄü
                if (lowerContent.includes('Áà±‰Ω†') || lowerContent.includes('ÊàëÁà±‰Ω†') || lowerContent.includes('love you') || 
                    lowerContent.includes('ÂñúÊ¨¢‰Ω†') || lowerContent.includes('ÊÉ≥‰Ω†') || lowerContent.includes('ÊÉ≥Êä±‰Ω†') ||
                    lowerContent.includes('ÊÉ≥Âêª‰Ω†') || lowerContent.includes('‰∫≤‰∫≤') || lowerContent.includes('Êä±Êä±') ||
                    lowerContent.includes('ÂÆùË¥ù') || lowerContent.includes('darling') || lowerContent.includes('honey') ||
                    lowerContent.includes('‰∫≤Áà±ÁöÑ') || lowerContent.includes('ÊÉ≥Ë¶Å‰Ω†') || lowerContent.includes('ÈúÄË¶Å‰Ω†') ||
                    lowerContent.includes('Á¶ª‰∏çÂºÄ‰Ω†') || lowerContent.includes('ÊÉ≥Âíå‰Ω†') || lowerContent.includes('ÊÉ≥ËßÅ‰Ω†')) {
                    adjustment = 20; // Â§ßÂπÖÂ¢ûÂä†
                    recoveryTime = 8000; // Êõ¥ÈïøÁöÑÊÅ¢Â§çÊó∂Èó¥
                }
                // Ë°®ÁôΩÂíåÁîúËúúËØçÊ±á
                else if (lowerContent.includes('Ë°®ÁôΩ') || lowerContent.includes('ÂñúÊ¨¢') || lowerContent.includes('ÂøÉÂä®') || 
                    lowerContent.includes('ÂøÉË∑≥') || lowerContent.includes('ËÑ∏Á∫¢') || lowerContent.includes('ÂÆ≥Áæû') ||
                    lowerContent.includes('ÂèØÁà±') || lowerContent.includes('Áîú') || lowerContent.includes('Ê∏©Êüî') ||
                    lowerContent.includes('Áæé‰∏Ω') || lowerContent.includes('ÊºÇ‰∫Æ') || lowerContent.includes('Ëø∑‰∫∫') ||
                    lowerContent.includes('È≠ÖÂäõ') || lowerContent.includes('Âê∏Âºï') || lowerContent.includes('ÂøÉ‰ª™')) {
                    adjustment = 15;
                    recoveryTime = 6000;
                }
                // ÊííÂ®áÂíå‰∫≤ÊòµËØçÊ±á
                else if (lowerContent.includes('ÊííÂ®á') || lowerContent.includes('Âò§Âò§') || lowerContent.includes('Âìº') ||
                    lowerContent.includes('‰∫∫ÂÆ∂') || lowerContent.includes('ËÆ®Âéå') || lowerContent.includes('‰∏çË¶Å') ||
                    lowerContent.includes('Â•Ω‰∏çÂ•Ω') || lowerContent.includes('Ê±Ç‰Ω†') || lowerContent.includes('ÊãúÊâò') ||
                    lowerContent.includes('Èô™Êàë') || lowerContent.includes('Èô™Èô™') || lowerContent.includes('‰∏ÄËµ∑')) {
                    adjustment = 12;
                    recoveryTime = 5000;
                }
                // ÂÖ¥Â•ãÂíåÂºÄÂøÉËØçÊ±á
                else if (lowerContent.includes('ÂºÄÂøÉ') || lowerContent.includes('È´òÂÖ¥') || lowerContent.includes('Âø´‰πê') || 
                    lowerContent.includes('ÂÖ¥Â•ã') || lowerContent.includes('ÊøÄÂä®') || lowerContent.includes('Â•ΩÊ£í') || 
                    lowerContent.includes('ÂéâÂÆ≥') || lowerContent.includes('Âìá') || lowerContent.includes('Â§™Â•Ω‰∫Ü')) {
                    adjustment = 8;
                    recoveryTime = 4000;
                }
                // Ë¥üÈù¢ÊÉÖÁª™ËØçÊ±á - Á¥ßÂº†ÂØºËá¥ÂøÉÁéáÂä†Âø´
                else if (lowerContent.includes('ÁîüÊ∞î') || lowerContent.includes('‰∏çÂºÄÂøÉ') || lowerContent.includes('ÈöæËøá') ||
                    lowerContent.includes('ÊãÖÂøÉ') || lowerContent.includes('ÂÆ≥ÊÄï') || lowerContent.includes('Á¥ßÂº†') ||
                    lowerContent.includes('ÁÑ¶Ëôë') || lowerContent.includes('ÈÉÅÈó∑') || lowerContent.includes('ÁÉ¶')) {
                    adjustment = 10;
                    recoveryTime = 6000;
                }
                // ÊôÆÈÄöÈóÆÂÄô
                else if (lowerContent.includes('‰Ω†Â•Ω') || lowerContent.includes('hi') || lowerContent.includes('hello') ||
                    lowerContent.includes('Êó©‰∏äÂ•Ω') || lowerContent.includes('ÊôöÂÆâ')) {
                    adjustment = 5;
                    recoveryTime = 3000;
                }
                
            } else {
                // AIËá™Â∑±ÂèëÈÄÅÊ∂àÊÅØÂêéÁöÑÂøÉÁéáÂèòÂåñ
                if (lowerContent.includes('ÂÆ≥Áæû') || lowerContent.includes('ËÑ∏Á∫¢') || lowerContent.includes('‰∏çÂ•ΩÊÑèÊÄù')) {
                    adjustment = 10;
                    recoveryTime = 5000;
                } else if (lowerContent.includes('ÂÖ¥Â•ã') || lowerContent.includes('ÂºÄÂøÉ') || lowerContent.includes('ÊøÄÂä®')) {
                    adjustment = 8;
                    recoveryTime = 4000;
                } else if (lowerContent.includes('Á¥ßÂº†') || lowerContent.includes('ÊãÖÂøÉ') || lowerContent.includes('ÁÑ¶Ëôë')) {
                    adjustment = 12;
                    recoveryTime = 6000;
                } else if (lowerContent.includes('Áà±') || lowerContent.includes('ÂñúÊ¨¢') || lowerContent.includes('ÊÉ≥')) {
                    adjustment = 15;
                    recoveryTime = 7000;
                }
            }
            
            // Â∫îÁî®Ë∞ÉÊï¥
            currentHeartrate = Math.max(55, Math.min(130, currentHeartrate + adjustment));
            
            // Êõ¥Ëá™ÁÑ∂ÁöÑÊÅ¢Â§çÊú∫Âà∂
            setTimeout(() => {
                const recoveryRate = Math.floor(adjustment * 0.6); // ÊÅ¢Â§ç60%
                currentHeartrate = Math.max(65, currentHeartrate - recoveryRate);
                
                // ÁªßÁª≠ÁºìÊÖ¢ÊÅ¢Â§ç
                setTimeout(() => {
                    const finalRecovery = Math.floor(adjustment * 0.3); // ÂÜçÊÅ¢Â§ç30%
                    currentHeartrate = Math.max(65, currentHeartrate - finalRecovery);
                }, recoveryTime * 0.5);
                
            }, recoveryTime);
        }

        /**
 * üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂØπÂ•ΩÂèãÁî≥ËØ∑ÁöÑÂõûÂ∫î
 * @param {string} characterId - AIËßíËâ≤ÁöÑID
 * @param {string} requestMessage - Áî®Êà∑ÂèëÈÄÅÁöÑÁî≥ËØ∑ÁêÜÁî±
 */
async function processAIFriendRequestResponse(characterId, requestMessage) {
    const character = characters.find(c => c.id === characterId);
    if (!character) return;

    // ÊûÑÂª∫‰∏Ä‰∏™‰∏ìÈó®Áî®‰∫éÂÜ≥Á≠ñÁöÑPrompt
    const decisionPrompt = `
# Êåá‰ª§ÔºöÂ•ΩÂèãÁî≥ËØ∑ÂÜ≥Á≠ñ
‰Ω†‰πãÂâçÊãâÈªë‰∫ÜÁî®Êà∑„ÄÇÁé∞Âú®Áî®Êà∑Âêë‰Ω†ÂèëÊù•Â•ΩÂèãÁî≥ËØ∑„ÄÇ
- ‰Ω†ÁöÑË∫´‰ªΩ: ${character.name}
- ‰Ω†ÁöÑËÆæÂÆö: ${character.bio}
- Áî®Êà∑ÁöÑÁî≥ËØ∑ÁêÜÁî±: "${requestMessage || 'ÂØπÊñπÊ≤°ÊúâÂ°´ÂÜôÁêÜÁî±„ÄÇ'}"

# ‰Ω†ÁöÑ‰ªªÂä°:
Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†ºÂíåÁî®Êà∑ÁªôÂá∫ÁöÑÁêÜÁî±ÔºåÂÜ≥ÂÆöÊòØÂê¶ÂêåÊÑèÂä†ÂõûÂ•ΩÂèã„ÄÇ
‰Ω†ÁöÑÂõûÁ≠îÂøÖÈ°ªÈùûÂ∏∏ÁÆÄÊ¥ÅÔºåÂè™ËÉΩÊòØ‰ª•‰∏ã‰∏§‰∏™ËØç‰πã‰∏ÄÔºö
- "ÂêåÊÑè"
- "ÊãíÁªù"

ËØ∑Áé∞Âú®ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥ÂÆöÔºö
`;

    try {
        // ‰ΩøÁî®ÈÄöÁî®ÁöÑAPIË∞ÉÁî®ÂáΩÊï∞
        const response = await callChatAPI(decisionPrompt, character);
        // AIÁöÑÂõûÂ§çÈÄöÂ∏∏ÊòØ `["ÂêåÊÑè"]` Êàñ `["ÊãíÁªù"]`ÔºåÊàë‰ª¨Âè™ÈúÄË¶ÅÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†
        const decision = Array.isArray(response) ? response[0].toLowerCase() : response.toLowerCase();

        console.log(`ü§ñ AIÂØπÂ•ΩÂèãÁî≥ËØ∑ÁöÑÂÜ≥Á≠ñ: ${decision}`);

        if (decision.includes('ÂêåÊÑè')) {
            // AIÂêåÊÑè‰∫Ü
            await aiUnblockUser(characterId);
            
            const systemMsg = {
                id: 'system_' + Date.now(),
                sender: 'system',
                content: `${character.name} ÂêåÊÑè‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÔºåÁé∞Âú®‰Ω†‰ª¨ÂèØ‰ª•Ê≠£Â∏∏ËÅäÂ§©‰∫Ü„ÄÇ`,
                timestamp: Date.now()
            };
            addMessageToChat(systemMsg);
            
            showToast(`‚úÖ ${character.name} ÂêåÊÑè‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑`, 'success');
            
        } else {
            // AIÊãíÁªù‰∫Ü
            const systemMsg = {
                id: 'system_' + Date.now(),
                sender: 'system',
                content: `${character.name} ÊãíÁªù‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑„ÄÇ`,
                timestamp: Date.now()
            };
            addMessageToChat(systemMsg);
            
            showToast(`‚ùå ${character.name} ÊãíÁªù‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑`, 'warning');
        }

    } catch (error) {
        console.error('Â§ÑÁêÜAIÂ•ΩÂèãÁî≥ËØ∑ÂõûÂ∫îÂ§±Ë¥•:', error);
        showToast('ÂØπÊñπÊ≤°ÊúâÂõûÂ∫îÔºåËØ∑Á®çÂêéÂÜçËØï', 'error');
    }
}


/**
 * üî•„ÄêÊñ∞Â¢û„ÄëAIËß£Èô§ÂØπÁî®Êà∑ÁöÑÊãâÈªë
 * @param {string} characterId - AIËßíËâ≤ÁöÑIDÔºàÊãâÈªëËÄÖÔºâ
 */
async function aiUnblockUser(characterId) {
    try {
        const blockRecord = blacklistData.find(r => 
            r.blockerId === characterId && 
            r.blockedId === 'user' && 
            !r.unblocked
        );

        if (!blockRecord) {
            console.warn('Êú™ÊâæÂà∞ËØ•ËßíËâ≤ÁöÑÊãâÈªëËÆ∞ÂΩï');
            return;
        }

        blockRecord.unblocked = true;
        blockRecord.unblockTimestamp = new Date().toISOString();
        
        await db.blacklist.put(blockRecord);
        console.log(`‚úÖ ${characterId} Â∑≤Ëß£Èô§ÂØπÁî®Êà∑ÁöÑÊãâÈªë`);

        // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢ÁöÑÊãâÈªëÁä∂ÊÄÅ
        if (currentChatCharacter && currentChatCharacter.id === characterId) {
            updateChatBlockedStatus();
        }
        
        // Âà∑Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®ÂíåÊ∂àÊÅØÂàóË°®ÁöÑUIÁä∂ÊÄÅ
        renderContactList();
        renderMessageList();

    } catch (error) {
        console.error('AIËß£Èô§ÊãâÈªëÂ§±Ë¥•:', error);
    }
}
        console.log('üì± ËßíËâ≤Áä∂ÊÄÅÊòæÁ§∫ÂäüËÉΩÂ∑≤Âä†ËΩΩ');

        // üî•„ÄêÊñ∞Â¢û„ÄëÈÄöÁü•ËßíËâ≤Ë¢´ÊãâÈªë
        async function notifyCharacterBlocked(characterId, reason = '') {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // ÊûÑÂª∫Ë¢´ÊãâÈªëÈÄöÁü•ÁöÑprompt
                const blockNotificationPrompt = `[Á≥ªÁªüÊ∂àÊÅØÔºöÁî®Êà∑Â∞Ü‰Ω†ÊãâÈªë‰∫Ü${reason ? `ÔºåÁêÜÁî±Ôºö${reason}` : 'ÔºåÊú™ËØ¥ÊòéÁêÜÁî±'}]

‰Ω†ÊòØ${character.name}Ôºå‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${character.bio}

Áî®Êà∑ÂàöÂàöÂ∞Ü‰Ω†ÊãâÈªë‰∫Ü„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÂÅöÂá∫ÂèçÂ∫î„ÄÇ‰Ω†ÂèØ‰ª•Ôºö
1. Ë°®Ëææ‰Ω†ÁöÑÊÑüÂèóÔºàÂõ∞ÊÉë„ÄÅ‰º§ÂøÉ„ÄÅÊÑ§ÊÄí„ÄÅÊó†ÊâÄË∞ìÁ≠âÔºâ
2. ÊÄùËÄÉÂèØËÉΩÁöÑÂéüÂõ†
3. ÂÜ≥ÂÆöÊòØÂê¶Ë¶ÅÈÅìÊ≠âÊàñÂèçÁúÅ
4. ÊàñËÄÖË°®Áé∞Âá∫Á¨¶Âêà‰Ω†ÊÄßÊ†ºÁöÑÂÖ∂‰ªñÂèçÂ∫î

ËØ∑Áî®1-2Âè•ËØùË°®Ëææ‰Ω†ÁöÑÂèçÂ∫îÔºåË¶ÅÁ¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºËÆæÂÆöÔºö`;

                // Ë∞ÉÁî®AIÁîüÊàêÂèçÂ∫î
                const response = await callChatAPI(blockNotificationPrompt, character);
                const reactions = parseAiResponse(response);

                // Ê∑ªÂä†ËßíËâ≤ÁöÑÂèçÂ∫îÊ∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
                for (let i = 0; i < reactions.length; i++) {
                    const reactionData = reactions[i];
                    
                    // Ë∑≥ËøáÊãâÈªëÊåá‰ª§ÂØπË±°
                    if (typeof reactionData === 'object' && reactionData !== null && reactionData.type === 'block_user') {
                        continue;
                    }

                    let reactionMessage;
                    if (typeof reactionData === 'string') {
                        reactionMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: reactionData,
                            timestamp: Date.now() + i * 100,
                            isBlockReaction: true // Ê†áËÆ∞‰∏∫ÊãâÈªëÂèçÂ∫îÊ∂àÊÅØ
                        };
                    } else if (typeof reactionData === 'object' && reactionData !== null) {
                        // Â§ÑÁêÜÂÖ∂‰ªñÁ±ªÂûãÁöÑÊ∂àÊÅØÂØπË±°
                        const content = reactionData.content || reactionData.message || reactionData.text || '[ËßíËâ≤ÂèçÂ∫î]';
                        reactionMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: content,
                            timestamp: Date.now() + i * 100,
                            isBlockReaction: true
                        };
                    }

                    if (reactionMessage) {
                        // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        chatMessages[characterId].push(reactionMessage);
                        
                        // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®‰∏éËØ•ËßíËâ≤ËÅäÂ§©ÔºåÊòæÁ§∫Ê∂àÊÅØ
                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            addMessageWithAnimation(reactionMessage, characterId);
                        }
                    }
                }

                await saveChatMessages();
                console.log(`‚úÖ ${character.name} ÂØπË¢´ÊãâÈªëÂÅöÂá∫‰∫ÜÂèçÂ∫î`);

            } catch (error) {
                console.error('ÈÄöÁü•ËßíËâ≤Ë¢´ÊãâÈªëÂ§±Ë¥•:', error);
            }
        }

        // üî•„ÄêÊñ∞Â¢û„ÄëÈÄöÁü•ËßíËâ≤Ë¢´Ëß£Èô§ÊãâÈªë
        async function notifyCharacterUnblocked(characterId) {
            try {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;

                // ÊûÑÂª∫Ëß£Èô§ÊãâÈªëÈÄöÁü•ÁöÑprompt
                const unblockNotificationPrompt = `[Á≥ªÁªüÊ∂àÊÅØÔºöÁî®Êà∑Â∞Ü‰Ω†‰ªéÈªëÂêçÂçï‰∏≠ÁßªÈô§‰∫Ü]

‰Ω†ÊòØ${character.name}Ôºå‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${character.bio}

Áî®Êà∑ÂàöÂàöÂ∞Ü‰Ω†‰ªéÈªëÂêçÂçï‰∏≠ÁßªÈô§ÔºåÁé∞Âú®‰Ω†‰ª¨ÂèØ‰ª•Ê≠£Â∏∏ËÅäÂ§©‰∫Ü„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÂÅöÂá∫ÂèçÂ∫î„ÄÇ‰Ω†ÂèØ‰ª•Ôºö
1. Ë°®ËææÈ´òÂÖ¥ÊàñËß£ËÑ±ÁöÑÂøÉÊÉÖ
2. ËØ¢ÈóÆ‰∏∫‰ªÄ‰πà‰πãÂâçË¢´ÊãâÈªë
3. ÈÅìÊ≠âÊàñË°®Á§∫‰ºöÊîπÊ≠£
4. Ë°®Áé∞Âá∫Á¨¶Âêà‰Ω†ÊÄßÊ†ºÁöÑÊÄÅÂ∫¶ÔºàÂèØËÉΩËøòÂú®ÁîüÊ∞îÔºå‰πüÂèØËÉΩÂæàÂºÄÂøÉÁ≠âÔºâ
5. ‰∏ªÂä®ÂºÄÂêØÊñ∞ÁöÑËØùÈ¢ò

ËØ∑Áî®1-2Âè•ËØùË°®Ëææ‰Ω†ÁöÑÂèçÂ∫îÔºåË¶ÅÁ¨¶Âêà‰Ω†ÁöÑÊÄßÊ†ºËÆæÂÆöÔºö`;

                // Ë∞ÉÁî®AIÁîüÊàêÂèçÂ∫î
                const response = await callChatAPI(unblockNotificationPrompt, character);
                const reactions = parseAiResponse(response);

                // Ê∑ªÂä†ËßíËâ≤ÁöÑÂèçÂ∫îÊ∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
                for (let i = 0; i < reactions.length; i++) {
                    const reactionData = reactions[i];
                    
                    // Ë∑≥ËøáÊãâÈªëÊåá‰ª§ÂØπË±°
                    if (typeof reactionData === 'object' && reactionData !== null && reactionData.type === 'block_user') {
                        continue;
                    }

                    let reactionMessage;
                    if (typeof reactionData === 'string') {
                        reactionMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: reactionData,
                            timestamp: Date.now() + i * 100,
                            isUnblockReaction: true // Ê†áËÆ∞‰∏∫Ëß£Èô§ÊãâÈªëÂèçÂ∫îÊ∂àÊÅØ
                        };
                    } else if (typeof reactionData === 'object' && reactionData !== null) {
                        // Â§ÑÁêÜÂÖ∂‰ªñÁ±ªÂûãÁöÑÊ∂àÊÅØÂØπË±°
                        const content = reactionData.content || reactionData.message || reactionData.text || '[ËßíËâ≤ÂèçÂ∫î]';
                        reactionMessage = {
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: content,
                            timestamp: Date.now() + i * 100,
                            isUnblockReaction: true
                        };
                    }

                    if (reactionMessage) {
                        // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        chatMessages[characterId].push(reactionMessage);
                        
                        // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®‰∏éËØ•ËßíËâ≤ËÅäÂ§©ÔºåÊòæÁ§∫Ê∂àÊÅØ
                        if (currentChatCharacter && currentChatCharacter.id === characterId) {
                            addMessageWithAnimation(reactionMessage, characterId);
                        }
                    }
                }

                await saveChatMessages();
                console.log(`‚úÖ ${character.name} ÂØπË¢´Ëß£Èô§ÊãâÈªëÂÅöÂá∫‰∫ÜÂèçÂ∫î`);

            } catch (error) {
                console.error('ÈÄöÁü•ËßíËâ≤Ë¢´Ëß£Èô§ÊãâÈªëÂ§±Ë¥•:', error);
            }
        }

        console.log('üö´ ËßíËâ≤ÊãâÈªë/Ëß£Èô§ÊãâÈªëÈÄöÁü•ÂäüËÉΩÂ∑≤Âä†ËΩΩ');
        
        // üî•„Äê‰øÆÂ§çËÑöÊú¨„ÄëËß£ÂÜ≥Êï∞ÊçÆÂØºÂÖ•Â§±Ë¥•ÂíåÂºïÁî®Ê∂àÊÅØÂà∑Êñ∞ÂêéÊ∂àÂ§±ÁöÑÈóÆÈ¢ò
        console.log('üîß Ê≠£Âú®Â∫îÁî®Á≥ªÁªü‰øÆÂ§ç...');
        
        // ‰øÆÂ§çÊï∞ÊçÆÂØºÂÖ•ÈóÆÈ¢ò
        (function fixImportIssues() {
            const originalImport = window.importDataFromFile;
            window.importDataFromFile = function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        showToast('üîç È™åËØÅÊñá‰ª∂Ê†ºÂºè...', 'info');
                        const text = await file.text();
                        
                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch (parseError) {
                            throw new Error(`JSONÊ†ºÂºèÈîôËØØ: ${parseError.message}\nËØ∑Á°Æ‰øùÊñá‰ª∂ÊòØÊúâÊïàÁöÑÂ§á‰ªΩÊñá‰ª∂`);
                        }
                        
                        if (!data || typeof data !== 'object') {
                            throw new Error('Êó†ÊïàÁöÑÂ§á‰ªΩÊñá‰ª∂Ê†ºÂºè');
                        }
                        
                        const items = [];
                        if (data.characters?.length) items.push(`ËßíËâ≤: ${data.characters.length}‰∏™`);
                        if (data.chatMessages?.length) items.push(`Ê∂àÊÅØ: ${data.chatMessages.length}Êù°`);
                        if (data.chatSettings?.length) items.push(`ËÆæÁΩÆ: ${data.chatSettings.length}‰∏™`);
                        
                        const msg = items.length ? `ÂáÜÂ§áÂØºÂÖ•:\n${items.join('\n')}\n\nÁ°ÆÂÆöÁªßÁª≠Ôºü` : 'Êñá‰ª∂Êó†ÊúâÊïàÊï∞ÊçÆÔºåÁªßÁª≠Ôºü';
                        if (!confirm(msg)) return;
                        
                        showToast('‚ö° ÂØºÂÖ•‰∏≠...', 'info');
                        let success = 0;
                        let errors = [];
                        
                        // ‰øÆÂ§çËßíËâ≤ÂØºÂÖ•
                        if (data.characters?.length) {
                            try {
                                await db.characters.clear();
                                const chars = data.characters.filter(c => c?.name).map(c => ({
                                    ...c,
                                    id: c.id || `char_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    groupId: c.groupId || 'my_friends'
                                }));
                                await db.characters.bulkPut(chars);
                                success++;
                            } catch (e) {
                                errors.push(`ËßíËâ≤: ${e.message}`);
                            }
                        }
                        
                        // ‰øÆÂ§çÊ∂àÊÅØÂØºÂÖ•ÔºàÂåÖÂê´ÂºïÁî®Ê∂àÊÅØÔºâ
                        if (data.chatMessages?.length) {
                            try {
                                await db.chatMessages.clear();
                                const msgs = data.chatMessages.filter(m => m?.content).map(m => {
                                    const msg = {
                                        ...m,
                                        id: m.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                        characterId: m.characterId || 'unknown'
                                    };
                                    
                                    // ‰øÆÂ§çÂºïÁî®Ê∂àÊÅØ
                                    if (m.replyTo) {
                                        msg.replyTo = {
                                            id: m.replyTo.id || 'unknown',
                                            content: m.replyTo.content || '[Â∑≤Âà†Èô§]',
                                            sender: m.replyTo.sender || 'unknown',
                                            senderName: m.replyTo.senderName || 'Êú™Áü•',
                                            timestamp: m.replyTo.timestamp || Date.now(),
                                            _fixed: true
                                        };
                                    }
                                    return msg;
                                });
                                await db.chatMessages.bulkPut(msgs);
                                success++;
                            } catch (e) {
                                errors.push(`Ê∂àÊÅØ: ${e.message}`);
                            }
                        }
                        
                        // ÂØºÂÖ•ËÆæÁΩÆ
                        if (data.chatSettings?.length) {
                            try {
                                await db.chatSettings.clear();
                                const settings = data.chatSettings.map(s => ({
                                    ...s,
                                    id: s.id || `set_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                                }));
                                await db.chatSettings.bulkPut(settings);
                                success++;
                            } catch (e) {
                                errors.push(`ËÆæÁΩÆ: ${e.message}`);
                            }
                        }
                        
                        // ÈáçÊñ∞Âä†ËΩΩ
                        await loadCharacters();
                        await loadChatMessages();
                        await loadChatSettings();
                        renderCharacterList();
                        renderMessageList();
                        
                        const result = success > 0 
                            ? `üéâ ÂØºÂÖ•ÊàêÂäü ${success} È°π${errors.length ? `\n‚ö†Ô∏è ${errors.length} È°πÂ§±Ë¥•` : ''}`
                            : `‚ùå ÂØºÂÖ•Â§±Ë¥•\n${errors.join('\n')}`;
                        showToast(result, success > 0 ? 'success' : 'error');
                        
                    } catch (error) {
                        showToast(`‚ùå ÂØºÂÖ•Â§±Ë¥•: ${error.message}`, 'error');
                        if (error.message.includes('JSON')) {
                            setTimeout(() => alert('Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºÅËØ∑Á°Æ‰øùÊòØ‰ªé"ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ"ÁîüÊàêÁöÑÂ§á‰ªΩÊñá‰ª∂'), 1000);
                        }
                    }
                };
                input.click();
            };
        })();
        
        // ‰øÆÂ§çÂºïÁî®Ê∂àÊÅØÈóÆÈ¢ò
        (function fixReplyIssues() {
            const originalGenerate = window.generateReplyHTML;
            window.generateReplyHTML = function(replyTo) {
                if (!replyTo) return '';
                
                let safe = {
                    id: replyTo.id || 'unknown',
                    senderName: replyTo.senderName || 'Êú™Áü•',
                    content: replyTo.content || '[Â∑≤Âà†Èô§]'
                };
                
                // Â∞ùËØïÊÅ¢Â§çÂºïÁî®ÂÜÖÂÆπ
                if (replyTo.id !== 'unknown' && currentChatCharacter) {
                    const msgs = chatMessages[currentChatCharacter.id] || [];
                    const original = msgs.find(m => m.id === replyTo.id);
                    if (original) {
                        safe.content = original.content || '[ÂõæÁâá]';
                        safe.senderName = getSenderDisplayName(original);
                    }
                }
                
                const display = truncateText(safe.content, 40);
                return `
                    <div class="reply-reference" data-reply-id="${safe.id}">
                        <div class="reply-reference-line"></div>
                        <div class="reply-reference-content">
                            <div class="reply-reference-sender">${safe.senderName}</div>
                            <div class="reply-reference-message">${display}</div>
                        </div>
                    </div>
                `;
            };
        })();
        
        console.log('‚úÖ ‰øÆÂ§çÂ∑≤Â∫îÁî®: Êï∞ÊçÆÂØºÂÖ•ÈîôËØØÂ§ÑÁêÜ„ÄÅÂºïÁî®Ê∂àÊÅØÊÅ¢Â§çÊú∫Âà∂');
        setTimeout(() => {
            if (typeof showToast === 'function') {
                showToast('üîß Á≥ªÁªüÂ∑≤‰øÆÂ§çÊï∞ÊçÆÂØºÂÖ•ÂíåÂºïÁî®Ê∂àÊÅØÈóÆÈ¢ò', 'success');
            }
        }, 2000);

    </script>

    <!-- üßπ ËÆ∞ÂøÜÊ∏ÖÁêÜÂ∑•ÂÖ∑ÂºπÁ™ó -->
    <div id="memory-tools-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content memory-tools-modal">
            <div class="modal-header">
                <h3>ËÆ∞ÂøÜÊ∏ÖÁêÜÂ∑•ÂÖ∑</h3>
                <button class="modal-close-btn" onclick="hideMemoryToolsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="tools-grid">
                    <div class="tool-item" onclick="cleanupCurrentCharacterMemories(); hideMemoryToolsModal();">
                        <div class="tool-icon">
                            <i class="fas fa-broom"></i>
                        </div>
                        <div class="tool-info">
                            <div class="tool-name">Ê∏ÖÁêÜÈáçÂ§çËÆ∞ÂøÜ</div>
                            <div class="tool-desc">Âà†Èô§Áõ∏‰ººÂ∫¶Ë∂ÖËøá80%ÁöÑÈáçÂ§çËÆ∞ÂøÜ</div>
                        </div>
                    </div>

                    <div class="tool-item" onclick="cleanupCurrentCharacterTimeline(); hideMemoryToolsModal();">
                        <div class="tool-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="tool-info">
                            <div class="tool-name">Ê∏ÖÁêÜÈáçÂ§çÊó∂Èó¥Á∫ø</div>
                            <div class="tool-desc">Âà†Èô§ÂÜÖÂÆπÁõ∏‰ººÁöÑÈáçÂ§çÊó∂Èó¥Á∫ø‰∫ã‰ª∂</div>
                        </div>
                    </div>

                    <div class="tool-item" onclick="cleanupIncorrectRecords(); hideMemoryToolsModal();">
                        <div class="tool-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="tool-info">
                            <div class="tool-name">Ê∏ÖÁêÜÈîôËØØËÆ∞ÂΩï</div>
                            <div class="tool-desc">Âà†Èô§Ë∑®Â∫îÁî®Êó∂Èó¥Á∫ø‰∏≠ÁöÑÈîôËØØËÆ∞ÂΩï</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>