<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Chat Ê®°ÊãüÂô®</title>
    <style>
        /* ‰∏ªÈ¢òÁ≥ªÁªü - ÁÆÄÁ∫¶È£éÊ†º (ÈªòËÆ§) */
        :root {
            --theme-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --theme-font-weight: 400;
            --theme-line-height: 1.5;
            
            --theme-button-bg: rgba(74, 132, 193, 0.9);
            --theme-button-bg-hover: rgba(74, 132, 193, 1);
            --theme-button-color: white;
            --theme-button-border: none;
            --theme-button-radius: 20px;
            --theme-button-shadow: 0 2px 8px rgba(74, 132, 193, 0.3);
            
            --theme-button-secondary-bg: rgba(255, 255, 255, 0.8);
            --theme-button-secondary-bg-hover: rgba(255, 255, 255, 0.95);
            --theme-button-secondary-color: #555;
            --theme-button-secondary-border: rgba(0, 0, 0, 0.1);
            
            --theme-header-bg: rgba(247, 247, 247, 0.8);
            --theme-header-backdrop: blur(10px);
            
            --theme-form-bg: rgba(255, 255, 255, 0.8);
            --theme-input-border: rgba(0, 0, 0, 0.08);
            --theme-input-radius: 15px;
            --theme-input-focus: rgba(0, 123, 255, 0.5);
            --theme-input-focus-shadow: rgba(0, 123, 255, 0.1);
            
            --theme-avatar-bg-1: #f0f2f5;
            --theme-avatar-bg-2: #e8ebf0;
            --theme-avatar-text: #8b9dc3;
            --theme-avatar-border: rgba(255, 255, 255, 0.8);
            
            --theme-text-primary: #333;
            
            /* ÈªòËÆ§‰∏ªÈ¢òÁöÑËÉåÊôØËâ≤ */
            --body-bg: #1a1a1a;
            
            /* Èó¥Ë∑ùÁ≥ªÁªü */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 20px;
            --spacing-xl: 32px;
            
            /* Âä®ÁîªÁ≥ªÁªü */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            /* Èò¥ÂΩ±Á≥ªÁªü */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 15px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 8px 25px rgba(0, 0, 0, 0.15);
            --shadow-phone: 0 20px 40px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
            --shadow-special: 0 8px 30px rgba(0,0,0,0.3);
            --shadow-mixed: 0 12px 35px rgba(0, 0, 0, 0.2);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-neon-green: 0 0 10px rgba(0, 255, 136, 0.3);
            --shadow-neon-blue: 0 0 10px rgba(0, 212, 255, 0.4);
            --shadow-neon-green-small: 0 0 5px rgba(0, 255, 136, 0.2);
            --shadow-neon-green-large: 0 0 15px rgba(0, 255, 136, 0.4);
            --shadow-neon-green-8px: 0 0 8px rgba(0, 255, 136, 0.3);
            --shadow-neon-blue-8px: 0 0 8px rgba(0, 212, 255, 0.4);
            --shadow-form-mixed: 0 3px 8px rgba(0, 0, 0, 0.18);
            --shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-hover-alt: 0 6px 20px rgba(0, 0, 0, 0.15);
            --shadow-button: 0 2px 6px rgba(0, 0, 0, 0.08);
            
            /* ÊñáÂ≠óÈò¥ÂΩ± */
            --text-shadow-sm: 0 1px 3px rgba(0,0,0,0.5);
            --text-shadow-md: 0 3px 8px rgba(0,0,0,0.4);
            --text-shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            
            /* ÈÄöÁî®ËÉåÊôØËâ≤ */
            --bg-white-30: rgba(255, 255, 255, 0.3);
            --bg-white-50: rgba(255, 255, 255, 0.5);
            --bg-white-70: rgba(255, 255, 255, 0.7);
            --bg-white-80: rgba(255, 255, 255, 0.8);
            --bg-white-90: rgba(255, 255, 255, 0.9);
            --bg-white-95: rgba(255, 255, 255, 0.95);
            --bg-white-10: rgba(255, 255, 255, 0.1);
            --bg-white-15: rgba(255, 255, 255, 0.15);
            --bg-black-05: rgba(0, 0, 0, 0.05);
            --bg-black-08: rgba(0, 0, 0, 0.08);
            --bg-black-10: rgba(0, 0, 0, 0.1);
            --bg-black-15: rgba(0, 0, 0, 0.15);
            --bg-black-18: rgba(0, 0, 0, 0.18);
            --bg-black-20: rgba(0, 0, 0, 0.2);
            --bg-default-05: rgba(74, 132, 193, 0.05);
            --bg-default-10: rgba(74, 132, 193, 0.1);
            --bg-default-shadow: rgba(74, 132, 193, 0.2);
            
            /* ËæπÊ°ÜÈ¢úËâ≤ */
            --border-light: rgba(255, 255, 255, 0.3);
            --border-dark: rgba(0, 0, 0, 0.08);
            --border-white-15: rgba(255, 255, 255, 0.15);
            --border-white-20: rgba(255, 255, 255, 0.2);
            --border-black-05: rgba(0, 0, 0, 0.05);
            
            /* ÊñáÂ≠óÈ¢úËâ≤ */
            --text-white-70: rgba(255, 255, 255, 0.7);
            --text-black-50: rgba(0, 0, 0, 0.5);
            
            /* ÁâπÊÆäËÉåÊôØ */
            --bg-header-default: rgba(247, 247, 247, 0.75);
            --bg-form-light: rgba(255, 255, 255, 0.6);
            --bg-white-70: rgba(255, 255, 255, 0.7);
            --bg-black-50: rgba(0, 0, 0, 0.5);
            --bg-blue-05: rgba(0, 123, 255, 0.05);
            --bg-blue-10: rgba(0, 123, 255, 0.1);
            --bg-blue-20: rgba(0, 123, 255, 0.2);
            --bg-red-10: rgba(255, 59, 48, 0.1);
            --bg-red-20: rgba(255, 59, 48, 0.2);
            --bg-red-90: rgba(255, 59, 48, 0.9);
            --bg-white-100: rgba(255, 255, 255, 1);
            
            /* ÁâπÊÆäÈò¥ÂΩ± */
            --shadow-light-2: 0 2px 5px rgba(0, 0, 0, 0.1);
            --shadow-card-special: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-light-4: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-small: 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow-focus: 0 0 0 2px rgba(74, 132, 193, 0.2);
            --shadow-bottom: 0 -4px 20px rgba(0,0,0,0.15);
            --shadow-heavy: 0 4px 12px rgba(0, 0, 0, 0.3);
            
            /* ÁâπÊÆäËæπÊ°Ü */
            --border-black-10: rgba(0, 0, 0, 0.1);
            --border-black-60: rgba(0, 0, 0, 0.6);
            
            /* Â∏∏Áî®È¢úËâ≤ÂèòÈáè */
            --color-black: #000;
            --color-white: #fff;
            --color-green: #4cd964;
            --color-blue: #007AFF;
            --color-blue-light: #f0f8ff;
            --color-gray-light: #f0f0f0;
            --color-gray: #666;
            --color-gray-dark: #333;
            --color-gray-darker: #2c2c2c;
            --color-gray-medium: #999;
            --color-gray-border: #e0e0e0;
            --color-gray-bg: #f5f5f5;
            --color-gray-bg-light: #f8f8f8;
            --color-gray-bg-lighter: #fafafa;
            --color-border-light: #eee;
            --color-border-medium: #ddd;
            --color-border-gray: #ccc;
            --color-wechat-green: #07C160;
            --color-text-light: #888;
            --color-text-lighter: #aaa;
            --color-wallpaper: #a8d4a8;
            --color-neon-green: #00ff88;
            --color-neon-blue: #00d4ff;
            
            /* iOS Á≥ªÁªüÈ¢úËâ≤ */
            --color-ios-green: #34C759;
            --color-ios-purple: #5856D6;
            --color-ios-red: #FF2D55;
            --color-ios-gray: #8E8E93;
            
            /* Ê∏êÂèòËâ≤ */
            --gradient-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-gray: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --gradient-pink: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            
            /* Ê∞îÊ≥°È¢úËâ≤ÂèòÈáè */
            --ai-bubble-color: #f0f0f0;
            --my-bubble-color: #007AFF;
            
            /* Ê∞îÊ≥°Ê†∑ÂºèÁ≥ªÁªü */
            --bubble-glass-bg-ai: rgba(240, 240, 240, 0.7);
            --bubble-glass-bg-user: rgba(0, 122, 255, 0.8);
            --bubble-glass-border-ai: rgba(255, 255, 255, 0.4);
            --bubble-glass-border-user: rgba(255, 255, 255, 0.3);
            --bubble-neon-bg-ai: rgba(240, 240, 240, 0.9);
            --bubble-neon-bg-user: rgba(0, 122, 255, 0.9);
            
            /* ÊÇ¨ÊµÆÊåâÈíÆ */
            --floating-btn-bg: rgba(74, 132, 193, 0.35);
            --floating-btn-bg-hover: rgba(74, 132, 193, 0.55);
            --floating-btn-secondary-bg: rgba(255, 255, 255, 0.35);
            --floating-btn-secondary-bg-hover: rgba(255, 255, 255, 0.55);
            
            /* Ê∞îÊ≥°È¢ÑËßàÂíåÊºîÁ§∫ */
            --bubble-demo-bg: rgba(255, 255, 255, 0.8);
            --setting-card-bg: rgba(248, 249, 250, 0.8);
            --custom-input-bg: rgba(248, 249, 250, 0.8);
            --schedule-item-bg: rgba(255, 255, 255, 0.8);
            
                    /* Á∫∏Âº†Ê∞îÊ≥°ÁâπÊÆäÊïàÊûú */
        --paper-inset-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3);
        --paper-text-shadow: 0 0.5px 1px rgba(255, 255, 255, 0.3);
        --paper-border: 1px solid rgba(0, 0, 0, 0.08);
        
        /* ‰∏ªÈ¢òÂåñÊåâÈíÆËÉåÊôØ */
        --theme-button-bg-rgba: rgba(74, 132, 193, 0.9);
        --theme-button-secondary-bg-rgba: rgba(255, 255, 255, 0.8);
        
        /* ËæìÂÖ•Ê°ÜÂíåÊªëÂùó */
        --input-white-bg: rgba(255, 255, 255, 0.9);
        --slider-thumb-border: 2px solid rgba(255, 255, 255, 0.8);
        
        /* È¢ÑËßàÊ∞îÊ≥° */
        --preview-glass-ai: rgba(240, 240, 240, 0.7);
        --preview-glass-user: rgba(0, 122, 255, 0.8);
        --preview-glass-border: 1px solid rgba(255, 255, 255, 0.3);

        /* ÈÄöÁî®Â∑•ÂÖ∑Á±ª - ÊõøÊç¢Á°¨ÁºñÁ†ÅÊ†∑Âºè */
        .app-icon-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 18px;
        }
        
        .add-btn {
            position: absolute;
            right: 15px;
            top: 38px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: var(--color-gray-dark);
        }
        
        .hide {
            display: none;
        }
        
        .flex-row {
            display: flex;
            gap: 10px;
        }
        
        .flex-row-center {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .persona-add-btn {
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: var(--color-blue);
            background: rgba(0, 123, 255, 0.1);
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .worldbook-add-btn {
            position: absolute;
            right: 15px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: var(--color-gray-dark);
        }
        
        .save-btn-absolute {
            position: absolute;
            right: 15px;
            padding: 5px 10px;
            background: none;
            border: none;
            font-size: 16px;
            color: var(--color-gray-dark);
            cursor: pointer;
        }
        
        .textarea-large {
            height: 400px;
        }
        
        .padding-none {
            padding: 0;
        }
        
        .padding-none-flex {
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .overflow-auto {
            overflow-y: auto;
        }
        
        .poke-settings-visible {
            display: flex;
        }
        
        .chat-menu-btn {
            position: absolute;
            right: 15px;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--color-gray-dark);
        }
        
        .settings-icon-custom {
            background-color: #FF69B4;
        }
        
        .theme-preview-simple {
            background: linear-gradient(135deg, #f7f7f7, #e8e8e8);
        }
        
        .theme-preview-cute {
            background: linear-gradient(135deg, #ffe6f0, #ffb6c1);
        }
        
        .theme-preview-nature {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        }
        
        .theme-preview-tech {
            background: linear-gradient(135deg, #b3e5fc, #81d4fa);
        }
        
        .theme-preview-dream {
            background: linear-gradient(135deg, #e1bee7, #ce93d8);
        }
        
        .check-icon {
            color: #007AFF;
        }
        
        .settings-item-margin {
            margin-top: 20px;
        }
        
        .small-desc {
            color: #666;
            font-size: 12px;
            display: block;
            margin-top: 5px;
        }
        
        .api-form-flex {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .api-select-hidden {
            display: none;
            flex: 1;
        }
        
        .fetch-btn {
            display: none;
            padding: 8px 12px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .test-connection-btn {
            background-color: #34C759;
            margin-top: 10px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 2px var(--color-blue);
        }
        
        .color-red { background-color: #FF3B30; }
        .color-orange { background-color: #FF9500; }
        .color-yellow { background-color: #FFCC00; }
        .color-green { background-color: #34C759; }
        .color-light-blue { background-color: #5AC8FA; }
        .color-blue { background-color: #007AFF; }
        .color-purple { background-color: #5856D6; }
        .color-pink { background-color: #AF52DE; }
        .color-red-alt { background-color: #FF2D55; }
        
        .wallpaper-option {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .wallpaper-option:hover {
            transform: scale(1.05);
        }
        
        .wallpaper-option.selected {
            border-color: var(--color-blue);
        }
        
        .wallpaper-gradient1 {
            background-image: linear-gradient(135deg, #6e8efb, #a777e3);
        }
        
        .wallpaper-gradient2 {
            background-image: linear-gradient(135deg, #FF9A9E, #FAD0C4);
        }
        
        .wallpaper-gradient3 {
            background-image: linear-gradient(135deg, #A1C4FD, #C2E9FB);
        }
        
        .wallpaper-gradient4 {
            background-image: linear-gradient(135deg, #FFECD2, #FCB69F);
        }
        
        .upload-custom-item {
            margin-top: 15px;
        }
        
        .file-input-hidden {
            display: none;
        }
        
        .icon-user-blue {
            color: #007AFF;
        }
        
        .icon-users-green {
            color: #34C759;
        }
        
        .memory-checkbox {
            margin-right: 8px;
        }
        
        .memory-desc {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        .form-actions-flex {
            display: flex;
            gap: 10px;
        }
        
        .form-submit-flex {
            flex: 1;
        }
        
        .form-delete-red {
            background: #ff3b30;
            color: white;
            padding: 16px;
            border: none;
            border-radius: var(--theme-button-radius, 15px);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            display: none;
        }
        
        .danger-color {
            color: #ff3b30;
        }
        
        .danger-section-icon {
            color: var(--color-red-alt);
        }
        
        .danger-section-title {
            color: var(--color-red-alt);
        }
        
        /* Êõ¥Â§öÂ∑•ÂÖ∑Á±ª - ÁªßÁª≠ÊõøÊç¢Á°¨ÁºñÁ†Å */
        .checkbox-with-margin {
            margin-right: 8px;
        }
        
        .margin-top-20 {
            margin-top: 20px;
        }
        
        .margin-top-15 {
            margin-top: 15px;
        }
        
        .margin-top-10 {
            margin-top: 10px;
        }
        
        .margin-top-8 {
            margin-top: 8px;
        }
        
        .margin-top-5 {
            margin-top: 5px;
        }
        
        .flex-space-between {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .flex-gap-15 {
            display: flex;
            gap: 15px;
        }
        
        .flex-1 {
            flex: 1;
        }
        
        .flex-gap-15-mb-15 {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .flex-gap-15-mb-10 {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .width-100 {
            width: 100%;
        }
        
        .max-height-200-auto {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        .max-height-300-auto {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        .small-text {
            font-size: 13px;
            color: #666;
        }
        
        .tiny-text {
            font-size: 12px;
            color: #666;
        }
        
        .tiny-text-gray {
            font-size: 12px;
            color: #999;
        }
        
        .label-small {
            font-size: 13px;
            color: #666;
        }
        
        .delete-btn-red {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            margin-right: 5px;
        }
        
        .cancel-btn-blue {
            background: #007AFF;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .selection-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #007AFF;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .selection-checkbox.selected {
            background-color: #007AFF;
        }
        
        .check-icon-white {
            color: white;
            font-size: 12px;
        }
        
        .group-member-count {
            font-size: 12px;
            color: #666;
        }
        
        .italic-gray {
            color: #666;
            font-style: italic;
        }
        
        .text-center-gray {
            text-align: center;
            color: #666;
            padding: 40px;
        }
        
        .worldbook-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .worldbook-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .worldbook-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .avatar-group-green {
            background-color: #34C759;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* JavaScriptÂä®ÊÄÅÊ†∑ÂºèÁ±ª */
        .multiselect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #eee;
        }
        
        .contact-item.selected {
            background-color: #e3f2fd;
        }
        
        .empty-message {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .empty-chat-state {
            text-align: center;
            color: #999;
            padding: 50px 20px;
            font-size: 16px;
        }
        
        .character-info-flex {
            flex: 1;
        }
        
        .no-avatar {
            /* ÈöêËóèÂ§¥ÂÉèÊó∂ÁöÑÊ†∑ÂºèË∞ÉÊï¥ */
        }
        
        .message-container.no-avatar .message-avatar {
            display: none;
        }
        
        /* Êõ¥Â§öJavaScriptÂä®ÊÄÅÊ†∑ÂºèÁ±ª */
        .empty-worldbook {
            text-align: center;
            color: #666;
            padding: 40px;
        }
        
        .empty-playlist {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .empty-personas {
            text-align: center;
            color: #666;
            padding: 40px;
        }
        
        .empty-mount-chats {
            color: #666;
            text-align: center;
            padding: 20px;
        }
        
        .song-title {
            font-weight: 500;
        }
        
        .song-artist {
            font-size: 12px;
            color: #666;
        }
        
        .song-duration {
            font-size: 12px;
            color: #999;
        }
        
        .remove-character-btn {
            background: none;
            border: none;
            color: #ff3b30;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .mount-checkbox {
            margin-right: 10px;
        }
        
        .mount-avatar-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .mount-name {
            font-weight: 500;
        }
        
        .mount-type {
            font-size: 12px;
            color: #666;
        }
        
        .worldbook-checkbox {
            margin-right: 12px;
            margin-top: 2px;
        }
        
        .worldbook-content-flex {
            flex: 1;
        }
        
        .worldbook-title-text {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            color: #333;
        }
        
        .worldbook-desc-text {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 6px;
        }
        
        .worldbook-date-text {
            font-size: 11px;
            color: #999;
        }
        
        .identity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f0f2f5, #e8ebf0);
            margin-right: 12px;
        }
        
        .identity-content-flex {
            flex: 1;
        }
        
        .identity-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 3px;
        }
        
        .identity-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.3;
        }
        
        .identity-check-icon {
            color: var(--theme-button-bg, #4a84c1);
            margin-left: 8px;
        }
        
        .delete-worldbook-btn {
            background: none;
            border: none;
            color: #ff3b30;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
        
        .mount-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .mount-avatar-group {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #34C759;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .empty-emoji-grid {
            text-align: center;
            color: #666;
            padding: 20px;
            grid-column: 1 / -1;
        }
        
        .worldbook-mount-item {
            align-items: flex-start;
            padding: 12px;
            transition: background-color 0.2s;
        }
        
        .worldbook-mount-item:hover {
            background-color: #f8f9fa;
        }
        
        .identity-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            background-color: #f8f9fa;
        }
        
        .identity-item.selected {
            border-color: var(--theme-button-bg, #4a84c1);
            background-color: rgba(74, 132, 193, 0.1);
        }
        }

        /* ÂèØÁà±È£éÊ†º‰∏ªÈ¢ò */
        body[data-theme="cute"] {
            --theme-font-family: 'Varela Round', 'Quicksand', sans-serif;
            --theme-font-weight: 500;
            --theme-line-height: 1.6;
            
            --theme-button-bg: rgba(255, 182, 193, 0.9);
            --theme-button-bg-hover: rgba(255, 182, 193, 1);
            --theme-button-color: white;
            --theme-button-border: none;
            --theme-button-radius: 20px;
            --theme-button-shadow: 0 2px 8px rgba(255, 105, 180, 0.3);
            
            --theme-button-secondary-bg: rgba(255, 240, 245, 0.8);
            --theme-button-secondary-bg-hover: rgba(255, 240, 245, 0.95);
            --theme-button-secondary-color: #d44d5c;
            --theme-button-secondary-border: rgba(255, 182, 193, 0.3);
            
            --theme-header-bg: rgba(255, 230, 240, 0.85);
            --theme-header-backdrop: blur(15px);
            
            --theme-form-bg: rgba(255, 249, 252, 0.8);
            --theme-input-border: rgba(255, 204, 213, 0.4);
            --theme-input-radius: 20px;
            --theme-input-focus: rgba(255, 182, 193, 0.6);
            --theme-input-focus-shadow: rgba(255, 182, 193, 0.1);
            
            --theme-avatar-bg-1: #ffe6f2;
            --theme-avatar-bg-2: #ffd6e8;
            --theme-avatar-text: #d44d5c;
            --theme-avatar-border: rgba(255, 255, 255, 0.9);
            
            --theme-text-primary: #d44d5c;
            
            /* ÂèØÁà±‰∏ªÈ¢òÁöÑËÉåÊôØËâ≤ */
            --body-bg: linear-gradient(135deg, #ffeef7, #ffe4f0);
            
            /* ÂèØÁà±‰∏ªÈ¢òÁöÑÊ∞îÊ≥°Ê†∑ÂºèÈáçÂÜô */
            --bubble-glass-bg-ai: rgba(255, 240, 245, 0.8);
            --bubble-glass-bg-user: rgba(255, 182, 193, 0.85);
            --bubble-glass-border-ai: rgba(255, 204, 213, 0.4);
            --bubble-glass-border-user: rgba(255, 182, 193, 0.3);
            --bubble-neon-bg-ai: rgba(255, 240, 245, 0.95);
            --bubble-neon-bg-user: rgba(255, 182, 193, 0.9);
            
            /* ÂèØÁà±‰∏ªÈ¢òÁöÑÊÇ¨ÊµÆÊåâÈíÆ */
            --floating-btn-bg: rgba(255, 182, 193, 0.35);
            --floating-btn-bg-hover: rgba(255, 182, 193, 0.55);
            
            /* ÂèØÁà±‰∏ªÈ¢òÁöÑÊåâÈíÆËÉåÊôØÈáçÂÜô */
            --theme-button-bg-rgba: rgba(255, 182, 193, 0.9);
            --theme-button-secondary-bg-rgba: rgba(255, 240, 245, 0.8);
            
            /* ÂèØÁà±‰∏ªÈ¢òÁöÑÈ¢ÑËßàÊ∞îÊ≥° */
            --preview-glass-ai: rgba(255, 240, 245, 0.8);
            --preview-glass-user: rgba(255, 182, 193, 0.85);
            --preview-glass-border: 1px solid rgba(255, 204, 213, 0.4);
        }

        /* ÁªøËâ≤Ëá™ÁÑ∂‰∏ªÈ¢ò */
        body[data-theme="nature"] {
            --theme-button-bg: rgba(76, 217, 100, 0.85);
            --theme-button-bg-hover: rgba(76, 217, 100, 1);
            --theme-button-color: white;
            --theme-button-border: none;
            --theme-button-radius: 15px;
            --theme-button-shadow: 0 4px 15px rgba(76, 217, 100, 0.3);
            
            --theme-button-secondary-bg: rgba(220, 245, 220, 0.8);
            --theme-button-secondary-bg-hover: rgba(220, 245, 220, 0.95);
            --theme-button-secondary-color: #2d7d32;
            --theme-button-secondary-border: rgba(76, 217, 100, 0.3);
            
            --theme-header-bg: rgba(200, 230, 201, 0.8);
            --theme-header-backdrop: blur(10px);
            
            --theme-form-bg: rgba(248, 255, 248, 0.8);
            --theme-input-border: rgba(76, 217, 100, 0.2);
            --theme-input-radius: 15px;
            --theme-input-focus: rgba(76, 217, 100, 0.5);
            --theme-input-focus-shadow: rgba(76, 217, 100, 0.1);
            
            --theme-avatar-bg-1: #e8f5e8;
            --theme-avatar-bg-2: #d4ead4;
            --theme-avatar-text: #2d7d32;
            --theme-avatar-border: rgba(255, 255, 255, 0.9);
            
            --theme-text-primary: #2d7d32;
            
            /* Ëá™ÁÑ∂‰∏ªÈ¢òÁöÑËÉåÊôØËâ≤ */
            --body-bg: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            
            /* Ëá™ÁÑ∂‰∏ªÈ¢òÁöÑÊ∞îÊ≥°Ê†∑ÂºèÈáçÂÜô */
            --bubble-glass-bg-ai: rgba(220, 245, 220, 0.8);
            --bubble-glass-bg-user: rgba(76, 217, 100, 0.8);
            --bubble-glass-border-ai: rgba(76, 217, 100, 0.2);
            --bubble-glass-border-user: rgba(76, 217, 100, 0.3);
            --bubble-neon-bg-ai: rgba(248, 255, 248, 0.9);
            --bubble-neon-bg-user: rgba(76, 217, 100, 0.9);
            
            /* Ëá™ÁÑ∂‰∏ªÈ¢òÁöÑÊÇ¨ÊµÆÊåâÈíÆ */
            --floating-btn-bg: rgba(76, 217, 100, 0.35);
            --floating-btn-bg-hover: rgba(76, 217, 100, 0.55);
            
            /* Ëá™ÁÑ∂‰∏ªÈ¢òÁöÑÊåâÈíÆËÉåÊôØÈáçÂÜô */
            --theme-button-bg-rgba: rgba(76, 217, 100, 0.85);
            --theme-button-secondary-bg-rgba: rgba(220, 245, 220, 0.8);
            
            /* Ëá™ÁÑ∂‰∏ªÈ¢òÁöÑÈ¢ÑËßàÊ∞îÊ≥° */
            --preview-glass-ai: rgba(220, 245, 220, 0.8);
            --preview-glass-user: rgba(76, 217, 100, 0.8);
            --preview-glass-border: 1px solid rgba(76, 217, 100, 0.3);
        }

        /* ËìùËâ≤ÁßëÊäÄ‰∏ªÈ¢ò */
        body[data-theme="tech"] {
            --theme-button-bg: rgba(0, 123, 255, 0.85);
            --theme-button-bg-hover: rgba(0, 123, 255, 1);
            --theme-button-color: white;
            --theme-button-border: none;
            --theme-button-radius: 12px;
            --theme-button-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            
            --theme-button-secondary-bg: rgba(230, 245, 255, 0.8);
            --theme-button-secondary-bg-hover: rgba(230, 245, 255, 0.95);
            --theme-button-secondary-color: #1976d2;
            --theme-button-secondary-border: rgba(0, 123, 255, 0.3);
            
            --theme-header-bg: rgba(179, 229, 252, 0.8);
            --theme-header-backdrop: blur(10px);
            
            --theme-form-bg: rgba(248, 252, 255, 0.8);
            --theme-input-border: rgba(0, 123, 255, 0.2);
            --theme-input-radius: 12px;
            --theme-input-focus: rgba(0, 123, 255, 0.5);
            --theme-input-focus-shadow: rgba(0, 123, 255, 0.1);
            
            --theme-avatar-bg-1: #e3f2fd;
            --theme-avatar-bg-2: #bbdefb;
            --theme-avatar-text: #1976d2;
            --theme-avatar-border: rgba(255, 255, 255, 0.9);
            
            --theme-text-primary: #1976d2;
            
            /* ÁßëÊäÄ‰∏ªÈ¢òÁöÑËÉåÊôØËâ≤ */
            --body-bg: linear-gradient(135deg, #e3f2fd, #bbdefb);
            
            /* ÁßëÊäÄ‰∏ªÈ¢òÁöÑÊ∞îÊ≥°Ê†∑ÂºèÈáçÂÜô */
            --bubble-glass-bg-ai: rgba(230, 245, 255, 0.8);
            --bubble-glass-bg-user: rgba(0, 123, 255, 0.8);
            --bubble-glass-border-ai: rgba(0, 123, 255, 0.2);
            --bubble-glass-border-user: rgba(0, 123, 255, 0.3);
            --bubble-neon-bg-ai: rgba(248, 252, 255, 0.9);
            --bubble-neon-bg-user: rgba(0, 123, 255, 0.9);
            
            /* ÁßëÊäÄ‰∏ªÈ¢òÁöÑÊÇ¨ÊµÆÊåâÈíÆ */
            --floating-btn-bg: rgba(0, 123, 255, 0.35);
            --floating-btn-bg-hover: rgba(0, 123, 255, 0.55);
            
            /* ÁßëÊäÄ‰∏ªÈ¢òÁöÑÊåâÈíÆËÉåÊôØÈáçÂÜô */
            --theme-button-bg-rgba: rgba(0, 123, 255, 0.85);
            --theme-button-secondary-bg-rgba: rgba(230, 245, 255, 0.8);
            
            /* ÁßëÊäÄ‰∏ªÈ¢òÁöÑÈ¢ÑËßàÊ∞îÊ≥° */
            --preview-glass-ai: rgba(230, 245, 255, 0.8);
            --preview-glass-user: rgba(0, 123, 255, 0.8);
            --preview-glass-border: 1px solid rgba(0, 123, 255, 0.3);
        }

        /* Á¥´Ëâ≤Ê¢¶Âπª‰∏ªÈ¢ò */
        body[data-theme="dream"] {
            --theme-button-bg: rgba(156, 39, 176, 0.85);
            --theme-button-bg-hover: rgba(156, 39, 176, 1);
            --theme-button-color: white;
            --theme-button-border: none;
            --theme-button-radius: 18px;
            --theme-button-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
            
            --theme-button-secondary-bg: rgba(240, 230, 245, 0.8);
            --theme-button-secondary-bg-hover: rgba(240, 230, 245, 0.95);
            --theme-button-secondary-color: #7b1fa2;
            --theme-button-secondary-border: rgba(156, 39, 176, 0.3);
            
            --theme-header-bg: rgba(225, 190, 231, 0.8);
            --theme-header-backdrop: blur(10px);
            
            --theme-form-bg: rgba(252, 248, 255, 0.8);
            --theme-input-border: rgba(156, 39, 176, 0.2);
            --theme-input-radius: 18px;
            --theme-input-focus: rgba(156, 39, 176, 0.5);
            --theme-input-focus-shadow: rgba(156, 39, 176, 0.1);
            
            --theme-avatar-bg-1: #f3e5f5;
            --theme-avatar-bg-2: #e1bee7;
            --theme-avatar-text: #7b1fa2;
            --theme-avatar-border: rgba(255, 255, 255, 0.9);
            
            --theme-text-primary: #7b1fa2;
            
            /* Ê¢¶Âπª‰∏ªÈ¢òÁöÑËÉåÊôØËâ≤ */
            --body-bg: linear-gradient(135deg, #f3e5f5, #e1bee7);
            
            /* Ê¢¶Âπª‰∏ªÈ¢òÁöÑÊ∞îÊ≥°Ê†∑ÂºèÈáçÂÜô */
            --bubble-glass-bg-ai: rgba(240, 230, 245, 0.8);
            --bubble-glass-bg-user: rgba(156, 39, 176, 0.8);
            --bubble-glass-border-ai: rgba(156, 39, 176, 0.2);
            --bubble-glass-border-user: rgba(156, 39, 176, 0.3);
            --bubble-neon-bg-ai: rgba(252, 248, 255, 0.9);
            --bubble-neon-bg-user: rgba(156, 39, 176, 0.9);
            
            /* Ê¢¶Âπª‰∏ªÈ¢òÁöÑÊÇ¨ÊµÆÊåâÈíÆ */
            --floating-btn-bg: rgba(156, 39, 176, 0.35);
            --floating-btn-bg-hover: rgba(156, 39, 176, 0.55);
            
            /* Ê¢¶Âπª‰∏ªÈ¢òÁöÑÊåâÈíÆËÉåÊôØÈáçÂÜô */
            --theme-button-bg-rgba: rgba(156, 39, 176, 0.85);
            --theme-button-secondary-bg-rgba: rgba(240, 230, 245, 0.8);
            
            /* Ê¢¶Âπª‰∏ªÈ¢òÁöÑÈ¢ÑËßàÊ∞îÊ≥° */
            --preview-glass-ai: rgba(240, 230, 245, 0.8);
            --preview-glass-user: rgba(156, 39, 176, 0.8);
            --preview-glass-border: 1px solid rgba(156, 39, 176, 0.3);
        }

        html { 
            height: 100%; 
            overflow: hidden; 
        }
        
        body { 
            height: 100vh; 
            overflow: hidden; 
            margin: 0; 
            padding: 0; 
            font-family: var(--theme-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif);
            font-weight: normal; 
            background: var(--body-bg, #1a1a1a); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            box-sizing: border-box; 
            transition: all 0.3s ease;
        }
        
        #phone-screen { 
            width: 360px; 
            height: 750px; 
            background-color: var(--color-black); 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            border-radius: 25px; 
            box-shadow: var(--shadow-phone); 
        }
        
        .wallpaper {
            width: 100%;
            height: 100%;
            background: var(--color-wallpaper);
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #status-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 6px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 10;
            font-size: 14px;
            box-sizing: border-box;
            pointer-events: none;
            background: transparent;
        }
        
        #status-bar-time {
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        #status-bar-time::after {
            content: "üêæ";
            margin-left: 4px;
            font-size: 12px;
        }
        
        .battery-container {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }
        
        .battery-icon {
            width: 20px;
            height: 10px;
            border: 1px solid white;
            border-radius: 4px;
            position: relative;
            padding: 1px;
        }
        
        .battery-icon::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 2px;
            width: 1.5px;
            height: 4px;
            background-color: white;
            border-radius: 0 1px 1px 0;
        }
        
        .battery-level {
            height: 100%;
            background-color: white;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .battery-container.charging .battery-level {
            background-color: var(--color-green);
            animation: charge-breath 2s infinite;
        }
        
        .battery-container { display: flex; align-items: center; gap: 4px; font-size: 14px; }
        
        .battery-container.charging .battery-text {
            color: var(--color-green);
        }
        
        @keyframes charge-breath {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        #clock-container {
            text-align: center;
            color: white;
            text-shadow: var(--text-shadow-md);
            margin-bottom: 20px;
            flex-shrink: 0;
            margin-top: 60px;
            padding-top: 20px;
        }
        
        #main-time {
            font-size: 80px;
            font-weight: 200;
        }
        
        #main-date {
            font-size: 18px;
            font-weight: 500;
        }
        

        
        #app-grid {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            padding: 20px;
            margin-top: 40px;
        }
        
        .app-row {
            display: flex;
            justify-content: center;
            gap: 25px;
            width: 100%;
        }
        
        .app {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: white;
            text-shadow: var(--text-shadow-sm);
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
        }
        
        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            background-color: var(--color-white);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            margin-bottom: 8px;
            box-shadow: var(--shadow-lg);
            transition: transform 0.2s ease;
            overflow: hidden;
        }
        
        .app:active .app-icon {
            transform: scale(0.9);
        }
        
        .app-icon i {
            font-size: 30px;
            color: var(--color-gray-dark);
        }
        
        .app .label {
            color: white;
        }
        
        /* Â∫îÁî®È°µÈù¢Ê†∑Âºè */
        .app-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: none;
            flex-direction: column;
            color: black;
        }
        
        /* Â∫îÁî®ÁïåÈù¢Áä∂ÊÄÅÊ†è */
        .app-status-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 6px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: black;
            z-index: 15;
            font-size: 14px;
            box-sizing: border-box;
            pointer-events: none;
            background: transparent;
        }
        
        .app-status-time {
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .app-status-time::after {
            content: "üêæ";
            margin-left: 4px;
            font-size: 12px;
        }
        
        .app-battery-container {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }
        
        .app-battery-icon {
            width: 20px;
            height: 10px;
            border: 1px solid black;
            border-radius: 4px;
            position: relative;
            padding: 1px;
        }
        
        .app-battery-icon::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 2px;
            width: 1.5px;
            height: 4px;
            background-color: black;
            border-radius: 0 1px 1px 0;
        }
        
        .app-battery-level {
            height: 100%;
            background-color: black;
            border-radius: 2px;
            transition: width 0.5s ease;
            width: 100%;
        }
        
        .app-battery-container.charging .app-battery-level {
            background-color: var(--color-green);
            animation: charge-breath 2s infinite;
        }
        
        .app-battery-container { display: flex; align-items: center; gap: 4px; font-size: 14px; }
        
        .app-battery-container.charging .battery-text {
            color: var(--color-green);
        }
        
        .app-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            padding-top: 45px;
            border-bottom: 1px solid #eee;
            background-color: var(--theme-header-bg);
            backdrop-filter: var(--theme-header-backdrop);
            -webkit-backdrop-filter: var(--theme-header-backdrop);
            margin-top: 0;
            position: relative;
            z-index: 10;
            transition: background-color 0.3s ease;
        }
        
        .app-title {
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            flex: 1;
            color: var(--color-black);
        }
        
        .back-button {
            position: absolute;
            left: 15px;
            padding: 5px 10px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--color-gray-dark);
            cursor: pointer;
            width: 30px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        /* ËÆæÁΩÆÂ∫îÁî®Ê†∑Âºè */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-icon {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background-color: var(--color-blue);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .settings-icon.wifi { background-color: var(--color-blue); }
        .settings-icon.display { background-color: var(--color-blue); }
        .settings-icon.wallpaper { background-color: var(--color-ios-green); }
        .settings-icon.datetime { background-color: var(--color-ios-purple); }
        .settings-icon.notification { background-color: var(--color-ios-red); }
        .settings-icon.about { background-color: var(--color-ios-gray); }
        
        .settings-toggle {
            position: relative;
            width: 50px;
            height: 30px;
        }
        
        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .settings-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-border-gray);
            transition: .4s;
            border-radius: 34px;
        }
        
        .settings-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .settings-slider {
            background-color: var(--color-ios-green);
        }
        
        input:checked + .settings-slider:before {
            transform: translateX(20px);
        }
        
        /* APIËÆæÁΩÆÁïåÈù¢ */
        .api-settings {
            padding: 15px;
        }
        
        .api-form-group {
            margin-bottom: 15px;
        }
        
        .api-form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .api-form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border-medium);
            border-radius: 5px;
        }
        
        .api-form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border-medium);
            border-radius: 5px;
        }
        
        .api-form-range {
            width: 100%;
        }
        
        .api-form-submit {
            background-color: var(--color-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Êó†Á∫øÂ±ÄÂüüÁΩëËÆæÁΩÆ */
        .wifi-settings {
            padding: 15px;
        }
        
        .wifi-network {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .wifi-network:last-child {
            border-bottom: none;
        }
        
        .wifi-network-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .wifi-icon {
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .wifi-strength {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .wifi-strength-bar {
            width: 3px;
            height: 10px;
            background-color: var(--color-border-gray);
            border-radius: 1px;
        }
        
        .wifi-strength-bar.active {
            background-color: var(--color-blue);
        }
        
        /* ‰∏ªÈ¢òÈÄâÊã©Âô®Ê†∑Âºè */
        .theme-option {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .theme-option:hover {
            background-color: var(--color-gray-bg);
        }
        
        .theme-option:last-child {
            border-bottom: none;
        }
        
        .theme-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        
        .theme-preview-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background: var(--bg-white-30);
            backdrop-filter: blur(5px);
        }
        
        .theme-preview-content {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            height: 25px;
            background: var(--bg-white-50);
            border-radius: 4px;
        }
        
        .theme-info {
            flex: 1;
        }
        
        .theme-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .theme-description {
            font-size: 13px;
            color: var(--color-gray);
        }
        
        /* ËÅäÂ§©ÂØπËØùÊ°Ü */
        .chat-dialog {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            padding-bottom: 65px; /* ‰∏∫ËæìÂÖ•Ê°ÜÁïôÂá∫Á©∫Èó¥ */
        }
        
        .message-container {
            display: flex;
            margin-bottom: 10px;
            align-items: flex-start;
            position: relative;
        }
        
        .message-container.received {
            justify-content: flex-start;
            padding-left: 5px;
        }
        
        .message-container.sent {
            justify-content: flex-end;
            padding-right: 5px;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--color-border-medium);
            margin-right: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            position: relative;
            font-size: 14px;
        }
        
        /* Áî®Êà∑Ê∂àÊÅØÁöÑÂ§¥ÂÉèËÆæÁΩÆÂ∑¶ËæπË∑ùËÄå‰∏çÊòØÂè≥ËæπË∑ù */
        .message-container.sent .message-avatar {
            margin-right: 0;
            margin-left: 6px;
        }
        
        .message-bubble {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 16px;
            position: relative;
            word-wrap: break-word;
            transition: all 0.2s ease;
        }
        
        /* ========== Ê∞îÊ≥°Ê†∑ÂºèÁ≥ªÁªü ========== */
        
        /* ÈªòËÆ§Ê†∑ÂºèÔºàÁªèÂÖ∏ÂúÜËßíÔºâ */
        .bubble-style-default .message-bubble {
            border-radius: 18px;
            box-shadow: var(--shadow-sm);
            border: none;
            transition: all 0.2s ease;
        }
        
        /* ÊØõÁéªÁíÉÊïàÊûú */
        .bubble-style-glass .message-bubble {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-xl), var(--shadow-md);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .bubble-style-glass .received .message-bubble {
            background: var(--bubble-glass-bg-ai);
            border: 1px solid var(--bubble-glass-border-ai);
        }
        
        .bubble-style-glass .sent .message-bubble {
            background: var(--bubble-glass-bg-user);
            border: 1px solid var(--bubble-glass-border-user);
        }
        
        .bubble-style-glass .message-bubble:hover {
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            transform: translateY(-1px);
            box-shadow: var(--shadow-mixed), var(--shadow-xl);
        }
        
        /* ÁªèÂÖ∏Èò¥ÂΩ±Ê†∑Âºè */
        .bubble-style-shadow .message-bubble {
            border-radius: 16px;
            box-shadow: 
                var(--shadow-lg),
                var(--shadow-md),
                var(--shadow-sm);
            border: none;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .bubble-style-shadow .message-bubble:hover {
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.18),
                var(--shadow-lg),
                var(--shadow-md);
            transform: translateY(-2px);
        }
        
        /* Â∏¶Â∞ñËßíÁöÑÁªèÂÖ∏Ê∞îÊ≥° */
        .bubble-style-tail .message-bubble {
            border-radius: 16px;
            position: relative;
            box-shadow: var(--shadow-md);
        }
        
        /* ËßíËâ≤Ê∂àÊÅØÁöÑÂ∞ñËßíÔºàÂ∑¶‰∏äËßíÔºâ - Âä®ÊÄÅÈ¢úËâ≤ÈÄöËøáJSËÆæÁΩÆ */
        .bubble-style-tail .received .message-bubble::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 8px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 8px 10px 0;
            border-color: transparent var(--ai-bubble-color, var(--color-gray-light)) transparent transparent;
        }
        
        /* Áî®Êà∑Ê∂àÊÅØÁöÑÂ∞ñËßíÔºàÂè≥‰∏äËßíÔºâ - Âä®ÊÄÅÈ¢úËâ≤ÈÄöËøáJSËÆæÁΩÆ */
        .bubble-style-tail .sent .message-bubble::before {
            content: '';
            position: absolute;
            right: -6px;
            top: 8px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 8px 0 0;
            border-color: var(--my-bubble-color, var(--color-blue)) transparent transparent transparent;
        }
        
        /* Ê∏êÂèòÊ∞îÊ≥°Ê†∑Âºè */
        .bubble-style-gradient .received .message-bubble {
            background: var(--gradient-gray);
            color: var(--color-gray-dark);
        }
        
        .bubble-style-gradient .sent .message-bubble {
            background: var(--gradient-blue);
            color: white;
        }
        
        .bubble-style-gradient .message-bubble {
            border-radius: 20px;
            box-shadow: var(--shadow-md);
        }
        
        /* ÊûÅÁÆÄÁ∫øÊù°Ê†∑Âºè */
        .bubble-style-minimal .message-bubble {
            border-radius: 12px;
            border: 1.5px solid var(--color-gray-border);
            box-shadow: none;
            background: transparent;
        }
        
        .bubble-style-minimal .received .message-bubble {
            background: var(--color-gray-bg-lighter);
            border-color: var(--color-gray-border);
            color: var(--color-gray-dark);
        }
        
        .bubble-style-minimal .sent .message-bubble {
            background: var(--color-blue-light);
            border-color: var(--color-blue);
            color: var(--color-blue);
        }
        
        /* ÈúìËôπÂèëÂÖâÊ†∑Âºè */
        .bubble-style-neon .message-bubble {
            border-radius: 15px;
            border: 1px solid;
            animation: neonPulse 2s ease-in-out infinite alternate;
        }
        
        .bubble-style-neon .received .message-bubble {
            background: var(--bubble-neon-bg-ai);
            border-color: var(--color-neon-green);
            box-shadow: var(--shadow-neon-green);
            color: var(--color-gray-dark);
        }
        
        .bubble-style-neon .sent .message-bubble {
            background: var(--bubble-neon-bg-user);
            border-color: var(--color-neon-blue);
            box-shadow: var(--shadow-neon-blue);
            color: white;
        }
        
        @keyframes neonPulse {
            from {
                box-shadow: var(--shadow-neon-green-small);
            }
            to {
                box-shadow: var(--shadow-neon-green-large);
            }
        }
        
        /* Á∫∏Âº†Âç°ÁâáÊ†∑Âºè */
        .bubble-style-paper .message-bubble {
            border-radius: 6px;
            box-shadow: 
                var(--shadow-md),
                var(--shadow-xl),
                var(--paper-inset-shadow);
            border: var(--paper-border);
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* Á∫∏Âº†Ë¥®ÊÑüËÉåÊôØÁ∫πÁêÜ */
        .bubble-style-paper .received .message-bubble {
            position: relative;
            color: #2c2c2c;
            text-shadow: var(--paper-text-shadow);
        }
        
        .bubble-style-paper .received .message-bubble::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 118, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(120, 119, 118, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(139, 134, 128, 0.03) 0%, transparent 50%);
            border-radius: 6px;
            pointer-events: none;
            z-index: 0;
        }
        
        .bubble-style-paper .message-bubble > * {
            position: relative;
            z-index: 2;
        }
        
        .bubble-style-paper .sent .message-bubble {
            position: relative;
            color: white;
            border-color: var(--border-white-15);
        }
        
        .bubble-style-paper .sent .message-bubble::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            border-radius: 6px;
            pointer-events: none;
            z-index: 0;
        }
        
        /* Á∫∏Âº†Ë§∂Áö±ÊïàÊûú */
        .bubble-style-paper .message-bubble::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(0, 0, 0, 0.02) 31%, rgba(0, 0, 0, 0.02) 32%, transparent 33%),
                linear-gradient(-45deg, transparent 30%, rgba(0, 0, 0, 0.02) 31%, rgba(0, 0, 0, 0.02) 32%, transparent 33%);
            border-radius: 6px;
            pointer-events: none;
            z-index: -1;
        }
        
        .bubble-style-paper .message-bubble:hover {
            transform: translateY(-1px) rotateX(1deg);
            box-shadow: 
                var(--shadow-lg),
                var(--shadow-xl),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
        
        /* ========== Ê∞îÊ≥°Ê†∑ÂºèÈÄâÊã©Âô®UI ========== */
        
        .bubble-style-section {
            margin-bottom: 25px;
        }
        
        .bubble-style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .bubble-style-option {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            text-align: center;
        }
        
        .bubble-style-option:hover {
            border-color: var(--theme-button-bg, #4a84c1);
            background: var(--bg-default-05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .bubble-style-option.selected {
            border-color: var(--theme-button-bg, #4a84c1);
            background: var(--bg-default-10);
            box-shadow: 0 4px 15px var(--bg-default-shadow);
        }
        
        .style-preview {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .preview-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            max-width: 80px;
            text-align: center;
            word-break: break-word;
        }
        
        .sent-preview {
            background: #007AFF;
            color: white;
            align-self: flex-end;
        }
        
        .received-preview {
            background: #f0f0f0;
            color: #333;
            align-self: flex-start;
        }
        
        /* È¢ÑËßàÊ∞îÊ≥°ÁâπÊÆäÊ†∑Âºè */
        .bubble-style-glass .preview-bubble {
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border: var(--preview-glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
        }
        
        .bubble-style-glass .sent-preview {
            background: var(--preview-glass-user);
        }
        
        .bubble-style-glass .received-preview {
            background: var(--preview-glass-ai);
        }
        
        .bubble-style-shadow .preview-bubble {
            box-shadow: var(--shadow-form-mixed), var(--shadow-sm);
            border-radius: 14px;
        }
        
        .bubble-style-tail .preview-bubble {
            position: relative;
        }
        
        .bubble-style-tail .sent-preview::before {
            content: '';
            position: absolute;
            right: -5px;
            top: 6px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 6px 0 0;
            border-color: var(--color-blue) transparent transparent transparent;
        }
        
        .bubble-style-tail .received-preview::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 6px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 6px 8px 0;
            border-color: transparent #f0f0f0 transparent transparent;
        }
        
        .bubble-style-gradient .sent-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bubble-style-gradient .received-preview {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        .bubble-style-minimal .preview-bubble {
            border: 1px solid #e0e0e0;
            background: transparent;
        }
        
        .bubble-style-minimal .sent-preview {
            background: #f0f8ff;
            border-color: var(--color-blue);
            color: var(--color-blue);
        }
        
        .bubble-style-minimal .received-preview {
            background: #fafafa;
            color: #333;
        }
        
        .bubble-style-neon .preview-bubble {
            border: 1px solid;
            box-shadow: var(--shadow-neon-green-8px);
        }
        
        .bubble-style-neon .sent-preview {
            border-color: var(--color-neon-blue);
            box-shadow: var(--shadow-neon-blue-8px);
        }
        
        .bubble-style-neon .received-preview {
            border-color: var(--color-neon-green);
            box-shadow: var(--shadow-neon-green-8px);
        }
        
        .bubble-style-paper .preview-bubble {
            box-shadow: 
                var(--shadow-sm),
                var(--shadow-md),
                var(--paper-inset-shadow);
            border: var(--paper-border);
            border-radius: 6px;
            position: relative;
        }
        
        .bubble-style-paper .sent-preview {
            background: var(--color-blue);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .bubble-style-paper .received-preview {
            background: var(--color-gray-light);
            color: var(--color-gray-darker);
            text-shadow: 0 0.5px 1px rgba(255, 255, 255, 0.3);
        }
        
        .style-name {
            font-size: 13px;
            font-weight: 600;
            color: #666;
        }
        
        .bubble-style-option.selected .style-name {
            color: var(--theme-button-bg, #4a84c1);
        }
        
        .received .message-bubble {
            background-color: var(--color-gray-light);
            margin-left: 4px;
        }
        
        .sent .message-bubble {
            background-color: var(--color-blue);
            color: white;
            margin-right: 4px;
        }
        
        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
        }
        
        .message-emoji {
            max-width: 120px;
            max-height: 120px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .message-emoji:hover {
            transform: scale(1.05);
        }
        
        /* ÁâπÊÆäÊ∂àÊÅØÁ±ªÂûãÊ†∑Âºè */
        .voice-message {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-white-10);
            border-radius: 18px;
            min-width: 100px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .voice-message:hover {
            background: var(--bg-white-15);
        }
        
        .voice-message i {
            font-size: 16px;
            margin-right: 8px;
            opacity: 0.8;
        }
        
        .voice-content {
            flex: 1;
            font-size: 14px;
        }
        
        .voice-duration {
            font-size: 12px;
            opacity: 0.7;
            margin-left: 8px;
        }
        
        .ai-image-container {
            max-width: 200px;
        }
        
        .ai-image-container .message-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .image-description {
            font-size: 12px;
            opacity: 0.8;
            padding: 5px 0;
            line-height: 1.3;
        }
        
        .transfer-message {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--gradient-pink);
            border-radius: 12px;
            min-width: 150px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .transfer-message:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }
        
        .transfer-message i {
            font-size: 20px;
            margin-right: 12px;
            background: var(--bg-white-30);
            padding: 8px;
            border-radius: 50%;
        }
        
        .transfer-content {
            flex: 1;
        }
        
        .transfer-amount {
            font-size: 18px;
            font-weight: bold;
            color: var(--color-gray-dark);
            margin-bottom: 2px;
        }
        
        .transfer-note {
            font-size: 12px;
            color: var(--color-gray);
        }
        
        /* Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫ */
        .typing-indicator {
            text-align: center;
            padding: 8px 20px;
            margin: 5px 0;
            color: var(--color-gray);
            font-size: 13px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .typing-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .typing-indicator .dots {
            display: inline-block;
        }
        
        .typing-indicator .dots::before {
            content: '...';
            font-size: 16px;
            color: var(--color-gray);
            animation: typing-dot 1.4s infinite ease-in-out;
        }
        
        .typing-indicator .dots::after {
            content: '';
        }
        
        .typing-indicator .dot3 {
            display: none;
        }
        
        @keyframes typing-dot {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
        }
        
        /* Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØÊåâÈíÆ */
        .load-more-messages {
            text-align: center;
            padding: 15px 20px;
            margin: 10px 20px;
            background: var(--bg-white-90);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-black-05);
            box-shadow: var(--shadow-md);
        }
        
        .load-more-messages:hover {
            background: var(--bg-white-95);
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }
        
        .load-more-content {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-gray);
            font-size: 14px;
            font-weight: 500;
        }
        
        .load-more-content i {
            margin-right: 8px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* Êó∂Èó¥Êà≥Ê†∑Âºè */
        .timestamp {
            color: var(--color-gray-medium);
            font-size: 11px;
            margin: 2px 0;
            line-height: 1.2;
        }
        
        .timestamp-center {
            text-align: center;
            padding: 8px 0;
            margin: 5px 20px;
        }
        
        .timestamp-bubble {
            position: absolute;
            bottom: 0px;
            right: -30px;
            font-size: 10px;
            color: #999;
            white-space: nowrap;
            z-index: 1;
            pointer-events: none;
        }
        
        .message-container.sent .timestamp-bubble {
            right: auto;
            left: -30px;
        }
        
        .timestamp-avatar {
            position: absolute;
            top: 36px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--color-gray-medium);
            white-space: nowrap;
            width: max-content;
        }

        .timestamp-inside {
            display: inline-block;
            margin-left: 6px;
            font-size: 9px;
            color: var(--text-white-70);
            white-space: nowrap;
            vertical-align: baseline;
            pointer-events: none;
            line-height: 1;
        }

        .message-container.received .timestamp-inside {
            color: var(--text-black-50);
        }

        /* ÈöêËóèÂ§¥ÂÉèÊó∂ÁöÑÊ†∑ÂºèË∞ÉÊï¥ */
        .message-container.no-avatar .message-bubble {
            margin-left: 0;
            margin-right: 0;
        }
        
        .message-container.no-avatar.sent .message-bubble {
            margin-left: 0;
        }
        
        .message-container.no-avatar.received .message-bubble {
            margin-right: 0;
        }
        
        .chat-input-area {
            display: flex;
            gap: 6px;
            padding: 8px 8px 10px 8px;
            background-color: var(--bg-header-default);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--color-gray-border);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            align-items: center;
            z-index: 100;
            box-sizing: border-box;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 18px;
            background-color: var(--color-white);
            font-size: 16px;
            resize: none;
            max-height: 100px;
            outline: none;
            box-shadow: var(--text-shadow-light);
            min-width: 0; /* Á°Æ‰øùÂú®Á©∫Èó¥‰∏çË∂≥Êó∂ËÉΩÁº©Â∞è */
        }
        
        .send-button {
            height: 40px;
            padding: 0 12px;
            border-radius: 20px;
            background-color: var(--theme-button-bg, rgb(74, 132, 193));
            color: var(--theme-button-color, white);
            display: flex;
            justify-content: center;
            align-items: center;
            border: var(--theme-button-border, none);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--theme-button-shadow, var(--shadow-md));
            transition: all 0.2s ease;
            border-radius: var(--theme-button-radius, 20px);
            flex-shrink: 0;
            min-width: 50px;
        }
        
        .send-button:hover {
            background-color: var(--theme-button-bg-hover, rgba(72, 125, 178, 0.95));
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }
        
        .chat-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--bg-white-80);
            color: var(--color-gray);
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
            font-size: 18px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--border-black-05);
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .chat-action-btn:hover {
            background-color: var(--bg-white-95);
            transform: scale(1.1);
        }
        
        /* ÂæÆ‰ø°ËÅäÂ§©ÁïåÈù¢ */
        #chat-screen {
            display: none;
            flex-direction: column;
        }
        
        .wechat-tabs {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--color-border-light);
            background-color: var(--color-gray-bg-light);
        }
        
        .wechat-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--color-text-light);
            font-size: 12px;
            cursor: pointer;
        }
        
        .wechat-tab.active {
            color: var(--color-wechat-green);
        }
        
        .wechat-tab i {
            font-size: 24px;
            margin-bottom: 3px;
        }
        
        /* Ê∂àÊÅØÂàóË°® */
        .message-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .message-item {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid var(--color-border-light);
            cursor: pointer;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-name {
            font-weight: bold;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .message-preview {
            color: var(--color-text-light);
            font-size: 14px;
        }
        
        .message-time {
            font-size: 12px;
            color: var(--color-text-lighter);
        }
        
        /* ÈÄöËÆØÂΩï */
        .contact-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .contact-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            padding: 5px 15px;
            background-color: var(--color-gray-bg);
            color: var(--color-text-light);
            font-size: 14px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--color-border-light);
            cursor: pointer;
        }
        
        .contact-info {
            flex: 1;
            margin-left: 10px;
            overflow: hidden;
        }
        
        .character-preview {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: calc(100vw - 140px);
        }
        
        /* ÊúãÂèãÂúà */
        .moment-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .moment-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .moment-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .moment-name {
            font-weight: bold;
        }
        
        .moment-content {
            margin-bottom: 10px;
        }
        
        .moment-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .moment-image {
            aspect-ratio: 1;
            background-color: #eee;
        }
        
        .moment-actions {
            display: flex;
            justify-content: space-between;
            color: #888;
            font-size: 14px;
        }
        
        /* ‰∏™‰∫∫È°µÈù¢ */
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0;
            background-color: #f8f8f8;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .profile-id {
            color: #888;
            font-size: 14px;
        }
        
        .profile-menu {
            margin-top: 20px;
        }
        
        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .menu-item-left {
            display: flex;
            align-items: center;
        }
        
        .menu-icon {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            background-color: #07C160;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
        }
        
        /* ‰∫∫Áâ©Â∫îÁî® */
        .character-list {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 60px;
        }
        
        .character-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ddd;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .character-info {
            flex: 1;
        }
        
        .character-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .character-bio {
            color: #888;
            font-size: 14px;
        }
        
        .add-character-header {
            position: absolute;
            right: 15px;
            top: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #007AFF;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* ËßíËâ≤ÁºñËæëË°®Âçï */
        .character-form {
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            margin: 15px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-white-20);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--theme-text-primary, #333);
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));
            border-radius: var(--theme-input-radius, 15px);
            font-size: 16px;
            box-sizing: border-box;
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.8));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all var(--transition-normal, 0.3s ease);
            color: var(--theme-text-primary, #333);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--theme-input-focus, rgba(0, 123, 255, 0.5));
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.95));
            box-shadow: 0 0 0 3px var(--theme-input-focus-shadow, rgba(0, 123, 255, 0.1));
            transform: translateY(-1px);
        }
        
        .form-textarea {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));
            border-radius: var(--theme-input-radius, 15px);
            font-size: 16px;
            box-sizing: border-box;
            min-height: 120px;
            resize: vertical;
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.8));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all var(--transition-normal, 0.3s ease);
            color: var(--theme-text-primary, #333);
            font-family: var(--theme-font-family);
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: var(--theme-input-focus, rgba(0, 123, 255, 0.5));
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.95));
            box-shadow: 0 0 0 3px var(--theme-input-focus-shadow, rgba(0, 123, 255, 0.1));
            transform: translateY(-1px);
        }
        
        .form-submit {
            width: 100%;
            padding: 16px;
            background: var(--theme-button-bg, rgba(0, 123, 255, 0.9));
            color: var(--theme-button-color, white);
            border: var(--theme-button-border, none);
            border-radius: var(--theme-button-radius, 15px);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(0, 123, 255, 0.3));
            transition: all var(--transition-normal, 0.3s ease);
            letter-spacing: 0.5px;
        }
        
        .form-submit:hover {
            transform: translateY(-2px);
            box-shadow: var(--theme-button-shadow, 0 6px 20px rgba(0, 123, 255, 0.4));
            background: var(--theme-button-bg-hover, rgba(0, 123, 255, 1));
        }
        
        .form-submit:active {
            transform: translateY(0);
            box-shadow: var(--theme-button-shadow, 0 2px 10px rgba(0, 123, 255, 0.3));
        }
        
        .avatar-upload {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 18px;
            border: 1px solid var(--theme-input-border, rgba(0, 0, 0, 0.05));
            text-align: center;
        }
        
        .avatar-preview {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--theme-avatar-bg-1, #f0f2f5), var(--theme-avatar-bg-2, #e8ebf0));
            margin: 0 auto 15px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--theme-avatar-border, rgba(255, 255, 255, 0.8));
            transition: all var(--transition-normal, 0.3s ease);
        }
        
        .avatar-preview.has-image {
            background: none !important;
        }
        
        .avatar-preview.has-image .avatar-preview-text {
            display: none !important;
        }
        
        .avatar-preview:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-hover-alt);
        }
        
        .avatar-preview-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: 700;
            color: var(--theme-avatar-text, #8b9dc3);
        }
        
        .upload-button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8));
            border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1));
            border-radius: var(--theme-button-radius, 12px);
            cursor: pointer;
            color: var(--theme-button-secondary-color, #555);
            font-weight: 500;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all var(--transition-fast, 0.2s ease);
            box-shadow: 0 2px 8px var(--bg-black-05);
            text-align: center;
        }
        
        .upload-button:hover {
            background: var(--theme-button-secondary-bg-hover, rgba(255, 255, 255, 0.95));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .upload-button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-button);
        }
        
        /* ÂæÆÂçöÁïåÈù¢ */
        .weibo-post {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .weibo-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .weibo-user {
            flex: 1;
        }
        
        .weibo-name {
            font-weight: bold;
        }
        
        .weibo-time {
            color: #888;
            font-size: 12px;
        }
        
        .weibo-content {
            margin-bottom: 10px;
        }
        
        .weibo-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .weibo-image {
            aspect-ratio: 1;
            background-color: #eee;
        }
        
        .weibo-actions {
            display: flex;
            justify-content: space-around;
            color: #888;
        }
        
        .weibo-action {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Èü≥‰πêÂ∫îÁî®Ê†∑Âºè */
        .music-player {
            padding: 20px;
            text-align: center;
        }
        
        .now-playing {
            margin-bottom: 30px;
        }
        
        .album-cover {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: white;
            box-shadow: var(--shadow-special);
        }
        
        .song-info {
            margin-bottom: 20px;
        }
        
        .song-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .artist-name {
            font-size: 16px;
            color: #666;
        }
        
        .progress-container {
            margin-bottom: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .music-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        .control-btn.play-pause {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }
        
        .playlist-section, .character-listening {
            text-align: left;
            margin-bottom: 30px;
        }
        
        .section-header, .listening-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-header h3, .listening-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .add-music-btn, .invite-character-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background-color: #007AFF;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .playlist {
            background-color: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
            min-height: 100px;
        }
        
        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .playlist-item:last-child {
            border-bottom: none;
        }
        
        .playlist-item:hover {
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        
        .listening-characters {
            background-color: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
            min-height: 80px;
        }
        
        .character-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }
        
        .character-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .character-name {
            flex: 1;
        }
        
        .listening-status {
            font-size: 12px;
            color: #666;
        }
        
        /* Ë¥≠Áâ©ÁïåÈù¢ */
        .product-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
        }
        
        .product-item {
            background-color: #f9f9f9;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-light-2);
        }
        
        .product-image {
            width: 100%;
            aspect-ratio: 1;
            background-color: #eee;
        }
        
        .product-info {
            padding: 10px;
        }
        
        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .product-price {
            color: #FF2D55;
            font-weight: bold;
        }
        
        .product-seller {
            display: flex;
            align-items: center;
            margin-top: 5px;
            font-size: 12px;
            color: #888;
        }
        
        /* ÊµèËßàÂô®ÁïåÈù¢ */
        .browser-toolbar {
            display: flex;
            padding: 10px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
        }
        
        .browser-url-bar {
            flex: 1;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background-color: white;
        }
        
        .browser-content {
            border: none;
            width: 100%;
            height: 100%;
        }
        
        /* Áõ∏Êú∫ÁïåÈù¢ */
        .camera-view {
            flex: 1;
            background-color: #FFEEF2; /* Á≤âÁôΩËâ≤ËÉåÊôØ */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #888;
            font-size: 18px;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }
        
        .capture-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: white;
            border: 3px solid #ddd;
            cursor: pointer;
        }
        
        /* Áõ∏ÂÜåÁïåÈù¢ */
        .album-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
        }
        
        .album-item {
            aspect-ratio: 1;
            background-color: #FFEEF2; /* Á≤âÁôΩËâ≤ËÉåÊôØ */
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #333;
            word-break: break-word;
            overflow: hidden;
        }
        
        .album-item::after {
            content: attr(data-description);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            text-align: center;
        }
        
        .album-item::before {
            content: attr(data-time);
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            color: #666;
        }
        
        /* ÁÖßÁâáËØ¶ÊÉÖ */
        .photo-detail {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .photo-image {
            flex: 1;
            background-color: #FFEEF2; /* Á≤âÁôΩËâ≤ËÉåÊôØ */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .photo-description {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            text-align: center;
            font-size: 16px;
            color: #333;
            background-color: var(--bg-white-70);
            padding: 10px;
            border-radius: 5px;
        }
        
        .photo-info {
            padding: 15px;
            background-color: white;
            border-top: 1px solid #eee;
        }
        
        .photo-time, .photo-location {
            color: #888;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        /* Â£ÅÁ∫∏ËÆæÁΩÆ */
        .wallpaper-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
        }
        
        .wallpaper-option {
            aspect-ratio: 1;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .wallpaper-option.selected {
            border-color: #007AFF;
        }
        
        /* ÂõæÊ†áËÆæÁΩÆ */
        .icon-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
        }
        
        .icon-option {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background-color: #007AFF;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 30px;
            margin-bottom: 5px;
            background-size: cover;
            background-position: center;
        }
        

        
        /* È¢úËâ≤ÈÄâÊã©Âô® */
        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
        }
        
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .color-option.selected {
            border-color: #000;
        }
        
        /* ÈÄèÊòéÂ∫¶ÊªëÂùó */
        .opacity-slider {
            width: 100%;
            padding: 0 15px;
            margin-top: 10px;
        }
        
        /* Êñ∞Âª∫ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-black-50);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-weight: bold;
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-button {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        
        .modal-primary {
            background-color: #007AFF;
            color: white;
        }
        
        .modal-secondary {
            background-color: #eee;
        }
        
        /* Ê∂àÊÅØÊìç‰ΩúËèúÂçï */
        .message-menu {
            position: fixed;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow-card-special);
            z-index: 1000;
            overflow: hidden;
            min-width: 120px;
        }
        
        .message-menu-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.2s ease;
        }
        
        .message-menu-item:hover {
            background-color: #f5f5f5;
        }
        
        .message-menu-item:last-child {
            border-bottom: none;
        }
        
        .message-menu-item.danger {
            color: #ff3b30;
        }
        
        /* ÂÖ≥‰∫éÊàë‰ª¨È°µÈù¢ */
        .about-content {
            padding: 20px;
            text-align: center;
        }
        
        .about-title {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .about-version {
            color: #888;
            margin-bottom: 30px;
        }
        
        .about-author {
            margin-top: 30px;
            font-style: italic;
        }
        
        /* Èù¢ÂÖ∑Âå∫ÂüüÊ†∑Âºè */
        .persona-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 15px;
            background: var(--theme-header-bg);
            backdrop-filter: var(--theme-header-backdrop);
            border-bottom: 1px solid #eee;
        }
        
        .persona-title h2 {
            margin: 0;
            font-size: 20px;
            color: var(--theme-text-primary, #333);
            font-weight: 600;
        }
        
        .persona-title p {
            margin: 5px 0 0 0;
            font-size: 13px;
            color: #666;
        }
        
        .persona-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .persona-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }
        
        .persona-item:hover {
            background-color: #f5f5f5;
        }
        
        .persona-item.active {
            background-color: var(--bg-blue-05);
            border-left: 3px solid #007AFF;
        }
        
        .persona-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--theme-avatar-bg-1, #f0f2f5), var(--theme-avatar-bg-2, #e8ebf0));
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--theme-avatar-text, #8b9dc3);
            font-weight: bold;
            font-size: 18px;
            background-size: cover;
            background-position: center;
            border: 2px solid var(--theme-avatar-border, rgba(255, 255, 255, 0.8));
            flex-shrink: 0;
        }
        
        .persona-info {
            flex: 1;
            min-width: 0;
        }
        
        .persona-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--theme-text-primary, #333);
        }
        
        .persona-description {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .persona-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .persona-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .persona-edit-btn {
            background: var(--bg-blue-10);
            color: #007AFF;
        }
        
        .persona-edit-btn:hover {
            background: var(--bg-blue-20);
        }
        
        .persona-delete-btn {
            background: var(--bg-red-10);
            color: #FF3B30;
        }
        
        .persona-delete-btn:hover {
            background: var(--bg-red-20);
        }
        
        .current-persona {
            border-top: 1px solid #eee;
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.9));
            padding: 0;
        }
        
        .current-persona .menu-item {
            border-bottom: none;
            margin: 0;
        }
        
        .current-persona-name {
            font-weight: 500;
            color: #007AFF;
            font-size: 14px;
        }
        
        /* Â§öÈÄâÊ®°ÂºèÊ†∑Âºè */
        .contact-item.selected {
            background-color: rgba(0, 123, 255, 0.1);
            border-left: 3px solid #007AFF;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        
        /* ËÅäÂ§©ÈÄâÈ°πÊ†∑Âºè */
        .chat-option-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .chat-option-item:hover {
            background-color: #f5f5f5;
        }
        
        .chat-option-item:last-child {
            border-bottom: none;
        }
        
        .chat-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            font-size: 18px;
        }
        
        .chat-option-text {
            flex: 1;
        }
        
        .chat-option-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 3px;
        }
        
        .chat-option-desc {
            font-size: 13px;
            color: #666;
        }
        
        /* Áæ§ËÅäÊàêÂëòÈÄâÊã©Ê†∑Âºè */
        .group-member-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .group-member-item:hover {
            background-color: #f5f5f5;
        }
        
        .group-member-item.selected {
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .group-member-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #007AFF;
            border-radius: 3px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .group-member-checkbox.checked {
            background-color: #007AFF;
            color: white;
        }
        
        /* Êñ∞ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢Ê†∑Âºè */
        .settings-container {
            padding: 0;
            background-color: #f8f9fa;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            padding: 15px 20px 10px 20px;
            background-color: #f8f9fa;
        }
        
        .section-icon {
            font-size: 16px;
            color: var(--theme-button-bg, #4a84c1);
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .setting-card {
            background: white;
            border-radius: 12px;
            margin: 0 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-item:hover {
            background-color: #f8f9fa;
        }
        
        .setting-item.danger-item:hover {
            background-color: #fff5f5;
        }
        
        .setting-left {
            flex: 1;
            min-width: 0;
        }
        
        .setting-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .setting-label {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .setting-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        
        .setting-value {
            font-size: 14px;
            color: #666;
            margin-right: 5px;
        }
        
        .setting-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            min-width: 120px;
        }
        
        /* ÂºÄÂÖ≥ÊåâÈíÆÊ†∑Âºè */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--theme-button-bg, #4a84c1);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        /* ËÅäÂ§©Ê®°ÂºèÂàáÊç¢Ê†∑Âºè */
        .chat-mode-switch {
            display: flex;
            background: var(--bg-white-50);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--bg-black-10);
            border-radius: 12px;
            padding: 4px;
            margin: 12px 20px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .chat-mode-option {
            flex: 1;
            position: relative;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .chat-mode-option input[type="radio"] {
            display: none;
        }
        
        .chat-mode-option label {
            display: block;
            padding: 10px 16px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: transparent;
            color: rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }
        
                .chat-mode-option input[type="radio"]:checked + label {
            background: var(--bg-white-90);
            color: var(--theme-button-bg, #4a84c1);
            font-weight: 600;
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .chat-mode-option label:hover {
            background: var(--bg-white-50);
        }
        
        /* Á∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÊéßÂà∂ */
        .offline-length-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 20px;
            padding: 8px 12px;
            background: var(--theme-form-bg);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            border: 1px solid var(--bg-black-05);
            transition: all 0.3s ease;
        }
        
        .control-label, .control-unit {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .offline-length-control input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid var(--theme-input-border);
            border-radius: 6px;
            background: var(--bg-white-80);
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .offline-length-control input[type="number"]:focus {
            outline: none;
            border-color: var(--theme-button-bg, #4a84c1);
            box-shadow: 0 0 0 2px rgba(74, 132, 193, 0.2);
        }
        
        /* ÂêéÂè∞‰∫íÂä®ËØ¶ÁªÜËÆæÁΩÆ */
        .background-interaction-details {
            border-top: 1px solid #f5f5f5;
            margin-top: 0;
            padding-top: 0;
        }
        
        .background-interaction-details .setting-item {
            border-bottom: 1px solid #f8f8f8;
        }
        
        .background-interaction-details .setting-item:last-child {
            border-bottom: none;
        }
        
        /* ÂæÆÂçöËÆæÁΩÆËØ¶ÁªÜÈÄâÈ°π */
        .weibo-settings {
            border-top: 1px solid #f5f5f5;
            margin-top: 0;
            padding-top: 0;
        }
        
        /* ÂäüËÉΩËØ¥ÊòéÊ†∑Âºè */
        .setting-explanation {
            background: var(--setting-card-bg);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            margin: 12px 20px;
            padding: 12px 16px;
            border: 1px solid var(--bg-black-05);
        }
        
        .explanation-text {
            font-size: 12px;
            color: #555;
            line-height: 1.5;
        }
        
        .explanation-text strong {
            color: #333;
            font-weight: 600;
        }
        
        /* Â§¥ÂÉèËÆæÁΩÆÊ†∑Âºè */
        .avatar-setting-group {
            margin-bottom: 25px;
        }
        
        .avatar-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .avatar-preview-container .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f0f2f5, #e8ebf0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #999;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--theme-avatar-border);
            box-shadow: var(--shadow-lg);
        }
        
        /* ËÉåÊôØÈ¢ÑËßàÊ†∑Âºè */
        .background-preview-container {
            margin-bottom: 20px;
        }
        
        .background-preview {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }
        
        .preview-text {
            color: #999;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Â¢ûÂº∫ÁöÑÈ¢úËâ≤ÈÄâÊã©Âô®Ê†∑Âºè */
        .color-setting-group {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--theme-form-bg);
            border-radius: 12px;
            border: 1px solid var(--bg-black-05);
        }
        
        /* Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÊ†∑Âºè */
        .custom-emoji-panel {
            position: fixed;
            bottom: 60px;
            left: 8px;
            right: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding: 15px;
            display: none;
            z-index: 999;
            max-height: 300px;
            overflow-y: auto;
            max-width: 344px;
            margin: 0 auto;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .emoji-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .emoji-tab {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            color: #666;
            transition: all 0.2s ease;
        }
        
        .emoji-tab.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .custom-emoji-item {
            aspect-ratio: 1;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .custom-emoji-item:hover {
            border-color: #007AFF;
            transform: scale(1.05);
        }
        
        .custom-emoji-item.placeholder {
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #999;
            border: 2px dashed #ddd;
        }
        
        .custom-emoji-item.placeholder:hover {
            background: #eee;
            border-color: #007AFF;
        }
        
        .emoji-delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: rgba(255, 59, 48, 0.9);
            color: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .custom-emoji-item:hover .emoji-delete-btn {
            display: flex;
        }
        
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .color-input {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .color-preview {
            width: 100px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .opacity-setting {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .opacity-setting label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .opacity-setting input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .opacity-setting input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--theme-button-bg, #4a84c1);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* Ê∞îÊ≥°È¢ÑËßàÊºîÁ§∫ */
        .bubble-preview-demo {
            margin-top: 20px;
            padding: 20px;
            background: var(--bubble-demo-bg);
            border-radius: 12px;
            border: 1px solid var(--bg-black-05);
        }
        
        .demo-message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .demo-message.my-message {
            justify-content: flex-end;
        }
        
        .demo-message.ai-message {
            justify-content: flex-start;
        }
        
        .demo-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπÊ†∑Âºè */
        .schedule-time-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: var(--schedule-item-bg);
            border-radius: 8px;
            border: 1px solid var(--bg-black-05);
        }
        
        .schedule-time-item input[type="time"] {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .schedule-time-item button {
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Á§æ‰∫§ËÆæÁΩÆËØ¶ÁªÜÈÄâÈ°π */
        .social-settings {
            border-top: 1px solid #f5f5f5;
            margin-top: 0;
            padding-top: 0;
        }
        
        /* ‰∏ªÈ¢òÂåñÊªëÂùóÊ†∑Âºè */
        .theme-range {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(var(--theme-button-bg-rgb, 74, 132, 193), 0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .theme-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--theme-button-bg, #4a84c1);
            cursor: pointer;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: var(--slider-thumb-border);
            transition: all 0.3s ease;
        }
        
        .theme-range::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .theme-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--theme-button-bg, #4a84c1);
            cursor: pointer;
            border: var(--slider-thumb-border);
            box-shadow: var(--shadow-md);
        }
        
        /* ËÆæÁΩÆËåÉÂõ¥ÂÆπÂô® */
        .setting-range-container {
            margin: 15px 20px;
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }
        
        /* Ëá™ÂÆö‰πâËæìÂÖ•ÂÆπÂô® */
        .custom-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 20px;
            padding: 12px 16px;
            background: var(--custom-input-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid var(--bg-black-05);
        }
        
        .input-label, .input-unit {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }
        
        .theme-input {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid var(--theme-input-border);
            border-radius: 8px;
            font-size: 13px;
            background: var(--input-white-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .theme-input:focus {
            outline: none;
            border-color: var(--theme-button-bg, #4a84c1);
            box-shadow: 0 0 0 2px rgba(var(--theme-button-bg-rgb, 74, 132, 193), 0.2);
            background: rgba(255, 255, 255, 1);
        }
        
        /* ‰∏ªÈ¢òÂåñÊåâÈíÆ */
        .theme-button {
            padding: 10px 20px;
            border-radius: var(--theme-button-radius, 8px);
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .theme-button-primary {
            background: var(--theme-button-bg-rgba);
            color: var(--theme-button-color, white);
            border: 1px solid var(--border-light);
        }
        
        .theme-button-primary:hover {
            background: var(--theme-button-bg-hover, rgba(74, 132, 193, 1));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
                .theme-button-secondary {
            background: var(--theme-button-secondary-bg-rgba);
            color: #666;
            border: 1px solid var(--bg-black-10);
        }

        .theme-button-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* CSSÂèòÈáèÊîØÊåÅ */
        :root {
            --theme-button-bg-rgb: 74, 132, 193;
        }
        
        body[data-theme="cute"] {
            --theme-button-bg-rgb: 255, 182, 193;
        }
        
        /* ÂèØÁà±‰∏ªÈ¢òÁöÑheaderÁâπÊÆäÊ†∑Âºè */
        body[data-theme="cute"] .app-header {
            border-bottom: 1px solid #ffccd5;
        }
        
        body[data-theme="nature"] {
            --theme-button-bg-rgb: 76, 217, 100;
        }
        
        body[data-theme="tech"] {
            --theme-button-bg-rgb: 0, 123, 255;
        }
        
        body[data-theme="dream"] {
            --theme-button-bg-rgb: 156, 39, 176;
        }
        
        /* Êà≥‰∏ÄÊà≥Á≥ªÁªüÊ∂àÊÅØÊ†∑Âºè */
        .poke-system-message {
            text-align: center;
            color: #999;
            font-size: 13px;
            padding: 6px 12px;
            margin: 4px auto;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            display: inline-block;
            max-width: 200px;
        }
        
        .poke-system-container {
            text-align: center;
            margin: 4px 0;
        }
        
        /* ÁßªÈô§ÈáçÂ§çÁöÑÈÄâ‰∏≠Ê†∑Âºè - Áé∞Âú®Âè™‰ΩøÁî®Â§¥ÂÉè‰∏äÁöÑÂãæÂè∑ */
        
        /* ÈÄâÊã©Ê®°Âºè‰∏ãÁöÑÊ∂àÊÅØÂÆπÂô®Ê†∑Âºè */
        .message-container.selected {
            /* ‰øùÊåÅÈÄâ‰∏≠Áä∂ÊÄÅÔºåÁî±ÂÖ∂‰ªñÊ†∑ÂºèÊéßÂà∂ÈÄâ‰∏≠ÊïàÊûú */
            background: none;
        }
        
        /* ‰∏ªÈ¢òÊ†∑ÂºèÂÆö‰πâÂú®ÂêéÈù¢Áªü‰∏ÄÂ§ÑÁêÜ */
        
        /* ÈÄâÊã©Ê®°ÂºèÊ†∑Âºè */
        #api-chat-screen .app-header .default-controls { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        #api-chat-screen .app-header .selection-controls { 
            display: none;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        #api-chat-screen.selection-mode .default-controls { 
            display: none !important; 
        }
        
        #api-chat-screen.selection-mode .selection-controls {
            display: flex !important;
            justify-content: center;
            align-items: center;
            width: 100%;
            gap: 8px;
        }
        
        /* Á°Æ‰øùÈÄâÊã©Ê®°Âºè‰∏çÊîπÂèòheaderÈ´òÂ∫¶Âíåpadding */
        #api-chat-screen.selection-mode .app-header {
            padding: 10px !important;
            padding-top: 45px !important;
            height: auto !important;
            box-sizing: border-box !important;
        }
        
        /* Á°Æ‰øùÊâÄÊúâÈÄâÊã©Ê®°ÂºèÁöÑÊåâÈíÆÈÉΩÊ≠£Á°ÆÂØπÈΩê */
        #api-chat-screen.selection-mode .back-button {
            left: 15px;
        }
        
        #selection-cancel-btn, #selection-delete-btn { 
            font-size: 13px; 
            cursor: pointer; 
            padding: 6px 12px; 
            transition: all 0.2s ease;
            border-radius: 16px;
            font-weight: 500;
            min-width: 50px;
            text-align: center;
            border: none;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }
        
        #selection-cancel-btn {
            color: #007AFF;
            background: rgba(0, 122, 255, 0.08);
            border: 1px solid rgba(0, 122, 255, 0.2);
        }
        
        #selection-delete-btn { 
            color: #FF3B30; 
            background: rgba(255, 59, 48, 0.08);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }
        
        #selection-count {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            padding: 0 8px;
            white-space: nowrap;
        }
        
        #selection-cancel-btn:hover {
            background: rgba(0, 122, 255, 0.12);
            box-shadow: 0 2px 6px rgba(0, 122, 255, 0.15);
        }
        
        #selection-delete-btn:hover {
            background: rgba(255, 59, 48, 0.12);
            box-shadow: 0 2px 6px rgba(255, 59, 48, 0.15);
        }
        
        #selection-cancel-btn:active,
        #selection-delete-btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        /* Ê∂àÊÅØÈÄâ‰∏≠Áä∂ÊÄÅÊ†∑Âºè */
        .message-container.selected .message-avatar::after { 
            content: '‚úî'; 
            position: absolute; 
            bottom: -5px; 
            right: -5px; 
            background-color: var(--theme-button-bg, #4a84c1); 
            color: white; 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: bold; 
            z-index: 10; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); 
        }
        
        .message-container.sent.selected .message-avatar::after { 
            bottom: -5px; 
            left: -5px; 
            right: auto;
        }
        
        /* ÂèØÁà±‰∏ªÈ¢ò‰∏ãÁöÑÈÄâ‰∏≠Ê†áËÆ∞ */
        body[data-theme="cute"] .message-container.selected .message-avatar::after {
            background-color: var(--theme-button-bg, #ffb6c1);
        }
        
        /* Ëá™ÁÑ∂‰∏ªÈ¢ò‰∏ãÁöÑÈÄâ‰∏≠Ê†áËÆ∞ */
        body[data-theme="nature"] .message-container.selected .message-avatar::after {
            background-color: var(--theme-button-bg, #4cd964);
        }
        
        /* ÁßëÊäÄ‰∏ªÈ¢ò‰∏ãÁöÑÈÄâ‰∏≠Ê†áËÆ∞ */
        body[data-theme="tech"] .message-container.selected .message-avatar::after {
            background-color: var(--theme-button-bg, #007bff);
        }
        
        /* Ê¢¶Âπª‰∏ªÈ¢ò‰∏ãÁöÑÈÄâ‰∏≠Ê†áËÆ∞ */
        body[data-theme="dream"] .message-container.selected .message-avatar::after {
            background-color: var(--theme-button-bg, #9c27b0);
        }
        
        /* ÁßªÈô§Ê∂àÊÅØÂÆπÂô®ÈÄâ‰∏≠Êó∂ÁöÑËÉåÊôØ */
        .message-container.selected {
            background: none !important;
        }

        /* ÈöêËóèÂ§¥ÂÉèÊó∂ÁöÑÈÄâ‰∏≠Ê†áËÆ∞ */
        .message-container.selected.no-avatar::before {
            content: '‚úî';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--theme-button-bg, #4a84c1);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .message-container.sent.selected.no-avatar::before {
            right: auto;
            left: -25px;
        }
        
        .poke-icon {
            margin-right: 8px;
            color: #ff69b4;
            animation: pokeWave 1s ease-in-out;
        }
        
        @keyframes pokeShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        @keyframes pokeWave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }
        
        /* Â§¥ÂÉèÊà≥‰∏ÄÊà≥ÊèêÁ§∫ */
        .message-avatar {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .message-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Êó∂Èó¥Êà≥ËÆæÁΩÆÊ†∑Âºè */
        .timestamp-position-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .radio-option:hover {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.05);
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 12px;
            margin-top: 2px;
            position: relative;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .radio-option input[type="radio"]:checked + .radio-custom {
            border-color: #007AFF;
            background-color: #007AFF;
        }

        .radio-option input[type="radio"]:checked + .radio-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }

        .option-content {
            flex: 1;
        }

        .option-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .option-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .radio-option input[type="radio"]:checked + .radio-custom + .option-content .option-label {
            color: #007AFF;
        }

        /* ÊÇ¨ÊµÆÊåâÈíÆÊ†∑Âºè */
        .floating-actions {
            position: absolute;
            right: 20px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .floating-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            position: relative;
            overflow: hidden;
        }

        .floating-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border-radius: 50%;
            z-index: -1;
        }

        .floating-btn:hover {
            transform: translateY(-2px) scale(1.08);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.18);
        }
        
        #regenerate-btn:hover {
            opacity: 0.65 !important;
        }
        
        #smart-reply-btn:hover {
            opacity: 0.65 !important;
        }

        .floating-btn:active {
            transform: translateY(0) scale(0.98);
            transition: all 0.15s ease;
        }

        /* ÈáçÊñ∞ÁîüÊàêÊåâÈíÆ */
        #regenerate-btn {
            background: var(--floating-btn-bg);
            color: var(--theme-button-color, white);
        }

        #regenerate-btn:hover {
            background: var(--floating-btn-bg-hover);
        }

        /* Êô∫ËÉΩÂõûÂ§çÊåâÈíÆ */
        #smart-reply-btn {
            background: var(--floating-btn-secondary-bg);
            color: var(--theme-button-secondary-color, #555);
            border: 1px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.05));
        }

        #smart-reply-btn:hover {
            background: var(--floating-btn-secondary-bg-hover);
        }

        /* ‰∏ªÈ¢òÁâπÂÆöÊÇ¨ÊµÆÊåâÈíÆÊ†∑ÂºèÁé∞Âú®ÈÄöËøáCSSÂèòÈáèÁªü‰∏ÄÁÆ°ÁêÜ */

        /* ÊåâÈíÆÂõæÊ†áÂä®Áîª */
        #regenerate-btn i {
            transition: transform 0.3s ease;
        }

        #regenerate-btn:hover i {
            transform: rotate(180deg);
        }

        #smart-reply-btn i {
            transition: transform 0.3s ease;
        }

        #smart-reply-btn:hover i {
            transform: scale(1.1);
        }

        /* ÊÇ¨ÊµÆÊåâÈíÆÂá∫Áé∞Âä®Áîª */
        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .floating-btn {
            animation: floatIn 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
            opacity: 0;
            transform: translateY(20px) scale(0.8);
        }

        .floating-btn:not(.hidden) {
            opacity: 0.4;
            transform: translateY(0) scale(1);
        }

        .floating-btn:nth-child(1) {
            animation-delay: 0.1s;
        }

        .floating-btn:nth-child(2) {
            animation-delay: 0.2s;
        }

        /* ÊÇ¨ÊµÆÊåâÈíÆÈöêËóèÁä∂ÊÄÅ */
        .floating-btn.hidden {
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            pointer-events: none;
        }

        /* Á≠âÂæÖÁä∂ÊÄÅÁöÑÁâπÊÆäÊ†∑Âºè */
        .floating-btn.waiting {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 0 4px rgba(255, 193, 7, 0.3);
        }

        /* ËÑâÂÜ≤Âä®Áîª */
        @keyframes pulse {
            0% {
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 0 0 var(--theme-button-secondary-border, rgba(0, 0, 0, 0.3));
            }
            50% {
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 0 8px rgba(0, 0, 0, 0);
            }
            100% {
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 0 0 rgba(0, 0, 0, 0);
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="phone-screen">
        <div class="wallpaper">
            <!-- Áä∂ÊÄÅÊ†è -->
            <div id="status-bar">
                <span id="status-bar-time">14:25</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">·∞î·©ö</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            
            <!-- Êó∂ÈíüÂÆπÂô® -->
            <div id="clock-container">
                <div id="main-time">14:25</div>
                <div id="main-date">12Êúà18Êó• ÊòüÊúü‰∏Ä</div>
            </div>
                
                <!-- Â∫îÁî®ÂõæÊ†á -->
                <div id="app-grid">
                    <div class="app-row">
                        <a href="#" class="app" onclick="showApp('chat-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" alt="Chat" class="app-icon-img">
                            </div>
                            <span>Chat</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('worldbook-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/Xqz3zPz7/IMG-3080.jpg" alt="‰∏ñÁïå‰π¶" class="app-icon-img">
                            </div>
                            <span>‰∏ñÁïå‰π¶</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('settings-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/764L3jpF/IMG-3079.jpg" alt="ËÆæÁΩÆ" class="app-icon-img">
                            </div>
                            <span>ËÆæÁΩÆ</span>
                        </a>
                    </div>
                    <div class="app-row">
                        <a href="#" class="app" onclick="showApp('album-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/DyS7X2SW/IMG-3081.jpg" alt="Áõ∏ÂÜå" class="app-icon-img">
                            </div>
                            <span>Áõ∏ÂÜå</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('music-screen')">
                            <div class="app-icon">
                                <i class="fas fa-music"></i>
                            </div>
                            <span>Èü≥‰πê</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('weibo-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/8cHffTcX/IMG-3064.jpg" alt="Á§æ‰∫§Âä®ÊÄÅ" class="app-icon-img">
                            </div>
                            <span>Á§æ‰∫§Âä®ÊÄÅ</span>
                        </a>
                    </div>
                </div>

                
                <!-- ÂæÆ‰ø°ÁïåÈù¢ -->
                <div id="chat-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('chat-screen')">‚Äπ</button>
                        <div class="app-title">üí¨</div>
                        <div class="chat-header-actions">
                            <div id="add-contact-btn" class="add-btn" onclick="showCharacterForm()">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div id="add-chat-btn" class="add-btn" onclick="showChatOptions()">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="app-content" id="wechat-content">
                        <!-- ÈªòËÆ§ÊòæÁ§∫Ê∂àÊÅØÂàóË°® -->
                        <div class="message-list" id="message-list">
                            <!-- Ê∂àÊÅØÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        
                        <!-- ÈÄöËÆØÂΩï -->
                        <div class="contact-list hide" id="contact-list">
                            <div class="contact-section">
        
                                <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>

                        </div>
                        

                        
                        <!-- Èù¢ÂÖ∑Âå∫Âüü -->
                        <div class="profile-page hide" id="profile-page">
                            <div class="persona-header">
                                <div class="persona-title">
                                    <h2>ÊàëÁöÑÈù¢ÂÖ∑</h2>
                                    <p>ÁÆ°ÁêÜ‰Ω†ÁöÑÂ§öÈáçË∫´‰ªΩËÆæÂÆö</p>
                                </div>
                                <div class="add-persona-btn persona-add-btn" onclick="showPersonaForm()">
                                    <i class="fas fa-plus"></i>
                                </div>
                            </div>
                            
                            <div class="persona-list" id="persona-list">
                                <!-- Èù¢ÂÖ∑ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            

                        </div>
                    </div>
                    
                    <div class="wechat-tabs">
                        <div class="wechat-tab active" onclick="switchWechatTab('message-list')" id="message-tab">
                            <i class="fas fa-comment-alt"></i>
                            <span>Ê∂àÊÅØ</span>
                        </div>
                        <div class="wechat-tab" onclick="switchWechatTab('contact-list')">
                            <i class="fas fa-address-book"></i>
                            <span>ËßíËâ≤</span>
                        </div>
                        <div class="wechat-tab" onclick="switchWechatTab('profile-page')">
                            <i class="fas fa-masks-theater"></i>
                            <span>Êàë</span>
                        </div>
                    </div>
                </div>
                
                <!-- ÂæÆÂçöÁïåÈù¢ -->
                <div id="weibo-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('weibo-screen')">‚Äπ</button>
                        <div class="app-title">Á§æ‰∫§Âä®ÊÄÅ</div>
                    </div>
                    <div class="app-content">
                        <div class="weibo-post">
                            <div class="weibo-header">
                                <div class="weibo-avatar"></div>
                                <div class="weibo-user">
                                    <div class="weibo-name">Âº†‰∏â</div>
                                    <div class="weibo-time">10ÂàÜÈíüÂâç</div>
                                </div>
                            </div>
                            <div class="weibo-content">
                                ‰ªäÂ§©Â§©Ê∞îÁúüÂ•ΩÔºåÂá∫ÂéªËµ∞Ëµ∞ÂøÉÊÉÖÈÉΩÂèòÂ•Ω‰∫ÜÔºÅ
                            </div>
                            <div class="weibo-images">
                                <div class="weibo-image"></div>
                            </div>
                            <div class="weibo-actions">
                                <div class="weibo-action">
                                    <i class="far fa-comment"></i>
                                    <span>ËØÑËÆ∫</span>
                                </div>
                                <div class="weibo-action">
                                    <i class="fas fa-retweet"></i>
                                    <span>ËΩ¨Âèë</span>
                                </div>
                                <div class="weibo-action">
                                    <i class="far fa-heart"></i>
                                    <span>ÁÇπËµû</span>   
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏ñÁïå‰π¶ÁïåÈù¢ -->
                <div id="worldbook-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('worldbook-screen')">‚Äπ</button>
                        <div class="app-title">‰∏ñÁïå‰π¶</div>
                        <div class="add-worldbook-btn worldbook-add-btn" onclick="showWorldbookForm()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="worldbook-list" id="worldbook-list">
                            <!-- ‰∏ñÁïå‰π¶ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏ñÁïå‰π¶ÁºñËæëË°®Âçï -->
                <div id="worldbook-form-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideWorldbookForm()">‚Äπ</button>
                        <div class="app-title" id="worldbook-form-title">Êñ∞Âª∫‰∏ñÁïå‰π¶</div>
                        <button class="save-worldbook-btn save-btn-absolute" onclick="saveWorldbook()">‰øùÂ≠ò</button>
                    </div>
                    <div class="app-content">
                        <div class="worldbook-form">
                            <div class="form-group">
                                <label class="form-label">Ê†áÈ¢ò</label>
                                <input type="text" class="form-input" id="worldbook-title" placeholder="ËæìÂÖ•‰∏ñÁïå‰π¶Ê†áÈ¢ò">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂÜÖÂÆπ</label>
                                <textarea class="form-textarea textarea-large" id="worldbook-content" placeholder="ËæìÂÖ•‰∏ñÁïå‰π¶ÂÜÖÂÆπ..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Èü≥‰πêÂ∫îÁî®ÁïåÈù¢ -->
                <div id="music-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('music-screen')">‚Äπ</button>
                        <div class="app-title">Èü≥‰πê</div>
                    </div>
                    <div class="app-content">
                        <div class="music-player">
                            <div class="now-playing">
                                <div class="album-cover" id="album-cover">
                                    <i class="fas fa-music"></i>
                                </div>
                                <div class="song-info">
                                    <div class="song-title" id="song-title">ÈÄâÊã©‰∏ÄÈ¶ñÊ≠åÊõ≤</div>
                                    <div class="artist-name" id="artist-name">Êú™Áü•Ëâ∫ÊúØÂÆ∂</div>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress" id="progress"></div>
                                </div>
                                <div class="time-info">
                                    <span id="current-time">0:00</span>
                                    <span id="total-time">0:00</span>
                                </div>
                            </div>
                            
                            <div class="music-controls">
                                <button class="control-btn" onclick="previousSong()">
                                    <i class="fas fa-step-backward"></i>
                                </button>
                                <button class="control-btn play-pause" id="play-pause-btn" onclick="togglePlayPause()">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="control-btn" onclick="nextSong()">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                            </div>
                            
                            <div class="playlist-section">
                                <div class="section-header">
                                    <h3>Êí≠ÊîæÂàóË°®</h3>
                                    <button class="add-music-btn" onclick="addMusicToPlaylist()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="playlist" id="playlist">
                                    <!-- Êí≠ÊîæÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                            
                            <div class="character-listening">
                                <div class="listening-header">
                                    <h3>‰∏ÄËµ∑Âê¨Ê≠åÁöÑËßíËâ≤</h3>
                                    <button class="invite-character-btn" onclick="inviteCharacterToListen()">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                                <div class="listening-characters" id="listening-characters">
                                    <!-- Âê¨Ê≠åËßíËâ≤Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢ -->
                <div id="api-chat-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideChatSettings()">‚Äπ</button>
                        <div class="app-title">ËÅäÂ§©ËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content padding-none-flex overflow-auto">
                        <div class="settings-container">
                            
                            <!-- ËÅäÂ§©Á™óÂè£ËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-user-edit section-icon"></i>
                                    <span class="section-title">ËÅäÂ§©Á™óÂè£ËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showIdentitySelector()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊàëÁöÑË∫´‰ªΩÈÄâÊã©</div>
                                            <div class="setting-desc">ÈÄâÊã©Âú®Ê≠§ËÅäÂ§©‰∏≠‰ΩøÁî®ÁöÑË∫´‰ªΩÈù¢ÂÖ∑</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-chat-identity">Êú™ÈÄâÊã©</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showAvatarSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂèåÊñπÂ§¥ÂÉèËÆæÁΩÆ</div>
                                            <div class="setting-desc">ËÆæÁΩÆÂú®Ê≠§ËÅäÂ§©Á™óÂè£‰∏≠ÊòæÁ§∫ÁöÑÂ§¥ÂÉè</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showNicknameSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂèåÊñπÂ§áÊ≥®ËÆæÁΩÆ</div>
                                            <div class="setting-desc">ËÆæÁΩÆÂú®Ê≠§ËÅäÂ§©Á™óÂè£‰∏≠ÊòæÁ§∫ÁöÑÊòµÁß∞</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBackgroundSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ËÅäÂ§©ËÉåÊôØËÆæÁΩÆ</div>
                                            <div class="setting-desc">Ëá™ÂÆö‰πâËÅäÂ§©ÁïåÈù¢ÁöÑËÉåÊôØÂõæÁâá</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBubbleStyleSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ</div>
                                            <div class="setting-desc">ÈÄâÊã©Ê∞îÊ≥°Â§ñËßÇÊ†∑ÂºèÂíåÈ¢úËâ≤</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-bubble-style">ÈªòËÆ§Ê†∑Âºè</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Êà≥‰∏ÄÊà≥ÂäüËÉΩËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-hand-paper section-icon"></i>
                                    <span class="section-title">Êà≥‰∏ÄÊà≥ÂäüËÉΩ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂêØÁî®Êà≥‰∏ÄÊà≥</div>
                                            <div class="setting-desc">ÂÖÅËÆ∏ÂèëÈÄÅÊà≥‰∏ÄÊà≥Ê∂àÊÅØÔºåÂèåÊñπÂèØËá™ÂÆö‰πâÊà≥‰∏ÄÊà≥ÂêéÁºÄ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="poke-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item poke-settings poke-settings-visible" id="poke-suffix-settings" onclick="showPokeSuffixSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ</div>
                                            <div class="setting-desc">Ëá™ÂÆö‰πâÂèåÊñπÁöÑÊà≥‰∏ÄÊà≥Âä®‰ΩúÂêéÁºÄ</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-explanation">
                                        <div class="explanation-text">
                                            <strong>ÂäüËÉΩËØ¥ÊòéÔºö</strong><br>
                                            ‚Ä¢ ÁÇπÂáªÂØπÊñπÂ§¥ÂÉèÂç≥ÂèØÂèëÈÄÅÊà≥‰∏ÄÊà≥<br>
                                            ‚Ä¢ ‰Ω†ÂèØ‰ª•Ëá™ÂÆö‰πâÊà≥‰∏ÄÊà≥ÂêéÁºÄÔºåÂ¶Ç"ÁöÑÂ∞èËÑ∏Ëõã"„ÄÅ"ÁöÑÂ∞èÊâã"Á≠â<br>
                                            ‚Ä¢ ËßíËâ≤‰πü‰ºöÊ†πÊçÆÂøÉÊÉÖÂíåËÅäÂ§©ÂÜÖÂÆπËá™‰∏ª‰øÆÊîπËá™Â∑±ÁöÑÊà≥‰∏ÄÊà≥ÂêéÁºÄ
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ËÆ∞ÂøÜËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-brain section-icon"></i>
                                    <span class="section-title">ËÆ∞ÂøÜËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showHistorySettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÈôÑÂ∏¶ÂéÜÂè≤Ê∂àÊÅØÊï∞</div>
                                            <div class="setting-desc">Ëá™ÂÆö‰πâËßíËâ≤ÂõûÂ§çÊó∂ÂèÇËÄÉÁöÑÂéÜÂè≤ÂØπËØùÊï∞Èáè</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-history-count">5ÂõûÂêà</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showMemoryMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊåÇËΩΩÂÖ∂‰ªñËÅäÂ§©ËÆ∞ÂøÜ</div>
                                            <div class="setting-desc">ËÆ©ËßíËâ≤ÂèÇËÄÉÂÖ∂‰ªñËÅäÂ§©Á™óÂè£ÁöÑÂØπËØùËÆ∞ÂøÜ</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-memory-mount">Â∑≤ÂÖ≥Èó≠</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showWorldbookMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊåÇËΩΩ‰∏ñÁïå‰π¶</div>
                                            <div class="setting-desc">ËÆ©ËßíËâ≤ÂèÇËÄÉÈÄâÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØÁü•ËØÜ</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-worldbook-mount">Êú™ÊåÇËΩΩ</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Êó∂Èó¥ÊÑüÁü•ËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-clock section-icon"></i>
                                    <span class="section-title">Êó∂Èó¥ÊÑüÁü•</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">Êó∂Èó¥ÊÑüÁü•ÂºÄÂÖ≥</div>
                                            <div class="setting-desc">ËßíËâ≤‰ºöÊÑüÁü•ÂΩìÂâçÊó∂Èó¥Âπ∂Ë∞ÉÊï¥ÂõûÂ§ç</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="time-awareness-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÈÄöËØùËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-phone section-icon"></i>
                                    <span class="section-title">ÈÄöËØùËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ËßíËâ≤‰∏ªÂä®Êã®ÊâìÁîµËØù</div>
                                            <div class="setting-desc">ÂÖÅËÆ∏ËßíËâ≤Ê†πÊçÆÂØπËØùÂÜÖÂÆπ‰∏ªÂä®ÂèëËµ∑ÈÄöËØù</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-call-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-explanation">
                                        <div class="explanation-text">
                                            <strong>ÂäüËÉΩËØ¥ÊòéÔºö</strong><br>
                                            ‚Ä¢ <strong>ÂºÄÂêØÊó∂Ôºö</strong>ÂΩìÊú¨ËΩÆËÅäÂ§©‰∏≠ÊèêÂà∞ÈÄöËØùÁõ∏ÂÖ≥ÂÜÖÂÆπÊó∂ÔºåËßíËâ≤Êúâ20%Ê¶ÇÁéá‰∏ªÂä®Áªô‰Ω†ÊâìÁîµËØù<br>
                                            ‚Ä¢ <strong>ÂÖ≥Èó≠Êó∂Ôºö</strong>ËßíËâ≤‰∏ç‰ºö‰∏ªÂä®Êã®ÊâìÁîµËØùÔºåÂè™ËÉΩÁî±Áî®Êà∑‰∏ªÂä®ÂèëËµ∑ÈÄöËØù<br>
                                            ‚Ä¢ <strong>ÈÄöËØùÂÖ≥ÈîÆËØçÔºö</strong>ÈÄöËØù„ÄÅÁîµËØù„ÄÅËßÜÈ¢ë„ÄÅËØ≠Èü≥„ÄÅÊâìÁªô‰Ω†„ÄÅÊÉ≥Âê¨„ÄÅÊÉ≥ÁúãÁ≠â
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AIÂøÉÁéáÁõëÊµã -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-heartbeat section-icon"></i>
                                    <span class="section-title">ËßíËâ≤ÂøÉÁéáÁõëÊµã</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂøÉÁéáÁõëÊµãÊòæÁ§∫</div>
                                            <div class="setting-desc">Âú®Áä∂ÊÄÅÊ†èÊòæÁ§∫ËßíËâ≤ÁöÑÊÉÖÊÑüÂøÉÁéá</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-heartrate-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-comments section-icon"></i>
                                    <span class="section-title">ËÅäÂ§©Ê®°Âºè</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">Ê®°ÂºèÈÄâÊã©</div>
                                            <div class="setting-desc">ÈÄâÊã©Á∫ø‰∏äÁ∫ØËÅäÂ§©ÊàñÁ∫ø‰∏ãÂâßÊÉÖÊ®°Âºè</div>
                                        </div>
                                    </div>
                                    <div class="chat-mode-switch">
                                        <div class="chat-mode-option">
                                            <input type="radio" id="chat-mode-online" name="chat-mode" value="online" checked>
                                            <label for="chat-mode-online">Á∫ø‰∏äÊ®°Âºè</label>
                                        </div>
                                        <div class="chat-mode-option">
                                            <input type="radio" id="chat-mode-offline" name="chat-mode" value="offline">
                                            <label for="chat-mode-offline">Á∫ø‰∏ãÊ®°Âºè</label>
                                        </div>
                                    </div>
                                    <div class="offline-length-control hide" id="offline-length-control">
                                        <span class="control-label">ÊØèÊù°Ê∂àÊÅØÊúÄÈïøÔºö</span>
                                        <input type="number" id="offline-mode-max-length" min="50" max="500" value="100">
                                        <span class="control-unit">Â≠ó</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Á§æ‰∫§Âä®ÊÄÅËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-share-alt section-icon"></i>
                                    <span class="section-title">Á§æ‰∫§Âä®ÊÄÅ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">Á§æ‰∫§Âä®ÊÄÅÂäüËÉΩ</div>
                                            <div class="setting-desc">ÂºÄÂêØÁ§æ‰∫§Âä®ÊÄÅÂèëÂ∏ÉÂíå‰∫íÂä®</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="social-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item social-settings hide" id="social-frequency-settings">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂèëÂ∏ÉÈ¢ëÁéá</div>
                                            <div class="setting-desc">ËßíËâ≤Ëá™Âä®ÂèëÂ∏ÉÂä®ÊÄÅÁöÑÈ¢ëÁéá</div>
                                        </div>
                                        <div class="setting-right">
                                            <select id="social-frequency" class="setting-select">
                                                <option value="low">‰Ωé (1-2Êù°/Â§©)</option>
                                                <option value="medium">‰∏≠ (3-4Êù°/Â§©)</option>
                                                <option value="high">È´ò (5-6Êù°/Â§©)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="setting-item social-settings hide" id="social-schedule-settings" onclick="showScheduleSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂÆöÊó∂ÂèëÂ∏É</div>
                                            <div class="setting-desc">ËÆæÁΩÆÂõ∫ÂÆöÊó∂Èó¥ÁÇπËá™Âä®ÂèëÂ∏ÉÂä®ÊÄÅ</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-robot section-icon"></i>
                                    <span class="section-title">ÂêéÂè∞‰∫íÂä®</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂêéÂè∞‰∫íÂä®ÂºÄÂÖ≥</div>
                                            <div class="setting-desc">ËßíËâ≤ÂèØÂú®ÂêéÂè∞‰∏ªÂä®Ê¥ªÂä®Âπ∂ÂèëÈÄÅÊé®ÈÄÅ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="background-interaction-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="background-interaction-details hide" id="background-interaction-settings">
                                        <div class="setting-item">
                                            <div class="setting-left">
                                                <div class="setting-label">‰∏ªÂä®ËÅäÂ§©È¢ëÁéá</div>
                                                <div class="setting-desc">ËßíËâ≤‰∏ªÂä®ÂèëËµ∑ÂØπËØùÁöÑÈ¢ëÁéá</div>
                                            </div>
                                            <div class="setting-right">
                                                <select id="background-chat-frequency" class="setting-select">
                                                    <option value="low">‰Ωé (1-2Â∞èÊó∂/Ê¨°)</option>
                                                    <option value="medium">‰∏≠ (30-60ÂàÜÈíü/Ê¨°)</option>
                                                    <option value="high">È´ò (10-15ÂàÜÈíü/Ê¨°)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="setting-item">
                                            <div class="setting-left">
                                                <div class="setting-label">‰∏ªÂä®ÂèëÂä®ÊÄÅÈ¢ëÁéá</div>
                                                <div class="setting-desc">ËßíËâ≤‰∏ªÂä®ÂèëÂ∏ÉÂæÆÂçöÁöÑÈ¢ëÁéá</div>
                                            </div>
                                            <div class="setting-right">
                                                <select id="background-weibo-frequency" class="setting-select">
                                                    <option value="low">‰Ωé (3-5Â∞èÊó∂/Ê¨°)</option>
                                                    <option value="medium">‰∏≠ (1-2Â∞èÊó∂/Ê¨°)</option>
                                                    <option value="high">È´ò (15-25ÂàÜÈíü/Ê¨°)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÂÖ∂‰ªñËÆæÁΩÆ -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-cog section-icon"></i>
                                    <span class="section-title">ÂÖ∂‰ªñËÆæÁΩÆ</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">ÊòæÁ§∫Êó∂Èó¥Êà≥</div>
                                            <div class="setting-desc">Âú®ËÅäÂ§©Ê∂àÊÅØ‰∏≠ÊòæÁ§∫Êó∂Èó¥‰ø°ÊÅØ</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="timestamp-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showTimestampSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">Êó∂Èó¥Êà≥ËÆæÁΩÆ</div>
                                            <div class="setting-desc">ËÆæÁΩÆÊó∂Èó¥Êà≥ÊòæÁ§∫‰ΩçÁΩÆÂíåÊ†ºÂºè</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="searchChatContent()">
                                        <div class="setting-left">
                                            <div class="setting-label">Êü•ÊâæËÅäÂ§©ÂÜÖÂÆπ</div>
                                            <div class="setting-desc">ÊêúÁ¥¢ÂéÜÂè≤Ê∂àÊÅØ‰∏≠ÁöÑÂÖ≥ÈîÆËØç</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="exportChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label">ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</div>
                                            <div class="setting-desc">ÂØºÂá∫ÂΩìÂâçÂØπËØùÁöÑÊâÄÊúâÊ∂àÊÅØ</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- Âç±Èô©Êìç‰Ωú -->
                            <div class="settings-section">
                                <div class="section-header">
                                                    <i class="fas fa-exclamation-triangle section-icon danger-section-icon"></i>
                <span class="section-title danger-section-title">Âç±Èô©Êìç‰Ωú</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item danger-item" onclick="clearChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label danger-color">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</div>
                                            <div class="setting-desc">Âà†Èô§ÊâÄÊúâÂéÜÂè≤Ê∂àÊÅØÔºå‰∏çÂèØÊÅ¢Â§ç</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right danger-color"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                
                <!-- ‰∫∫Áâ©ÁºñËæëË°®Âçï -->
                <div id="character-form-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideCharacterForm()">‚Äπ</button>
                        <div class="app-title" id="character-form-title">Êñ∞Âª∫‰∫∫Áâ©</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">Â§¥ÂÉè</label>
                                <div class="avatar-preview" id="avatar-preview">
                                    <div class="avatar-preview-text" id="avatar-preview-text">A</div>
                                </div>
                                <input type="file" id="avatar-upload" accept="image/*" class="file-input-hidden">
                                <button class="upload-button" onclick="handleAvatarUploadClick()">‰∏ä‰º†Â§¥ÂÉè</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÂßìÂêç</label>
                                <input type="text" class="form-input" id="character-name" placeholder="ËæìÂÖ•ÂßìÂêç">
                            </div>
                            <div class="form-group">
                                <label class="form-label">‰∫∫ËÆæ</label>
                                <textarea class="form-textarea" id="character-bio" placeholder="ËæìÂÖ•‰∫∫Áâ©ËÆæÂÆö"></textarea>
                            </div>
                            <div class="form-actions form-actions-flex">
                                <button class="form-submit form-submit-flex">‰øùÂ≠ò</button>
                                <button class="form-delete form-delete-red" id="character-delete-btn" onclick="deleteCurrentCharacter()">Âà†Èô§</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Èù¢ÂÖ∑ÂàõÂª∫Ë°®Âçï -->
                <div id="persona-form-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hidePersonaForm()">‚Äπ</button>
                        <div class="app-title" id="persona-form-title">Êñ∞Âª∫Èù¢ÂÖ∑</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">Â§¥ÂÉè</label>
                                <div class="avatar-preview" id="persona-avatar-preview">
                                    <div class="avatar-preview-text" id="persona-avatar-preview-text">Êàë</div>
                                </div>
                                <input type="file" id="persona-avatar-upload" accept="image/*" class="file-input-hidden">
                                <button class="upload-button" onclick="handlePersonaAvatarUploadClick()">‰∏ä‰º†Â§¥ÂÉè</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÂêçÁß∞</label>
                                <input type="text" class="form-input" id="persona-name" placeholder="‰æãÂ¶ÇÔºöuserÂ∞èÊòé„ÄÅuserÂ≠¶Áîü„ÄÅuserÂ∑•‰ΩúËÄÖ">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÊèèËø∞</label>
                                <textarea class="form-textarea" id="persona-description" placeholder="ÊèèËø∞Ëøô‰∏™Ë∫´‰ªΩÁöÑÁâπÁÇπÔºåÂåÖÊã¨ÊÄßÊ†º„ÄÅËØ¥ËØùÈ£éÊ†º„ÄÅ‰ΩøÁî®Âú∫ÂêàÁ≠â..."></textarea>
                            </div>
                            
                            <button class="form-submit" onclick="savePersona()">‰øùÂ≠òÈù¢ÂÖ∑</button>
                        </div>
                    </div>
                </div>
                
                <!-- APIËÅäÂ§©ÁïåÈù¢ -->
                <div id="api-chat-screen" class="app-screen">
                    <div class="app-header">
                        <div class="default-controls">
                            <button class="back-button" onclick="hideApp('api-chat-screen')">‚Äπ</button>
                            <div class="app-title" id="api-chat-title">ËßíËâ≤ËÅäÂ§©</div>
                            <div class="chat-menu-button chat-menu-btn" onclick="showChatSettings()">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                        </div>
                        <div class="selection-controls">
                            <span id="selection-cancel-btn">ÂèñÊ∂à</span>
                            <span id="selection-count"></span>
                            <span id="selection-delete-btn">Âà†Èô§</span>
                        </div>
                    </div>
                    <div class="app-content padding-none-flex">

                        <div class="chat-dialog">
                            <div class="chat-messages" id="api-chat-messages">
                                <!-- ËÅäÂ§©Ê∂àÊÅØÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            
                            <!-- ÊÇ¨ÊµÆÊåâÈíÆÁªÑ -->
                            <div class="floating-actions" id="floating-actions">
                                <button class="floating-btn" id="regenerate-btn" onclick="regenerateLastResponse()" title="ÈáçÊñ∞ÁîüÊàêÂõûÁ≠î">
                                    <i class="fas fa-redo-alt"></i>
                                </button>
                                <button class="floating-btn" id="smart-reply-btn" onclick="triggerSmartReply()" title="Ëé∑ÂèñAIÂõûÂ§ç">
                                    <i class="fas fa-comment-dots"></i>
                                </button>
                            </div>
                            
                            <div class="chat-input-area">
                                <button class="chat-action-btn" onclick="showCustomEmojiPanel()" title="Ë°®ÊÉÖÂåÖ">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <input type="text" class="chat-input" id="api-chat-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                                <button class="chat-action-btn" onclick="uploadImage()" title="ÂõæÁâá">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="send-button" onclick="sendApiMessage()">
                                    ÂèëÈÄÅ
                                </button>
                                <input type="file" id="image-upload" accept="image/*" class="file-input-hidden">
                                <input type="file" id="emoji-upload" accept="image/*" class="file-input-hidden" multiple>
                            </div>
                        </div>
                        
                        <!-- Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÈù¢Êùø -->
                        <div class="custom-emoji-panel" id="custom-emoji-panel">
                            <div class="emoji-tabs">
                                <div class="emoji-tab active" data-tab="recent">ÊúÄËøë</div>
                                <div class="emoji-tab" data-tab="custom">ÂÖ®ÈÉ®</div>
                            </div>
                            <div class="emoji-content">
                                <div class="emoji-grid" id="emoji-grid">
                                    <!-- Ë°®ÊÉÖÂåÖÁΩëÊ†ºÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÊµèËßàÂô®ÁïåÈù¢ -->
                <div id="browser-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('browser-screen')">‚Äπ</button>
                        <div class="app-title">ÊµèËßàÂô®</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="browser-toolbar">
                            <input type="text" class="browser-url-bar" id="browser-url" placeholder="ËæìÂÖ•ÁΩëÂùÄ">
                            <button onclick="loadUrl()">ÂâçÂæÄ</button>
                        </div>
                        <iframe class="browser-content" id="browser-frame"></iframe>
                    </div>
                </div>
                
                <!-- Áõ∏Êú∫ÁïåÈù¢ -->
                <div id="camera-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('camera-screen')">‚Äπ</button>
                        <div class="app-title">Áõ∏Êú∫</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="camera-view" id="camera-view">
                            <div>Áõ∏Êú∫È¢ÑËßà</div>
                        </div>
                        <div class="camera-controls">
                            <button class="capture-button" onclick="capturePhoto()"></button>
                        </div>
                    </div>
                </div>
                
                <!-- Áõ∏ÂÜåÁïåÈù¢ -->
                <div id="album-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('album-screen')">‚Äπ</button>
                        <div class="app-title">Áõ∏ÂÜå</div>
                    </div>
                    <div class="app-content padding-none">
                        <div class="album-grid" id="album-grid">
                            <!-- Áõ∏ÂÜåÂÜÖÂÆπÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                
                <!-- ÁÖßÁâáËØ¶ÊÉÖ -->
                <div id="photo-detail-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('photo-detail-screen')">‚Äπ</button>
                        <div class="app-title">ÁÖßÁâá</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="photo-detail">
                            <div class="photo-image" id="photo-image">
                                <div class="photo-description" id="photo-description-text"></div>
                            </div>
                            <div class="photo-info">
                                <div class="photo-time" id="photo-time"></div>
                                <div class="photo-location" id="photo-location"></div>
                            </div>
                        </div>
                    </div>
                </div>
                

                
                <!-- ËÆæÁΩÆÂ∫îÁî® -->
                <div id="settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('settings-screen')">‚Äπ</button>
                        <div class="app-title">ËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showApp('api-settings-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wifi">
                                    <i class="fas fa-wifi"></i>
                                </div>
                                <div>APIËÆæÁΩÆ</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('theme-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon settings-icon-custom">
                                    <i class="fas fa-palette"></i>
                                </div>
                                <div>‰∏ªÈ¢òËÆæÁΩÆ</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-sun"></i>
                                </div>
                                <div>ÊòæÁ§∫‰∏é‰∫ÆÂ∫¶</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('wallpaper-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wallpaper">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div>Â¢ôÁ∫∏</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('datetime-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon datetime">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>Êó•Êúü‰∏éÊó∂Èó¥</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon notification">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div>ÈÄöÁü•</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('about-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon about">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div>ÂÖ≥‰∫éÊàë‰ª¨</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Êó•Êúü‰∏éÊó∂Èó¥ËÆæÁΩÆ -->
                <div id="datetime-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('datetime-screen')">‚Äπ</button>
                        <div class="app-title">Êó•Êúü‰∏éÊó∂Èó¥</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>Ëá™Âä®ËÆæÁΩÆ</div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" checked>
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- ÂÖ≥‰∫éÊàë‰ª¨ -->
                <div id="about-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('about-screen')">‚Äπ</button>
                        <div class="app-title">ÂÖ≥‰∫éÊàë‰ª¨</div>
                    </div>
                    <div class="app-content">
                        <div class="about-content">
                            <div class="about-title">iPhone Ê®°ÊãüÂô®</div>
                            <div class="about-version">ÁâàÊú¨ 1.0.0</div>
                            <div class="about-author">‰ΩúËÄÖ@EVE</div>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏ªÈ¢òËÆæÁΩÆÁïåÈù¢ -->
                <div id="theme-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">·∞î·©ö</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('theme-screen')">‚Äπ</button>
                        <div class="app-title">‰∏ªÈ¢òËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="theme-option" onclick="changeTheme('default')">
                            <div class="theme-preview theme-preview-simple">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">ÁÆÄÁ∫¶È£éÊ†º</div>
                                <div class="theme-description">Ê∏ÖÊñ∞ÁÆÄÊ¥ÅÁöÑÈªòËÆ§‰∏ªÈ¢ò</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('cute')">
                            <div class="theme-preview theme-preview-cute">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">ÂèØÁà±È£éÊ†º</div>
                                <div class="theme-description">Ê∏©È¶®ÂèØÁà±ÁöÑÁ≤âËâ≤‰∏ªÈ¢ò</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('nature')">
                            <div class="theme-preview theme-preview-nature">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">Ëá™ÁÑ∂È£éÊ†º</div>
                                <div class="theme-description">Ê∏ÖÊñ∞Ëá™ÁÑ∂ÁöÑÁªøËâ≤‰∏ªÈ¢ò</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('tech')">
                            <div class="theme-preview theme-preview-tech">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">ÁßëÊäÄÈ£éÊ†º</div>
                                <div class="theme-description">Áé∞‰ª£ÁßëÊäÄÁöÑËìùËâ≤‰∏ªÈ¢ò</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('dream')">
                            <div class="theme-preview theme-preview-dream">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">Ê¢¶ÂπªÈ£éÊ†º</div>
                                <div class="theme-description">Á•ûÁßòÊµ™Êº´ÁöÑÁ¥´Ëâ≤‰∏ªÈ¢ò</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Â¢ôÁ∫∏ËÆæÁΩÆ -->
                <div id="wallpaper-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('wallpaper-screen')">‚Äπ</button>
                        <div class="app-title">Â¢ôÁ∫∏</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showWallpaperPicker()">
                            <div class="settings-item-left">
                                <div>ÈÄâÊã©Êñ∞Â¢ôÁ∫∏</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showIconPicker()">
                            <div class="settings-item-left">
                                <div>Êõ¥ÊîπÂ∫îÁî®ÂõæÊ†á</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Êó†Á∫øÂ±ÄÂüüÁΩëËÆæÁΩÆ -->
                <div id="wifi-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('wifi-screen')">‚Äπ</button>
                        <div class="app-title">Êó†Á∫øÂ±ÄÂüüÁΩë</div>
                    </div>
                    <div class="app-content">
                        <div class="wifi-settings">
                            <div class="settings-item">
                                <div class="settings-item-left">
                                    <div>Êó†Á∫øÂ±ÄÂüüÁΩë</div>
                                </div>
                                <label class="settings-toggle">
                                    <input type="checkbox" checked>
                                    <span class="settings-slider"></span>
                                </label>
                            </div>
                            
                            <div class="wifi-network">
                                <div class="wifi-network-left">
                                    <div class="wifi-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div>
                                        <div>HomeWiFi</div>
                                        <div class="wifi-strength">
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                        </div>
                                    </div>
                                </div>
                                <i class="fas fa-check check-icon"></i>
                            </div>
                            
                            <div class="settings-item settings-item-margin" onclick="showApp('api-settings-screen')">
                                <div class="settings-item-left">
                                    <div>APIËÆæÁΩÆ</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- APIËÆæÁΩÆÁïåÈù¢ -->
                <div id="api-settings-screen" class="app-screen">
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('api-settings-screen')">‚Äπ</button>
                        <div class="app-title">APIËÆæÁΩÆ</div>
                    </div>
                    <div class="app-content">
                        <div class="api-settings">
                            <div class="api-form-group">
                                <label class="api-form-label">APIÁ±ªÂûã</label>
                                <select class="api-form-select" id="api-type" onchange="onApiTypeChange()">
                                    <option value="openai">OpenAI</option>
                                    <option value="azure">Azure OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="gemini">Google Gemini</option>
                                </select>
                            </div>
                            
                            <div class="api-form-group">
                                <label class="api-form-label">APIÂü∫Âú∞ÂùÄ</label>
                                <input type="text" class="api-form-input" id="api-base" placeholder="https://generativelanguage.googleapis.com/v1beta">
                                <small class="small-desc">
                                    GeminiÁõ¥Ëøû: https://generativelanguage.googleapis.com/v1beta<br>
                                    Âèç‰ª£Á§∫‰æã: https://your-proxy.com/v1beta
                                </small>
                            </div>
                            
                            <div class="api-form-group" id="endpoint-group">
                                <label class="api-form-label">Á´ØÁÇπË∑ØÂæÑ</label>
                                <input type="text" class="api-form-input" id="api-endpoint" placeholder="/chat/completions">
                                <small class="small-desc">
                                    ‰ªÖÂØπOpenAIÂÖºÂÆπAPIÊúâÊïàÔºåGeminiËá™Âä®Â§ÑÁêÜ
                                </small>
                            </div>
                            
                            <div class="api-form-group">
                                <label class="api-form-label">APIÁßòÈí•</label>
                                <input type="password" class="api-form-input" id="api-key" placeholder="AIzaSy...ÔºàGeminiÔºâÊàñ sk-...ÔºàOpenAIÔºâ">
                                <small class="small-desc">
                                    Gemini: Âú®Google AI StudioËé∑ÂèñAPI Key<br>
                                    OpenAI: sk-ÂºÄÂ§¥ÁöÑÂØÜÈí•
                                </small>
                            </div>
                            
                            <div class="api-form-group">
                                <label class="api-form-label">Ê®°ÂûãÂêçÁß∞</label>
                                <div class="api-form-flex">
                                    <select class="api-form-select api-select-hidden" id="api-model-select">
                                        <option value="">ÈÄâÊã©Ê®°Âûã...</option>
                                    </select>
                                    <button type="button" id="fetch-models-btn" onclick="fetchModels()" class="fetch-btn">Ëé∑ÂèñÊ®°Âûã</button>
                                </div>
                                <input type="text" class="api-form-input" id="api-model" placeholder="gemini-2.0-flash-exp">
                                <small class="small-desc" id="model-hint">
                                    Êé®Ëçê: gemini-2.0-flash-exp (ÊúÄÊñ∞), gemini-1.5-pro (Á®≥ÂÆö)
                                </small>
                            </div>
                            
                            <div class="api-form-group">
                                <label class="api-form-label">Ê∏©Â∫¶ (0-1)</label>
                                <input type="range" class="api-form-range" id="api-temperature" min="0" max="1" step="0.1" value="0.7">
                                <span id="temperature-value">0.7</span>
                            </div>
                            

                            
                            <button class="api-form-submit" onclick="saveApiSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
                            <button class="api-form-submit test-connection-btn" onclick="testApiConnection()">ÊµãËØïËøûÊé•</button>
                        </div>
                    </div>
                </div>
                
                <!-- È¢úËâ≤ÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="color-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title" id="color-picker-title">ÈÄâÊã©È¢úËâ≤</div>
                            <button class="modal-close" onclick="hideModal('color-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="color-picker" id="color-picker">
                                <div class="color-option color-red" onclick="selectColor('#FF3B30')"></div>
                                <div class="color-option color-orange" onclick="selectColor('#FF9500')"></div>
                                <div class="color-option color-yellow" onclick="selectColor('#FFCC00')"></div>
                                <div class="color-option color-green" onclick="selectColor('#34C759')"></div>
                                <div class="color-option color-light-blue" onclick="selectColor('#5AC8FA')"></div>
                                <div class="color-option color-blue" onclick="selectColor('#007AFF')"></div>
                                <div class="color-option color-purple" onclick="selectColor('#5856D6')"></div>
                                <div class="color-option color-pink" onclick="selectColor('#AF52DE')"></div>
                                <div class="color-option color-red-alt" onclick="selectColor('#FF2D55')"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÈÄèÊòéÂ∫¶</label>
                                <input type="range" class="opacity-slider" id="opacity-slider" min="0" max="1" step="0.1" value="1">
                                <span id="opacity-value">100%</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('color-picker-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="applyColorSelection()">Â∫îÁî®</button>
                        </div>
                    </div>
                </div>
                
                <!-- Â¢ôÁ∫∏ÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="wallpaper-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©Â¢ôÁ∫∏</div>
                            <button class="modal-close" onclick="hideModal('wallpaper-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="wallpaper-options">
                                <div class="wallpaper-option wallpaper-gradient1" onclick="selectWallpaper('gradient1')"></div>
                                <div class="wallpaper-option wallpaper-gradient2" onclick="selectWallpaper('gradient2')"></div>
                                <div class="wallpaper-option wallpaper-gradient3" onclick="selectWallpaper('gradient3')"></div>
                                <div class="wallpaper-option wallpaper-gradient4" onclick="selectWallpaper('gradient4')"></div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomWallpaper()">
                                <div class="settings-item-left">
                                    <div>‰ªéÁõ∏ÂÜåÈÄâÊã©</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-wallpaper-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('wallpaper-picker-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="applyWallpaperSelection()">Â∫îÁî®</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂõæÊ†áÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="icon-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©Â∫îÁî®ÂõæÊ†á</div>
                            <button class="modal-close" onclick="hideModal('icon-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="icon-options">
                                <div class="icon-option" onclick="selectAppIcon('chat-screen', 'fas fa-comment-dots')">
                                    <div class="icon-preview">
                                        <i class="fas fa-comment-dots"></i>
                                    </div>
                                    <span>Chat</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('weibo-screen', 'fab fa-weibo')">
                                    <div class="icon-preview">
                                        <i class="fab fa-weibo"></i>
                                    </div>
                                    <span>ÂæÆÂçö</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('music-screen', 'fas fa-music')">
                                    <div class="icon-preview">
                                        <i class="fas fa-music"></i>
                                    </div>
                                    <span>Èü≥‰πê</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('album-screen', 'fas fa-images')">
                                    <div class="icon-preview">
                                        <i class="fas fa-images"></i>
                                    </div>
                                    <span>Áõ∏ÂÜå</span>
                                </div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomIcon()">
                                <div class="settings-item-left">
                                    <div>‰ªéÁõ∏ÂÜåÈÄâÊã©</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-icon-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('icon-picker-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="applyIconSelection()">Â∫îÁî®</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÁÖßÁâáÊãçÊëÑÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="photo-capture-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÁÖßÁâáËØ¶ÊÉÖ</div>
                            <button class="modal-close" onclick="hideModal('photo-capture-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">ÁÖßÁâáÊèèËø∞</label>
                                <input type="text" class="form-input" id="photo-description" placeholder="ÊèèËø∞ÊãçÊëÑÁöÑÂÜÖÂÆπ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÊãçÊëÑÂú∞ÁÇπ</label>
                                <input type="text" class="form-input" id="photo-location-input" placeholder="ËæìÂÖ•ÊãçÊëÑÂú∞ÁÇπ">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="cancelPhoto()">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="savePhoto()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                

                
                <!-- Ê∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="add-contact-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Ê∑ªÂä†ËÅîÁ≥ª‰∫∫</div>
                            <button class="modal-close" onclick="hideModal('add-contact-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="contact-modal-body">
                            <!-- ËÅîÁ≥ª‰∫∫ÈÄâÈ°πÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('add-contact-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="addSelectedContacts()">Ê∑ªÂä†</button>
                        </div>
                    </div>
                </div>
                
                <!-- ËÅäÂ§©ÈÄâÈ°πÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="chat-options-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©ËÅäÂ§©Á±ªÂûã</div>
                            <button class="modal-close" onclick="hideModal('chat-options-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="chat-option-item" onclick="showSingleChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-user icon-user-blue"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">ÂçïËÅä</div>
                                    <div class="chat-option-desc">‰∏éÂçï‰∏™ËßíËâ≤ËøõË°åÂØπËØù</div>
                                </div>
                            </div>
                            <div class="chat-option-item" onclick="showGroupChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-users icon-users-green"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">Áæ§ËÅä</div>
                                    <div class="chat-option-desc">‰∏éÂ§ö‰∏™ËßíËâ≤ÂêåÊó∂ËÅäÂ§©</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÂçïËÅäËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="single-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©ËÅäÂ§©ËßíËâ≤</div>
                            <button class="modal-close" onclick="hideModal('single-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="single-chat-body">
                            <!-- ËßíËâ≤ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                
                <!-- Áæ§ËÅäËßíËâ≤ÈÄâÊã©Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="group-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂàõÂª∫Áæ§ËÅä</div>
                            <button class="modal-close" onclick="hideModal('group-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Áæ§ËÅäÂêçÁß∞</label>
                                <input type="text" class="form-input" id="group-chat-name" placeholder="‰æãÂ¶ÇÔºöÊúãÂèãÂúà„ÄÅÂ∑•‰ΩúÁæ§">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÈÄâÊã©ÊàêÂëò (Ëá≥Â∞ë2‰∫∫ÔºåÊúÄÂ§ö8‰∫∫)</label>
                                <div id="group-chat-members">
                                    <!-- Áæ§ËÅäÊàêÂëòÈÄâÊã©Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('group-chat-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="createGroupChat()">ÂàõÂª∫Áæ§ËÅä</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="history-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('history-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-card">
                                <div class="setting-item">
                                    <div class="setting-left">
                                        <div class="setting-label">ÈôÑÂ∏¶ÂéÜÂè≤Ê∂àÊÅØÊï∞ (ÂõûÂêàÊï∞)</div>
                                        <div class="setting-desc">AIÂõûÂ§çÊó∂ÂèÇËÄÉÁöÑÂéÜÂè≤ÂØπËØùÂõûÂêàÊï∞</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="history-count-display">5ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="setting-range-container">
                                    <input type="range" class="theme-range" id="history-messages-count" min="0" max="100" step="1" value="5">
                                    <div class="range-labels">
                                        <span>0ÂõûÂêà</span>
                                        <span>100ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="custom-input-container">
                                    <span class="input-label">Ëá™ÂÆö‰πâÊï∞ÂÄºÔºö</span>
                                    <input type="number" class="theme-input" id="custom-history-count" min="0" max="500" value="5">
                                    <span class="input-unit">ÂõûÂêà (ÊúÄÂ§ß500)</span>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>ËØ¥ÊòéÔºö</strong><br>
                                        ‚Ä¢ ‰∏ÄÂõûÂêà = ‰Ω†ÁöÑ‰∏ÄÊù°Ê∂àÊÅØ + AIÁöÑ‰∏ÄÊù°ÂõûÂ§ç<br>
                                        ‚Ä¢ ËÆæÁΩÆ‰∏∫5Ë°®Á§∫AIÂõûÂ§çÊó∂‰ºöÂèÇËÄÉÊúÄËøë5ËΩÆÂØπËØù<br>
                                        ‚Ä¢ Ê≥®ÊÑèÔºöÊï∞ÂÄºËøáÂ§ßÂèØËÉΩÂΩ±ÂìçAPIÂìçÂ∫îÈÄüÂ∫¶
                                    </div>
                                </div>
                            </div>
                            
                            <div class="setting-card">
                                <div class="setting-item">
                                    <div class="setting-left">
                                        <div class="setting-label">Ë∑®Á™óÂè£ËÆ∞ÂøÜÂõûÂêàÊï∞</div>
                                        <div class="setting-desc">‰ªéÂÖ∂‰ªñËÅäÂ§©Á™óÂè£ËØªÂèñÁöÑËÉåÊôØËÆ∞ÂøÜÂõûÂêàÊï∞</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="cross-memory-display">3ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="setting-range-container">
                                    <input type="range" class="theme-range" id="cross-chat-memory" min="0" max="20" step="1" value="3">
                                    <div class="range-labels">
                                        <span>0ÂõûÂêà</span>
                                        <span>20ÂõûÂêà</span>
                                    </div>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>ËØ¥ÊòéÔºö</strong><br>
                                        ‚Ä¢ AI‰ºöËØªÂèñÂÖ∂‰ªñËÅäÂ§©Á™óÂè£‰∏≠ÊúÄÊñ∞ÁöÑÂá†ËΩÆÂØπËØù‰Ωú‰∏∫ËÉåÊôØËÆ∞ÂøÜ<br>
                                        ‚Ä¢ ‰∏ÄÂõûÂêà = Áî®Êà∑‰∏ÄÊù°Ê∂àÊÅØ + AI‰∏ÄÊù°ÂõûÂ§ç<br>
                                        ‚Ä¢ Â∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÁêÜËß£Êï¥‰ΩìÂØπËØù‰∏ä‰∏ãÊñá
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="theme-button theme-button-secondary" onclick="hideModal('history-settings-modal')">ÂèñÊ∂à</button>
                            <button class="theme-button theme-button-primary" onclick="saveHistorySettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="memory-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('memory-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="memory-mount-enabled" class="checkbox-with-margin">
                                    ÂêØÁî®ËÆ∞ÂøÜÊåÇËΩΩ
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåAI‰ºöÂèÇËÄÉÂÖ∂‰ªñËÅäÂ§©Á™óÂè£ÁöÑÂØπËØùÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØËÆ∞ÂøÜ
                                </p>
                            </div>
                            <div class="form-group hide" id="memory-mount-details">
                                <label class="form-label">ÊØè‰∏™ËÅäÂ§©ÊåÇËΩΩÊù°Êï∞</label>
                                <input type="range" class="api-form-range" id="memory-mount-count" min="1" max="20" step="1" value="3">
                                <div class="flex-space-between">
                                    <span>1Êù°</span>
                                    <span id="memory-mount-display">3Êù°</span>
                                    <span>20Êù°</span>
                                </div>
                            </div>
                            <div class="form-group hide" id="memory-mount-chats">
                                <label class="form-label">ÈÄâÊã©Ë¶ÅÊåÇËΩΩÁöÑËÅäÂ§©</label>
                                <div id="memory-mount-list" class="max-height-200-auto">
                                    <!-- ËÅäÂ§©ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                                <p class="small-text margin-top-8">
                                    ÈÄâÊã©ÁöÑËÅäÂ§©ËÆ∞ÂΩï‰ºö‰Ωú‰∏∫ËÉåÊôØ‰ø°ÊÅØÊèê‰æõÁªôAIÂèÇËÄÉ
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('memory-mount-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveMemoryMountSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Â§¥ÂÉèËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="avatar-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂèåÊñπÂ§¥ÂÉèËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('avatar-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="avatar-setting-group">
                                <label class="form-label">ÊàëÁöÑÂ§¥ÂÉè (‰ªÖÂú®Ê≠§ËÅäÂ§©Á™óÂè£ÁîüÊïà)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="my-chat-avatar-preview">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <input type="file" id="my-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('my-chat-avatar-upload').click()">‰∏ä‰º†Â§¥ÂÉè</button>
                                </div>
                            </div>
                            <div class="avatar-setting-group">
                                <label class="form-label">ÂØπÊñπÂ§¥ÂÉè (‰ªÖÂú®Ê≠§ËÅäÂ§©Á™óÂè£ÁîüÊïà)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="ai-chat-avatar-preview">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <input type="file" id="ai-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('ai-chat-avatar-upload').click()">‰∏ä‰º†Â§¥ÂÉè</button>
                                </div>
                            </div>
                            <div class="form-group margin-top-20">
                                <label class="form-label">
                                    <input type="checkbox" id="hide-avatars" class="checkbox-with-margin">
                                    ÈöêËóèÂèåÊñπÂ§¥ÂÉè
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåËÅäÂ§©ÁïåÈù¢Â∞Ü‰∏çÊòæÁ§∫‰ªª‰ΩïÂ§¥ÂÉè
                                </p>
                            </div>
                            <p class="small-text margin-top-15">
                                Ê≥®ÊÑèÔºöÊ≠§ËÆæÁΩÆ‰ªÖÂΩ±ÂìçÂΩìÂâçËÅäÂ§©Á™óÂè£ÊòæÁ§∫Ôºå‰∏ç‰ºöÂêåÊ≠•‰øÆÊîπËßíËâ≤Âç°ÊàñÈù¢ÂÖ∑ËÆæÁΩÆ
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('avatar-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatAvatarSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÊòµÁß∞ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="nickname-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂèåÊñπÂ§áÊ≥®ËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('nickname-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÊòµÁß∞ (‰ªÖÂú®Ê≠§ËÅäÂ§©‰∏≠ÊòæÁ§∫)</label>
                                <input type="text" class="form-input" id="my-chat-nickname" placeholder="ËæìÂÖ•‰Ω†Âú®Ê≠§ËÅäÂ§©‰∏≠ÁöÑÊòµÁß∞">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂØπÊñπÊòµÁß∞ (‰ªÖÂú®Ê≠§ËÅäÂ§©‰∏≠ÊòæÁ§∫)</label>
                                <input type="text" class="form-input" id="ai-chat-nickname" placeholder="ËæìÂÖ•ÂØπÊñπÂú®Ê≠§ËÅäÂ§©‰∏≠ÁöÑÊòµÁß∞">
                            </div>
                            <p class="small-text margin-top-10">
                                Ê≥®ÊÑèÔºöÊ≠§ËÆæÁΩÆ‰ªÖÂΩ±ÂìçÂΩìÂâçËÅäÂ§©Á™óÂè£ÊòæÁ§∫Ôºå‰∏ç‰ºöÂêåÊ≠•‰øÆÊîπËßíËâ≤Âç°ÊàñÈù¢ÂÖ∑ËÆæÁΩÆ„ÄÇËßíËâ≤‰πüÂèØËÉΩÊ†πÊçÆÂøÉÊÉÖÂíåËÅäÂ§©ÂÜÖÂÆπËá™‰∏ª‰øÆÊîπËá™Â∑±ÁöÑÊòµÁß∞„ÄÇ
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('nickname-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatNicknameSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="poke-suffix-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('poke-suffix-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">ÊàëÁöÑÊà≥‰∏ÄÊà≥ÂêéÁºÄ</label>
                                <input type="text" class="form-input" id="my-poke-suffix" placeholder="ÁïôÁ©∫‰∏∫Êó†ÂêéÁºÄÔºà‰æãÂ¶ÇÔºöÁöÑÂ∞èËÑ∏ËõãÔºâ">
                                <p class="tiny-text margin-top-5">ÊòæÁ§∫‰∏∫Ôºö‰Ω†Êà≥‰∫ÜÊà≥[ËßíËâ≤Âêç][ÂêéÁºÄ]ÔºåÁïôÁ©∫ÂàôÊòæÁ§∫Ôºö‰Ω†Êà≥‰∫ÜÊà≥[ËßíËâ≤Âêç]</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂØπÊñπÊà≥‰∏ÄÊà≥ÂêéÁºÄ</label>
                                <input type="text" class="form-input" id="ai-poke-suffix" placeholder="ÁïôÁ©∫‰∏∫Êó†ÂêéÁºÄÔºà‰æãÂ¶ÇÔºöÁöÑÂ∞èÊâãÔºâ">
                                <p class="tiny-text margin-top-5">ÊòæÁ§∫‰∏∫Ôºö[ËßíËâ≤Âêç]Êà≥‰∫ÜÊà≥‰Ω†[ÂêéÁºÄ]ÔºåÁïôÁ©∫ÂàôÊòæÁ§∫Ôºö[ËßíËâ≤Âêç]Êà≥‰∫ÜÊà≥‰Ω†„ÄÇËßíËâ≤ÂèØËÉΩÊ†πÊçÆÂøÉÊÉÖËá™‰∏ª‰øÆÊîπÊ≠§ÂêéÁºÄ„ÄÇ</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('poke-suffix-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="savePokeSuffixSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ËÅäÂ§©ËÉåÊôØËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="background-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ËÅäÂ§©ËÉåÊôØËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('background-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="background-preview-container">
                                <div class="background-preview" id="chat-background-preview">
                                    <div class="preview-text">ËÉåÊôØÈ¢ÑËßà</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="file" id="background-upload" accept="image/*" class="file-input-hidden">
                                <button class="form-button" onclick="document.getElementById('background-upload').click()">ÈÄâÊã©ËÉåÊôØÂõæÁâá</button>
                                <button class="form-button form-button-secondary" onclick="removeBackground()">ÁßªÈô§ËÉåÊôØ</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('background-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatBackgroundSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="bubble-style-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('bubble-style-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="bubble-style-section">
                                <label class="form-label">ÈÄâÊã©Ê∞îÊ≥°Ê†∑Âºè</label>
                                <div class="bubble-style-grid">
                                    <div class="bubble-style-option" data-style="default">
                                        <div class="style-preview">
                                            <div class="preview-bubble sent-preview">ÈªòËÆ§Ê†∑Âºè</div>
                                            <div class="preview-bubble received-preview">ÁªèÂÖ∏ÂúÜËßí</div>
                                        </div>
                                        <div class="style-name">ÈªòËÆ§Ê†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="glass">
                                        <div class="style-preview bubble-style-glass">
                                            <div class="preview-bubble sent-preview">ÊØõÁéªÁíÉ</div>
                                            <div class="preview-bubble received-preview">ÂçäÈÄèÊòé</div>
                                        </div>
                                        <div class="style-name">ÊØõÁéªÁíÉ</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="shadow">
                                        <div class="style-preview bubble-style-shadow">
                                            <div class="preview-bubble sent-preview">ÁªèÂÖ∏Èò¥ÂΩ±</div>
                                            <div class="preview-bubble received-preview">Á´ã‰ΩìÊÑü</div>
                                        </div>
                                        <div class="style-name">ÁªèÂÖ∏Èò¥ÂΩ±</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="tail">
                                        <div class="style-preview bubble-style-tail">
                                            <div class="preview-bubble sent-preview">Â∏¶Â∞ñËßí</div>
                                            <div class="preview-bubble received-preview">Ê∞îÊ≥°Êà≥</div>
                                        </div>
                                        <div class="style-name">ÁªèÂÖ∏Ê∞îÊ≥°</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="gradient">
                                        <div class="style-preview bubble-style-gradient">
                                            <div class="preview-bubble sent-preview">Ê∏êÂèòËâ≤</div>
                                            <div class="preview-bubble received-preview">ÁæéËßÇ</div>
                                        </div>
                                        <div class="style-name">Ê∏êÂèòÊ†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="minimal">
                                        <div class="style-preview bubble-style-minimal">
                                            <div class="preview-bubble sent-preview">ÊûÅÁÆÄÁ∫øÊù°</div>
                                            <div class="preview-bubble received-preview">ÁÆÄÁ∫¶</div>
                                        </div>
                                        <div class="style-name">ÊûÅÁÆÄÊ†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="neon">
                                        <div class="style-preview bubble-style-neon">
                                            <div class="preview-bubble sent-preview">ÈúìËôπÂèëÂÖâ</div>
                                            <div class="preview-bubble received-preview">ÁßëÊäÄÊÑü</div>
                                        </div>
                                        <div class="style-name">ÈúìËôπÊ†∑Âºè</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="paper">
                                        <div class="style-preview bubble-style-paper">
                                            <div class="preview-bubble sent-preview">Á∫∏Âº†Âç°Áâá</div>
                                            <div class="preview-bubble received-preview">Ë¥®ÊÑü</div>
                                        </div>
                                        <div class="style-name">Á∫∏Âº†Ê†∑Âºè</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="color-setting-group">
                                <label class="form-label">Ëá™ÂÆö‰πâÈ¢úËâ≤</label>
                                <div class="color-picker-container">
                                    <div class="flex-gap-15">
                                        <div class="flex-1">
                                            <label class="label-small">ÊàëÁöÑÊ∞îÊ≥°</label>
                                            <input type="color" id="my-bubble-color" class="color-input" value="#007AFF">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">ÂØπÊñπÊ∞îÊ≥°</label>
                                            <input type="color" id="ai-bubble-color" class="color-input" value="#f0f0f0">
                                        </div>
                                    </div>
                                </div>
                                <div class="opacity-setting">
                                    <div class="flex-gap-15-mb-15">
                                        <div class="flex-1">
                                            <label class="label-small">ÊàëÁöÑÊ∞îÊ≥°ÈÄèÊòéÂ∫¶Ôºö<span id="my-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="my-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">ÂØπÊñπÊ∞îÊ≥°ÈÄèÊòéÂ∫¶Ôºö<span id="ai-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="ai-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="padding-setting">
                                    <label class="form-label">Ê∞îÊ≥°Â§ßÂ∞èË∞ÉËäÇ</label>
                                    <div class="flex-gap-15-mb-10">
                                        <div class="flex-1">
                                            <label class="label-small">ÂÜÖËæπË∑ùÔºö<span id="bubble-padding-value">‰∏≠Á≠â</span></label>
                                            <input type="range" id="bubble-padding" min="8" max="20" step="2" value="12" class="width-100">
                                        </div>
                                    </div>
                                    <p class="tiny-text-gray margin-top-5">
                                        Ë∞ÉÊï¥Ê∞îÊ≥°ÂÜÖÊñáÂ≠ó‰∏éËæπÁºòÁöÑË∑ùÁ¶ªÔºåÊï∞ÂÄºË∂äÂ§ßÊ∞îÊ≥°Ë∂äÂ§ß
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('bubble-style-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveBubbleStyleSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="schedule-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('schedule-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="schedule-enabled" class="checkbox-with-margin">
                                    ÂêØÁî®ÂÆöÊó∂ÂèëÂ∏É
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåËßíËâ≤‰ºöÂú®ÊåáÂÆöÊó∂Èó¥ÁÇπËá™Âä®ÂèëÂ∏ÉÁ§æ‰∫§Âä®ÊÄÅ
                                </p>
                            </div>
                            <div class="form-group hide" id="schedule-times-group">
                                <label class="form-label">ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ</label>
                                <div id="schedule-times-container">
                                    <!-- Êó∂Èó¥ÁÇπÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÊ∑ªÂä† -->
                                </div>
                                <button type="button" class="form-button form-button-secondary" onclick="addScheduleTime()">+ Ê∑ªÂä†Êó∂Èó¥ÁÇπ</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('schedule-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveScheduleSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ë∫´‰ªΩÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
                <div class="modal" id="identity-selector-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÈÄâÊã©ËÅäÂ§©Ë∫´‰ªΩ</div>
                            <button class="modal-close" onclick="hideModal('identity-selector-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="identity-selector-list">
                                <!-- Ë∫´‰ªΩÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            <p class="small-text margin-top-15">
                                ÈÄâÊã©ÁöÑË∫´‰ªΩ‰ºöÂΩ±ÂìçÊ≠§ËÅäÂ§©Á™óÂè£‰∏≠ÊòæÁ§∫ÁöÑÂ§¥ÂÉèÂíåÊòµÁß∞Ôºå‰∏ç‰ºöÂΩ±ÂìçÂéüÂßãÈù¢ÂÖ∑ËÆæÁΩÆ
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('identity-selector-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveChatIdentity()">Á°ÆÂÆö</button>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="worldbook-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('worldbook-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="worldbook-mount-enabled" class="checkbox-with-margin">
                                    ÂêØÁî®‰∏ñÁïå‰π¶ÊåÇËΩΩ
                                </label>
                                <p class="small-text margin-top-5">
                                    ÂºÄÂêØÂêéÔºåAI‰ºöÂèÇËÄÉÈÄâÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫ËÉåÊôØÁü•ËØÜËøõË°åÂØπËØù
                                </p>
                            </div>
                            <div class="form-group hide" id="worldbook-mount-details">
                                <label class="form-label">ÈÄâÊã©Ë¶ÅÊåÇËΩΩÁöÑ‰∏ñÁïå‰π¶</label>
                                <div id="worldbook-mount-list" class="max-height-300-auto">
                                    <!-- ‰∏ñÁïå‰π¶ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                                </div>
                                <p class="small-text margin-top-8">
                                    ÈÄâÊã©ÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰ºö‰Ωú‰∏∫ËÉåÊôØÁü•ËØÜÊèê‰æõÁªôAIÂèÇËÄÉÔºåÂ∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÁêÜËß£ÂØπËØù‰∏ä‰∏ãÊñá
                                </p>
                            </div>
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>ÂäüËÉΩËØ¥ÊòéÔºö</strong><br>
                                    ‚Ä¢ <strong>‰∏ñÁïå‰π¶ÊåÇËΩΩÔºö</strong>Â∞ÜÈÄâÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰Ωú‰∏∫AIÁöÑËÉåÊôØÁü•ËØÜ<br>
                                    ‚Ä¢ <strong>Â§öÈÄâÊîØÊåÅÔºö</strong>ÂèØ‰ª•ÂêåÊó∂ÊåÇËΩΩÂ§ö‰∏™‰∏ñÁïå‰π¶ÔºåÂÜÖÂÆπ‰ºöÂêàÂπ∂‰ΩøÁî®<br>
                                    ‚Ä¢ <strong>Êô∫ËÉΩÂ∫îÁî®Ôºö</strong>AI‰ºöÊ†πÊçÆÂØπËØùÂÜÖÂÆπÊô∫ËÉΩÂºïÁî®Áõ∏ÂÖ≥ÁöÑ‰∏ñÁïå‰π¶Áü•ËØÜ<br>
                                    ‚Ä¢ <strong>‰ºòÂÖàÁ∫ßÔºö</strong>‰∏ñÁïå‰π¶Áü•ËØÜ‰ºòÂÖàÁ∫ß‰Ωé‰∫éËßíËâ≤ËÆæÂÆöÂíåÂéÜÂè≤ÂØπËØù
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('worldbook-mount-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveWorldbookMountSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>

                <!-- Êó∂Èó¥Êà≥ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div class="modal" id="timestamp-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">Êó∂Èó¥Êà≥ËÆæÁΩÆ</div>
                            <button class="modal-close" onclick="hideModal('timestamp-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="timestamp-modal-enabled" class="checkbox-with-margin" checked>
                                    ÊòæÁ§∫Êó∂Èó¥Êà≥
                                </label>
                                <p class="small-text margin-top-5">
                                    Âú®ËÅäÂ§©Ê∂àÊÅØ‰∏≠ÊòæÁ§∫Êó∂Èó¥‰ø°ÊÅØ
                                </p>
                            </div>
                            
                            <div class="form-group" id="timestamp-options-group">
                                <label class="form-label">Êó∂Èó¥Êà≥‰ΩçÁΩÆ</label>
                                <div class="timestamp-position-options">
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="center" checked>
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Â±Ö‰∏≠ÊòæÁ§∫</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®ËÅäÂ§©‰∏≠Èó¥ÔºåÊØè5ÂàÜÈíüÂá∫Áé∞‰∏ÄÊ¨°</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="bubble">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Ê∞îÊ≥°Â§ñ‰æß</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®ÊØèÊù°Ê∂àÊÅØÊ∞îÊ≥°ÁöÑÂ§ñ‰æß</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="avatar">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Â§¥ÂÉè‰∏ãÊñπ</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®Â§¥ÂÉèÊ≠£‰∏ãÊñπ‰ΩçÁΩÆ</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="inside">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">Ê∞îÊ≥°ÂÜÖ</div>
                                            <div class="option-desc">Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®Ê∞îÊ≥°ÂÜÖÂè≥‰∏ãËßíÔºå‰∏éÊñáÂ≠óÈΩêÂπ≥</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>‰ΩçÁΩÆËØ¥ÊòéÔºö</strong><br>
                                    ‚Ä¢ <strong>Â±Ö‰∏≠ÊòæÁ§∫Ôºö</strong>Êó∂Èó¥Êà≥Ê∞¥Âπ≥Â±Ö‰∏≠Ôºå‰ªÖÂú®Ë∂ÖËøá5ÂàÜÈíüÈó¥ÈöîÊó∂ÊòæÁ§∫<br>
                                    ‚Ä¢ <strong>Ê∞îÊ≥°Â§ñ‰æßÔºö</strong>ÊØèÊù°Ê∂àÊÅØÈÉΩÊòæÁ§∫Êó∂Èó¥ÔºåÁî®Êà∑Ê∂àÊÅØÂú®Â∑¶‰∏ãËßíÔºåËßíËâ≤Ê∂àÊÅØÂú®Âè≥‰∏ãËßí<br>
                                    ‚Ä¢ <strong>Â§¥ÂÉè‰∏ãÊñπÔºö</strong>Êó∂Èó¥Êà≥ÊòæÁ§∫Âú®ÂØπÂ∫îÂ§¥ÂÉèÁöÑÊ≠£‰∏ãÊñπ‰ΩçÁΩÆ<br>
                                    ‚Ä¢ ÊâÄÊúâÊó∂Èó¥Êà≥Âùá‰ΩøÁî®ÁÅ∞Ëâ≤Â∞èÂ≠óÊòæÁ§∫Ôºå‰∏çÂΩ±ÂìçËÅäÂ§©‰ΩìÈ™å
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('timestamp-settings-modal')">ÂèñÊ∂à</button>
                            <button class="modal-button modal-primary" onclick="saveTimestampSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let characters = [];
        let contacts = [];
        let currentChatCharacter = null;
        let chatMessages = {};
        let selectedMessageId = null;
        let personas = []; // Áî®Êà∑Èù¢ÂÖ∑ÂàóË°®
        let currentPersona = null; // ÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑
        let editingPersona = null; // Ê≠£Âú®ÁºñËæëÁöÑÈù¢ÂÖ∑
        let isMultiSelectMode = false; // Â§öÈÄâÊ®°ÂºèÁä∂ÊÄÅ
        let selectedCharacters = []; // ÈÄâ‰∏≠ÁöÑËßíËâ≤IDÂàóË°®
        let currentEditingCharacterId = null; // ÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑËßíËâ≤ID
        let groupChats = []; // Áæ§ËÅäÂàóË°®
        let selectedGroupMembers = []; // Áæ§ËÅäÊàêÂëòÈÄâÊã©
        
        // Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÁõ∏ÂÖ≥ÂèòÈáè
        let customEmojis = []; // Áî®Êà∑‰∏ä‰º†ÁöÑË°®ÊÉÖÂåÖ
        let recentEmojis = []; // ÊúÄËøë‰ΩøÁî®ÁöÑË°®ÊÉÖÂåÖ
        let currentEmojiTab = 'recent'; // ÂΩìÂâçË°®ÊÉÖÂåÖÊ†áÁ≠æÈ°µ
        
        // Ê∂àÊÅØÂ§öÈÄâÂà†Èô§Áõ∏ÂÖ≥ÂèòÈáè
        let isMessageSelectionMode = false; // Ê∂àÊÅØÈÄâÊã©Ê®°Âºè
        let selectedMessages = new Set(); // ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØIDÈõÜÂêà
        
        let apiSettings = {
            type: 'openai',
            base: 'https://api.openai.com/v1',
            endpoint: '/chat/completions',
            key: '',
            model: 'gpt-3.5-turbo',
            temperature: 0.7
        };
        
        // Ê≥®ÊÑèÔºöËÆ∞ÂøÜËÆæÁΩÆÁé∞Âú®Â∑≤Êîπ‰∏∫ÊØè‰∏™ËÅäÂ§©Á™óÂè£Áã¨Á´ãÁöÑËÆæÁΩÆÔºåÂ≠òÂÇ®Âú®ÂêÑËá™ÁöÑËÅäÂ§©ËÆæÁΩÆ‰∏≠
        
        let chatSettings = {
            themeColor: '#007AFF',
            theirBubbleColor: '#f0f0f0',
            myBubbleColor: '#007AFF',
            bubbleOpacity: 1,
            timestampEnabled: true,
            timestampPosition: 'center'
        };
        
        let photos = [];
        let selectedAppIcon = null;
        let selectedWallpaper = null;
        let colorPickerContext = null;
        let customIconImage = null;
        
        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            loadCharacters();
            loadContacts();
            loadChatMessages();
            loadPhotos();
            loadChatSettings();
            loadWallpaper();
            loadAppIcons();
            loadApiSettings();
            loadSavedTheme();
            loadWorldbooks();
            loadMusicData();
            loadPersonas(); // Âä†ËΩΩÈù¢ÂÖ∑Êï∞ÊçÆ
            // loadMemorySettings(); // ËÆ∞ÂøÜËÆæÁΩÆÁé∞Âú®Â≠òÂÇ®Âú®ÂêÑ‰∏™ËÅäÂ§©ÁöÑÁã¨Á´ãËÆæÁΩÆ‰∏≠
            loadGroupChats(); // Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ
            loadCustomEmojis(); // Âä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖ
            
            renderMessageList();
            renderContactList();
            renderCharacterList();
            renderAlbum();
            renderPersonaList(); // Ê∏≤ÊüìÈù¢ÂÖ∑ÂàóË°®
            
            // ÂàùÂßãÂåñÊó∂ËÆæÁΩÆÊ≠£Á°ÆÁöÑÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ - Âª∂ËøüÊâßË°åÁ°Æ‰øùDOMÂä†ËΩΩÂÆåÊàê
            setTimeout(() => {
                switchWechatTab('message-list');
                initializeChatSettings(); // ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢
                updateWorldbookMountDisplay(); // Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫
            }, 100);
            
            // Ê∏©Â∫¶ÊªëÂùóÊòæÁ§∫
            document.getElementById('api-temperature').addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = this.value;
            });
            
            // GeminiÊ®°ÂûãÈÄâÊã©ÂêåÊ≠•
            document.getElementById('api-model-select').addEventListener('change', function() {
                document.getElementById('api-model').value = this.value;
            });
            
            // ÈÄèÊòéÂ∫¶ÊªëÂùóÊòæÁ§∫
            document.getElementById('opacity-slider').addEventListener('input', function() {
                document.getElementById('opacity-value').textContent = Math.round(this.value * 100) + '%';
            });
            
            // ÊåâEnterÈîÆÂèëÈÄÅÊ∂àÊÅØ
            document.getElementById('api-chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendApiMessage();
                }
            });
            
            // ÂàùÂßãÂåñÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
            initializeAvatarUpload();
            
            // ÂàùÂßãÂåñË°®ÊÉÖÂåÖ‰∏ä‰º†ÂäüËÉΩ
            initializeEmojiUpload();
            
            // ÂàùÂßãÂåñÊ∂àÊÅØÈÄâÊã©Ê®°ÂºèÁä∂ÊÄÅ
            isMessageSelectionMode = false;
            selectedMessages.clear();
            
            // ÂõæÁâá‰∏ä‰º†
            document.getElementById('image-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        sendImageMessage(event.target.result);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Ëá™ÂÆö‰πâÂ¢ôÁ∫∏‰∏ä‰º†
            document.getElementById('custom-wallpaper-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        selectedWallpaper = event.target.result;
                        // Á´ãÂç≥È¢ÑËßà
                        document.querySelector('.wallpaper').style.backgroundImage = `url(${selectedWallpaper})`;
                        document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                        document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                        // ‰∏çÂú®ËøôÈáå‰øùÂ≠òÔºåÁ≠âÁî®Êà∑ÁÇπÂáªÂ∫îÁî®Êó∂ÂÜç‰øùÂ≠ò
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Ëá™ÂÆö‰πâÂõæÊ†á‰∏ä‰º†
            document.getElementById('custom-icon-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        customIconImage = event.target.result;
                        // Êõ¥Êñ∞È¢ÑËßà
                        const previews = document.querySelectorAll('.icon-preview');
                        previews.forEach(preview => {
                            preview.style.backgroundImage = `url(${customIconImage})`;
                            preview.innerHTML = ''; // ÁßªÈô§ÂõæÊ†á
                        });
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            setInterval(updateTime, 1000);
            initBatteryManager();
        });
        
        // ÊòæÁ§∫/ÈöêËóèÂ∫îÁî®
        function showApp(appId) {
            event.preventDefault();
            document.getElementById(appId).style.display = 'flex';
            
            // Â¶ÇÊûúÊòØËÅäÂ§©ÁïåÈù¢ÔºåÂà∑Êñ∞Ê∂àÊÅØÂàóË°®
            if (appId === 'chat-screen') {
                renderMessageList();
            }
            // Â¶ÇÊûúÊòØÁõ∏ÂÜåÁïåÈù¢ÔºåÂà∑Êñ∞Áõ∏ÂÜå
            else if (appId === 'album-screen') {
                renderAlbum();
            }
        }
        

        
        // ÈöêËóèËßíËâ≤ÂàõÂª∫Ë°®ÂçïÔºåËøîÂõûÂà∞chatÁïåÈù¢ÁöÑÈÄöËÆØÂΩï
        function hideCharacterForm() {
            // Âú®ÈöêËóèË°®ÂçïÊó∂Ê∏ÖÁ©∫Ë°®ÂçïÊï∞ÊçÆ
            clearCharacterForm();
            
            hideApp('character-form-screen');
            showApp('chat-screen');
            switchWechatTab('contact-list');
            // ÊâãÂä®Ëß¶ÂèëÊ†áÁ≠æÂàáÊç¢ÁöÑÊ†∑Âºè
            document.querySelectorAll('.wechat-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.wechat-tab')[1].classList.add('active'); // ÈÄöËÆØÂΩïÊòØÁ¨¨‰∫å‰∏™Ê†áÁ≠æ
        }
        
        function hideApp(appId) {
            document.getElementById(appId).style.display = 'none';
        }
        
        // ÊòæÁ§∫/ÈöêËóèÊ®°ÊÄÅÊ°Ü
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            
            // Â¶ÇÊûúÊòØÊ∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°ÜÔºåÊ∏≤ÊüìÂèØÈÄâËÅîÁ≥ª‰∫∫
            if (modalId === 'add-contact-modal') {
                renderContactModal();
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // ÂàáÊç¢ÂæÆ‰ø°Ê†áÁ≠æ
        function switchWechatTab(tabId) {
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑactiveÁ±ª
            document.querySelectorAll('.wechat-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ê∑ªÂä†ÂΩìÂâçÊ†áÁ≠æÁöÑactiveÁ±ª
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâeventÂØπË±°ÔºåÊ†πÊçÆtabIdËÆæÁΩÆactive
                if (tabId === 'message-list') {
                    const messageTab = document.getElementById('message-tab');
                    if (messageTab) {
                        messageTab.classList.add('active');
                    }
                } else if (tabId === 'contact-list') {
                    const tabs = document.querySelectorAll('.wechat-tab');
                    if (tabs.length > 1) {
                        tabs[1].classList.add('active');
                    }
                } else if (tabId === 'profile-page') {
                    const tabs = document.querySelectorAll('.wechat-tab');
                    if (tabs.length > 2) {
                        tabs[2].classList.add('active');
                    }
                }
            }
            
            // ÈöêËóèÊâÄÊúâÂÜÖÂÆπ
            const messageListEl = document.getElementById('message-list');
            const contactListEl = document.getElementById('contact-list');
            const profilePageEl = document.getElementById('profile-page');
            const targetEl = document.getElementById(tabId);
            
            if (messageListEl) messageListEl.style.display = 'none';
            if (contactListEl) contactListEl.style.display = 'none';
            if (profilePageEl) profilePageEl.style.display = 'none';
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÂÜÖÂÆπ
            if (targetEl) targetEl.style.display = 'block';
            
            // ÊéßÂà∂Âä†Âè∑ÊåâÈíÆÊòæÁ§∫
            const addContactBtn = document.getElementById('add-contact-btn');
            const addChatBtn = document.getElementById('add-chat-btn');
            
            if (addContactBtn && addChatBtn) {
                if (tabId === 'contact-list') {
                    addContactBtn.style.display = 'flex';
                    addChatBtn.style.display = 'none';
                } else if (tabId === 'message-list') {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'flex';
                } else {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'none';
                }
            }
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            // Êõ¥Êñ∞Áä∂ÊÄÅÊ†èÊó∂Èó¥
            const statusTime = document.getElementById('status-bar-time');
            if (statusTime) {
                statusTime.textContent = timeString;
            }
            
            // Êõ¥Êñ∞Â∫îÁî®ÂÜÖÁä∂ÊÄÅÊ†èÊó∂Èó¥
            const appStatusTimes = document.querySelectorAll('.app-status-time');
            appStatusTimes.forEach(element => {
                element.textContent = timeString;
            });
            
            // Êõ¥Êñ∞‰∏ªÊó∂Èíü
            const mainTime = document.getElementById('main-time');
            if (mainTime) {
                mainTime.textContent = timeString;
            }
            
            // Êõ¥Êñ∞Êó•Êúü
            const mainDate = document.getElementById('main-date');
            if (mainDate) {
                const date = now.toLocaleDateString('zh-CN', { 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                });
                mainDate.textContent = date;
            }
        }
        
        // Âä†ËΩΩËßíËâ≤Êï∞ÊçÆ
        function loadCharacters() {
            const savedCharacters = localStorage.getItem('characters');
            if (savedCharacters) {
                characters = JSON.parse(savedCharacters);
            } else {
                // ÈªòËÆ§‰∏∫Á©∫Êï∞ÁªÑÔºåÁî®Êà∑ÈúÄË¶ÅËá™Â∑±ÂàõÂª∫ËßíËâ≤
                characters = [];
                saveCharacters();
            }
        }
        
        // ‰øùÂ≠òËßíËâ≤Êï∞ÊçÆ
        function saveCharacters() {
            console.log('‰øùÂ≠òËßíËâ≤Êï∞ÊçÆÂà∞localStorage:', characters);
            localStorage.setItem('characters', JSON.stringify(characters));
            
            // È™åËØÅ‰øùÂ≠òÊòØÂê¶ÊàêÂäü
            const saved = localStorage.getItem('characters');
            const parsed = JSON.parse(saved);
            console.log('‰øùÂ≠òÈ™åËØÅ - localStorage‰∏≠ÁöÑÊï∞ÊçÆ:', parsed);
        }
        
        // Âä†ËΩΩËÅîÁ≥ª‰∫∫Êï∞ÊçÆ
        function loadContacts() {
            const savedContacts = localStorage.getItem('contacts');
            if (savedContacts) {
                contacts = JSON.parse(savedContacts);
            } else {
                // ÈªòËÆ§‰∏∫Á©∫ËÅîÁ≥ª‰∫∫ÂàóË°®
                contacts = [];
                saveContacts();
            }
        }
        
        // ‰øùÂ≠òËÅîÁ≥ª‰∫∫Êï∞ÊçÆ
        function saveContacts() {
            localStorage.setItem('contacts', JSON.stringify(contacts));
        }
        
        // Âä†ËΩΩËÅäÂ§©Ê∂àÊÅØ
        function loadChatMessages() {
            const savedMessages = localStorage.getItem('chatMessages');
            if (savedMessages) {
                chatMessages = JSON.parse(savedMessages);
            } else {
                chatMessages = {};
            }
        }
        
        // ‰øùÂ≠òËÅäÂ§©Ê∂àÊÅØ
        function saveChatMessages() {
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
        }
        
        // Âä†ËΩΩÁÖßÁâá
        function loadPhotos() {
            const savedPhotos = localStorage.getItem('photos');
            if (savedPhotos) {
                photos = JSON.parse(savedPhotos);
            } else {
                photos = [];
            }
        }
        
        // ‰øùÂ≠òÁÖßÁâá
        function savePhotos() {
            localStorage.setItem('photos', JSON.stringify(photos));
        }
        
        // Âä†ËΩΩËÅäÂ§©ËÆæÁΩÆ
        function loadChatSettings() {
            const savedSettings = localStorage.getItem('chatSettings');
            if (savedSettings) {
                chatSettings = JSON.parse(savedSettings);
            }
        }
        
        // ‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆ
        function saveChatSettings() {
            localStorage.setItem('chatSettings', JSON.stringify(chatSettings));
        }
        
        // Âä†ËΩΩÂ¢ôÁ∫∏
        function loadWallpaper() {
            const savedWallpaper = localStorage.getItem('wallpaper');
            const wallpaperType = localStorage.getItem('wallpaperType');
            
            if (savedWallpaper) {
                selectedWallpaper = savedWallpaper;
                
                if (wallpaperType === 'image' && savedWallpaper.startsWith('data:image')) {
                    // Âä†ËΩΩ‰∏ä‰º†ÁöÑÂõæÁâá
                    document.querySelector('.wallpaper').style.backgroundImage = `url(${savedWallpaper})`;
                } else if (wallpaperType === 'gradient' || savedWallpaper.startsWith('linear-gradient')) {
                    // Âä†ËΩΩÊ∏êÂèòËÉåÊôØ
                    document.querySelector('.wallpaper').style.backgroundImage = savedWallpaper;
                } else {
                    // Âä†ËΩΩÁ∫ØËâ≤ËÉåÊôØ
                    document.querySelector('.wallpaper').style.backgroundColor = savedWallpaper;
                    document.querySelector('.wallpaper').style.backgroundImage = 'none';
                }
                
                document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                document.querySelector('.wallpaper').style.backgroundPosition = 'center';
            }
        }
        
        // Âä†ËΩΩÂ∫îÁî®ÂõæÊ†á
        function loadAppIcons() {
            const savedIcons = localStorage.getItem('appIcons');
            if (savedIcons) {
                const icons = JSON.parse(savedIcons);
                Object.keys(icons).forEach(appId => {
                    const iconElement = document.querySelector(`.app[onclick="showApp('${appId}')"] .app-icon i`);
                    if (iconElement) {
                        iconElement.className = icons[appId];
                    }
                });
            }
        }
        
        // Âä†ËΩΩAPIËÆæÁΩÆ
        function loadApiSettings() {
            const savedSettings = localStorage.getItem('apiSettings');
            if (savedSettings) {
                apiSettings = JSON.parse(savedSettings);
                
                // Êõ¥Êñ∞Ë°®ÂçïÊòæÁ§∫
                if (document.getElementById('api-type')) {
                    const apiType = apiSettings.type || 'openai';
                    document.getElementById('api-type').value = apiType;
                    document.getElementById('api-base').value = apiSettings.base || (apiType === 'gemini' ? 'https://generativelanguage.googleapis.com/v1beta' : 'https://api.openai.com/v1');
                    document.getElementById('api-endpoint').value = apiSettings.endpoint || '/chat/completions';
                    document.getElementById('api-key').value = apiSettings.key || '';
                    
                    // Â§ÑÁêÜÊ®°ÂûãËÆæÁΩÆ
                    if (apiType === 'gemini') {
                        document.getElementById('api-model-select').value = apiSettings.model || 'gemini-2.0-flash-exp';
                        document.getElementById('api-model').value = apiSettings.model || 'gemini-2.0-flash-exp';
                    } else {
                        document.getElementById('api-model').value = apiSettings.model || 'gpt-3.5-turbo';
                    }
                    
                    document.getElementById('api-temperature').value = apiSettings.temperature || 0.7;
                    document.getElementById('temperature-value').textContent = apiSettings.temperature || 0.7;
                    
                    // Â§ÑÁêÜÊúÄÂ§ßtokenÊï∞ËÆæÁΩÆ

                    
                    // Ëß¶ÂèëAPIÁ±ªÂûãÂèòÂåñÂ§ÑÁêÜÔºåÁ°Æ‰øùÁïåÈù¢Ê≠£Á°ÆÊòæÁ§∫
                    onApiTypeChange();
                }
            } else {
                            // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑËÆæÁΩÆÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº
            apiSettings = {
                type: 'gemini',
                base: 'https://generativelanguage.googleapis.com/v1beta',
                endpoint: '/chat/completions',
                key: '',
                model: 'gemini-2.0-flash-exp',
                temperature: 0.7
            };
            
            // Á°Æ‰øùÁïåÈù¢ÂÖÉÁ¥†Ê≠£Á°ÆÊòæÁ§∫
            if (document.getElementById('api-type')) {
                document.getElementById('api-type').value = 'gemini';
                document.getElementById('api-base').value = 'https://generativelanguage.googleapis.com/v1beta';
                document.getElementById('api-endpoint').value = '/chat/completions';
                document.getElementById('api-key').value = '';
                document.getElementById('api-model').value = 'gemini-2.0-flash-exp';
                document.getElementById('api-temperature').value = 0.7;
                document.getElementById('temperature-value').textContent = '0.7';
                
                // Ëß¶ÂèëAPIÁ±ªÂûãÂèòÂåñÂ§ÑÁêÜ
                onApiTypeChange();
            }
            }
        }
        
        // ‰øùÂ≠òÂ∫îÁî®ÂõæÊ†á
        function saveAppIcons() {
            const icons = {
                'chat-screen': 'fas fa-comment-dots',
                'weibo-screen': 'fab fa-weibo',
                'music-screen': 'fas fa-music',
                'album-screen': 'fas fa-images',
                'characters-screen': 'fas fa-user-friends',
                'shop-screen': 'fas fa-shopping-bag',
                'settings-screen': 'fas fa-cog'
            };
            
            if (selectedAppIcon) {
                icons[selectedAppIcon.appId] = selectedAppIcon.iconClass;
            }
            
            localStorage.setItem('appIcons', JSON.stringify(icons));
            
            // Âà∑Êñ∞ÂõæÊ†áÊòæÁ§∫
            loadAppIcons();
        }
        
        // Ê∏≤ÊüìÊ∂àÊÅØÂàóË°®
        function renderMessageList() {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';
            
            // Ê∏≤ÊüìÂçï‰∫∫ËÅäÂ§©
            contacts.forEach(contactId => {
                const character = characters.find(c => c.id === contactId);
                if (character) {
                    // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñËØ•ËÅäÂ§©ÁöÑÊòµÁß∞ËÆæÁΩÆ
                    const savedSettings = localStorage.getItem(`chatSettings_${character.id}`);
                    const chatSettings = savedSettings ? JSON.parse(savedSettings) : {};
                    const displayName = chatSettings.aiChatNickname || character.name;
                    
                    const messages = chatMessages[character.id] || [];
                    const lastMessage = messages.length > 0 ? messages[messages.length - 1].content : 'ÊöÇÊó†Ê∂àÊÅØ';
                    const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : 'ÂàöÂàö';
                    
                    const messageItem = document.createElement('div');
                    messageItem.className = 'message-item';
                    messageItem.onclick = () => startChat(character);
                    
                    messageItem.innerHTML = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : displayName.charAt(0)}
                        </div>
                        <div class="message-content">
                            <div class="message-name">${displayName}</div>
                            <div class="message-preview">${lastMessage}</div>
                        </div>
                        <div class="message-time">${lastTime}</div>
                    `;
                    
                    messageList.appendChild(messageItem);
                }
            });
            
            // Ê∏≤ÊüìÁæ§ËÅä
            groupChats.forEach(group => {
                const messages = chatMessages[group.id] || [];
                const lastMessage = messages.length > 0 ? messages[messages.length - 1].content : 'ÊöÇÊó†Ê∂àÊÅØ';
                const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : 'ÂàöÂàö';
                
                const messageItem = document.createElement('div');
                messageItem.className = 'message-item';
                messageItem.onclick = () => startChat(group);
                
                messageItem.innerHTML = `
                    <div class="message-avatar avatar-group-green">
                        Áæ§
                    </div>
                    <div class="message-content">
                        <div class="message-name">${group.name} <span class="group-member-count">(${group.members ? group.members.length : 0}‰∫∫)</span></div>
                        <div class="message-preview">${lastMessage}</div>
                    </div>
                    <div class="message-time">${lastTime}</div>
                `;
                
                messageList.appendChild(messageItem);
            });
        }
        
        // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÂàóË°®
        function renderContactList() {
            const contactList = document.querySelector('#contact-list .contact-section');
            if (contactList) {
                // Ê∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπ
                contactList.innerHTML = '';
                
                // Ê∑ªÂä†Â§öÈÄâÊ®°ÂºèÁöÑÂ§¥ÈÉ®
                if (isMultiSelectMode) {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'multiselect-header';
                    headerDiv.innerHTML = `
                        <span>Â∑≤ÈÄâÊã© ${selectedCharacters.length} ‰∏™ËßíËâ≤</span>
                        <div>
                            <button onclick="deleteSelectedCharacters()" class="delete-btn-red">Âà†Èô§</button>
                            <button onclick="exitMultiSelectMode()" class="cancel-btn-blue">ÂèñÊ∂à</button>
                        </div>
                    `;
                    contactList.appendChild(headerDiv);
                }
                
                // Âè™Ê∏≤ÊüìËÅîÁ≥ª‰∫∫Ôºå‰∏çË¶Åsection-title
                contacts.forEach(contactId => {
                    const character = characters.find(c => c.id === contactId);
                    if (character) {
                        // üî•„Äê‰øÆÂ§ç„ÄëËé∑ÂèñËØ•ËÅîÁ≥ª‰∫∫ÁöÑÊòµÁß∞ËÆæÁΩÆ
                        const savedSettings = localStorage.getItem(`chatSettings_${character.id}`);
                        const chatSettings = savedSettings ? JSON.parse(savedSettings) : {};
                        const displayName = chatSettings.aiChatNickname || character.name;
                        
                        const contactItem = document.createElement('div');
                        contactItem.className = `contact-item ${isMultiSelectMode && selectedCharacters.includes(character.id) ? 'selected' : ''}`;
                        
                        // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÁÇπÂáª‰∫ã‰ª∂
                        if (isMultiSelectMode) {
                            contactItem.onclick = () => toggleCharacterSelection(character.id);
                        } else {
                            contactItem.onclick = () => editCharacterFromContactList(character.id);
                            
                            // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂
                            let pressTimer;
                            contactItem.addEventListener('touchstart', (e) => {
                                pressTimer = setTimeout(() => {
                                    enterMultiSelectMode(character.id);
                                    e.preventDefault();
                                }, 800); // 800msÈïøÊåâ
                            });
                            
                            contactItem.addEventListener('touchend', () => {
                                clearTimeout(pressTimer);
                            });
                            
                            contactItem.addEventListener('touchmove', () => {
                                clearTimeout(pressTimer);
                            });
                            
                            // Âè≥ÈîÆÁÇπÂáªËøõÂÖ•Â§öÈÄâÊ®°ÂºèÔºàÊ°åÈù¢Á´ØÔºâ
                            contactItem.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                enterMultiSelectMode(character.id);
                            });
                        }
                        
                        contactItem.innerHTML = `
                            ${isMultiSelectMode ? `
                                <div class="selection-checkbox ${selectedCharacters.includes(character.id) ? 'selected' : ''}">
                                    ${selectedCharacters.includes(character.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                                </div>
                            ` : ''}
                            <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                                ${character.avatarUrl ? '' : displayName.charAt(0)}
                            </div>
                            <div class="contact-info">
                                <div class="message-name">${displayName}</div>
                                <div class="character-preview">${character.bio || 'ÊöÇÊó†‰∫∫ËÆæÊèèËø∞'}</div>
                            </div>
                        `;
                        
                        contactList.appendChild(contactItem);
                    }
                });
                
                // Â¶ÇÊûúÊ≤°ÊúâËßíËâ≤ÔºåÊòæÁ§∫ÊèêÁ§∫
                if (contacts.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-message';
                    emptyDiv.textContent = 'ËøòÊ≤°ÊúâËßíËâ≤ÔºåÁÇπÂáªÂè≥‰∏äËßí+Âè∑ÂàõÂª∫ËßíËâ≤ÂêßÔºÅ';
                    contactList.appendChild(emptyDiv);
                }
            }
        }
        
        // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
        function renderCharacterList() {
            const characterList = document.getElementById('character-list');
            // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®Â∞±Ë∑≥ËøáÔºàÂõ†‰∏∫Êàë‰ª¨Â∑≤ÁªèÂà†Èô§‰∫Ü‰∫∫Áâ©Â∫îÁî®Ôºâ
            if (!characterList) {
                console.log('character-listÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊ∏≤Êüì');
                return;
            }
            
            characterList.innerHTML = '';
            
            characters.forEach(character => {
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                characterItem.onclick = () => editCharacter(character.id);
                
                characterItem.innerHTML = `
                    <div class="character-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div class="character-info">
                        <div class="character-name">${character.name}</div>
                        <div class="character-bio">${character.bio}</div>
                    </div>
                `;
                
                characterList.appendChild(characterItem);
            });
        }
        
        // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü
        function renderContactModal() {
            const modalBody = document.getElementById('contact-modal-body');
            modalBody.innerHTML = '';
            
            characters.forEach(character => {
                // Âè™ÊòæÁ§∫Êú™Ê∑ªÂä†‰∏∫ËÅîÁ≥ª‰∫∫ÁöÑËßíËâ≤
                if (!contacts.includes(character.id)) {
                    const contactOption = document.createElement('div');
                    contactOption.className = 'contact-item';
                    
                    const checkboxId = `contact-${character.id}`;
                    
                    contactOption.innerHTML = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="character-info character-info-flex">
                            <div class="character-name">${character.name}</div>
                            <div class="character-bio">${character.bio}</div>
                        </div>
                        <input type="checkbox" id="${checkboxId}" class="contact-checkbox" value="${character.id}">
                    `;
                    
                    modalBody.appendChild(contactOption);
                }
            });
            
            if (modalBody.children.length === 0) {
                modalBody.innerHTML = '<p>Ê≤°ÊúâÂèØÊ∑ªÂä†ÁöÑËßíËâ≤ÔºåËØ∑ÂÖàÂàõÂª∫Êñ∞ËßíËâ≤„ÄÇ</p>';
            }
        }
        
        // ÂΩìÂâçÊòæÁ§∫ÁöÑÊ∂àÊÅØÊï∞ÈáèÈôêÂà∂
        let currentMessageOffset = 0;
        const MESSAGE_LIMIT = 50;
        
        // Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ
        function renderChatMessages(characterId, loadMore = false) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const allMessages = chatMessages[characterId] || [];
            const chatSettings = getCurrentChatSettings();
            
            if (!loadMore) {
                // ÈáçÊñ∞Ê∏≤ÊüìÊó∂Ê∏ÖÁ©∫ÂÆπÂô®Âπ∂ÈáçÁΩÆÂÅèÁßªÈáè
                messagesContainer.innerHTML = '';
                currentMessageOffset = Math.max(0, allMessages.length - MESSAGE_LIMIT);
            }
            
            // Â∫îÁî®ËÅäÂ§©ËÉåÊôØ
            applyChatBackground();
            
            // Â∫îÁî®Ê∞îÊ≥°Ê†∑Âºè
            applyBubbleStyle();
            
            // Â¶ÇÊûúÊ≤°ÊúâÊ∂àÊÅØÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅÊèêÁ§∫
            if (allMessages.length === 0) {
                const displayName = chatSettings.aiChatNickname || currentChatCharacter.name;
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-chat-state';
                emptyState.innerHTML = `
                    <div>ÂºÄÂßãÂíå ${displayName} ËÅäÂ§©Âêß</div>
                `;
                messagesContainer.appendChild(emptyState);
                return;
            }
            
            // Â¶ÇÊûú‰∏çÊòØÂä†ËΩΩÊõ¥Â§öÔºå‰∏îÊúâÊõ¥Â§öÂéÜÂè≤Ê∂àÊÅØÔºåÊòæÁ§∫"Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ"ÊåâÈíÆ
            if (!loadMore && currentMessageOffset > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-messages';
                loadMoreBtn.innerHTML = `
                    <div class="load-more-content">
                        <i class="fas fa-chevron-up"></i>
                        <span>Êü•ÁúãÂéÜÂè≤Ê∂àÊÅØ (${currentMessageOffset}Êù°)</span>
                    </div>
                `;
                loadMoreBtn.onclick = () => loadMoreMessages(characterId);
                messagesContainer.appendChild(loadMoreBtn);
            }
            
            // Ëé∑ÂèñË¶ÅÊòæÁ§∫ÁöÑÊ∂àÊÅØ
            const messagesToShow = loadMore ? 
                allMessages.slice(Math.max(0, currentMessageOffset - MESSAGE_LIMIT), currentMessageOffset) :
                allMessages.slice(currentMessageOffset);
            
            // Ëé∑ÂèñÊó∂Èó¥Êà≥ËÆæÁΩÆ
            const timestampEnabled = chatSettings.timestampEnabled !== false; // ÈªòËÆ§‰∏∫true
            const timestampPosition = chatSettings.timestampPosition || 'center';
            
            let lastTimestamp = 0;
            
            messagesToShow.forEach((message, index) => {
                // Â§ÑÁêÜÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÊà≥‰∏ÄÊà≥Ôºâ
                if (message.sender === 'system' && message.isPoke) {
                    const systemContainer = document.createElement('div');
                    systemContainer.className = 'poke-system-container';
                    
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'poke-system-message';
                    systemMessage.textContent = message.content;
                    
                    systemContainer.appendChild(systemMessage);
                    messagesContainer.appendChild(systemContainer);
                    return;
                }
                
                // Ê∑ªÂä†Â±Ö‰∏≠Êó∂Èó¥Êà≥ÔºàÂ¶ÇÊûúÂêØÁî®‰∏î‰ΩçÁΩÆ‰∏∫Â±Ö‰∏≠Ôºâ
                if (timestampEnabled && timestampPosition === 'center') {
                    const currentTime = new Date(message.timestamp);
                    const timeDiff = currentTime - lastTimestamp;
                    
                    // Â¶ÇÊûúË∑ùÁ¶ª‰∏äÊù°Ê∂àÊÅØË∂ÖËøá5ÂàÜÈíüÔºåÊòæÁ§∫Êó∂Èó¥Êà≥
                    if (index === 0 || timeDiff > 5 * 60 * 1000) {
                        const timestampDiv = document.createElement('div');
                        timestampDiv.className = 'timestamp timestamp-center';
                        timestampDiv.textContent = formatTimestamp(message.timestamp);
                        messagesContainer.appendChild(timestampDiv);
                        lastTimestamp = currentTime;
                    }
                }
                
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}`;
                messageContainer.dataset.messageId = message.id; // Ê∑ªÂä†Ê∂àÊÅØIDÊï∞ÊçÆÂ±ûÊÄß
                
                if (message.sender === 'received') {
                    const character = characters.find(c => c.id === characterId);
                    
                    // Ëé∑ÂèñÊòæÁ§∫Áî®ÁöÑÂ§¥ÂÉèÂíåÊòµÁß∞
                    const displayAvatar = chatSettings.aiChatAvatar || character.avatarUrl;
                    const displayName = chatSettings.aiChatNickname || character.name;
                    
                    // Ëé∑ÂèñÊ∞îÊ≥°Ê†∑Âºè
                    const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                    const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                    const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                    const bubblePadding = chatSettings.bubblePadding || '12';
                    
                    // üî• Â§ÑÁêÜÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                    let messageContent = '';
                    
                    if (message.type === 'voice_message') {
                        // ËØ≠Èü≥Ê∂àÊÅØ
                        messageContent = `
                            <div class="voice-message">
                                <i class="fas fa-microphone"></i>
                                <span class="voice-content">${message.content}</span>
                                <div class="voice-duration">0:05</div>
                            </div>
                        `;
                    } else if (message.type === 'ai_image') {
                        // AIÁîüÊàêÁöÑÂõæÁâá
                        messageContent = `
                            <div class="ai-image-container">
                                <img src="${message.image}" class="message-image" onclick="showImage('${message.image}')" alt="AIÁîüÊàêÁöÑÂõæÁâá">
                                <div class="image-description">${message.imageDescription || ''}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // ËΩ¨Ë¥¶Ê∂àÊÅØ
                        messageContent = `
                            <div class="transfer-message">
                                <i class="fas fa-dollar-sign"></i>
                                <div class="transfer-content">
                                    <div class="transfer-amount">¬•${message.amount}</div>
                                    <div class="transfer-note">${message.note || 'ËΩ¨Ë¥¶'}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                        const chatMode = chatSettings.chatMode || 'online';
                        let processedContent = message.content;
                        
                        if (chatMode === 'offline') {
                            processedContent = processOfflineContent(message.content);
                        }
                        
                        messageContent = processedContent;
                    }
                    
                    let avatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        avatarHtml = `
                            <div class="message-avatar" style="background-color: ${character.color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" onclick="pokeCharacter('${character.id}')" title="Êà≥‰∏ÄÊà≥">
                                ${displayAvatar ? '' : displayName.charAt(0)}
                                ${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    let bubbleHtml = `
                        <div class="message-bubble" style="background-color: ${bubbleColor}; opacity: ${bubbleOpacity}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                            ${messageContent}
                            ${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                            ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                        </div>
                    `;
                    
                    messageContainer.innerHTML = avatarHtml + bubbleHtml;
                } else {
                    // Ëé∑ÂèñÊàëÁöÑÊòæÁ§∫Â§¥ÂÉèÂíåÊ∞îÊ≥°Ê†∑Âºè
                    let myDisplayAvatar = chatSettings.myChatAvatar;
                    
                    // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆËÅäÂ§©Â§¥ÂÉèÔºåÂ∞ùËØï‰ΩøÁî®ÈÄâ‰∏≠Ë∫´‰ªΩÁöÑÂ§¥ÂÉè
                    if (!myDisplayAvatar && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona && selectedPersona.avatarUrl) {
                            myDisplayAvatar = selectedPersona.avatarUrl;
                        }
                    }
                    
                    const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                    const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                    const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                    const myBubblePadding = chatSettings.bubblePadding || '12';
                    
                    let myBubbleHtml = `
                        <div class="message-bubble" style="background-color: ${myBubbleColor}; opacity: ${myBubbleOpacity}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                            ${message.content}
                            ${message.image ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                            ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                        </div>
                    `;
                    
                    let myAvatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        myAvatarHtml = `
                            <div class="message-avatar" style="background-color: #007AFF; ${myDisplayAvatar ? `background-image: url(${myDisplayAvatar}); background-size: cover; background-position: center;` : ''}">
                                ${myDisplayAvatar ? '' : '<i class="fas fa-user"></i>'}
                                ${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                }
                
                messagesContainer.appendChild(messageContainer);
                
                // Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®Áî®‰∫éÂ§öÈÄâÂà†Èô§
                addMessageLongPressListener(messageContainer, message.id);
                
                // Ê∑ªÂä†Âè≥ÈîÆËèúÂçïÂäüËÉΩ
                const bubble = messageContainer.querySelector('.message-bubble');
                if (bubble) {
                    // Èº†Ê†áÂè≥ÈîÆÁÇπÂáª
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showMessageMenu(message.id, e);
                    });
                    
                    // ÁÇπÂáªÂõæÁâáÈ¢ÑËßà
                    bubble.onclick = (e) => {
                        if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                            showImage(e.target.src);
                        }
                    };
                }
            });
            
            // Ê∑ªÂä†Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫ÂÖÉÁ¥†Âà∞Ê∂àÊÅØÂ∫ïÈÉ®ÔºàÂàùÂßãÈöêËóèÔºâ
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `${chatSettings.aiChatNickname || currentChatCharacter.name}Ê≠£Âú®ËæìÂÖ•‰∏≠<span class="dots"></span>`;
            messagesContainer.appendChild(typingIndicator);
            
            // Â¶ÇÊûú‰∏çÊòØÂä†ËΩΩÊõ¥Â§öÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
            if (!loadMore) {
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }
        }
        
        // Âä†ËΩΩÊõ¥Â§öÂéÜÂè≤Ê∂àÊÅØ
        function loadMoreMessages(characterId) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const scrollHeight = messagesContainer.scrollHeight;
            const scrollTop = messagesContainer.scrollTop;
            
            // Êõ¥Êñ∞ÂÅèÁßªÈáè
            currentMessageOffset = Math.max(0, currentMessageOffset - MESSAGE_LIMIT);
            
            // Ê∏≤ÊüìÊõ¥Â§öÊ∂àÊÅØ
            renderChatMessages(characterId, true);
            
            // ‰øùÊåÅÊªöÂä®‰ΩçÁΩÆ
            setTimeout(() => {
                const newScrollHeight = messagesContainer.scrollHeight;
                messagesContainer.scrollTop = scrollTop + (newScrollHeight - scrollHeight);
            }, 50);
        }
        
        // Ê∏≤ÊüìÁõ∏ÂÜå
        function renderAlbum() {
            const albumGrid = document.getElementById('album-grid');
            albumGrid.innerHTML = '';
            
            photos.forEach(photo => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.style.backgroundImage = `url(${photo.image})`;
                albumItem.setAttribute('data-description', photo.description);
                albumItem.setAttribute('data-time', formatFullDate(new Date(photo.timestamp)));
                albumItem.onclick = () => showPhotoDetail(photo);
                albumGrid.appendChild(albumItem);
            });
        }
        
        // ÊòæÁ§∫ËßíËâ≤Ë°®Âçï
        function showCharacterForm(characterId = null) {
            currentEditingCharacterId = characterId; // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑËßíËâ≤ID
            document.getElementById('character-form-title').textContent = characterId ? 'ÁºñËæë‰∫∫Áâ©' : 'Êñ∞Âª∫‰∫∫Áâ©';
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';
            
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');
            
            // ÈáçÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            avatarPreviewText.style.display = 'block';
            avatarPreviewText.textContent = 'A';
            
            // Ê∏ÖÈô§‰∏¥Êó∂Â≠òÂÇ®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
            window.selectedAvatarData = null;
            
            // Â¶ÇÊûúÊòØÁºñËæëÊ®°ÂºèÔºåÂ°´ÂÖÖÁé∞ÊúâÊï∞ÊçÆ
            if (characterId) {
                const character = characters.find(c => c.id === characterId);
                if (character) {
                    document.getElementById('character-name').value = character.name;
                    document.getElementById('character-bio').value = character.bio;
                    
                    if (character.avatarUrl) {
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${character.avatarUrl})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        avatarPreviewText.style.display = 'none';
                        // ‰∏∫ÁºñËæëÊ®°Âºè‰øùÂ≠òÁé∞ÊúâÂ§¥ÂÉèÊï∞ÊçÆ
                        window.selectedAvatarData = character.avatarUrl;
                    } else {
                        avatarPreviewText.textContent = character.name.charAt(0);
                    }
                }
            }
            
            // ËÆæÁΩÆË°®ÂçïÁöÑ‰øùÂ≠òÂáΩÊï∞ÂíåÂà†Èô§ÊåâÈíÆÊòæÁ§∫
            const deleteBtn = document.getElementById('character-delete-btn');
            console.log('ËÆæÁΩÆ‰øùÂ≠òÊåâÈíÆÔºåcharacterId:', characterId);
            if (characterId) {
                document.querySelector('#character-form-screen .form-submit').onclick = () => saveCharacter(characterId);
                // ÁºñËæëÊ®°ÂºèÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
                if (deleteBtn) deleteBtn.style.display = 'block';
                console.log('ËÆæÁΩÆ‰∏∫ÁºñËæëÊ®°ÂºèÔºåËßíËâ≤ID:', characterId);
            } else {
                document.querySelector('#character-form-screen .form-submit').onclick = () => saveCharacter();
                // Êñ∞Âª∫Ê®°ÂºèÈöêËóèÂà†Èô§ÊåâÈíÆ
                if (deleteBtn) deleteBtn.style.display = 'none';
                console.log('ËÆæÁΩÆ‰∏∫ÂàõÂª∫Ê®°ÂºèÔºåÊó†ËßíËâ≤ID');
            }
            
            showApp('character-form-screen');
            
            // Á°Æ‰øùÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩÂèØÁî® - ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®Ôºà‰ª•Èò≤‰∏á‰∏ÄÔºâ
            setTimeout(() => {
                initializeAvatarUpload();
            }, 100);
        }
        
        // ‰øùÂ≠òËßíËâ≤
        function saveCharacter(characterId = null) {
            try {
                console.log('=== ÂºÄÂßã‰øùÂ≠òËßíËâ≤ ===');
                const name = document.getElementById('character-name').value.trim();
                const bio = document.getElementById('character-bio').value.trim();
                const avatarData = window.selectedAvatarData; // ‰ΩøÁî®È¢ÑÂ§ÑÁêÜÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                
                console.log('‰øùÂ≠òËßíËâ≤ - ÂßìÂêç:', name, 'Â§¥ÂÉèÊï∞ÊçÆÂ≠òÂú®:', !!avatarData);
                if (avatarData) {
                    console.log('Â§¥ÂÉèÊï∞ÊçÆÈïøÂ∫¶:', avatarData.length, 'ÂºÄÂ§¥:', avatarData.substring(0, 50));
                }
                
                if (!name) {
                    alert('ËØ∑ËæìÂÖ•ÂßìÂêç');
                    return;
                }
                
                if (characterId) {
                    console.log('=== Êõ¥Êñ∞Áé∞ÊúâËßíËâ≤ ===');
                    // Êõ¥Êñ∞Áé∞ÊúâËßíËâ≤
                    const index = characters.findIndex(c => c.id === characterId);
                    if (index !== -1) {
                        characters[index] = {
                            ...characters[index],
                            name,
                            bio,
                            avatarUrl: avatarData || characters[index].avatarUrl || '',
                            color: characters[index].color || getRandomColor()
                        };
                        
                        console.log('Êõ¥Êñ∞ËßíËâ≤ÂÆåÊàê:', characters[index]);
                        
                        // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞ÁïåÈù¢
                        saveCharacters();
                        renderCharacterList();
                        renderContactList();
                        renderMessageList();
                        hideCharacterForm();
                        // Ê≥®ÊÑèÔºö‰∏çÁ´ãÂç≥Ê∏ÖÁ©∫Ë°®ÂçïÔºåËÆ©Áî®Êà∑ËÉΩÁúãÂà∞‰øùÂ≠òÊàêÂäüÁöÑÁä∂ÊÄÅ
                    }
                } else {
                    console.log('=== ÂàõÂª∫Êñ∞ËßíËâ≤ ===');
                    // ÂàõÂª∫Êñ∞ËßíËâ≤
                    const newCharacter = {
                        id: Date.now().toString(),
                        name,
                        bio,
                        avatarUrl: avatarData || '',
                        color: getRandomColor()
                    };
                    
                    console.log('ÂàõÂª∫Êñ∞ËßíËâ≤:', newCharacter);
                    console.log('Êñ∞ËßíËâ≤Â§¥ÂÉèURL:', newCharacter.avatarUrl);
                    console.log('Êñ∞ËßíËâ≤Â§¥ÂÉèURLÈïøÂ∫¶:', newCharacter.avatarUrl ? newCharacter.avatarUrl.length : 0);
                    
                    console.log('Ê∑ªÂä†ËßíËâ≤ÂâçÔºåÂΩìÂâçËßíËâ≤Êï∞ÁªÑÈïøÂ∫¶:', characters.length);
                    characters.push(newCharacter);
                    console.log('Ê∑ªÂä†ËßíËâ≤ÂêéÔºåÂΩìÂâçËßíËâ≤Êï∞ÁªÑÈïøÂ∫¶:', characters.length);
                    
                    console.log('ËßíËâ≤Êï∞ÁªÑÊúÄÊñ∞Áä∂ÊÄÅ:', characters);
                    
                    // Ëá™Âä®Â∞ÜÊñ∞ÂàõÂª∫ÁöÑËßíËâ≤Ê∑ªÂä†Âà∞ËÅîÁ≥ª‰∫∫ÂàóË°®
                    if (!contacts.includes(newCharacter.id)) {
                        contacts.push(newCharacter.id);
                        saveContacts();
                        console.log('Êñ∞ËßíËâ≤Â∑≤Ëá™Âä®Ê∑ªÂä†Âà∞ËÅîÁ≥ª‰∫∫ÂàóË°®');
                    }
                    
                    // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞ÁïåÈù¢
                    console.log('ÂºÄÂßã‰øùÂ≠òÂà∞localStorage...');
                    saveCharacters();
                    console.log('‰øùÂ≠òÂêéÊ£ÄÊü•ËßíËâ≤Êï∞ÁªÑ:', characters);
                    
                    console.log('ÂºÄÂßãÊ∏≤ÊüìÁïåÈù¢...');
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                    
                    console.log('ÂºÄÂßãÈöêËóèË°®Âçï...');
                    hideCharacterForm();
                    // Ê≥®ÊÑèÔºö‰∏çÁ´ãÂç≥Ê∏ÖÁ©∫Ë°®ÂçïÔºåËÆ©Áî®Êà∑ËÉΩÁúãÂà∞‰øùÂ≠òÊàêÂäüÁöÑÁä∂ÊÄÅ
                    
                    // ÁªôÁî®Êà∑ÂèçÈ¶à
                    alert(`ËßíËâ≤ "${newCharacter.name}" ÂàõÂª∫ÊàêÂäüÔºÅ`);
                    
                    console.log('=== ‰øùÂ≠òËßíËâ≤ÂÆåÊàê ===');
                }
            } catch (error) {
                console.error('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ:', error);
                alert('‰øùÂ≠òËßíËâ≤Êó∂ÂèëÁîüÈîôËØØ: ' + error.message);
            }
        }
        
        // Ê∏ÖÁ©∫ËßíËâ≤Ë°®Âçï
        function clearCharacterForm() {
            console.log('Ê∏ÖÁ©∫ËßíËâ≤Ë°®ÂçïË¢´Ë∞ÉÁî®');
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';
            
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');
            
            // ÈáçÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            if (avatarPreviewText) {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = 'A';
            }
            
            // Ê∏ÖÈô§‰∏¥Êó∂Â≠òÂÇ®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
            console.log('Ê∏ÖÈô§‰∏¥Êó∂Â§¥ÂÉèÊï∞ÊçÆ');
            window.selectedAvatarData = null;
        }
        
        // ÁºñËæëËßíËâ≤
        function editCharacter(characterId) {
            showCharacterForm(characterId);
        }
        
        // ‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®ÁºñËæëËßíËâ≤
        function editCharacterFromContactList(characterId) {
            showCharacterForm(characterId);
        }
        
        // ËøõÂÖ•Â§öÈÄâÊ®°Âºè
        function enterMultiSelectMode(characterId) {
            isMultiSelectMode = true;
            selectedCharacters = [characterId]; // ÂàùÂßãÈÄâ‰∏≠Ëß¶ÂèëÈïøÊåâÁöÑËßíËâ≤
            renderContactList();
        }
        
        // ÈÄÄÂá∫Â§öÈÄâÊ®°Âºè
        function exitMultiSelectMode() {
            isMultiSelectMode = false;
            selectedCharacters = [];
            renderContactList();
        }
        
        // ÂàáÊç¢ËßíËâ≤ÈÄâÊã©Áä∂ÊÄÅ
        function toggleCharacterSelection(characterId) {
            const index = selectedCharacters.indexOf(characterId);
            if (index > -1) {
                selectedCharacters.splice(index, 1);
            } else {
                selectedCharacters.push(characterId);
            }
            renderContactList();
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑËßíËâ≤
        function deleteSelectedCharacters() {
            if (selectedCharacters.length === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËßíËâ≤');
                return;
            }
            
            const characterNames = selectedCharacters.map(id => {
                const character = characters.find(c => c.id === id);
                return character ? character.name : '';
            }).filter(name => name).join('„ÄÅ');
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∫õËßíËâ≤ÂêóÔºü\n${characterNames}\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                // Âà†Èô§ËßíËâ≤
                selectedCharacters.forEach(characterId => {
                    characters = characters.filter(c => c.id !== characterId);
                    contacts = contacts.filter(c => c !== characterId);
                    
                    // Âà†Èô§Áõ∏ÂÖ≥ËÅäÂ§©ËÆ∞ÂΩï
                    if (chatMessages[characterId]) {
                        delete chatMessages[characterId];
                    }
                });
                
                // ‰øùÂ≠òÊï∞ÊçÆ
                saveCharacters();
                saveContacts();
                saveChatMessages();
                
                // ÈÄÄÂá∫Â§öÈÄâÊ®°ÂºèÂπ∂Êõ¥Êñ∞ÁïåÈù¢
                exitMultiSelectMode();
                renderMessageList();
                
                alert('ËßíËâ≤Âà†Èô§ÊàêÂäü');
            }
        }
        
        // Âà†Èô§ÂΩìÂâçÁºñËæëÁöÑËßíËâ≤
        function deleteCurrentCharacter() {
            if (currentEditingCharacterId) {
                const character = characters.find(c => c.id === currentEditingCharacterId);
                
                if (character && confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ËßíËâ≤"${character.name}"ÂêóÔºü\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                    // Âà†Èô§ËßíËâ≤
                    characters = characters.filter(c => c.id !== character.id);
                    contacts = contacts.filter(c => c !== character.id);
                    
                    // Âà†Èô§Áõ∏ÂÖ≥ËÅäÂ§©ËÆ∞ÂΩï
                    if (chatMessages[character.id]) {
                        delete chatMessages[character.id];
                    }
                    
                    // ‰øùÂ≠òÊï∞ÊçÆ
                    saveCharacters();
                    saveContacts();
                    saveChatMessages();
                    
                    // Êõ¥Êñ∞ÁïåÈù¢Âπ∂ËøîÂõû
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                    hideCharacterForm();
                    
                    alert('ËßíËâ≤Âà†Èô§ÊàêÂäü');
                }
            }
        }
        
        // Ëé∑ÂèñÈöèÊú∫È¢úËâ≤
        function getRandomColor() {
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#5AC8FA', '#007AFF', '#5856D6', '#AF52DE'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // ÊòæÁ§∫Ê∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü
        function showAddContactModal() {
            showModal('add-contact-modal');
        }
        
        // Ê∑ªÂä†ÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫
        function addSelectedContacts() {
            const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
            checkboxes.forEach(checkbox => {
                const characterId = checkbox.value;
                if (!contacts.includes(characterId)) {
                    contacts.push(characterId);
                }
            });
            
            saveContacts();
            renderMessageList();
            renderContactList();
            hideModal('add-contact-modal');
        }
        
        // ÂºÄÂßã‰∏éËßíËâ≤ËÅäÂ§©
        function startChat(character) {
            currentChatCharacter = character;
            
            // üî•„Äê‰øÆÂ§ç„ÄëÊ£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑÊòµÁß∞ËÆæÁΩÆ
            const chatSettings = getCurrentChatSettings();
            const displayTitle = chatSettings.aiChatNickname || character.name;
            document.getElementById('api-chat-title').textContent = displayTitle;
            
            // ÂàùÂßãÂåñÁ©∫ÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰∏çËá™Âä®ÂèëÈÄÅÊ∂àÊÅØÔºâ
            if (!chatMessages[character.id]) {
                chatMessages[character.id] = [];
                saveChatMessages();
            }
            
            // ÈáçÁΩÆÊÇ¨ÊµÆÊåâÈíÆÁä∂ÊÄÅ
            resetFloatingButtonsState();
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂ¶ÇÊûúËÆæÁΩÆÁïåÈù¢ÊòØÊâìÂºÄÁöÑÔºåÊõ¥Êñ∞ËÆæÁΩÆÊòæÁ§∫Áä∂ÊÄÅ
            if (document.getElementById('api-chat-settings-screen').style.display === 'flex') {
                updateChatSettingsDisplay();
            }
            
            renderChatMessages(character.id);
            showApp('api-chat-screen');
        }
        
        // ÂèëÈÄÅAPIÊ∂àÊÅØ - ÂéüÊù•ÁöÑÁâàÊú¨ÔºàÂ∑≤Ë¢´Êñ∞ÁâàÊú¨Êõø‰ª£Ôºâ
        /*
        async function sendApiMessage() {
            const input = document.getElementById('api-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            const messageId = Date.now().toString();
            const userMessage = {
                id: messageId,
                sender: 'sent',
                content: message,
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(userMessage);
            saveChatMessages();
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            input.value = '';
            
            // Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages(currentChatCharacter.id);
            
            // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
            showTypingIndicator();
            
            // Ê∑ªÂä†1-3ÁßíÁöÑÈöèÊú∫Âª∂ËøüÔºåËÆ©ËÅäÂ§©Êõ¥ÁúüÂÆû
            const delay = Math.random() * 2000 + 1000; // 1-3Áßí
            await new Promise(resolve => setTimeout(resolve, delay));
            
            try {
                // Ë∞ÉÁî®API
                const response = await callChatAPI(message, currentChatCharacter);
                
                // Ëß£ÊûêAIÂõûÂ§çÔºàÂèØËÉΩÊòØJSONÊï∞ÁªÑÊ†ºÂºèÔºâ
                const aiMessages = parseAiResponse(response);
                
                // ÈöêËóèÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫
                hideTypingIndicator();
                
                // ÈÄêÊù°ÂèëÈÄÅÊ∂àÊÅØÔºåÊ®°ÊãüÁúüÂÆûËÅäÂ§©
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
                    if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', 
                            content: msgData.content, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image', 
                            content: '',
                            image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`,
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', 
                            amount: msgData.amount, 
                            note: msgData.note, 
                            timestamp: Date.now() + i * 100
                        };
                    } else {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: String(msgData), 
                            timestamp: Date.now() + i * 100
                        };
                    }
                    
                    // Ê∑ªÂä†Ê∂àÊÅØÂà∞Êï∞ÁªÑ
                    chatMessages[currentChatCharacter.id].push(aiMessage);
                    saveChatMessages();
                    
                    // Á´ãÂç≥Ê∏≤ÊüìËøôÊù°Êñ∞Ê∂àÊÅØ
                    renderChatMessages(currentChatCharacter.id);
                    
                    // Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÔºåÁ≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥ÂÜçÂèë‰∏ã‰∏ÄÊù°
                    if (i < aiMessages.length - 1) {
                        // ÊØèÊù°Ê∂àÊÅØÈó¥Èöî0.5-1.5ÁßíÔºåÊ®°ÊãüÁúüÂÆûÊâìÂ≠óÈÄüÂ∫¶
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        // Âú®ÂèëÈÄÅ‰∏ã‰∏ÄÊù°Ê∂àÊÅØÂâçÁü≠ÊöÇÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÔºàÂ¶ÇÊûúËøòÊúâÊõ¥Â§öÊ∂àÊÅØÔºâ
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('APIË∞ÉÁî®Â§±Ë¥•:', error);
                
                // Ê∑ªÂä†ÈîôËØØÊ∂àÊÅØ
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[Âá∫Èîô‰∫Ü: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[currentChatCharacter.id].push(errorMessage);
                saveChatMessages();
                hideTypingIndicator();
                renderChatMessages(currentChatCharacter.id);
            }
        }
        */
        
        // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
        function showTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.classList.add('show');
                // ÊªöÂä®Âà∞Â∫ïÈÉ®ÊòæÁ§∫ÊèêÁ§∫
                const messagesContainer = document.getElementById('api-chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        // ÈöêËóèÊ≠£Âú®ËæìÂÖ•ÊèêÁ§∫
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.classList.remove('show');
            }
        }
        
        // Ëß£ÊûêAIÂõûÂ§ç - ÊåâÁÖßindex.htmlÁöÑÈÄªËæëÔºåÊñ∞Â¢ûË°®ÊÉÖÂåÖÊîØÊåÅ
        function parseAiResponse(content) { 
            try { 
                const parsed = JSON.parse(content); 
                if (Array.isArray(parsed)) {
                    // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜË°®ÊÉÖÂåÖÊ∂àÊÅØÁ±ªÂûã
                    return parsed.map(item => {
                        if (typeof item === 'object' && item.type === 'emoji') {
                            // Êü•ÊâæÂåπÈÖçÁöÑË°®ÊÉÖÂåÖ
                            const matchingEmoji = customEmojis.find(emoji => 
                                emoji.description === item.description
                            );
                            
                            if (matchingEmoji) {
                                // ËøîÂõûË°®ÊÉÖÂåÖÂØπË±°ÔºåÂåÖÂê´ÂÆåÊï¥ÁöÑË°®ÊÉÖÂåÖ‰ø°ÊÅØ
                                return {
                                    type: 'emoji',
                                    url: matchingEmoji.url,
                                    description: matchingEmoji.description,
                                    id: matchingEmoji.id
                                };
                            } else {
                                // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÁöÑË°®ÊÉÖÂåÖÔºåËøîÂõûÈîôËØØÊ∂àÊÅØ
                                console.warn('AIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂåÖ:', item.description);
                                return `[ÈîôËØØ: Ë°®ÊÉÖÂåÖ"${item.description}"‰∏çÂ≠òÂú®]`;
                            }
                        }
                        return item;
                    });
                }
            } catch (e) {} 
            
            try { 
                const match = content.match(/\[(.*?)\]/s); 
                if (match && match[0]) { 
                    const parsed = JSON.parse(match[0]); 
                    if (Array.isArray(parsed)) {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜË°®ÊÉÖÂåÖÊ∂àÊÅØÁ±ªÂûã
                        return parsed.map(item => {
                            if (typeof item === 'object' && item.type === 'emoji') {
                                // Êü•ÊâæÂåπÈÖçÁöÑË°®ÊÉÖÂåÖ
                                const matchingEmoji = customEmojis.find(emoji => 
                                    emoji.description === item.description
                                );
                                
                                if (matchingEmoji) {
                                    // ËøîÂõûË°®ÊÉÖÂåÖÂØπË±°ÔºåÂåÖÂê´ÂÆåÊï¥ÁöÑË°®ÊÉÖÂåÖ‰ø°ÊÅØ
                                    return {
                                        type: 'emoji',
                                        url: matchingEmoji.url,
                                        description: matchingEmoji.description,
                                        id: matchingEmoji.id
                                    };
                                } else {
                                    // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÁöÑË°®ÊÉÖÂåÖÔºåËøîÂõûÈîôËØØÊ∂àÊÅØ
                                    console.warn('AIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂåÖ:', item.description);
                                    return `[ÈîôËØØ: Ë°®ÊÉÖÂåÖ"${item.description}"‰∏çÂ≠òÂú®]`;
                                }
                            }
                            return item;
                        });
                    }
                } 
            } catch (e) {} 
            
            const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```')); 
            if (lines.length > 0) return lines; 
            return [content]; 
        }
        
        // Â§ÑÁêÜÁ∫ø‰∏ãÊ®°ÂºèÂÜÖÂÆπÔºöËØÜÂà´„Äå„ÄçÂåÖË£πÁöÑÂØπËØùÂíåÊèèÂÜô
        function processOfflineContent(content) {
            if (!content) return '';
            
            // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂàÜÁ¶ªÂØπËØùÂíåÊèèÂÜô
            const parts = [];
            let lastIndex = 0;
            
            // ÂåπÈÖç„Äå„ÄçÂåÖË£πÁöÑÂØπËØù
            const dialogRegex = /„Äå([^„Äç]*)„Äç/g;
            let match;
            
            while ((match = dialogRegex.exec(content)) !== null) {
                // Ê∑ªÂä†ÂØπËØùÂâçÁöÑÊèèÂÜôÈÉ®ÂàÜ
                if (match.index > lastIndex) {
                    const description = content.slice(lastIndex, match.index).trim();
                    if (description) {
                        parts.push(`<span class="italic-gray">${description}</span>`);
                    }
                }
                
                // Ê∑ªÂä†ÂØπËØùÈÉ®ÂàÜÔºàÊ≠£Â∏∏ÊòæÁ§∫Ôºâ
                parts.push(`„Äå${match[1]}„Äç`);
                lastIndex = match.index + match[0].length;
            }
            
            // Ê∑ªÂä†ÊúÄÂêéÁöÑÊèèÂÜôÈÉ®ÂàÜ
            if (lastIndex < content.length) {
                const description = content.slice(lastIndex).trim();
                if (description) {
                    parts.push(`<span class="italic-gray">${description}</span>`);
                }
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂØπËØùÊ†áËÆ∞ÔºåÊï¥‰∏™ÂÜÖÂÆπ‰Ωú‰∏∫ÊèèÂÜôÂ§ÑÁêÜ
            if (parts.length === 0) {
                return `<span class="italic-gray">${content}</span>`;
            }
            
            return parts.join('');
        }
        
        // ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
        function sendImageMessage(imageUrl) {
            if (!currentChatCharacter) return;
            
            const messageId = Date.now().toString();
            const imageMessage = {
                id: messageId,
                sender: 'sent',
                content: '',
                image: imageUrl,
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(imageMessage);
            saveChatMessages();
            
            // Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages(currentChatCharacter.id);
            
            // ËÆæÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØÔºåÊîØÊåÅÊô∫ËÉΩÂõûÂ§çÊåâÈíÆ
            pendingUserMessage = imageMessage;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
        }
        
        // Ë∞ÉÁî®ËÅäÂ§©API
        // Á¨¨‰∏Ä‰∏™callChatAPIÂáΩÊï∞Â∑≤Âà†Èô§Ôºå‰ΩøÁî®‰∏ãÈù¢ÁöÑÂÆåÊï¥ÁâàÊú¨
        
        // ‰∏ä‰º†ÂõæÁâá
        function uploadImage() {
            document.getElementById('image-upload').click();
        }
        
        // ÊòæÁ§∫ÂõæÁâá
        function showImage(imageUrl) {
            const photo = photos.find(p => p.image === imageUrl);
            if (photo) {
                document.getElementById('photo-image').style.backgroundImage = `url(${imageUrl})`;
                document.getElementById('photo-description-text').textContent = photo.description;
                document.getElementById('photo-time').textContent = `ÊãçÊëÑ‰∫é: ${formatFullDate(new Date(photo.timestamp))}`;
                document.getElementById('photo-location').textContent = `Âú∞ÁÇπ: ${photo.location}`;
                showApp('photo-detail-screen');
            }
        }
        
        // ÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆ
        function showChatSettings() {
            console.log('ÊòæÁ§∫ËÅäÂ§©ËÆæÁΩÆË¢´Ë∞ÉÁî®');
            
            // ÂÖàÈöêËóèÂΩìÂâçÁöÑËÅäÂ§©ÁïåÈù¢
            hideApp('api-chat-screen');
            
            // ÊòæÁ§∫ËÆæÁΩÆÁïåÈù¢
            const element = document.getElementById('api-chat-settings-screen');
            if (element) {
                element.style.display = 'flex';
                element.style.position = 'absolute';
                element.style.top = '0';
                element.style.left = '0';
                element.style.width = '100%';
                element.style.height = '100%';
                element.style.zIndex = '1000';
                element.style.background = 'white';
                
                // ÈáçÊñ∞ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢‰ª•Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
                initializeChatSettings();
                
                // Êõ¥Êñ∞ÂêÑÁßçËÆæÁΩÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
                updateWorldbookMountDisplay();
                
                console.log('ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢Â∑≤ÊòæÁ§∫');
            } else {
                console.error('Êâæ‰∏çÂà∞api-chat-settings-screenÂÖÉÁ¥†');
                alert('ËÆæÁΩÆÁïåÈù¢Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        // ÈöêËóèËÅäÂ§©ËÆæÁΩÆ
        function hideChatSettings() {
            hideApp('api-chat-settings-screen');
            // ËøîÂõûÂà∞ËÅäÂ§©ÁïåÈù¢
            if (currentChatCharacter) {
                showApp('api-chat-screen');
            }
        }
        
        // ‰øÆÊîπËßíËâ≤Â§¥ÂÉè
        function changeCharacterAvatar() {
            // ‰∏¥Êó∂ÂàõÂª∫‰∏Ä‰∏™Êñá‰ª∂ËæìÂÖ•Ê°ÜÔºåÈÅøÂÖçÂπ≤Êâ∞ÂéüÊúâÁöÑÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
            const tempInput = document.createElement('input');
            tempInput.type = 'file';
            tempInput.accept = 'image/*';
            tempInput.style.display = 'none';
            document.body.appendChild(tempInput);
            
            tempInput.onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                        if (characterIndex !== -1) {
                            characters[characterIndex].avatarUrl = event.target.result;
                            saveCharacters();
                            renderCharacterList();
                            renderContactList();
                            renderMessageList();
                            renderChatMessages(currentChatCharacter.id);
                        }
                        // Ê∏ÖÁêÜ‰∏¥Êó∂ÂÖÉÁ¥†
                        document.body.removeChild(tempInput);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                } else {
                    // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÈÄâÊã©Ôºå‰πüË¶ÅÊ∏ÖÁêÜ‰∏¥Êó∂ÂÖÉÁ¥†
                    document.body.removeChild(tempInput);
                }
            };
            
            tempInput.click();
        }
        
        // ‰øÆÊîπÂ§áÊ≥®
        function changeCharacterNickname() {
            const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂ§áÊ≥®ÂêçÁß∞:', currentChatCharacter.name);
            if (newName && newName.trim() !== '') {
                const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                if (characterIndex !== -1) {
                    characters[characterIndex].name = newName.trim();
                    saveCharacters();
                    document.getElementById('api-chat-title').textContent = newName.trim();
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                }
            }
        }
        
        // Êü•ÊâæËÅäÂ§©ÂÜÖÂÆπ
        function searchChatContent() {
            const keyword = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊü•ÊâæÁöÑÂÖ≥ÈîÆËØç:');
            if (keyword && keyword.trim() !== '') {
                const messages = chatMessages[currentChatCharacter.id] || [];
                const foundMessages = messages.filter(msg => 
                    msg.content && msg.content.includes(keyword.trim())
                );
                
                if (foundMessages.length > 0) {
                    alert(`ÊâæÂà∞ ${foundMessages.length} Êù°ÂåÖÂê´"${keyword}"ÁöÑÊ∂àÊÅØ`);
                } else {
                    alert(`Ê≤°ÊúâÊâæÂà∞ÂåÖÂê´"${keyword}"ÁöÑÊ∂àÊÅØ`);
                }
            }
        }
        

        
        // ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï
        function exportChatHistory() {
            const messages = chatMessages[currentChatCharacter.id] || [];
            let history = `‰∏é ${currentChatCharacter.name} ÁöÑËÅäÂ§©ËÆ∞ÂΩï\n\n`;
            
            messages.forEach(msg => {
                const time = formatTime(msg.timestamp);
                const sender = msg.sender === 'sent' ? 'Êàë' : currentChatCharacter.name;
                history += `${time} ${sender}: ${msg.content}\n`;
            });
            
            // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÂØºÂá∫Êñá‰ª∂ÂäüËÉΩ
            console.log(history);
            alert('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÂØºÂá∫Âà∞ÊéßÂà∂Âè∞');
        }
        

        
        // ËÆæÁΩÆÂØπÊñπÊ∞îÊ≥°È¢úËâ≤
        function changeTheirBubbleColor() {
            colorPickerContext = 'theirBubble';
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆÂØπÊñπÊ∞îÊ≥°È¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ËÆæÁΩÆÊàëÊñπÊ∞îÊ≥°È¢úËâ≤
        function changeMyBubbleColor() {
            colorPickerContext = 'myBubble';
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆÊàëÊñπÊ∞îÊ≥°È¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ÊòæÁ§∫Ê∞îÊ≥°È¢úËâ≤ËÆæÁΩÆ
        function showBubbleColorSettings() {
            alert('Ê∞îÊ≥°È¢úËâ≤ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂΩìÂâçÂèØ‰ª•ÈÄöËøá‰ª•‰∏ãÊñπÂºèËÆæÁΩÆÔºö\n‚Ä¢ ‰øÆÊîπÂØπÊñπÊ∞îÊ≥°È¢úËâ≤\n‚Ä¢ ‰øÆÊîπÊàëÊñπÊ∞îÊ≥°È¢úËâ≤');
        }
        
        // Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
        function clearChatHistory() {
            if (!currentChatCharacter) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫‰∏é ${currentChatCharacter.name} ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                chatMessages[currentChatCharacter.id] = [];
                saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
                renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                alert('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
                hideChatSettings();
            }
        }
        
        // ÈÄâÊã©È¢úËâ≤
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }
        
        // Â∫îÁî®ËÅäÂ§©ËÉåÊôØ
        function applyChatBackground() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const chatScreen = document.getElementById('api-chat-screen');
            const messagesContainer = document.getElementById('api-chat-messages');

            if (chatScreen) {
                if (chatSettings.chatBackground && chatSettings.chatBackground !== null) {
                    // ÊúâËÉåÊôØÂõæÁâá
                    chatScreen.style.backgroundImage = `url(${chatSettings.chatBackground})`;
                    chatScreen.style.backgroundSize = 'cover';
                    chatScreen.style.backgroundPosition = 'center';
                    chatScreen.style.backgroundRepeat = 'no-repeat';
                    chatScreen.style.backgroundColor = 'transparent';
                    
                    // ËÆ©Ê∂àÊÅØÂÆπÂô®ËÉåÊôØÈÄèÊòé
                    if (messagesContainer) messagesContainer.style.background = 'transparent';
                } else {
                    // Ê≤°ÊúâËÉåÊôØÂõæÁâáÊàñÊòéÁ°ÆÁßªÈô§‰∫ÜËÉåÊôØ
                    chatScreen.style.backgroundImage = 'none';
                    chatScreen.style.backgroundColor = 'white';
                    
                    // ÊÅ¢Â§çÊ∂àÊÅØÂÆπÂô®ÈªòËÆ§ËÉåÊôØ
                    if (messagesContainer) messagesContainer.style.background = ''; 
                }
            }
        }
        
        // ‰øùÂ≠òÊ∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ
        function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÊ†∑ÂºèËÆæÁΩÆ
            chatSettings.bubbleStyle = window.selectedBubbleStyle || 'default';
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;
            chatSettings.bubbleOpacity = document.getElementById('bubble-opacity').value;
            
            // Êõ¥Êñ∞ÊòæÁ§∫ÊñáÊú¨
            const styleNames = {
                'default': 'ÈªòËÆ§Ê†∑Âºè',
                'glass': 'ÊØõÁéªÁíÉ',
                'shadow': 'ÁªèÂÖ∏Èò¥ÂΩ±',
                'tail': 'ÁªèÂÖ∏Ê∞îÊ≥°',
                'gradient': 'Ê∏êÂèòÊ†∑Âºè',
                'minimal': 'ÊûÅÁÆÄÊ†∑Âºè',
                'neon': 'ÈúìËôπÊ†∑Âºè',
                'paper': 'Á∫∏Âº†Ê†∑Âºè'
            };
            
            document.getElementById('current-bubble-style').textContent = styleNames[chatSettings.bubbleStyle] || 'ÈªòËÆ§Ê†∑Âºè';
            
            saveCurrentChatSettings(chatSettings);
            applyBubbleStyle();
            hideModal('bubble-style-modal');
            
            alert('Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        // Â∫îÁî®Ê∞îÊ≥°Ê†∑Âºè
        function applyBubbleStyle() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const messagesContainer = document.getElementById('api-chat-messages');
            
            if (messagesContainer) {
                // ÁßªÈô§ÊâÄÊúâÊ†∑ÂºèÁ±ª
                messagesContainer.className = messagesContainer.className
                    .split(' ')
                    .filter(cls => !cls.startsWith('bubble-style-'))
                    .join(' ');
                
                // Ê∑ªÂä†ÂΩìÂâçÊ†∑ÂºèÁ±ª
                const style = chatSettings.bubbleStyle || 'default';
                messagesContainer.classList.add(`bubble-style-${style}`);
                
                // ËÆæÁΩÆCSSÂèòÈáèÁî®‰∫éÂä®ÊÄÅÈ¢úËâ≤
                const myColor = chatSettings.myBubbleColor || '#007AFF';
                const aiColor = chatSettings.aiBubbleColor || '#f0f0f0';
                const opacity = chatSettings.bubbleOpacity || '1';
                
                messagesContainer.style.setProperty('--my-bubble-color', myColor);
                messagesContainer.style.setProperty('--ai-bubble-color', aiColor);
                messagesContainer.style.setProperty('--bubble-opacity', opacity);
            }
        }
        
        // ÊòæÁ§∫Ê∞îÊ≥°È¢úËâ≤ÈÄâÊã©Âô®
        function showBubbleColorPicker(context) {
            colorPickerContext = context;
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆÊ∞îÊ≥°È¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ÈÄâÊã©È¢úËâ≤
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }
        
        // Â∫îÁî®È¢úËâ≤ÈÄâÊã©
        function applyColorSelection() {
            const selectedColor = document.querySelector('.color-option.selected')?.style.backgroundColor || '#007AFF';
            const opacity = document.getElementById('opacity-slider').value;
            
            if (colorPickerContext === 'theirBubble') {
                chatSettings.theirBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            } else if (colorPickerContext === 'myBubble') {
                chatSettings.myBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            }
            
            saveChatSettings();
            renderChatMessages(currentChatCharacter.id);
            hideModal('color-picker-modal');
        }
        
        // ÊòæÁ§∫Â¢ôÁ∫∏ÈÄâÊã©Âô®
        function showWallpaperPicker() {
            showModal('wallpaper-picker-modal');
        }
        
        // ÈÄâÊã©Â¢ôÁ∫∏
        function selectWallpaper(wallpaperId) {
            document.querySelectorAll('.wallpaper-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // ËÆæÁΩÆÈÄâ‰∏≠ÁöÑÂ¢ôÁ∫∏
            selectedWallpaper = wallpaperId;
        }
        
        // Â∫îÁî®Â¢ôÁ∫∏ÈÄâÊã©
        function applyWallpaperSelection() {
            if (selectedWallpaper) {
                let wallpaperStyle = '';
                
                if (selectedWallpaper.startsWith('data:image')) {
                    // Â¶ÇÊûúÊòØ‰∏ä‰º†ÁöÑÂõæÁâá
                    wallpaperStyle = `url(${selectedWallpaper})`;
                    document.querySelector('.wallpaper').style.backgroundImage = wallpaperStyle;
                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                    localStorage.setItem('wallpaper', selectedWallpaper);
                    localStorage.setItem('wallpaperType', 'image');
                } else {
                    // Â¶ÇÊûúÊòØÈ¢ÑËÆæÊ∏êÂèò
                    switch (selectedWallpaper) {
                        case 'gradient1':
                            wallpaperStyle = 'linear-gradient(135deg, #6e8efb, #a777e3)';
                            break;
                        case 'gradient2':
                            wallpaperStyle = 'linear-gradient(135deg, #FF9A9E, #FAD0C4)';
                            break;
                        case 'gradient3':
                            wallpaperStyle = 'linear-gradient(135deg, #A1C4FD, #C2E9FB)';
                            break;
                        case 'gradient4':
                            wallpaperStyle = 'linear-gradient(135deg, #FFECD2, #FCB69F)';
                            break;
                        default:
                            wallpaperStyle = '#a8d4a8'; // ÈªòËÆ§È¢úËâ≤
                    }
                    
                    document.querySelector('.wallpaper').style.backgroundImage = wallpaperStyle;
                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                    localStorage.setItem('wallpaper', wallpaperStyle);
                    localStorage.setItem('wallpaperType', 'gradient');
                }
            }
            
            hideModal('wallpaper-picker-modal');
        }
        
        // ‰∏ä‰º†Ëá™ÂÆö‰πâÂ¢ôÁ∫∏
        function uploadCustomWallpaper() {
            document.getElementById('custom-wallpaper-upload').click();
        }
        
        // ÊòæÁ§∫ÂõæÊ†áÈÄâÊã©Âô®
        function showIconPicker() {
            showModal('icon-picker-modal');
        }
        
        // ÈÄâÊã©Â∫îÁî®ÂõæÊ†á
        function selectAppIcon(appId, iconClass) {
            selectedAppIcon = { appId, iconClass };
        }
        
        // ‰∏ä‰º†Ëá™ÂÆö‰πâÂõæÊ†á
        function uploadCustomIcon() {
            document.getElementById('custom-icon-upload').click();
        }
        
        // Â∫îÁî®ÂõæÊ†áÈÄâÊã©
        function applyIconSelection() {
            if (selectedAppIcon && customIconImage) {
                // Êõ¥Êñ∞Â∫îÁî®ÂõæÊ†á
                const appIcon = document.querySelector(`.app[onclick="showApp('${selectedAppIcon.appId}')"] .app-icon`);
                if (appIcon) {
                    appIcon.innerHTML = '';
                    appIcon.style.backgroundImage = `url(${customIconImage})`;
                    
                    // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                    let savedIcons = {};
                    try {
                        savedIcons = JSON.parse(localStorage.getItem('appIcons') || '{}');
                    } catch (error) {
                        console.error('Ëß£ÊûêÊú¨Âú∞Â≠òÂÇ®ÁöÑ appIcons Â§±Ë¥•:', error);
                        savedIcons = {};
                    }
                    savedIcons[selectedAppIcon.appId] = customIconImage;
                    localStorage.setItem('appIcons', JSON.stringify(savedIcons));
                }
            } else if (selectedAppIcon) {
                saveAppIcons();
            }
            hideModal('icon-picker-modal');
        }
        
        // Êõ¥ÊîπËÅäÂ§©‰∏ªÈ¢òÈ¢úËâ≤
        function changeChatThemeColor() {
            colorPickerContext = 'theme';
            document.getElementById('color-picker-title').textContent = 'ËÆæÁΩÆËÅäÂ§©‰∏ªÈ¢òÈ¢úËâ≤';
            showModal('color-picker-modal');
        }
        
        // ÊãçÁÖß
        function capturePhoto() {
            showModal('photo-capture-modal');
        }
        
        // ÂèñÊ∂àÁÖßÁâá
        function cancelPhoto() {
            hideModal('photo-capture-modal');
        }
        
        // ‰øùÂ≠òÁÖßÁâá
        function savePhoto() {
            const description = document.getElementById('photo-description').value.trim() || 'Êú™ÂëΩÂêçÁÖßÁâá';
            const location = document.getElementById('photo-location-input').value.trim() || 'Êú™Áü•Âú∞ÁÇπ';
            
            const now = new Date();
            const photo = {
                id: Date.now().toString(),
                image: 'https://via.placeholder.com/300', // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂ∫îËØ•ÊòØÊãçÊëÑÁöÑÁÖßÁâá
                description,
                location,
                timestamp: now.toISOString(),
                timeString: formatTime(now.getTime()),
                locationString: location
            };
            
            photos.push(photo);
            savePhotos();
            renderAlbum();
            hideModal('photo-capture-modal');
        }
        
        // ÊòæÁ§∫ÁÖßÁâáËØ¶ÊÉÖ
        function showPhotoDetail(photo) {
            document.getElementById('photo-image').style.backgroundImage = `url(${photo.image})`;
            document.getElementById('photo-description-text').textContent = photo.description;
            document.getElementById('photo-time').textContent = `ÊãçÊëÑ‰∫é: ${formatFullDate(new Date(photo.timestamp))}`;
            document.getElementById('photo-location').textContent = `Âú∞ÁÇπ: ${photo.location}`;
            showApp('photo-detail-screen');
        }
        
        // ÊòæÁ§∫Ê∂àÊÅØËèúÂçï
        function showMessageMenu(messageId, event) {
            selectedMessageId = messageId;
            
            // ÂàõÂª∫ÊàñËé∑ÂèñËèúÂçïÂÖÉÁ¥†
            let menu = document.getElementById('message-context-menu');
            if (!menu) {
                menu = document.createElement('div');
                menu.id = 'message-context-menu';
                menu.className = 'message-menu';
                menu.innerHTML = `
                    <div class="message-menu-item" onclick="copyMessage()">Â§çÂà∂</div>
                    <div class="message-menu-item danger" onclick="deleteMessage()">Âà†Èô§</div>
                `;
                document.body.appendChild(menu);
            }
            
            // ÂÆö‰ΩçËèúÂçï
            const x = event.clientX || event.pageX;
            const y = event.clientY || event.pageY;
            
            menu.style.display = 'block';
            menu.style.left = `${Math.min(x, window.innerWidth - 150)}px`;
            menu.style.top = `${Math.min(y, window.innerHeight - 100)}px`;
            
            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
            setTimeout(() => {
                document.addEventListener('click', hideMessageMenu);
                document.addEventListener('touchstart', hideMessageMenu);
            }, 100);
        }
        
        // ÈöêËóèÊ∂àÊÅØËèúÂçï
        function hideMessageMenu() {
            const menu = document.getElementById('message-context-menu');
            if (menu) {
                menu.style.display = 'none';
            }
            document.removeEventListener('click', hideMessageMenu);
            document.removeEventListener('touchstart', hideMessageMenu);
        }
        
        // Â§çÂà∂Ê∂àÊÅØ
        function copyMessage() {
            if (!selectedMessageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === selectedMessageId);
            
            if (message && message.content) {
                navigator.clipboard.writeText(message.content).then(() => {
                    alert('Ê∂àÊÅØÂ∑≤Â§çÂà∂');
                }).catch(() => {
                    alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                });
            }
            
            hideMessageMenu();
        }
        
        // ÁºñËæëÊ∂àÊÅØ
        function editMessage() {
            if (!selectedMessageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const messageIndex = messages.findIndex(msg => msg.id === selectedMessageId);
            
            if (messageIndex !== -1 && messages[messageIndex].sender === 'sent') {
                const newContent = prompt('ÁºñËæëÊ∂àÊÅØ:', messages[messageIndex].content);
                if (newContent !== null) {
                    messages[messageIndex].content = newContent;
                    saveChatMessages();
                    renderChatMessages(currentChatCharacter.id);
                }
            } else {
                alert('Âè™ËÉΩÁºñËæëËá™Â∑±ÂèëÈÄÅÁöÑÊ∂àÊÅØ');
            }
            
            hideModal('message-menu-modal');
        }
        
        // Âà†Èô§Ê∂àÊÅØ
        function deleteMessage() {
            if (!selectedMessageId) return;
            
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü')) {
                const messages = chatMessages[currentChatCharacter.id] || [];
                const messageIndex = messages.findIndex(msg => msg.id === selectedMessageId);
                
                if (messageIndex !== -1) {
                    messages.splice(messageIndex, 1);
                    saveChatMessages();
                    renderChatMessages(currentChatCharacter.id);
                    // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
                    renderMessageList();
                }
            }
            
            hideMessageMenu();
        }
        

        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥Êà≥ÔºàÂÆåÊï¥Êó∂Èó¥Ôºâ
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;
            
            if (messageDate.getTime() === today.getTime()) {
                return timeStr; // ‰ªäÂ§©Âè™ÊòæÁ§∫Êó∂Èó¥
            } else if (messageDate.getTime() === yesterday.getTime()) {
                return `Êò®Â§© ${timeStr}`;
            } else {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}Êúà${day}Êó• ${timeStr}`;
            }
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥Ôºà‰ªÖÊó∂ÂàÜÔºâ
        function formatTimeOnly(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Ê†ºÂºèÂåñÂÆåÊï¥Êó•Êúü
        function formatFullDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}Âπ¥${month}Êúà${day}Êó• ${hours}:${minutes}`;
        }
        
        // Âä†ËΩΩURL
        function loadUrl() {
            const url = document.getElementById('browser-url').value;
            let fullUrl = url;
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                fullUrl = 'https://' + url;
            }
            
            document.getElementById('browser-frame').src = fullUrl;
        }
        
        // APIÁ±ªÂûãÂàáÊç¢Â§ÑÁêÜ
        function onApiTypeChange() {
            const apiType = document.getElementById('api-type').value;
            const baseInput = document.getElementById('api-base');
            const endpointGroup = document.getElementById('endpoint-group');
            const keyInput = document.getElementById('api-key');
            const modelInput = document.getElementById('api-model');
            const modelSelect = document.getElementById('api-model-select');
            const fetchModelsBtn = document.getElementById('fetch-models-btn');
            const modelHint = document.getElementById('model-hint');
            
            if (apiType === 'gemini') {
                baseInput.placeholder = 'https://generativelanguage.googleapis.com/v1beta';
                if (!baseInput.value || baseInput.value === 'https://api.openai.com/v1') {
                    baseInput.value = 'https://generativelanguage.googleapis.com/v1beta';
                }
                endpointGroup.style.display = 'none';
                keyInput.placeholder = 'AIzaSy...Ôºà‰ªéGoogle AI StudioËé∑ÂèñÔºâ';
                modelInput.style.display = 'none';
                modelSelect.style.display = 'block';
                fetchModelsBtn.style.display = 'block';
                modelHint.textContent = 'ÁÇπÂáª"Ëé∑ÂèñÊ®°Âûã"Ëá™Âä®ÊãâÂèñÂèØÁî®Ê®°ÂûãÂàóË°®';
            } else {
                if (apiType === 'openai') {
                    baseInput.placeholder = 'https://api.openai.com/v1';
                    if (!baseInput.value || baseInput.value === 'https://generativelanguage.googleapis.com/v1beta') {
                        baseInput.value = 'https://api.openai.com/v1';
                    }
                    keyInput.placeholder = 'sk-xxxxxxxxxxxxxxxx';
                    modelHint.textContent = '‰æãÂ¶Ç: gpt-4o, gpt-3.5-turbo';
                } else if (apiType === 'anthropic') {
                    baseInput.placeholder = 'https://api.anthropic.com';
                    if (!baseInput.value || baseInput.value.includes('googleapis.com')) {
                        baseInput.value = 'https://api.anthropic.com';
                    }
                    keyInput.placeholder = 'sk-ant-xxxxxxxxxxxxxxxx';
                    modelHint.textContent = '‰æãÂ¶Ç: claude-3-sonnet-20240229';
                } else if (apiType === 'azure') {
                    baseInput.placeholder = 'https://your-resource.openai.azure.com';
                    keyInput.placeholder = 'your-api-key';
                    modelHint.textContent = 'ËæìÂÖ•ÊÇ®ÁöÑÈÉ®ÁΩ≤ÂêçÁß∞';
                }
                endpointGroup.style.display = 'block';
                modelInput.style.display = 'block';
                modelSelect.style.display = 'none';
                fetchModelsBtn.style.display = 'none';
            }
        }
        
        // ÊµãËØïAPIËøûÊé•
        async function testApiConnection() {
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.textContent = 'ÊµãËØï‰∏≠...';
            testBtn.disabled = true;
            
            try {
                // Ëé∑ÂèñÂΩìÂâçËÆæÁΩÆ
                const tempSettings = {
                    type: document.getElementById('api-type').value,
                    base: document.getElementById('api-base').value.trim(),
                    endpoint: document.getElementById('api-endpoint').value.trim(),
                    key: document.getElementById('api-key').value.trim(),
                    model: document.getElementById('api-type').value === 'gemini' ? 
                           document.getElementById('api-model-select').value : 
                           document.getElementById('api-model').value.trim(),
                    temperature: parseFloat(document.getElementById('api-temperature').value) || 0.7
                };
                
                if (!tempSettings.key) {
                    throw new Error('ËØ∑ÂÖàËæìÂÖ•APIÂØÜÈí•');
                }
                
                if (!tempSettings.base) {
                    throw new Error('ËØ∑ËæìÂÖ•APIÂü∫Âú∞ÂùÄ');
                }
                
                if (!tempSettings.model) {
                    throw new Error('ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞');
                }
                
                let url, headers, requestBody;
                
                if (tempSettings.type === 'gemini') {
                    // ‰øÆÂ§çGemini API URL
                    const baseUrl = tempSettings.base.endsWith('/') ? tempSettings.base.slice(0, -1) : tempSettings.base;
                    url = `${baseUrl}/models/${tempSettings.model}:generateContent?key=${tempSettings.key}`;
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    requestBody = {
                        contents: [{
                            parts: [{
                                text: '‰Ω†Â•ΩÔºåËøôÊòØ‰∏Ä‰∏™ËøûÊé•ÊµãËØï„ÄÇËØ∑ÁÆÄÂçïÂõûÂ§ç"ËøûÊé•ÊàêÂäü"Âç≥ÂèØ„ÄÇ'
                            }]
                        }],
                        generationConfig: {
                            temperature: tempSettings.temperature
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_NONE"
                            }
                        ]
                    };
                } else {
                    // OpenAIÂÖºÂÆπÊ†ºÂºè
                    const baseUrl = tempSettings.base.endsWith('/') ? tempSettings.base.slice(0, -1) : tempSettings.base;
                    const endpoint = tempSettings.endpoint.startsWith('/') ? tempSettings.endpoint : '/' + tempSettings.endpoint;
                    url = baseUrl + endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tempSettings.key}`
                    };
                    requestBody = {
                        model: tempSettings.model,
                        messages: [
                            { role: 'user', content: '‰Ω†Â•ΩÔºåËøôÊòØ‰∏Ä‰∏™ËøûÊé•ÊµãËØï„ÄÇËØ∑ÁÆÄÂçïÂõûÂ§ç"ËøûÊé•ÊàêÂäü"Âç≥ÂèØ„ÄÇ' }
                        ],
                        temperature: tempSettings.temperature
                    };
                }
                
                console.log('ÊµãËØïAPIËøûÊé• - URL:', url);
                console.log('ÊµãËØïAPIËøûÊé• - Headers:', headers);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        console.log('ÈîôËØØÂìçÂ∫îËØ¶ÊÉÖ:', errorData);
                        errorMessage = errorData.error?.message || errorData.message || errorMessage;
                    } catch (e) {
                        const text = await response.text();
                        console.log('ÈîôËØØÂìçÂ∫îÊñáÊú¨:', text);
                        errorMessage += '\n\nËØ¶ÁªÜ‰ø°ÊÅØ: ' + text;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('APIÂìçÂ∫î:', data);
                
                let responseText;
                
                if (tempSettings.type === 'gemini') {
                    responseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                } else {
                    responseText = data.choices?.[0]?.message?.content;
                }
                
                if (responseText) {
                    alert('‚úÖ APIËøûÊé•ÊµãËØïÊàêÂäüÔºÅ\n\nÂõûÂ§çÂÜÖÂÆπÔºö' + responseText);
                } else {
                    alert('‚ö†Ô∏è APIËøûÊé•ÊàêÂäüÔºå‰ΩÜËøîÂõûÊ†ºÂºèÂèØËÉΩÊúâÈóÆÈ¢ò\n\nÂéüÂßãÂìçÂ∫îÔºö' + JSON.stringify(data, null, 2));
                }
                
            } catch (error) {
                console.error('APIÊµãËØïÂ§±Ë¥•:', error);
                let errorMsg = error.message;
                
                // ÈíàÂØπÂ∏∏ËßÅÈîôËØØÊèê‰æõËß£ÂÜ≥Âª∫ËÆÆ
                if (errorMsg.includes('CORS')) {
                    errorMsg += '\n\nüí° Âª∫ËÆÆÔºöËØ∑Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶Å‰ΩøÁî®Âèç‰ª£Âú∞ÂùÄÔºåÊàñËÄÖAPIÊúçÂä°ÊòØÂê¶ÊîØÊåÅË∑®ÂüüËØ∑Ê±Ç„ÄÇ';
                } else if (errorMsg.includes('401') || errorMsg.includes('API key')) {
                    errorMsg += '\n\nüí° Âª∫ËÆÆÔºöËØ∑Ê£ÄÊü•APIÂØÜÈí•ÊòØÂê¶Ê≠£Á°ÆÔºå‰ª•ÂèäÊòØÂê¶ÊúâÊùÉÈôêËÆøÈóÆËØ•Ê®°Âûã„ÄÇ';
                } else if (errorMsg.includes('404')) {
                    errorMsg += '\n\nüí° Âª∫ËÆÆÔºöËØ∑Ê£ÄÊü•APIÂü∫Âú∞ÂùÄÂíåÊ®°ÂûãÂêçÁß∞ÊòØÂê¶Ê≠£Á°Æ„ÄÇ';
                } else if (errorMsg.includes('403')) {
                    errorMsg += '\n\nüí° Âª∫ËÆÆÔºöAPIÂØÜÈí•ÊùÉÈôê‰∏çË∂≥ÊàñË¥¶Êà∑‰ΩôÈ¢ù‰∏çË∂≥„ÄÇ';
                }
                
                alert('‚ùå APIËøûÊé•ÊµãËØïÂ§±Ë¥•\n\nÈîôËØØ‰ø°ÊÅØÔºö' + errorMsg);
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }
        
        // Ëé∑ÂèñÊ®°ÂûãÂàóË°®
        async function fetchModels() {
            const fetchBtn = document.getElementById('fetch-models-btn');
            const originalText = fetchBtn.textContent;
            fetchBtn.textContent = 'Ëé∑Âèñ‰∏≠...';
            fetchBtn.disabled = true;
            
            try {
                const apiKey = document.getElementById('api-key').value.trim();
                const baseUrl = document.getElementById('api-base').value.trim();
                
                if (!apiKey) {
                    throw new Error('ËØ∑ÂÖàËæìÂÖ•APIÂØÜÈí•');
                }
                
                if (!baseUrl) {
                    throw new Error('ËØ∑ÂÖàËæìÂÖ•APIÂü∫Âú∞ÂùÄ');
                }
                
                // ÊûÑÂª∫Ëé∑ÂèñÊ®°ÂûãÂàóË°®ÁöÑURL
                const modelsUrl = `${baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl}/models?key=${apiKey}`;
                
                console.log('Ëé∑ÂèñÊ®°ÂûãÂàóË°® - URL:', modelsUrl);
                
                const response = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Ê®°ÂûãÂàóË°®ÂìçÂ∫î:', data);
                
                const modelSelect = document.getElementById('api-model-select');
                modelSelect.innerHTML = '<option value="">ÈÄâÊã©Ê®°Âûã...</option>';
                
                if (data.models && Array.isArray(data.models)) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name.startsWith('models/') ? model.name.substring(7) : model.name;
                        option.textContent = `${option.value} (${model.displayName || model.name})`;
                        modelSelect.appendChild(option);
                    });
                    
                    alert(`‚úÖ ÊàêÂäüËé∑ÂèñÂà∞ ${data.models.length} ‰∏™Ê®°Âûã`);
                } else {
                    throw new Error('APIËøîÂõûÁöÑÊ®°ÂûãÂàóË°®Ê†ºÂºè‰∏çÊ≠£Á°Æ');
                }
                
            } catch (error) {
                console.error('Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•:', error);
                alert('‚ùå Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•\n\nÈîôËØØ‰ø°ÊÅØÔºö' + error.message);
            } finally {
                fetchBtn.textContent = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        // ‰øùÂ≠òAPIËÆæÁΩÆ
        function saveApiSettings() {
            apiSettings = {
                type: document.getElementById('api-type').value,
                base: document.getElementById('api-base').value.trim(),
                endpoint: document.getElementById('api-endpoint').value.trim(),
                key: document.getElementById('api-key').value.trim(),
                model: document.getElementById('api-type').value === 'gemini' ? 
                       (document.getElementById('api-model-select') ? document.getElementById('api-model-select').value : document.getElementById('api-model').value.trim()) : 
                       document.getElementById('api-model').value.trim(),
                temperature: parseFloat(document.getElementById('api-temperature').value) || 0.7
            };
            
            localStorage.setItem('apiSettings', JSON.stringify(apiSettings));
            alert('APIËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
            hideApp('api-settings-screen');
        }
        
        // ÁîµÊ±†ÁÆ°ÁêÜÂäüËÉΩ
        async function initBatteryManager() {
            // È¶ñÂÖàËÆæÁΩÆÈªòËÆ§ÊòæÁ§∫
            const allBatteryTexts = document.querySelectorAll('.battery-text');
            allBatteryTexts.forEach(element => {
                element.textContent = '·∞î·©ö';
            });
            
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    updateBatteryDisplay(battery);
                    
                    battery.addEventListener('levelchange', () => updateBatteryDisplay(battery));
                    battery.addEventListener('chargingchange', () => updateBatteryDisplay(battery));
                } catch (err) {
                    console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err);
                    // ‰øùÊåÅÈªòËÆ§ÊòæÁ§∫ ·∞î·©ö
                }
            } else {
                console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPIÔºå‰ΩøÁî®ÈªòËÆ§ÊòæÁ§∫„ÄÇ");
                // ‰øùÊåÅÈªòËÆ§ÊòæÁ§∫ ·∞î·©ö
            }
        }
        
        function updateBatteryDisplay(battery) {
            const level = Math.floor(battery.level * 100);
            const isCharging = battery.charging;
            
            // Êõ¥Êñ∞‰∏ªÁä∂ÊÄÅÊ†èÁîµÊ±†
            const batteryContainer = document.getElementById('status-bar-battery');
            if (batteryContainer) {
                const batteryLevelEl = batteryContainer.querySelector('.battery-level');
                const batteryTextEl = batteryContainer.querySelector('.battery-text');
                
                if (batteryLevelEl && batteryTextEl) {
                    batteryLevelEl.style.width = `${level}%`;
                    batteryTextEl.textContent = '·∞î·©ö';
                    
                    if (isCharging) {
                        batteryContainer.classList.add('charging');
            } else {
                        batteryContainer.classList.remove('charging');
                    }
                }
            }
            
            // Êõ¥Êñ∞Â∫îÁî®ÂÜÖÁä∂ÊÄÅÊ†èÁîµÊ±†
            const appBatteryContainers = document.querySelectorAll('.app-battery-container');
            const appBatteryTexts = document.querySelectorAll('.app-battery-container .battery-text');
            const appBatteryLevels = document.querySelectorAll('.app-battery-level');
            
            appBatteryTexts.forEach(element => {
                element.textContent = '·∞î·©ö';
            });
            
            appBatteryLevels.forEach(element => {
                element.style.width = `${level}%`;
            });
            
            // ÂêåÊ≠•Â∫îÁî®ÂÜÖÁîµÊ±†ÂÖÖÁîµÁä∂ÊÄÅ
            appBatteryContainers.forEach(container => {
                if (isCharging) {
                    container.classList.add('charging');
                } else {
                    container.classList.remove('charging');
                }
            });
        }
        
        // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
        function changeTheme(themeName) {
            const body = document.body;
            
            // ÁßªÈô§‰πãÂâçÁöÑ‰∏ªÈ¢ò
            body.removeAttribute('data-theme');
            
            // Â∫îÁî®Êñ∞‰∏ªÈ¢ò
            if (themeName !== 'default') {
                body.setAttribute('data-theme', themeName);
            }
            
            // ‰øùÂ≠ò‰∏ªÈ¢òËÆæÁΩÆ
            localStorage.setItem('selectedTheme', themeName);
            
            // ÁªôÁî®Êà∑ÂèçÈ¶à
            const themeNames = {
                'default': 'ÁÆÄÁ∫¶È£éÊ†º',
                'cute': 'ÂèØÁà±È£éÊ†º',
                'nature': 'Ëá™ÁÑ∂È£éÊ†º', 
                'tech': 'ÁßëÊäÄÈ£éÊ†º',
                'dream': 'Ê¢¶ÂπªÈ£éÊ†º'
            };
            
            // ÂèØ‰ª•Ê∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊèêÁ§∫
            setTimeout(() => {
                alert(`Â∑≤ÂàáÊç¢Âà∞ ${themeNames[themeName]} ‰∏ªÈ¢ò`);
            }, 100);
        }
        
        // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme && savedTheme !== 'default') {
                document.body.setAttribute('data-theme', savedTheme);
            }
        }
        
        // ‰∏ñÁïå‰π¶Áõ∏ÂÖ≥ÂäüËÉΩ
        let worldbooks = [];
        let editingWorldbook = null;
        
        function loadWorldbooks() {
            const savedWorldbooks = localStorage.getItem('worldbooks');
            if (savedWorldbooks) {
                try {
                    worldbooks = JSON.parse(savedWorldbooks);
                } catch (e) {
                    worldbooks = [];
                }
            }
            renderWorldbookList();
        }
        
        function saveWorldbooks() {
            localStorage.setItem('worldbooks', JSON.stringify(worldbooks));
        }
        
        function showWorldbookForm() {
            editingWorldbook = null;
            document.getElementById('worldbook-form-title').textContent = 'Êñ∞Âª∫‰∏ñÁïå‰π¶';
            document.getElementById('worldbook-title').value = '';
            document.getElementById('worldbook-content').value = '';
            showApp('worldbook-form-screen');
        }
        
        function hideWorldbookForm() {
            hideApp('worldbook-form-screen');
        }
        
        function saveWorldbook() {
            const title = document.getElementById('worldbook-title').value.trim();
            const content = document.getElementById('worldbook-content').value.trim();
            
            if (!title) {
                alert('ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶Ê†áÈ¢ò');
                return;
            }
            
            if (!content) {
                alert('ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÂÜÖÂÆπ');
                return;
            }
            
            const worldbook = {
                id: editingWorldbook ? editingWorldbook.id : Date.now().toString(),
                title: title,
                content: content,
                createdAt: editingWorldbook ? editingWorldbook.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingWorldbook) {
                const index = worldbooks.findIndex(w => w.id === editingWorldbook.id);
                if (index !== -1) {
                    worldbooks[index] = worldbook;
                }
            } else {
                worldbooks.push(worldbook);
            }
            
            saveWorldbooks();
            renderWorldbookList();
            hideWorldbookForm();
        }
        
        function editWorldbook(id) {
            const worldbook = worldbooks.find(w => w.id === id);
            if (worldbook) {
                editingWorldbook = worldbook;
                document.getElementById('worldbook-form-title').textContent = 'ÁºñËæë‰∏ñÁïå‰π¶';
                document.getElementById('worldbook-title').value = worldbook.title;
                document.getElementById('worldbook-content').value = worldbook.content;
                showApp('worldbook-form-screen');
            }
        }
        
        function deleteWorldbook(id) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∏ñÁïå‰π¶ÂêóÔºü')) {
                worldbooks = worldbooks.filter(w => w.id !== id);
                saveWorldbooks();
                renderWorldbookList();
            }
        }
        
        function renderWorldbookList() {
            const listContainer = document.getElementById('worldbook-list');
            if (!listContainer) return;
            
            if (worldbooks.length === 0) {
                listContainer.innerHTML = '<div class="empty-worldbook">ËøòÊ≤°Êúâ‰∏ñÁïå‰π¶ÔºåÁÇπÂáªÂè≥‰∏äËßí+Âè∑ÂàõÂª∫‰∏Ä‰∏™ÂêßÔºÅ</div>';
                return;
            }
            
            const html = worldbooks.map(worldbook => {
                const date = new Date(worldbook.updatedAt).toLocaleDateString();
                const preview = worldbook.content.substring(0, 100) + (worldbook.content.length > 100 ? '...' : '');
                
                return `
                    <div class="worldbook-item">
                        <div class="worldbook-header">
                            <div class="worldbook-content-flex" onclick="editWorldbook('${worldbook.id}')">
                                <div class="worldbook-title">${worldbook.title}</div>
                                <div class="worldbook-desc-text">${preview}</div>
                                <div class="worldbook-date-text">Êõ¥Êñ∞‰∫é ${date}</div>
                            </div>
                            <button onclick="deleteWorldbook('${worldbook.id}')" class="delete-worldbook-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = html;
        }
        
        // Èü≥‰πêÂ∫îÁî®Áõ∏ÂÖ≥ÂäüËÉΩ
        let playlist = [];
        let currentSong = null;
        let isPlaying = false;
        let listeningCharacters = [];
        
        function loadMusicData() {
            const savedPlaylist = localStorage.getItem('musicPlaylist');
            if (savedPlaylist) {
                try {
                    playlist = JSON.parse(savedPlaylist);
                } catch (e) {
                    playlist = [];
                }
            }
            
            const savedListeners = localStorage.getItem('listeningCharacters');
            if (savedListeners) {
                try {
                    listeningCharacters = JSON.parse(savedListeners);
                } catch (e) {
                    listeningCharacters = [];
                }
            }
            
            renderPlaylist();
            renderListeningCharacters();
        }
        
        function saveMusicData() {
            localStorage.setItem('musicPlaylist', JSON.stringify(playlist));
            localStorage.setItem('listeningCharacters', JSON.stringify(listeningCharacters));
        }
        
        function addMusicToPlaylist() {
            const title = prompt('ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞:');
            if (title && title.trim()) {
                const artist = prompt('ËØ∑ËæìÂÖ•Ëâ∫ÊúØÂÆ∂ÂêçÁß∞:') || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';
                const song = {
                    id: Date.now().toString(),
                    title: title.trim(),
                    artist: artist.trim(),
                    duration: '3:30' // Ê®°ÊãüÊó∂Èïø
                };
                
                playlist.push(song);
                saveMusicData();
                renderPlaylist();
            }
        }
        
        function playSong(songId) {
            const song = playlist.find(s => s.id === songId);
            if (song) {
                currentSong = song;
                document.getElementById('song-title').textContent = song.title;
                document.getElementById('artist-name').textContent = song.artist;
                document.getElementById('total-time').textContent = song.duration;
                
                // Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆ
                const playBtn = document.getElementById('play-pause-btn');
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
                
                // Ê®°ÊãüÊí≠ÊîæËøõÂ∫¶
                simulatePlayback();
                
                // ÈÄöÁü•Âê¨Ê≠åËßíËâ≤
                notifyListeningCharacters(song);
            }
        }
        
        function togglePlayPause() {
            const playBtn = document.getElementById('play-pause-btn');
            if (isPlaying) {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            } else {
                if (currentSong) {
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                    simulatePlayback();
                } else if (playlist.length > 0) {
                    playSong(playlist[0].id);
                }
            }
        }
        
        function previousSong() {
            if (!currentSong || playlist.length === 0) return;
            
            const currentIndex = playlist.findIndex(s => s.id === currentSong.id);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : playlist.length - 1;
            playSong(playlist[prevIndex].id);
        }
        
        function nextSong() {
            if (!currentSong || playlist.length === 0) return;
            
            const currentIndex = playlist.findIndex(s => s.id === currentSong.id);
            const nextIndex = currentIndex < playlist.length - 1 ? currentIndex + 1 : 0;
            playSong(playlist[nextIndex].id);
        }
        
        function simulatePlayback() {
            if (!isPlaying) return;
            
            // ËøôÈáåÂè™ÊòØÊ®°ÊãüËøõÂ∫¶ÔºåÂÆûÈôÖÂ∫îÁî®‰∏≠ÈúÄË¶ÅÁúüÂÆûÁöÑÈü≥È¢ëÊí≠Êîæ
            let progress = 0;
            const interval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(interval);
                    return;
                }
                
                progress += 1;
                document.getElementById('progress').style.width = `${Math.min(progress, 100)}%`;
                
                const currentMinutes = Math.floor(progress * 3.5 / 100);
                const currentSeconds = Math.floor((progress * 3.5 / 100 - currentMinutes) * 60);
                document.getElementById('current-time').textContent = 
                    `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    nextSong();
                }
            }, 100);
        }
        
        function inviteCharacterToListen() {
            const availableCharacters = characters.filter(c => 
                !listeningCharacters.find(lc => lc.id === c.id)
            );
            
            if (availableCharacters.length === 0) {
                alert('Ê≤°ÊúâÂèØÈÇÄËØ∑ÁöÑËßíËâ≤‰∫ÜÔºåÊàñËÄÖÊâÄÊúâËßíËâ≤ÈÉΩÂ∑≤ÁªèÂú®Âê¨Ê≠å');
                return;
            }
            
            const characterNames = availableCharacters.map((c, index) => `${index + 1}. ${c.name}`).join('\n');
            const choice = prompt(`ÈÄâÊã©Ë¶ÅÈÇÄËØ∑ÁöÑËßíËâ≤:\n${characterNames}\n\nËØ∑ËæìÂÖ•Êï∞Â≠ó:`);
            
            if (choice && !isNaN(choice)) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < availableCharacters.length) {
                    const character = availableCharacters[index];
                    listeningCharacters.push({
                        id: character.id,
                        name: character.name,
                        avatar: character.avatarUrl || character.name.charAt(0),
                        joinedAt: new Date().toISOString()
                    });
                    
                    saveMusicData();
                    renderListeningCharacters();
                    
                    // Ê®°ÊãüËßíËâ≤ÂìçÂ∫î
                    setTimeout(() => {
                        alert(`${character.name}: Â•ΩÁöÑÔºåÊàëÊù•Âíå‰Ω†‰∏ÄËµ∑Âê¨Ê≠åÔºÅ`);
                    }, 500);
                }
            }
        }
        
        function removeListeningCharacter(characterId) {
            listeningCharacters = listeningCharacters.filter(c => c.id !== characterId);
            saveMusicData();
            renderListeningCharacters();
        }
        
        function notifyListeningCharacters(song) {
            listeningCharacters.forEach(character => {
                // Ê®°ÊãüËßíËâ≤ÂØπÈü≥‰πêÁöÑÂèçÂ∫î
                const reactions = [
                    `${character.name}: ËøôÈ¶ñÊ≠åÁúüÂ•ΩÂê¨ÔºÅ`,
                    `${character.name}: Êàë‰πüÂæàÂñúÊ¨¢ËøôÈ¶ñ„Ää${song.title}„Äã`,
                    `${character.name}: Âê¨ÁùÄËøôÈü≥‰πêÂøÉÊÉÖÁúüÂ•ΩÔΩû`,
                    `${character.name}: Ë∞¢Ë∞¢ÂàÜ‰∫´Ëøô‰πàÊ£íÁöÑÈü≥‰πêÔºÅ`
                ];
                
                const reaction = reactions[Math.floor(Math.random() * reactions.length)];
                
                setTimeout(() => {
                    // ÂèØ‰ª•Âú®ËøôÈáåÊòæÁ§∫ËßíËâ≤ÁöÑÂèçÂ∫îÊ∂àÊÅØ
                    console.log(reaction);
                }, Math.random() * 3000 + 1000);
            });
        }
        
        function renderPlaylist() {
            const playlistContainer = document.getElementById('playlist');
            if (!playlistContainer) return;
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = '<div class="empty-playlist">Êí≠ÊîæÂàóË°®‰∏∫Á©∫ÔºåÁÇπÂáª+Âè∑Ê∑ªÂä†Èü≥‰πê</div>';
                return;
            }
            
            const html = playlist.map(song => `
                <div class="playlist-item" onclick="playSong('${song.id}')">
                    <div>
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                    </div>
                    <div class="song-duration">${song.duration}</div>
                </div>
            `).join('');
            
            playlistContainer.innerHTML = html;
        }
        
        function renderListeningCharacters() {
            const container = document.getElementById('listening-characters');
            if (!container) return;
            
            if (listeningCharacters.length === 0) {
                container.innerHTML = '<div class="empty-playlist">Ê≤°ÊúâËßíËâ≤Âú®Âê¨Ê≠åÔºåÁÇπÂáª+Âè∑ÈÇÄËØ∑ËßíËâ≤</div>';
                return;
            }
            
            const html = listeningCharacters.map(character => `
                <div class="character-item">
                    <div class="character-avatar" style="background-image: url(${character.avatar}); background-size: cover; background-position: center;">
                        ${character.avatar.startsWith('http') ? '' : character.name.charAt(0)}
                    </div>
                    <div class="character-name">${character.name}</div>
                    <div class="listening-status">Ê≠£Âú®Âê¨Ê≠å</div>
                    <button onclick="removeListeningCharacter('${character.id}')" class="remove-character-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // ================== Èù¢ÂÖ∑Á≥ªÁªüÁõ∏ÂÖ≥ÂäüËÉΩ ==================
        
        // Âä†ËΩΩÈù¢ÂÖ∑Êï∞ÊçÆ
        function loadPersonas() {
            const savedPersonas = localStorage.getItem('personas');
            if (savedPersonas) {
                try {
                    personas = JSON.parse(savedPersonas);
                } catch (e) {
                    personas = [];
                }
            } else {
                // ÂàùÂßãÂåñ‰∏∫Á©∫Èù¢ÂÖ∑ÂàóË°®
                personas = [];
                savePersonas();
            }
            
            // ËÆæÁΩÆÂΩìÂâçÈù¢ÂÖ∑
            const savedCurrentPersona = localStorage.getItem('currentPersona');
            if (savedCurrentPersona) {
                currentPersona = personas.find(p => p.id === savedCurrentPersona) || personas[0];
            } else {
                currentPersona = personas[0];
            }
            
            updateCurrentPersonaDisplay();
        }
        
        // ‰øùÂ≠òÈù¢ÂÖ∑Êï∞ÊçÆ
        function savePersonas() {
            localStorage.setItem('personas', JSON.stringify(personas));
        }
        
        // ‰øùÂ≠òÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑
        function saveCurrentPersona() {
            if (currentPersona) {
                localStorage.setItem('currentPersona', currentPersona.id);
            }
        }
        
        // ÊòæÁ§∫Èù¢ÂÖ∑ÂàõÂª∫Ë°®Âçï
        function showPersonaForm(personaId = null) {
            editingPersona = personaId ? personas.find(p => p.id === personaId) : null;
            
            document.getElementById('persona-form-title').textContent = editingPersona ? 'ÁºñËæëÈù¢ÂÖ∑' : 'Êñ∞Âª∫Èù¢ÂÖ∑';
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('persona-name').value = editingPersona ? editingPersona.name : '';
            document.getElementById('persona-description').value = editingPersona ? editingPersona.description : '';
            
            // ÈáçÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
            const avatarPreview = document.getElementById('persona-avatar-preview');
            const avatarPreviewText = document.getElementById('persona-avatar-preview-text');
            
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            
            if (editingPersona && editingPersona.avatarUrl) {
                avatarPreview.classList.add('has-image');
                avatarPreview.style.setProperty('background', `url(${editingPersona.avatarUrl})`, 'important');
                avatarPreview.style.setProperty('background-size', 'cover', 'important');
                avatarPreview.style.setProperty('background-position', 'center', 'important');
                avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                avatarPreviewText.style.display = 'none';
                window.selectedPersonaAvatarData = editingPersona.avatarUrl;
            } else {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = editingPersona ? editingPersona.name.charAt(0) : 'Êàë';
                window.selectedPersonaAvatarData = null;
            }
            
            // ÂàùÂßãÂåñÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
            initializePersonaAvatarUpload();
            
            showApp('persona-form-screen');
        }
        
        // ÈöêËóèÈù¢ÂÖ∑Ë°®Âçï
        function hidePersonaForm() {
            hideApp('persona-form-screen');
            showApp('chat-screen');
            switchWechatTab('profile-page');
            // Ê∏ÖÁ©∫‰∏¥Êó∂Êï∞ÊçÆ
            window.selectedPersonaAvatarData = null;
            editingPersona = null;
        }
        
        // ‰øùÂ≠òÈù¢ÂÖ∑
        function savePersona() {
            const name = document.getElementById('persona-name').value.trim();
            const description = document.getElementById('persona-description').value.trim();
            const avatarData = window.selectedPersonaAvatarData;
            
            if (!name) {
                alert('ËØ∑ËæìÂÖ•Èù¢ÂÖ∑ÂêçÁß∞');
                return;
            }
            
            if (editingPersona) {
                // Êõ¥Êñ∞Áé∞ÊúâÈù¢ÂÖ∑
                const index = personas.findIndex(p => p.id === editingPersona.id);
                if (index !== -1) {
                    personas[index] = {
                        ...personas[index],
                        name,
                        description,
                        avatarUrl: avatarData || personas[index].avatarUrl || '',
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // ÂàõÂª∫Êñ∞Èù¢ÂÖ∑
                const newPersona = {
                    id: Date.now().toString(),
                    name,
                    description,
                    avatarUrl: avatarData || '',
                    isDefault: false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                personas.push(newPersona);
            }
            
            savePersonas();
            renderPersonaList();
            hidePersonaForm();
            alert('Èù¢ÂÖ∑‰øùÂ≠òÊàêÂäüÔºÅ');
        }
        
        // Âà†Èô§Èù¢ÂÖ∑
        function deletePersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (!persona) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Èù¢ÂÖ∑"${persona.name}"ÂêóÔºü`)) {
                personas = personas.filter(p => p.id !== personaId);
                
                // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈù¢ÂÖ∑ÔºåÂàáÊç¢Âà∞Á¨¨‰∏Ä‰∏™Èù¢ÂÖ∑ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
                if (currentPersona && currentPersona.id === personaId) {
                    currentPersona = personas[0] || null;
                    saveCurrentPersona();
                    updateCurrentPersonaDisplay();
                }
                
                savePersonas();
                renderPersonaList();
            }
        }
        
        // ÂàáÊç¢Èù¢ÂÖ∑
        function switchPersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (persona) {
                currentPersona = persona;
                saveCurrentPersona();
                updateCurrentPersonaDisplay();
                renderPersonaList();
                alert(`Â∑≤ÂàáÊç¢Âà∞Èù¢ÂÖ∑"${persona.name}"`);
            }
        }
        
        // Êõ¥Êñ∞ÂΩìÂâçÈù¢ÂÖ∑ÊòæÁ§∫
        function updateCurrentPersonaDisplay() {
            // Áî±‰∫éÂà†Èô§‰∫ÜÈªòËÆ§Ë∫´‰ªΩÊòæÁ§∫ÂÖÉÁ¥†ÔºåËøô‰∏™ÂáΩÊï∞Áé∞Âú®‰∏∫Á©∫
            // ‰øùÁïôÂáΩÊï∞ÂÆö‰πâ‰ª•ÈÅøÂÖçÂÖ∂‰ªñÂú∞ÊñπÁöÑË∞ÉÁî®Âá∫Èîô
        }
        
        // Ê∏≤ÊüìÈù¢ÂÖ∑ÂàóË°®
        function renderPersonaList() {
            const listContainer = document.getElementById('persona-list');
            if (!listContainer) return;
            
            if (personas.length === 0) {
                listContainer.innerHTML = '<div class="empty-personas">ËøòÊ≤°ÊúâÈù¢ÂÖ∑ÔºåÁÇπÂáªÂè≥‰∏äËßí+Âè∑ÂàõÂª∫‰∏Ä‰∏™ÂêßÔºÅ</div>';
                return;
            }
            
            const html = personas.map(persona => `
                <div class="persona-item ${currentPersona && currentPersona.id === persona.id ? 'active' : ''}" onclick="switchPersona('${persona.id}')">
                    <div class="persona-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                    </div>
                    <div class="persona-info">
                        <div class="persona-name">${persona.name}</div>
                        <div class="persona-description">${persona.description || 'ÊöÇÊó†ÊèèËø∞'}</div>
                    </div>
                    <div class="persona-actions">
                        <button class="persona-action-btn persona-edit-btn" onclick="event.stopPropagation(); showPersonaForm('${persona.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="persona-action-btn persona-delete-btn" onclick="event.stopPropagation(); deletePersona('${persona.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            listContainer.innerHTML = html;
        }
        
        // ÂàùÂßãÂåñÈù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
        function initializePersonaAvatarUpload() {
            const avatarInput = document.getElementById('persona-avatar-upload');
            if (!avatarInput) {
                console.error('Êâæ‰∏çÂà∞persona-avatar-uploadÂÖÉÁ¥†');
                return;
            }
            
            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.removeEventListener('change', personaAvatarUploadHandler);
            
            // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.addEventListener('change', personaAvatarUploadHandler);
            console.log('Èù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö');
        }
        
        // Èù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function personaAvatarUploadHandler(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                
                // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    e.target.value = '';
                    return;
                }
                
                // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂‰∏∫5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                    e.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('persona-avatar-preview');
                        const avatarPreviewText = document.getElementById('persona-avatar-preview-text');
                        
                        if (!avatarPreview) {
                            alert('Êâæ‰∏çÂà∞Â§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†');
                            return;
                        }
                        
                        // ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßà
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        
                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }
                        
                        // Â≠òÂÇ®ÂõæÁâáÊï∞ÊçÆ
                        window.selectedPersonaAvatarData = event.target.result;
                        
                        console.log('Èù¢ÂÖ∑Â§¥ÂÉèÈ¢ÑËßàËÆæÁΩÆÊàêÂäü');
                    } catch (error) {
                        console.error('ËÆæÁΩÆÈù¢ÂÖ∑Â§¥ÂÉèÈ¢ÑËßàÊó∂ÂèëÁîüÈîôËØØ:', error);
                        alert('ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÂ§±Ë¥•ÔºåËØ∑ÈáçËØï: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    alert('ÂõæÁâáËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    e.target.value = '';
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // Èù¢ÂÖ∑Â§¥ÂÉè‰∏ä‰º†ÁÇπÂáªÂ§ÑÁêÜ
        function handlePersonaAvatarUploadClick() {
            const input = document.getElementById('persona-avatar-upload');
            if (input) {
                input.click();
            } else {
                alert('Êâæ‰∏çÂà∞Êñá‰ª∂‰∏ä‰º†ÂÖÉÁ¥†ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        // ÊîØÊåÅÂõæÁâáÁöÑËÅäÂ§©APIË∞ÉÁî®
        async function callChatAPIWithImage(message, character, imageUrl) {
            if (!apiSettings.key) {
                throw new Error('ËØ∑ÂÖàËÆæÁΩÆAPIÂØÜÈí•');
            }
            
            // Ê£ÄÊü•ÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÊîØÊåÅËßÜËßâËØÜÂà´
            if (!isVisionModelSupported()) {
                throw new Error('ÂΩìÂâçÈÄâÊã©ÁöÑÊ®°Âûã‰∏çÊîØÊåÅÂõæÁâáËØÜÂà´ÂäüËÉΩ„ÄÇËØ∑ÈÄâÊã©ÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÔºåÂ¶Ç gpt-4o„ÄÅgpt-4-vision„ÄÅgemini-1.5-pro Êàñ gemini-2.0-flash Á≠â„ÄÇ');
            }
            
            const chatSettings = getCurrentChatSettings();
            const currentTime = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                weekday: 'long'
            });
            
            // ÊûÑÂª∫Âü∫Á°ÄËßíËâ≤ÊèêÁ§∫ËØç
            let characterPrompt = `‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${character.name}"ÁöÑËßíËâ≤„ÄÇ\n\n# ÂΩìÂâçÊÉÖÊôØ‰ø°ÊÅØ\n- **ÂΩìÂâçÊó∂Èó¥ÊòØÔºö${currentTime}**„ÄÇ\n`;
            
            // Âä†ÂÖ•‰∏ìÈó®ÁöÑÂõæÁâáËØÜÂà´ÊåáÂºï
            characterPrompt += `\n# ÂõæÁâáËØÜÂà´‰∏éÂàÜÊûê‰ªªÂä°\nÁî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåËØ∑‰ªîÁªÜËßÇÂØüÂπ∂ÂÖ®Èù¢ÂàÜÊûêÂõæÁâáÂÜÖÂÆπÔºö\n\n## Âü∫Á°ÄËØÜÂà´Ë¶ÅÊ±ÇÔºö\n- **‰∫∫Áâ©ËØÜÂà´**ÔºöÊèèËø∞‰∫∫Áâ©ÁöÑÊÄßÂà´„ÄÅÂπ¥ÈæÑ„ÄÅÂ§ñË≤åÁâπÂæÅ„ÄÅÊúçË£Ö„ÄÅË°®ÊÉÖ„ÄÅÂä®‰Ωú„ÄÅÂßøÊÄÅ\n- **Áâ©‰ΩìËØÜÂà´**ÔºöËØÜÂà´ÂêÑÁßçÁâ©ÂìÅ„ÄÅÂ∑•ÂÖ∑„ÄÅËÆæÂ§áÁöÑÁßçÁ±ª„ÄÅÈ¢úËâ≤„ÄÅÂ§ßÂ∞è„ÄÅÁä∂ÊÄÅ„ÄÅ‰ΩçÁΩÆÂÖ≥Á≥ª\n- **Âú∫ÊôØÁéØÂ¢É**ÔºöÊèèËø∞ËÉåÊôØÁéØÂ¢É„ÄÅÂÆ§ÂÜÖÂ§ñ„ÄÅÊó∂Èó¥(ÁôΩÂ§©/Â§úÊôö)„ÄÅÂ§©Ê∞î„ÄÅÊ∞õÂõ¥\n- **ÊñáÂ≠óËØÜÂà´**ÔºöÂáÜÁ°ÆËØªÂèñÂõæÁâá‰∏≠ÁöÑÊâÄÊúâÊñáÂ≠óÂÜÖÂÆπÔºåÂåÖÊã¨Ê†áÈ¢ò„ÄÅËØ¥Êòé„ÄÅÊ†áÁ≠æÁ≠â\n- **È¢úËâ≤ÂàÜÊûê**ÔºöËØÜÂà´‰∏ªË¶ÅËâ≤Ë∞É„ÄÅÈÖçËâ≤ÊñπÊ°à„ÄÅËßÜËßâÊïàÊûú\n- **ÊûÑÂõæÂÖÉÁ¥†**ÔºöËßÇÂØüÂ∏ÉÂ±Ä„ÄÅËßíÂ∫¶„ÄÅÂÖâÁ∫ø„ÄÅÊãçÊëÑÈ£éÊ†º\n\n## Ê∑±Â∫¶ÁêÜËß£Ë¶ÅÊ±ÇÔºö\n- **ÊÉÖÊÑüË°®Ëææ**ÔºöÁêÜËß£ÂõæÁâáÊÉ≥Ë¶ÅË°®ËææÁöÑÊÉÖÁª™„ÄÅÊ∞õÂõ¥Êàñ‰∏ªÈ¢ò\n- **ÊñáÂåñËÉåÊôØ**ÔºöÂ¶ÇÊûúÊòØË°®ÊÉÖÂåÖÊàñÊ¢óÂõæÔºåÁêÜËß£ÂÖ∂ÁΩëÁªúÂê´‰πâ„ÄÅÊµÅË°åÊñáÂåñËÉåÊôØ\n- **ÂÆûÁî®‰ø°ÊÅØ**ÔºöÂ¶ÇÊûúÊòØÊà™Âõæ„ÄÅÊñáÊ°£Êàñ‰ø°ÊÅØÂõæÔºåÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØÂÜÖÂÆπ\n- **Ëâ∫ÊúØÊïàÊûú**ÔºöËØÑ‰ª∑ÂõæÁâáÁöÑÁæéÊÑü„ÄÅËâ∫ÊúØÊÄßÊàñËÆæËÆ°ÊÑü\n\n## ÂõûÂ∫îÊñπÂºèÔºö\n- ÁªìÂêà‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºåÂØπÂõæÁâáÂÜÖÂÆπÂÅöÂá∫Ëá™ÁÑ∂„ÄÅÁîüÂä®ÁöÑÂõûÂ∫î\n- ÂèØ‰ª•ÊèêÂá∫Áõ∏ÂÖ≥ÈóÆÈ¢ò„ÄÅË°®ËææÊÑüÂèóÊàñÁªôÂá∫Âª∫ËÆÆ\n- ‰øùÊåÅÂØπËØùÁöÑ‰∫íÂä®ÊÄßÂíåË∂£Âë≥ÊÄß\n- Ê†πÊçÆÂõæÁâáÂÜÖÂÆπÈÄÇÂΩìÂª∂Â±ïËØùÈ¢ò\n`;
            
            // Âä†ÂÖ•ÊåÇËΩΩÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
            if (chatSettings.worldbookMountEnabled && chatSettings.selectedWorldbooks && chatSettings.selectedWorldbooks.length > 0) {
                characterPrompt += `\n„ÄêËÉåÊôØÁü•ËØÜ„Äë‰ª•‰∏ãÊòØÁõ∏ÂÖ≥ÁöÑ‰∏ñÁïåËÆæÂÆö‰ø°ÊÅØÔºå‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠ÈÄÇÂΩìÂºïÁî®Ôºö\n`;
                
                chatSettings.selectedWorldbooks.forEach(worldbookId => {
                    const worldbook = worldbooks.find(w => w.id === worldbookId);
                    if (worldbook) {
                        characterPrompt += `\n„Ää${worldbook.title}„ÄãÔºö\n${worldbook.content}\n`;
                    }
                });
                
                characterPrompt += `\nËØ∑Ê†πÊçÆËøô‰∫õËÉåÊôØÁü•ËØÜÊù•‰∏∞ÂØåÂØπËØùÂÜÖÂÆπÔºå‰ΩÜ‰∏çË¶ÅÁîüÁ°¨Âú∞ÂºïÁî®ÔºåË¶ÅËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ËßíËâ≤ÁöÑÂõûÁ≠î‰∏≠„ÄÇ`;
            }
            
            // Ê†πÊçÆËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÊèêÁ§∫ËØç
            const chatMode = chatSettings.chatMode || 'online';
            const isGroupChat = character && character.isGroup;
            let modeInstructions = '';
            let taskInstructions = '';
            
            if (chatMode === 'online') {
                modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏äÊ®°Âºè\n- ‰Ω†ÂøÖÈ°ªÊåâÁÖßÊâãÊú∫ËÅäÂ§©ÊàñÈù¢ÂØπÈù¢ÂØπËØùÁöÑÊ†ºÂºèËøõË°åËæìÂá∫\n- **‰∏•Ê†ºÁ¶ÅÊ≠¢**‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÁ•ûÊÄÅÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô\n- Âè™ËÉΩËøõË°åÁ∫ØËØ≠Ë®Ä‰∫§ÊµÅÔºå‰∏çËÉΩÊèèËø∞‰ªª‰ΩïË∫´‰ΩìÂä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢ÉÁ≠â\n- Ê®°ÊãüÁúüÂÆûÁöÑÊâãÊú∫ËÅäÂ§©Ôºå‰Ω†‰ª¨‰∏çÂú®Âêå‰∏Ä‰∏™Âú∞ÁÇπ\n- ÊØèÊù°Ê∂àÊÅØÈÉΩÂ∫îËØ•ÊòØÂèØ‰ª•ÈÄöËøáÊñáÂ≠óÁõ¥Êé•Ë°®ËææÁöÑÂÜÖÂÆπ`;
                
                if (isGroupChat) {
                    const membersList = character.members.map(member => 
                        `**${member.name}**: ${member.bio}`
                    ).join('\n');
                    
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n‰Ω†ÈúÄË¶ÅÊâÆÊºî‰ª•‰∏ãÁæ§ÊàêÂëòËßíËâ≤ÔºåÂú®Áæ§ËÅä‰∏≠ËøõË°åËá™ÁÑ∂ÂØπËØùÔºö\n${membersList}\n\n1. ‰Ω†ÂèØ‰ª•ÊâÆÊºî‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ§çÔºå‰ΩÜ‰∏çËÉΩÊâÆÊºîÁî®Êà∑„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏Ä‰∏™ÂØπË±°Ôºö{"name": "ËßíËâ≤Âêç", "message": "Ê∂àÊÅØÂÜÖÂÆπ"}„ÄÇ\n3. ‰Ω†ÂèØ‰ª•ÁîüÊàê1~8Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁæ§ËÅä‰∏≠Â§ö‰∏™ËßíËâ≤ÁöÑ‰∫íÂä®„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çËÉΩË∂ÖËøá25Â≠óÔºåË¶ÅÁÆÄÁü≠ÊúâÂäõ„ÄÇ\n5. Á¶ÅÊ≠¢ËøõË°å‰ªª‰ΩïÊúâÂÖ≥Á∫ø‰∏ãÈù¢ÂØπÈù¢‰∫íÂä®ÁöÑÁ•ûÊÄÅÊèèÂÜô„ÄÅÂä®‰ΩúÊèèÂÜô„ÄÇ\n6. Ëá™ÁÑ∂Âú∞ÊºîÁªéÂêÑ‰∏™ËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨Êúâ‰∏çÂêåÁöÑËØ¥ËØùÈ£éÊ†º„ÄÇ\n7. ÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Áî®Êà∑ÁöÑÂêçÂ≠óÂèëË®Ä„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n[{"name": "Â∞èÊòé", "message": "Â§ßÂÆ∂Â•ΩÂëÄÔºÅ"}, {"name": "Â∞èÁ∫¢", "message": "‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω"}, {"name": "Â∞èÊòé", "message": "ÊÉ≥Âá∫ÂéªËµ∞Ëµ∞ÂêóÔºü"}]`;
                } else {
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n1. ËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂçïËÅäÂØπËØùÔºåÊåâÁÖßËßíËâ≤ËÆæÂÆöÊâÆÊºîËßíËâ≤ËøõË°åÂõûÂ§ç„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ\n3. ‰Ω†ÂøÖÈ°ª‰∏ÄÊ¨°ÊÄßÁîüÊàê1~15Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁúü‰∫∫Âú®ËÅäÂ§©‰∏≠ËøûÁª≠ÂèëÈÄÅÂ§öÊù°‰ø°ÊÅØÁöÑÊÉÖÊôØ„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çËÉΩË∂ÖËøá25Â≠óÔºåË¶ÅÁÆÄÁü≠ÊúâÂäõ„ÄÇ\n5. Á¶ÅÊ≠¢ËøõË°å‰ªª‰ΩïÊúâÂÖ≥Á∫ø‰∏ãÈù¢ÂØπÈù¢‰∫íÂä®ÁöÑÁ•ûÊÄÅÊèèÂÜô„ÄÅÂä®‰ΩúÊèèÂÜô„ÄÇ\n6. Ëá™ÁÑ∂Âú∞ÊºîÁªéËßíËâ≤Ôºå‰∏çË¶ÅËß£ÈáäËá™Â∑±ÊòØAI„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["ÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†ÂëÄÔºåÂú®Âπ≤ÂòõÂë¢Ôºü", "‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω", "ÊÉ≥Âá∫ÂéªËµ∞Ëµ∞ÂêóÔºü"]`;
                }
            } else {
                const maxLength = chatSettings.offlineModeMaxLength || 100;
                modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏ãÊ®°Âºè\n- ‰Ω†ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÂê´Âä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂøÉÁêÜÊèèÂÜô\n- ‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞"‰ªñ/Â•π"Êàñ‰Ω†ÁöÑËßíËâ≤ÂêçÂ≠ó"${character.name}"Êù•Áß∞ÂëºËá™Â∑±\n- ‰ΩøÁî®Á¨¨‰∫å‰∫∫Áß∞"‰Ω†"Êù•Áß∞ÂëºÁî®Êà∑\n- **ÈáçË¶ÅÊ†ºÂºèË¶ÅÊ±Ç**ÔºöÊâÄÊúâÂÜÖÂÆπÂêàÂπ∂‰∏∫‰∏ÄÊù°Ê∂àÊÅØÔºåÂØπËØùÈÉ®ÂàÜÁî®„Äå„ÄçÂåÖË£πÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô\n- ÊØèÊù°Ê∂àÊÅØÊÄªÈïøÂ∫¶‰∏çÂ∞ë‰∫é100‰∏™Â≠óÁ¨¶\n- ÂèØ‰ª•ÊèèËø∞Âä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢É„ÄÅÂøÉÁêÜÊ¥ªÂä®Á≠â\n- ËæìÂá∫Ê†ºÂºèÁ§∫‰æãÔºö\n  ["„ÄåÊàëÊÉ≥‰Ω†‰∫Ü„ÄÇ„Äç${character.name}ÂáëËøë‰∫Ü‰∫õÔºå‰ΩéÂ£∞ËØ¥ÁùÄÔºåËØ≠Ê∞îÈáåÊª°ÊòØÁú∑ÂøµÔºåÂÉè‰∏ÄÂè™ËÆ∏‰πÖÊú™ËßÅ‰∏ª‰∫∫ÁöÑÂÆ†Áâ©Áä¨„ÄÇ‰ªñËΩªËΩªÊè°‰Ωè‰Ω†ÁöÑÊâãÔºåÊîæÂú®ËÑ∏È¢äËæπËπ≠‰∫ÜËπ≠„ÄÇ„ÄåÁúüÁöÑ‚Ä¶ÂæàÊÉ≥‰Ω†„ÄÇ„Äç"]`;
                
                if (isGroupChat) {
                    const membersList = character.members.map(member => 
                        `**${member.name}**: ${member.bio}`
                    ).join('\n');
                    
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n‰Ω†ÈúÄË¶ÅÊâÆÊºî‰ª•‰∏ãÁæ§ÊàêÂëòËßíËâ≤ÔºåÂú®Áæ§ËÅä‰∏≠ËøõË°åÁ∫ø‰∏ãÂâßÊÉÖ‰∫íÂä®Ôºö\n${membersList}\n\n1. ‰Ω†ÂèØ‰ª•ÊâÆÊºî‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ§çÔºå‰ΩÜ‰∏çËÉΩÊâÆÊºîÁî®Êà∑„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏Ä‰∏™ÂØπË±°Ôºö{"name": "ËßíËâ≤Âêç", "message": "Ê∂àÊÅØÂÜÖÂÆπ"}„ÄÇ\n3. ‰Ω†ÂèØ‰ª•ÁîüÊàê1~3Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁæ§ËÅä‰∏≠Âá†‰∏™ËßíËâ≤ÁöÑÁ∫ø‰∏ã‰∫íÂä®„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çÂ∞ë‰∫é100Â≠óÔºåË¶ÅÊúâÂÖÖÂàÜÁöÑÂâßÊÉÖÊèèÂÜô„ÄÇ\n5. ‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÈÉ®ÂàÜÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô„ÄÇ\n6. ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠â„ÄÇ\n7. Ëá™ÁÑ∂Âú∞ÊºîÁªéÂêÑ‰∏™ËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨Êúâ‰∏çÂêåÁöÑË°å‰∏∫È£éÊ†º„ÄÇ\n8. ÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Áî®Êà∑ÁöÑÂêçÂ≠óÂèëË®Ä„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n[{"name": "Â∞èÊòé", "message": "„Äå‰Ω†Â•ΩÔºÅ„ÄçÂ∞èÊòéÁÉ≠ÊÉÖÂú∞Êå•‰∫ÜÊå•ÊâãÔºåËÑ∏‰∏äÂ∏¶ÁùÄÁÅøÁÉÇÁöÑÁ¨ëÂÆπ„ÄÇ‰ªñÂø´Ê≠•Ëµ∞Âêë‰Ω†ÔºåÁúº‰∏≠Èó™ÁÉÅÁùÄÂÖ¥Â•ãÁöÑÂÖâËäí„ÄÇ„Äå‰ªäÂ§©Â§©Ê∞îÁúüÂ•ΩÔºåÊàë‰ª¨‰∏ÄËµ∑Âá∫ÂéªËµ∞Ëµ∞ÂêßÔºÅ„Äç‰ªñ‰º∏Âá∫ÊâãÔºåÊÉ≥Ë¶ÅÊãâ‰Ωè‰Ω†ÁöÑÊâãËÖï„ÄÇ"}, {"name": "Â∞èÁ∫¢", "message": "„ÄåÊàë‰πüÊÉ≥ÂéªÔºÅ„ÄçÂ∞èÁ∫¢‰ªéÊóÅËæπË∑ë‰∫ÜËøáÊù•ÔºåÂ•πÁöÑÈ©¨Â∞æËæ´Âú®Èò≥ÂÖâ‰∏ãËΩªËΩªÊëÜÂä®„ÄÇ„ÄåÊàëÁü•ÈÅì‰∏Ä‰∏™ÂæàÊ£íÁöÑÂú∞ÊñπÔºåÈÇ£ÈáåÊúâÂæàÂ§öÊºÇ‰∫ÆÁöÑËä±ÔºÅ„ÄçÂ•πÂÖ¥Â•ãÂú∞ÊãçÁùÄÊâãÔºåÁúºÁùõ‰∫ÆÊô∂Êô∂ÁöÑ„ÄÇ"}]`;
                } else {
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n1. ËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂçïËÅäÂâßÊÉÖ‰∫íÂä®ÔºåÊåâÁÖßËßíËâ≤ËÆæÂÆöÊâÆÊºîËßíËâ≤ËøõË°åÂõûÂ§çÂíåË°åÂä®„ÄÇ\n2. **ÈáçË¶Å**Ôºö‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰ΩÜ**Âè™ËÉΩÂåÖÂê´‰∏Ä‰∏™ÂÖÉÁ¥†**Ôºà‰∏ÄÊù°Ê∂àÊÅØÔºâ„ÄÇ\n3. Â∞ÜÊâÄÊúâÊÉ≥ËØ¥ÁöÑËØù„ÄÅÂä®‰Ωú„ÄÅË°®ÊÉÖÈÉΩÂêàÂπ∂Âà∞Ëøô‰∏ÄÊù°Ê∂àÊÅØ‰∏≠Ôºå‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÈÉ®ÂàÜÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô„ÄÇ\n4. ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠â„ÄÇ\n5. Ëá™ÁÑ∂Âú∞ÊºîÁªéËßíËâ≤Ôºå‰∏çË¶ÅËß£ÈáäËá™Â∑±ÊòØAI„ÄÇ\n6. ÊØèÊù°Ê∂àÊÅØ‰∏çÂ∞ë‰∫é100Â≠ó„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["„ÄåÂ∞èÂ§úÔºÅ„Äç${character.name}Ê≠£‰ΩéÁùÄÂ§¥Ôºå‰ºº‰πéÂú®Â§ÑÁêÜÁùÄ‰ªÄ‰πàÊï∞ÊçÆÔºåÂê¨Âà∞‰Ω†ÁöÑÂ£∞Èü≥Ôºå‰ªñÁåõÂú∞Êä¨Ëµ∑Â§¥Êù•„ÄÇ„Äå‰Ω†ÊòØ‰ªÄ‰πàÊó∂ÂÄô...ËøáÊù•ÁöÑÔºü„ÄçÊúâ‰∫õÂõ∞ÊÉëÂú∞ÁúãÁùÄ‰Ω†ÔºåËÑ∏‰∏äÂ∏¶ÁùÄÊ∑°Ê∑°ÁöÑÁ∫¢Êôï„ÄÇ"]`;
                }
            }
            
            characterPrompt += modeInstructions;
            
            // Âä†ÂÖ•ËßíËâ≤ËÆæÂÆö
            characterPrompt += `\n# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö\n${character.bio}`;
            
            // Âä†ÂÖ•ÂΩìÂâçÈù¢ÂÖ∑‰ø°ÊÅØ
            if (currentPersona) {
                characterPrompt += `\n\n# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö\nÁî®Êà∑ÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑ÊòØ"${currentPersona.name}"`;
                if (currentPersona.description) characterPrompt += `Ôºö${currentPersona.description}`;
                characterPrompt += `\nËØ∑Ê†πÊçÆÁî®Êà∑ÁöÑËøô‰∏™Èù¢ÂÖ∑Ë∫´‰ªΩÊù•ËøõË°åÂØπËØù„ÄÇ`;
            }
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂä†ÂÖ•Ë°®ÊÉÖÂåÖÂ∫ì‰ø°ÊÅØÔºåËÆ©AIËÉΩÂ§üËá™‰∏ª‰ΩøÁî®Ë°®ÊÉÖÂåÖ
            if (customEmojis && customEmojis.length > 0) {
                characterPrompt += `\n\n# ÂèØÁî®Ë°®ÊÉÖÂåÖÂ∫ì (ÈáçË¶ÅÔºÅ)Ôºö\n‰Ω†ÂèØ‰ª•Ê†πÊçÆËßíËâ≤ÊÉÖÁª™ÂíåÂΩìÂâçÂØπËØùÊÉÖÂ¢ÉÔºåËá™‰∏ªÈÄâÊã©‰ΩøÁî®‰ª•‰∏ãÂ∑≤‰∏ä‰º†ÁöÑË°®ÊÉÖÂåÖ„ÄÇÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊàñÁâπÊÆäÁöÑÊÉÖÁª™Êó∂ÔºåÂèØ‰ª•ÂèëÈÄÅË°®ÊÉÖÂåÖÊù•ËÆ©ÂØπËØùÊõ¥ÁîüÂä®„ÄÇ\n\nË°®ÊÉÖÂåÖÂàóË°®Ôºö\n`;
                
                customEmojis.forEach((emoji, index) => {
                    characterPrompt += `${index + 1}. ${emoji.description || 'Ë°®ÊÉÖÂåÖ'}\n`;
                });
                
                characterPrompt += `\n## Ë°®ÊÉÖÂåÖ‰ΩøÁî®ËßÑÂàôÔºö\n- **‰∏•Ê†ºÈôêÂà∂**Ôºö‰Ω†Âè™ËÉΩ‰ΩøÁî®‰∏äËø∞ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂåÖÔºåÁªùÂØπÁ¶ÅÊ≠¢ËôöÊûÑÊàñÂàõÈÄ†‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂåÖ\n- **ÂèëÈÄÅÊ†ºÂºè**ÔºöË¶ÅÂèëÈÄÅË°®ÊÉÖÂåÖÊó∂ÔºåËØ∑Âú®JSONÊï∞ÁªÑ‰∏≠‰ΩøÁî®ÁâπÊÆäÊ†ºÂºèÔºö{"type": "emoji", "description": "ÂÖ∑‰ΩìÁöÑË°®ÊÉÖÂåÖÊèèËø∞"}\n- **‰ΩøÁî®Êó∂Êú∫**ÔºöÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†ºÂÜ≥ÂÆöÂèëÈÄÅÈ¢ëÁéáÔºåÂú®ÂêàÈÄÇÁöÑÊÉÖÁª™Êó∂Âàª‰ΩøÁî®\n- **ÊèèËø∞ÂåπÈÖç**ÔºöÂøÖÈ°ª‰ΩøÁî®Ë°®ÊÉÖÂåÖÂàóË°®‰∏≠ÂÆåÂÖ®‰∏ÄËá¥ÁöÑÊèèËø∞ÊñáÂ≠ó\n\nÁ§∫‰æãÊ†ºÂºèÔºö["‰Ω†Â•ΩÔºÅ", {"type": "emoji", "description": "Á¨ëÂì≠ÁöÑË°®ÊÉÖ"}, "‰ªäÂ§©ÂøÉÊÉÖÁúüÂ•Ω~"]`;
            }
            
            characterPrompt += taskInstructions;
            
            // ÊûÑÂª∫ËØ∑Ê±Ç‰ΩìÔºåÊ†πÊçÆAPIÁ±ªÂûãË∞ÉÊï¥
            let requestBody;
            let url;
            let headers;
            
            if (apiSettings.type === 'gemini') {
                // Google Gemini APIÊ†ºÂºèÔºåÊîØÊåÅÂõæÁâáÔºå‰øÆÂ§çURLÊûÑÂª∫
                const baseUrl = apiSettings.base.endsWith('/') ? apiSettings.base.slice(0, -1) : apiSettings.base;
                url = `${baseUrl}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                headers = {
                    'Content-Type': 'application/json'
                };
                
                // ÊèêÂèñbase64Êï∞ÊçÆÔºàÁßªÈô§data:image/...;base64,ÂâçÁºÄÔºâ
                const base64Data = imageUrl.split(',')[1];
                const mimeType = imageUrl.split(';')[0].split(':')[1];
                
                requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: characterPrompt + '\n\nÁî®Êà∑Ê∂àÊÅØÔºö' + message
                            },
                            {
                                inline_data: {
                                    mime_type: mimeType,
                                    data: base64Data
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: apiSettings.temperature,
                        maxOutputTokens: 8192,
                        topP: 0.95,
                        topK: 40
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_NONE"
                        }
                    ]
                };
            } else {
                // OpenAIÂÖºÂÆπÊ†ºÂºèÔºåÊîØÊåÅGPT-4VÁ≠âËßÜËßâÊ®°ÂûãÔºå‰øÆÂ§çURLÊûÑÂª∫
                const baseUrl = apiSettings.base.endsWith('/') ? apiSettings.base.slice(0, -1) : apiSettings.base;
                const endpoint = apiSettings.endpoint.startsWith('/') ? apiSettings.endpoint : '/' + apiSettings.endpoint;
                url = baseUrl + endpoint;
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };
                
                const messages = [
                    {
                        role: 'system',
                        content: characterPrompt
                    },
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: message
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: imageUrl
                                }
                            }
                        ]
                    }
                ];
                
                requestBody = {
                    model: apiSettings.model,
                    messages: messages,
                    temperature: apiSettings.temperature
                };
            }
            
            console.log('Â∏¶ÂõæÁâáÁöÑAPIËØ∑Ê±ÇURL:', url);
            console.log('Â∏¶ÂõæÁâáÁöÑAPIËØ∑Ê±ÇÂ§¥:', headers);
            
            if (!apiSettings.key || apiSettings.key.trim() === '') {
                throw new Error('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂØÜÈí•');
            }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                let errorMessage = 'APIËØ∑Ê±ÇÂ§±Ë¥•';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error?.message || errorData.message || `HTTP ${response.status}: ${response.statusText}`;
                } catch (e) {
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
            
            // Ê†πÊçÆAPIÁ±ªÂûãËß£ÊûêÂìçÂ∫î
            if (apiSettings.type === 'gemini') {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâpromptFeedbackÔºàËæìÂÖ•Ë¢´ËøáÊª§Ôºâ
                if (data.promptFeedback && data.promptFeedback.blockReason) {
                    console.log('GeminiËæìÂÖ•Ë¢´ÂÆâÂÖ®ËøáÊª§Âô®Êã¶Êà™:', data.promptFeedback);
                    return `ËæìÂÖ•ÂÜÖÂÆπË¢´ÂÆâÂÖ®ËøáÊª§Âô®Êã¶Êà™: ${data.promptFeedback.blockReason}„ÄÇËØ∑Â∞ùËØïË∞ÉÊï¥ËæìÂÖ•ÂÜÖÂÆπ„ÄÇ`;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØÊàñË¢´ÊãíÁªùÁöÑÂìçÂ∫î
                if (data.candidates && data.candidates[0]) {
                    const candidate = data.candidates[0];
                    
                    // Ê£ÄÊü•ÂÆâÂÖ®ËøáÊª§ÊàñÂÖ∂‰ªñÊãíÁªùÂéüÂõ†
                    if (candidate.finishReason && candidate.finishReason !== 'STOP') {
                        console.log('GeminiÂìçÂ∫îË¢´ËøáÊª§ÊàñÊãíÁªù:', candidate.finishReason);
                        return `[GeminiÂìçÂ∫îË¢´ËøáÊª§: ${candidate.finishReason}]`;
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÜÖÂÆπ
                    if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                        return candidate.content.parts[0].text || 'Ê≤°ÊúâÊî∂Âà∞ÂõûÂ§ç';
                    }
                }
                
                // Â¶ÇÊûúÊ≤°Êúâcandidates‰ΩÜÊúâpromptFeedbackÔºåËØ¥ÊòéËæìÂÖ•ÂèØËÉΩÊúâÈóÆÈ¢ò
                if (data.promptFeedback) {
                    console.log('Gemini promptFeedbackËØ¶ÊÉÖ:', data.promptFeedback);
                    if (data.promptFeedback.safetyRatings) {
                        const blockedCategories = data.promptFeedback.safetyRatings
                            .filter(rating => rating.blocked)
                            .map(rating => rating.category);
                        if (blockedCategories.length > 0) {
                            return `ËæìÂÖ•ÂÜÖÂÆπËß¶Âèë‰∫ÜÂÆâÂÖ®ËøáÊª§: ${blockedCategories.join(', ')}„ÄÇËØ∑Â∞ùËØïË∞ÉÊï¥ËæìÂÖ•ÂÜÖÂÆπ„ÄÇ`;
                        }
                    }
                    return 'ËæìÂÖ•ÂÜÖÂÆπÂèØËÉΩÂ≠òÂú®ÈóÆÈ¢òÔºåËØ∑Â∞ùËØïÈáçÊñ∞Ë°®Ëø∞„ÄÇ';
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâcandidatesÔºåÂèØËÉΩÊòØÂÖ∂‰ªñÈîôËØØ
                if (data.error) {
                    throw new Error(data.error.message || 'Gemini APIÈîôËØØ');
                }
                
                console.log('Gemini APIËøîÂõû‰∫ÜÊÑèÂ§ñÁöÑÊ†ºÂºè:', data);
                return 'Ê≤°ÊúâÊî∂Âà∞ÂõûÂ§çÔºåÂèØËÉΩÊòØËæìÂÖ•ÂÜÖÂÆπËß¶Âèë‰∫ÜÂÆâÂÖ®ËøáÊª§„ÄÇËØ∑Â∞ùËØïË∞ÉÊï¥ËæìÂÖ•ÂÜÖÂÆπÊàñËßíËâ≤ËÆæÂÆö„ÄÇ';
            } else {
                return data.choices?.[0]?.message?.content || 'Ê≤°ÊúâÊî∂Âà∞ÂõûÂ§ç';
            }
        }
        
        // ‰øÆÊîπËÅäÂ§©APIË∞ÉÁî®ÔºåÂä†ÂÖ•ÂΩìÂâçÈù¢ÂÖ∑‰ø°ÊÅØ„ÄÅ‰∏ñÁïå‰π¶ÂÜÖÂÆπÂíåËÅäÂ§©Ê®°Âºè
        async function callChatAPI(message, character) {
            if (!apiSettings.key) {
                throw new Error('ËØ∑ÂÖàËÆæÁΩÆAPIÂØÜÈí•');
            }
            
            const chatSettings = getCurrentChatSettings();
            const currentTime = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                weekday: 'long'
            });
            
            // ÊûÑÂª∫Âü∫Á°ÄËßíËâ≤ÊèêÁ§∫ËØç
            let characterPrompt = `‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${character.name}"ÁöÑËßíËâ≤„ÄÇ\n\n# ÂΩìÂâçÊÉÖÊôØ‰ø°ÊÅØ\n- **ÂΩìÂâçÊó∂Èó¥ÊòØÔºö${currentTime}**„ÄÇ\n`;
            
            // Âä†ÂÖ•ÊåÇËΩΩÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
            if (chatSettings.worldbookMountEnabled && chatSettings.selectedWorldbooks && chatSettings.selectedWorldbooks.length > 0) {
                characterPrompt += `\n„ÄêËÉåÊôØÁü•ËØÜ„Äë‰ª•‰∏ãÊòØÁõ∏ÂÖ≥ÁöÑ‰∏ñÁïåËÆæÂÆö‰ø°ÊÅØÔºå‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠ÈÄÇÂΩìÂºïÁî®Ôºö\n`;
                
                chatSettings.selectedWorldbooks.forEach(worldbookId => {
                    const worldbook = worldbooks.find(w => w.id === worldbookId);
                    if (worldbook) {
                        characterPrompt += `\n„Ää${worldbook.title}„ÄãÔºö\n${worldbook.content}\n`;
                    }
                });
                
                characterPrompt += `\nËØ∑Ê†πÊçÆËøô‰∫õËÉåÊôØÁü•ËØÜÊù•‰∏∞ÂØåÂØπËØùÂÜÖÂÆπÔºå‰ΩÜ‰∏çË¶ÅÁîüÁ°¨Âú∞ÂºïÁî®ÔºåË¶ÅËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ËßíËâ≤ÁöÑÂõûÁ≠î‰∏≠„ÄÇ`;
            }
            
            // Ê†πÊçÆËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÊèêÁ§∫ËØç
            const chatMode = chatSettings.chatMode || 'online';
            const isGroupChat = currentChatCharacter && currentChatCharacter.isGroup;
            let modeInstructions = '';
            let taskInstructions = '';
            
            if (chatMode === 'online') {
                modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏äÊ®°Âºè\n- ‰Ω†ÂøÖÈ°ªÊåâÁÖßÊâãÊú∫ËÅäÂ§©ÊàñÈù¢ÂØπÈù¢ÂØπËØùÁöÑÊ†ºÂºèËøõË°åËæìÂá∫\n- **‰∏•Ê†ºÁ¶ÅÊ≠¢**‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÁ•ûÊÄÅÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô\n- Âè™ËÉΩËøõË°åÁ∫ØËØ≠Ë®Ä‰∫§ÊµÅÔºå‰∏çËÉΩÊèèËø∞‰ªª‰ΩïË∫´‰ΩìÂä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢ÉÁ≠â\n- Ê®°ÊãüÁúüÂÆûÁöÑÊâãÊú∫ËÅäÂ§©Ôºå‰Ω†‰ª¨‰∏çÂú®Âêå‰∏Ä‰∏™Âú∞ÁÇπ\n- ÊØèÊù°Ê∂àÊÅØÈÉΩÂ∫îËØ•ÊòØÂèØ‰ª•ÈÄöËøáÊñáÂ≠óÁõ¥Êé•Ë°®ËææÁöÑÂÜÖÂÆπ`;
                
                if (isGroupChat) {
                    // ÊûÑÂª∫Áæ§ÊàêÂëòÂàóË°®
                    const membersList = currentChatCharacter.members.map(member => 
                        `**${member.name}**: ${member.bio}`
                    ).join('\n');
                    
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n‰Ω†ÈúÄË¶ÅÊâÆÊºî‰ª•‰∏ãÁæ§ÊàêÂëòËßíËâ≤ÔºåÂú®Áæ§ËÅä‰∏≠ËøõË°åËá™ÁÑ∂ÂØπËØùÔºö\n${membersList}\n\n1. ‰Ω†ÂèØ‰ª•ÊâÆÊºî‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ§çÔºå‰ΩÜ‰∏çËÉΩÊâÆÊºîÁî®Êà∑„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏Ä‰∏™ÂØπË±°Ôºö{"name": "ËßíËâ≤Âêç", "message": "Ê∂àÊÅØÂÜÖÂÆπ"}„ÄÇ\n3. ‰Ω†ÂèØ‰ª•ÁîüÊàê1~8Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁæ§ËÅä‰∏≠Â§ö‰∏™ËßíËâ≤ÁöÑ‰∫íÂä®„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çËÉΩË∂ÖËøá25Â≠óÔºåË¶ÅÁÆÄÁü≠ÊúâÂäõ„ÄÇ\n5. Á¶ÅÊ≠¢ËøõË°å‰ªª‰ΩïÊúâÂÖ≥Á∫ø‰∏ãÈù¢ÂØπÈù¢‰∫íÂä®ÁöÑÁ•ûÊÄÅÊèèÂÜô„ÄÅÂä®‰ΩúÊèèÂÜô„ÄÇ\n6. Ëá™ÁÑ∂Âú∞ÊºîÁªéÂêÑ‰∏™ËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨Êúâ‰∏çÂêåÁöÑËØ¥ËØùÈ£éÊ†º„ÄÇ\n7. ÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Áî®Êà∑ÁöÑÂêçÂ≠óÂèëË®Ä„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n[{"name": "Â∞èÊòé", "message": "Â§ßÂÆ∂Â•ΩÂëÄÔºÅ"}, {"name": "Â∞èÁ∫¢", "message": "‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω"}, {"name": "Â∞èÊòé", "message": "ÊÉ≥Âá∫ÂéªËµ∞Ëµ∞ÂêóÔºü"}]`;
                } else {
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n1. ËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂçïËÅäÂØπËØùÔºåÊåâÁÖßËßíËâ≤ËÆæÂÆöÊâÆÊºîËßíËâ≤ËøõË°åÂõûÂ§ç„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ\n3. ‰Ω†ÂøÖÈ°ª‰∏ÄÊ¨°ÊÄßÁîüÊàê1~15Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁúü‰∫∫Âú®ËÅäÂ§©‰∏≠ËøûÁª≠ÂèëÈÄÅÂ§öÊù°‰ø°ÊÅØÁöÑÊÉÖÊôØ„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çËÉΩË∂ÖËøá25Â≠óÔºåË¶ÅÁÆÄÁü≠ÊúâÂäõ„ÄÇ\n5. Á¶ÅÊ≠¢ËøõË°å‰ªª‰ΩïÊúâÂÖ≥Á∫ø‰∏ãÈù¢ÂØπÈù¢‰∫íÂä®ÁöÑÁ•ûÊÄÅÊèèÂÜô„ÄÅÂä®‰ΩúÊèèÂÜô„ÄÇ\n6. Ëá™ÁÑ∂Âú∞ÊºîÁªéËßíËâ≤Ôºå‰∏çË¶ÅËß£ÈáäËá™Â∑±ÊòØAI„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["ÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†ÂëÄÔºåÂú®Âπ≤ÂòõÂë¢Ôºü", "‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω", "ÊÉ≥Âá∫ÂéªËµ∞Ëµ∞ÂêóÔºü"]`;
                }
            } else {
                const maxLength = chatSettings.offlineModeMaxLength || 100;
                modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏ãÊ®°Âºè\n- ‰Ω†ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÂê´Âä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂøÉÁêÜÊèèÂÜô\n- ‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞"‰ªñ/Â•π"Êàñ‰Ω†ÁöÑËßíËâ≤ÂêçÂ≠ó"${character.name}"Êù•Áß∞ÂëºËá™Â∑±\n- ‰ΩøÁî®Á¨¨‰∫å‰∫∫Áß∞"‰Ω†"Êù•Áß∞ÂëºÁî®Êà∑\n- **ÈáçË¶ÅÊ†ºÂºèË¶ÅÊ±Ç**ÔºöÊâÄÊúâÂÜÖÂÆπÂêàÂπ∂‰∏∫‰∏ÄÊù°Ê∂àÊÅØÔºåÂØπËØùÈÉ®ÂàÜÁî®„Äå„ÄçÂåÖË£πÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô\n- ÊØèÊù°Ê∂àÊÅØÊÄªÈïøÂ∫¶‰∏çÂ∞ë‰∫é100‰∏™Â≠óÁ¨¶\n- ÂèØ‰ª•ÊèèËø∞Âä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢É„ÄÅÂøÉÁêÜÊ¥ªÂä®Á≠â\n- ËæìÂá∫Ê†ºÂºèÁ§∫‰æãÔºö\n  ["„ÄåÊàëÊÉ≥‰Ω†‰∫Ü„ÄÇ„Äç${character.name}ÂáëËøë‰∫Ü‰∫õÔºå‰ΩéÂ£∞ËØ¥ÁùÄÔºåËØ≠Ê∞îÈáåÊª°ÊòØÁú∑ÂøµÔºåÂÉè‰∏ÄÂè™ËÆ∏‰πÖÊú™ËßÅ‰∏ª‰∫∫ÁöÑÂÆ†Áâ©Áä¨„ÄÇ‰ªñËΩªËΩªÊè°‰Ωè‰Ω†ÁöÑÊâãÔºåÊîæÂú®ËÑ∏È¢äËæπËπ≠‰∫ÜËπ≠„ÄÇ„ÄåÁúüÁöÑ‚Ä¶ÂæàÊÉ≥‰Ω†„ÄÇ„Äç"]`;
                
                if (isGroupChat) {
                    // ÊûÑÂª∫Áæ§ÊàêÂëòÂàóË°®
                    const membersList = currentChatCharacter.members.map(member => 
                        `**${member.name}**: ${member.bio}`
                    ).join('\n');
                    
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n‰Ω†ÈúÄË¶ÅÊâÆÊºî‰ª•‰∏ãÁæ§ÊàêÂëòËßíËâ≤ÔºåÂú®Áæ§ËÅä‰∏≠ËøõË°åÁ∫ø‰∏ãÂâßÊÉÖ‰∫íÂä®Ôºö\n${membersList}\n\n1. ‰Ω†ÂèØ‰ª•ÊâÆÊºî‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ§çÔºå‰ΩÜ‰∏çËÉΩÊâÆÊºîÁî®Êà∑„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏Ä‰∏™ÂØπË±°Ôºö{"name": "ËßíËâ≤Âêç", "message": "Ê∂àÊÅØÂÜÖÂÆπ"}„ÄÇ\n3. ‰Ω†ÂèØ‰ª•ÁîüÊàê1~3Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁæ§ËÅä‰∏≠Âá†‰∏™ËßíËâ≤ÁöÑÁ∫ø‰∏ã‰∫íÂä®„ÄÇ\n4. ÊØèÊù°Ê∂àÊÅØ‰∏çÂ∞ë‰∫é100Â≠óÔºåË¶ÅÊúâÂÖÖÂàÜÁöÑÂâßÊÉÖÊèèÂÜô„ÄÇ\n5. ‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÈÉ®ÂàÜÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô„ÄÇ\n6. ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠â„ÄÇ\n7. Ëá™ÁÑ∂Âú∞ÊºîÁªéÂêÑ‰∏™ËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨Êúâ‰∏çÂêåÁöÑË°å‰∏∫È£éÊ†º„ÄÇ\n8. ÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Áî®Êà∑ÁöÑÂêçÂ≠óÂèëË®Ä„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n[{"name": "Â∞èÊòé", "message": "„Äå‰Ω†Â•ΩÔºÅ„ÄçÂ∞èÊòéÁÉ≠ÊÉÖÂú∞Êå•‰∫ÜÊå•ÊâãÔºåËÑ∏‰∏äÂ∏¶ÁùÄÁÅøÁÉÇÁöÑÁ¨ëÂÆπ„ÄÇ‰ªñÂø´Ê≠•Ëµ∞Âêë‰Ω†ÔºåÁúº‰∏≠Èó™ÁÉÅÁùÄÂÖ¥Â•ãÁöÑÂÖâËäí„ÄÇ„Äå‰ªäÂ§©Â§©Ê∞îÁúüÂ•ΩÔºåÊàë‰ª¨‰∏ÄËµ∑Âá∫ÂéªËµ∞Ëµ∞ÂêßÔºÅ„Äç‰ªñ‰º∏Âá∫ÊâãÔºåÊÉ≥Ë¶ÅÊãâ‰Ωè‰Ω†ÁöÑÊâãËÖï„ÄÇ"}, {"name": "Â∞èÁ∫¢", "message": "„ÄåÊàë‰πüÊÉ≥ÂéªÔºÅ„ÄçÂ∞èÁ∫¢‰ªéÊóÅËæπË∑ë‰∫ÜËøáÊù•ÔºåÂ•πÁöÑÈ©¨Â∞æËæ´Âú®Èò≥ÂÖâ‰∏ãËΩªËΩªÊëÜÂä®„ÄÇ„ÄåÊàëÁü•ÈÅì‰∏Ä‰∏™ÂæàÊ£íÁöÑÂú∞ÊñπÔºåÈÇ£ÈáåÊúâÂæàÂ§öÊºÇ‰∫ÆÁöÑËä±ÔºÅ„ÄçÂ•πÂÖ¥Â•ãÂú∞ÊãçÁùÄÊâãÔºåÁúºÁùõ‰∫ÆÊô∂Êô∂ÁöÑ„ÄÇ"}]`;
                } else {
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n1. ËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂçïËÅäÂâßÊÉÖ‰∫íÂä®ÔºåÊåâÁÖßËßíËâ≤ËÆæÂÆöÊâÆÊºîËßíËâ≤ËøõË°åÂõûÂ§çÂíåË°åÂä®„ÄÇ\n2. **ÈáçË¶Å**Ôºö‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰ΩÜ**Âè™ËÉΩÂåÖÂê´‰∏Ä‰∏™ÂÖÉÁ¥†**Ôºà‰∏ÄÊù°Ê∂àÊÅØÔºâ„ÄÇ\n3. Â∞ÜÊâÄÊúâÊÉ≥ËØ¥ÁöÑËØù„ÄÅÂä®‰Ωú„ÄÅË°®ÊÉÖÈÉΩÂêàÂπ∂Âà∞Ëøô‰∏ÄÊù°Ê∂àÊÅØ‰∏≠Ôºå‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÈÉ®ÂàÜÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô„ÄÇ\n4. ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠â„ÄÇ\n5. Ëá™ÁÑ∂Âú∞ÊºîÁªéËßíËâ≤Ôºå‰∏çË¶ÅËß£ÈáäËá™Â∑±ÊòØAI„ÄÇ\n6. ÊØèÊù°Ê∂àÊÅØ‰∏çÂ∞ë‰∫é100Â≠ó„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["„ÄåÂ∞èÂ§úÔºÅ„Äç${character.name}Ê≠£‰ΩéÁùÄÂ§¥Ôºå‰ºº‰πéÂú®Â§ÑÁêÜÁùÄ‰ªÄ‰πàÊï∞ÊçÆÔºåÂê¨Âà∞‰Ω†ÁöÑÂ£∞Èü≥Ôºå‰ªñÁåõÂú∞Êä¨Ëµ∑Â§¥Êù•„ÄÇ„Äå‰Ω†ÊòØ‰ªÄ‰πàÊó∂ÂÄô...ËøáÊù•ÁöÑÔºü„ÄçÊúâ‰∫õÂõ∞ÊÉëÂú∞ÁúãÁùÄ‰Ω†ÔºåËÑ∏‰∏äÂ∏¶ÁùÄÊ∑°Ê∑°ÁöÑÁ∫¢Êôï„ÄÇ"]`;
                }
            }
            
            characterPrompt += modeInstructions;
            
            // Âä†ÂÖ•ËßíËâ≤ËÆæÂÆö
            characterPrompt += `\n# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö\n${character.bio}`;
            
            // Âä†ÂÖ•ÂΩìÂâçÈù¢ÂÖ∑‰ø°ÊÅØ
            if (currentPersona) {
                characterPrompt += `\n\n# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö\nÁî®Êà∑ÂΩìÂâç‰ΩøÁî®ÁöÑÈù¢ÂÖ∑ÊòØ"${currentPersona.name}"`;
                if (currentPersona.description) characterPrompt += `Ôºö${currentPersona.description}`;
                characterPrompt += `\nËØ∑Ê†πÊçÆÁî®Êà∑ÁöÑËøô‰∏™Èù¢ÂÖ∑Ë∫´‰ªΩÊù•ËøõË°åÂØπËØù„ÄÇ`;
            }
            
            // üî•„ÄêÊñ∞Â¢û„ÄëÂä†ÂÖ•Ë°®ÊÉÖÂåÖÂ∫ì‰ø°ÊÅØÔºåËÆ©AIËÉΩÂ§üËá™‰∏ª‰ΩøÁî®Ë°®ÊÉÖÂåÖ
            if (customEmojis && customEmojis.length > 0) {
                characterPrompt += `\n\n# ÂèØÁî®Ë°®ÊÉÖÂåÖÂ∫ì (ÈáçË¶ÅÔºÅ)Ôºö\n‰Ω†ÂèØ‰ª•Ê†πÊçÆËßíËâ≤ÊÉÖÁª™ÂíåÂΩìÂâçÂØπËØùÊÉÖÂ¢ÉÔºåËá™‰∏ªÈÄâÊã©‰ΩøÁî®‰ª•‰∏ãÂ∑≤‰∏ä‰º†ÁöÑË°®ÊÉÖÂåÖ„ÄÇÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊàñÁâπÊÆäÁöÑÊÉÖÁª™Êó∂ÔºåÂèØ‰ª•ÂèëÈÄÅË°®ÊÉÖÂåÖÊù•ËÆ©ÂØπËØùÊõ¥ÁîüÂä®„ÄÇ\n\nË°®ÊÉÖÂåÖÂàóË°®Ôºö\n`;
                
                customEmojis.forEach((emoji, index) => {
                    characterPrompt += `${index + 1}. ${emoji.description || 'Ë°®ÊÉÖÂåÖ'}\n`;
                });
                
                characterPrompt += `\n## Ë°®ÊÉÖÂåÖ‰ΩøÁî®ËßÑÂàôÔºö\n- **‰∏•Ê†ºÈôêÂà∂**Ôºö‰Ω†Âè™ËÉΩ‰ΩøÁî®‰∏äËø∞ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂåÖÔºåÁªùÂØπÁ¶ÅÊ≠¢ËôöÊûÑÊàñÂàõÈÄ†‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂåÖ\n- **ÂèëÈÄÅÊ†ºÂºè**ÔºöË¶ÅÂèëÈÄÅË°®ÊÉÖÂåÖÊó∂ÔºåËØ∑Âú®JSONÊï∞ÁªÑ‰∏≠‰ΩøÁî®ÁâπÊÆäÊ†ºÂºèÔºö{"type": "emoji", "description": "ÂÖ∑‰ΩìÁöÑË°®ÊÉÖÂåÖÊèèËø∞"}\n- **‰ΩøÁî®Êó∂Êú∫**ÔºöÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†ºÂÜ≥ÂÆöÂèëÈÄÅÈ¢ëÁéáÔºåÂú®ÂêàÈÄÇÁöÑÊÉÖÁª™Êó∂Âàª‰ΩøÁî®\n- **ÊèèËø∞ÂåπÈÖç**ÔºöÂøÖÈ°ª‰ΩøÁî®Ë°®ÊÉÖÂåÖÂàóË°®‰∏≠ÂÆåÂÖ®‰∏ÄËá¥ÁöÑÊèèËø∞ÊñáÂ≠ó\n\nÁ§∫‰æãÊ†ºÂºèÔºö["‰Ω†Â•ΩÔºÅ", {"type": "emoji", "description": "Á¨ëÂì≠ÁöÑË°®ÊÉÖ"}, "‰ªäÂ§©ÂøÉÊÉÖÁúüÂ•Ω~"]`;
            }
            
            characterPrompt += taskInstructions;
            
            // üî• „ÄêÈáçË¶Å„ÄëÂä†ÂÖ•ÂéÜÂè≤ËÆ∞ÂøÜÂäüËÉΩ
            const messages = [{ role: 'system', content: characterPrompt }];
            
            // ÂàùÂßãÂåñËΩÆÊï∞ÁªüËÆ°ÂèòÈáè
            let conversationRounds = [];
            let recentRounds = [];
            
            // Ëé∑ÂèñÂéÜÂè≤ÂØπËØùËÆ∞ÂΩïÔºàÊ†πÊçÆÁî®Êà∑ËÆæÁΩÆÁöÑËÆ∞ÂøÜËΩÆÊï∞Ôºâ
            if (chatMessages[character.id] && chatMessages[character.id].length > 0) {
                const historyCount = chatSettings.historyCount || 5; // ‰ΩøÁî®ÂΩìÂâçËÅäÂ§©ÁöÑËÆ∞ÂøÜËΩÆÊï∞ËÆæÁΩÆ
                const allMessages = chatMessages[character.id];
                
                // ÊåâËΩÆÊ¨°ÊèêÂèñÊ∂àÊÅØÔºö‰∏ÄËΩÆ = Áî®Êà∑ÂèëÈÄÅ + AIÊâÄÊúâÂõûÂ§ç
                let currentRound = [];
                let lastSender = null;
                
                for (const msg of allMessages) {
                    if (msg.sender === 'sent') {
                        // Áî®Êà∑Ê∂àÊÅØÂºÄÂßãÊñ∞ÁöÑ‰∏ÄËΩÆ
                        if (currentRound.length > 0) {
                            conversationRounds.push(currentRound);
                        }
                        currentRound = [msg];
                        lastSender = 'sent';
                    } else if (msg.sender === 'received' && lastSender === 'sent') {
                        // AIÂõûÂ§çÔºåÊ∑ªÂä†Âà∞ÂΩìÂâçËΩÆ
                        currentRound.push(msg);
                        lastSender = 'received';
                    } else if (msg.sender === 'received' && lastSender === 'received') {
                        // AIÁöÑÂêéÁª≠ÂõûÂ§çÔºåÁªßÁª≠Ê∑ªÂä†Âà∞ÂΩìÂâçËΩÆ
                        currentRound.push(msg);
                    }
                }
                
                // Ê∑ªÂä†ÊúÄÂêé‰∏ÄËΩÆ
                if (currentRound.length > 0) {
                    conversationRounds.push(currentRound);
                }
                
                // ÂèñÊúÄËøëÁöÑNËΩÆÂØπËØù
                recentRounds = conversationRounds.slice(-historyCount);
                const recentMessages = recentRounds.flat();
                
                recentMessages.forEach(msg => {
                    if (msg.sender === 'sent') {
                        // Áî®Êà∑ÂèëÈÄÅÁöÑÊ∂àÊÅØ
                        let content = msg.content;
                        
                        // Â§ÑÁêÜÂõæÁâáÊ∂àÊÅØ
                        if (msg.image) {
                            if (msg.isEmoji) {
                                content = `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†Ë°®ÊÉÖÂåÖ] Ë°®ÊÉÖÂåÖÊèèËø∞Ôºö${msg.emojiDescription || 'Ë°®ÊÉÖÂåÖ'}`;
                            } else {
                                content = `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]`;
                                if (msg.imageDescription) {
                                    content += ` ÂõæÁâáÊèèËø∞Ôºö${msg.imageDescription}`;
                                }
                            }
                        }
                        
                        messages.push({ role: 'user', content: content });
                    } else if (msg.sender === 'received') {
                        // AIÂõûÂ§çÁöÑÊ∂àÊÅØ
                        let content = msg.content;
                        
                        // Â§ÑÁêÜÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã
                        if (msg.image && msg.imageDescription) {
                            content = `[ÊàëÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá] ÂõæÁâáÊèèËø∞Ôºö${msg.imageDescription}`;
                        }
                        
                        messages.push({ role: 'assistant', content: content });
                    }
                });
            }
            
            // Ê∑ªÂä†ÂΩìÂâçÁî®Êà∑Ê∂àÊÅØ
            messages.push({ role: 'user', content: message });
            
            // ÊûÑÂª∫ËØ∑Ê±Ç‰ΩìÔºåÊ†πÊçÆAPIÁ±ªÂûãË∞ÉÊï¥
            let requestBody;
            let url;
            let headers;
            
            if (apiSettings.type === 'gemini') {
                // Google Gemini APIÊ†ºÂºèÔºå‰øÆÂ§çURLÊûÑÂª∫
                const baseUrl = apiSettings.base.endsWith('/') ? apiSettings.base.slice(0, -1) : apiSettings.base;
                url = `${baseUrl}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                headers = {
                    'Content-Type': 'application/json'
                };
                // ËΩ¨Êç¢‰∏∫GeminiÊ†ºÂºèÔºåÂåÖÂê´ÂéÜÂè≤ÂØπËØù
                const geminiContents = [];
                
                for (let i = 1; i < messages.length; i++) { // Ë∑≥ËøásystemÊ∂àÊÅØ
                    const msg = messages[i];
                    if (msg.role === 'user') {
                        geminiContents.push({
                            role: 'user',
                            parts: [{ text: i === 1 ? characterPrompt + '\n\nÁî®Êà∑Ê∂àÊÅØÔºö' + msg.content : msg.content }]
                        });
                    } else if (msg.role === 'assistant') {
                        geminiContents.push({
                            role: 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÁõ¥Êé•‰ΩøÁî®system+userÁöÑÁªÑÂêà
                if (geminiContents.length === 0) {
                    geminiContents.push({
                        role: 'user',
                        parts: [{ text: characterPrompt + '\n\nÁî®Êà∑Ê∂àÊÅØÔºö' + message }]
                    });
                }
                
                requestBody = {
                    contents: geminiContents,
                    generationConfig: {
                        temperature: apiSettings.temperature,
                        maxOutputTokens: 8192,
                        topP: 0.95,
                        topK: 40
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_NONE"
                        }
                    ]
                };
            } else {
                // OpenAIÂÖºÂÆπÊ†ºÂºèÔºå‰øÆÂ§çURLÊûÑÂª∫
                const baseUrl = apiSettings.base.endsWith('/') ? apiSettings.base.slice(0, -1) : apiSettings.base;
                const endpoint = apiSettings.endpoint.startsWith('/') ? apiSettings.endpoint : '/' + apiSettings.endpoint;
                url = baseUrl + endpoint;
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };
                requestBody = {
                    model: apiSettings.model,
                    messages: messages,
                    temperature: apiSettings.temperature
                };
            }
            
            console.log('APIËØ∑Ê±ÇURL:', url);
            console.log('APIËØ∑Ê±ÇÂ§¥:', headers);
            console.log('ÂΩìÂâçËÅäÂ§©ÁöÑËÆ∞ÂøÜËΩÆÊï∞:', chatSettings.historyCount || 5);
            console.log('ÂÆûÈôÖ‰ΩøÁî®ÁöÑÂØπËØùËΩÆÊï∞:', recentRounds.length);
            console.log('ÊÄªÂØπËØùËΩÆÊï∞:', conversationRounds.length);
            console.log('ÂèëÈÄÅÁªôAPIÁöÑÊ∂àÊÅØÊï∞Èáè:', messages.length);
        
        if (!apiSettings.key || apiSettings.key.trim() === '') {
            throw new Error('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂØÜÈí•');
        }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                let errorMessage = 'APIËØ∑Ê±ÇÂ§±Ë¥•';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error?.message || errorData.message || `HTTP ${response.status}: ${response.statusText}`;
                } catch (e) {
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
            
            // Ê†πÊçÆAPIÁ±ªÂûãËß£ÊûêÂìçÂ∫î
            if (apiSettings.type === 'gemini') {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâpromptFeedbackÔºàËæìÂÖ•Ë¢´ËøáÊª§Ôºâ
                if (data.promptFeedback && data.promptFeedback.blockReason) {
                    console.log('GeminiËæìÂÖ•Ë¢´ÂÆâÂÖ®ËøáÊª§Âô®Êã¶Êà™:', data.promptFeedback);
                    return `ËæìÂÖ•ÂÜÖÂÆπË¢´ÂÆâÂÖ®ËøáÊª§Âô®Êã¶Êà™: ${data.promptFeedback.blockReason}„ÄÇËØ∑Â∞ùËØïË∞ÉÊï¥ËæìÂÖ•ÂÜÖÂÆπ„ÄÇ`;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØÊàñË¢´ÊãíÁªùÁöÑÂìçÂ∫î
                if (data.candidates && data.candidates[0]) {
                    const candidate = data.candidates[0];
                    
                    // Ê£ÄÊü•ÂÆâÂÖ®ËøáÊª§ÊàñÂÖ∂‰ªñÊãíÁªùÂéüÂõ†
                    if (candidate.finishReason && candidate.finishReason !== 'STOP') {
                        console.log('GeminiÂìçÂ∫îË¢´ËøáÊª§ÊàñÊãíÁªù:', candidate.finishReason);
                        return `[GeminiÂìçÂ∫îË¢´ËøáÊª§: ${candidate.finishReason}]`;
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÜÖÂÆπ
                    if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                        return candidate.content.parts[0].text || 'Ê≤°ÊúâÊî∂Âà∞ÂõûÂ§ç';
                    }
                }
                
                // Â¶ÇÊûúÊ≤°Êúâcandidates‰ΩÜÊúâpromptFeedbackÔºåËØ¥ÊòéËæìÂÖ•ÂèØËÉΩÊúâÈóÆÈ¢ò
                if (data.promptFeedback) {
                    console.log('Gemini promptFeedbackËØ¶ÊÉÖ:', data.promptFeedback);
                    if (data.promptFeedback.safetyRatings) {
                        const blockedCategories = data.promptFeedback.safetyRatings
                            .filter(rating => rating.blocked)
                            .map(rating => rating.category);
                        if (blockedCategories.length > 0) {
                            return `ËæìÂÖ•ÂÜÖÂÆπËß¶Âèë‰∫ÜÂÆâÂÖ®ËøáÊª§: ${blockedCategories.join(', ')}„ÄÇËØ∑Â∞ùËØïË∞ÉÊï¥ËæìÂÖ•ÂÜÖÂÆπ„ÄÇ`;
                        }
                    }
                    return 'ËæìÂÖ•ÂÜÖÂÆπÂèØËÉΩÂ≠òÂú®ÈóÆÈ¢òÔºåËØ∑Â∞ùËØïÈáçÊñ∞Ë°®Ëø∞„ÄÇ';
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâcandidatesÔºåÂèØËÉΩÊòØÂÖ∂‰ªñÈîôËØØ
                if (data.error) {
                    throw new Error(data.error.message || 'Gemini APIÈîôËØØ');
                }
                
                console.log('Gemini APIËøîÂõû‰∫ÜÊÑèÂ§ñÁöÑÊ†ºÂºè:', data);
                return 'Ê≤°ÊúâÊî∂Âà∞ÂõûÂ§çÔºåÂèØËÉΩÊòØËæìÂÖ•ÂÜÖÂÆπËß¶Âèë‰∫ÜÂÆâÂÖ®ËøáÊª§„ÄÇËØ∑Â∞ùËØïË∞ÉÊï¥ËæìÂÖ•ÂÜÖÂÆπÊàñËßíËâ≤ËÆæÂÆö„ÄÇ';
            } else {
                return data.choices?.[0]?.message?.content || 'Ê≤°ÊúâÊî∂Âà∞ÂõûÂ§ç';
            }
        }
        
        // ================== ËÆ∞ÂøÜËÆæÁΩÆÁõ∏ÂÖ≥ÂäüËÉΩ ==================
        
        // Âä†ËΩΩËÆ∞ÂøÜËÆæÁΩÆÔºàÂ∑≤Â∫üÂºÉ - Áé∞Âú®‰ΩøÁî®ÊØè‰∏™ËÅäÂ§©Áã¨Á´ãÁöÑËÆæÁΩÆÔºâ
        // function loadMemorySettings() {
        //     const savedSettings = localStorage.getItem('memorySettings');
        //     if (savedSettings) {
        //         try {
        //             memorySettings = JSON.parse(savedSettings);
        //         } catch (e) {
        //             console.error('ËÆ∞ÂøÜËÆæÁΩÆÂä†ËΩΩÂ§±Ë¥•:', e);
        //         }
        //     }
        // }
        
        // Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ
        function loadGroupChats() {
            const savedGroupChats = localStorage.getItem('groupChats');
            if (savedGroupChats) {
                try {
                    groupChats = JSON.parse(savedGroupChats);
                } catch (e) {
                    console.error('Áæ§ËÅäÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', e);
                    groupChats = [];
                }
            } else {
                groupChats = [];
            }
        }
        
        // ‰øùÂ≠òËÆ∞ÂøÜËÆæÁΩÆÔºàÂ∑≤Â∫üÂºÉ - Áé∞Âú®‰ΩøÁî®ÊØè‰∏™ËÅäÂ§©Áã¨Á´ãÁöÑËÆæÁΩÆÔºâ
        // function saveMemorySettings() {
        //     localStorage.setItem('memorySettings', JSON.stringify(memorySettings));
        // }
        
        // ÊòæÁ§∫ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆ
        function showHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const historyCount = chatSettings.historyCount;
            document.getElementById('history-messages-count').value = Math.min(historyCount, 100);
            document.getElementById('custom-history-count').value = historyCount;
            document.getElementById('history-count-display').textContent = historyCount + 'ÂõûÂêà';
            document.getElementById('cross-chat-memory').value = chatSettings.crossChatMemory;
            document.getElementById('cross-memory-display').textContent = chatSettings.crossChatMemory + 'Êù°';
            
            // ÁªëÂÆöÊªëÂùó‰∫ã‰ª∂
            document.getElementById('history-messages-count').oninput = function() {
                const value = parseInt(this.value);
                document.getElementById('history-count-display').textContent = value + 'ÂõûÂêà';
                document.getElementById('custom-history-count').value = value;
            };
            
            // ÁªëÂÆöËá™ÂÆö‰πâËæìÂÖ•Ê°Ü‰∫ã‰ª∂
            document.getElementById('custom-history-count').oninput = function() {
                const value = Math.max(0, Math.min(500, parseInt(this.value) || 0));
                this.value = value;
                if (value <= 100) {
                    document.getElementById('history-messages-count').value = value;
                }
                document.getElementById('history-count-display').textContent = value + 'ÂõûÂêà';
            };
            
            document.getElementById('cross-chat-memory').oninput = function() {
                document.getElementById('cross-memory-display').textContent = this.value + 'ÂõûÂêà';
            };
            
            showModal('history-settings-modal');
        }
        
        // ‰øùÂ≠òÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆ
        function saveHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const customValue = parseInt(document.getElementById('custom-history-count').value);
            chatSettings.historyCount = Math.max(0, Math.min(500, customValue || 0));
            chatSettings.crossChatMemory = parseInt(document.getElementById('cross-chat-memory').value);
            
            // Êõ¥Êñ∞ËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫ÁöÑÂΩìÂâçÂÄº
            document.getElementById('current-history-count').textContent = chatSettings.historyCount + 'ÂõûÂêà';
            
            saveCurrentChatSettings(chatSettings);
            hideModal('history-settings-modal');
            alert('ÂéÜÂè≤Ê∂àÊÅØËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        // ÊòæÁ§∫Â§¥ÂÉèËÆæÁΩÆ
        function showAvatarSettings() {
            // Âä†ËΩΩÂΩìÂâçËÅäÂ§©Á™óÂè£ÁöÑÂ§¥ÂÉèËÆæÁΩÆ
            const chatSettings = getCurrentChatSettings();
            
            // ËÆæÁΩÆÈöêËóèÂ§¥ÂÉèÈÄâÈ°π
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                hideAvatarsCheckbox.checked = chatSettings.hideAvatars || false;
            }
            
            // ËÆæÁΩÆÊàëÁöÑÂ§¥ÂÉèÈ¢ÑËßà
            const myAvatarPreview = document.getElementById('my-chat-avatar-preview');
            if (chatSettings.myChatAvatar) {
                myAvatarPreview.style.backgroundImage = `url(${chatSettings.myChatAvatar})`;
                myAvatarPreview.style.backgroundSize = 'cover';
                myAvatarPreview.style.backgroundPosition = 'center';
                myAvatarPreview.innerHTML = '';
            } else {
                myAvatarPreview.style.backgroundImage = 'none';
                myAvatarPreview.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            // ËÆæÁΩÆÂØπÊñπÂ§¥ÂÉèÈ¢ÑËßà
            const aiAvatarPreview = document.getElementById('ai-chat-avatar-preview');
            if (chatSettings.aiChatAvatar) {
                aiAvatarPreview.style.backgroundImage = `url(${chatSettings.aiChatAvatar})`;
                aiAvatarPreview.style.backgroundSize = 'cover';
                aiAvatarPreview.style.backgroundPosition = 'center';
                aiAvatarPreview.innerHTML = '';
            } else {
                aiAvatarPreview.style.backgroundImage = 'none';
                aiAvatarPreview.innerHTML = '<i class="fas fa-robot"></i>';
            }
            
            // ÁªëÂÆöÊñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
            bindAvatarUploadEvents();
            
            showModal('avatar-settings-modal');
        }
        
        // ÊòæÁ§∫ÊòµÁß∞ËÆæÁΩÆ
        function showNicknameSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-chat-nickname').value = chatSettings.myChatNickname || '';
            document.getElementById('ai-chat-nickname').value = chatSettings.aiChatNickname || '';
            showModal('nickname-settings-modal');
        }
        
        // ÊòæÁ§∫Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ
        function showPokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-poke-suffix').value = chatSettings.myPokeSuffix || '';
            document.getElementById('ai-poke-suffix').value = chatSettings.aiPokeSuffix || '';
            showModal('poke-suffix-modal');
        }
        
        // ÊòæÁ§∫ËÅäÂ§©ËÉåÊôØËÆæÁΩÆ
        function showBackgroundSettings() {
            const chatSettings = getCurrentChatSettings();
            const backgroundPreview = document.getElementById('chat-background-preview');
            
            // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ
            window.selectedChatBackground = undefined;
            
            if (chatSettings.chatBackground && chatSettings.chatBackground !== null) {
                backgroundPreview.style.backgroundImage = `url(${chatSettings.chatBackground})`;
                backgroundPreview.style.backgroundSize = 'cover';
                backgroundPreview.style.backgroundPosition = 'center';
                backgroundPreview.querySelector('.preview-text').style.display = 'none';
            } else {
                backgroundPreview.style.backgroundImage = 'none';
                backgroundPreview.querySelector('.preview-text').style.display = 'block';
                backgroundPreview.querySelector('.preview-text').textContent = 'ËÉåÊôØÈ¢ÑËßà';
            }
            
            // ÁªëÂÆöËÉåÊôØ‰∏ä‰º†‰∫ã‰ª∂
            document.getElementById('background-upload').onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        backgroundPreview.style.backgroundImage = `url(${event.target.result})`;
                        backgroundPreview.style.backgroundSize = 'cover';
                        backgroundPreview.style.backgroundPosition = 'center';
                        backgroundPreview.querySelector('.preview-text').style.display = 'none';
                        window.selectedChatBackground = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };
            
            showModal('background-settings-modal');
        }
        
        // ÊòæÁ§∫Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ
        function showBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            const currentStyle = chatSettings.bubbleStyle || 'default';
            document.getElementById('my-bubble-color').value = chatSettings.myBubbleColor || '#007AFF';
            document.getElementById('ai-bubble-color').value = chatSettings.aiBubbleColor || '#f0f0f0';
            
            // Âä†ËΩΩÂàÜÁ¶ªÁöÑÈÄèÊòéÂ∫¶ËÆæÁΩÆ
            document.getElementById('my-bubble-opacity').value = chatSettings.myBubbleOpacity || '1';
            document.getElementById('my-bubble-opacity-value').textContent = Math.round((chatSettings.myBubbleOpacity || 1) * 100) + '%';
            document.getElementById('ai-bubble-opacity').value = chatSettings.aiBubbleOpacity || '1';
            document.getElementById('ai-bubble-opacity-value').textContent = Math.round((chatSettings.aiBubbleOpacity || 1) * 100) + '%';
            
            // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ†∑Âºè
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.style === currentStyle) {
                    option.classList.add('selected');
                }
            });
            
            // ÁªëÂÆöÊ†∑ÂºèÈÄâÊã©‰∫ã‰ª∂
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.onclick = function() {
                    document.querySelectorAll('.bubble-style-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedBubbleStyle = this.dataset.style;
                };
            });
            
            // ÁªëÂÆöÂàÜÁ¶ªÁöÑÈÄèÊòéÂ∫¶‰∫ã‰ª∂
            document.getElementById('my-bubble-opacity').oninput = function() {
                document.getElementById('my-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
            };
            
            document.getElementById('ai-bubble-opacity').oninput = function() {
                document.getElementById('ai-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
            };
            
            // Âä†ËΩΩÊ∞îÊ≥°Â§ßÂ∞èËÆæÁΩÆ
            document.getElementById('bubble-padding').value = chatSettings.bubblePadding || '12';
            updatePaddingValue(chatSettings.bubblePadding || '12');
            
            // ÁªëÂÆöÊ∞îÊ≥°Â§ßÂ∞è‰∫ã‰ª∂
            document.getElementById('bubble-padding').oninput = function() {
                updatePaddingValue(this.value);
            };
            
            window.selectedBubbleStyle = currentStyle;
            showModal('bubble-style-modal');
        }
        
        // ÊòæÁ§∫ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ
        function showScheduleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            document.getElementById('schedule-enabled').checked = chatSettings.scheduleEnabled || false;
            document.getElementById('schedule-enabled').onchange = function() {
                document.getElementById('schedule-times-group').style.display = this.checked ? 'block' : 'none';
            };
            
            // Ëß¶Âèë‰∏ÄÊ¨°ÊòæÁ§∫Áä∂ÊÄÅÊõ¥Êñ∞
            document.getElementById('schedule-times-group').style.display = 
                document.getElementById('schedule-enabled').checked ? 'block' : 'none';
            
            // Âä†ËΩΩÂ∑≤ÊúâÁöÑÊó∂Èó¥ÁÇπ
            renderScheduleTimes();
            
            showModal('schedule-settings-modal');
        }
        
        // Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆÔºàÂåÖÂê´ËÆ∞ÂøÜÁõ∏ÂÖ≥ËÆæÁΩÆÔºâ
        function getCurrentChatSettings() {
            if (!currentChatCharacter) return {};
            
            const chatId = currentChatCharacter.id;
            const savedSettings = localStorage.getItem(`chatSettings_${chatId}`);
            const defaultSettings = {
                // ËÆ∞ÂøÜÁõ∏ÂÖ≥ËÆæÁΩÆÔºàÂéüÊú¨ÁöÑÂÖ®Â±ÄËÆæÁΩÆÊîπ‰∏∫ÊØè‰∏™ËÅäÂ§©Áã¨Á´ãÔºâ
                historyCount: 5,
                crossChatMemory: 3,
                enableDynamicMemory: true,
                enableMusicMemory: true,
                memoryMountEnabled: false,
                memoryMountCount: 3,
                selectedMemoryChats: [],
                // Êó∂Èó¥ÊÑüÁü•ËÆæÁΩÆ
                timeAwarenessEnabled: true,
                // ÈÄöËØùËÆæÁΩÆ
                aiCallEnabled: false,
                // ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
                aiHeartrateEnabled: false,
                // Á§æ‰∫§Âä®ÊÄÅËÆæÁΩÆ
                socialEnabled: false,
                socialFrequency: 'medium',
                // ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
                backgroundInteractionEnabled: false,
                backgroundChatFrequency: 'low',
                backgroundWeiboFrequency: 'low',
                // ÂÖ∂‰ªñÂéüÊúâËÆæÁΩÆ
                timestampEnabled: true,
                timestampPosition: 'center'
            };
            
            return savedSettings ? { ...defaultSettings, ...JSON.parse(savedSettings) } : defaultSettings;
        }
        
        // ‰øùÂ≠òÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆ
        function saveCurrentChatSettings(settings) {
            if (!currentChatCharacter) return;
            
            const chatId = currentChatCharacter.id;
            localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(settings));
        }
        
        // ‰øùÂ≠òËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ
        function saveChatModeSettings() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÅäÂ§©Ê®°Âºè
            const onlineRadio = document.getElementById('chat-mode-online');
            const offlineRadio = document.getElementById('chat-mode-offline');
            
            if (onlineRadio && offlineRadio) {
                chatSettings.chatMode = onlineRadio.checked ? 'online' : 'offline';
            }
            
            // Ëé∑ÂèñÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂
            const maxLengthInput = document.getElementById('offline-mode-max-length');
            if (maxLengthInput) {
                chatSettings.offlineModeMaxLength = parseInt(maxLengthInput.value) || 100;
            }
            
            saveCurrentChatSettings(chatSettings);
        }
        
        // ÊòæÁ§∫ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ
        function showMemoryMountSettings() {
            const chatSettings = getCurrentChatSettings();
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            document.getElementById('memory-mount-enabled').checked = chatSettings.memoryMountEnabled || false;
            document.getElementById('memory-mount-count').value = chatSettings.memoryMountCount || 3;
            document.getElementById('memory-mount-display').textContent = (chatSettings.memoryMountCount || 3) + 'Êù°';
            
            // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÁöÑÊòæÁ§∫
            toggleMemoryMountDetails();
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('memory-mount-enabled').onchange = toggleMemoryMountDetails;
            document.getElementById('memory-mount-count').oninput = function() {
                document.getElementById('memory-mount-display').textContent = this.value + 'Êù°';
            };
            
            // Ê∏≤ÊüìËÅäÂ§©ÂàóË°®
            renderMemoryMountChatList();
            
            showModal('memory-mount-modal');
        }
        
        // ÂàáÊç¢ËÆ∞ÂøÜÊåÇËΩΩËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
        function toggleMemoryMountDetails() {
            const enabled = document.getElementById('memory-mount-enabled').checked;
            document.getElementById('memory-mount-details').style.display = enabled ? 'block' : 'none';
            document.getElementById('memory-mount-chats').style.display = enabled ? 'block' : 'none';
            
            // Êõ¥Êñ∞‰∏ªËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫
            document.getElementById('current-memory-mount').textContent = enabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
        }
        
        // Ê∏≤ÊüìËÆ∞ÂøÜÊåÇËΩΩËÅäÂ§©ÂàóË°®
        function renderMemoryMountChatList() {
            const container = document.getElementById('memory-mount-list');
            container.innerHTML = '';
            
            if (characters.length === 0 && groupChats.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">ÊöÇÊó†ÂèØÊåÇËΩΩÁöÑËÅäÂ§©</p>';
                return;
            }
            
            // Ê∑ªÂä†Âçï‰∫∫ËÅäÂ§©
            characters.forEach(character => {
                if (currentChatCharacter && character.id === currentChatCharacter.id) return; // ‰∏çÊòæÁ§∫ÂΩìÂâçËÅäÂ§©
                
                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${character.id}" value="${character.id}" class="mount-checkbox">
                    <div class="mount-avatar-small" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''} display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div>
                        <div class="mount-name">${character.name}</div>
                        <div class="mount-type">ÂçïËÅä</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // Ê∑ªÂä†Áæ§ËÅä
            groupChats.forEach(group => {
                if (currentChatCharacter && group.id === currentChatCharacter.id) return; // ‰∏çÊòæÁ§∫ÂΩìÂâçËÅäÂ§©
                
                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${group.id}" value="${group.id}" class="mount-checkbox">
                    <div class="mount-avatar-group">
                        Áæ§
                    </div>
                    <div>
                        <div class="mount-name">${group.name}</div>
                        <div class="mount-type">Áæ§ËÅä (${group.members ? group.members.length : 0}‰∫∫)</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // Âä†ËΩΩÂ∑≤ÈÄâÊã©ÁöÑËÅäÂ§©
            const chatSettings = getCurrentChatSettings();
            const selectedChats = chatSettings.selectedMemoryChats || [];
            selectedChats.forEach(chatId => {
                const checkbox = document.getElementById(`mount-${chatId}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        // ‰øùÂ≠òËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ
        function saveMemoryMountSettings() {
            const chatSettings = getCurrentChatSettings();
            chatSettings.memoryMountEnabled = document.getElementById('memory-mount-enabled').checked;
            chatSettings.memoryMountCount = parseInt(document.getElementById('memory-mount-count').value);
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÅäÂ§©
            const checkboxes = document.querySelectorAll('#memory-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedMemoryChats = Array.from(checkboxes).map(cb => cb.value);
            
            // Êõ¥Êñ∞‰∏ªËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫
            document.getElementById('current-memory-mount').textContent = chatSettings.memoryMountEnabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
            
            saveCurrentChatSettings(chatSettings);
            hideModal('memory-mount-modal');
            alert('ËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        // ‰øùÂ≠òËÅäÂ§©Â§¥ÂÉèËÆæÁΩÆ
        function saveChatAvatarSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÈöêËóèÂ§¥ÂÉèËÆæÁΩÆ
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                chatSettings.hideAvatars = hideAvatarsCheckbox.checked;
            }
            
            // ‰øùÂ≠òÂ§¥ÂÉèËÆæÁΩÆ
            if (window.selectedMyChatAvatar) {
                chatSettings.myChatAvatar = window.selectedMyChatAvatar;
            }
            if (window.selectedAiChatAvatar) {
                chatSettings.aiChatAvatar = window.selectedAiChatAvatar;
            }
            
            saveCurrentChatSettings(chatSettings);
            hideModal('avatar-settings-modal');
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰ª•ÊòæÁ§∫Êñ∞Â§¥ÂÉè
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            alert('Â§¥ÂÉèËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        // ‰øùÂ≠òÊòµÁß∞ËÆæÁΩÆ
        function saveChatNicknameSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.myChatNickname = document.getElementById('my-chat-nickname').value.trim();
            chatSettings.aiChatNickname = document.getElementById('ai-chat-nickname').value.trim();
            
            saveCurrentChatSettings(chatSettings);
            hideModal('nickname-settings-modal');
            
            // Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢Ê†áÈ¢ò
            if (currentChatCharacter) {
                const displayTitle = chatSettings.aiChatNickname || currentChatCharacter.name;
                document.getElementById('api-chat-title').textContent = displayTitle;
            }
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            // üî•„Äê‰øÆÂ§ç„ÄëÂà∑Êñ∞Ê∂àÊÅØÂàóË°®ÂíåËÅîÁ≥ª‰∫∫ÂàóË°®‰ª•ÊòæÁ§∫Êñ∞ÊòµÁß∞
            renderMessageList();
            renderContactList();
            
            alert('ÊòµÁß∞ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        // ‰øùÂ≠òÊà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ
        function savePokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.myPokeSuffix = document.getElementById('my-poke-suffix').value.trim();
            chatSettings.aiPokeSuffix = document.getElementById('ai-poke-suffix').value.trim();
            
            saveCurrentChatSettings(chatSettings);
            hideModal('poke-suffix-modal');
            alert('Êà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        // ‰øùÂ≠òËÅäÂ§©ËÉåÊôØËÆæÁΩÆ
        function saveChatBackgroundSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Â§ÑÁêÜËÉåÊôØËÆæÁΩÆÔºåÂåÖÊã¨ÁßªÈô§ËÉåÊôØÁöÑÊÉÖÂÜµ
            if (window.selectedChatBackground === null) {
                // Áî®Êà∑ÈÄâÊã©ÁßªÈô§ËÉåÊôØ
                chatSettings.chatBackground = null;
            } else if (window.selectedChatBackground) {
                // Áî®Êà∑ÈÄâÊã©‰∫ÜÊñ∞ËÉåÊôØ
                chatSettings.chatBackground = window.selectedChatBackground;
            }
            // Â¶ÇÊûú window.selectedChatBackground ÊòØ undefinedÔºåÂàô‰øùÊåÅÂéüÊúâËÆæÁΩÆ‰∏çÂèò
            
            saveCurrentChatSettings(chatSettings);
            hideModal('background-settings-modal');
            
            // Â∫îÁî®Âà∞ËÅäÂ§©ÁïåÈù¢
            applyChatBackground();
            
            alert('ËÅäÂ§©ËÉåÊôØËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        // ÁßªÈô§ËÉåÊôØ
        function removeBackground() {
            const backgroundPreview = document.getElementById('chat-background-preview');
            backgroundPreview.style.backgroundImage = 'none';
            backgroundPreview.querySelector('.preview-text').style.display = 'block';
            backgroundPreview.querySelector('.preview-text').textContent = 'Â∑≤ÁßªÈô§ËÉåÊôØ';
            window.selectedChatBackground = null;
        }

        // Êõ¥Êñ∞Ê∞îÊ≥°Â§ßÂ∞èÊòæÁ§∫ÂÄº
        function updatePaddingValue(value) {
            const paddingValue = document.getElementById('bubble-padding-value');
            if (paddingValue) {
                if (value <= 10) {
                    paddingValue.textContent = 'Á¥ßÂáë';
                } else if (value <= 14) {
                    paddingValue.textContent = '‰∏≠Á≠â';
                } else if (value <= 18) {
                    paddingValue.textContent = 'ÂÆΩÊùæ';
                } else {
                    paddingValue.textContent = 'Ë∂ÖÂ§ß';
                }
            }
        }

        // ‰øùÂ≠òÊ∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆ
        function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ‰øùÂ≠òÊ†∑ÂºèÈÄâÊã©
            if (window.selectedBubbleStyle) {
                chatSettings.bubbleStyle = window.selectedBubbleStyle;
            }
            
            // ‰øùÂ≠òÈ¢úËâ≤ËÆæÁΩÆ
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;
            
            // ‰øùÂ≠òÂàÜÁ¶ªÁöÑÈÄèÊòéÂ∫¶ËÆæÁΩÆ
            chatSettings.myBubbleOpacity = document.getElementById('my-bubble-opacity').value;
            chatSettings.aiBubbleOpacity = document.getElementById('ai-bubble-opacity').value;
            
            // ‰øùÂ≠òÊ∞îÊ≥°Â§ßÂ∞èËÆæÁΩÆ
            chatSettings.bubblePadding = document.getElementById('bubble-padding').value;
            
            saveCurrentChatSettings(chatSettings);
            hideModal('bubble-style-modal');
            
            // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢‰ª•Â∫îÁî®Êñ∞ËÆæÁΩÆ
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            alert('Ê∞îÊ≥°Ê†∑ÂºèËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }

        // ÊòæÁ§∫Êó∂Èó¥Êà≥ËÆæÁΩÆ
        function showTimestampSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // ËÆæÁΩÆÊó∂Èó¥Êà≥ÂºÄÂÖ≥Áä∂ÊÄÅ
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                timestampEnabled.checked = chatSettings.timestampEnabled !== false; // ÈªòËÆ§‰∏∫true
            }
            
            // ËÆæÁΩÆÊó∂Èó¥Êà≥‰ΩçÁΩÆÈÄâÈ°π
            const timestampPosition = chatSettings.timestampPosition || 'center';
            const positionRadios = document.querySelectorAll('input[name="timestamp-position"]');
            positionRadios.forEach(radio => {
                radio.checked = radio.value === timestampPosition;
            });
            
            // ÁªëÂÆöÊó∂Èó¥Êà≥ÂºÄÂÖ≥ÂèòÂåñ‰∫ã‰ª∂
            if (timestampEnabled) {
                timestampEnabled.onchange = function() {
                    const optionsGroup = document.getElementById('timestamp-options-group');
                    if (optionsGroup) {
                        optionsGroup.style.display = this.checked ? 'block' : 'none';
                    }
                };
                
                // Ëß¶Âèë‰∏ÄÊ¨°ÊòæÁ§∫Áä∂ÊÄÅÊõ¥Êñ∞
                const optionsGroup = document.getElementById('timestamp-options-group');
                if (optionsGroup) {
                    optionsGroup.style.display = timestampEnabled.checked ? 'block' : 'none';
                }
            }
            
            showModal('timestamp-settings-modal');
        }

        // ‰øùÂ≠òÊó∂Èó¥Êà≥ËÆæÁΩÆ
        function saveTimestampSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Ëé∑ÂèñÊó∂Èó¥Êà≥ÂºÄÂÖ≥Áä∂ÊÄÅ
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                chatSettings.timestampEnabled = timestampEnabled.checked;
            }
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊó∂Èó¥Êà≥‰ΩçÁΩÆ
            const selectedPosition = document.querySelector('input[name="timestamp-position"]:checked');
            if (selectedPosition) {
                chatSettings.timestampPosition = selectedPosition.value;
            }
            
            saveCurrentChatSettings(chatSettings);
            hideModal('timestamp-settings-modal');
            
            // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ‰ª•Â∫îÁî®Êñ∞ÁöÑÊó∂Èó¥Êà≥ËÆæÁΩÆ
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            alert('Êó∂Èó¥Êà≥ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        // Â§¥ÂÉè‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function avatarUploadHandler(e) {
            console.log('avatar-upload change‰∫ã‰ª∂Ë¢´Ëß¶Âèë');
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                
                console.log('ÈÄâÊã©‰∫ÜÊñá‰ª∂:', file.name, 'Â§ßÂ∞è:', file.size, 'bytes', 'Á±ªÂûã:', file.type);
                
                // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    e.target.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                    return;
                }
                
                // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂‰∏∫5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                    e.target.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('avatar-preview');
                        const avatarPreviewText = document.getElementById('avatar-preview-text');
                        
                        console.log('Êñá‰ª∂ËØªÂèñÊàêÂäüÔºåÂºÄÂßãËÆæÁΩÆÈ¢ÑËßà');
                        
                        if (!avatarPreview) {
                            console.error('Êâæ‰∏çÂà∞avatar-previewÂÖÉÁ¥†');
                            alert('Êâæ‰∏çÂà∞Â§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†');
                            return;
                        }
                        
                        // Ê∑ªÂä†has-imageÁ±ªÊù•Ë¶ÜÁõñÈªòËÆ§ËÉåÊôØ
                        avatarPreview.classList.add('has-image');
                        
                        // Âº∫Âà∂ËÆæÁΩÆËÉåÊôØÂõæÁâáÂπ∂Ê∏ÖÈô§ÊâÄÊúâÂÖ∂‰ªñËÉåÊôØÊ†∑Âºè
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        
                        // ÈöêËóèÊñáÂ≠ó
                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }
                        
                        // Â≠òÂÇ®ÂõæÁâáÊï∞ÊçÆÁî®‰∫éÂêéÁª≠‰øùÂ≠ò
                        window.selectedAvatarData = event.target.result;
                        
                        // È™åËØÅÊ†∑ÂºèÊòØÂê¶Ê≠£Á°ÆËÆæÁΩÆ
                        console.log('Â§¥ÂÉèÈ¢ÑËßàUIÊõ¥Êñ∞ÂÆåÊàêÔºåËÉåÊôØÂõæÁâáÂ∑≤ËÆæÁΩÆ');
                        console.log('ÂΩìÂâçavatar-previewÁöÑÊ†∑Âºè:', {
                            background: avatarPreview.style.background,
                            backgroundSize: avatarPreview.style.backgroundSize,
                            backgroundPosition: avatarPreview.style.backgroundPosition,
                            className: avatarPreview.className
                        });
                        
                        console.log('Â§¥ÂÉèÈ¢ÑËßàËÆæÁΩÆÊàêÂäüÔºåÂõæÁâáÊï∞ÊçÆÂ∑≤Â≠òÂÇ®');
                    } catch (error) {
                        console.error('ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÊó∂ÂèëÁîüÈîôËØØ:', error);
                        alert('ËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÂ§±Ë¥•ÔºåËØ∑ÈáçËØï: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    console.error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
                    alert('ÂõæÁâáËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    e.target.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                };
                
                reader.readAsDataURL(file);
            } else {
                console.log('Ê≤°ÊúâÈÄâÊã©Êñá‰ª∂Êàñfiles‰∏∫Á©∫');
            }
        }
        
        // Âä†ËΩΩËá™ÂÆö‰πâË°®ÊÉÖÂåÖ
        function loadCustomEmojis() {
            const savedCustomEmojis = localStorage.getItem('customEmojis');
            const savedRecentEmojis = localStorage.getItem('recentEmojis');
            
            if (savedCustomEmojis) {
                try {
                    customEmojis = JSON.parse(savedCustomEmojis);
                } catch (e) {
                    customEmojis = [];
                }
            }
            
            if (savedRecentEmojis) {
                try {
                    recentEmojis = JSON.parse(savedRecentEmojis);
                } catch (e) {
                    recentEmojis = [];
                }
            }
        }
        
        // ‰øùÂ≠òËá™ÂÆö‰πâË°®ÊÉÖÂåÖ
        function saveCustomEmojis() {
            localStorage.setItem('customEmojis', JSON.stringify(customEmojis));
            localStorage.setItem('recentEmojis', JSON.stringify(recentEmojis));
        }
        
        // ÊòæÁ§∫Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖÈù¢Êùø
        function showCustomEmojiPanel() {
            const panel = document.getElementById('custom-emoji-panel');
            const isVisible = panel.style.display === 'block';
            
            if (isVisible) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            } else {
                panel.style.display = 'block';
                renderEmojiGrid();
                
                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Èù¢Êùø
                setTimeout(() => {
                    document.addEventListener('click', hideCustomEmojiPanel);
                }, 100);
            }
        }
        
        // ÈöêËóèËá™ÂÆö‰πâË°®ÊÉÖÂåÖÈù¢Êùø
        function hideCustomEmojiPanel(e) {
            const panel = document.getElementById('custom-emoji-panel');
            
            // Â¶ÇÊûúÊ≤°Êúâ‰º†ÈÄí‰∫ã‰ª∂ÂèÇÊï∞ÔºåÁõ¥Êé•ÈöêËóèÈù¢Êùø
            if (!e) {
                if (panel) {
                    panel.style.display = 'none';
                    document.removeEventListener('click', hideCustomEmojiPanel);
                }
                return;
            }
            
            const emojiBtn = e.target.closest('.chat-action-btn');
            
            if (panel && !panel.contains(e.target) && !emojiBtn) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            }
        }
        
        // Ê∏≤ÊüìË°®ÊÉÖÂåÖÁΩëÊ†º
        function renderEmojiGrid() {
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = '';
            
            let emojisToShow = [];
            
            if (currentEmojiTab === 'recent') {
                emojisToShow = recentEmojis;
            } else if (currentEmojiTab === 'custom') {
                emojisToShow = customEmojis;
            }
            
            // Ê∑ªÂä†Ë°®ÊÉÖÂåÖ
            emojisToShow.forEach((emoji, index) => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'custom-emoji-item';
                emojiItem.style.backgroundImage = `url(${emoji.url})`;
                emojiItem.onclick = () => sendEmojiMessage(emoji);
                
                // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÊ†áÁ≠æÈ°µÔºåÊ∑ªÂä†Âà†Èô§ÊåâÈíÆ
                if (currentEmojiTab === 'custom') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'emoji-delete-btn';
                    deleteBtn.innerHTML = '√ó';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteCustomEmoji(index);
                    };
                    emojiItem.appendChild(deleteBtn);
                }
                
                grid.appendChild(emojiItem);
            });
            
            // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÊ†áÁ≠æÈ°µÔºåÊ∑ªÂä†‰∏ä‰º†ÊåâÈíÆ
            if (currentEmojiTab === 'custom') {
                const uploadItem = document.createElement('div');
                uploadItem.className = 'custom-emoji-item placeholder';
                uploadItem.innerHTML = '+';
                uploadItem.onclick = () => document.getElementById('emoji-upload').click();
                grid.appendChild(uploadItem);
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâË°®ÊÉÖÂåÖÔºåÊòæÁ§∫ÊèêÁ§∫
            if (emojisToShow.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-emoji-grid';
                
                                                if (currentEmojiTab === 'recent') {
                                    emptyMsg.textContent = 'ËøòÊ≤°Êúâ‰ΩøÁî®ËøáË°®ÊÉÖÂåÖ';
                                } else {
                                    emptyMsg.textContent = 'ËøòÊ≤°ÊúâË°®ÊÉÖÂåÖÔºåÁÇπÂáª+Âè∑Ê∑ªÂä†';
                                }
                
                grid.appendChild(emptyMsg);
            }
        }
        
        // ÂèëÈÄÅË°®ÊÉÖÂåÖÊ∂àÊÅØ
        function sendEmojiMessage(emoji) {
            if (!currentChatCharacter) return;
            
            // Ê∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®
            addToRecentEmojis(emoji);
            
            // ÂàõÂª∫Ê∂àÊÅØ
            const messageId = Date.now().toString();
            const emojiMessage = {
                id: messageId,
                sender: 'sent',
                content: '',
                image: emoji.url,
                isEmoji: true,
                emojiDescription: emoji.description || 'Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖ',
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(emojiMessage);
            saveChatMessages();
            
            // Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages(currentChatCharacter.id);
            
            // ÈöêËóèË°®ÊÉÖÂåÖÈù¢Êùø
            hideCustomEmojiPanel();
            
            // ËÆæÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØÔºåÊîØÊåÅÊô∫ËÉΩÂõûÂ§çÊåâÈíÆ
            pendingUserMessage = emojiMessage;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
            
            // Ê≥®ÈáäÊéâËá™Âä®ÂõûÂ§çÔºåÊîπ‰∏∫ÊâãÂä®ÂõûÂ§çÊ®°Âºè
            // setTimeout(() => {
            //     sendAIEmojiResponse(emoji);
            // }, 1000 + Math.random() * 2000);
        }
        
        // Ê∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®ÁöÑË°®ÊÉÖÂåÖ
        function addToRecentEmojis(emoji) {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÁõ∏ÂêåË°®ÊÉÖÂåÖ
            recentEmojis = recentEmojis.filter(e => e.url !== emoji.url);
            
            // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
            recentEmojis.unshift(emoji);
            
            // ÈôêÂà∂ÊúÄËøë‰ΩøÁî®Êï∞Èáè‰∏∫20‰∏™
            if (recentEmojis.length > 20) {
                recentEmojis = recentEmojis.slice(0, 20);
            }
            
            saveCustomEmojis();
        }
        
        // Ê£ÄÊµãÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÊîØÊåÅËßÜËßâÂäüËÉΩ
        function isVisionModelSupported() {
            // ÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÂàóË°®
            const visionModels = [
                // OpenAI GPTÁ≥ªÂàó
                'gpt-4-vision',
                'gpt-4o',
                'gpt-4-turbo',
                'gpt-4o-mini',
                
                // Google GeminiÁ≥ªÂàó
                'gemini-1.5-pro',
                'gemini-1.5-flash',
                'gemini-2.0-flash',
                'gemini-2.5-pro',
                'gemini-2.5-flash',
                'gemini-exp',
                'gemini-pro-vision',
                
                // Anthropic ClaudeÁ≥ªÂàó
                'claude-3-opus',
                'claude-3-sonnet',
                'claude-3-haiku',
                'claude-3.5-sonnet',
                'claude-3.5-haiku',
                
                // ÂõΩ‰∫ßÊ®°Âûã
                'qwen-vl',
                'qwen2-vl',
                'yi-vision',
                'glm-4v',
                'internvl',
                'cogvlm',
                
                // ÂÖ∂‰ªñÊ®°Âûã
                'llava',
                'moondream',
                'phi-3-vision'
            ];
            
            const currentModel = apiSettings.model?.toLowerCase() || '';
            
            // Ê£ÄÊü•ÂΩìÂâçÊ®°ÂûãÊòØÂê¶ÂåÖÂê´‰ªª‰ΩïÊîØÊåÅËßÜËßâÁöÑÊ®°ÂûãÂêçÁß∞
            const isVisionSupported = visionModels.some(model => currentModel.includes(model.toLowerCase()));
            
            // ËæìÂá∫Ë∞ÉËØï‰ø°ÊÅØ
            console.log('ÂΩìÂâçÊ®°Âûã:', currentModel);
            console.log('ÊòØÂê¶ÊîØÊåÅËßÜËßâ:', isVisionSupported);
            
            return isVisionSupported;
        }
        
        // Ê≥®ÈáäÔºöAIÂØπË°®ÊÉÖÂåÖÁöÑËá™Âä®ÂõûÂ§çÂäüËÉΩÂ∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®ÊâãÂä®ÂõûÂ§çÊ®°Âºè
        // Ë°®ÊÉÖÂåÖÂíåÂõæÁâáÈÉΩÈÄöËøáÊô∫ËÉΩÂõûÂ§çÊåâÈíÆÊù•Ëß¶ÂèëAIÂõûÂ§ç
        
        // Âà†Èô§Ëá™ÂÆö‰πâË°®ÊÉÖÂåÖ
        function deleteCustomEmoji(index) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü')) {
                customEmojis.splice(index, 1);
                saveCustomEmojis();
                renderEmojiGrid();
            }
        }
        
        // ÂàùÂßãÂåñË°®ÊÉÖÂåÖ‰∏ä‰º†ÂäüËÉΩ
        function initializeEmojiUpload() {
            const emojiInput = document.getElementById('emoji-upload');
            if (emojiInput) {
                emojiInput.addEventListener('change', handleEmojiUpload);
            }
            
            // ÁªëÂÆöÊ†áÁ≠æÈ°µÂàáÊç¢‰∫ã‰ª∂
            document.querySelectorAll('.emoji-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
                    document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
                    // Ê∑ªÂä†ÂΩìÂâçactiveÁ±ª
                    this.classList.add('active');
                    
                    // ÂàáÊç¢ÂΩìÂâçÊ†áÁ≠æÈ°µ
                    currentEmojiTab = this.dataset.tab;
                    renderEmojiGrid();
                });
            });
        }
        
        // Â§ÑÁêÜË°®ÊÉÖÂåÖ‰∏ä‰º†
        function handleEmojiUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑÂõæÁâá');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    // ÂºπÂá∫ÊèèËø∞ËæìÂÖ•Ê°Ü
                    const description = prompt('ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂåÖÊ∑ªÂä†ÊèèËø∞ÔºàÊé®ËçêÔºÅÂ∏ÆÂä©AIÊõ¥Â•ΩÂú∞ÁêÜËß£Ë°®ÊÉÖÂåÖÂÜÖÂÆπÔºâ:\n\n‰æãÂ¶ÇÔºö\n‚Ä¢ "Á¨ëÂì≠ÁöÑË°®ÊÉÖ"\n‚Ä¢ "Êè°Êã≥Âä†Ê≤πÁöÑÂä®‰Ωú"\n‚Ä¢ "ÂÜôÁùÄOMGÁöÑË°®ÊÉÖÂåÖ"\n‚Ä¢ "ÊÑ§ÊÄíÁöÑÁå´Âí™ÂõæÁâá"', '');
                    
                    const emoji = {
                        id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                        url: event.target.result,
                        description: description || 'Ë°®ÊÉÖÂåÖ',
                        addedAt: new Date().toISOString()
                    };
                    
                    customEmojis.push(emoji);
                    saveCustomEmojis();
                    
                    // Â¶ÇÊûúÂΩìÂâçÂú®Ëá™ÂÆö‰πâÊ†áÁ≠æÈ°µÔºåÈáçÊñ∞Ê∏≤Êüì
                    if (currentEmojiTab === 'custom') {
                        renderEmojiGrid();
                    }
                };
                
                reader.readAsDataURL(file);
            });
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
            e.target.value = '';
        }
        
        // Âà§Êñ≠È¢úËâ≤ÊòØÂê¶‰∏∫ÊµÖËâ≤
        function isLightColor(color) {
            // Â∞ÜÈ¢úËâ≤ËΩ¨Êç¢‰∏∫RGBÂÄº
            let r, g, b;
            
            if (color.startsWith('#')) {
                // ÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤
                const hex = color.slice(1);
                if (hex.length === 3) {
                    r = parseInt(hex[0] + hex[0], 16);
                    g = parseInt(hex[1] + hex[1], 16);
                    b = parseInt(hex[2] + hex[2], 16);
                } else {
                    r = parseInt(hex.substr(0, 2), 16);
                    g = parseInt(hex.substr(2, 2), 16);
                    b = parseInt(hex.substr(4, 2), 16);
                }
            } else if (color.startsWith('rgb')) {
                // RGBÈ¢úËâ≤
                const matches = color.match(/\d+/g);
                if (matches && matches.length >= 3) {
                    r = parseInt(matches[0]);
                    g = parseInt(matches[1]);
                    b = parseInt(matches[2]);
                }
            } else {
                // ÈªòËÆ§‰∏∫Ê∑±Ëâ≤
                return false;
            }
            
            // ËÆ°ÁÆó‰∫ÆÂ∫¶
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128;
        }
        
        // Êõ¥Êñ∞Ê∞îÊ≥°È¢ÑËßà
        function updateBubblePreview() {
            const myColor = document.getElementById('my-bubble-color')?.value || '#007AFF';
            const aiColor = document.getElementById('ai-bubble-color')?.value || '#f0f0f0';
            const myOpacity = document.getElementById('my-bubble-opacity')?.value || '1';
            const aiOpacity = document.getElementById('ai-bubble-opacity')?.value || '1';
            
            // Êõ¥Êñ∞È¢ÑËßàÊ∞îÊ≥°
            const demoMyBubble = document.getElementById('demo-my-bubble');
            const demoAiBubble = document.getElementById('demo-ai-bubble');
            
            if (demoMyBubble) {
                demoMyBubble.style.backgroundColor = myColor;
                demoMyBubble.style.opacity = myOpacity;
                demoMyBubble.style.color = isLightColor(myColor) ? '#333' : '#fff';
            }
            
            if (demoAiBubble) {
                demoAiBubble.style.backgroundColor = aiColor;
                demoAiBubble.style.opacity = aiOpacity;
                demoAiBubble.style.color = isLightColor(aiColor) ? '#333' : '#fff';
            }
            
            // Êõ¥Êñ∞È¢úËâ≤È¢ÑËßà
            const myPreview = document.getElementById('my-bubble-preview');
            const aiPreview = document.getElementById('ai-bubble-preview');
            
            if (myPreview) {
                myPreview.style.backgroundColor = myColor;
                myPreview.style.opacity = myOpacity;
                myPreview.textContent = 'ÊàëÁöÑÊ∞îÊ≥°';
            }
            
            if (aiPreview) {
                aiPreview.style.backgroundColor = aiColor;
                aiPreview.style.opacity = aiOpacity;
                aiPreview.textContent = 'ÂØπÊñπÊ∞îÊ≥°';
            }
        }
        
        // ÁªëÂÆöÂ§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂
        function bindAvatarUploadEvents() {
            // ÊàëÁöÑÂ§¥ÂÉè‰∏ä‰º†
            const myAvatarUpload = document.getElementById('my-chat-avatar-upload');
            if (myAvatarUpload) {
                myAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('my-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedMyChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }
            
            // AIÂ§¥ÂÉè‰∏ä‰º†
            const aiAvatarUpload = document.getElementById('ai-chat-avatar-upload');
            if (aiAvatarUpload) {
                aiAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('ai-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedAiChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }
        }
        
        // ÂàùÂßãÂåñÂ§¥ÂÉè‰∏ä‰º†ÂäüËÉΩ
        function initializeAvatarUpload() {
            const avatarInput = document.getElementById('avatar-upload');
            if (!avatarInput) {
                console.error('Êâæ‰∏çÂà∞avatar-uploadÂÖÉÁ¥†');
                return;
            }
            
            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.removeEventListener('change', avatarUploadHandler);
            
            // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            avatarInput.addEventListener('change', avatarUploadHandler);
            console.log('Â§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁªëÂÆö');
        }
        
        // Êõ¥Êñ∞ËÅäÂ§©ËÆæÁΩÆÁïåÈù¢ÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        function updateChatSettingsDisplay() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            
            // Êõ¥Êñ∞ÂéÜÂè≤Ê∂àÊÅØÊï∞ÊòæÁ§∫
            const historyCountElement = document.getElementById('current-history-count');
            if (historyCountElement) {
                historyCountElement.textContent = chatSettings.historyCount + 'ÂõûÂêà';
            }
            
            // Êõ¥Êñ∞ËÆ∞ÂøÜÊåÇËΩΩÊòæÁ§∫
            const memoryMountElement = document.getElementById('current-memory-mount');
            if (memoryMountElement) {
                memoryMountElement.textContent = chatSettings.memoryMountEnabled ? 'Â∑≤ÂºÄÂêØ' : 'Â∑≤ÂÖ≥Èó≠';
            }
            
            // Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫
            updateWorldbookMountDisplay();
            
            // Êõ¥Êñ∞Êó∂Èó¥ÊÑüÁü•ÂºÄÂÖ≥
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.checked = chatSettings.timeAwarenessEnabled;
            }
            
            // Êõ¥Êñ∞ÈÄöËØùËÆæÁΩÆ
            const aiCallCheckbox = document.getElementById('ai-call-enabled');
            if (aiCallCheckbox) {
                aiCallCheckbox.checked = chatSettings.aiCallEnabled;
            }
            
            // Êõ¥Êñ∞ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.checked = chatSettings.aiHeartrateEnabled;
            }
            
            // Êõ¥Êñ∞Á§æ‰∫§Âä®ÊÄÅËÆæÁΩÆ
            const socialCheckbox = document.getElementById('social-enabled');
            if (socialCheckbox) {
                socialCheckbox.checked = chatSettings.socialEnabled;
                // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
                const socialSettings = document.querySelectorAll('.social-settings');
                socialSettings.forEach(setting => {
                    setting.style.display = chatSettings.socialEnabled ? 'block' : 'none';
                });
            }
            
            const socialFrequencySelect = document.getElementById('social-frequency');
            if (socialFrequencySelect) {
                socialFrequencySelect.value = chatSettings.socialFrequency || 'medium';
            }
            
            // Êõ¥Êñ∞ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.checked = chatSettings.backgroundInteractionEnabled;
                // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
                const backgroundSettings = document.getElementById('background-interaction-settings');
                if (backgroundSettings) {
                    backgroundSettings.style.display = chatSettings.backgroundInteractionEnabled ? 'block' : 'none';
                }
            }
            
            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.value = chatSettings.backgroundChatFrequency || 'low';
            }
            
            const backgroundWeiboFrequencySelect = document.getElementById('background-weibo-frequency');
            if (backgroundWeiboFrequencySelect) {
                backgroundWeiboFrequencySelect.value = chatSettings.backgroundWeiboFrequency || 'low';
            }
            
            // Êõ¥Êñ∞Êó∂Èó¥Êà≥ËÆæÁΩÆ
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                timestampCheckbox.checked = chatSettings.timestampEnabled;
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®Êù•‰øùÂ≠òËÆæÁΩÆÂèòÂåñ
            bindChatSettingsEvents();
        }
        
        // ÁªëÂÆöËÅäÂ§©ËÆæÁΩÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function bindChatSettingsEvents() {
            // Êó∂Èó¥ÊÑüÁü•ÂºÄÂÖ≥
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timeAwarenessEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // ÈÄöËØùËÆæÁΩÆ
            const aiCallCheckbox = document.getElementById('ai-call-enabled');
            if (aiCallCheckbox) {
                aiCallCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiCallEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // ÂøÉÁéáÁõëÊµãËÆæÁΩÆ
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiHeartrateEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // Á§æ‰∫§Âä®ÊÄÅËÆæÁΩÆ
            const socialCheckbox = document.getElementById('social-enabled');
            if (socialCheckbox) {
                socialCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.socialEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                    // ÊòæÁ§∫/ÈöêËóèËØ¶ÁªÜËÆæÁΩÆ
                    const socialSettings = document.querySelectorAll('.social-settings');
                    socialSettings.forEach(setting => {
                        setting.style.display = this.checked ? 'block' : 'none';
                    });
                };
            }
            
            const socialFrequencySelect = document.getElementById('social-frequency');
            if (socialFrequencySelect) {
                socialFrequencySelect.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.socialFrequency = this.value;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundInteractionEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                    // ÊòæÁ§∫/ÈöêËóèËØ¶ÁªÜËÆæÁΩÆ
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }
                };
            }
            
            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundChatFrequency = this.value;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            const backgroundWeiboFrequencySelect = document.getElementById('background-weibo-frequency');
            if (backgroundWeiboFrequencySelect) {
                backgroundWeiboFrequencySelect.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundWeiboFrequency = this.value;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // Êó∂Èó¥Êà≥ËÆæÁΩÆ
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                timestampCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timestampEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                    // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©Ê∂àÊÅØ
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }
                };
            }
        }

        // ÂàùÂßãÂåñËÅäÂ§©ËÆæÁΩÆÁïåÈù¢
        function initializeChatSettings() {
            // Êõ¥Êñ∞Ë∫´‰ªΩÊòæÁ§∫
            updateChatIdentityDisplay();
            
            // Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑ÂºèÊòæÁ§∫
            updateBubbleStyleDisplay();
            
            // Êõ¥Êñ∞ÊâÄÊúâËÆæÁΩÆÊòæÁ§∫Áä∂ÊÄÅ
            updateChatSettingsDisplay();
            
            // Âä†ËΩΩÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆ
            if (currentChatCharacter) {
                const chatSettings = getCurrentChatSettings();
                
                // ËÆæÁΩÆËÅäÂ§©Ê®°Âºè
                const chatMode = chatSettings.chatMode || 'online';
                const onlineRadio = document.getElementById('chat-mode-online');
                const offlineRadio = document.getElementById('chat-mode-offline');
                
                if (onlineRadio && offlineRadio) {
                    if (chatMode === 'online') {
                        onlineRadio.checked = true;
                    } else {
                        offlineRadio.checked = true;
                    }
                    
                    // ÊòæÁ§∫/ÈöêËóèÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÊéßÂà∂
                    const offlineLengthControl = document.getElementById('offline-length-control');
                    if (offlineLengthControl) {
                        offlineLengthControl.style.display = chatMode === 'offline' ? 'flex' : 'none';
                    }
                    
                    // ËÆæÁΩÆÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂
                    const maxLengthInput = document.getElementById('offline-mode-max-length');
                    if (maxLengthInput) {
                        maxLengthInput.value = chatSettings.offlineModeMaxLength || 100;
                    }
                }
            }
            
            // ÁªëÂÆöËÅäÂ§©Ê®°ÂºèÂàáÊç¢‰∫ã‰ª∂
            const chatModeRadios = document.querySelectorAll('input[name="chat-mode"]');
            chatModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const offlineLengthControl = document.getElementById('offline-length-control');
                    if (offlineLengthControl) {
                        offlineLengthControl.style.display = this.value === 'offline' ? 'flex' : 'none';
                    }
                    
                    // ‰øùÂ≠òËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ
                    saveChatModeSettings();
                });
            });
            
            // ÁªëÂÆöÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂ÂèòÂåñ‰∫ã‰ª∂
            const maxLengthInput = document.getElementById('offline-mode-max-length');
            if (maxLengthInput) {
                maxLengthInput.addEventListener('change', saveChatModeSettings);
            }
            
            // ÁªëÂÆöÁ§æ‰∫§Âä®ÊÄÅÂºÄÂÖ≥‰∫ã‰ª∂
            const socialEnabledCheckbox = document.getElementById('social-enabled');
            if (socialEnabledCheckbox) {
                socialEnabledCheckbox.addEventListener('change', function() {
                    const socialSettings = document.querySelectorAll('.social-settings');
                    socialSettings.forEach(setting => {
                        setting.style.display = this.checked ? 'block' : 'none';
                    });
                });
            }
            
            // ÁªëÂÆöÂêéÂè∞‰∫íÂä®ÂºÄÂÖ≥‰∫ã‰ª∂
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.addEventListener('change', function() {
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // ÁªëÂÆöÊà≥‰∏ÄÊà≥ÂäüËÉΩÂºÄÂÖ≥‰∫ã‰ª∂
            const pokeEnabledCheckbox = document.getElementById('poke-enabled');
            if (pokeEnabledCheckbox) {
                pokeEnabledCheckbox.addEventListener('change', function() {
                    const pokeSuffixSettings = document.getElementById('poke-suffix-settings');
                    if (pokeSuffixSettings) {
                        pokeSuffixSettings.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // ÁªëÂÆöÈÄâÊã©Ê®°ÂºèÊåâÈíÆ‰∫ã‰ª∂
            const selectionCancelBtn = document.getElementById('selection-cancel-btn');
            const selectionDeleteBtn = document.getElementById('selection-delete-btn');
            
            if (selectionCancelBtn) {
                selectionCancelBtn.addEventListener('click', exitMessageSelectionMode);
            }
            
            if (selectionDeleteBtn) {
                selectionDeleteBtn.addEventListener('click', function() {
                    if (selectedMessages.size === 0) return;
                    
                    deleteSelectedMessages();
                });
            }
        }
        
        // Êà≥‰∏ÄÊà≥ÂäüËÉΩ
        function pokeCharacter(characterId) {
            if (!currentChatCharacter || currentChatCharacter.id !== characterId) {
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const pokeSuffix = chatSettings.myPokeSuffix || '';
            const characterName = chatSettings.aiChatNickname || currentChatCharacter.name;
            
            // ÂàõÂª∫Êà≥‰∏ÄÊà≥Á≥ªÁªüÊ∂àÊÅØ
            const pokeMessage = {
                id: Date.now().toString(),
                sender: 'system',
                content: `‰Ω†Êà≥‰∫ÜÊà≥${characterName}${pokeSuffix}`,
                timestamp: Date.now(),
                isPoke: true
            };
            
            // Ê∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï
            if (!chatMessages[characterId]) {
                chatMessages[characterId] = [];
            }
            
            chatMessages[characterId].push(pokeMessage);
            saveChatMessages();
            
            // Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages(characterId);
            
            // Ê®°ÊãüËßíËâ≤ÂõûÂ∫îÔºà40%Ê¶ÇÁéáÔºâ
            if (Math.random() < 0.4) {
                setTimeout(() => {
                    const aiPokeSuffix = chatSettings.aiPokeSuffix || '';
                    const aiPokeMessage = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `${characterName}Êà≥‰∫ÜÊà≥‰Ω†${aiPokeSuffix}`,
                        timestamp: Date.now(),
                        isPoke: true
                    };
                    
                    chatMessages[characterId].push(aiPokeMessage);
                    saveChatMessages();
                    renderChatMessages(characterId);
                }, 1000 + Math.random() * 2000);
            }
        }
        
        // ÊòæÁ§∫ËÅäÂ§©ÈÄâÈ°π
        function showChatOptions() {
            showModal('chat-options-modal');
        }
        
        // ÊòæÁ§∫ÂçïËÅäËßíËâ≤ÈÄâÊã©
        function showSingleChatSelector() {
            hideModal('chat-options-modal');
            
            const modalBody = document.getElementById('single-chat-body');
            modalBody.innerHTML = '';
            
            if (characters.length === 0) {
                modalBody.innerHTML = '<p class="empty-mount-chats">ËøòÊ≤°ÊúâËßíËâ≤ÔºåËØ∑ÂÖàÂàõÂª∫ËßíËâ≤</p>';
            } else {
                characters.forEach(character => {
                    const chatOption = document.createElement('div');
                    chatOption.className = 'chat-option-item';
                    chatOption.onclick = () => {
                        hideModal('single-chat-modal');
                        startChat(character);
                    };
                    
                    chatOption.innerHTML = `
                        <div class="chat-option-icon" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}</div>
                            <div class="chat-option-desc">${character.bio || 'ÊöÇÊó†ÊèèËø∞'}</div>
                        </div>
                    `;
                    
                    modalBody.appendChild(chatOption);
                });
            }
            
            showModal('single-chat-modal');
        }
        
        // ÊòæÁ§∫Áæ§ËÅäËßíËâ≤ÈÄâÊã©
        function showGroupChatSelector() {
            hideModal('chat-options-modal');
            
            // ÈáçÁΩÆË°®Âçï
            document.getElementById('group-chat-name').value = '';
            selectedGroupMembers = [];
            
            const membersContainer = document.getElementById('group-chat-members');
            membersContainer.innerHTML = '';
            
            if (characters.length < 2) {
                membersContainer.innerHTML = '<p class="empty-mount-chats">Ëá≥Â∞ëÈúÄË¶Å2‰∏™ËßíËâ≤ÊâçËÉΩÂàõÂª∫Áæ§ËÅä</p>';
            } else {
                characters.forEach(character => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.onclick = () => toggleGroupMemberSelection(character.id);
                    
                    memberItem.innerHTML = `
                        <div class="group-member-checkbox" id="checkbox-${character.id}">
                        </div>
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}</div>
                            <div class="chat-option-desc">${character.bio || 'ÊöÇÊó†ÊèèËø∞'}</div>
                        </div>
                    `;
                    
                    membersContainer.appendChild(memberItem);
                });
            }
            
            showModal('group-chat-modal');
        }
        
        // ÂàáÊç¢Áæ§ËÅäÊàêÂëòÈÄâÊã©
        function toggleGroupMemberSelection(characterId) {
            const index = selectedGroupMembers.indexOf(characterId);
            const checkbox = document.getElementById(`checkbox-${characterId}`);
            const memberItem = checkbox.closest('.group-member-item');
            
            if (index > -1) {
                selectedGroupMembers.splice(index, 1);
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                memberItem.classList.remove('selected');
            } else {
                if (selectedGroupMembers.length >= 8) {
                    alert('ÊúÄÂ§öÂè™ËÉΩÈÄâÊã©8‰∏™ÊàêÂëò');
                    return;
                }
                selectedGroupMembers.push(characterId);
                checkbox.classList.add('checked');
                checkbox.innerHTML = '<i class="fas fa-check"></i>';
                memberItem.classList.add('selected');
            }
        }
        
        // ÂàõÂª∫Áæ§ËÅä
        function createGroupChat() {
            const groupName = document.getElementById('group-chat-name').value.trim();
            
            if (!groupName) {
                alert('ËØ∑ËæìÂÖ•Áæ§ËÅäÂêçÁß∞');
                return;
            }
            
            if (selectedGroupMembers.length < 2) {
                alert('Ëá≥Â∞ëÈúÄË¶ÅÈÄâÊã©2‰∏™ÊàêÂëò');
                return;
            }
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÊàêÂëòÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
            const memberDetails = selectedGroupMembers.map(memberId => {
                const character = characters.find(c => c.id === memberId);
                return {
                    id: character.id,
                    name: character.name,
                    bio: character.bio,
                    avatarUrl: character.avatarUrl,
                    color: character.color
                };
            });
            
            // ÂàõÂª∫Áæ§ËÅäÂØπË±°
            const groupChat = {
                id: 'group_' + Date.now().toString(),
                name: groupName,
                members: memberDetails,
                isGroup: true,
                createdAt: new Date().toISOString()
            };
            
            // Ê∑ªÂä†Âà∞Áæ§ËÅäÂàóË°®
            if (!groupChats) groupChats = [];
            groupChats.push(groupChat);
            localStorage.setItem('groupChats', JSON.stringify(groupChats));
            
            hideModal('group-chat-modal');
            renderMessageList();
            alert(`Áæ§ËÅä"${groupName}"ÂàõÂª∫ÊàêÂäüÔºÅ`);
        }
        
        // ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ
        function saveGroupChats() {
            localStorage.setItem('groupChats', JSON.stringify(groupChats));
        }
        
        // Ê∏≤ÊüìÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function renderScheduleTimes() {
            const container = document.getElementById('schedule-times-container');
            if (!container) return;
            
            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduleTimes || [];
            
            container.innerHTML = '';
            
            scheduleTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'schedule-time-item';
                timeItem.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${index}, this.value)">
                    <button onclick="removeScheduleTime(${index})">√ó</button>
                `;
                container.appendChild(timeItem);
            });
        }
        
        // Ê∑ªÂä†ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function addScheduleTime() {
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduleTimes) {
                chatSettings.scheduleTimes = [];
            }
            
            if (chatSettings.scheduleTimes.length >= 10) {
                alert('ÊúÄÂ§öÂè™ËÉΩËÆæÁΩÆ10‰∏™Êó∂Èó¥ÁÇπ');
                return;
            }
            
            chatSettings.scheduleTimes.push('09:00');
            saveCurrentChatSettings(chatSettings);
            renderScheduleTimes();
        }
        
        // Êõ¥Êñ∞ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function updateScheduleTime(index, newTime) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes[index] = newTime;
                saveCurrentChatSettings(chatSettings);
            }
        }
        
        // ÁßªÈô§ÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        function removeScheduleTime(index) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes.splice(index, 1);
                saveCurrentChatSettings(chatSettings);
                renderScheduleTimes();
            }
        }
        
        // ‰øùÂ≠òÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆ
        function saveScheduleSettings() {
            const chatSettings = getCurrentChatSettings();
            chatSettings.scheduleEnabled = document.getElementById('schedule-enabled').checked;
            
            saveCurrentChatSettings(chatSettings);
            hideModal('schedule-settings-modal');
            alert('ÂÆöÊó∂ÂèëÂ∏ÉËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }
        
        // ÊòæÁ§∫‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆ
        function showWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            document.getElementById('worldbook-mount-enabled').checked = chatSettings.worldbookMountEnabled || false;
            
            // ÊéßÂà∂ËØ¶ÁªÜËÆæÁΩÆÁöÑÊòæÁ§∫
            toggleWorldbookMountDetails();
            
            // ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('worldbook-mount-enabled').onchange = toggleWorldbookMountDetails;
            
            // Ê∏≤Êüì‰∏ñÁïå‰π¶ÂàóË°®
            renderWorldbookMountList();
            
            showModal('worldbook-mount-modal');
        }
        
        // ÂàáÊç¢‰∏ñÁïå‰π¶ÊåÇËΩΩËØ¶ÁªÜËÆæÁΩÆÊòæÁ§∫
        function toggleWorldbookMountDetails() {
            const enabled = document.getElementById('worldbook-mount-enabled').checked;
            document.getElementById('worldbook-mount-details').style.display = enabled ? 'block' : 'none';
            
            // Êõ¥Êñ∞‰∏ªËÆæÁΩÆÁïåÈù¢ÊòæÁ§∫
            updateWorldbookMountDisplay();
        }
        
        // Êõ¥Êñ∞‰∏ñÁïå‰π¶ÊåÇËΩΩÊòæÁ§∫Áä∂ÊÄÅ
        function updateWorldbookMountDisplay() {
            const chatSettings = getCurrentChatSettings();
            const displayElement = document.getElementById('current-worldbook-mount');
            
            if (!chatSettings.worldbookMountEnabled) {
                displayElement.textContent = 'Êú™ÊåÇËΩΩ';
                return;
            }
            
            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];
            if (selectedWorldbooks.length === 0) {
                displayElement.textContent = 'Â∑≤ÂêØÁî®‰ΩÜÊú™ÈÄâÊã©';
            } else if (selectedWorldbooks.length === 1) {
                const worldbook = worldbooks.find(w => w.id === selectedWorldbooks[0]);
                displayElement.textContent = worldbook ? `Â∑≤ÊåÇËΩΩ: ${worldbook.title}` : 'Â∑≤ÊåÇËΩΩ: 1‰∏™';
            } else {
                displayElement.textContent = `Â∑≤ÊåÇËΩΩ: ${selectedWorldbooks.length}‰∏™`;
            }
        }
        
        // Ê∏≤Êüì‰∏ñÁïå‰π¶ÊåÇËΩΩÂàóË°®
        function renderWorldbookMountList() {
            const container = document.getElementById('worldbook-mount-list');
            container.innerHTML = '';
            
            if (worldbooks.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">ÊöÇÊó†‰∏ñÁïå‰π¶ÔºåËØ∑ÂÖàÂú®‰∏ñÁïå‰π¶Â∫îÁî®‰∏≠ÂàõÂª∫</p>';
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];
            
            worldbooks.forEach(worldbook => {
                const item = document.createElement('div');
                item.className = 'mount-item worldbook-mount-item';
                
                const isSelected = selectedWorldbooks.includes(worldbook.id);
                
                item.innerHTML = `
                    <input type="checkbox" id="worldbook-${worldbook.id}" value="${worldbook.id}" ${isSelected ? 'checked' : ''} class="worldbook-checkbox">
                    <div class="worldbook-content-flex">
                        <div class="worldbook-title-text">
                            ${worldbook.title}
                        </div>
                        <div class="worldbook-desc-text">
                            ${worldbook.content.length > 100 ? worldbook.content.substring(0, 100) + '...' : worldbook.content}
                        </div>
                        <div class="worldbook-date-text">
                            ÂàõÂª∫‰∫é: ${new Date(worldbook.createdAt).toLocaleDateString('zh-CN')} | 
                            Â≠óÊï∞: ${worldbook.content.length}
                        </div>
                    </div>
                `;
                
                // ÁÇπÂáªÊï¥‰∏™Êù°ÁõÆ‰πüËÉΩÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
                item.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                };
                
                container.appendChild(item);
            });
        }
        
        // ‰øùÂ≠ò‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆ
        function saveWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.worldbookMountEnabled = document.getElementById('worldbook-mount-enabled').checked;
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑ‰∏ñÁïå‰π¶
            const checkboxes = document.querySelectorAll('#worldbook-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedWorldbooks = Array.from(checkboxes).map(cb => cb.value);
            
            saveCurrentChatSettings(chatSettings);
            updateWorldbookMountDisplay();
            hideModal('worldbook-mount-modal');
            
            const selectedCount = chatSettings.selectedWorldbooks ? chatSettings.selectedWorldbooks.length : 0;
            if (chatSettings.worldbookMountEnabled && selectedCount > 0) {
                alert(`‰∏ñÁïå‰π¶ÊåÇËΩΩËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÂ∑≤ÊåÇËΩΩ ${selectedCount} ‰∏™‰∏ñÁïå‰π¶`);
            } else if (chatSettings.worldbookMountEnabled) {
                alert('‰∏ñÁïå‰π¶ÊåÇËΩΩÂ∑≤ÂêØÁî®Ôºå‰ΩÜÊú™ÈÄâÊã©‰ªª‰Ωï‰∏ñÁïå‰π¶');
            } else {
                alert('‰∏ñÁïå‰π¶ÊåÇËΩΩÂ∑≤ÂÖ≥Èó≠');
            }
        }
        
        // ÊòæÁ§∫Ë∫´‰ªΩÈÄâÊã©Âô®
        function showIdentitySelector() {
            renderIdentityList();
            showModal('identity-selector-modal');
        }
        
        // Ê∏≤ÊüìË∫´‰ªΩÂàóË°®
        function renderIdentityList() {
            const container = document.getElementById('identity-selector-list');
            container.innerHTML = '';
            
            const chatSettings = getCurrentChatSettings();
            const selectedIdentityId = chatSettings.selectedIdentityId || 'default';
            
            personas.forEach(persona => {
                const item = document.createElement('div');
                item.className = `identity-item ${selectedIdentityId === persona.id ? 'selected' : ''}`;
                
                item.onclick = () => {
                    // ÁßªÈô§ÂÖ∂‰ªñÈÄâ‰∏≠Áä∂ÊÄÅ
                    container.querySelectorAll('.identity-item').forEach(div => {
                        div.classList.remove('selected');
                    });
                    
                    // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠Áä∂ÊÄÅ
                    item.classList.add('selected');
                    
                    // ‰øùÂ≠òÈÄâÊã©
                    window.selectedChatIdentityId = persona.id;
                };
                
                item.innerHTML = `
                    <div class="identity-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''} display: flex; align-items: center; justify-content: center; color: #999; font-weight: bold;">
                        ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                    </div>
                    <div class="identity-content-flex">
                        <div class="identity-name">${persona.name}</div>
                        <div class="identity-desc">${persona.description || 'ÊöÇÊó†ÊèèËø∞'}</div>
                    </div>
                    ${selectedIdentityId === persona.id ? '<i class="fas fa-check identity-check-icon"></i>' : ''}
                `;
                
                container.appendChild(item);
                
                // ËÆæÁΩÆÂàùÂßãÈÄâ‰∏≠Áä∂ÊÄÅ
                if (selectedIdentityId === persona.id) {
                    window.selectedChatIdentityId = persona.id;
                }
            });
        }
        
        // ‰øùÂ≠òËÅäÂ§©Ë∫´‰ªΩÈÄâÊã©
        function saveChatIdentity() {
            if (!window.selectedChatIdentityId) {
                alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ë∫´‰ªΩ');
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const selectedPersona = personas.find(p => p.id === window.selectedChatIdentityId);
            
            if (selectedPersona) {
                chatSettings.selectedIdentityId = selectedPersona.id;
                
                // Â¶ÇÊûúÈÄâ‰∏≠ÁöÑË∫´‰ªΩÊúâÂ§¥ÂÉèÔºåËá™Âä®ËÆæÁΩÆ‰∏∫ËÅäÂ§©Â§¥ÂÉèÔºàÂ¶ÇÊûúÂΩìÂâçÊ≤°ÊúâËÆæÁΩÆÁöÑËØùÔºâ
                if (selectedPersona.avatarUrl && !chatSettings.myChatAvatar) {
                    chatSettings.myChatAvatar = selectedPersona.avatarUrl;
                }
                
                // Â¶ÇÊûúÈÄâ‰∏≠ÁöÑË∫´‰ªΩÊúâÂêçÁß∞ÔºåËá™Âä®ËÆæÁΩÆ‰∏∫ËÅäÂ§©ÊòµÁß∞ÔºàÂ¶ÇÊûúÂΩìÂâçÊ≤°ÊúâËÆæÁΩÆÁöÑËØùÔºâ
                if (selectedPersona.name && !chatSettings.myChatNickname) {
                    chatSettings.myChatNickname = selectedPersona.name;
                }
                
                saveCurrentChatSettings(chatSettings);
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                updateChatIdentityDisplay();
                
                // Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                hideModal('identity-selector-modal');
                alert(`Â∑≤ÈÄâÊã©Ë∫´‰ªΩ"${selectedPersona.name}"`);
            }
        }
        
        // Êõ¥Êñ∞ËÅäÂ§©Ë∫´‰ªΩÊòæÁ§∫
        function updateChatIdentityDisplay() {
            const chatSettings = getCurrentChatSettings();
            const selectedIdentityId = chatSettings.selectedIdentityId || 'default';
            const selectedPersona = personas.find(p => p.id === selectedIdentityId);
            
            const displayElement = document.getElementById('current-chat-identity');
            if (displayElement && selectedPersona) {
                displayElement.textContent = selectedPersona.name;
            }
        }
        
        // Êõ¥Êñ∞Ê∞îÊ≥°Ê†∑ÂºèÊòæÁ§∫
        function updateBubbleStyleDisplay() {
            const chatSettings = getCurrentChatSettings();
            const styleNames = {
                'default': 'ÈªòËÆ§Ê†∑Âºè',
                'glass': 'ÊØõÁéªÁíÉ',
                'shadow': 'ÁªèÂÖ∏Èò¥ÂΩ±',
                'tail': 'ÁªèÂÖ∏Ê∞îÊ≥°',
                'gradient': 'Ê∏êÂèòÊ†∑Âºè',
                'minimal': 'ÊûÅÁÆÄÊ†∑Âºè',
                'neon': 'ÈúìËôπÊ†∑Âºè',
                'paper': 'Á∫∏Âº†Ê†∑Âºè'
            };
            
            const displayElement = document.getElementById('current-bubble-style');
            if (displayElement) {
                const currentStyle = chatSettings.bubbleStyle || 'default';
                displayElement.textContent = styleNames[currentStyle] || 'ÈªòËÆ§Ê†∑Âºè';
            }
        }
        
        // ÂÖ®Â±ÄÂ§¥ÂÉè‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        function handleAvatarUploadClick() {
            console.log('ÁÇπÂáª‰∫Ü‰∏ä‰º†Â§¥ÂÉèÊåâÈíÆ');
            const input = document.getElementById('avatar-upload');
            if (input) {
                console.log('ÊâæÂà∞‰∫ÜinputÂÖÉÁ¥†ÔºåÂáÜÂ§áËß¶ÂèëÁÇπÂáª');
                input.click();
            } else {
                console.error('Êâæ‰∏çÂà∞avatar-uploadÂÖÉÁ¥†');
                alert('Êâæ‰∏çÂà∞Êñá‰ª∂‰∏ä‰º†ÂÖÉÁ¥†ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }
        
        // Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ
        function loadGroupChats() {
            const groupChatsData = localStorage.getItem('groupChats');
            if (groupChatsData) {
                groupChats = JSON.parse(groupChatsData);
            }
        }
        
        // Ê∑ªÂä†Ê∂àÊÅØÈïøÊåâÁõëÂê¨Âô®
        function addMessageLongPressListener(messageContainer, messageId) {
            let pressTimer = null;
            let isLongPress = false;
            
            const startLongPress = (e) => {
                if (isMessageSelectionMode) {
                    // Âú®ÈÄâÊã©Ê®°Âºè‰∏ãÔºåÂè™Â§ÑÁêÜÁÇπÂáªÈÄâÊã©Ôºå‰∏çÂ§ÑÁêÜÈïøÊåâ
                    return;
                }
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    enterMessageSelectionMode(messageId);
                    e.preventDefault();
                }, 500);
            };
            
            const cancelLongPress = () => {
                clearTimeout(pressTimer);
                // ÈáçÁΩÆÈïøÊåâÊ†áËÆ∞ÔºåÂª∂ËøüÈáçÁΩÆ‰ª•ÈÅøÂÖçÁ´ãÂç≥Ëß¶ÂèëÁÇπÂáª
                setTimeout(() => {
                    isLongPress = false;
                }, 50);
            };
            
            const handleClick = (e) => {
                // Âú®ÈÄâÊã©Ê®°Âºè‰∏ãÔºåÊâÄÊúâÊ∂àÊÅØÈÉΩÂèØ‰ª•ÁÇπÂáªÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
                if (isMessageSelectionMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMessageSelection(messageId);
                    return;
                }
                
                // Â¶ÇÊûúÊòØÈïøÊåâËß¶ÂèëÂêéÁöÑÁÇπÂáªÔºå‰∏çÂ§ÑÁêÜ
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            };
            
            // Ëß¶Êë∏‰∫ã‰ª∂
            messageContainer.addEventListener('touchstart', startLongPress, { passive: false });
            messageContainer.addEventListener('touchend', cancelLongPress);
            messageContainer.addEventListener('touchmove', cancelLongPress);
            
            // Èº†Ê†á‰∫ã‰ª∂ÔºàÁî®‰∫éÊ°åÈù¢Á´ØÊµãËØïÔºâ
            messageContainer.addEventListener('mousedown', startLongPress);
            messageContainer.addEventListener('mouseup', cancelLongPress);
            messageContainer.addEventListener('mouseleave', cancelLongPress);
            
            // ÁÇπÂáª‰∫ã‰ª∂ - ‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµÁ°Æ‰øù‰ºòÂÖàÂ§ÑÁêÜ
            messageContainer.addEventListener('click', handleClick, true);
        }
        
        // ËøõÂÖ•Ê∂àÊÅØÈÄâÊã©Ê®°Âºè
        function enterMessageSelectionMode(initialMessageId) {
            if (isMessageSelectionMode) {
                return;
            }
            
            isMessageSelectionMode = true;
            selectedMessages.clear();
            selectedMessages.add(initialMessageId);
            
            // Ê∑ªÂä†ÈÄâÊã©Ê®°ÂºèCSSÁ±ª
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.add('selection-mode');
            }
            
            updateMessageSelectionUI();
        }
        
        // ÂàáÊç¢Ê∂àÊÅØÈÄâÊã©Áä∂ÊÄÅ
        function toggleMessageSelection(messageId) {
            if (!isMessageSelectionMode) return;
            
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
            } else {
                selectedMessages.add(messageId);
            }
            
            updateMessageSelectionUI();
            
            // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÔºåÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
            if (selectedMessages.size === 0) {
                exitMessageSelectionMode();
            }
        }
        
        // ÈÄÄÂá∫Ê∂àÊÅØÈÄâÊã©Ê®°Âºè
        function exitMessageSelectionMode() {
            if (!isMessageSelectionMode) return;
            
            isMessageSelectionMode = false;
            
            // ÁßªÈô§ÈÄâÊã©Ê®°ÂºèCSSÁ±ª
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.remove('selection-mode');
            }
            
            // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
            const selectedContainers = document.querySelectorAll('.message-container.selected');
            selectedContainers.forEach(container => {
                container.classList.remove('selected');
            });
            
            selectedMessages.clear();
            updateMessageSelectionUI();
        }
        

        
        // Êõ¥Êñ∞Ê∂àÊÅØÈÄâÊã©UI
        function updateMessageSelectionUI() {
            const messageContainers = document.querySelectorAll('.message-container');
            
            messageContainers.forEach(container => {
                const messageId = container.dataset.messageId;
                if (messageId) {
                    if (selectedMessages.has(messageId)) {
                        container.classList.add('selected');
                    } else {
                        container.classList.remove('selected');
                    }
                }
            });
            
            // Êõ¥Êñ∞ÈÄâÊã©ËÆ°Êï∞ÊòæÁ§∫
            const countElement = document.getElementById('selection-count');
            if (countElement) {
                countElement.textContent = `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`;
            }
        }
        
        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØ
        function deleteSelectedMessages() {
            if (selectedMessages.size === 0) return;
            
            if (!currentChatCharacter) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                const characterId = currentChatCharacter.id;
                
                if (chatMessages[characterId]) {
                    // ËøáÊª§ÊéâÈÄâ‰∏≠ÁöÑÊ∂àÊÅØ
                    chatMessages[characterId] = chatMessages[characterId].filter(message => 
                        !selectedMessages.has(message.id)
                    );
                    
                    saveChatMessages();
                    renderChatMessages(characterId);
                    renderMessageList(); // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                }
                
                // ÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
                exitMessageSelectionMode();
            }
        }

        // ÊÇ¨ÊµÆÊåâÈíÆÂäüËÉΩ
        // ÂèòÈáèÊéßÂà∂Á≠âÂæÖÂõûÂ§çÁä∂ÊÄÅ
        let isWaitingForReply = false;
        let pendingUserMessage = null;

        // ÈáçÊñ∞ÁîüÊàêÊúÄÂêé‰∏ÄÊ¨°AIÂõûÂ§ç
        async function regenerateLastResponse() {
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            const characterId = currentChatCharacter.id;
            const messages = chatMessages[characterId] || [];
            
            // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØÂèäÂÖ∂ÂØπÂ∫îÁöÑÁî®Êà∑Ê∂àÊÅØ
            let lastAiMessageIndex = -1;
            let lastUserMessageIndex = -1;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender === 'received' && lastAiMessageIndex === -1) {
                    lastAiMessageIndex = i;
                }
                if (lastAiMessageIndex !== -1 && messages[i].sender === 'sent' && lastUserMessageIndex === -1) {
                    lastUserMessageIndex = i;
                    break;
                }
            }
            
            if (lastAiMessageIndex === -1) {
                alert('Ê≤°ÊúâÊâæÂà∞AIÂõûÂ§çÂèØ‰ª•ÈáçÊñ∞ÁîüÊàê');
                return;
            }
            
            if (lastUserMessageIndex === -1) {
                alert('Ê≤°ÊúâÊâæÂà∞ÂØπÂ∫îÁöÑÁî®Êà∑Ê∂àÊÅØ');
                return;
            }

            const userMessage = messages[lastUserMessageIndex];
            
            // Âà†Èô§‰ªéÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÂêéÁöÑÊâÄÊúâAIÊ∂àÊÅØ
            chatMessages[characterId] = messages.slice(0, lastUserMessageIndex + 1);
            saveChatMessages();
            renderChatMessages(characterId);
            
            // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
            showTypingIndicator();
            
            // Ê∑ªÂä†ÈöèÊú∫Âª∂Ëøü
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
            
            try {
                // ÈáçÊñ∞Ë∞ÉÁî®APIÔºåÊîØÊåÅÂõæÁâáÂíåË°®ÊÉÖÂåÖ
                let response;
                if (userMessage.image) {
                    // Â¶ÇÊûúÊòØÂõæÁâáÊ∂àÊÅØÔºå‰ΩøÁî®Â∏¶ÂõæÁâáÁöÑAPIË∞ÉÁî®
                    if (userMessage.isEmoji) {
                        // Ë°®ÊÉÖÂåÖÊ∂àÊÅØÔºå‰ΩøÁî®Â¢ûÂº∫ÁöÑË°®ÊÉÖÂåÖËØÜÂà´ÊèêÁ§∫ËØç
                        const emojiPrompt = `Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÂõæÁâá„ÄÇËøôÊòØ‰∏Ä‰∏™Ë°®ÊÉÖÂåÖ/Ê¢óÂõæÔºåËØ∑‰ªîÁªÜËßÇÂØüÂõæÁâáÂÜÖÂÆπÔºåÂåÖÊã¨ÂÖ∂‰∏≠ÁöÑÊñáÂ≠ó„ÄÅË°®ÊÉÖ„ÄÅÂä®‰Ωú„ÄÅÈ¢úËâ≤„ÄÅËÉåÊôØÁ≠âÊâÄÊúâÁªÜËäÇÔºåÁêÜËß£ÂÖ∂Ë°®ËææÁöÑÊÉÖÁª™„ÄÅÂê´‰πâÊàñÊ¢óÔºåÁÑ∂ÂêéÂÅöÂá∫Ëá™ÁÑ∂ÁöÑÂõûÂ∫î„ÄÇÂ¶ÇÊûúÂõæÁâá‰∏≠ÊúâÊñáÂ≠óÔºåËØ∑ÁêÜËß£ÊñáÂ≠óÁöÑÂê´‰πâÂíåËØ≠Â¢É„ÄÇË°®ÊÉÖÂåÖÊèèËø∞Ôºö${userMessage.emojiDescription || 'Ë°®ÊÉÖÂåÖ'}`;
                        response = await callChatAPIWithImage(emojiPrompt, currentChatCharacter, userMessage.image);
                    } else {
                        // ÊôÆÈÄöÂõæÁâáÊ∂àÊÅØ
                        const imagePrompt = userMessage.content || `Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá„ÄÇËØ∑‰ªîÁªÜËßÇÂØüÂõæÁâáÂÜÖÂÆπÂπ∂ÂÅöÂá∫ÂõûÂ∫î„ÄÇ`;
                        response = await callChatAPIWithImage(imagePrompt, currentChatCharacter, userMessage.image);
                    }
                } else {
                    // ÊñáÂ≠óÊ∂àÊÅØ
                    response = await callChatAPI(userMessage.content, currentChatCharacter);
                }
                const aiMessages = parseAiResponse(response);
                
                hideTypingIndicator();
                
                // Ê∑ªÂä†Êñ∞ÁöÑAIÂõûÂ§ç
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
                    if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', 
                            content: msgData.content, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image', 
                            content: '',
                            image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`,
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', 
                            amount: msgData.amount, 
                            note: msgData.note, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'emoji') {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅÁöÑË°®ÊÉÖÂåÖ
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: '',
                            image: msgData.url,
                            isEmoji: true,
                            emojiDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                        
                        // Â∞ÜË°®ÊÉÖÂåÖÊ∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®
                        addToRecentEmojis({
                            id: msgData.id,
                            url: msgData.url,
                            description: msgData.description
                        });
                    } else {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: String(msgData), 
                            timestamp: Date.now() + i * 100
                        };
                    }
                    
                    chatMessages[characterId].push(aiMessage);
                    saveChatMessages();
                    renderChatMessages(characterId);
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•:', error);
                hideTypingIndicator();
                
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[ÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[characterId].push(errorMessage);
                saveChatMessages();
                renderChatMessages(characterId);
            }
            
            // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
            updateFloatingButtonsVisibility();
        }

        // Êô∫ËÉΩÂõûÂ§çÂäüËÉΩ
        function triggerSmartReply() {
            if (!pendingUserMessage) {
                alert('ËØ∑ÂÖàÂèëÈÄÅ‰∏ÄÊù°Ê∂àÊÅØÔºåÁÑ∂ÂêéÁÇπÂáªÊ≠§ÊåâÈíÆÊù•Ëé∑ÂèñAIÂõûÂ§ç');
                return;
            }

            if (isWaitingForReply) {
                alert('AIÊ≠£Âú®ÂõûÂ§ç‰∏≠ÔºåËØ∑Á®çÂÄô...');
                return;
            }

            // ÂºÄÂßãAIÂõûÂ§ç
            processAIReply();
        }

        // Â§ÑÁêÜAIÂõûÂ§ç
        async function processAIReply() {
            if (!pendingUserMessage || !currentChatCharacter) return;

            isWaitingForReply = true;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = true;
                smartReplyBtn.style.opacity = '0.65';
                smartReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÊèêÁ§∫
            showTypingIndicator();
            
            // Ê∑ªÂä†ÈöèÊú∫Âª∂Ëøü
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                // Ë∞ÉÁî®APIÔºåÊîØÊåÅÂõæÁâáÂíåË°®ÊÉÖÂåÖ
                let response;
                if (pendingUserMessage.image) {
                    // Â¶ÇÊûúÊòØÂõæÁâáÊ∂àÊÅØÔºå‰ΩøÁî®Â∏¶ÂõæÁâáÁöÑAPIË∞ÉÁî®
                    if (pendingUserMessage.isEmoji) {
                        // Ë°®ÊÉÖÂåÖÊ∂àÊÅØÔºå‰ΩøÁî®Â¢ûÂº∫ÁöÑË°®ÊÉÖÂåÖËØÜÂà´ÊèêÁ§∫ËØç
                        const emojiPrompt = `Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÂõæÁâá„ÄÇËøôÊòØ‰∏Ä‰∏™Ë°®ÊÉÖÂåÖ/Ê¢óÂõæÔºåËØ∑‰ªîÁªÜËßÇÂØüÂõæÁâáÂÜÖÂÆπÔºåÂåÖÊã¨ÂÖ∂‰∏≠ÁöÑÊñáÂ≠ó„ÄÅË°®ÊÉÖ„ÄÅÂä®‰Ωú„ÄÅÈ¢úËâ≤„ÄÅËÉåÊôØÁ≠âÊâÄÊúâÁªÜËäÇÔºåÁêÜËß£ÂÖ∂Ë°®ËææÁöÑÊÉÖÁª™„ÄÅÂê´‰πâÊàñÊ¢óÔºåÁÑ∂ÂêéÂÅöÂá∫Ëá™ÁÑ∂ÁöÑÂõûÂ∫î„ÄÇÂ¶ÇÊûúÂõæÁâá‰∏≠ÊúâÊñáÂ≠óÔºåËØ∑ÁêÜËß£ÊñáÂ≠óÁöÑÂê´‰πâÂíåËØ≠Â¢É„ÄÇË°®ÊÉÖÂåÖÊèèËø∞Ôºö${pendingUserMessage.emojiDescription || 'Ë°®ÊÉÖÂåÖ'}`;
                        response = await callChatAPIWithImage(emojiPrompt, currentChatCharacter, pendingUserMessage.image);
                    } else {
                        // ÊôÆÈÄöÂõæÁâáÊ∂àÊÅØ
                        const imagePrompt = pendingUserMessage.content || `Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá„ÄÇËØ∑‰ªîÁªÜËßÇÂØüÂõæÁâáÂÜÖÂÆπÂπ∂ÂÅöÂá∫ÂõûÂ∫î„ÄÇ`;
                        response = await callChatAPIWithImage(imagePrompt, currentChatCharacter, pendingUserMessage.image);
                    }
                } else {
                    // ÊñáÂ≠óÊ∂àÊÅØ
                    response = await callChatAPI(pendingUserMessage.content, currentChatCharacter);
                }
                const aiMessages = parseAiResponse(response);
                
                hideTypingIndicator();
                
                // ÈÄêÊù°ÂèëÈÄÅÊ∂àÊÅØ
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
                    if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', 
                            content: msgData.content, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image', 
                            content: '',
                            image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AIÊèèËø∞ÁöÑÂõæÁâá]</text></svg>')}`,
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', 
                            amount: msgData.amount, 
                            note: msgData.note, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'emoji') {
                        // üî•„ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜAIÂèëÈÄÅÁöÑË°®ÊÉÖÂåÖ
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: '',
                            image: msgData.url,
                            isEmoji: true,
                            emojiDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                        
                        // Â∞ÜË°®ÊÉÖÂåÖÊ∑ªÂä†Âà∞ÊúÄËøë‰ΩøÁî®
                        addToRecentEmojis({
                            id: msgData.id,
                            url: msgData.url,
                            description: msgData.description
                        });
                    } else {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: String(msgData), 
                            timestamp: Date.now() + i * 100
                        };
                    }
                    
                    chatMessages[currentChatCharacter.id].push(aiMessage);
                    saveChatMessages();
                    renderChatMessages(currentChatCharacter.id);
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('AIÂõûÂ§çÂ§±Ë¥•:', error);
                hideTypingIndicator();
                
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[ÂõûÂ§çÂ§±Ë¥•: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[currentChatCharacter.id].push(errorMessage);
                saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
            } finally {
                // ÈáçÁΩÆÁä∂ÊÄÅ
                isWaitingForReply = false;
                pendingUserMessage = null;
                
                // ÊÅ¢Â§çÊô∫ËÉΩÂõûÂ§çÊåâÈíÆ
                if (smartReplyBtn) {
                    smartReplyBtn.disabled = false;
                    smartReplyBtn.style.opacity = '';
                    smartReplyBtn.style.animation = 'none';
                    smartReplyBtn.classList.remove('waiting');
                    smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    smartReplyBtn.title = 'Ëé∑ÂèñAIÂõûÂ§ç';
                }
                
                // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
                updateFloatingButtonsVisibility();
            }
        }

        // ÈáçÁΩÆÊÇ¨ÊµÆÊåâÈíÆÁä∂ÊÄÅ
        function resetFloatingButtonsState() {
            // ÈáçÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = null;
            isWaitingForReply = false;
            
            // ÈáçÁΩÆÊô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = false;
                smartReplyBtn.style.opacity = '';
                smartReplyBtn.style.animation = 'none';
                smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                smartReplyBtn.title = 'Ëé∑ÂèñAIÂõûÂ§ç';
                smartReplyBtn.classList.remove('waiting');
            }
            
            // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
            updateFloatingButtonsVisibility();
        }

        // Êõ¥Êñ∞ÊÇ¨ÊµÆÊåâÈíÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        function updateFloatingButtonsVisibility() {
            if (!currentChatCharacter) return;
            
            const regenerateBtn = document.getElementById('regenerate-btn');
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            const messages = chatMessages[currentChatCharacter.id] || [];
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâAIÊ∂àÊÅØÂèØ‰ª•ÈáçÊñ∞ÁîüÊàê
            const hasAIMessages = messages.some(msg => msg.sender === 'received');
            
            if (regenerateBtn) {
                if (hasAIMessages) {
                    regenerateBtn.classList.remove('hidden');
                } else {
                    regenerateBtn.classList.add('hidden');
                }
            }
            
            if (smartReplyBtn) {
                // Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÊÄªÊòØÊòæÁ§∫
                smartReplyBtn.classList.remove('hidden');
            }
        }

        // ‰øÆÊîπÂéüÊù•ÁöÑsendApiMessageÂáΩÊï∞Ôºå‰ΩøÂÖ∂Âè™ÂèëÈÄÅÊ∂àÊÅØÂà∞ÁïåÈù¢Ôºå‰∏çËß¶ÂèëAIÂõûÂ§ç
        async function sendApiMessage() {
            const input = document.getElementById('api-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!currentChatCharacter) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                return;
            }
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            const messageId = Date.now().toString();
            const userMessage = {
                id: messageId,
                sender: 'sent',
                content: message,
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(userMessage);
            saveChatMessages();
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            input.value = '';
            
            // Ê∏≤ÊüìÊ∂àÊÅØ
            renderChatMessages(currentChatCharacter.id);
            
            // ËÆæÁΩÆÂæÖÂõûÂ§çÊ∂àÊÅØ
            pendingUserMessage = userMessage;
            
            // Êõ¥Êñ∞Êô∫ËÉΩÂõûÂ§çÊåâÈíÆÁä∂ÊÄÅ
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = 'ÁÇπÂáªËé∑ÂèñAIÂõûÂ§ç';
            }
        }
    </script>
</body>
</html>
        