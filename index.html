<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Phone Chat 模拟器</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600;700&family=Comic+Neue:wght@400;700&family=Fredoka+One&family=Nunito:wght@400;500;600;700&family=Montserrat:wght@400;500;600&family=Inter:wght@400;500;600&family=Roboto:wght@400;500&family=Raleway:wght@400;500;600&family=Lato:wght@400;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* 主题系统 - 简约风格 (默认) */
        :root {
            --theme-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --theme-font-weight: 400;
            --theme-line-height: 1.5;
            
            --theme-button-bg: rgba(74, 132, 193, 0.9);
            --theme-button-bg-hover: rgba(74, 132, 193, 1);
            --theme-button-color: white;
            --theme-button-border: none;
            --theme-button-radius: 20px;
            --theme-button-shadow: 0 2px 8px rgba(74, 132, 193, 0.3);
            
            --theme-button-secondary-bg: rgba(255, 255, 255, 0.8);
            --theme-button-secondary-bg-hover: rgba(255, 255, 255, 0.95);
            --theme-button-secondary-color: #555;
            --theme-button-secondary-border: rgba(0, 0, 0, 0.1);
            
            --theme-header-bg: rgba(247, 247, 247, 0.8);
            --theme-header-backdrop: blur(10px);
            
            --theme-form-bg: rgba(255, 255, 255, 0.8);
            --theme-input-border: rgba(0, 0, 0, 0.08);
            --theme-input-radius: 15px;
            --theme-input-focus: rgba(0, 123, 255, 0.5);
            --theme-input-focus-shadow: rgba(0, 123, 255, 0.1);
            
            --theme-avatar-bg-1: #f0f2f5;
            --theme-avatar-bg-2: #e8ebf0;
            --theme-avatar-text: #8b9dc3;
            --theme-avatar-border: rgba(255, 255, 255, 0.8);
            
            --theme-text-primary: #333;
            
            /* 默认主题的背景色 */
            --body-bg: #ffffff;
            
            /* 间距系统 */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 20px;
            --spacing-xl: 32px;
            
            /* 尺寸系统 */
            --size-xs: 20px;
            --size-sm: 24px;
            --size-md: 30px;
            --size-lg: 40px;
            --size-xl: 50px;
            --size-xxl: 60px;
            
            /* 字体大小系统 */
            --font-size-xs: 10px;
            --font-size-sm: 12px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-xxl: 20px;
            --font-size-xxxl: 24px;
            --font-size-huge: 32px;
            --font-size-giant: 80px;
            
            /* 圆角系统 */
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 15px;
            --radius-xxl: 18px;
            --radius-xxxl: 20px;
            --radius-huge: 25px;
            --radius-round: 50%;
            
            /* 行高系统 */
            --line-height-tight: 1.3;
            --line-height-normal: 1.4;
            --line-height-relaxed: 1.5;
            --line-height-loose: 1.6;
            
            /* Z-index系统 */
            --z-index-dropdown: 10;
            --z-index-sticky: 20;
            --z-index-fixed: 30;
            --z-index-modal-backdrop: 40;
            --z-index-modal: 50;
            --z-index-popover: 60;
            --z-index-tooltip: 70;
            --z-index-notification: 80;
            
            /* 动画系统 */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            /* 阴影系统 */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 15px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 8px 25px rgba(0, 0, 0, 0.15);
            --shadow-phone: 0 20px 40px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
            --shadow-special: 0 8px 30px rgba(0,0,0,0.3);
            --shadow-mixed: 0 12px 35px rgba(0, 0, 0, 0.2);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-neon-green: 0 0 10px rgba(0, 255, 136, 0.3);
            --shadow-neon-blue: 0 0 10px rgba(0, 212, 255, 0.4);
            --shadow-neon-green-small: 0 0 5px rgba(0, 255, 136, 0.2);
            --shadow-neon-green-large: 0 0 15px rgba(0, 255, 136, 0.4);
            --shadow-neon-green-8px: 0 0 8px rgba(0, 255, 136, 0.3);
            --shadow-neon-blue-8px: 0 0 8px rgba(0, 212, 255, 0.4);
            --shadow-form-mixed: 0 3px 8px rgba(0, 0, 0, 0.18);
            --shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-hover-alt: 0 6px 20px rgba(0, 0, 0, 0.15);
            --shadow-button: 0 2px 6px rgba(0, 0, 0, 0.08);
            
            /* 文字阴影 */
            --text-shadow-sm: 0 1px 3px rgba(0,0,0,0.5);
            --text-shadow-md: 0 3px 8px rgba(0,0,0,0.4);
            --text-shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            
            /* 通用背景色 */
            --bg-white-30: rgba(255, 255, 255, 0.3);
            --bg-white-50: rgba(255, 255, 255, 0.5);
            --bg-white-70: rgba(255, 255, 255, 0.7);
            --bg-white-80: rgba(255, 255, 255, 0.8);
            --bg-white-90: rgba(255, 255, 255, 0.9);
            --bg-white-95: rgba(255, 255, 255, 0.95);
            --bg-white-10: rgba(255, 255, 255, 0.1);
            --bg-white-15: rgba(255, 255, 255, 0.15);
            --bg-black-05: rgba(0, 0, 0, 0.05);
            --bg-black-08: rgba(0, 0, 0, 0.08);
            --bg-black-10: rgba(0, 0, 0, 0.1);
            --bg-black-15: rgba(0, 0, 0, 0.15);
            --bg-black-18: rgba(0, 0, 0, 0.18);
            --bg-black-20: rgba(0, 0, 0, 0.2);
            --bg-default-05: rgba(74, 132, 193, 0.05);
            --bg-default-10: rgba(74, 132, 193, 0.1);
            --bg-default-shadow: rgba(74, 132, 193, 0.2);
            
            /* 边框颜色 */
            --border-light: rgba(255, 255, 255, 0.3);
            --border-dark: rgba(0, 0, 0, 0.08);
            --border-white-15: rgba(255, 255, 255, 0.15);
            --border-white-20: rgba(255, 255, 255, 0.2);
            --border-black-05: rgba(0, 0, 0, 0.05);
            
            /* 文字颜色 */
            --text-white-70: rgba(255, 255, 255, 0.7);
            --text-black-50: rgba(0, 0, 0, 0.5);
            
            /* 特殊背景 */
            --bg-header-default: rgba(247, 247, 247, 0.75);
            --bg-form-light: rgba(255, 255, 255, 0.6);
            --bg-black-50: rgba(0, 0, 0, 0.5);
            --bg-blue-05: rgba(0, 123, 255, 0.05);
            --bg-blue-10: rgba(0, 123, 255, 0.1);
            --bg-blue-20: rgba(0, 123, 255, 0.2);
            --bg-red-10: rgba(255, 59, 48, 0.1);
            --bg-red-20: rgba(255, 59, 48, 0.2);
            --bg-red-90: rgba(255, 59, 48, 0.9);
            --bg-white-100: rgba(255, 255, 255, 1);
            
            /* 特殊阴影 */
            --shadow-light-2: 0 2px 5px rgba(0, 0, 0, 0.1);
            --shadow-card-special: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-light-4: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-small: 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow-focus: 0 0 0 2px rgba(74, 132, 193, 0.2);
            --shadow-bottom: 0 -4px 20px rgba(0,0,0,0.15);
            --shadow-heavy: 0 4px 12px rgba(0, 0, 0, 0.3);
            
            /* 特殊边框 */
            --border-black-10: rgba(0, 0, 0, 0.1);
            --border-black-60: rgba(0, 0, 0, 0.6);
            
            /* 常用颜色变量 */
            --color-black: #000;
            --color-white: #fff;
            --color-green: #4cd964;
            --color-blue: #007AFF;
            --color-blue-light: #f0f8ff;
            --color-gray-light: #f0f0f0;
            --color-gray: #666;
            --color-gray-dark: #333;
            --color-gray-darker: #2c2c2c;
            --color-gray-medium: #999;
            --color-gray-border: #e0e0e0;
            --color-gray-bg: #f5f5f5;
            --color-gray-bg-light: #f8f8f8;
            --color-gray-bg-lighter: #fafafa;
            --color-border: #eee;
            --color-border-light: #eee;
            --color-border-medium: #ddd;
            --color-border-gray: #ccc;
            --color-wechat-green: #07C160;
            --color-text-light: #888;
            --color-text-lighter: #aaa;
            --color-wallpaper: #a8d4a8;
            --color-neon-green: #00ff88;
            --color-neon-blue: #00d4ff;
            --color-orange: #FF9500;
            --color-yellow: #FFCC00;
            --color-light-blue: #5AC8FA;
            --color-pink: #AF52DE;
            
            /* iOS 系统颜色 */
            --color-ios-green: #34C759;
            --color-ios-purple: #5856D6;
            --color-ios-red: #FF2D55;
            --color-ios-gray: #8E8E93;
            
            /* 渐变色 */
            --gradient-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-gray: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --gradient-pink: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            
            /* 气泡颜色变量 */
            --ai-bubble-color: #f0f0f0;
            --my-bubble-color: #007AFF;
            
            /* 气泡样式系统 */
            --bubble-glass-bg-ai: rgba(240, 240, 240, 0.7);
            --bubble-glass-bg-user: rgba(0, 122, 255, 0.8);
            --bubble-glass-border-ai: rgba(255, 255, 255, 0.4);
            --bubble-glass-border-user: rgba(255, 255, 255, 0.3);
            --bubble-neon-bg-ai: rgba(240, 240, 240, 0.9);
            --bubble-neon-bg-user: rgba(0, 122, 255, 0.9);
            
            /* 悬浮按钮 */
            --floating-btn-bg: rgba(74, 132, 193, 0.35);
            --floating-btn-bg-hover: rgba(74, 132, 193, 0.55);
            --floating-btn-secondary-bg: rgba(255, 255, 255, 0.35);
            --floating-btn-secondary-bg-hover: rgba(255, 255, 255, 0.55);
            
            /* 气泡预览和演示 */
            --bubble-demo-bg: rgba(255, 255, 255, 0.8);
            --setting-card-bg: rgba(248, 249, 250, 0.8);
            --custom-input-bg: rgba(248, 249, 250, 0.8);
            --schedule-item-bg: rgba(255, 255, 255, 0.8);
            
                    /* 纸张气泡特殊效果 */
        --paper-inset-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3);
        --paper-text-shadow: 0 0.5px 1px rgba(255, 255, 255, 0.3);
        --paper-border: 1px solid rgba(0, 0, 0, 0.08);
        
        /* 主题化按钮背景 */
        --theme-button-bg-rgba: rgba(74, 132, 193, 0.9);
        --theme-button-secondary-bg-rgba: rgba(255, 255, 255, 0.8);
        
        /* 输入框和滑块 */
        --input-white-bg: rgba(255, 255, 255, 0.9);
        --slider-thumb-border: 2px solid rgba(255, 255, 255, 0.8);
        
        /* 预览气泡 */
        --preview-glass-ai: rgba(240, 240, 240, 0.7);
        --preview-glass-user: rgba(0, 122, 255, 0.8);
        --preview-glass-border: 1px solid rgba(255, 255, 255, 0.3);

        /* 通用工具类 - 替换硬编码样式 */
        .app-icon-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 18px;
        }
        
        .add-btn {
            position: absolute;
            right: var(--spacing-lg);
            top: 39.5px;
            width: var(--size-md);
            height: var(--size-md);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--font-size-xxl);
            color: var(--color-gray-dark);
        }
        
        .hide {
            display: none;
        }
        
        .flex-row {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .flex-row-center {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }
        
        .persona-add-btn {
            width: var(--size-md);
            height: var(--size-md);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--font-size-xxl);
            color: var(--color-blue);
            background: var(--bg-blue-10);
            border-radius: var(--radius-round);
            margin-right: var(--spacing-xs);
        }
        
        .worldbook-add-btn {
            position: absolute;
            right: var(--spacing-lg);
            top: 39px;
            width: var(--size-md);
            height: var(--size-md);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--font-size-xxl);
            color: var(--color-gray-dark);
        }
        
        .save-btn-absolute {
            position: absolute;
            right: var(--spacing-lg);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: none;
            border: none;
            font-size: var(--font-size-lg);
            color: var(--color-gray-dark);
            cursor: pointer;
        }
        
        .textarea-large {
            height: 400px;
        }
        
        .padding-none {
            padding: 0;
        }
        
        .padding-none-flex {
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .overflow-auto {
            overflow-y: auto;
        }
        
        .poke-settings-visible {
            display: flex;
        }
        
        .chat-menu-btn {
            position: absolute;
            right: var(--spacing-lg);
            top: 1.5px;
            width: var(--size-md);
            height: var(--size-md);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--color-gray-dark);
        }
        
        .settings-icon-custom {
            background-color: var(--color-pink);
        }
        
        .theme-preview-simple {
            background: linear-gradient(135deg, #f7f7f7, #e8e8e8);
        }
        
        .theme-preview-cute {
            background: linear-gradient(135deg, #ffe6f0, #ffb6c1);
        }
        
        .theme-preview-nature {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        }
        
        .theme-preview-tech {
            background: linear-gradient(135deg, #b3e5fc, #81d4fa);
        }
        
        .theme-preview-dream {
            background: linear-gradient(135deg, #e1bee7, #ce93d8);
        }
        
        .check-icon {
            color: var(--color-blue);
        }
        
        .settings-item-margin {
            margin-top: var(--spacing-lg);
        }
        
        .small-desc {
            color: var(--color-gray);
            font-size: var(--font-size-sm);
            display: block;
            margin-top: var(--spacing-xs);
        }
        
        .api-form-flex {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }
        
        .api-select-hidden {
            display: none;
            flex: 1;
        }
        
        .fetch-btn {
            display: none;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-blue);
            color: var(--color-white);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
            white-space: nowrap;
        }
        
        .test-connection-btn {
            background-color: var(--color-ios-green);
            margin-top: var(--spacing-sm);
        }
        
        .color-option {
            width: var(--size-md);
            height: var(--size-md);
            border-radius: var(--radius-round);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--transition-fast) ease;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border-color: var(--color-white);
            box-shadow: 0 0 0 2px var(--color-blue);
        }
        
        .color-red { background-color: var(--color-ios-red); }
        .color-orange { background-color: var(--color-orange); }
        .color-yellow { background-color: var(--color-yellow); }
        .color-green { background-color: var(--color-ios-green); }
        .color-light-blue { background-color: var(--color-light-blue); }
        .color-blue { background-color: var(--color-blue); }
        .color-purple { background-color: var(--color-ios-purple); }
        .color-pink { background-color: var(--color-pink); }
        .color-red-alt { background-color: var(--color-ios-red); }
        
        .wallpaper-option {
            width: var(--size-xxl);
            height: var(--size-xxl);
            border-radius: var(--radius-lg);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--transition-fast) ease;
        }
        
        .wallpaper-option:hover {
            transform: scale(1.05);
        }
        
        .wallpaper-option.selected {
            border-color: var(--color-blue);
        }
        
        .wallpaper-gradient1 {
            background-image: linear-gradient(135deg, #6e8efb, #a777e3);
        }
        
        .wallpaper-gradient2 {
            background-image: linear-gradient(135deg, #FF9A9E, #FAD0C4);
        }
        
        .wallpaper-gradient3 {
            background-image: linear-gradient(135deg, #A1C4FD, #C2E9FB);
        }
        
        .wallpaper-gradient4 {
            background-image: linear-gradient(135deg, #FFECD2, #FCB69F);
        }
        
        .upload-custom-item {
            margin-top: var(--spacing-lg);
        }
        
        .file-input-hidden {
            display: none;
        }
        
        .icon-user-blue {
            color: var(--color-blue);
        }
        
        .icon-users-green {
            color: var(--color-ios-green);
        }
        
        .memory-checkbox {
            margin-right: var(--spacing-sm);
        }
        
        .memory-desc {
            font-size: var(--font-size-md);
            color: var(--color-gray);
            margin-top: var(--spacing-xs);
        }
        
        .form-actions-flex {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .form-submit-flex {
            flex: 1;
        }
        
        .form-delete-red {
            background: var(--color-ios-red);
            color: var(--color-white);
            padding: var(--spacing-lg);
            border: none;
            border-radius: var(--theme-button-radius, var(--radius-xl));
            font-size: var(--font-size-xl);
            font-weight: 600;
            cursor: pointer;
            display: none;
        }
        
        .danger-color {
            color: var(--color-ios-red);
        }
        
        .danger-section-icon {
            color: var(--color-red-alt);
        }
        
        .danger-section-title {
            color: var(--color-red-alt);
        }
        
        /* 更多工具类 - 继续替换硬编码 */
        .checkbox-with-margin {
            margin-right: var(--spacing-sm);
        }
        
        .margin-top-20 {
            margin-top: var(--spacing-lg);
        }
        
        .margin-top-15 {
            margin-top: var(--spacing-lg);
        }
        
        .margin-top-10 {
            margin-top: var(--spacing-sm);
        }
        
        .margin-top-8 {
            margin-top: var(--spacing-sm);
        }
        
        .margin-top-5 {
            margin-top: var(--spacing-xs);
        }
        
        .flex-space-between {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-xs);
        }
        
        .flex-gap-15 {
            display: flex;
            gap: var(--spacing-lg);
        }
        
        .flex-1 {
            flex: 1;
        }
        
        .flex-gap-15-mb-15 {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        
        .flex-gap-15-mb-10 {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
        }
        
        .width-100 {
            width: 100%;
        }
        
        .max-height-200-auto {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--color-border-medium);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
        }
        
        .max-height-300-auto {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--color-border-medium);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
        }
        
        .small-text {
            font-size: var(--font-size-md);
            color: var(--color-gray);
        }
        
        .tiny-text {
            font-size: var(--font-size-sm);
            color: var(--color-gray);
        }
        
        .tiny-text-gray {
            font-size: var(--font-size-sm);
            color: var(--color-gray-medium);
        }
        
        .label-small {
            font-size: var(--font-size-md);
            color: var(--color-gray);
        }
        
        .delete-btn-red {
            background: var(--color-ios-red);
            color: var(--color-white);
            border: none;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-xs);
            margin-right: var(--spacing-xs);
        }
        
        .cancel-btn-blue {
            background: var(--color-blue);
            color: var(--color-white);
            border: none;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-xs);
        }
        
        .selection-checkbox {
            width: var(--size-xs);
            height: var(--size-xs);
            border-radius: var(--radius-round);
            border: 2px solid var(--color-blue);
            margin-right: var(--spacing-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .selection-checkbox.selected {
            background-color: var(--color-blue);
        }
        
        .check-icon-white {
            color: var(--color-white);
            font-size: var(--font-size-sm);
        }
        
        .group-member-count {
            font-size: var(--font-size-sm);
            color: var(--color-gray);
        }
        
        .italic-gray {
            color: var(--color-gray);
            font-style: italic;
        }
        
        .text-center-gray {
            text-align: center;
            color: var(--color-gray);
            padding: var(--size-lg);
        }
        
        .worldbook-item {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
        }
        
        .worldbook-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .worldbook-title {
            font-weight: bold;
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-xs);
        }
        
        .avatar-group-green {
            background-color: var(--color-ios-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-white);
            font-weight: bold;
        }
        
        /* JavaScript动态样式类 */
        .multiselect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-lg);
            background-color: var(--color-gray-bg);
            border-bottom: 1px solid var(--color-border);
        }
        
        .contact-item.selected {
            background-color: var(--color-blue-light);
        }
        
        .empty-message {
            text-align: center;
            color: var(--color-gray);
            padding: var(--size-lg) var(--spacing-lg);
        }
        
        .empty-chat-state {
            text-align: center;
            color: var(--color-gray-medium);
            padding: var(--size-xl) var(--spacing-lg);
            font-size: var(--font-size-lg);
        }
        
        .character-info-flex {
            flex: 1;
        }
        

        
        .message-container.no-avatar .message-avatar {
            display: none;
        }
        
        /* 更多JavaScript动态样式类 */
        .empty-worldbook {
            text-align: center;
            color: var(--color-gray);
            padding: var(--size-lg);
        }
        
        .empty-playlist {
            text-align: center;
            color: var(--color-gray);
            padding: var(--spacing-lg);
        }
        
        .empty-personas {
            text-align: center;
            color: var(--color-gray);
            padding: var(--size-lg);
        }
        
        .empty-mount-chats {
            color: var(--color-gray);
            text-align: center;
            padding: var(--spacing-lg);
        }
        
        .song-title {
            font-weight: 500;
        }
        
        .song-artist {
            font-size: var(--font-size-sm);
            color: var(--color-gray);
        }
        
        .song-duration {
            font-size: var(--font-size-sm);
            color: var(--color-gray-medium);
        }
        
        .remove-character-btn {
            background: none;
            border: none;
            color: var(--color-ios-red);
            cursor: pointer;
            margin-left: var(--spacing-sm);
        }
        
        .mount-checkbox {
            margin-right: var(--spacing-sm);
        }
        
        .mount-avatar-small {
            width: var(--size-md);
            height: var(--size-md);
            border-radius: var(--radius-round);
            margin-right: var(--spacing-sm);
        }
        
        .mount-name {
            font-weight: 500;
        }
        
        .mount-type {
            font-size: var(--font-size-sm);
            color: var(--color-gray);
        }
        
        .worldbook-checkbox {
            margin-right: var(--spacing-md);
            margin-top: 2px;
        }
        
        .worldbook-content-flex {
            flex: 1;
        }
        
        .worldbook-title-text {
            font-weight: 600;
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-xs);
            color: var(--color-gray-dark);
        }
        
        .worldbook-desc-text {
            font-size: var(--font-size-md);
            color: var(--color-gray);
            line-height: var(--line-height-normal);
            margin-bottom: var(--spacing-sm);
        }
        
        .worldbook-date-text {
            font-size: var(--font-size-xs);
            color: var(--color-gray-medium);
        }
        
        .identity-avatar {
            width: var(--size-lg);
            height: var(--size-lg);
            border-radius: var(--radius-round);
            background: linear-gradient(135deg, var(--theme-avatar-bg-1), var(--theme-avatar-bg-2));
            margin-right: var(--spacing-md);
        }
        
        .identity-content-flex {
            flex: 1;
        }
        
        .identity-name {
            font-weight: 600;
            font-size: var(--font-size-lg);
            margin-bottom: 3px;
        }
        
        .identity-desc {
            font-size: var(--font-size-md);
            color: var(--color-gray);
            line-height: var(--line-height-tight);
        }
        
        .identity-check-icon {
            color: var(--theme-button-bg, var(--color-blue));
            margin-left: var(--spacing-sm);
        }
        
        .delete-worldbook-btn {
            background: none;
            border: none;
            color: var(--color-ios-red);
            cursor: pointer;
            font-size: var(--font-size-lg);
            padding: var(--spacing-xs);
        }
        
        .mount-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--color-gray-light);
            cursor: pointer;
        }
        
        .mount-avatar-group {
            width: var(--size-md);
            height: var(--size-md);
            border-radius: var(--radius-round);
            background-color: var(--color-ios-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-white);
            font-weight: bold;
            margin-right: var(--spacing-sm);
        }
        
        .empty-emoji-grid {
            text-align: center;
            color: var(--color-gray);
            padding: var(--spacing-lg);
            grid-column: 1 / -1;
        }
        
        .worldbook-mount-item {
            align-items: flex-start;
            padding: var(--spacing-md);
            transition: background-color var(--transition-fast);
        }
        
        .worldbook-mount-item:hover {
            background-color: var(--color-gray-bg-light);
        }
        
        .identity-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            margin-bottom: var(--spacing-sm);
            transition: all var(--transition-fast) ease;
            background-color: var(--color-gray-bg-light);
        }
        
        .identity-item.selected {
            border-color: var(--theme-button-bg, var(--color-blue));
            background-color: var(--bg-default-10);
        }
        }

        /* 可爱风格主题 */
        body[data-theme="cute"] {
            --theme-font-family: 'Comfortaa', 'Comic Neue', 'Varela Round', 'Quicksand', sans-serif;
            --theme-font-weight: 500;
            --theme-line-height: 1.6;
            --theme-title-font-size: 20px;
            --theme-title-font-weight: 700;
            --theme-setting-title-font: 'Fredoka One', 'Comfortaa', sans-serif;
            
            --theme-button-bg: rgba(255, 182, 193, 0.9);
            --theme-button-bg-hover: rgba(255, 182, 193, 1);
            --theme-button-color: white;
            --theme-button-border: none;
            --theme-button-radius: 25px;
            --theme-button-shadow: 0 3px 10px rgba(255, 105, 180, 0.4);
            --theme-button-font-size: 16px;
            --theme-button-font-weight: 600;
            --theme-button-letter-spacing: 0.5px;
            
            --theme-button-secondary-bg: rgba(255, 240, 245, 0.8);
            --theme-button-secondary-bg-hover: rgba(255, 240, 245, 0.95);
            --theme-button-secondary-color: #d44d5c;
            --theme-button-secondary-border: rgba(255, 182, 193, 0.3);
            
            --theme-header-bg: rgba(255, 230, 240, 0.8);
            --theme-header-backdrop: blur(10px);
            
            --theme-form-bg: rgba(255, 249, 252, 0.8);
            --theme-input-border: rgba(255, 204, 213, 0.4);
            --theme-input-radius: 20px;
            --theme-input-focus: rgba(255, 182, 193, 0.6);
            --theme-input-focus-shadow: rgba(255, 182, 193, 0.1);
            
            --theme-avatar-bg-1: #ffe6f2;
            --theme-avatar-bg-2: #ffd6e8;
            --theme-avatar-text: #d44d5c;
            --theme-avatar-border: rgba(255, 255, 255, 0.9);
            
            --theme-text-primary: #d44d5c;
            --theme-text-shadow: 0 1px 3px rgba(255, 182, 193, 0.2);
            
            /* 可爱主题的背景色 */
            --body-bg: linear-gradient(135deg, #ffeef7, #ffe4f0);
            
            /* 可爱主题的气泡样式重写 */
            --bubble-glass-bg-ai: rgba(255, 240, 245, 0.8);
            --bubble-glass-bg-user: rgba(255, 182, 193, 0.85);
            --bubble-glass-border-ai: rgba(255, 204, 213, 0.4);
            --bubble-glass-border-user: rgba(255, 182, 193, 0.3);
            --bubble-neon-bg-ai: rgba(255, 240, 245, 0.95);
            --bubble-neon-bg-user: rgba(255, 182, 193, 0.9);
            
            /* 可爱主题的悬浮按钮 */
            --floating-btn-bg: rgba(255, 182, 193, 0.35);
            --floating-btn-bg-hover: rgba(255, 182, 193, 0.55);
            
            /* 可爱主题的按钮背景重写 */
            --theme-button-bg-rgba: rgba(255, 182, 193, 0.9);
            --theme-button-secondary-bg-rgba: rgba(255, 240, 245, 0.8);
            
            /* 可爱主题的预览气泡 */
            --preview-glass-ai: rgba(255, 240, 245, 0.8);
            --preview-glass-user: rgba(255, 182, 193, 0.85);
            --preview-glass-border: 1px solid rgba(255, 204, 213, 0.4);
        }
        
        /* 可爱主题的特殊效果 */
        body[data-theme="cute"] .settings-icon {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.3);
        }
        
        body[data-theme="cute"] .form-submit:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(255, 182, 193, 0.4);
        }
        

        
        body[data-theme="cute"] .control-btn {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            box-shadow: 0 3px 10px rgba(255, 182, 193, 0.3);
        }
        
        body[data-theme="cute"] .control-btn:hover {
            transform: scale(1.1) rotate(5deg);
        }
        
        body[data-theme="cute"] .app-title.chat-mode {
            background: linear-gradient(90deg, #ff6b9d, #ffa8cc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 绿色自然主题 */
        body[data-theme="nature"] {
            --theme-font-family: 'Nunito', 'Montserrat', 'Open Sans', sans-serif;
            --theme-font-weight: 400;
            --theme-line-height: 1.6;
            --theme-title-font-size: var(--font-size-xl);
            --theme-title-font-weight: 600;
            --theme-setting-title-font: 'Nunito', 'Montserrat', sans-serif;
            
            --theme-button-bg: rgba(76, 217, 100, 0.85);
            --theme-button-bg-hover: rgba(76, 217, 100, 1);
            --theme-button-color: var(--color-white);
            --theme-button-border: none;
            --theme-button-radius: var(--radius-xxxl);
            --theme-button-shadow: 0 4px 15px rgba(76, 217, 100, 0.3);
            --theme-button-font-size: var(--font-size-lg);
            --theme-button-font-weight: 500;
            --theme-button-letter-spacing: 0.3px;
            
            --theme-button-secondary-bg: rgba(220, 245, 220, 0.8);
            --theme-button-secondary-bg-hover: rgba(220, 245, 220, 0.95);
            --theme-button-secondary-color: #2d7d32;
            --theme-button-secondary-border: rgba(76, 217, 100, 0.3);
            
            --theme-header-bg: rgba(200, 230, 201, 0.8);
            --theme-header-backdrop: blur(10px);
            
            --theme-form-bg: rgba(248, 255, 248, 0.8);
            --theme-input-border: rgba(76, 217, 100, 0.2);
            --theme-input-radius: 15px;
            --theme-input-focus: rgba(76, 217, 100, 0.5);
            --theme-input-focus-shadow: rgba(76, 217, 100, 0.1);
            
            --theme-avatar-bg-1: #e8f5e8;
            --theme-avatar-bg-2: #d4ead4;
            --theme-avatar-text: #2d7d32;
            --theme-avatar-border: rgba(255, 255, 255, 0.9);
            
            --theme-text-primary: #2d7d32;
            --theme-text-shadow: 0 1px 2px rgba(76, 217, 100, 0.15);
            
            /* 自然主题的背景色 */
            --body-bg: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            
            /* 自然主题的气泡样式重写 */
            --bubble-glass-bg-ai: rgba(220, 245, 220, 0.8);
            --bubble-glass-bg-user: rgba(76, 217, 100, 0.8);
            --bubble-glass-border-ai: rgba(76, 217, 100, 0.2);
            --bubble-glass-border-user: rgba(76, 217, 100, 0.3);
            --bubble-neon-bg-ai: rgba(248, 255, 248, 0.9);
            --bubble-neon-bg-user: rgba(76, 217, 100, 0.9);
            
            /* 自然主题的悬浮按钮 */
            --floating-btn-bg: rgba(76, 217, 100, 0.35);
            --floating-btn-bg-hover: rgba(76, 217, 100, 0.55);
            
            /* 自然主题的按钮背景重写 */
            --theme-button-bg-rgba: rgba(76, 217, 100, 0.85);
            --theme-button-secondary-bg-rgba: rgba(220, 245, 220, 0.8);
            
            /* 自然主题的预览气泡 */
            --preview-glass-ai: rgba(220, 245, 220, 0.8);
            --preview-glass-user: rgba(76, 217, 100, 0.8);
            --preview-glass-border: 1px solid rgba(76, 217, 100, 0.3);
        }
        
        /* 自然主题的特殊效果 */
        body[data-theme="nature"] .settings-icon {
            border-radius: 10px;
            background-image: linear-gradient(135deg, #4cd964, #5ac969);
        }
        
        body[data-theme="nature"] .form-submit {
            background: linear-gradient(135deg, #4cd964, #5ac969);
        }
        
        body[data-theme="nature"] .form-submit:hover {
            background: linear-gradient(135deg, #5ac969, #4cd964);
        }
        
        body[data-theme="nature"] .control-btn {
            background: linear-gradient(135deg, #81c784, #66bb6a);
        }
        
        body[data-theme="nature"] .app-title.chat-mode {
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        


        /* 蓝色科技主题 */
        body[data-theme="tech"] {
            --theme-font-family: 'Inter', 'Roboto', 'Helvetica Neue', sans-serif;
            --theme-font-weight: 400;
            --theme-line-height: 1.5;
            --theme-title-font-size: var(--font-size-xl);
            --theme-title-font-weight: 600;
            --theme-setting-title-font: 'Inter', 'Roboto', sans-serif;
            
            --theme-button-bg: rgba(0, 123, 255, 0.85);
            --theme-button-bg-hover: rgba(0, 123, 255, 1);
            --theme-button-color: var(--color-white);
            --theme-button-border: none;
            --theme-button-radius: var(--radius-md);
            --theme-button-shadow: 0 2px 8px rgba(0, 123, 255, 0.25);
            --theme-button-font-size: var(--font-size-lg);
            --theme-button-font-weight: 500;
            --theme-button-letter-spacing: 0.2px;
            
            --theme-button-secondary-bg: rgba(230, 245, 255, 0.8);
            --theme-button-secondary-bg-hover: rgba(230, 245, 255, 0.95);
            --theme-button-secondary-color: #1976d2;
            --theme-button-secondary-border: rgba(0, 123, 255, 0.3);
            
            --theme-header-bg: rgba(179, 229, 252, 0.8);
            --theme-header-backdrop: blur(10px);
            
            --theme-form-bg: rgba(248, 252, 255, 0.8);
            --theme-input-border: rgba(0, 123, 255, 0.2);
            --theme-input-radius: 12px;
            --theme-input-focus: rgba(0, 123, 255, 0.5);
            --theme-input-focus-shadow: rgba(0, 123, 255, 0.1);
            
            --theme-avatar-bg-1: #e3f2fd;
            --theme-avatar-bg-2: #bbdefb;
            --theme-avatar-text: #1976d2;
            --theme-avatar-border: rgba(255, 255, 255, 0.9);
            
            --theme-text-primary: #1976d2;
            --theme-text-shadow: none;
            
            /* 科技主题的背景色 */
            --body-bg: linear-gradient(135deg, #e3f2fd, #bbdefb);
            
            /* 科技主题的气泡样式重写 */
            --bubble-glass-bg-ai: rgba(230, 245, 255, 0.8);
            --bubble-glass-bg-user: rgba(0, 123, 255, 0.8);
            --bubble-glass-border-ai: rgba(0, 123, 255, 0.2);
            --bubble-glass-border-user: rgba(0, 123, 255, 0.3);
            --bubble-neon-bg-ai: rgba(248, 252, 255, 0.9);
            --bubble-neon-bg-user: rgba(0, 123, 255, 0.9);
            
            /* 科技主题的悬浮按钮 */
            --floating-btn-bg: rgba(0, 123, 255, 0.35);
            --floating-btn-bg-hover: rgba(0, 123, 255, 0.55);
            
            /* 科技主题的按钮背景重写 */
            --theme-button-bg-rgba: rgba(0, 123, 255, 0.85);
            --theme-button-secondary-bg-rgba: rgba(230, 245, 255, 0.8);
            
            /* 科技主题的预览气泡 */
            --preview-glass-ai: rgba(230, 245, 255, 0.8);
            --preview-glass-user: rgba(0, 123, 255, 0.8);
            --preview-glass-border: 1px solid rgba(0, 123, 255, 0.3);
        }
        
        /* 科技主题的特殊效果 */
        body[data-theme="tech"] .settings-icon {
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body[data-theme="tech"] .form-submit {
            position: relative;
            overflow: hidden;
        }
        
        body[data-theme="tech"] .form-submit::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        body[data-theme="tech"] .form-submit:active::after {
            width: 300px;
            height: 300px;
        }
        
        body[data-theme="tech"] .control-btn {
            border: 1px solid rgba(0, 123, 255, 0.2);
            background: rgba(0, 123, 255, 0.9);
        }
        
        body[data-theme="tech"] .app-title.chat-mode {
            background: linear-gradient(90deg, #2196f3, #64b5f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 紫色梦幻主题 */
        body[data-theme="dream"] {
            --theme-font-family: 'Raleway', 'Lato', 'Poppins', sans-serif;
            --theme-font-weight: 400;
            --theme-line-height: 1.6;
            --theme-title-font-size: var(--font-size-xl);
            --theme-title-font-weight: 600;
            --theme-setting-title-font: 'Raleway', 'Poppins', sans-serif;
            
            --theme-button-bg: rgba(156, 39, 176, 0.85);
            --theme-button-bg-hover: rgba(156, 39, 176, 1);
            --theme-button-color: var(--color-white);
            --theme-button-border: none;
            --theme-button-radius: var(--radius-huge);
            --theme-button-shadow: 0 4px 20px rgba(156, 39, 176, 0.35);
            --theme-button-font-size: var(--font-size-lg);
            --theme-button-font-weight: 500;
            --theme-button-letter-spacing: 0.4px;
            
            --theme-button-secondary-bg: rgba(240, 230, 245, 0.8);
            --theme-button-secondary-bg-hover: rgba(240, 230, 245, 0.95);
            --theme-button-secondary-color: #7b1fa2;
            --theme-button-secondary-border: rgba(156, 39, 176, 0.3);
            
            --theme-header-bg: rgba(225, 190, 231, 0.8);
            --theme-header-backdrop: blur(10px);
            
            --theme-form-bg: rgba(252, 248, 255, 0.8);
            --theme-input-border: rgba(156, 39, 176, 0.2);
            --theme-input-radius: 18px;
            --theme-input-focus: rgba(156, 39, 176, 0.5);
            --theme-input-focus-shadow: rgba(156, 39, 176, 0.1);
            
            --theme-avatar-bg-1: #f3e5f5;
            --theme-avatar-bg-2: #e1bee7;
            --theme-avatar-text: #7b1fa2;
            --theme-avatar-border: rgba(255, 255, 255, 0.9);
            
            --theme-text-primary: #7b1fa2;
            --theme-text-shadow: 0 1px 3px rgba(156, 39, 176, 0.15);
            
            /* 梦幻主题的背景色 */
            --body-bg: linear-gradient(135deg, #f3e5f5, #e1bee7);
            
            /* 梦幻主题的气泡样式重写 */
            --bubble-glass-bg-ai: rgba(240, 230, 245, 0.8);
            --bubble-glass-bg-user: rgba(156, 39, 176, 0.8);
            --bubble-glass-border-ai: rgba(156, 39, 176, 0.2);
            --bubble-glass-border-user: rgba(156, 39, 176, 0.3);
            --bubble-neon-bg-ai: rgba(252, 248, 255, 0.9);
            --bubble-neon-bg-user: rgba(156, 39, 176, 0.9);
            
            /* 梦幻主题的悬浮按钮 */
            --floating-btn-bg: rgba(156, 39, 176, 0.35);
            --floating-btn-bg-hover: rgba(156, 39, 176, 0.55);
            
            /* 梦幻主题的按钮背景重写 */
            --theme-button-bg-rgba: rgba(156, 39, 176, 0.85);
            --theme-button-secondary-bg-rgba: rgba(240, 230, 245, 0.8);
            
            /* 梦幻主题的预览气泡 */
            --preview-glass-ai: rgba(240, 230, 245, 0.8);
            --preview-glass-user: rgba(156, 39, 176, 0.8);
            --preview-glass-border: 1px solid rgba(156, 39, 176, 0.3);
        }
        
        /* 梦幻主题的特殊效果 */
        body[data-theme="dream"] .settings-icon {
            border-radius: 15px;
            background-image: linear-gradient(135deg, #ce93d8, #ba68c8);
            box-shadow: 0 3px 15px rgba(156, 39, 176, 0.3);
        }
        
        body[data-theme="dream"] .form-submit {
            background: linear-gradient(135deg, #9c27b0, #ba68c8);
            box-shadow: 0 4px 20px rgba(156, 39, 176, 0.35);
        }
        
        body[data-theme="dream"] .form-submit:hover {
            background: linear-gradient(135deg, #ba68c8, #9c27b0);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(156, 39, 176, 0.4);
        }
        
        body[data-theme="dream"] .control-btn {
            background: linear-gradient(135deg, #ba68c8, #ab47bc);
            box-shadow: 0 3px 15px rgba(156, 39, 176, 0.3);
        }
        
        body[data-theme="dream"] .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
        }
        
        body[data-theme="dream"] .app-title.chat-mode {
            background: linear-gradient(90deg, #9c27b0, #ba68c8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        html { 
            height: 100%; 
            overflow: hidden; 
        }
        
        body { 
            height: 100vh; 
            overflow: hidden; 
            margin: 0; 
            padding: 20px; 
            font-family: var(--theme-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif);
            font-weight: normal; 
            background: var(--body-bg, #dcdcdc); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            box-sizing: border-box; 
            transition: all 0.3s ease;
        }
        
        #phone-frame { 
            padding: 12px; 
            background-color: #fff; 
            border-radius: 50px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1); 
            position: relative; 
            display: none; /* 默认隐藏，由外观设置控制 */
        }
        

        
        #phone-screen { 
            width: 350px; 
            height: 740px; 
            background-color: var(--color-black); 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            border-radius: 25px; 
            box-shadow: var(--shadow-phone); 
        }
        
        .wallpaper {
            width: 100%;
            height: 100%;
            background: var(--color-wallpaper);
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #status-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 12px 20px 6px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 10;
            font-size: 14px;
            box-sizing: border-box;
            pointer-events: none;
            background: transparent;
        }
        
        #status-bar-time {
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        #status-bar-time::after {
            content: "🐾";
            margin-left: 4px;
            font-size: 12px;
        }
        
        .battery-container {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }
        
        .battery-icon {
            width: 20px;
            height: 10px;
            border: 1px solid white;
            border-radius: 4px;
            position: relative;
            padding: 1px;
        }
        
        .battery-icon::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 2px;
            width: 1.5px;
            height: 4px;
            background-color: white;
            border-radius: 0 1px 1px 0;
        }
        
        .battery-level {
            height: 100%;
            background-color: white;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .battery-container.charging .battery-level {
            background-color: var(--color-green);
            animation: charge-breath 2s infinite;
        }
        
        .battery-container { display: flex; align-items: center; gap: 4px; font-size: 14px; }
        
        .battery-container.charging .battery-text {
            color: var(--color-green);
        }
        
        @keyframes charge-breath {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        #clock-container {
            text-align: center;
            color: white;
            text-shadow: var(--text-shadow-md);
            margin-bottom: 40px;
            flex-shrink: 0;
            margin-top: 90px;
            padding-top: 20px;
        }
        
        #main-time {
            font-size: 80px;
            font-weight: 200;
        }
        
        #main-date {
            font-size: 18px;
            font-weight: 500;
        }
        

        
        #app-grid {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            padding: 20px;
            margin-top: 40px;
        }
        
        .app-row {
            display: flex;
            justify-content: center;
            gap: 25px;
            width: 100%;
        }
        
        .app {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: white;
            text-shadow: var(--text-shadow-sm);
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
        }
        
        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            background-color: var(--color-white);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            margin-bottom: 8px;
            box-shadow: var(--shadow-lg);
            transition: transform 0.2s ease;
            overflow: hidden;
        }
        
        .app:active .app-icon {
            transform: scale(0.9);
        }
        
        .app-icon i {
            font-size: 30px;
            color: var(--color-gray-dark);
        }
        
        .app .label {
            color: white;
        }
        
        /* 应用页面样式 */
        .app-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: none;
            flex-direction: column;
            color: black;
        }
        
        /* 应用界面状态栏 */
        .app-status-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 12px 20px 6px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: black;
            z-index: 1000;
            font-size: 14px;
            box-sizing: border-box;
            pointer-events: none;
            background: transparent;
            border-bottom: none;
        }
        
        .app-status-time {
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .app-status-time::after {
            content: "🐾";
            margin-left: 4px;
            font-size: 12px;
        }
        
        .app-battery-container {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }
        
        .app-battery-icon {
            width: 20px;
            height: 10px;
            border: 1px solid black;
            border-radius: 4px;
            position: relative;
            padding: 1px;
        }
        
        .app-battery-icon::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 2px;
            width: 1.5px;
            height: 4px;
            background-color: black;
            border-radius: 0 1px 1px 0;
        }
        
        .app-battery-level {
            height: 100%;
            background-color: black;
            border-radius: 2px;
            transition: width 0.5s ease;
            width: 100%;
        }
        
        .app-battery-container.charging .app-battery-level {
            background-color: var(--color-green);
            animation: charge-breath 2s infinite;
        }
        
        .app-battery-container { display: flex; align-items: center; gap: 4px; font-size: 14px; }
        
        .app-battery-container.charging .battery-text {
            color: var(--color-green);
        }
        
        .app-header { 
            position: relative; 
            z-index: 15; 
            flex-shrink: 0; 
            padding: 12px 32px; 
            padding-top: 45px; 
            height: 84px;
            box-sizing: border-box;
            background-color: var(--theme-header-bg); 
            backdrop-filter: var(--theme-header-backdrop); 
            -webkit-backdrop-filter: var(--theme-header-backdrop); 
            border-bottom: 1px solid var(--color-border); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 18px; 
            font-weight: 600; 
            transition: var(--transition-normal);
            overflow: hidden; /* 防止内容溢出 */
        }

        .header { 
    position: relative; 
    z-index: 15; 
    flex-shrink: 0; 
    padding: 12px 32px; 
    padding-top: 45px; 
    height: 84px;
    box-sizing: border-box;
    background-color: var(--theme-header-bg); 
    backdrop-filter: var(--theme-header-backdrop); 
    -webkit-backdrop-filter: var(--theme-header-backdrop); 
    border-bottom: 1px solid var(--color-border); 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    font-size: 18px; 
    font-weight: 600; 
    transition: var(--transition-normal);
    overflow: hidden; /* 防止内容溢出 */
}
        

        
        .app-title {
            font-weight: var(--theme-title-font-weight, bold);
            font-size: var(--theme-title-font-size, 18px);
            font-family: var(--theme-setting-title-font, var(--theme-font-family));
            text-align: center;
            flex: 1;
            color: var(--color-black);
            text-shadow: none;
            letter-spacing: var(--theme-title-letter-spacing, 0);
        }

        .header .header-actions { display: flex; align-items: center; gap: 15px; position: absolute; right: 20px; top: 70%; transform: translateY(-50%); }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: #000000; display: flex; align-items: center; justify-content: center; background: none; border: none; padding: 0; }
        .header .back-btn { position: absolute; left: 20px; }
        .header .header-title { text-align: center; flex: 1; color: #000000; }
        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: #000000; font-weight: 600; cursor: pointer; position: absolute; right: 20px; }
        
        .back-button {
            position: absolute;
            left: 20px;
            padding: 0;
            background: none;
            border: none;
            font-size: 24px;
            color: #000000;
            cursor: pointer;
            width: 30px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        

        
        .app-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        /* 设置应用样式 */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .settings-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
            padding-left: 15px;
        }
        
        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-label {
            font-weight: var(--theme-button-font-weight, 500);
            font-size: 16px;
            color: var(--theme-text-primary, #333);
            font-family: var(--theme-font-family);
            margin-bottom: 2px;
        }
        
        .setting-desc {
            font-size: 13px;
            color: #666;
            font-family: var(--theme-font-family);
        }
        
        .settings-icon {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background-color: var(--color-blue);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            flex-shrink: 0;
        }
        
        .settings-icon.wifi { background-color: var(--color-blue); }
        .settings-icon.display { background-color: var(--color-blue); }
        .settings-icon.wallpaper { 
            background-color: var(--color-ios-green); 
            width: 30px !important;
            height: 30px !important;
            border-radius: 6px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        .settings-icon.datetime { background-color: var(--color-ios-purple); }
        .settings-icon.notification { background-color: var(--color-ios-red); }
        .settings-icon.about { background-color: var(--color-ios-gray); }
        
        /* 确保壁纸文字正常显示 */
        .settings-item-left div:not(.settings-icon) {
            white-space: nowrap;
        }
        
        /* 屏幕尺寸选择样式 */
        .size-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .size-option:hover {
            background-color: rgba(0, 0, 0, 0.02);
            padding-left: 15px;
        }
        
        .size-option-left {
            flex: 1;
        }
        
        .size-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 2px;
        }
        
        .size-desc {
            font-size: 13px;
            color: #666;
        }
        
        .size-preview {
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 70px;
        }
        
        .size-preview-rect {
            background-color: #333;
            border-radius: 3px;
            border: 1px solid #666;
        }
        
        .check-icon {
            color: var(--color-ios-green);
            font-size: 18px;
            position: absolute;
            right: 15px;
        }
        
        .settings-toggle {
            position: relative;
            width: 50px;
            height: 30px;
        }
        
        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .settings-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-border-gray);
            transition: .4s;
            border-radius: 34px;
        }
        
        .settings-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .settings-slider {
            background-color: var(--color-ios-green);
        }
        
        input:checked + .settings-slider:before {
            transform: translateX(20px);
        }
        
        /* API设置界面 */
        .api-settings {
            padding: 15px;
        }
        
        .api-form-group {
            margin-bottom: 15px;
        }
        
        .api-form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .api-form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border-medium);
            border-radius: 5px;
        }
        
        .api-form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border-medium);
            border-radius: 5px;
        }
        
        .api-form-range {
            width: 100%;
        }
        
        .api-form-submit {
            background-color: var(--color-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* 无线局域网设置 */
        .wifi-settings {
            padding: 15px;
        }
        
        .wifi-network {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .wifi-network:last-child {
            border-bottom: none;
        }
        
        .wifi-network-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .wifi-icon {
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .wifi-strength {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .wifi-strength-bar {
            width: 3px;
            height: 10px;
            background-color: var(--color-border-gray);
            border-radius: 1px;
        }
        
        .wifi-strength-bar.active {
            background-color: var(--color-blue);
        }
        
        /* 主题选择器样式 */
        .theme-option {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .theme-option:hover {
            background-color: var(--color-gray-bg);
        }
        
        .theme-option:last-child {
            border-bottom: none;
        }
        
        .theme-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        
        .theme-preview-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background: var(--bg-white-30);
            backdrop-filter: blur(5px);
        }
        
        .theme-preview-content {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            height: 25px;
            background: var(--bg-white-50);
            border-radius: 4px;
        }
        
        .theme-info {
            flex: 1;
        }
        
        .theme-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .theme-description {
            font-size: 13px;
            color: var(--color-gray);
        }
        
        /* 聊天对话框 */
        .chat-dialog {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            padding-bottom: 65px; /* 为输入框留出空间 */
        }
        
        .message-container {
            display: flex;
            margin-bottom: 10px;
            align-items: flex-start;
            position: relative;
        }
        
        .message-container.received {
            justify-content: flex-start;
            padding-left: 5px;
        }
        
        .message-container.sent {
            justify-content: flex-end;
            padding-right: 5px;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--color-border-medium);
            margin-right: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            position: relative;
            font-size: 14px;
        }
        
        /* 用户消息的头像设置左边距而不是右边距 */
        .message-container.sent .message-avatar {
            margin-right: 0;
            margin-left: 6px;
        }
        
        .message-bubble {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 16px;
            position: relative;
            word-wrap: break-word;
            transition: all 0.2s ease;
        }
        
        /* ========== 气泡样式系统 ========== */
        
        /* 默认样式（经典圆角） */
        .bubble-style-default .message-bubble {
            border-radius: 18px;
            box-shadow: var(--shadow-sm);
            border: none;
            transition: all 0.2s ease;
        }
        
        /* 毛玻璃效果 */
        .bubble-style-glass .message-bubble {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-xl), var(--shadow-md);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .bubble-style-glass .received .message-bubble {
            background: var(--bubble-glass-bg-ai);
            border: 1px solid var(--bubble-glass-border-ai);
        }
        
        .bubble-style-glass .sent .message-bubble {
            background: var(--bubble-glass-bg-user);
            border: 1px solid var(--bubble-glass-border-user);
        }
        
        .bubble-style-glass .message-bubble:hover {
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            transform: translateY(-1px);
            box-shadow: var(--shadow-mixed), var(--shadow-xl);
        }
        
        /* 经典阴影样式 */
        .bubble-style-shadow .message-bubble {
            border-radius: 16px;
            box-shadow: 
                var(--shadow-lg),
                var(--shadow-md),
                var(--shadow-sm);
            border: none;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .bubble-style-shadow .message-bubble:hover {
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.18),
                var(--shadow-lg),
                var(--shadow-md);
            transform: translateY(-2px);
        }
        
        /* 带尖角的经典气泡 */
        .bubble-style-tail .message-bubble {
            border-radius: 16px;
            position: relative;
            box-shadow: var(--shadow-md);
        }
        
        /* 角色消息的尖角（左上角） - 动态颜色通过JS设置 */
        .bubble-style-tail .received .message-bubble::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 8px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 8px 10px 0;
            border-color: transparent var(--ai-bubble-color, var(--color-gray-light)) transparent transparent;
        }
        
        /* 用户消息的尖角（右上角） - 动态颜色通过JS设置 */
        .bubble-style-tail .sent .message-bubble::before {
            content: '';
            position: absolute;
            right: -6px;
            top: 8px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 8px 0 0;
            border-color: var(--my-bubble-color, var(--color-blue)) transparent transparent transparent;
        }
        
        /* 渐变气泡样式 */
        .bubble-style-gradient .received .message-bubble {
            background: var(--gradient-gray);
            color: var(--color-gray-dark);
        }
        
        .bubble-style-gradient .sent .message-bubble {
            background: var(--gradient-blue);
            color: white;
        }
        
        .bubble-style-gradient .message-bubble {
            border-radius: 20px;
            box-shadow: var(--shadow-md);
        }
        
        /* 极简线条样式 */
        .bubble-style-minimal .message-bubble {
            border-radius: 12px;
            border: 1.5px solid var(--color-gray-border);
            box-shadow: none;
            background: transparent;
        }
        
        .bubble-style-minimal .received .message-bubble {
            background: var(--color-gray-bg-lighter);
            border-color: var(--color-gray-border);
            color: var(--color-gray-dark);
        }
        
        .bubble-style-minimal .sent .message-bubble {
            background: var(--color-blue-light);
            border-color: var(--color-blue);
            color: var(--color-blue);
        }
        
        /* 霓虹发光样式 */
        .bubble-style-neon .message-bubble {
            border-radius: 15px;
            border: 1px solid;
            animation: neonPulse 2s ease-in-out infinite alternate;
        }
        
        .bubble-style-neon .received .message-bubble {
            background: var(--bubble-neon-bg-ai);
            border-color: var(--color-neon-green);
            box-shadow: var(--shadow-neon-green);
            color: var(--color-gray-dark);
        }
        
        .bubble-style-neon .sent .message-bubble {
            background: var(--bubble-neon-bg-user);
            border-color: var(--color-neon-blue);
            box-shadow: var(--shadow-neon-blue);
            color: white;
        }
        
        @keyframes neonPulse {
            from {
                box-shadow: var(--shadow-neon-green-small);
            }
            to {
                box-shadow: var(--shadow-neon-green-large);
            }
        }
        
        /* 纸张卡片样式 */
        .bubble-style-paper .message-bubble {
            border-radius: 6px;
            box-shadow: 
                var(--shadow-md),
                var(--shadow-xl),
                var(--paper-inset-shadow);
            border: var(--paper-border);
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* 纸张质感背景纹理 */
        .bubble-style-paper .received .message-bubble {
            position: relative;
            color: #2c2c2c;
            text-shadow: var(--paper-text-shadow);
        }
        
        .bubble-style-paper .received .message-bubble::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 118, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(120, 119, 118, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(139, 134, 128, 0.03) 0%, transparent 50%);
            border-radius: 6px;
            pointer-events: none;
            z-index: 0;
        }
        
        .bubble-style-paper .message-bubble > * {
            position: relative;
            z-index: 2;
        }
        
        .bubble-style-paper .sent .message-bubble {
            position: relative;
            color: white;
            border-color: var(--border-white-15);
        }
        
        .bubble-style-paper .sent .message-bubble::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            border-radius: 6px;
            pointer-events: none;
            z-index: 0;
        }
        
        /* 纸张褶皱效果 */
        .bubble-style-paper .message-bubble::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(0, 0, 0, 0.02) 31%, rgba(0, 0, 0, 0.02) 32%, transparent 33%),
                linear-gradient(-45deg, transparent 30%, rgba(0, 0, 0, 0.02) 31%, rgba(0, 0, 0, 0.02) 32%, transparent 33%);
            border-radius: 6px;
            pointer-events: none;
            z-index: -1;
        }
        
        .bubble-style-paper .message-bubble:hover {
            transform: translateY(-1px) rotateX(1deg);
            box-shadow: 
                var(--shadow-lg),
                var(--shadow-xl),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
        
        /* ========== 气泡样式选择器UI ========== */
        
        .bubble-style-section {
            margin-bottom: 25px;
        }
        
        .bubble-style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .bubble-style-option {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            text-align: center;
        }
        
        .bubble-style-option:hover {
            border-color: var(--theme-button-bg, #4a84c1);
            background: var(--bg-default-05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .bubble-style-option.selected {
            border-color: var(--theme-button-bg, #4a84c1);
            background: var(--bg-default-10);
            box-shadow: 0 4px 15px var(--bg-default-shadow);
        }
        
        .style-preview {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .preview-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            max-width: 80px;
            text-align: center;
            word-break: break-word;
        }
        
        .sent-preview {
            background: #007AFF;
            color: white;
            align-self: flex-end;
        }
        
        .received-preview {
            background: #f0f0f0;
            color: #333;
            align-self: flex-start;
        }
        
        /* 预览气泡特殊样式 */
        .bubble-style-glass .preview-bubble {
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border: var(--preview-glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
        }
        
        .bubble-style-glass .sent-preview {
            background: var(--preview-glass-user);
        }
        
        .bubble-style-glass .received-preview {
            background: var(--preview-glass-ai);
        }
        
        .bubble-style-shadow .preview-bubble {
            box-shadow: var(--shadow-form-mixed), var(--shadow-sm);
            border-radius: 14px;
        }
        
        .bubble-style-tail .preview-bubble {
            position: relative;
        }
        
        .bubble-style-tail .sent-preview::before {
            content: '';
            position: absolute;
            right: -5px;
            top: 6px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 6px 0 0;
            border-color: var(--color-blue) transparent transparent transparent;
        }
        
        .bubble-style-tail .received-preview::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 6px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 6px 8px 0;
            border-color: transparent #f0f0f0 transparent transparent;
        }
        
        .bubble-style-gradient .sent-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bubble-style-gradient .received-preview {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        .bubble-style-minimal .preview-bubble {
            border: 1px solid #e0e0e0;
            background: transparent;
        }
        
        .bubble-style-minimal .sent-preview {
            background: #f0f8ff;
            border-color: var(--color-blue);
            color: var(--color-blue);
        }
        
        .bubble-style-minimal .received-preview {
            background: #fafafa;
            color: #333;
        }
        
        .bubble-style-neon .preview-bubble {
            border: 1px solid;
            box-shadow: var(--shadow-neon-green-8px);
        }
        
        .bubble-style-neon .sent-preview {
            border-color: var(--color-neon-blue);
            box-shadow: var(--shadow-neon-blue-8px);
        }
        
        .bubble-style-neon .received-preview {
            border-color: var(--color-neon-green);
            box-shadow: var(--shadow-neon-green-8px);
        }
        
        .bubble-style-paper .preview-bubble {
            box-shadow: 
                var(--shadow-sm),
                var(--shadow-md),
                var(--paper-inset-shadow);
            border: var(--paper-border);
            border-radius: 6px;
            position: relative;
        }
        
        .bubble-style-paper .sent-preview {
            background: var(--color-blue);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .bubble-style-paper .received-preview {
            background: var(--color-gray-light);
            color: var(--color-gray-darker);
            text-shadow: 0 0.5px 1px rgba(255, 255, 255, 0.3);
        }
        
        .style-name {
            font-size: 13px;
            font-weight: 600;
            color: #666;
        }
        
        .bubble-style-option.selected .style-name {
            color: var(--theme-button-bg, #4a84c1);
        }
        
        .received .message-bubble {
            background-color: var(--color-gray-light);
            margin-left: 4px;
        }
        
        .sent .message-bubble {
            background-color: var(--color-blue);
            color: white;
            margin-right: 4px;
        }
        
        .message-image {
            max-width: 150px;  /* 从200px减小到150px */
            max-height: 150px;  /* 从200px减小到150px */
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
            object-fit: cover;  /* 确保图片适应容器 */
        }
        
        .message-image:hover {
            transform: scale(1.05);
        }
        
        .message-emoji {
            max-width: 100px;  /* 从120px减小到100px */
            max-height: 100px;  /* 从120px减小到100px */
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .message-emoji:hover {
            transform: scale(1.1);  /* 从1.05增加到1.1 */
        }
        
        /* 无气泡的表情包样式 */
        .message-container.emoji-only .message-bubble {
            background: none !important;
            box-shadow: none !important;
            border: none !important;
            padding: 0 !important;
        }
        
        /* 图片预览模态框 */
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        
        .image-preview-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }
        
        /* 特殊消息类型样式 */
        .voice-message {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-white-10);
            border-radius: 18px;
            min-width: 100px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        /* 系统消息样式 */
        .system-message {
            text-align: center;
            color: var(--color-gray-medium);
            font-size: var(--font-size-sm);
            padding: 6px 12px;
            margin: 0;
            background: var(--bg-white-10);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            display: inline-block;
            max-width: 60%;
            width: fit-content;
        }

        /* 撤回消息样式 */
        .recalled-message {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 5px 0;
            padding: 8px 12px;
            width: fit-content;
            max-width: 70%;
            background: var(--bg-white-10);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            animation: recallFadeIn 0.5s ease-in-out;
            position: relative; /* 🔥【修复】为选中标记提供定位基准 */
        }
        
        .recalled-message .original-text {
            color: #999;
            font-size: 11px;
            margin-top: 4px;
            padding-top: 4px;
        }
        
        /* 🔥【新增】撤回消息选中状态 - 显示勾选标记 */
        [data-message-id].selected .recalled-message::after {
            content: '✔';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--theme-button-bg, #4a84c1);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* 撤回消息包装器 */
        .message-wrapper.system {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 5px 0;
        }

        /* 撤回动画 */
        @keyframes recallFadeIn {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }
        
        .voice-message:hover {
            background: var(--bg-white-15);
        }
        
        .voice-message i {
            font-size: 16px;
            margin-right: 8px;
            opacity: 0.8;
        }
        
        .voice-content {
            flex: 1;
            font-size: 14px;
        }
        
        .voice-duration {
            font-size: 12px;
            opacity: 0.7;
            margin-left: 8px;
        }
        
        .ai-image-container {
            max-width: 200px;
        }
        
        .ai-image-container .message-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .image-description {
            font-size: 12px;
            opacity: 0.8;
            padding: 5px 0;
            line-height: 1.3;
        }
        
        .transfer-message {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--gradient-pink);
            border-radius: 12px;
            min-width: 150px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .transfer-message:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }
        
        .transfer-message i {
            font-size: 20px;
            margin-right: 12px;
            background: var(--bg-white-30);
            padding: 8px;
            border-radius: 50%;
        }
        
        .transfer-content {
            flex: 1;
        }
        
        .transfer-amount {
            font-size: 18px;
            font-weight: bold;
            color: var(--color-gray-dark);
            margin-bottom: 2px;
        }
        
        .transfer-note {
            font-size: 12px;
            color: var(--color-gray);
        }
        
        /* 正在输入提示 */
        .typing-indicator {
            text-align: center;
            padding: 8px 20px;
            margin: 5px 0;
            color: var(--color-gray);
            font-size: 13px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .typing-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .typing-indicator .dots {
            display: inline-block;
        }
        
        .typing-indicator .dots::before {
            content: '...';
            font-size: 16px;
            color: var(--color-gray);
            animation: typing-dot 1.4s infinite ease-in-out;
        }
        
        .typing-indicator .dots::after {
            content: '';
        }
        
        .typing-indicator .dot3 {
            display: none;
        }
        
        @keyframes typing-dot {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
        }
        
        /* 查看历史消息按钮 */
        .load-more-messages {
            text-align: center;
            padding: 15px 20px;
            margin: 10px 20px;
            background: var(--bg-white-90);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-black-05);
            box-shadow: var(--shadow-md);
        }
        
        .load-more-messages:hover {
            background: var(--bg-white-95);
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }
        
        .load-more-content {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-gray);
            font-size: 14px;
            font-weight: 500;
        }
        
        .load-more-content i {
            margin-right: 8px;
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* 时间戳样式 */
        .timestamp {
            color: var(--color-gray-medium);
            font-size: 11px;
            margin: 2px 0;
            line-height: 1.2;
        }
        
        .timestamp-center {
            text-align: center;
            padding: 8px 0;
            margin: 5px 20px;
        }
        
        .timestamp-bubble {
            position: absolute;
            bottom: 0px;
            right: -30px;
            font-size: 10px;
            color: #999;
            white-space: nowrap;
            z-index: 1;
            pointer-events: none;
        }
        
        .message-container.sent .timestamp-bubble {
            right: auto;
            left: -30px;
        }
        
        .timestamp-avatar {
            position: absolute;
            top: 36px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--color-gray-medium);
            white-space: nowrap;
            width: max-content;
        }

        .timestamp-inside {
            display: inline-block;
            margin-left: 6px;
            font-size: 9px;
            color: var(--text-white-70);
            white-space: nowrap;
            vertical-align: baseline;
            pointer-events: none;
            line-height: 1;
        }

        .message-container.received .timestamp-inside {
            color: var(--text-black-50);
        }

        /* 隐藏头像时的样式调整 */
        .message-container.no-avatar .message-bubble {
            margin-left: 0;
            margin-right: 0;
        }
        
        .message-container.no-avatar.sent .message-bubble {
            margin-left: 0;
        }
        
        .message-container.no-avatar.received .message-bubble {
            margin-right: 0;
        }
        
        .chat-input-area {
            display: flex;
            gap: 6px;
            padding: 8px 8px 10px 8px;
            background-color: var(--bg-header-default);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--color-gray-border);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            align-items: center;
            z-index: 100;
            box-sizing: border-box;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 18px;
            background-color: var(--color-white);
            font-size: 16px;
            resize: none;
            max-height: 100px;
            outline: none;
            box-shadow: var(--text-shadow-light);
            min-width: 0; /* 确保在空间不足时能缩小 */
        }
        
        .send-button {
            height: 40px;
            padding: 0 12px;
            border-radius: 20px;
            background-color: var(--theme-button-bg, rgb(74, 132, 193));
            color: var(--theme-button-color, white);
            display: flex;
            justify-content: center;
            align-items: center;
            border: var(--theme-button-border, none);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--theme-button-shadow, var(--shadow-md));
            transition: all 0.2s ease;
            border-radius: var(--theme-button-radius, 20px);
            flex-shrink: 0;
            min-width: 50px;
        }
        
        .send-button:hover {
            background-color: var(--theme-button-bg-hover, rgba(72, 125, 178, 0.95));
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }
        
        .chat-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--bg-white-80);
            color: var(--color-gray);
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
            font-size: 18px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--border-black-05);
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .chat-action-btn:hover {
            background-color: var(--bg-white-95);
            transform: scale(1.1);
        }
        
        /* 微信聊天界面 */
        #chat-screen {
            display: none;
            flex-direction: column;
        }
        
        .wechat-tabs {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--color-border-light);
            background-color: var(--color-gray-bg-light);
        }
        
        .wechat-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--color-text-light);
            font-size: 12px;
            cursor: pointer;
        }
        
        .wechat-tab.active {
            color: var(--color-wechat-green);
        }
        
        .wechat-tab i {
            font-size: 24px;
            margin-bottom: 3px;
        }
        
        /* 消息列表 */
        .message-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .message-item {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid var(--color-border-light);
            cursor: pointer;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-name {
            font-weight: bold;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .message-preview {
            color: var(--color-text-light);
            font-size: 14px;
        }
        
        .message-time {
            font-size: 12px;
            color: var(--color-text-lighter);
        }
        
        /* 通讯录 */
        .contact-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .contact-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            padding: 5px 15px;
            background-color: var(--color-gray-bg);
            color: var(--color-text-light);
            font-size: 14px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--color-border-light);
            cursor: pointer;
        }
        
        .contact-info {
            flex: 1;
            margin-left: 10px;
            overflow: hidden;
        }
        
        .character-preview {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: calc(100vw - 140px);
        }
        
        /* 朋友圈 */
        .moment-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .moment-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .moment-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .moment-name {
            font-weight: bold;
        }
        
        .moment-content {
            margin-bottom: 10px;
        }
        
        .moment-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .moment-image {
            aspect-ratio: 1;
            background-color: #eee;
        }
        
        .moment-actions {
            display: flex;
            justify-content: space-between;
            color: #888;
            font-size: 14px;
        }
        
        /* 个人页面 */
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0;
            background-color: #f8f8f8;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .profile-id {
            color: #888;
            font-size: 14px;
        }
        
        .profile-menu {
            margin-top: 20px;
        }
        
        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .menu-item-left {
            display: flex;
            align-items: center;
        }
        
        .menu-icon {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            background-color: #07C160;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
        }
        
        /* 人物应用 */
        .character-list {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 60px;
        }
        
        .character-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ddd;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .character-info {
            flex: 1;
        }
        
        .character-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .character-bio {
            color: #888;
            font-size: 14px;
        }
        
        .add-character-header {
            position: absolute;
            right: 15px;
            top: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #007AFF;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* 角色编辑表单 */
        .character-form {
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            margin: 15px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-white-20);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--theme-text-primary, #333);
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));
            border-radius: var(--theme-input-radius, 15px);
            font-size: 16px;
            box-sizing: border-box;
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.8));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all var(--transition-normal, 0.3s ease);
            color: var(--theme-text-primary, #333);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--theme-input-focus, rgba(0, 123, 255, 0.5));
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.95));
            box-shadow: 0 0 0 3px var(--theme-input-focus-shadow, rgba(0, 123, 255, 0.1));
            transform: translateY(-1px);
        }
        
        .form-textarea {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid var(--theme-input-border, rgba(0, 0, 0, 0.08));
            border-radius: var(--theme-input-radius, 15px);
            font-size: 16px;
            box-sizing: border-box;
            min-height: 120px;
            resize: vertical;
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.8));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all var(--transition-normal, 0.3s ease);
            color: var(--theme-text-primary, #333);
            font-family: var(--theme-font-family);
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: var(--theme-input-focus, rgba(0, 123, 255, 0.5));
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.95));
            box-shadow: 0 0 0 3px var(--theme-input-focus-shadow, rgba(0, 123, 255, 0.1));
            transform: translateY(-1px);
        }
        
        .form-submit {
            width: 100%;
            padding: 16px;
            background: var(--theme-button-bg, rgba(0, 123, 255, 0.9));
            color: var(--theme-button-color, white);
            border: var(--theme-button-border, none);
            border-radius: var(--theme-button-radius, 15px);
            font-size: var(--theme-button-font-size, 17px);
            font-weight: var(--theme-button-font-weight, 600);
            font-family: var(--theme-font-family);
            cursor: pointer;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: var(--theme-button-shadow, 0 4px 15px rgba(0, 123, 255, 0.3));
            transition: all var(--transition-normal, 0.3s ease);
            letter-spacing: var(--theme-button-letter-spacing, 0.5px);
            text-shadow: var(--theme-text-shadow, none);
        }
        
        .form-submit:hover {
            transform: translateY(-2px);
            box-shadow: var(--theme-button-shadow, 0 6px 20px rgba(0, 123, 255, 0.4));
            background: var(--theme-button-bg-hover, rgba(0, 123, 255, 1));
        }
        
        .form-submit:active {
            transform: translateY(0);
            box-shadow: var(--theme-button-shadow, 0 2px 10px rgba(0, 123, 255, 0.3));
        }
        
        .avatar-upload {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 18px;
            border: 1px solid var(--theme-input-border, rgba(0, 0, 0, 0.05));
            text-align: center;
        }
        

        /* 第二个重复的完整:root CSS变量定义块已安全删除 */
        /* 该重复块与第一个:root块内容完全相同，包含约900行重复的CSS变量和工具类 */

        
        .identity-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            margin-bottom: var(--spacing-sm);
            transition: all var(--transition-fast) ease;
            background-color: var(--color-gray-bg-light);
        }
        
        .identity-item.selected {
            border-color: var(--theme-button-bg, var(--color-blue));
            background-color: var(--bg-default-10);
        }

        html { 
            height: 100%; 
            overflow: hidden; 
        }
        
        .battery-container {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }
        
        .battery-icon {
            width: 20px;
            height: 10px;
            border: 1px solid white;
            border-radius: 4px;
            position: relative;
            padding: 1px;
        }
        
        .battery-icon::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 2px;
            width: 1.5px;
            height: 4px;
            background-color: white;
            border-radius: 0 1px 1px 0;
        }
        
        .battery-level {
            height: 100%;
            background-color: white;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .battery-container.charging .battery-level {
            background-color: var(--color-green);
            animation: charge-breath 2s infinite;
        }
        
        .battery-container { display: flex; align-items: center; gap: 4px; font-size: 14px; }
        
        .battery-container.charging .battery-text {
            color: var(--color-green);
        }
        
        .avatar-upload {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 18px;
            border: 1px solid var(--theme-input-border, rgba(0, 0, 0, 0.05));
            text-align: center;
        }
        
        .avatar-preview {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--theme-avatar-bg-1, #f0f2f5), var(--theme-avatar-bg-2, #e8ebf0));
            margin: 0 auto 15px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--theme-avatar-border, rgba(255, 255, 255, 0.8));
            transition: all var(--transition-normal, 0.3s ease);
        }
        
        .avatar-preview.has-image {
            background: none !important;
        }
        
        .avatar-preview.has-image .avatar-preview-text {
            display: none !important;
        }
        
        .avatar-preview:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-hover-alt);
        }
        
        .avatar-preview-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: 700;
            color: var(--theme-avatar-text, #8b9dc3);
        }
        
        .upload-button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background: var(--theme-button-secondary-bg, rgba(255, 255, 255, 0.8));
            border: 2px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.1));
            border-radius: var(--theme-button-radius, 12px);
            cursor: pointer;
            color: var(--theme-button-secondary-color, #555);
            font-weight: 500;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all var(--transition-fast, 0.2s ease);
            box-shadow: 0 2px 8px var(--bg-black-05);
            text-align: center;
        }
        
        .upload-button:hover {
            background: var(--theme-button-secondary-bg-hover, rgba(255, 255, 255, 0.95));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .upload-button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-button);
        }
        
        /* 论坛界面 */
        .forum-categories {
            padding: 15px;
        }
        
        .forum-category {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .forum-category:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .category-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
        }
        
        .forum-category:nth-child(1) .category-icon {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            color: white;
        }
        
        .forum-category:nth-child(2) .category-icon {
            background: linear-gradient(135deg, #4ecdc4, #44a3aa);
            color: white;
        }
        
        .forum-category:nth-child(3) .category-icon {
            background: linear-gradient(135deg, #f06292, #ec407a);
            color: white;
        }
        
        .category-info {
            flex: 1;
        }
        
        .category-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .category-desc {
            font-size: 13px;
            color: #666;
        }
        
        .category-count {
            font-size: 20px;
            font-weight: 600;
            color: #999;
        }
        
        /* 游戏界面 */
        .game-list {
            padding: 15px;
        }
        
        .game-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .game-item:hover:not(.coming-soon) {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .game-item.coming-soon {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .game-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .game-info {
            flex: 1;
        }
        
        .game-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .game-desc {
            font-size: 13px;
            color: #666;
        }
        
        .game-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* 社交动态界面 (已移除，改为论坛) */
        .weibo-post {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .weibo-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .weibo-user {
            flex: 1;
        }
        
        .weibo-name {
            font-weight: bold;
        }
        
        .weibo-time {
            color: #888;
            font-size: 12px;
        }
        
        .weibo-content {
            margin-bottom: 10px;
        }
        
        .weibo-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .weibo-image {
            aspect-ratio: 1;
            background-color: #eee;
        }
        
        .weibo-actions {
            display: flex;
            justify-content: space-around;
            color: #888;
        }
        
        .weibo-action {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 音乐应用样式 */
        .music-player {
            padding: 20px;
            text-align: center;
        }
        
        .now-playing {
            margin-bottom: 30px;
        }
        
        .album-cover {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: white;
            box-shadow: var(--shadow-special);
        }
        
        .song-info {
            margin-bottom: 20px;
        }
        
        .song-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .artist-name {
            font-size: 16px;
            color: #666;
        }
        
        .progress-container {
            margin-bottom: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .music-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: var(--theme-button-bg, linear-gradient(135deg, #667eea, #764ba2));
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--theme-button-shadow, 0 2px 8px rgba(0, 0, 0, 0.15));
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        .control-btn.play-pause {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }
        
        .playlist-section, .character-listening {
            text-align: left;
            margin-bottom: 30px;
        }
        
        .section-header, .listening-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-header h3, .listening-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .add-music-btn, .invite-character-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background-color: var(--theme-button-bg, #007AFF);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-button);
        }
        
        .add-music-btn:hover, .invite-character-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--theme-button-shadow);
        }
        
        .playlist {
            background-color: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
            min-height: 100px;
        }
        
        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .playlist-item:last-child {
            border-bottom: none;
        }
        
        .playlist-item:hover {
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        
        .listening-characters {
            background-color: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
            min-height: 80px;
        }
        
        .character-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }
        
        .character-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .character-name {
            flex: 1;
        }
        
        .listening-status {
            font-size: 12px;
            color: #666;
        }
        
        /* 购物界面 */
        .product-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
        }
        
        .product-item {
            background-color: #f9f9f9;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-light-2);
        }
        
        .product-image {
            width: 100%;
            aspect-ratio: 1;
            background-color: #eee;
        }
        
        .product-info {
            padding: 10px;
        }
        
        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .product-price {
            color: #FF2D55;
            font-weight: bold;
        }
        
        .product-seller {
            display: flex;
            align-items: center;
            margin-top: 5px;
            font-size: 12px;
            color: #888;
        }
        
        /* 浏览器界面 */
        .browser-toolbar {
            display: flex;
            padding: 10px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
        }
        
        .browser-url-bar {
            flex: 1;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background-color: white;
        }
        
        .browser-content {
            border: none;
            width: 100%;
            height: 100%;
        }
        
        /* 相机界面 */
        .camera-view {
            flex: 1;
            background-color: #FFEEF2; /* 粉白色背景 */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #888;
            font-size: 18px;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }
        
        .capture-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: white;
            border: 3px solid #ddd;
            cursor: pointer;
        }
        
        /* 相册界面 */
        .album-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
        }
        
        .album-item {
            aspect-ratio: 1;
            background-color: #FFEEF2; /* 粉白色背景 */
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #333;
            word-break: break-word;
            overflow: hidden;
        }
        
        .album-item::after {
            content: attr(data-description);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            text-align: center;
        }
        
        .album-item::before {
            content: attr(data-time);
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            color: #666;
        }
        
        /* 照片详情 */
        .photo-detail {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .photo-image {
            flex: 1;
            background-color: #FFEEF2; /* 粉白色背景 */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .photo-description {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            text-align: center;
            font-size: 16px;
            color: #333;
            background-color: var(--bg-white-70);
            padding: 10px;
            border-radius: 5px;
        }
        
        .photo-info {
            padding: 15px;
            background-color: white;
            border-top: 1px solid #eee;
        }
        
        .photo-time, .photo-location {
            color: #888;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        /* 壁纸设置 */
        .wallpaper-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
        }
        
        .wallpaper-option {
            aspect-ratio: 1;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .wallpaper-option.selected {
            border-color: #007AFF;
        }
        
        /* 壁纸预览容器 */
        .wallpaper-preview-container {
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 15px;
            min-height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .wallpaper-preview-placeholder {
            text-align: center;
            color: #999;
        }
        
        .wallpaper-preview-placeholder i {
            font-size: 48px;
            margin-bottom: 10px;
            color: #ddd;
        }
        
        .wallpaper-preview-placeholder div {
            font-size: 14px;
        }
        
        .wallpaper-preview-image {
            width: 280px;
            height: 200px;
            border-radius: 12px;
            object-fit: contain;
            border: 3px solid #ddd;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* 图标设置 */
        .icon-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
        }
        
        .icon-option {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background-color: #007AFF;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 30px;
            margin-bottom: 5px;
            background-size: cover;
            background-position: center;
        }
        

        
        /* 颜色选择器 */
        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
        }
        
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .color-option.selected {
            border-color: #000;
        }
        
        /* 透明度滑块 */
        .opacity-slider {
            width: 100%;
            padding: 0 15px;
            margin-top: 10px;
        }
        
        /* 新建联系人模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-black-50);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-weight: bold;
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-button {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        
        .modal-primary {
            background-color: var(--theme-button-bg, #007AFF);
            color: var(--theme-button-color, white);
            font-family: var(--theme-font-family);
            font-weight: var(--theme-button-font-weight, 500);
            letter-spacing: var(--theme-button-letter-spacing, 0);
            transition: all 0.2s ease;
        }
        
        .modal-primary:hover {
            background-color: var(--theme-button-bg-hover);
            transform: translateY(-1px);
            box-shadow: var(--theme-button-shadow);
        }
        
        .modal-secondary {
            background-color: var(--theme-button-secondary-bg, #eee);
            color: var(--theme-button-secondary-color, #333);
            font-family: var(--theme-font-family);
            font-weight: var(--theme-button-font-weight, 500);
            letter-spacing: var(--theme-button-letter-spacing, 0);
            transition: all 0.2s ease;
        }
        
        .modal-secondary:hover {
            background-color: var(--theme-button-secondary-bg-hover);
            transform: translateY(-1px);
        }
        
        /* 消息操作菜单 */
        .message-menu {
            position: fixed;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow-card-special);
            z-index: 1000;
            overflow: hidden;
            min-width: 120px;
        }
        
        .message-menu-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.2s ease;
        }
        
        .message-menu-item:hover {
            background-color: #f5f5f5;
        }
        
        .message-menu-item:last-child {
            border-bottom: none;
        }
        
        .message-menu-item.danger {
            color: #ff3b30;
        }
        
        /* 关于我们页面 */
        .about-content {
            padding: 20px;
            text-align: center;
        }
        
        .about-title {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .about-version {
            color: #888;
            margin-bottom: 30px;
        }
        
        .about-author {
            margin-top: 30px;
            font-style: italic;
        }
        
        /* 朋友圈（动态）样式 */
        .moments-page {
            height: 100%;
            overflow-y: auto;
            background-color: #f5f5f5;
        }
        
        .moments-header {
            position: relative;
            margin-bottom: 10px;
        }
        
        .moments-cover {
            position: relative;
            height: 250px;
            overflow: hidden;
        }
        
        .cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .cover-image-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6b8dd6, #8fa8e8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 500;
        }
        
        .cover-image-placeholder::after {
            content: "朋友圈封面";
        }
        
        .moments-user-info {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .moments-avatar {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .moments-username {
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .moments-list {
            background-color: white;
            min-height: calc(100vh - 250px);
        }
        
        .moment-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .moment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-color: #f0f0f0;
            margin-right: 12px;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }
        
        .moment-content {
            flex: 1;
            min-width: 0;
        }
        
        .moment-username {
            font-weight: 600;
            color: #576b95;
            margin-bottom: 5px;
        }
        
        .moment-text {
            color: #333;
            line-height: 1.5;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        
        .moment-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            margin-bottom: 8px;
        }
        
        .moment-image {
            aspect-ratio: 1;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .moment-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .moment-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .moment-time {
            font-size: 12px;
            color: #999;
        }
        
        .moment-actions {
            display: flex;
            gap: 15px;
        }
        
        .moment-action-btn {
            background: none;
            border: none;
            color: #576b95;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
        }
        
        .moment-interactions {
            background-color: #f7f7f7;
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
            font-size: 13px;
            display: none;
        }
        
        .moment-interactions.show {
            display: block;
        }
        
        .publish-moment-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #576b95;
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 100;
        }
        
        .publish-moment-btn:active {
            transform: scale(0.95);
        }

        /* 面具区域样式 */
        .persona-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 15px;
            background: var(--theme-header-bg);
            backdrop-filter: var(--theme-header-backdrop);
            border-bottom: 1px solid #eee;
        }
        
        .persona-title h2 {
            margin: 0;
            font-size: 20px;
            color: var(--theme-text-primary, #333);
            font-weight: 600;
        }
        
        .persona-title p {
            margin: 5px 0 0 0;
            font-size: 13px;
            color: #666;
        }
        
        .persona-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .persona-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }
        
        .persona-item:hover {
            background-color: #f5f5f5;
        }
        
        .persona-item.active {
            background-color: var(--bg-blue-05);
            border-left: 3px solid #007AFF;
        }
        
        .persona-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--theme-avatar-bg-1, #f0f2f5), var(--theme-avatar-bg-2, #e8ebf0));
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--theme-avatar-text, #8b9dc3);
            font-weight: bold;
            font-size: 18px;
            background-size: cover;
            background-position: center;
            border: 2px solid var(--theme-avatar-border, rgba(255, 255, 255, 0.8));
            flex-shrink: 0;
        }
        
        .persona-info {
            flex: 1;
            min-width: 0;
        }
        
        .persona-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--theme-text-primary, #333);
        }
        
        .persona-description {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .persona-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .persona-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .persona-edit-btn {
            background: var(--bg-blue-10);
            color: #007AFF;
        }
        
        .persona-edit-btn:hover {
            background: var(--bg-blue-20);
        }
        
        .persona-delete-btn {
            background: var(--bg-red-10);
            color: #FF3B30;
        }
        
        .persona-delete-btn:hover {
            background: var(--bg-red-20);
        }
        
        .current-persona {
            border-top: 1px solid #eee;
            background: var(--theme-form-bg, rgba(255, 255, 255, 0.9));
            padding: 0;
        }
        
        .current-persona .menu-item {
            border-bottom: none;
            margin: 0;
        }
        
        .current-persona-name {
            font-weight: 500;
            color: #007AFF;
            font-size: 14px;
        }
        
        /* 多选模式样式 */
        .contact-item.selected {
            background-color: rgba(0, 123, 255, 0.1);
            border-left: 3px solid #007AFF;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        
        /* 聊天选项样式 */
        .chat-option-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .chat-option-item:hover {
            background-color: #f5f5f5;
        }
        
        .chat-option-item:last-child {
            border-bottom: none;
        }
        
        .chat-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            font-size: 18px;
        }
        
        .chat-option-text {
            flex: 1;
        }
        
        .chat-option-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 3px;
        }
        
        .chat-option-desc {
            font-size: 13px;
            color: #666;
        }
        
        /* 群聊成员选择样式 */
        .group-member-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .group-member-item:hover {
            background-color: #f5f5f5;
        }
        
        .group-member-item.selected {
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .group-member-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #007AFF;
            border-radius: 3px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .group-member-checkbox.checked {
            background-color: #007AFF;
            color: white;
        }
        
        /* 新聊天设置界面样式 */
        .settings-container {
            padding: 0;
            background-color: #f8f9fa;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            padding: 15px 20px 10px 20px;
            background-color: #f8f9fa;
        }
        
        .section-icon {
            font-size: 16px;
            color: var(--theme-button-bg, #4a84c1);
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .setting-card {
            background: white;
            border-radius: 12px;
            margin: 0 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-item:hover {
            background-color: #f8f9fa;
        }
        
        .setting-item.danger-item:hover {
            background-color: #fff5f5;
        }
        
        .setting-left {
            flex: 1;
            min-width: 0;
        }
        
        .setting-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .setting-label {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .setting-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        
        .setting-value {
            font-size: 14px;
            color: #666;
            margin-right: 5px;
        }
        
        .setting-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            min-width: 120px;
        }
        
        /* 开关按钮样式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--theme-button-bg, #4a84c1);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        /* 聊天模式切换样式 */
        .chat-mode-switch {
            display: flex;
            background: var(--bg-white-50);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--bg-black-10);
            border-radius: 12px;
            padding: 4px;
            margin: 12px 20px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .chat-mode-option {
            flex: 1;
            position: relative;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .chat-mode-option input[type="radio"] {
            display: none;
        }
        
        .chat-mode-option label {
            display: block;
            padding: 10px 16px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: transparent;
            color: rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }
        
                .chat-mode-option input[type="radio"]:checked + label {
            background: var(--bg-white-90);
            color: var(--theme-button-bg, #4a84c1);
            font-weight: 600;
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .chat-mode-option label:hover {
            background: var(--bg-white-50);
        }
        
        /* 线下模式字数控制 */
        .offline-length-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 20px;
            padding: 8px 12px;
            background: var(--theme-form-bg);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            border: 1px solid var(--bg-black-05);
            transition: all 0.3s ease;
        }
        
        .control-label, .control-unit {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .offline-length-control input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid var(--theme-input-border);
            border-radius: 6px;
            background: var(--bg-white-80);
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .offline-length-control input[type="number"]:focus {
            outline: none;
            border-color: var(--theme-button-bg, #4a84c1);
            box-shadow: 0 0 0 2px rgba(74, 132, 193, 0.2);
        }
        
        /* 后台互动详细设置 */
        .background-interaction-details {
            border-top: 1px solid #f5f5f5;
            margin-top: 0;
            padding-top: 0;
        }
        
        .background-interaction-details .setting-item {
            border-bottom: 1px solid #f8f8f8;
        }
        
        .background-interaction-details .setting-item:last-child {
            border-bottom: none;
        }
        
        /* 社交动态设置详细选项 */
        .weibo-settings {
            border-top: 1px solid #f5f5f5;
            margin-top: 0;
            padding-top: 0;
        }
        
        /* 功能说明样式 */
        .setting-explanation {
            background: var(--setting-card-bg);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            margin: 12px 20px;
            padding: 12px 16px;
            border: 1px solid var(--bg-black-05);
        }
        
        .explanation-text {
            font-size: 12px;
            color: #555;
            line-height: 1.5;
        }
        
        .explanation-text strong {
            color: #333;
            font-weight: 600;
        }
        
        /* 头像设置样式 */
        .avatar-setting-group {
            margin-bottom: 25px;
        }
        
        .avatar-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .avatar-preview-container .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f0f2f5, #e8ebf0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #999;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--theme-avatar-border);
            box-shadow: var(--shadow-lg);
        }
        
        /* 背景预览样式 */
        .background-preview-container {
            margin-bottom: 20px;
        }
        
        .background-preview {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }
        
        .preview-text {
            color: #999;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* 增强的颜色选择器样式 */
        .color-setting-group {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--theme-form-bg);
            border-radius: 12px;
            border: 1px solid var(--bg-black-05);
        }
        
        /* 自定义表情包样式 */
        .custom-emoji-panel {
            position: fixed;
            bottom: 60px;
            left: 8px;
            right: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding: 15px;
            display: none;
            z-index: 999;
            max-height: 300px;
            overflow-y: auto;
            max-width: 344px;
            margin: 0 auto;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .emoji-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .emoji-tab {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            color: #666;
            transition: all 0.2s ease;
        }
        
        .emoji-tab.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .custom-emoji-item {
            aspect-ratio: 1;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .custom-emoji-item:hover {
            border-color: #007AFF;
            transform: scale(1.05);
        }
        
        .custom-emoji-item.placeholder {
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #999;
            border: 2px dashed #ddd;
        }
        
        .custom-emoji-item.placeholder:hover {
            background: #eee;
            border-color: #007AFF;
        }
        
        .emoji-delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: rgba(255, 59, 48, 0.9);
            color: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .custom-emoji-item:hover .emoji-delete-btn {
            display: flex;
        }
        
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .color-input {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .color-preview {
            width: 100px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .opacity-setting {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .opacity-setting label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .opacity-setting input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .opacity-setting input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--theme-button-bg, #4a84c1);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* 气泡预览演示 */
        .bubble-preview-demo {
            margin-top: 20px;
            padding: 20px;
            background: var(--bubble-demo-bg);
            border-radius: 12px;
            border: 1px solid var(--bg-black-05);
        }
        
        .demo-message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .demo-message.my-message {
            justify-content: flex-end;
        }
        
        .demo-message.ai-message {
            justify-content: flex-start;
        }
        
        .demo-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* 定时发布时间点样式 */
        .schedule-time-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: var(--schedule-item-bg);
            border-radius: 8px;
            border: 1px solid var(--bg-black-05);
        }
        
        .schedule-time-item input[type="time"] {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .schedule-time-item button {
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* 社交设置详细选项 */
        .social-settings {
            border-top: 1px solid #f5f5f5;
            margin-top: 0;
            padding-top: 0;
        }
        
        /* 主题化滑块样式 */
        .theme-range {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(var(--theme-button-bg-rgb, 74, 132, 193), 0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .theme-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--theme-button-bg, #4a84c1);
            cursor: pointer;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: var(--slider-thumb-border);
            transition: all 0.3s ease;
        }
        
        .theme-range::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .theme-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--theme-button-bg, #4a84c1);
            cursor: pointer;
            border: var(--slider-thumb-border);
            box-shadow: var(--shadow-md);
        }
        
        /* 设置范围容器 */
        .setting-range-container {
            margin: 15px 20px;
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }
        
        /* 自定义输入容器 */
        .custom-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 20px;
            padding: 12px 16px;
            background: var(--custom-input-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid var(--bg-black-05);
        }
        
        .input-label, .input-unit {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }
        
        .theme-input {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid var(--theme-input-border);
            border-radius: 8px;
            font-size: 13px;
            background: var(--input-white-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .theme-input:focus {
            outline: none;
            border-color: var(--theme-button-bg, #4a84c1);
            box-shadow: 0 0 0 2px rgba(var(--theme-button-bg-rgb, 74, 132, 193), 0.2);
            background: rgba(255, 255, 255, 1);
        }
        
        /* 主题化按钮 */
        .theme-button {
            padding: 10px 20px;
            border-radius: var(--theme-button-radius, 8px);
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .theme-button-primary {
            background: var(--theme-button-bg-rgba);
            color: var(--theme-button-color, white);
            border: 1px solid var(--border-light);
        }
        
        .theme-button-primary:hover {
            background: var(--theme-button-bg-hover, rgba(74, 132, 193, 1));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
                .theme-button-secondary {
            background: var(--theme-button-secondary-bg-rgba);
            color: #666;
            border: 1px solid var(--bg-black-10);
        }

        .theme-button-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* CSS变量支持 */
        :root {
            --theme-button-bg-rgb: 74, 132, 193;
        }
        
        body[data-theme="cute"] {
            --theme-button-bg-rgb: 255, 182, 193;
        }
        
        /* 可爱主题的header特殊样式 */
        body[data-theme="cute"] .app-header {
            border-bottom: 1px solid #ffccd5;
            background-color: rgba(255, 230, 240, 0.8) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
        }
        

        
        body[data-theme="nature"] {
            --theme-button-bg-rgb: 76, 217, 100;
        }
        
        body[data-theme="tech"] {
            --theme-button-bg-rgb: 0, 123, 255;
        }
        
        body[data-theme="dream"] {
            --theme-button-bg-rgb: 156, 39, 176;
        }
        
        /* 戳一戳系统消息样式 */
        .poke-system-message {
            text-align: center;
            color: #999;
            font-size: 13px;
            padding: 6px 12px;
            margin: 4px auto;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            display: inline-block;
            max-width: 200px;
        }
        
        .poke-system-container {
            text-align: center;
            margin: 4px 0;
        }
        
        /* 移除重复的选中样式 - 现在只使用头像上的勾号 */
        
        /* 选择模式下的消息容器样式 */
        .message-container.selected {
            /* 保持选中状态，由其他样式控制选中效果 */
            background: none;
        }
        
        /* 主题样式定义在后面统一处理 */
        

        

        
        /* 聊天消息界面使用和完成.html一样的header样式 */
        #api-chat-screen .header .default-controls, #api-chat-screen .header .selection-controls { 
            display: contents;
        }
        
        #api-chat-screen.selection-mode .default-controls { 
            display: none;
        }
        
        #api-chat-screen:not(.selection-mode) .selection-controls { 
            display: none;
        }
        
        #selection-cancel-btn, #selection-delete-btn { 
            font-size: 13px; 
            cursor: pointer; 
            padding: 6px 12px; 
            transition: all 0.2s ease;
            border-radius: 16px;
            font-weight: 500;
            min-width: 50px;
            text-align: center;
            border: none;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }
        
        #selection-cancel-btn {
            color: #007AFF;
            background: rgba(0, 122, 255, 0.08);
            border: 1px solid rgba(0, 122, 255, 0.2);
        }
        
        #selection-delete-btn { 
            color: #FF3B30; 
            background: rgba(255, 59, 48, 0.08);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }
        
        #selection-count {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            padding: 0 8px;
            white-space: nowrap;
        }
        
        #selection-cancel-btn:hover {
            background: rgba(0, 122, 255, 0.12);
            box-shadow: 0 2px 6px rgba(0, 122, 255, 0.15);
        }
        
        #selection-delete-btn:hover {
            background: rgba(255, 59, 48, 0.12);
            box-shadow: 0 2px 6px rgba(255, 59, 48, 0.15);
        }
        
        #selection-cancel-btn:active,
        #selection-delete-btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        /* 消息选中状态样式 */
        .message-container.selected .message-avatar::after { 
            content: '✔'; 
            position: absolute; 
            bottom: -5px; 
            right: -5px; 
            background-color: var(--theme-button-bg, #4a84c1); 
            color: white; 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: bold; 
            z-index: 10; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); 
        }
        
        .message-container.sent.selected .message-avatar::after { 
            bottom: -5px; 
            left: -5px; 
            right: auto;
        }
        
        /* 可爱主题下的选中标记 */
        body[data-theme="cute"] .message-container.selected .message-avatar::after {
            background-color: var(--theme-button-bg, #ffb6c1);
        }
        
        /* 自然主题下的选中标记 */
        body[data-theme="nature"] .message-container.selected .message-avatar::after {
            background-color: var(--theme-button-bg, #4cd964);
        }
        
        /* 科技主题下的选中标记 */
        body[data-theme="tech"] .message-container.selected .message-avatar::after {
            background-color: var(--theme-button-bg, #007bff);
        }
        
        /* 梦幻主题下的选中标记 */
        body[data-theme="dream"] .message-container.selected .message-avatar::after {
            background-color: var(--theme-button-bg, #9c27b0);
        }
        
        /* 移除消息容器选中时的背景 */
        .message-container.selected {
            background: none !important;
        }

        /* 隐藏头像时的选中标记 */
        .message-container.selected.no-avatar::before {
            content: '✔';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--theme-button-bg, #4a84c1);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .message-container.sent.selected.no-avatar::before {
            right: auto;
            left: -25px;
        }
        
        .poke-icon {
            margin-right: 8px;
            color: #ff69b4;
            animation: pokeWave 1s ease-in-out;
        }
        
        @keyframes pokeShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        @keyframes pokeWave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }
        
        /* 头像戳一戳提示 */
        .message-avatar {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .message-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* 时间戳设置样式 */
        .timestamp-position-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .radio-option:hover {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.05);
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 12px;
            margin-top: 2px;
            position: relative;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .radio-option input[type="radio"]:checked + .radio-custom {
            border-color: #007AFF;
            background-color: #007AFF;
        }

        .radio-option input[type="radio"]:checked + .radio-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
        }

        .option-content {
            flex: 1;
        }

        .option-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .option-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .radio-option input[type="radio"]:checked + .radio-custom + .option-content .option-label {
            color: #007AFF;
        }

        /* 悬浮按钮样式 */
        .floating-actions {
            position: absolute;
            right: 20px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .floating-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            position: relative;
            overflow: hidden;
        }

        .floating-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border-radius: 50%;
            z-index: -1;
        }

        .floating-btn:hover {
            transform: translateY(-2px) scale(1.08);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.18);
        }
        
        #regenerate-btn:hover {
            opacity: 0.65 !important;
        }
        
        #smart-reply-btn:hover {
            opacity: 0.65 !important;
        }

        .floating-btn:active {
            transform: translateY(0) scale(0.98);
            transition: all 0.15s ease;
        }

        /* 重新生成按钮 */
        #regenerate-btn {
            background: var(--floating-btn-bg);
            color: var(--theme-button-color, white);
        }

        #regenerate-btn:hover {
            background: var(--floating-btn-bg-hover);
        }

        /* 智能回复按钮 */
        #smart-reply-btn {
            background: var(--floating-btn-secondary-bg);
            color: var(--theme-button-secondary-color, #555);
            border: 1px solid var(--theme-button-secondary-border, rgba(0, 0, 0, 0.05));
        }

        #smart-reply-btn:hover {
            background: var(--floating-btn-secondary-bg-hover);
        }

        /* 主题特定悬浮按钮样式现在通过CSS变量统一管理 */

        /* 按钮图标动画 */
        #regenerate-btn i {
            transition: transform 0.3s ease;
        }

        #regenerate-btn:hover i {
            transform: rotate(180deg);
        }

        #smart-reply-btn i {
            transition: transform 0.3s ease;
        }

        #smart-reply-btn:hover i {
            transform: scale(1.1);
        }

        /* 悬浮按钮出现动画 */
        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .floating-btn {
            animation: floatIn 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
            opacity: 0;
            transform: translateY(20px) scale(0.8);
        }

        .floating-btn:not(.hidden) {
            opacity: 0.4;
            transform: translateY(0) scale(1);
        }

        .floating-btn:nth-child(1) {
            animation-delay: 0.1s;
        }

        .floating-btn:nth-child(2) {
            animation-delay: 0.2s;
        }

        /* 悬浮按钮隐藏状态 */
        .floating-btn.hidden {
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            pointer-events: none;
        }

        /* 等待状态的特殊样式 */
        .floating-btn.waiting {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 0 4px rgba(255, 193, 7, 0.3);
        }

        /* 脉冲动画 */
        @keyframes pulse {
            0% {
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 0 0 var(--theme-button-secondary-border, rgba(0, 0, 0, 0.3));
            }
            50% {
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 0 8px rgba(0, 0, 0, 0);
            }
            100% {
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 0 0 rgba(0, 0, 0, 0);
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="phone-frame">
        <div id="phone-screen">
        <div class="wallpaper" id="wallpaper-element">
            <!-- 状态栏 -->
            <div id="status-bar">
                <span id="status-bar-time">14:25</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">ᰔᩚ</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            
            <!-- 时钟容器 -->
            <div id="clock-container">
                <div id="main-time">14:25</div>
                <div id="main-date">12月18日 星期一</div>
            </div>
                
                <!-- 应用图标 -->
                <div id="app-grid">
                    <div class="app-row">
                        <a href="#" class="app" onclick="showApp('chat-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" alt="Chat" class="app-icon-img">
                            </div>
                            <span>Chat</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('worldbook-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/Xqz3zPz7/IMG-3080.jpg" alt="世界书" class="app-icon-img">
                            </div>
                            <span>世界书</span>
                        </a>
                        <a href="#" class="app" onclick="showApp('settings-screen')">
                            <div class="app-icon">
                                <img src="https://i.postimg.cc/764L3jpF/IMG-3079.jpg" alt="设置" class="app-icon-img">
                            </div>
                            <span>设置</span>
                        </a>
                    </div>
                    <div class="app-row">
                                        <a href="#" class="app" onclick="showApp('game-screen')">
                    <div class="app-icon">
                        <i class="fas fa-gamepad"></i>
                    </div>
                    <span>游戏</span>
                </a>
                        <a href="#" class="app" onclick="showApp('music-screen')">
                            <div class="app-icon">
                                <i class="fas fa-music"></i>
                            </div>
                            <span>音乐</span>
                        </a>
                                        <a href="#" class="app" onclick="showApp('forum-screen')">
                    <div class="app-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <span>论坛</span>
                </a>
                    </div>
                </div>

                
                <!-- 微信界面 -->
                <div id="chat-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('chat-screen')">‹</button>
                        <div class="app-title">💬</div>
                        <div class="chat-header-actions">
                            <div id="add-contact-btn" class="add-btn" onclick="showCharacterForm()">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div id="add-chat-btn" class="add-btn" onclick="showChatOptions()">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="app-content" id="wechat-content">
                        <!-- 默认显示消息列表 -->
                        <div class="message-list" id="message-list">
                            <!-- 消息列表将通过JS动态生成 -->
                        </div>
                        
                        <!-- 通讯录 -->
                        <div class="contact-list hide" id="contact-list">
                            <div class="contact-section">
        
                                <!-- 联系人列表将通过JS动态生成 -->
                            </div>

                        </div>
                        
                        <!-- 动态页面（朋友圈）-->
                        <div class="moments-page hide" id="moments-page">
                            <div class="moments-header">
                                <div class="moments-cover">
                                    <div class="cover-image-placeholder"></div>
                                    <div class="moments-user-info">
                                        <div class="moments-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <span class="moments-username">我的名字</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="moments-list" id="moments-list">
                                <!-- 动态列表将通过JS动态生成 -->
                                <div class="moment-item">
                                    <div class="moment-avatar">
                                        <div class="avatar-placeholder">
                                            <i class="fas fa-user"></i>
                                        </div>
                                    </div>
                                    <div class="moment-content">
                                        <div class="moment-username">示例用户</div>
                                        <div class="moment-text">今天天气真好，适合出去走走~</div>
                                        <div class="moment-images">
                                            <!-- 图片预览区域 -->
                                        </div>
                                        <div class="moment-footer">
                                            <div class="moment-time">5分钟前</div>
                                            <div class="moment-actions">
                                                <button class="moment-action-btn">
                                                    <i class="far fa-heart"></i>
                                                </button>
                                                <button class="moment-action-btn">
                                                    <i class="far fa-comment"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="moment-interactions">
                                            <!-- 点赞和评论区域 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 发布按钮 -->
                            <button class="publish-moment-btn" onclick="showPublishMoment()">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>

                        
                        <!-- 面具区域 -->
                        <div class="profile-page hide" id="profile-page">
                            <div class="persona-header">
                                <div class="persona-title">
                                    <h2>我的面具</h2>
                                    <p>管理你的多重身份设定</p>
                                </div>
                                <div class="add-persona-btn persona-add-btn" onclick="showPersonaForm()">
                                    <i class="fas fa-plus"></i>
                                </div>
                            </div>
                            
                            <div class="persona-list" id="persona-list">
                                <!-- 面具列表将通过JS动态生成 -->
                            </div>
                            

                        </div>
                    </div>
                    
                    <div class="wechat-tabs">
                        <div class="wechat-tab active" onclick="switchWechatTab('message-list')" id="message-tab">
                            <i class="fas fa-comment-alt"></i>
                            <span>消息</span>
                        </div>
                        <div class="wechat-tab" onclick="switchWechatTab('contact-list')">
                            <i class="fas fa-address-book"></i>
                            <span>角色</span>
                        </div>
                        <div class="wechat-tab" onclick="switchWechatTab('moments-page')">
                            <i class="fas fa-circle-notch"></i>
                            <span>动态</span>
                        </div>
                        <div class="wechat-tab" onclick="switchWechatTab('profile-page')">
                            <i class="fas fa-masks-theater"></i>
                            <span>我</span>
                        </div>
                    </div>
                </div>
                
                <!-- 论坛界面 -->
                <div id="forum-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('forum-screen')">‹</button>
                        <div class="app-title">论坛</div>
                    </div>
                    <div class="app-content">
                        <div class="forum-categories">
                            <div class="forum-category">
                                <div class="category-icon">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">热门话题</div>
                                    <div class="category-desc">最受欢迎的讨论</div>
                                </div>
                                <div class="category-count">128</div>
                            </div>
                            <div class="forum-category">
                                <div class="category-icon">
                                    <i class="fas fa-gamepad"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">游戏讨论</div>
                                    <div class="category-desc">分享游戏心得</div>
                                </div>
                                <div class="category-count">89</div>
                            </div>
                            <div class="forum-category">
                                <div class="category-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">角色互动</div>
                                    <div class="category-desc">与AI角色的故事</div>
                                </div>
                                <div class="category-count">256</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 世界书界面 -->
                <div id="worldbook-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('worldbook-screen')">‹</button>
                        <div class="app-title">世界书</div>
                        <div class="add-worldbook-btn worldbook-add-btn" onclick="showWorldbookForm()">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    <div class="app-content">
                        <div class="worldbook-list" id="worldbook-list">
                            <!-- 世界书列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 世界书编辑表单 -->
                <div id="worldbook-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideWorldbookForm()">‹</button>
                        <div class="app-title" id="worldbook-form-title">新建世界书</div>
                        <button class="save-worldbook-btn save-btn-absolute" onclick="saveWorldbook()">保存</button>
                    </div>
                    <div class="app-content">
                        <div class="worldbook-form">
                            <div class="form-group">
                                <label class="form-label">标题</label>
                                <input type="text" class="form-input" id="worldbook-title" placeholder="输入世界书标题">
                            </div>
                            <div class="form-group">
                                <label class="form-label">内容</label>
                                <textarea class="form-textarea textarea-large" id="worldbook-content" placeholder="输入世界书内容..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 音乐应用界面 -->
                <div id="music-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('music-screen')">‹</button>
                        <div class="app-title">音乐</div>
                    </div>
                    <div class="app-content">
                        <div class="music-player">
                            <div class="now-playing">
                                <div class="album-cover" id="album-cover">
                                    <i class="fas fa-music"></i>
                                </div>
                                <div class="song-info">
                                    <div class="song-title" id="song-title">选择一首歌曲</div>
                                    <div class="artist-name" id="artist-name">未知艺术家</div>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress" id="progress"></div>
                                </div>
                                <div class="time-info">
                                    <span id="current-time">0:00</span>
                                    <span id="total-time">0:00</span>
                                </div>
                            </div>
                            
                            <div class="music-controls">
                                <button class="control-btn" onclick="previousSong()">
                                    <i class="fas fa-step-backward"></i>
                                </button>
                                <button class="control-btn play-pause" id="play-pause-btn" onclick="togglePlayPause()">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="control-btn" onclick="nextSong()">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                            </div>
                            
                            <div class="playlist-section">
                                <div class="section-header">
                                    <h3>播放列表</h3>
                                    <button class="add-music-btn" onclick="addMusicToPlaylist()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="playlist" id="playlist">
                                    <!-- 播放列表将通过JS动态生成 -->
                                </div>
                            </div>
                            
                            <div class="character-listening">
                                <div class="listening-header">
                                    <h3>一起听歌的角色</h3>
                                    <button class="invite-character-btn" onclick="inviteCharacterToListen()">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                                <div class="listening-characters" id="listening-characters">
                                    <!-- 听歌角色将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 聊天设置界面 -->
                <div id="api-chat-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideChatSettings()">‹</button>
                        <div class="app-title">聊天设置</div>
                    </div>
                    <div class="app-content padding-none-flex overflow-auto">
                        <div class="settings-container">
                            
                            <!-- 聊天窗口设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-user-edit section-icon"></i>
                                    <span class="section-title">聊天窗口设置</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showIdentitySelector()">
                                        <div class="setting-left">
                                            <div class="setting-label">我的身份选择</div>
                                            <div class="setting-desc">选择在此聊天中使用的身份面具</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-chat-identity">未选择</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showAvatarSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">双方头像设置</div>
                                            <div class="setting-desc">设置在此聊天窗口中显示的头像</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showNicknameSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">双方备注设置</div>
                                            <div class="setting-desc">设置在此聊天窗口中显示的昵称</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBackgroundSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">聊天背景设置</div>
                                            <div class="setting-desc">自定义聊天界面的背景图片</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showBubbleStyleSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">气泡样式设置</div>
                                            <div class="setting-desc">选择气泡外观样式和颜色</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-bubble-style">默认样式</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 戳一戳功能设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-hand-paper section-icon"></i>
                                    <span class="section-title">戳一戳功能</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">启用戳一戳</div>
                                            <div class="setting-desc">允许发送戳一戳消息，双方可自定义戳一戳后缀</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="poke-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item poke-settings poke-settings-visible" id="poke-suffix-settings" onclick="showPokeSuffixSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">戳一戳后缀设置</div>
                                            <div class="setting-desc">自定义双方的戳一戳动作后缀</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-explanation">
                                        <div class="explanation-text">
                                            <strong>功能说明：</strong><br>
                                            • 点击对方头像即可发送戳一戳<br>
                                            • 你可以自定义戳一戳后缀，如"的小脸蛋"、"的小手"等<br>
                                            • 角色也会根据心情和聊天内容自主修改自己的戳一戳后缀
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 记忆设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-brain section-icon"></i>
                                    <span class="section-title">记忆设置</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item" onclick="showHistorySettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">附带历史消息数</div>
                                            <div class="setting-desc">自定义角色回复时参考的历史对话数量</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-history-count">5回合</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showMemoryMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">挂载其他聊天记忆</div>
                                            <div class="setting-desc">让角色参考其他聊天窗口的对话记忆</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-memory-mount">已关闭</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showWorldbookMountSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">挂载世界书</div>
                                            <div class="setting-desc">让角色参考选定的世界书内容作为背景知识</div>
                                        </div>
                                        <div class="setting-right">
                                            <span class="setting-value" id="current-worldbook-mount">未挂载</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 时间感知设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-clock section-icon"></i>
                                    <span class="section-title">时间感知</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">时间感知开关</div>
                                            <div class="setting-desc">角色会感知当前时间并调整回复</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="time-awareness-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 通话设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-phone section-icon"></i>
                                    <span class="section-title">通话设置</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">角色主动拨打电话</div>
                                            <div class="setting-desc">允许角色根据对话内容主动发起通话</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-call-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-explanation">
                                        <div class="explanation-text">
                                            <strong>功能说明：</strong><br>
                                            • <strong>开启时：</strong>当本轮聊天中提到通话相关内容时，角色有20%概率主动给你打电话<br>
                                            • <strong>关闭时：</strong>角色不会主动拨打电话，只能由用户主动发起通话<br>
                                            • <strong>通话关键词：</strong>通话、电话、视频、语音、打给你、想听、想看等
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AI心率监测 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-heartbeat section-icon"></i>
                                    <span class="section-title">角色心率监测</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">心率监测显示</div>
                                            <div class="setting-desc">在状态栏显示角色的情感心率</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ai-heartrate-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 聊天模式设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-comments section-icon"></i>
                                    <span class="section-title">聊天模式</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">模式选择</div>
                                            <div class="setting-desc">选择线上纯聊天或线下剧情模式</div>
                                        </div>
                                    </div>
                                    <div class="chat-mode-switch">
                                        <div class="chat-mode-option">
                                            <input type="radio" id="chat-mode-online" name="chat-mode" value="online" checked>
                                            <label for="chat-mode-online">线上模式</label>
                                        </div>
                                        <div class="chat-mode-option">
                                            <input type="radio" id="chat-mode-offline" name="chat-mode" value="offline">
                                            <label for="chat-mode-offline">线下模式</label>
                                        </div>
                                    </div>
                                    <div class="offline-length-control hide" id="offline-length-control">
                                        <span class="control-label">每条消息最长：</span>
                                        <input type="number" id="offline-mode-max-length" min="50" max="500" value="100">
                                        <span class="control-unit">字</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 社交动态设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-share-alt section-icon"></i>
                                    <span class="section-title">社交动态</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">社交动态功能</div>
                                            <div class="setting-desc">开启社交动态发布和互动</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="social-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item social-settings hide" id="social-frequency-settings">
                                        <div class="setting-left">
                                            <div class="setting-label">发布频率</div>
                                            <div class="setting-desc">角色自动发布动态的频率</div>
                                        </div>
                                        <div class="setting-right">
                                            <select id="social-frequency" class="setting-select">
                                                <option value="low">低 (1-2条/天)</option>
                                                <option value="medium">中 (3-4条/天)</option>
                                                <option value="high">高 (5-6条/天)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="setting-item social-settings hide" id="social-schedule-settings" onclick="showScheduleSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">定时发布</div>
                                            <div class="setting-desc">设置固定时间点自动发布动态</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 后台互动设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-robot section-icon"></i>
                                    <span class="section-title">后台互动</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">后台互动开关</div>
                                            <div class="setting-desc">角色可在后台主动活动并发送推送</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="background-interaction-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="background-interaction-details hide" id="background-interaction-settings">
                                        <div class="setting-item">
                                            <div class="setting-left">
                                                <div class="setting-label">主动聊天频率</div>
                                                <div class="setting-desc">角色主动发起对话的频率</div>
                                            </div>
                                            <div class="setting-right">
                                                <select id="background-chat-frequency" class="setting-select">
                                                    <option value="low">低 (1-2小时/次)</option>
                                                    <option value="medium">中 (30-60分钟/次)</option>
                                                    <option value="high">高 (10-15分钟/次)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="setting-item">
                                            <div class="setting-left">
                                                <div class="setting-label">主动发动态频率</div>
                                                <div class="setting-desc">角色主动发布社交动态的频率</div>
                                            </div>
                                            <div class="setting-right">
                                                <select id="background-weibo-frequency" class="setting-select">
                                                    <option value="low">低 (3-5小时/次)</option>
                                                    <option value="medium">中 (1-2小时/次)</option>
                                                    <option value="high">高 (15-25分钟/次)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 其他设置 -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <i class="fas fa-cog section-icon"></i>
                                    <span class="section-title">其他设置</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item">
                                        <div class="setting-left">
                                            <div class="setting-label">显示时间戳</div>
                                            <div class="setting-desc">在聊天消息中显示时间信息</div>
                                        </div>
                                        <div class="setting-right">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="timestamp-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="showTimestampSettings()">
                                        <div class="setting-left">
                                            <div class="setting-label">时间戳设置</div>
                                            <div class="setting-desc">设置时间戳显示位置和格式</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="searchChatContent()">
                                        <div class="setting-left">
                                            <div class="setting-label">查找聊天内容</div>
                                            <div class="setting-desc">搜索历史消息中的关键词</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="setting-item" onclick="exportChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label">导出聊天记录</div>
                                            <div class="setting-desc">导出当前对话的所有消息</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- 危险操作 -->
                            <div class="settings-section">
                                <div class="section-header">
                                                    <i class="fas fa-exclamation-triangle section-icon danger-section-icon"></i>
                <span class="section-title danger-section-title">危险操作</span>
                                </div>
                                <div class="setting-card">
                                    <div class="setting-item danger-item" onclick="clearChatHistory()">
                                        <div class="setting-left">
                                            <div class="setting-label danger-color">清空聊天记录</div>
                                            <div class="setting-desc">删除所有历史消息，不可恢复</div>
                                        </div>
                                        <div class="setting-right">
                                            <i class="fas fa-chevron-right danger-color"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                
                <!-- 人物编辑表单 -->
                <div id="character-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideCharacterForm()">‹</button>
                        <div class="app-title" id="character-form-title">新建人物</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">头像</label>
                                <div class="avatar-preview" id="avatar-preview">
                                    <div class="avatar-preview-text" id="avatar-preview-text">A</div>
                                </div>
                                <input type="file" id="avatar-upload" accept="image/*" class="file-input-hidden">
                                <button class="upload-button" onclick="handleAvatarUploadClick()">上传头像</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">姓名</label>
                                <input type="text" class="form-input" id="character-name" placeholder="输入姓名">
                            </div>
                            <div class="form-group">
                                <label class="form-label">人设</label>
                                <textarea class="form-textarea" id="character-bio" placeholder="输入人物设定"></textarea>
                            </div>
                            <div class="form-actions form-actions-flex">
                                <button class="form-submit form-submit-flex">保存</button>
                                <button class="form-delete form-delete-red" id="character-delete-btn" onclick="deleteCurrentCharacter()">删除</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 面具创建表单 -->
                <div id="persona-form-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hidePersonaForm()">‹</button>
                        <div class="app-title" id="persona-form-title">新建面具</div>
                    </div>
                    <div class="app-content">
                        <div class="character-form">
                            <div class="form-group avatar-upload">
                                <label class="form-label">头像</label>
                                <div class="avatar-preview" id="persona-avatar-preview">
                                    <div class="avatar-preview-text" id="persona-avatar-preview-text">我</div>
                                </div>
                                <input type="file" id="persona-avatar-upload" accept="image/*" class="file-input-hidden">
                                <button class="upload-button" onclick="handlePersonaAvatarUploadClick()">上传头像</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">我的名称</label>
                                <input type="text" class="form-input" id="persona-name" placeholder="例如：user小明、user学生、user工作者">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">我的描述</label>
                                <textarea class="form-textarea" id="persona-description" placeholder="描述这个身份的特点，包括性格、说话风格、使用场合等..."></textarea>
                            </div>
                            
                            <button class="form-submit" onclick="savePersona()">保存面具</button>
                        </div>
                    </div>
                </div>
                
                <!-- API聊天界面 -->
                <div id="api-chat-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="header">
                        <div class="default-controls">
                            <button class="back-btn" onclick="backToChatApp()">‹</button>
                            <span class="header-title" id="api-chat-title">角色聊天</span>
                            <div class="header-actions">
                                <span class="action-btn" onclick="showChatSettings()">
                                <i class="fas fa-ellipsis-v"></i>
                                </span>
                            </div>
                        </div>
                        <div class="selection-controls">
                            <span id="selection-cancel-btn">取消</span>
                            <span id="selection-count"></span>
                            <span id="selection-delete-btn">删除</span>
                        </div>
                    </div>
                    <div class="app-content padding-none-flex">

                        <div class="chat-dialog">
                            <div class="chat-messages" id="api-chat-messages">
                                <!-- 聊天消息将通过JS动态生成 -->
                            </div>
                            
                            <!-- 悬浮按钮组 -->
                            <div class="floating-actions" id="floating-actions">
                                <button class="floating-btn" id="regenerate-btn" onclick="regenerateLastResponse()" title="重新生成回答">
                                    <i class="fas fa-redo-alt"></i>
                                </button>
                                <button class="floating-btn" id="smart-reply-btn" onclick="triggerSmartReply()" title="获取AI回复">
                                    <i class="fas fa-comment-dots"></i>
                                </button>
                            </div>
                            
                            <div class="chat-input-area">
                                <button class="chat-action-btn" onclick="showCustomEmojiPanel()" title="表情包">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <input type="text" class="chat-input" id="api-chat-input" placeholder="输入消息...">
                                <button class="chat-action-btn" onclick="uploadImage()" title="图片">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="send-button" onclick="sendApiMessage()">
                                    发送
                                </button>
                                <input type="file" id="image-upload" accept="image/*" class="file-input-hidden">
                                <input type="file" id="emoji-upload" accept="image/*" class="file-input-hidden" multiple>
                            </div>
                        </div>
                        
                        <!-- 自定义表情包面板 -->
                        <div class="custom-emoji-panel" id="custom-emoji-panel">
                            <div class="emoji-tabs">
                                <div class="emoji-tab active" data-tab="recent">最近</div>
                                <div class="emoji-tab" data-tab="custom">全部</div>
                            </div>
                            <div class="emoji-content">
                                <div class="emoji-grid" id="emoji-grid">
                                    <!-- 表情包网格将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 浏览器界面 -->
                <div id="browser-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('browser-screen')">‹</button>
                        <div class="app-title">浏览器</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="browser-toolbar">
                            <input type="text" class="browser-url-bar" id="browser-url" placeholder="输入网址">
                            <button onclick="loadUrl()">前往</button>
                        </div>
                        <iframe class="browser-content" id="browser-frame"></iframe>
                    </div>
                </div>
                
                <!-- 相机界面 -->
                <div id="camera-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('camera-screen')">‹</button>
                        <div class="app-title">相机</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="camera-view" id="camera-view">
                            <div>相机预览</div>
                        </div>
                        <div class="camera-controls">
                            <button class="capture-button" onclick="capturePhoto()"></button>
                        </div>
                    </div>
                </div>
                
                <!-- 游戏界面 -->
                <div id="game-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('game-screen')">‹</button>
                        <div class="app-title">游戏中心</div>
                    </div>
                    <div class="app-content">
                        <div class="game-list">
                            <div class="game-item" onclick="startGame('witchPotion')">
                                <div class="game-icon">
                                    <i class="fas fa-flask"></i>
                                </div>
                                <div class="game-info">
                                    <div class="game-name">女巫的解药</div>
                                    <div class="game-desc">与AI角色一起调制神秘药水</div>
                                </div>
                                <div class="game-badge">NEW</div>
                            </div>
                            <div class="game-item coming-soon">
                                <div class="game-icon">
                                    <i class="fas fa-dice"></i>
                                </div>
                                <div class="game-info">
                                    <div class="game-name">角色猜谜</div>
                                    <div class="game-desc">即将推出</div>
                                </div>
                            </div>
                            <div class="game-item coming-soon">
                                <div class="game-icon">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="game-info">
                                    <div class="game-name">互动故事</div>
                                    <div class="game-desc">即将推出</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 照片详情 -->
                <div id="photo-detail-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('photo-detail-screen')">‹</button>
                        <div class="app-title">照片</div>
                    </div>
                    <div class="app-content padding-none-flex">
                        <div class="photo-detail">
                            <div class="photo-image" id="photo-image">
                                <div class="photo-description" id="photo-description-text"></div>
                            </div>
                            <div class="photo-info">
                                <div class="photo-time" id="photo-time"></div>
                                <div class="photo-location" id="photo-location"></div>
                            </div>
                        </div>
                    </div>
                </div>
                

                
                <!-- 设置应用 -->
                <div id="settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('settings-screen')">‹</button>
                        <div class="app-title">设置</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showApp('api-settings-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wifi">
                                    <i class="fas fa-wifi"></i>
                                </div>
                                <div>API设置</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('theme-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon settings-icon-custom">
                                    <i class="fas fa-palette"></i>
                                </div>
                                <div>主题设置</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('display-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-sun"></i>
                                </div>
                                <div>显示与亮度</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('appearance-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon display">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div>
                                    <div class="setting-label">外观设置</div>
                                    <div class="setting-desc">手机边框、尺寸等设置</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('wallpaper-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon wallpaper">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div>壁纸</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('datetime-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon datetime">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>日期与时间</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div class="settings-icon notification">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div>通知</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showApp('about-screen')">
                            <div class="settings-item-left">
                                <div class="settings-icon about">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div>关于我们</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- 日期与时间设置 -->
                <div id="datetime-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('datetime-screen')">‹</button>
                        <div class="app-title">日期与时间</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>自动设置</div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" checked>
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 关于我们 -->
                <div id="about-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('about-screen')">‹</button>
                        <div class="app-title">关于我们</div>
                    </div>
                    <div class="app-content">
                        <div class="about-content">
                            <div class="about-title">iPhone 模拟器</div>
                            <div class="about-version">版本 1.0.0</div>
                            <div class="about-author">作者@EVE</div>
                        </div>
                    </div>
                </div>
                
                <!-- 显示与亮度设置 -->
                <div id="display-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('display-screen')">‹</button>
                        <div class="app-title">显示与亮度</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">自动亮度</div>
                                    <div class="setting-desc">根据环境光线自动调节亮度</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" checked>
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">原彩显示</div>
                                    <div class="setting-desc">根据环境光线调节显示效果</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" checked>
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">夜览</div>
                                    <div class="setting-desc">减少蓝光以改善睡眠</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox">
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 屏幕尺寸设置 -->
                <div id="screen-size-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('screen-size-screen')">‹</button>
                        <div class="app-title">屏幕尺寸</div>
                    </div>
                    <div class="app-content">
                        <div class="size-option" onclick="changeScreenSize(320, 568, 'iPhone SE')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone SE</div>
                                <div class="size-desc">320×568 (小屏模式)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect" style="width: 20px; height: 35px;"></div>
                            </div>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(350, 740, '适中尺寸')" id="size-350-740">
                            <div class="size-option-left">
                                <div class="size-name">适中尺寸</div>
                                <div class="size-desc">350×740 (推荐)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect" style="width: 25px; height: 52px;"></div>
                            </div>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(375, 812, 'iPhone 12/13')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 12/13</div>
                                <div class="size-desc">375×812 (标准)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect" style="width: 27px; height: 58px;"></div>
                            </div>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(390, 844, 'iPhone 15')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15</div>
                                <div class="size-desc">390×844 (真实尺寸)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect" style="width: 28px; height: 60px;"></div>
                            </div>
                        </div>
                        
                        <div class="size-option" onclick="changeScreenSize(428, 926, 'iPhone 15 Plus')">
                            <div class="size-option-left">
                                <div class="size-name">iPhone 15 Plus</div>
                                <div class="size-desc">428×926 (大屏)</div>
                            </div>
                            <div class="size-preview">
                                <div class="size-preview-rect" style="width: 30px; height: 65px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 外观设置 -->
                <div id="appearance-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('appearance-screen')">‹</button>
                        <div class="app-title">外观设置</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">显示手机边框</div>
                                    <div class="setting-desc">显示圆角边框和阴影效果</div>
                                </div>
                            </div>
                            <label class="settings-toggle">
                                <input type="checkbox" id="phone-border-toggle" checked onchange="togglePhoneBorder()">
                                <span class="settings-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item" onclick="showScreenSizeOptions()">
                            <div class="settings-item-left">
                                <div>
                                    <div class="setting-label">屏幕尺寸</div>
                                    <div class="setting-desc" id="current-screen-size">当前：350×740 (适中尺寸)</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- 主题设置界面 -->
                <div id="theme-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('theme-screen')">‹</button>
                        <div class="app-title">主题设置</div>
                    </div>
                    <div class="app-content">
                        <div class="theme-option" onclick="changeTheme('default')">
                            <div class="theme-preview theme-preview-simple">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">简约风格</div>
                                <div class="theme-description">清新简洁的默认主题</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('cute')">
                            <div class="theme-preview theme-preview-cute">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">可爱风格</div>
                                <div class="theme-description">温馨可爱的粉色主题</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('nature')">
                            <div class="theme-preview theme-preview-nature">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">自然风格</div>
                                <div class="theme-description">清新自然的绿色主题</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('tech')">
                            <div class="theme-preview theme-preview-tech">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">科技风格</div>
                                <div class="theme-description">现代科技的蓝色主题</div>
                            </div>
                        </div>
                        
                        <div class="theme-option" onclick="changeTheme('dream')">
                            <div class="theme-preview theme-preview-dream">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content"></div>
                            </div>
                            <div class="theme-info">
                                <div class="theme-name">梦幻风格</div>
                                <div class="theme-description">神秘浪漫的紫色主题</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 壁纸设置 -->
                <div id="wallpaper-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('wallpaper-screen')">‹</button>
                        <div class="app-title">壁纸</div>
                    </div>
                    <div class="app-content">
                        <div class="settings-item" onclick="showWallpaperPicker()">
                            <div class="settings-item-left">
                                <div>选择新壁纸</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="showIconPicker()">
                            <div class="settings-item-left">
                                <div>更改应用图标</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- 无线局域网设置 -->
                <div id="wifi-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="hideApp('wifi-screen')">‹</button>
                        <div class="app-title">无线局域网</div>
                    </div>
                    <div class="app-content">
                        <div class="wifi-settings">
                            <div class="settings-item">
                                <div class="settings-item-left">
                                    <div>无线局域网</div>
                                </div>
                                <label class="settings-toggle">
                                    <input type="checkbox" checked>
                                    <span class="settings-slider"></span>
                                </label>
                            </div>
                            
                            <div class="wifi-network">
                                <div class="wifi-network-left">
                                    <div class="wifi-icon">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div>
                                        <div>HomeWiFi</div>
                                        <div class="wifi-strength">
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                            <div class="wifi-strength-bar active"></div>
                                        </div>
                                    </div>
                                </div>
                                <i class="fas fa-check check-icon"></i>
                            </div>
                            
                            <div class="settings-item settings-item-margin" onclick="showApp('api-settings-screen')">
                                <div class="settings-item-left">
                                    <div>API设置</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- API设置界面 -->
                <div id="api-settings-screen" class="app-screen">
                    <div class="app-status-bar">
                        <div class="app-status-time"></div>
                        <div class="app-battery-container">
                            <span class="battery-text">ᰔᩚ</span>
                            <div class="app-battery-icon">
                                <div class="app-battery-level"></div>
                            </div>
                        </div>
                    </div>
                    <div class="app-header">
                        <button class="back-button" onclick="backToSettings('api-settings-screen')">‹</button>
                        <div class="app-title">API设置</div>
                    </div>
                    <div class="app-content">
                        <div class="api-settings">
                            <div class="api-form-group">
                                <label class="api-form-label">API类型</label>
                                <select class="api-form-select" id="api-type" onchange="onApiTypeChange()">
                                    <option value="openai">OpenAI</option>
                                    <option value="azure">Azure OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="gemini">Google Gemini</option>
                                </select>
                            </div>
                            
                            <div class="api-form-group">
                                <label class="api-form-label">API基地址</label>
                                <input type="text" class="api-form-input" id="api-base" placeholder="https://generativelanguage.googleapis.com/v1beta">
                                <small class="small-desc">
                                    Gemini直连: https://generativelanguage.googleapis.com/v1beta<br>
                                    反代示例: https://your-proxy.com/v1beta
                                </small>
                            </div>
                            
                            <div class="api-form-group" id="endpoint-group">
                                <label class="api-form-label">端点路径</label>
                                <input type="text" class="api-form-input" id="api-endpoint" placeholder="/chat/completions">
                                <small class="small-desc">
                                    仅对OpenAI兼容API有效，Gemini自动处理
                                </small>
                            </div>
                            
                            <div class="api-form-group">
                                <label class="api-form-label">API秘钥</label>
                                <input type="password" class="api-form-input" id="api-key" placeholder="AIzaSy...（Gemini）或 sk-...（OpenAI）">
                                <small class="small-desc">
                                    Gemini: 在Google AI Studio获取API Key<br>
                                    OpenAI: sk-开头的密钥
                                </small>
                            </div>
                            
                            <div class="api-form-group">
                                <label class="api-form-label">模型名称</label>
                                <div class="api-form-flex">
                                    <select class="api-form-select api-select-hidden" id="api-model-select">
                                        <option value="">选择模型...</option>
                                    </select>
                                    <button type="button" id="fetch-models-btn" onclick="fetchModels()" class="fetch-btn">获取模型</button>
                                </div>
                                <input type="text" class="api-form-input" id="api-model" placeholder="gemini-2.0-flash-exp">
                                <small class="small-desc" id="model-hint">
                                    推荐: gemini-2.0-flash-exp (最新), gemini-1.5-pro (稳定)
                                </small>
                            </div>
                            
                            <div class="api-form-group">
                                <label class="api-form-label">温度 (0-2)</label>
                                <input type="range" class="api-form-range" id="api-temperature" min="0" max="2" step="0.01" value="0.70">
                                <span id="temperature-value">0.70</span>
                            </div>
                            

                            
                            <button class="api-form-submit" onclick="saveApiSettings()">保存设置</button>
                            <button class="api-form-submit test-connection-btn" onclick="testApiConnection()">测试连接</button>
                        </div>
                    </div>
                </div>
                
                <!-- 颜色选择器模态框 -->
                <div class="modal" id="color-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title" id="color-picker-title">选择颜色</div>
                            <button class="modal-close" onclick="hideModal('color-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="color-picker" id="color-picker">
                                <div class="color-option color-red" onclick="selectColor('#FF3B30')"></div>
                                <div class="color-option color-orange" onclick="selectColor('#FF9500')"></div>
                                <div class="color-option color-yellow" onclick="selectColor('#FFCC00')"></div>
                                <div class="color-option color-green" onclick="selectColor('#34C759')"></div>
                                <div class="color-option color-light-blue" onclick="selectColor('#5AC8FA')"></div>
                                <div class="color-option color-blue" onclick="selectColor('#007AFF')"></div>
                                <div class="color-option color-purple" onclick="selectColor('#5856D6')"></div>
                                <div class="color-option color-pink" onclick="selectColor('#AF52DE')"></div>
                                <div class="color-option color-red-alt" onclick="selectColor('#FF2D55')"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">透明度</label>
                                <input type="range" class="opacity-slider" id="opacity-slider" min="0" max="1" step="0.1" value="1">
                                <span id="opacity-value">100%</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('color-picker-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="applyColorSelection()">应用</button>
                        </div>
                    </div>
                </div>
                
                <!-- 壁纸选择器模态框 -->
                <div class="modal" id="wallpaper-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">选择壁纸</div>
                            <button class="modal-close" onclick="hideModal('wallpaper-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="wallpaper-preview-container" id="wallpaper-preview-container">
                                <div class="wallpaper-preview-placeholder">
                                    <i class="fas fa-image"></i>
                                    <div>选择本地图片后可在此预览</div>
                                </div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomWallpaper()">
                                <div class="settings-item-left">
                                    <div>从相册选择</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-wallpaper-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('wallpaper-picker-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="applyWallpaperSelection()">应用</button>
                        </div>
                    </div>
                </div>
                
                <!-- 图标选择器模态框 -->
                <div class="modal" id="icon-picker-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">选择应用图标</div>
                            <button class="modal-close" onclick="hideModal('icon-picker-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="icon-options">
                                <div class="icon-option" onclick="selectAppIcon('chat-screen', 'fas fa-comment-dots')">
                                    <div class="icon-preview">
                                        <i class="fas fa-comment-dots"></i>
                                    </div>
                                    <span>Chat</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('weibo-screen', 'fab fa-weibo')">
                                    <div class="icon-preview">
                                        <i class="fab fa-weibo"></i>
                                    </div>
                                    <span>社交网络</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('music-screen', 'fas fa-music')">
                                    <div class="icon-preview">
                                        <i class="fas fa-music"></i>
                                    </div>
                                    <span>音乐</span>
                                </div>
                                <div class="icon-option" onclick="selectAppIcon('album-screen', 'fas fa-images')">
                                    <div class="icon-preview">
                                        <i class="fas fa-images"></i>
                                    </div>
                                    <span>相册</span>
                                </div>
                            </div>
                            <div class="settings-item upload-custom-item" onclick="uploadCustomIcon()">
                                <div class="settings-item-left">
                                    <div>从相册选择</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <input type="file" id="custom-icon-upload" accept="image/*" class="file-input-hidden">
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('icon-picker-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="applyIconSelection()">应用</button>
                        </div>
                    </div>
                </div>
                
                <!-- 照片拍摄模态框 -->
                <div class="modal" id="photo-capture-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">照片详情</div>
                            <button class="modal-close" onclick="hideModal('photo-capture-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">照片描述</label>
                                <input type="text" class="form-input" id="photo-description" placeholder="描述拍摄的内容">
                            </div>
                            <div class="form-group">
                                <label class="form-label">拍摄地点</label>
                                <input type="text" class="form-input" id="photo-location-input" placeholder="输入拍摄地点">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="cancelPhoto()">取消</button>
                            <button class="modal-button modal-primary" onclick="savePhoto()">保存</button>
                        </div>
                    </div>
                </div>
                

                
                <!-- 添加联系人模态框 -->
                <div class="modal" id="add-contact-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">添加联系人</div>
                            <button class="modal-close" onclick="hideModal('add-contact-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="contact-modal-body">
                            <!-- 联系人选项将通过JS动态生成 -->
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('add-contact-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="addSelectedContacts()">添加</button>
                        </div>
                    </div>
                </div>
                
                <!-- 聊天选项模态框 -->
                <div class="modal" id="chat-options-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">选择聊天类型</div>
                            <button class="modal-close" onclick="hideModal('chat-options-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="chat-option-item" onclick="showSingleChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-user icon-user-blue"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">单聊</div>
                                    <div class="chat-option-desc">与单个角色进行对话</div>
                                </div>
                            </div>
                            <div class="chat-option-item" onclick="showGroupChatSelector()">
                                <div class="chat-option-icon">
                                    <i class="fas fa-users icon-users-green"></i>
                                </div>
                                <div class="chat-option-text">
                                    <div class="chat-option-title">群聊</div>
                                    <div class="chat-option-desc">与多个角色同时聊天</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 单聊角色选择模态框 -->
                <div class="modal" id="single-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">选择聊天角色</div>
                            <button class="modal-close" onclick="hideModal('single-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body" id="single-chat-body">
                            <!-- 角色列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 群聊角色选择模态框 -->
                <div class="modal" id="group-chat-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">创建群聊</div>
                            <button class="modal-close" onclick="hideModal('group-chat-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">群聊名称</label>
                                <input type="text" class="form-input" id="group-chat-name" placeholder="例如：朋友圈、工作群">
                            </div>
                            <div class="form-group">
                                <label class="form-label">选择成员 (至少2人，最多8人)</label>
                                <div id="group-chat-members">
                                    <!-- 群聊成员选择将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('group-chat-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="createGroupChat()">创建群聊</button>
                        </div>
                    </div>
                </div>
                
                <!-- 历史消息设置模态框 -->
                <div class="modal" id="history-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">历史消息设置</div>
                            <button class="modal-close" onclick="hideModal('history-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-card">
                                <div class="setting-item">
                                    <div class="setting-left">
                                        <div class="setting-label">附带历史消息数 (回合数)</div>
                                        <div class="setting-desc">AI回复时参考的历史对话回合数</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="history-count-display">5回合</span>
                                    </div>
                                </div>
                                <div class="setting-range-container">
                                    <input type="range" class="theme-range" id="history-messages-count" min="0" max="100" step="1" value="5">
                                    <div class="range-labels">
                                        <span>0回合</span>
                                        <span>100回合</span>
                                    </div>
                                </div>
                                <div class="custom-input-container">
                                    <span class="input-label">自定义数值：</span>
                                    <input type="number" class="theme-input" id="custom-history-count" min="0" max="500" value="5">
                                    <span class="input-unit">回合 (最大500)</span>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>说明：</strong><br>
                                        • 一回合 = 你的一条消息 + AI的一条回复<br>
                                        • 设置为5表示AI回复时会参考最近5轮对话<br>
                                        • 注意：数值过大可能影响API响应速度
                                    </div>
                                </div>
                            </div>
                            
                            <div class="setting-card">
                                <div class="setting-item">
                                    <div class="setting-left">
                                        <div class="setting-label">跨窗口记忆回合数</div>
                                        <div class="setting-desc">从其他聊天窗口读取的背景记忆回合数</div>
                                    </div>
                                    <div class="setting-right">
                                        <span class="setting-value" id="cross-memory-display">3回合</span>
                                    </div>
                                </div>
                                <div class="setting-range-container">
                                    <input type="range" class="theme-range" id="cross-chat-memory" min="0" max="20" step="1" value="3">
                                    <div class="range-labels">
                                        <span>0回合</span>
                                        <span>20回合</span>
                                    </div>
                                </div>
                                <div class="setting-explanation">
                                    <div class="explanation-text">
                                        <strong>说明：</strong><br>
                                        • AI会读取其他聊天窗口中最新的几轮对话作为背景记忆<br>
                                        • 一回合 = 用户一条消息 + AI一条回复<br>
                                        • 帮助AI更好地理解整体对话上下文
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="theme-button theme-button-secondary" onclick="hideModal('history-settings-modal')">取消</button>
                            <button class="theme-button theme-button-primary" onclick="saveHistorySettings()">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 记忆挂载设置模态框 -->
                <div class="modal" id="memory-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">记忆挂载设置</div>
                            <button class="modal-close" onclick="hideModal('memory-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="memory-mount-enabled" class="checkbox-with-margin">
                                    启用记忆挂载
                                </label>
                                <p class="small-text margin-top-5">
                                    开启后，AI会参考其他聊天窗口的对话内容作为背景记忆
                                </p>
                            </div>
                            <div class="form-group hide" id="memory-mount-details">
                                <label class="form-label">每个聊天挂载条数</label>
                                <input type="range" class="api-form-range" id="memory-mount-count" min="1" max="20" step="1" value="3">
                                <div class="flex-space-between">
                                    <span>1条</span>
                                    <span id="memory-mount-display">3条</span>
                                    <span>20条</span>
                                </div>
                            </div>
                            <div class="form-group hide" id="memory-mount-chats">
                                <label class="form-label">选择要挂载的聊天</label>
                                <div id="memory-mount-list" class="max-height-200-auto">
                                    <!-- 聊天列表将通过JS动态生成 -->
                                </div>
                                <p class="small-text margin-top-8">
                                    选择的聊天记录会作为背景信息提供给AI参考
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('memory-mount-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveMemoryMountSettings()">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 头像设置模态框 -->
                <div class="modal" id="avatar-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">双方头像设置</div>
                            <button class="modal-close" onclick="hideModal('avatar-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="avatar-setting-group">
                                <label class="form-label">我的头像 (仅在此聊天窗口生效)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="my-chat-avatar-preview">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <input type="file" id="my-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('my-chat-avatar-upload').click()">上传头像</button>
                                </div>
                            </div>
                            <div class="avatar-setting-group">
                                <label class="form-label">对方头像 (仅在此聊天窗口生效)</label>
                                <div class="avatar-preview-container">
                                    <div class="avatar-preview" id="ai-chat-avatar-preview">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <input type="file" id="ai-chat-avatar-upload" accept="image/*" class="file-input-hidden">
                                    <button class="upload-button" onclick="document.getElementById('ai-chat-avatar-upload').click()">上传头像</button>
                                </div>
                            </div>
                            <div class="form-group margin-top-20">
                                <label class="form-label">
                                    <input type="checkbox" id="hide-avatars" class="checkbox-with-margin">
                                    隐藏双方头像
                                </label>
                                <p class="small-text margin-top-5">
                                    开启后，聊天界面将不显示任何头像
                                </p>
                            </div>
                            <p class="small-text margin-top-15">
                                注意：此设置仅影响当前聊天窗口显示，不会同步修改角色卡或面具设置
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('avatar-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveChatAvatarSettings()">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 昵称设置模态框 -->
                <div class="modal" id="nickname-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">双方备注设置</div>
                            <button class="modal-close" onclick="hideModal('nickname-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">我的昵称 (仅在此聊天中显示)</label>
                                <input type="text" class="form-input" id="my-chat-nickname" placeholder="输入你在此聊天中的昵称">
                            </div>
                            <div class="form-group">
                                <label class="form-label">对方昵称 (仅在此聊天中显示)</label>
                                <input type="text" class="form-input" id="ai-chat-nickname" placeholder="输入对方在此聊天中的昵称">
                            </div>
                            <p class="small-text margin-top-10">
                                注意：此设置仅影响当前聊天窗口显示，不会同步修改角色卡或面具设置。角色也可能根据心情和聊天内容自主修改自己的昵称。
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('nickname-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveChatNicknameSettings()">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 戳一戳后缀设置模态框 -->
                <div class="modal" id="poke-suffix-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">戳一戳后缀设置</div>
                            <button class="modal-close" onclick="hideModal('poke-suffix-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">我的戳一戳后缀</label>
                                <input type="text" class="form-input" id="my-poke-suffix" placeholder="留空为无后缀（例如：的小脸蛋）">
                                <p class="tiny-text margin-top-5">显示为：你戳了戳[角色名][后缀]，留空则显示：你戳了戳[角色名]</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">对方戳一戳后缀</label>
                                <input type="text" class="form-input" id="ai-poke-suffix" placeholder="留空为无后缀（例如：的小手）">
                                <p class="tiny-text margin-top-5">显示为：[角色名]戳了戳你[后缀]，留空则显示：[角色名]戳了戳你。角色可能根据心情自主修改此后缀。</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('poke-suffix-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="savePokeSuffixSettings()">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 聊天背景设置模态框 -->
                <div class="modal" id="background-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">聊天背景设置</div>
                            <button class="modal-close" onclick="hideModal('background-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="background-preview-container">
                                <div class="background-preview" id="chat-background-preview">
                                    <div class="preview-text">背景预览</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="file" id="background-upload" accept="image/*" class="file-input-hidden">
                                <button class="form-button" onclick="document.getElementById('background-upload').click()">选择背景图片</button>
                                <button class="form-button form-button-secondary" onclick="removeBackground()">移除背景</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('background-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveChatBackgroundSettings()">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 气泡样式设置模态框 -->
                <div class="modal" id="bubble-style-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">气泡样式设置</div>
                            <button class="modal-close" onclick="hideModal('bubble-style-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="bubble-style-section">
                                <label class="form-label">选择气泡样式</label>
                                <div class="bubble-style-grid">
                                    <div class="bubble-style-option" data-style="default">
                                        <div class="style-preview">
                                            <div class="preview-bubble sent-preview">默认样式</div>
                                            <div class="preview-bubble received-preview">经典圆角</div>
                                        </div>
                                        <div class="style-name">默认样式</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="glass">
                                        <div class="style-preview bubble-style-glass">
                                            <div class="preview-bubble sent-preview">毛玻璃</div>
                                            <div class="preview-bubble received-preview">半透明</div>
                                        </div>
                                        <div class="style-name">毛玻璃</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="shadow">
                                        <div class="style-preview bubble-style-shadow">
                                            <div class="preview-bubble sent-preview">经典阴影</div>
                                            <div class="preview-bubble received-preview">立体感</div>
                                        </div>
                                        <div class="style-name">经典阴影</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="tail">
                                        <div class="style-preview bubble-style-tail">
                                            <div class="preview-bubble sent-preview">带尖角</div>
                                            <div class="preview-bubble received-preview">气泡戳</div>
                                        </div>
                                        <div class="style-name">经典气泡</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="gradient">
                                        <div class="style-preview bubble-style-gradient">
                                            <div class="preview-bubble sent-preview">渐变色</div>
                                            <div class="preview-bubble received-preview">美观</div>
                                        </div>
                                        <div class="style-name">渐变样式</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="minimal">
                                        <div class="style-preview bubble-style-minimal">
                                            <div class="preview-bubble sent-preview">极简线条</div>
                                            <div class="preview-bubble received-preview">简约</div>
                                        </div>
                                        <div class="style-name">极简样式</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="neon">
                                        <div class="style-preview bubble-style-neon">
                                            <div class="preview-bubble sent-preview">霓虹发光</div>
                                            <div class="preview-bubble received-preview">科技感</div>
                                        </div>
                                        <div class="style-name">霓虹样式</div>
                                    </div>
                                    
                                    <div class="bubble-style-option" data-style="paper">
                                        <div class="style-preview bubble-style-paper">
                                            <div class="preview-bubble sent-preview">纸张卡片</div>
                                            <div class="preview-bubble received-preview">质感</div>
                                        </div>
                                        <div class="style-name">纸张样式</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="color-setting-group">
                                <label class="form-label">自定义颜色</label>
                                <div class="color-picker-container">
                                    <div class="flex-gap-15">
                                        <div class="flex-1">
                                            <label class="label-small">我的气泡</label>
                                            <input type="color" id="my-bubble-color" class="color-input" value="#007AFF">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">对方气泡</label>
                                            <input type="color" id="ai-bubble-color" class="color-input" value="#f0f0f0">
                                        </div>
                                    </div>
                                </div>
                                <div class="opacity-setting">
                                    <div class="flex-gap-15-mb-15">
                                        <div class="flex-1">
                                            <label class="label-small">我的气泡透明度：<span id="my-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="my-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                        <div class="flex-1">
                                            <label class="label-small">对方气泡透明度：<span id="ai-bubble-opacity-value">100%</span></label>
                                            <input type="range" id="ai-bubble-opacity" min="0.1" max="1" step="0.1" value="1" class="width-100">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="padding-setting">
                                    <label class="form-label">气泡大小调节</label>
                                    <div class="flex-gap-15-mb-10">
                                        <div class="flex-1">
                                            <label class="label-small">内边距：<span id="bubble-padding-value">中等</span></label>
                                            <input type="range" id="bubble-padding" min="8" max="20" step="2" value="12" class="width-100">
                                        </div>
                                    </div>
                                    <p class="tiny-text-gray margin-top-5">
                                        调整气泡内文字与边缘的距离，数值越大气泡越大
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('bubble-style-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveBubbleStyleSettings()">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 定时发布设置模态框 -->
                <div class="modal" id="schedule-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">定时发布设置</div>
                            <button class="modal-close" onclick="hideModal('schedule-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="schedule-enabled" class="checkbox-with-margin">
                                    启用定时发布
                                </label>
                                <p class="small-text margin-top-5">
                                    开启后，角色会在指定时间点自动发布社交动态
                                </p>
                            </div>
                            <div class="form-group hide" id="schedule-times-group">
                                <label class="form-label">发布时间点</label>
                                <div id="schedule-times-container">
                                    <!-- 时间点将通过JS动态添加 -->
                                </div>
                                <button type="button" class="form-button form-button-secondary" onclick="addScheduleTime()">+ 添加时间点</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('schedule-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveScheduleSettings()">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- 身份选择器模态框 -->
                <div class="modal" id="identity-selector-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">选择聊天身份</div>
                            <button class="modal-close" onclick="hideModal('identity-selector-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="identity-selector-list">
                                <!-- 身份列表将通过JS动态生成 -->
                            </div>
                            <p class="small-text margin-top-15">
                                选择的身份会影响此聊天窗口中显示的头像和昵称，不会影响原始面具设置
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('identity-selector-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveChatIdentity()">确定</button>
                        </div>
                    </div>
                </div>
                
                <!-- 世界书挂载设置模态框 -->
                <div class="modal" id="worldbook-mount-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">世界书挂载设置</div>
                            <button class="modal-close" onclick="hideModal('worldbook-mount-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="worldbook-mount-enabled" class="checkbox-with-margin">
                                    启用世界书挂载
                                </label>
                                <p class="small-text margin-top-5">
                                    开启后，AI会参考选定的世界书内容作为背景知识进行对话
                                </p>
                            </div>
                            <div class="form-group hide" id="worldbook-mount-details">
                                <label class="form-label">选择要挂载的世界书</label>
                                <div id="worldbook-mount-list" class="max-height-300-auto">
                                    <!-- 世界书列表将通过JS动态生成 -->
                                </div>
                                <p class="small-text margin-top-8">
                                    选择的世界书内容会作为背景知识提供给AI参考，帮助AI更好地理解对话上下文
                                </p>
                            </div>
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>功能说明：</strong><br>
                                    • <strong>世界书挂载：</strong>将选定的世界书内容作为AI的背景知识<br>
                                    • <strong>多选支持：</strong>可以同时挂载多个世界书，内容会合并使用<br>
                                    • <strong>智能应用：</strong>AI会根据对话内容智能引用相关的世界书知识<br>
                                    • <strong>优先级：</strong>世界书知识优先级低于角色设定和历史对话
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('worldbook-mount-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveWorldbookMountSettings()">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 时间戳设置模态框 -->
                <div class="modal" id="timestamp-settings-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">时间戳设置</div>
                            <button class="modal-close" onclick="hideModal('timestamp-settings-modal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="timestamp-modal-enabled" class="checkbox-with-margin" checked>
                                    显示时间戳
                                </label>
                                <p class="small-text margin-top-5">
                                    在聊天消息中显示时间信息
                                </p>
                            </div>
                            
                            <div class="form-group" id="timestamp-options-group">
                                <label class="form-label">时间戳位置</label>
                                <div class="timestamp-position-options">
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="center" checked>
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">居中显示</div>
                                            <div class="option-desc">时间戳显示在聊天中间，每5分钟出现一次</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="bubble">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">气泡外侧</div>
                                            <div class="option-desc">时间戳显示在每条消息气泡的外侧</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="avatar">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">头像下方</div>
                                            <div class="option-desc">时间戳显示在头像正下方位置</div>
                                        </div>
                                    </label>
                                    
                                    <label class="radio-option">
                                        <input type="radio" name="timestamp-position" value="inside">
                                        <span class="radio-custom"></span>
                                        <div class="option-content">
                                            <div class="option-label">气泡内</div>
                                            <div class="option-desc">时间戳显示在气泡内右下角，与文字齐平</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="setting-explanation">
                                <div class="explanation-text">
                                    <strong>位置说明：</strong><br>
                                    • <strong>居中显示：</strong>时间戳水平居中，仅在超过5分钟间隔时显示<br>
                                    • <strong>气泡外侧：</strong>每条消息都显示时间，用户消息在左下角，角色消息在右下角<br>
                                    • <strong>头像下方：</strong>时间戳显示在对应头像的正下方位置<br>
                                    • 所有时间戳均使用灰色小字显示，不影响聊天体验
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-secondary" onclick="hideModal('timestamp-settings-modal')">取消</button>
                            <button class="modal-button modal-primary" onclick="saveTimestampSettings()">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // 初始化Dexie数据库
        const db = new Dexie('PhoneChatDB');
        db.version(1).stores({
            characters: '&id, name',
            contacts: '&id, characterId', 
            chatMessages: '&id, characterId, timestamp',
            apiSettings: '&id',
            customEmojis: '&id, description',
            photos: '&id, timestamp',
            wallpapers: '&id, type',
            worldbooks: '&id, name',
            groupChats: '&id, name',
            personas: '&id, name',
            globalSettings: '&id',
            appIcons: '&id, appId'
        });

        // 全局变量
        let characters = [];
        let contacts = [];
        let currentChatCharacter = null;
        let chatMessages = {};
        let selectedMessageId = null;
        let personas = []; // 用户面具列表
        let currentPersona = null; // 当前使用的面具
        let editingPersona = null; // 正在编辑的面具
        let isMultiSelectMode = false; // 多选模式状态
        let selectedCharacters = []; // 选中的角色ID列表
        let currentEditingCharacterId = null; // 当前正在编辑的角色ID
        let groupChats = []; // 群聊列表
        let selectedGroupMembers = []; // 群聊成员选择
        
        // 自定义表情包相关变量
        let customEmojis = []; // 用户上传的表情包
        let recentEmojis = []; // 最近使用的表情包
        let currentEmojiTab = 'recent'; // 当前表情包标签页
        
        // 消息多选删除相关变量
        let isMessageSelectionMode = false; // 消息选择模式
        let selectedMessages = new Set(); // 选中的消息ID集合
        
        let apiSettings = {
            type: 'openai',
            base: 'https://api.openai.com/v1',
            endpoint: '/chat/completions',
            key: '',
            model: 'gpt-3.5-turbo',
            temperature: 0.70
        };
        
        // 注意：记忆设置现在已改为每个聊天窗口独立的设置，存储在各自的聊天设置中
        
        let chatSettings = {
            themeColor: '#007AFF',
            theirBubbleColor: '#f0f0f0',
            myBubbleColor: '#007AFF',
            bubbleOpacity: 1,
            timestampEnabled: true,
            timestampPosition: 'center'
        };
        
        let photos = [];
        let selectedAppIcon = null;
        let selectedWallpaper = null;
        let colorPickerContext = null;
        let customIconImage = null;
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', async function() {
            updateTime();
            
            // 并行加载所有数据
            await Promise.all([
                loadCharacters(),
                loadContacts(), 
                loadChatMessages(),
                loadPhotos(),
                loadChatSettings(),
                loadApiSettings(),
                loadCustomEmojis()
            ]);
            
            // 加载外观设置
            loadPhoneBorderSetting();
            loadScreenSize();
            
            // 加载其他设置（包括需要数据库的壁纸设置）
            await loadWallpaper();
            await loadAppIcons();
            loadSavedTheme();
            await loadWorldbooks();
            loadMusicData();
            await loadPersonas();
            await loadGroupChats();
            
            // 渲染界面
            renderMessageList();
            renderContactList();
            renderCharacterList();
            renderPersonaList();
            
            // 初始化时设置正确的按钮显示状态 - 延迟执行确保DOM加载完成
            setTimeout(() => {
                switchWechatTab('message-list');
                // 确保app标题有chat-mode类和正确内容
                const appTitle = document.querySelector('#chat-screen .app-title');
                if (appTitle) {
                    appTitle.classList.add('chat-mode');
                    appTitle.textContent = '💬';
                }
                initializeChatSettings(); // 初始化聊天设置界面
                updateWorldbookMountDisplay(); // 更新世界书挂载显示
            }, 100);
            
            // 温度滑块显示
            document.getElementById('api-temperature').addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = parseFloat(this.value).toFixed(2);
            });
            
            // Gemini模型选择同步
            document.getElementById('api-model-select').addEventListener('change', function() {
                document.getElementById('api-model').value = this.value;
            });
            
            // 透明度滑块显示
            document.getElementById('opacity-slider').addEventListener('input', function() {
                document.getElementById('opacity-value').textContent = Math.round(this.value * 100) + '%';
            });
            
            // 按Enter键发送消息
            document.getElementById('api-chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendApiMessage();
                }
            });
            
            // 初始化头像上传功能
            initializeAvatarUpload();
            
            // 初始化表情包上传功能
            initializeEmojiUpload();
            
            // 初始化消息选择模式状态
            isMessageSelectionMode = false;
            selectedMessages.clear();
            
            // 图片上传
            document.getElementById('image-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // 检查文件类型，GIF格式不被Gemini API支持
                    if (file.type === 'image/gif') {
                        alert('抱歉，Gemini API 不支持 GIF 格式的图片。\n\n请选择其他格式的图片，如：\n• JPEG\n• PNG\n• WEBP');
                        // 清空文件选择器
                        e.target.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        sendImageMessage(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // 自定义壁纸上传
            document.getElementById('custom-wallpaper-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        selectedWallpaper = event.target.result;
                        
                        // 更新预览容器
                        const previewContainer = document.getElementById('wallpaper-preview-container');
                        if (previewContainer) {
                            previewContainer.innerHTML = `<img src="${selectedWallpaper}" class="wallpaper-preview-image" alt="壁纸预览">`;
                        }
                        
                        // 不在这里立即应用到主界面，等用户点击应用时再应用
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // 自定义图标上传
            document.getElementById('custom-icon-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        customIconImage = event.target.result;
                        // 更新预览
                        const previews = document.querySelectorAll('.icon-preview');
                        previews.forEach(preview => {
                            preview.style.backgroundImage = `url(${customIconImage})`;
                            preview.innerHTML = ''; // 移除图标
                        });
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            setInterval(updateTime, 1000);
            initBatteryManager();
        });
        
        // 显示/隐藏应用
        function showApp(appId) {
            if (event) event.preventDefault();
            
            // 隐藏所有app界面
            const allApps = document.querySelectorAll('.app-screen');
            allApps.forEach(app => {
                app.style.display = 'none';
            });
            
            // 显示目标界面
            document.getElementById(appId).style.display = 'flex';
            
            // 如果是聊天界面，刷新消息列表
            if (appId === 'chat-screen') {
                renderMessageList();
            }
        }
        

        
        // 隐藏角色创建表单，返回到chat界面的通讯录
        function hideCharacterForm() {
            // 在隐藏表单时清空表单数据
            clearCharacterForm();
            
            hideApp('character-form-screen');
            showApp('chat-screen');
            switchWechatTab('contact-list');
            // 手动触发标签切换的样式
            const wechatTabs = document.querySelectorAll('.wechat-tab');
            wechatTabs.forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });
            // 安全地添加active类到第二个标签（通讯录）
            if (wechatTabs.length > 1 && wechatTabs[1] && wechatTabs[1].classList) {
                wechatTabs[1].classList.add('active');
            }
        }
        
        function hideApp(appId) {
            document.getElementById(appId).style.display = 'none';
        }
        
        // 显示/隐藏模态框
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            
            // 如果是添加联系人模态框，渲染可选联系人
            if (modalId === 'add-contact-modal') {
                renderContactModal();
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // 切换微信标签
        function switchWechatTab(tabId) {
            // 移除所有标签的active类
            document.querySelectorAll('.wechat-tab').forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });
            
            // 添加当前标签的active类
            if (event && event.currentTarget && event.currentTarget.classList) {
                event.currentTarget.classList.add('active');
            } else {
                // 如果没有event对象，根据tabId设置active
                if (tabId === 'message-list') {
                    const messageTab = document.getElementById('message-tab');
                    if (messageTab && messageTab.classList) {
                        messageTab.classList.add('active');
                    }
                } else if (tabId === 'contact-list') {
                    const tabs = document.querySelectorAll('.wechat-tab');
                    if (tabs.length > 1 && tabs[1] && tabs[1].classList) {
                        tabs[1].classList.add('active');
                    }
                } else if (tabId === 'moments-page') {
                    const tabs = document.querySelectorAll('.wechat-tab');
                    if (tabs.length > 2 && tabs[2] && tabs[2].classList) {
                        tabs[2].classList.add('active');
                    }
                } else if (tabId === 'profile-page') {
                    const tabs = document.querySelectorAll('.wechat-tab');
                    if (tabs.length > 3 && tabs[3] && tabs[3].classList) {
                        tabs[3].classList.add('active');
                    }
                }
            }
            
            // 隐藏所有内容
            const messageListEl = document.getElementById('message-list');
            const contactListEl = document.getElementById('contact-list');
            const profilePageEl = document.getElementById('profile-page');
            const momentsPageEl = document.getElementById('moments-page');
            const targetEl = document.getElementById(tabId);
            
            if (messageListEl) messageListEl.style.display = 'none';
            if (contactListEl) contactListEl.style.display = 'none';
            if (profilePageEl) profilePageEl.style.display = 'none';
            if (momentsPageEl) momentsPageEl.style.display = 'none';
            
            // 显示选中的内容
            if (targetEl) targetEl.style.display = 'block';
            
            // 控制app标题的渐变效果和内容
            const appTitle = document.querySelector('#chat-screen .app-title');
            if (appTitle) {
                if (tabId === 'message-list') {
                    appTitle.classList.add('chat-mode');
                    appTitle.textContent = '💬';
                } else if (tabId === 'contact-list') {
                    appTitle.classList.remove('chat-mode');
                    appTitle.textContent = '角色';
                } else if (tabId === 'moments-page') {
                    appTitle.classList.remove('chat-mode');
                    appTitle.textContent = '朋友圈';
                } else if (tabId === 'profile-page') {
                    appTitle.classList.remove('chat-mode');
                    appTitle.textContent = '我';
                }
            }
            
            // 控制加号按钮显示
            const addContactBtn = document.getElementById('add-contact-btn');
            const addChatBtn = document.getElementById('add-chat-btn');
            
            if (addContactBtn && addChatBtn) {
                if (tabId === 'contact-list') {
                    addContactBtn.style.display = 'flex';
                    addChatBtn.style.display = 'none';
                } else if (tabId === 'message-list') {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'flex';
                } else {
                    addContactBtn.style.display = 'none';
                    addChatBtn.style.display = 'none';
                }
            }
            
            // 如果是动态页面，加载动态内容
            if (tabId === 'moments-page') {
                loadMoments();
            }
        }
        
        // 更新时间
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            // 更新状态栏时间
            const statusTime = document.getElementById('status-bar-time');
            if (statusTime) {
                statusTime.textContent = timeString;
            }
            
            // 更新应用内状态栏时间
            const appStatusTimes = document.querySelectorAll('.app-status-time');
            appStatusTimes.forEach(element => {
                element.textContent = timeString;
            });
            
            // 更新主时钟
            const mainTime = document.getElementById('main-time');
            if (mainTime) {
                mainTime.textContent = timeString;
            }
            
            // 更新日期
            const mainDate = document.getElementById('main-date');
            if (mainDate) {
                const date = now.toLocaleDateString('zh-CN', { 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                });
                mainDate.textContent = date;
            }
        }
        
        // 加载角色数据 - 使用IndexedDB（包含数据迁移）
        async function loadCharacters() {
            try {
                // 先检查IndexedDB中是否有数据
                const savedCharacters = await db.characters.toArray();
                
                if (savedCharacters.length === 0) {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localStorageData = localStorage.getItem('characters');
                    if (localStorageData) {
                        console.log('检测到localStorage中的角色数据，开始迁移...');
                        const localCharacters = JSON.parse(localStorageData);
                        
                        if (localCharacters.length > 0) {
                            // 迁移数据到IndexedDB
                            await db.characters.bulkAdd(localCharacters);
                            characters = localCharacters;
                            console.log('角色数据迁移完成:', characters);
                            // 可选：清除localStorage中的旧数据
                            // localStorage.removeItem('characters');
                        } else {
                            characters = [];
                        }
                    } else {
                        characters = [];
                    }
                } else {
                    // IndexedDB中有数据，直接使用
                    characters = savedCharacters;
                    console.log('从IndexedDB加载角色数据:', characters);
                }
            } catch (error) {
                console.error('加载角色数据失败:', error);
                // 如果IndexedDB失败，尝试从localStorage加载
                const localStorageData = localStorage.getItem('characters');
                if (localStorageData) {
                    characters = JSON.parse(localStorageData);
                    console.log('从localStorage备份加载角色数据:', characters);
                } else {
                    characters = [];
                }
            }
        }
        
        // 保存角色数据 - 使用IndexedDB
        async function saveCharacters() {
            try {
                console.log('保存角色数据到IndexedDB:', characters);
                
                // 清空现有数据
                await db.characters.clear();
                
                // 批量插入新数据
                if (characters.length > 0) {
                    await db.characters.bulkAdd(characters);
                }
                
                console.log('角色数据保存成功');
            } catch (error) {
                console.error('保存角色时发生错误:', error);
                alert('保存角色时发生错误: ' + error.message);
                throw error;
            }
        }
        
        // 显示存储使用情况
        function showStorageUsage() {
            const usage = [];
            
            // 计算各种数据的大小
            const characters = localStorage.getItem('characters') || '[]';
            const chatMessages = localStorage.getItem('chatMessages') || '{}';
            const photos = localStorage.getItem('photos') || '[]';
            const customEmojis = localStorage.getItem('customEmojis') || '[]';
            
            usage.push(`角色数据: ${(characters.length / 1024).toFixed(1)} KB`);
            usage.push(`聊天记录: ${(chatMessages.length / 1024).toFixed(1)} KB`);
            usage.push(`照片数据: ${(photos.length / 1024).toFixed(1)} KB`);
            usage.push(`表情包: ${(customEmojis.length / 1024).toFixed(1)} KB`);
            
            const total = characters.length + chatMessages.length + photos.length + customEmojis.length;
            usage.push(`总计: ${(total / 1024).toFixed(1)} KB`);
            
            console.log('存储使用情况:\n' + usage.join('\n'));
            alert('存储使用情况:\n' + usage.join('\n'));
        }
        
        // 加载联系人数据 - 使用IndexedDB（包含数据迁移）
        async function loadContacts() {
            try {
                const savedContacts = await db.contacts.toArray();
                
                if (savedContacts.length === 0) {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localStorageData = localStorage.getItem('contacts');
                    if (localStorageData) {
                        console.log('检测到localStorage中的联系人数据，开始迁移...');
                        const localContacts = JSON.parse(localStorageData);
                        
                        if (localContacts.length > 0) {
                            const contactArray = localContacts.map((contactId, index) => ({
                                id: index,
                                characterId: contactId
                            }));
                            await db.contacts.bulkAdd(contactArray);
                        }
                        
                        contacts = localContacts;
                        console.log('联系人数据迁移完成:', contacts);
                    } else {
                        contacts = [];
                    }
                } else {
                    contacts = savedContacts.map(contact => contact.characterId);
                    console.log('从IndexedDB加载联系人:', contacts);
                }
            } catch (error) {
                console.error('加载联系人失败:', error);
                // 如果IndexedDB失败，尝试从localStorage加载
                const localStorageData = localStorage.getItem('contacts');
                if (localStorageData) {
                    contacts = JSON.parse(localStorageData);
                    console.log('从localStorage备份加载联系人:', contacts);
                } else {
                    contacts = [];
                }
            }
        }
        
        // 保存联系人数据 - 使用IndexedDB
        async function saveContacts() {
            try {
                await db.contacts.clear();
                const contactArray = contacts.map((contactId, index) => ({
                    id: index,
                    characterId: contactId
                }));
                if (contactArray.length > 0) {
                    await db.contacts.bulkAdd(contactArray);
                }
            } catch (error) {
                console.error('保存联系人失败:', error);
            }
        }
        
        // 加载聊天消息 - 使用IndexedDB（包含数据迁移）
        async function loadChatMessages() {
            try {
                const savedMessages = await db.chatMessages.toArray();
                chatMessages = {};
                
                if (savedMessages.length === 0) {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localStorageData = localStorage.getItem('chatMessages');
                    if (localStorageData) {
                        console.log('检测到localStorage中的聊天数据，开始迁移...');
                        const localMessages = JSON.parse(localStorageData);
                        
                        // 将对象格式转换为数组格式存储到IndexedDB
                        const messageArray = [];
                        for (const [characterId, messages] of Object.entries(localMessages)) {
                            for (const message of messages) {
                                messageArray.push({
                                    id: `${characterId}_${message.id || message.timestamp}`,
                                    characterId: characterId,
                                    timestamp: message.timestamp,
                                    messageData: message
                                });
                            }
                        }
                        
                        if (messageArray.length > 0) {
                            await db.chatMessages.bulkAdd(messageArray);
                        }
                        
                        chatMessages = localMessages;
                        console.log('聊天消息迁移完成:', chatMessages);
                    }
                } else {
                    // 将数组格式转换回对象格式
                    for (const msgRecord of savedMessages) {
                        const characterId = msgRecord.characterId;
                        if (!chatMessages[characterId]) {
                            chatMessages[characterId] = [];
                        }
                        chatMessages[characterId].push(msgRecord.messageData);
                    }
                    
                    // 按时间戳排序
                    for (const characterId in chatMessages) {
                        chatMessages[characterId].sort((a, b) => a.timestamp - b.timestamp);
                    }
                    
                    console.log('从IndexedDB加载聊天消息:', chatMessages);
                }
            } catch (error) {
                console.error('加载聊天消息失败:', error);
                // 如果IndexedDB失败，尝试从localStorage加载
                const localStorageData = localStorage.getItem('chatMessages');
                if (localStorageData) {
                    chatMessages = JSON.parse(localStorageData);
                    console.log('从localStorage备份加载聊天消息:', chatMessages);
                } else {
                    chatMessages = {};
                }
            }
        }
        
        // 防抖保存计时器
        let saveMessagesTimer = null;
        let isSaving = false; // 防止并发保存
        
        // 防抖版本的保存函数
        function saveChatMessages() {
            // 清除之前的计时器
            if (saveMessagesTimer) {
                clearTimeout(saveMessagesTimer);
            }
            
            // 设置新的计时器，500ms后执行保存
            saveMessagesTimer = setTimeout(async () => {
                if (isSaving) {
                    console.log('正在保存中，跳过此次保存请求');
                    return;
                }
                await saveChatMessagesImmediate();
            }, 500);
        }
        
        // 立即保存聊天消息 - 使用IndexedDB
        async function saveChatMessagesImmediate() {
            if (isSaving) {
                console.log('保存操作正在进行中，跳过');
                return;
            }
            
            isSaving = true;
            
            try {
                console.log('保存聊天消息到IndexedDB');
                
                // 将chatMessages对象转换为数组格式存储
                const messageArray = [];
                let globalSequentialId = 0; // 全局顺序ID确保唯一性
                const usedIds = new Set(); // 用于检测ID重复
                
                for (const [characterId, messages] of Object.entries(chatMessages)) {
                    for (let i = 0; i < messages.length; i++) {
                        const message = messages[i];
                        
                        // 生成唯一的主键
                        let uniqueId = `${characterId}_${globalSequentialId++}`;
                        
                        // 确保ID绝对唯一
                        while (usedIds.has(uniqueId)) {
                            uniqueId = `${characterId}_${globalSequentialId++}`;
                        }
                        usedIds.add(uniqueId);
                        
                        messageArray.push({
                            id: uniqueId,
                            characterId: characterId,
                            timestamp: message.timestamp,
                            messageOrder: i,
                            originalMessageId: message.id, // 保留原始消息ID作为数据
                            messageData: message
                        });
                    }
                }
                
                // 清空现有消息
                await db.chatMessages.clear();
                
                // 批量插入新消息
                if (messageArray.length > 0) {
                    await db.chatMessages.bulkAdd(messageArray);
                }
                
                console.log('聊天消息保存成功，共保存', messageArray.length, '条消息');
            } catch (error) {
                console.error('保存聊天消息失败:', error);
                
                // 如果批量保存失败，使用简化的重试机制
                try {
                    console.log('使用简化保存策略重试...');
                    await db.chatMessages.clear();
                    
                    // 只保存最近的1000条消息，避免过大的数据集
                    const messageArray = [];
                    let globalSequentialId = 0;
                    let totalMessages = 0;
                    
                    // 先计算总消息数
                    for (const messages of Object.values(chatMessages)) {
                        totalMessages += messages.length;
                    }
                    
                    const maxMessages = 1000;
                    const skipCount = Math.max(0, totalMessages - maxMessages);
                    let currentSkip = 0;
                    
                    for (const [characterId, messages] of Object.entries(chatMessages)) {
                        for (let i = 0; i < messages.length; i++) {
                            if (currentSkip < skipCount) {
                                currentSkip++;
                                continue;
                            }
                            
                            const message = messages[i];
                            messageArray.push({
                                id: `${characterId}_${globalSequentialId++}`,
                                characterId: characterId,
                                timestamp: message.timestamp,
                                messageOrder: i,
                                originalMessageId: message.id,
                                messageData: message
                            });
                        }
                    }
                    
                    if (messageArray.length > 0) {
                        await db.chatMessages.bulkAdd(messageArray);
                    }
                    
                    console.log('简化保存成功，保存了', messageArray.length, '条消息');
                } catch (fallbackError) {
                    console.error('简化保存也失败:', fallbackError);
                }
            } finally {
                isSaving = false;
            }
        }
        
        // 加载照片 - 使用IndexedDB（包含数据迁移）
        async function loadPhotos() {
            try {
                const savedPhotos = await db.photos.toArray();
                
                if (savedPhotos.length === 0) {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localStorageData = localStorage.getItem('photos');
                    if (localStorageData) {
                        console.log('检测到localStorage中的照片数据，开始迁移...');
                        const localPhotos = JSON.parse(localStorageData);
                        
                        if (localPhotos.length > 0) {
                            await db.photos.bulkAdd(localPhotos);
                        }
                        
                        photos = localPhotos;
                        console.log('照片数据迁移完成:', photos);
                    } else {
                        photos = [];
                    }
                } else {
                    photos = savedPhotos;
                    console.log('从IndexedDB加载照片:', photos);
                }
            } catch (error) {
                console.error('加载照片失败:', error);
                // 如果IndexedDB失败，尝试从localStorage加载
                const localStorageData = localStorage.getItem('photos');
                if (localStorageData) {
                    photos = JSON.parse(localStorageData);
                    console.log('从localStorage备份加载照片:', photos);
                } else {
                    photos = [];
                }
            }
        }
        
        // 保存照片 - 使用IndexedDB
        async function savePhotos() {
            try {
                await db.photos.clear();
                if (photos.length > 0) {
                    await db.photos.bulkAdd(photos);
                }
            } catch (error) {
                console.error('保存照片失败:', error);
            }
        }
        
        // 加载聊天设置 - 暂时仍使用localStorage
        function loadChatSettings() {
            const savedSettings = localStorage.getItem('chatSettings');
            if (savedSettings) {
                chatSettings = JSON.parse(savedSettings);
            }
        }
        
        // 保存聊天设置
        function saveChatSettings() {
            localStorage.setItem('chatSettings', JSON.stringify(chatSettings));
        }
        


        // 加载壁纸 - 使用IndexedDB（包含数据迁移）
        async function loadWallpaper() {
            try {
                // 先从IndexedDB加载
                const savedWallpaper = await db.wallpapers.get('main');
                
                if (savedWallpaper) {
                    selectedWallpaper = savedWallpaper.data;
                    
                    if (savedWallpaper.type === 'image' && savedWallpaper.data.startsWith('data:image')) {
                        // 加载上传的图片
                        document.querySelector('.wallpaper').style.backgroundImage = `url(${savedWallpaper.data})`;
                    } else if (savedWallpaper.type === 'gradient' || savedWallpaper.data.startsWith('linear-gradient')) {
                        // 加载渐变背景
                        document.querySelector('.wallpaper').style.backgroundImage = savedWallpaper.data;
                    } else {
                        // 加载纯色背景
                        document.querySelector('.wallpaper').style.backgroundColor = savedWallpaper.data;
                        document.querySelector('.wallpaper').style.backgroundImage = 'none';
                    }
                    
                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                } else {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localWallpaper = localStorage.getItem('wallpaper');
                    const wallpaperType = localStorage.getItem('wallpaperType');
                    
                    if (localWallpaper) {
                        console.log('检测到localStorage中的壁纸数据，开始迁移...');
                        selectedWallpaper = localWallpaper;
                        
                        // 迁移到IndexedDB
                        await db.wallpapers.add({
                            id: 'main',
                            type: wallpaperType || 'gradient',
                            data: localWallpaper
                        });
                        
                        if (wallpaperType === 'image' && localWallpaper.startsWith('data:image')) {
                            document.querySelector('.wallpaper').style.backgroundImage = `url(${localWallpaper})`;
                        } else if (wallpaperType === 'gradient' || localWallpaper.startsWith('linear-gradient')) {
                            document.querySelector('.wallpaper').style.backgroundImage = localWallpaper;
                        } else {
                            document.querySelector('.wallpaper').style.backgroundColor = localWallpaper;
                            document.querySelector('.wallpaper').style.backgroundImage = 'none';
                        }
                        
                        document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                        document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                        
                        console.log('壁纸数据迁移完成');
                    }
                }
            } catch (error) {
                console.error('加载壁纸失败:', error);
                // 如果IndexedDB失败，回退到localStorage
                const localWallpaper = localStorage.getItem('wallpaper');
                const wallpaperType = localStorage.getItem('wallpaperType');
                
                if (localWallpaper) {
                    selectedWallpaper = localWallpaper;
                    
                    if (wallpaperType === 'image' && localWallpaper.startsWith('data:image')) {
                        document.querySelector('.wallpaper').style.backgroundImage = `url(${localWallpaper})`;
                    } else if (wallpaperType === 'gradient' || localWallpaper.startsWith('linear-gradient')) {
                        document.querySelector('.wallpaper').style.backgroundImage = localWallpaper;
                    } else {
                        document.querySelector('.wallpaper').style.backgroundColor = localWallpaper;
                        document.querySelector('.wallpaper').style.backgroundImage = 'none';
                    }
                    
                    document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                    document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                }
            }
        }
        
        // 加载应用图标 - 使用IndexedDB（包含数据迁移）
        async function loadAppIcons() {
            try {
                // 先从IndexedDB加载
                const savedIcons = await db.appIcons.toArray();
                
                if (savedIcons.length === 0) {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localStorageData = localStorage.getItem('appIcons');
                    if (localStorageData) {
                        console.log('检测到localStorage中的应用图标数据，开始迁移...');
                        const localIcons = JSON.parse(localStorageData);
                        
                        // 转换为数组格式存储到IndexedDB
                        const iconArray = Object.keys(localIcons).map(appId => ({
                            id: appId,
                            appId: appId,
                            iconClass: localIcons[appId]
                        }));
                        
                        if (iconArray.length > 0) {
                            await db.appIcons.bulkAdd(iconArray);
                            console.log('应用图标数据迁移完成:', iconArray);
                        }
                        
                        // 应用图标
                        Object.keys(localIcons).forEach(appId => {
                            const iconElement = document.querySelector(`.app[onclick="showApp('${appId}')"] .app-icon i`);
                            if (iconElement) {
                                iconElement.className = localIcons[appId];
                            }
                        });
                    }
                } else {
                    // IndexedDB中有数据，直接使用
                    console.log('从IndexedDB加载应用图标数据:', savedIcons);
                    savedIcons.forEach(iconData => {
                        const iconElement = document.querySelector(`.app[onclick="showApp('${iconData.appId}')"] .app-icon i`);
                        if (iconElement) {
                            iconElement.className = iconData.iconClass;
                        }
                    });
                }
            } catch (error) {
                console.error('加载应用图标失败:', error);
                // 如果IndexedDB失败，回退到localStorage
                const localStorageData = localStorage.getItem('appIcons');
                if (localStorageData) {
                    const icons = JSON.parse(localStorageData);
                    Object.keys(icons).forEach(appId => {
                        const iconElement = document.querySelector(`.app[onclick="showApp('${appId}')"] .app-icon i`);
                        if (iconElement) {
                            iconElement.className = icons[appId];
                        }
                    });
                }
            }
        }
        
        // 加载API设置
        function loadApiSettings() {
            const savedSettings = localStorage.getItem('apiSettings');
            if (savedSettings) {
                apiSettings = JSON.parse(savedSettings);
                
                // 更新表单显示
                if (document.getElementById('api-type')) {
                    const apiType = apiSettings.type || 'openai';
                    document.getElementById('api-type').value = apiType;
                    document.getElementById('api-base').value = apiSettings.base || (apiType === 'gemini' ? 'https://generativelanguage.googleapis.com/v1beta' : 'https://api.openai.com/v1');
                    document.getElementById('api-endpoint').value = apiSettings.endpoint || '/chat/completions';
                    document.getElementById('api-key').value = apiSettings.key || '';
                    
                    // 处理模型设置
                    if (apiType === 'gemini') {
                        document.getElementById('api-model-select').value = apiSettings.model || 'gemini-2.0-flash-exp';
                        document.getElementById('api-model').value = apiSettings.model || 'gemini-2.0-flash-exp';
                    } else {
                        document.getElementById('api-model').value = apiSettings.model || 'gpt-3.5-turbo';
                    }
                    
                    document.getElementById('api-temperature').value = apiSettings.temperature || 0.70;
                    document.getElementById('temperature-value').textContent = (apiSettings.temperature || 0.70).toFixed(2);
                    
                    // 处理最大token数设置

                    
                    // 触发API类型变化处理，确保界面正确显示
                    onApiTypeChange();
                }
            } else {
                            // 如果没有保存的设置，使用默认值
            apiSettings = {
                type: 'gemini',
                base: 'https://generativelanguage.googleapis.com/v1beta',
                endpoint: '/chat/completions',
                key: '',
                model: 'gemini-2.0-flash-exp',
                temperature: 0.70
            };
            
            // 确保界面元素正确显示
            if (document.getElementById('api-type')) {
                document.getElementById('api-type').value = 'gemini';
                document.getElementById('api-base').value = 'https://generativelanguage.googleapis.com/v1beta';
                document.getElementById('api-endpoint').value = '/chat/completions';
                document.getElementById('api-key').value = '';
                document.getElementById('api-model').value = 'gemini-2.0-flash-exp';
                document.getElementById('api-temperature').value = 0.70;
                document.getElementById('temperature-value').textContent = '0.70';
                
                // 触发API类型变化处理
                onApiTypeChange();
            }
            }
        }
        
        // 保存应用图标 - 使用IndexedDB
        async function saveAppIcons() {
            try {
                console.log('保存应用图标数据到IndexedDB...');
                
                const defaultIcons = {
                    'chat-screen': 'fas fa-comment-dots',
                    'forum-screen': 'fas fa-comments',
                    'music-screen': 'fas fa-music',
                    'game-screen': 'fas fa-gamepad',
                    'characters-screen': 'fas fa-user-friends',
                    'shop-screen': 'fas fa-shopping-bag',
                    'settings-screen': 'fas fa-cog'
                };
                
                if (selectedAppIcon) {
                    defaultIcons[selectedAppIcon.appId] = selectedAppIcon.iconClass;
                }
                
                // 转换为数组格式
                const iconArray = Object.keys(defaultIcons).map(appId => ({
                    id: appId,
                    appId: appId,
                    iconClass: defaultIcons[appId]
                }));
                
                // 清空现有数据并插入新数据
                await db.appIcons.clear();
                await db.appIcons.bulkAdd(iconArray);
                
                console.log('应用图标数据保存成功');
                
                // 刷新图标显示
                await loadAppIcons();
            } catch (error) {
                console.error('保存应用图标时发生错误:', error);
                // 如果IndexedDB失败，回退到localStorage
                const icons = {
                    'chat-screen': 'fas fa-comment-dots',
                    'weibo-screen': 'fab fa-weibo',
                    'music-screen': 'fas fa-music',
                    'album-screen': 'fas fa-images',
                    'characters-screen': 'fas fa-user-friends',
                    'shop-screen': 'fas fa-shopping-bag',
                    'settings-screen': 'fas fa-cog'
                };
                
                if (selectedAppIcon) {
                    icons[selectedAppIcon.appId] = selectedAppIcon.iconClass;
                }
                
                localStorage.setItem('appIcons', JSON.stringify(icons));
                loadAppIcons();
            }
        }
        
        // 渲染消息列表
        function renderMessageList() {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';
            
            // 渲染单人聊天
            contacts.forEach(contactId => {
                const character = characters.find(c => c.id === contactId);
                if (character) {
                    // 🔥【修复】获取该聊天的昵称设置
                    const savedSettings = localStorage.getItem(`chatSettings_${character.id}`);
                    const chatSettings = savedSettings ? JSON.parse(savedSettings) : {};
                    const displayName = chatSettings.aiChatNickname || character.name;
                    
                    const messages = chatMessages[character.id] || [];
                    const lastMessage = messages.length > 0 ? messages[messages.length - 1].content : '暂无消息';
                    const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : '刚刚';
                    
                    const messageItem = document.createElement('div');
                    messageItem.className = 'message-item';
                    messageItem.onclick = () => startChat(character);
                    
                    messageItem.innerHTML = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : displayName.charAt(0)}
                        </div>
                        <div class="message-content">
                            <div class="message-name">${displayName}</div>
                            <div class="message-preview">${lastMessage}</div>
                        </div>
                        <div class="message-time">${lastTime}</div>
                    `;
                    
                    messageList.appendChild(messageItem);
                }
            });
            
            // 渲染群聊
            groupChats.forEach(group => {
                const messages = chatMessages[group.id] || [];
                const lastMessage = messages.length > 0 ? messages[messages.length - 1].content : '暂无消息';
                const lastTime = messages.length > 0 ? formatTime(messages[messages.length - 1].timestamp) : '刚刚';
                
                const messageItem = document.createElement('div');
                messageItem.className = 'message-item';
                messageItem.onclick = () => startChat(group);
                
                messageItem.innerHTML = `
                    <div class="message-avatar avatar-group-green">
                        群
                    </div>
                    <div class="message-content">
                        <div class="message-name">${group.name} <span class="group-member-count">(${group.members ? group.members.length : 0}人)</span></div>
                        <div class="message-preview">${lastMessage}</div>
                    </div>
                    <div class="message-time">${lastTime}</div>
                `;
                
                messageList.appendChild(messageItem);
            });
        }
        
        // 渲染联系人列表
        function renderContactList() {
            const contactList = document.querySelector('#contact-list .contact-section');
            if (contactList) {
                // 清空所有内容
                contactList.innerHTML = '';
                
                // 添加多选模式的头部
                if (isMultiSelectMode) {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'multiselect-header';
                    headerDiv.innerHTML = `
                        <span>已选择 ${selectedCharacters.length} 个角色</span>
                        <div>
                            <button onclick="deleteSelectedCharacters()" class="delete-btn-red">删除</button>
                            <button onclick="exitMultiSelectMode()" class="cancel-btn-blue">取消</button>
                        </div>
                    `;
                    contactList.appendChild(headerDiv);
                }
                
                // 只渲染联系人，不要section-title
                contacts.forEach(contactId => {
                    const character = characters.find(c => c.id === contactId);
                    if (character) {
                        // 🔥【修复】获取该联系人的昵称设置
                        const savedSettings = localStorage.getItem(`chatSettings_${character.id}`);
                        const chatSettings = savedSettings ? JSON.parse(savedSettings) : {};
                        const displayName = chatSettings.aiChatNickname || character.name;
                        
                        const contactItem = document.createElement('div');
                        contactItem.className = `contact-item ${isMultiSelectMode && selectedCharacters.includes(character.id) ? 'selected' : ''}`;
                        
                        // 根据模式设置不同的点击事件
                        if (isMultiSelectMode) {
                            contactItem.onclick = () => toggleCharacterSelection(character.id);
                        } else {
                            contactItem.onclick = () => editCharacterFromContactList(character.id);
                            
                            // 添加长按事件
                            let pressTimer;
                            contactItem.addEventListener('touchstart', (e) => {
                                pressTimer = setTimeout(() => {
                                    enterMultiSelectMode(character.id);
                                    e.preventDefault();
                                }, 800); // 800ms长按
                            });
                            
                            contactItem.addEventListener('touchend', () => {
                                clearTimeout(pressTimer);
                            });
                            
                            contactItem.addEventListener('touchmove', () => {
                                clearTimeout(pressTimer);
                            });
                            
                            // 右键点击进入多选模式（桌面端）
                            contactItem.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                enterMultiSelectMode(character.id);
                            });
                        }
                        
                        contactItem.innerHTML = `
                            ${isMultiSelectMode ? `
                                <div class="selection-checkbox ${selectedCharacters.includes(character.id) ? 'selected' : ''}">
                                    ${selectedCharacters.includes(character.id) ? '<i class="fas fa-check check-icon-white"></i>' : ''}
                                </div>
                            ` : ''}
                            <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                                ${character.avatarUrl ? '' : displayName.charAt(0)}
                            </div>
                            <div class="contact-info">
                                <div class="message-name">${displayName}</div>
                                <div class="character-preview">${character.bio || '暂无人设描述'}</div>
                            </div>
                        `;
                        
                        contactList.appendChild(contactItem);
                    }
                });
                
                // 如果没有角色，显示提示
                if (contacts.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-message';
                    emptyDiv.textContent = '还没有角色，点击右上角+号创建角色吧！';
                    contactList.appendChild(emptyDiv);
                }
            }
        }
        
        // 渲染角色列表
        function renderCharacterList() {
            const characterList = document.getElementById('character-list');
            // 检查元素是否存在，如果不存在就跳过（因为我们已经删除了人物应用）
            if (!characterList) {
                console.log('character-list元素不存在，跳过渲染');
                return;
            }
            
            characterList.innerHTML = '';
            
            characters.forEach(character => {
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                characterItem.onclick = () => editCharacter(character.id);
                
                characterItem.innerHTML = `
                    <div class="character-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div class="character-info">
                        <div class="character-name">${character.name}</div>
                        <div class="character-bio">${character.bio}</div>
                    </div>
                `;
                
                characterList.appendChild(characterItem);
            });
        }
        
        // 渲染联系人模态框
        function renderContactModal() {
            const modalBody = document.getElementById('contact-modal-body');
            modalBody.innerHTML = '';
            
            characters.forEach(character => {
                // 只显示未添加为联系人的角色
                if (!contacts.includes(character.id)) {
                    const contactOption = document.createElement('div');
                    contactOption.className = 'contact-item';
                    
                    const checkboxId = `contact-${character.id}`;
                    
                    contactOption.innerHTML = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="character-info character-info-flex">
                            <div class="character-name">${character.name}</div>
                            <div class="character-bio">${character.bio}</div>
                        </div>
                        <input type="checkbox" id="${checkboxId}" class="contact-checkbox" value="${character.id}">
                    `;
                    
                    modalBody.appendChild(contactOption);
                }
            });
            
            if (modalBody.children.length === 0) {
                modalBody.innerHTML = '<p>没有可添加的角色，请先创建新角色。</p>';
            }
        }
        
        // 当前显示的消息数量限制
        let currentMessageOffset = 0;
        const MESSAGE_LIMIT = 50;
        
        // 渲染聊天消息
        function renderChatMessages(characterId, loadMore = false) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const allMessages = chatMessages[characterId] || [];
            const chatSettings = getCurrentChatSettings();
            
            if (!loadMore) {
                // 重新渲染时清空容器并重置偏移量
                messagesContainer.innerHTML = '';
                currentMessageOffset = Math.max(0, allMessages.length - MESSAGE_LIMIT);
            }
            
            // 应用聊天背景
            applyChatBackground();
            
            // 应用气泡样式
            applyBubbleStyle();
            
            // 如果没有消息，显示空状态提示
            if (allMessages.length === 0) {
                const displayName = chatSettings.aiChatNickname || currentChatCharacter.name;
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-chat-state';
                emptyState.innerHTML = `
                    <div>开始和 ${displayName} 聊天吧</div>
                `;
                messagesContainer.appendChild(emptyState);
                return;
            }
            
            // 如果不是加载更多，且有更多历史消息，显示"查看历史消息"按钮
            if (!loadMore && currentMessageOffset > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-messages';
                loadMoreBtn.innerHTML = `
                    <div class="load-more-content">
                        <i class="fas fa-chevron-up"></i>
                        <span>查看历史消息 (${currentMessageOffset}条)</span>
                    </div>
                `;
                loadMoreBtn.onclick = () => loadMoreMessages(characterId);
                messagesContainer.appendChild(loadMoreBtn);
            }
            
            // 获取要显示的消息
            const messagesToShow = loadMore ? 
                allMessages.slice(Math.max(0, currentMessageOffset - MESSAGE_LIMIT), currentMessageOffset) :
                allMessages.slice(currentMessageOffset);
            
            // 获取时间戳设置
            const timestampEnabled = chatSettings.timestampEnabled !== false; // 默认为true
            const timestampPosition = chatSettings.timestampPosition || 'center';
            
            let lastTimestamp = 0;
            
            messagesToShow.forEach((message, index) => {
                // 处理系统消息（如戳一戳、头像更换、撤回等）
                if (message.sender === 'system') {
                    if (message.isPoke) {
                        const systemContainer = document.createElement('div');
                        systemContainer.className = 'poke-system-container';
                        const systemMessage = document.createElement('div');
                        systemMessage.className = 'poke-system-message';
                        systemMessage.textContent = message.content;
                        systemContainer.appendChild(systemMessage);
                        messagesContainer.appendChild(systemContainer);
                    } else if (message.type === 'recalled_message') {
                        // 🔥【新增】处理撤回消息的显示
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id; // 🔥【修复】添加消息ID以支持选择
                        
                        const recallElement = document.createElement('div');
                        recallElement.className = 'recalled-message';
                        
                        // 解析撤回消息内容（格式：xxx 撤回了一条消息\n原文：xxx）
                        const lines = message.content.split('\n');
                        const mainText = lines[0]; // 主要提示文字
                        const originalText = lines[1]; // 原文部分
                        
                        recallElement.textContent = mainText;
                        
                        // 如果有原文，添加原文显示
                        if (originalText && originalText.startsWith('原文：')) {
                            const originalDiv = document.createElement('div');
                            originalDiv.className = 'original-text';
                            originalDiv.textContent = originalText;
                            recallElement.appendChild(originalDiv);
                        }
                        
                        centerContainer.appendChild(recallElement);
                        messagesContainer.appendChild(centerContainer);
                        
                        // 🔥【修复】为撤回消息添加选择功能
                        addMessageLongPressListener(centerContainer, message.id);
                    } else {
                        // 🔥【修复】其他系统消息（如头像更换）- 使用居中容器
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        
                        const systemContainer = document.createElement('div');
                        systemContainer.className = 'system-message';
                        systemContainer.textContent = message.content;
                        
                        centerContainer.appendChild(systemContainer);
                        messagesContainer.appendChild(centerContainer);
                    }
                    return;
                }
                
                // 添加居中时间戳（如果启用且位置为居中）
                if (timestampEnabled && timestampPosition === 'center') {
                    const currentTime = new Date(message.timestamp);
                    const timeDiff = currentTime - lastTimestamp;
                    
                    // 如果距离上条消息超过5分钟，显示时间戳
                    if (index === 0 || timeDiff > 5 * 60 * 1000) {
                        const timestampDiv = document.createElement('div');
                        timestampDiv.className = 'timestamp timestamp-center';
                        timestampDiv.textContent = formatTimestamp(message.timestamp);
                        messagesContainer.appendChild(timestampDiv);
                        lastTimestamp = currentTime;
                    }
                }
                
                const messageContainer = document.createElement('div');
                // 检查是否是纯表情包消息
                const isEmojiOnly = message.isEmoji && !message.content;
                messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
                messageContainer.dataset.messageId = message.id; // 添加消息ID数据属性
                
                if (message.sender === 'received') {
                    const character = characters.find(c => c.id === characterId);
                    
                    // 获取显示用的头像和昵称
                    const displayAvatar = chatSettings.aiChatAvatar || character.avatarUrl;
                    const displayName = chatSettings.aiChatNickname || character.name;
                    
                    // 获取气泡样式
                    const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                    const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                    const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                    const bubblePadding = chatSettings.bubblePadding || '12';
                    
                    // 🔥 处理特殊消息类型
                    let messageContent = '';
                    
                    if (message.type === 'voice_message') {
                        // 语音消息
                        messageContent = `
                            <div class="voice-message">
                                <i class="fas fa-microphone"></i>
                                <span class="voice-content">${message.content}</span>
                                <div class="voice-duration">0:05</div>
                            </div>
                        `;
                    } else if (message.type === 'ai_image') {
                        // AI生成的图片
                        messageContent = `
                            <div class="ai-image-container">
                                <img src="${message.image}" class="message-image" onclick="showImage('${message.image}')" alt="AI生成的图片">
                                <div class="image-description">${message.imageDescription || ''}</div>
                            </div>
                        `;
                    } else if (message.type === 'transfer') {
                        // 转账消息
                        messageContent = `
                            <div class="transfer-message">
                                <i class="fas fa-dollar-sign"></i>
                                <div class="transfer-content">
                                    <div class="transfer-amount">¥${message.amount}</div>
                                    <div class="transfer-note">${message.note || '转账'}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // 普通文本消息
                        const chatMode = chatSettings.chatMode || 'online';
                        let processedContent = message.content;
                        
                        if (chatMode === 'offline') {
                            processedContent = processOfflineContent(message.content);
                        }
                        
                        messageContent = processedContent;
                    }
                    
                    let avatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        avatarHtml = `
                            <div class="message-avatar" style="background-color: ${character.color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" onclick="pokeCharacter('${character.id}')" title="戳一戳">
                                ${displayAvatar ? '' : displayName.charAt(0)}
                                ${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    let bubbleHtml = `
                        <div class="message-bubble" style="background-color: ${bubbleColor}; opacity: ${bubbleOpacity}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                            ${messageContent}
                            ${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                            ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                        </div>
                    `;
                    
                    messageContainer.innerHTML = avatarHtml + bubbleHtml;
                } else {
                    // 获取我的显示头像和气泡样式
                    let myDisplayAvatar = chatSettings.myChatAvatar;
                    
                    // 如果没有设置聊天头像，尝试使用选中身份的头像
                    if (!myDisplayAvatar && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona && selectedPersona.avatarUrl) {
                            myDisplayAvatar = selectedPersona.avatarUrl;
                        }
                    }
                    
                    const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                    const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                    const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                    const myBubblePadding = chatSettings.bubblePadding || '12';
                    
                    let myBubbleHtml = `
                        <div class="message-bubble" style="background-color: ${myBubbleColor}; opacity: ${myBubbleOpacity}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">
                            ${message.content}
                            ${message.image ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}
                            ${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            ${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}
                        </div>
                    `;
                    
                    let myAvatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        myAvatarHtml = `
                            <div class="message-avatar" style="background-color: #007AFF; ${myDisplayAvatar ? `background-image: url(${myDisplayAvatar}); background-size: cover; background-position: center;` : ''}">
                                ${myDisplayAvatar ? '' : '<i class="fas fa-user"></i>'}
                                ${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                }
                
                messagesContainer.appendChild(messageContainer);
                
                // 添加长按监听器用于多选删除
                addMessageLongPressListener(messageContainer, message.id);
                
                // 添加右键菜单功能
                const bubble = messageContainer.querySelector('.message-bubble');
                if (bubble) {
                    // 鼠标右键点击
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showMessageMenu(message.id, e);
                    });
                    
                    // 点击图片预览
                    bubble.onclick = (e) => {
                        if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                            showImage(e.target.src);
                        }
                    };
                }
            });
            
            // 添加正在输入提示元素到消息底部（初始隐藏）
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `${chatSettings.aiChatNickname || currentChatCharacter.name}正在输入中<span class="dots"></span>`;
            messagesContainer.appendChild(typingIndicator);
            
            // 如果不是加载更多，自动滚动到底部
            if (!loadMore) {
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }
        }
        
        // 加载更多历史消息
        function loadMoreMessages(characterId) {
            const messagesContainer = document.getElementById('api-chat-messages');
            const allMessages = chatMessages[characterId] || [];
            const chatSettings = getCurrentChatSettings();
            
            // 保存滚动位置
            const scrollHeight = messagesContainer.scrollHeight;
            const scrollTop = messagesContainer.scrollTop;
            
            // 计算要加载的历史消息范围
            const newOffset = Math.max(0, currentMessageOffset - MESSAGE_LIMIT);
            const historicalMessages = allMessages.slice(newOffset, currentMessageOffset);
            
            // 移除现有的"查看历史消息"按钮
            const existingLoadMoreBtn = messagesContainer.querySelector('.load-more-messages');
            if (existingLoadMoreBtn) {
                existingLoadMoreBtn.remove();
            }
            
            // 如果还有更多历史消息，在顶部添加新的"查看历史消息"按钮
            if (newOffset > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.className = 'load-more-messages';
                loadMoreBtn.innerHTML = `
                    <div class="load-more-content">
                        <i class="fas fa-chevron-up"></i>
                        <span>查看历史消息 (${newOffset}条)</span>
                    </div>
                `;
                loadMoreBtn.onclick = () => loadMoreMessages(characterId);
                messagesContainer.insertBefore(loadMoreBtn, messagesContainer.firstChild);
            }
            
            // 在现有消息前面插入历史消息
            const timestampEnabled = chatSettings.timestampEnabled !== false;
            const timestampPosition = chatSettings.timestampPosition || 'center';
            let lastTimestamp = 0;
            
            // 从后往前插入，保持时间顺序
            for (let i = historicalMessages.length - 1; i >= 0; i--) {
                const message = historicalMessages[i];
                
                // 处理系统消息（如戳一戳、头像更换、撤回等）
                if (message.sender === 'system') {
                    let containerToInsert;
                    
                    if (message.isPoke) {
                        const systemContainer = document.createElement('div');
                        systemContainer.className = 'poke-system-container';
                        const systemMessage = document.createElement('div');
                        systemMessage.className = 'poke-system-message';
                        systemMessage.textContent = message.content;
                        systemContainer.appendChild(systemMessage);
                        containerToInsert = systemContainer;
                    } else if (message.type === 'recalled_message') {
                        // 🔥【新增】处理撤回消息的显示
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        centerContainer.dataset.messageId = message.id; // 🔥【修复】添加消息ID以支持选择
                        
                        const recallElement = document.createElement('div');
                        recallElement.className = 'recalled-message';
                        
                        // 解析撤回消息内容（格式：xxx 撤回了一条消息\n原文：xxx）
                        const lines = message.content.split('\n');
                        const mainText = lines[0]; // 主要提示文字
                        const originalText = lines[1]; // 原文部分
                        
                        recallElement.textContent = mainText;
                        
                        // 如果有原文，添加原文显示
                        if (originalText && originalText.startsWith('原文：')) {
                            const originalDiv = document.createElement('div');
                            originalDiv.className = 'original-text';
                            originalDiv.textContent = originalText;
                            recallElement.appendChild(originalDiv);
                        }
                        
                        centerContainer.appendChild(recallElement);
                        containerToInsert = centerContainer;
                    } else {
                        // 🔥【修复】其他系统消息（如头像更换）- 使用居中容器
                        const centerContainer = document.createElement('div');
                        centerContainer.style.display = 'flex';
                        centerContainer.style.justifyContent = 'center';
                        centerContainer.style.margin = '4px 0';
                        
                        const systemContainer = document.createElement('div');
                        systemContainer.className = 'system-message';
                        systemContainer.textContent = message.content;
                        
                        centerContainer.appendChild(systemContainer);
                        containerToInsert = centerContainer;
                    }
                    
                    // 插入到按钮后面（如果有按钮的话）
                    const insertAfter = messagesContainer.querySelector('.load-more-messages');
                    if (insertAfter) {
                        insertAfter.parentNode.insertBefore(containerToInsert, insertAfter.nextSibling);
                    } else {
                        messagesContainer.insertBefore(containerToInsert, messagesContainer.firstChild);
                    }
                    
                    // 🔥【修复】为撤回消息添加选择功能
                    if (message.type === 'recalled_message') {
                        addMessageLongPressListener(containerToInsert, message.id);
                    }
                    
                    continue;
                }
                
                const messageContainer = document.createElement('div');
                // 检查是否是纯表情包消息
                const isEmojiOnly = message.isEmoji && !message.content;
                messageContainer.className = `message-container ${message.sender}${chatSettings.hideAvatars ? ' no-avatar' : ''}${isEmojiOnly ? ' emoji-only' : ''}`;
                messageContainer.dataset.messageId = message.id;
                
                if (message.sender === 'received') {
                    const character = characters.find(c => c.id === characterId);
                    const displayAvatar = chatSettings.aiChatAvatar || character.avatarUrl;
                    const displayName = chatSettings.aiChatNickname || character.name;
                    const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                    const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                    const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                    const bubblePadding = chatSettings.bubblePadding || '12';
                    
                    let messageContent = '';
                    if (message.type === 'voice_message') {
                        messageContent = `<div class="voice-message"><i class="fas fa-microphone"></i><span class="voice-content">${message.content}</span><div class="voice-duration">0:05</div></div>`;
                    } else if (message.type === 'ai_image') {
                        messageContent = `<div class="ai-image-container"><img src="${message.image}" class="message-image" onclick="showImage('${message.image}')" alt="AI生成的图片"><div class="image-description">${message.imageDescription || ''}</div></div>`;
                    } else if (message.type === 'transfer') {
                        messageContent = `<div class="transfer-message"><i class="fas fa-dollar-sign"></i><div class="transfer-content"><div class="transfer-amount">¥${message.amount}</div><div class="transfer-note">${message.note || '转账'}</div></div></div>`;
                    } else {
                        const chatMode = chatSettings.chatMode || 'online';
                        messageContent = chatMode === 'offline' ? processOfflineContent(message.content) : message.content;
                    }
                    
                    let avatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        avatarHtml = `<div class="message-avatar" style="background-color: ${character.color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" onclick="pokeCharacter('${character.id}')" title="戳一戳">${displayAvatar ? '' : displayName.charAt(0)}${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                    let bubbleHtml = `<div class="message-bubble" style="background-color: ${bubbleColor}; opacity: ${bubbleOpacity}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">${messageContent}${message.image && !message.type ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    
                    messageContainer.innerHTML = avatarHtml + bubbleHtml;
                } else {
                    let myDisplayAvatar = chatSettings.myChatAvatar;
                    if (!myDisplayAvatar && chatSettings.selectedIdentityId) {
                        const selectedPersona = personas.find(p => p.id === chatSettings.selectedIdentityId);
                        if (selectedPersona && selectedPersona.avatarUrl) {
                            myDisplayAvatar = selectedPersona.avatarUrl;
                        }
                    }
                    
                    const myBubbleColor = chatSettings.myBubbleColor || '#007AFF';
                    const myBubbleOpacity = chatSettings.myBubbleOpacity || '1';
                    const myTextColor = isLightColor(myBubbleColor) ? '#333' : '#fff';
                    const myBubblePadding = chatSettings.bubblePadding || '12';
                    
                    let myBubbleHtml = `<div class="message-bubble" style="background-color: ${myBubbleColor}; opacity: ${myBubbleOpacity}; color: ${myTextColor}; position: relative; padding: ${myBubblePadding}px;">${message.content}${message.image ? `<img src="${message.image}" class="${message.isEmoji ? 'message-emoji' : 'message-image'}" onclick="showImage('${message.image}')">` : ''}${timestampEnabled && timestampPosition === 'bubble' ? `<div class="timestamp timestamp-bubble">${formatTimeOnly(message.timestamp)}</div>` : ''}${timestampEnabled && timestampPosition === 'inside' ? `<div class="timestamp timestamp-inside">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    
                    let myAvatarHtml = '';
                    if (!chatSettings.hideAvatars) {
                        myAvatarHtml = `<div class="message-avatar" style="background-color: #007AFF; ${myDisplayAvatar ? `background-image: url(${myDisplayAvatar}); background-size: cover; background-position: center;` : ''}">${myDisplayAvatar ? '' : '<i class="fas fa-user"></i>'}${timestampEnabled && timestampPosition === 'avatar' ? `<div class="timestamp timestamp-avatar">${formatTimeOnly(message.timestamp)}</div>` : ''}</div>`;
                    }
                    
                    messageContainer.innerHTML = myBubbleHtml + myAvatarHtml;
                }
                
                // 添加长按监听器和右键菜单
                addMessageLongPressListener(messageContainer, message.id);
                const bubble = messageContainer.querySelector('.message-bubble');
                if (bubble) {
                    bubble.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showMessageMenu(message.id, e);
                    });
                    
                    bubble.onclick = (e) => {
                        if (e.target.tagName === 'IMG' && e.target.classList.contains('message-image')) {
                            showImage(e.target.src);
                        }
                    };
                }
                
                // 插入消息到正确位置
                const insertAfter = messagesContainer.querySelector('.load-more-messages');
                if (insertAfter) {
                    insertAfter.parentNode.insertBefore(messageContainer, insertAfter.nextSibling);
                } else {
                    messagesContainer.insertBefore(messageContainer, messagesContainer.firstChild);
                }
            }
            
            // 更新偏移量
            currentMessageOffset = newOffset;
            
            // 保持滚动位置
            setTimeout(() => {
                const newScrollHeight = messagesContainer.scrollHeight;
                messagesContainer.scrollTop = scrollTop + (newScrollHeight - scrollHeight);
            }, 50);
        }

        
        // 显示角色表单
        function showCharacterForm(characterId = null) {
            currentEditingCharacterId = characterId; // 保存当前编辑的角色ID
            document.getElementById('character-form-title').textContent = characterId ? '编辑人物' : '新建人物';
            
            // 清空表单
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';
            
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');
            
            // 重置头像预览
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            avatarPreviewText.style.display = 'block';
            avatarPreviewText.textContent = 'A';
            
            // 清除临时存储的头像数据
            window.selectedAvatarData = null;
            
            // 如果是编辑模式，填充现有数据
            if (characterId) {
                const character = characters.find(c => c.id === characterId);
                if (character) {
                    document.getElementById('character-name').value = character.name;
                    document.getElementById('character-bio').value = character.bio;
                    
                    if (character.avatarUrl) {
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${character.avatarUrl})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        avatarPreviewText.style.display = 'none';
                        // 为编辑模式保存现有头像数据
                        window.selectedAvatarData = character.avatarUrl;
                    } else {
                        avatarPreviewText.textContent = character.name.charAt(0);
                    }
                }
            }
            
            // 设置表单的保存函数和删除按钮显示
            const deleteBtn = document.getElementById('character-delete-btn');
            console.log('设置保存按钮，characterId:', characterId);
            if (characterId) {
                document.querySelector('#character-form-screen .form-submit').onclick = async () => await saveCharacter(characterId);
                // 编辑模式显示删除按钮
                if (deleteBtn) deleteBtn.style.display = 'block';
                console.log('设置为编辑模式，角色ID:', characterId);
            } else {
                document.querySelector('#character-form-screen .form-submit').onclick = async () => await saveCharacter();
                // 新建模式隐藏删除按钮
                if (deleteBtn) deleteBtn.style.display = 'none';
                console.log('设置为创建模式，无角色ID');
            }
            
            showApp('character-form-screen');
            
            // 确保头像上传功能可用 - 重新绑定事件监听器（以防万一）
            setTimeout(() => {
                initializeAvatarUpload();
            }, 100);
        }
        
        // 保存角色
        async function saveCharacter(characterId = null) {
            try {
                console.log('=== 开始保存角色 ===');
                const name = document.getElementById('character-name').value.trim();
                const bio = document.getElementById('character-bio').value.trim();
                const avatarData = window.selectedAvatarData; // 使用预处理的头像数据
                
                console.log('保存角色 - 姓名:', name, '头像数据存在:', !!avatarData);
                if (avatarData) {
                    console.log('头像数据长度:', avatarData.length, '开头:', avatarData.substring(0, 50));
                }
                
                if (!name) {
                    alert('请输入姓名');
                    return;
                }
                
                if (characterId) {
                    console.log('=== 更新现有角色 ===');
                    // 更新现有角色
                    const index = characters.findIndex(c => c.id === characterId);
                    if (index !== -1) {
                        characters[index] = {
                            ...characters[index],
                            name,
                            bio,
                            avatarUrl: avatarData || characters[index].avatarUrl || '',
                            color: characters[index].color || getRandomColor()
                        };
                        
                        console.log('更新角色完成:', characters[index]);
                        
                        // 保存并更新界面
                        await saveCharacters();
                        renderCharacterList();
                        renderContactList();
                        renderMessageList();
                        hideCharacterForm();
                        // 注意：不立即清空表单，让用户能看到保存成功的状态
                    }
                } else {
                    console.log('=== 创建新角色 ===');
                    // 创建新角色
                    const newCharacter = {
                        id: Date.now().toString(),
                        name,
                        bio,
                        avatarUrl: avatarData || '',
                        color: getRandomColor()
                    };
                    
                    console.log('创建新角色:', newCharacter);
                    console.log('新角色头像URL:', newCharacter.avatarUrl);
                    console.log('新角色头像URL长度:', newCharacter.avatarUrl ? newCharacter.avatarUrl.length : 0);
                    
                    console.log('添加角色前，当前角色数组长度:', characters.length);
                    characters.push(newCharacter);
                    console.log('添加角色后，当前角色数组长度:', characters.length);
                    
                    console.log('角色数组最新状态:', characters);
                    
                    // 自动将新创建的角色添加到联系人列表
                    if (!contacts.includes(newCharacter.id)) {
                        contacts.push(newCharacter.id);
                        await saveContacts();
                        console.log('新角色已自动添加到联系人列表');
                    }
                    
                    // 保存并更新界面
                    console.log('开始保存到IndexedDB...');
                    await saveCharacters();
                    console.log('保存后检查角色数组:', characters);
                    
                    console.log('开始渲染界面...');
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                    
                    console.log('开始隐藏表单...');
                    hideCharacterForm();
                    // 注意：不立即清空表单，让用户能看到保存成功的状态
                    
                    // 给用户反馈
                    alert(`角色 "${newCharacter.name}" 创建成功！`);
                    
                    console.log('=== 保存角色完成 ===');
                }
            } catch (error) {
                console.error('保存角色时发生错误:', error);
                alert('保存角色时发生错误: ' + error.message);
            }
        }
        
        // 清空角色表单
        function clearCharacterForm() {
            console.log('清空角色表单被调用');
            document.getElementById('character-name').value = '';
            document.getElementById('character-bio').value = '';
            document.getElementById('avatar-upload').value = '';
            
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewText = document.getElementById('avatar-preview-text');
            
            // 重置头像预览
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            if (avatarPreviewText) {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = 'A';
            }
            
            // 清除临时存储的头像数据
            console.log('清除临时头像数据');
            window.selectedAvatarData = null;
        }
        
        // 编辑角色
        function editCharacter(characterId) {
            showCharacterForm(characterId);
        }
        
        // 从联系人列表编辑角色
        function editCharacterFromContactList(characterId) {
            showCharacterForm(characterId);
        }
        
        // 进入多选模式
        function enterMultiSelectMode(characterId) {
            isMultiSelectMode = true;
            selectedCharacters = [characterId]; // 初始选中触发长按的角色
            renderContactList();
        }
        
        // 退出多选模式
        function exitMultiSelectMode() {
            isMultiSelectMode = false;
            selectedCharacters = [];
            renderContactList();
        }
        
        // 切换角色选择状态
        function toggleCharacterSelection(characterId) {
            const index = selectedCharacters.indexOf(characterId);
            if (index > -1) {
                selectedCharacters.splice(index, 1);
            } else {
                selectedCharacters.push(characterId);
            }
            renderContactList();
        }
        
        // 删除选中的角色
        async function deleteSelectedCharacters() {
            if (selectedCharacters.length === 0) {
                alert('请先选择要删除的角色');
                return;
            }
            
            const characterNames = selectedCharacters.map(id => {
                const character = characters.find(c => c.id === id);
                return character ? character.name : '';
            }).filter(name => name).join('、');
            
            if (confirm(`确定要删除这些角色吗？\n${characterNames}\n\n此操作不可恢复！`)) {
                // 删除角色
                selectedCharacters.forEach(characterId => {
                    characters = characters.filter(c => c.id !== characterId);
                    contacts = contacts.filter(c => c !== characterId);
                    
                    // 删除相关聊天记录
                    if (chatMessages[characterId]) {
                        delete chatMessages[characterId];
                    }
                });
                
                // 保存数据
                await saveCharacters();
                await saveContacts();
                await saveChatMessages();
                
                // 退出多选模式并更新界面
                exitMultiSelectMode();
                renderMessageList();
                
                alert('角色删除成功');
            }
        }
        
        // 删除当前编辑的角色
        async function deleteCurrentCharacter() {
            if (currentEditingCharacterId) {
                const character = characters.find(c => c.id === currentEditingCharacterId);
                
                if (character && confirm(`确定要删除角色"${character.name}"吗？\n\n此操作不可恢复！`)) {
                    // 删除角色
                    characters = characters.filter(c => c.id !== character.id);
                    contacts = contacts.filter(c => c !== character.id);
                    
                    // 删除相关聊天记录
                    if (chatMessages[character.id]) {
                        delete chatMessages[character.id];
                    }
                    
                    // 保存数据
                    await saveCharacters();
                    await saveContacts();
                    await saveChatMessages();
                    
                    // 更新界面并返回
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                    hideCharacterForm();
                    
                    alert('角色删除成功');
                }
            }
        }
        
        // 获取随机颜色
        function getRandomColor() {
            const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#5AC8FA', '#007AFF', '#5856D6', '#AF52DE'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // 显示添加联系人模态框
        function showAddContactModal() {
            showModal('add-contact-modal');
        }
        
        // 添加选中的联系人
        async function addSelectedContacts() {
            const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
            checkboxes.forEach(checkbox => {
                const characterId = checkbox.value;
                if (!contacts.includes(characterId)) {
                    contacts.push(characterId);
                }
            });
            
            await saveContacts();
            renderMessageList();
            renderContactList();
            hideModal('add-contact-modal');
        }
        
        // 开始与角色聊天
        function startChat(character) {
            currentChatCharacter = character;
            
            // 🔥【修复】检查是否有保存的昵称设置
            const chatSettings = getCurrentChatSettings();
            const displayTitle = chatSettings.aiChatNickname || character.name;
            document.getElementById('api-chat-title').textContent = displayTitle;
            
            // 初始化空的聊天记录（不自动发送消息）
            if (!chatMessages[character.id]) {
                chatMessages[character.id] = [];
                saveChatMessages();
            }
            
            // 重置悬浮按钮状态
            resetFloatingButtonsState();
            
            // 🔥【新增】如果设置界面是打开的，更新设置显示状态
            if (document.getElementById('api-chat-settings-screen').style.display === 'flex') {
                updateChatSettingsDisplay();
            }
            
            renderChatMessages(character.id);
            showApp('api-chat-screen');
        }
        
        // 从聊天界面返回到聊天应用
        function backToChatApp() {
            hideApp('api-chat-screen');
            showApp('chat-screen');
        }
        
        // 从设置子页面返回到设置主页面
        function backToSettings(currentScreen) {
            hideApp(currentScreen);
            showApp('settings-screen');
        }
        

        
        // 显示正在输入提示
        function showTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.classList.add('show');
                // 滚动到底部显示提示
                const messagesContainer = document.getElementById('api-chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        // 隐藏正在输入提示
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.classList.remove('show');
            }
        }
        
        // 🔥【新增】添加系统消息到聊天界面（不重新渲染整个列表）
        function addSystemMessageToChat(systemMessage) {
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer) return;
            
            // 创建外层容器，用于居中
            const centerContainer = document.createElement('div');
            centerContainer.style.display = 'flex';
            centerContainer.style.justifyContent = 'center';
            centerContainer.style.margin = '4px 0';
            
            // 创建系统消息容器
            const systemContainer = document.createElement('div');
            systemContainer.className = 'system-message';
            systemContainer.textContent = systemMessage.content;
            
            // 将系统消息放入居中容器
            centerContainer.appendChild(systemContainer);
            
            // 插入到消息容器的最后（正在输入提示之前）
            const typingIndicator = messagesContainer.querySelector('#typing-indicator');
            if (typingIndicator) {
                messagesContainer.insertBefore(centerContainer, typingIndicator);
            } else {
                messagesContainer.appendChild(centerContainer);
            }
            
            // 滚动到底部
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // 🔥【新增】处理AI撤回消息功能
        async function handleRecalledMessage(messageContent, targetMessageId = null) {
            if (!currentChatCharacter) return;
            
            console.log('处理撤回消息:', messageContent, '目标消息ID:', targetMessageId);
            
            const messagesContainer = document.getElementById('api-chat-messages');
            if (!messagesContainer) return;
            
            const character = characters.find(c => c.id === currentChatCharacter.id);
            const chatSettings = getCurrentChatSettings();
            const displayName = chatSettings.aiChatNickname || character.name;
            
            let messageContainer = null;
            
            // 如果提供了目标消息ID，查找并撤回现有消息
            if (targetMessageId) {
                messageContainer = messagesContainer.querySelector(`[data-message-id="${targetMessageId}"]`);
                if (messageContainer) {
                    console.log('找到要撤回的现有消息，准备撤回');
                    
                    // 等待1.2秒后撤回
                    await new Promise(resolve => setTimeout(resolve, 1200));
                    
                    // 添加淡出动画
                    messageContainer.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                    
                    // 等待动画完成
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // 从聊天记录中移除这条消息
                    if (chatMessages[currentChatCharacter.id]) {
                        const messageIndex = chatMessages[currentChatCharacter.id].findIndex(msg => msg.id === targetMessageId);
                        if (messageIndex !== -1) {
                            chatMessages[currentChatCharacter.id].splice(messageIndex, 1);
                            saveChatMessages();
                        }
                    }
                } else {
                    console.warn('未找到要撤回的消息，创建临时消息');
                    // 如果找不到消息，回退到创建临时消息的方式
                    messageContainer = await createTemporaryMessage(messageContent);
                }
            } else {
                // 没有提供目标ID，创建临时消息
                messageContainer = await createTemporaryMessage(messageContent);
            }
            
            if (!messageContainer) return;
            
            // 创建撤回提醒的居中容器
            const centerContainer = document.createElement('div');
            centerContainer.style.display = 'flex';
            centerContainer.style.justifyContent = 'center';
            centerContainer.style.margin = '4px 0';
            
            // 创建撤回消息元素
            const recallElement = document.createElement('div');
            recallElement.className = 'recalled-message';
            
            // 主要提醒文字
            const mainText = document.createElement('div');
            mainText.style.marginBottom = '2px';
            mainText.textContent = `${displayName} 撤回了一条消息`;
            
            // 原文显示
            const originalText = document.createElement('div');
            originalText.className = 'original-text';
            originalText.textContent = `原文：${messageContent}`;
            
            recallElement.appendChild(mainText);
            recallElement.appendChild(originalText);
            centerContainer.appendChild(recallElement);
            
            // 在原消息位置替换为撤回提醒
            messageContainer.parentNode.insertBefore(centerContainer, messageContainer);
            messageContainer.remove();
            
            // 添加撤回消息到聊天历史
            const recalledMessage = {
                id: `recalled_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                sender: 'system',
                type: 'recalled_message',
                content: `${displayName} 撤回了一条消息\n原文：${messageContent}`,
                originalContent: messageContent,
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            chatMessages[currentChatCharacter.id].push(recalledMessage);
            saveChatMessages();
            
            // 滚动到底部
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 创建临时消息的辅助函数
            async function createTemporaryMessage(content) {
                const messageId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const tempContainer = document.createElement('div');
                const isEmojiOnly = false;
                tempContainer.className = `message-container received${isEmojiOnly ? ' emoji-only' : ''}`;
                tempContainer.dataset.messageId = messageId;
                
                const bubbleColor = chatSettings.aiBubbleColor || '#f0f0f0';
                const bubbleOpacity = chatSettings.aiBubbleOpacity || '1';
                const textColor = isLightColor(bubbleColor) ? '#333' : '#fff';
                const bubblePadding = chatSettings.bubblePadding || '12';
                const displayAvatar = chatSettings.aiChatAvatar || character.avatarUrl;
                
                let avatarHtml = '';
                if (!chatSettings.hideAvatars) {
                    avatarHtml = `
                        <div class="message-avatar" style="background-color: ${character.color}; ${displayAvatar ? `background-image: url(${displayAvatar}); background-size: cover; background-position: center;` : ''}" onclick="pokeCharacter('${character.id}')" title="戳一戳">
                            ${displayAvatar ? '' : displayName.charAt(0)}
                        </div>
                    `;
                }
                
                let bubbleHtml = `
                    <div class="message-bubble" style="background-color: ${bubbleColor}; opacity: ${bubbleOpacity}; color: ${textColor}; position: relative; padding: ${bubblePadding}px;">
                        ${content}
                    </div>
                `;
                
                tempContainer.innerHTML = avatarHtml + bubbleHtml;
                
                // 添加到消息容器
                const typingIndicator = messagesContainer.querySelector('#typing-indicator');
                if (typingIndicator) {
                    messagesContainer.insertBefore(tempContainer, typingIndicator);
                } else {
                    messagesContainer.appendChild(tempContainer);
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // 等待1.2秒后撤回
                await new Promise(resolve => setTimeout(resolve, 1200));
                
                // 添加淡出动画
                tempContainer.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                
                // 等待动画完成
                await new Promise(resolve => setTimeout(resolve, 500));
                
                return tempContainer;
            }
        }
        
        // 🔥【新增】获取用户最近发送的图片URL
        function getRecentUserImage() {
            if (!currentChatCharacter || !chatMessages[currentChatCharacter.id]) {
                return null;
            }
            
            const messages = chatMessages[currentChatCharacter.id];
            // 从最新消息开始向前查找用户发送的图片
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                if (msg.sender === 'sent' && msg.image && !msg.isEmoji) {
                    console.log('找到用户最近发送的图片:', msg.image);
                    return msg.image;
                }
            }
            
            console.log('没有找到用户发送的图片');
            return null;
        }
        
        // 解析AI回复 - 按照index.html的逻辑，新增表情包支持和格式修正
        function parseAiResponse(content) { 
            try { 
                const parsed = JSON.parse(content); 
                if (Array.isArray(parsed)) {
                    // 🔥【新增】处理表情包消息类型和格式修正
                    const processedMessages = [];
                    
                    parsed.forEach(item => {
                        if (typeof item === 'object' && item.type === 'emoji') {
                            // 查找匹配的表情包
                            const matchingEmoji = customEmojis.find(emoji => 
                                emoji.description === item.description
                            );
                            
                            if (matchingEmoji) {
                                // 检查表情包是否为GIF格式
                                if (matchingEmoji.url && matchingEmoji.url.includes('data:image/gif')) {
                                    console.warn('AI尝试使用GIF格式表情包:', item.description);
                                    processedMessages.push(`[${matchingEmoji.description}] (GIF格式不支持API识别)`);
                                } else {
                                // 返回表情包对象，包含完整的表情包信息
                                    processedMessages.push({
                                    type: 'emoji',
                                    url: matchingEmoji.url,
                                    description: matchingEmoji.description,
                                    id: matchingEmoji.id
                                    });
                                }
                            } else {
                                // 如果找不到匹配的表情包，返回错误消息
                                console.warn('AI尝试使用不存在的表情包:', item.description);
                                processedMessages.push(`[错误: 表情包"${item.description}"不存在]`);
                            }
                        } else if (typeof item === 'object' && item.type === 'change_avatar') {
                            // 处理头像更换对象
                            console.log('解析到头像更换指令:', item);
                            
                            // 🔥【新增】处理各种错误的占位符
                            if (item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                item.avatar_url === '用户发送的图片URL' ||
                                item.avatar_url === '图片URL') {
                                // 获取最近用户发送的图片URL
                                const recentUserImage = getRecentUserImage();
                                if (recentUserImage) {
                                    item.avatar_url = recentUserImage;
                                    console.log('将占位符替换为实际图片URL:', recentUserImage);
                                } else {
                                    console.warn('没有找到用户最近发送的图片，忽略头像更换请求');
                                    processedMessages.push(`[系统：无法更换头像，没有找到可用的图片]`);
                                    // 不要return，继续处理其他消息
                                }
                            }
                            
                            processedMessages.push(item);
                        } else if (typeof item === 'object' && item.type === 'recalled_message') {
                            // 🔥【新增】处理撤回消息
                            console.log('解析到撤回消息指令:', item);
                            processedMessages.push(item);
                        } else if (typeof item === 'string') {
                            // 🚨 【新增】检查并修复合并消息问题
                            if (item.includes('\n')) {
                                console.warn('检测到AI将多条消息合并在一个元素中，正在自动分拆:', item);
                                // 将换行符分隔的内容分拆成多条消息
                                const splitMessages = item.split('\n')
                                    .map(msg => msg.trim())
                                    .filter(msg => msg.length > 0);
                                processedMessages.push(...splitMessages);
                            } else {
                                processedMessages.push(item);
                            }
                        } else {
                            processedMessages.push(item);
                        }
                    });
                    
                    return processedMessages;
                }
            } catch (e) {} 
            
            try { 
                const match = content.match(/\[(.*?)\]/s); 
                if (match && match[0]) { 
                    const parsed = JSON.parse(match[0]); 
                    if (Array.isArray(parsed)) {
                        // 🔥【新增】处理表情包消息类型和格式修正
                        const processedMessages = [];
                        
                        parsed.forEach(item => {
                            if (typeof item === 'object' && item.type === 'emoji') {
                                // 查找匹配的表情包
                                const matchingEmoji = customEmojis.find(emoji => 
                                    emoji.description === item.description
                                );
                                
                                if (matchingEmoji) {
                                    // 检查表情包是否为GIF格式
                                    if (matchingEmoji.url && matchingEmoji.url.includes('data:image/gif')) {
                                        console.warn('AI尝试使用GIF格式表情包:', item.description);
                                        processedMessages.push(`[${matchingEmoji.description}] (GIF格式不支持API识别)`);
                                    } else {
                                    // 返回表情包对象，包含完整的表情包信息
                                        processedMessages.push({
                                        type: 'emoji',
                                        url: matchingEmoji.url,
                                        description: matchingEmoji.description,
                                        id: matchingEmoji.id
                                        });
                                    }
                                } else {
                                    // 如果找不到匹配的表情包，返回错误消息
                                    console.warn('AI尝试使用不存在的表情包:', item.description);
                                    processedMessages.push(`[错误: 表情包"${item.description}"不存在]`);
                                }
                            } else if (typeof item === 'object' && item.type === 'change_avatar') {
                                // 处理头像更换对象
                                console.log('解析到头像更换指令(第二处):', item);
                                
                                // 🔥【新增】处理各种错误的占位符
                                if (item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                    item.avatar_url === 'CURRENT_USER_IMAGE' || 
                                    item.avatar_url === '用户发送的图片URL' ||
                                    item.avatar_url === '图片URL') {
                                    // 获取最近用户发送的图片URL
                                    const recentUserImage = getRecentUserImage();
                                    if (recentUserImage) {
                                        item.avatar_url = recentUserImage;
                                        console.log('将占位符替换为实际图片URL(第二处):', recentUserImage);
                                    } else {
                                        console.warn('没有找到用户最近发送的图片，忽略头像更换请求(第二处)');
                                        processedMessages.push(`[系统：无法更换头像，没有找到可用的图片]`);
                                        // 不要return，继续处理其他消息
                                    }
                                }
                                
                                processedMessages.push(item);
                            } else if (typeof item === 'object' && item.type === 'recalled_message') {
                                // 🔥【新增】处理撤回消息(第二处)
                                console.log('解析到撤回消息指令(第二处):', item);
                                processedMessages.push(item);
                            } else if (typeof item === 'string') {
                                // 🚨 【新增】检查并修复合并消息问题
                                if (item.includes('\n')) {
                                    console.warn('检测到AI将多条消息合并在一个元素中，正在自动分拆:', item);
                                    // 将换行符分隔的内容分拆成多条消息
                                    const splitMessages = item.split('\n')
                                        .map(msg => msg.trim())
                                        .filter(msg => msg.length > 0);
                                    processedMessages.push(...splitMessages);
                                } else {
                                    processedMessages.push(item);
                                }
                            } else {
                                processedMessages.push(item);
                            }
                        });
                        
                        return processedMessages;
                    }
                } 
            } catch (e) {} 
            
            const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```')); 
            if (lines.length > 0) return lines; 
            return [content]; 
        }
        
        // 处理线下模式内容：识别「」包裹的对话和描写
        function processOfflineContent(content) {
            if (!content) return '';
            
            // 使用正则表达式分离对话和描写
            const parts = [];
            let lastIndex = 0;
            
            // 匹配「」包裹的对话
            const dialogRegex = /「([^」]*)」/g;
            let match;
            
            while ((match = dialogRegex.exec(content)) !== null) {
                // 添加对话前的描写部分
                if (match.index > lastIndex) {
                    const description = content.slice(lastIndex, match.index).trim();
                    if (description) {
                        parts.push(`<span class="italic-gray">${description}</span>`);
                    }
                }
                
                // 添加对话部分（正常显示）
                parts.push(`「${match[1]}」`);
                lastIndex = match.index + match[0].length;
            }
            
            // 添加最后的描写部分
            if (lastIndex < content.length) {
                const description = content.slice(lastIndex).trim();
                if (description) {
                    parts.push(`<span class="italic-gray">${description}</span>`);
                }
            }
            
            // 如果没有找到对话标记，整个内容作为描写处理
            if (parts.length === 0) {
                return `<span class="italic-gray">${content}</span>`;
            }
            
            return parts.join('');
        }
        
        // 发送图片消息
        function sendImageMessage(imageUrl) {
            if (!currentChatCharacter) return;
            
            const messageId = Date.now().toString();
            const imageMessage = {
                id: messageId,
                sender: 'sent',
                content: '',
                image: imageUrl,
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(imageMessage);
            saveChatMessages();
            
            // 渲染消息
            renderChatMessages(currentChatCharacter.id);
            
            // 设置待回复消息，支持智能回复按钮
            pendingUserMessage = imageMessage;
            
            // 更新智能回复按钮状态
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = '点击获取AI回复';
            }
        }
        
        // 调用聊天API
        // 第一个callChatAPI函数已删除，使用下面的完整版本
        
        // 上传图片
        function uploadImage() {
            document.getElementById('image-upload').click();
        }
        
        // 显示图片
        function showImage(imageUrl) {
            // 首先检查是否是相册中的照片
            const photo = photos.find(p => p.image === imageUrl);
            if (photo) {
                document.getElementById('photo-image').style.backgroundImage = `url(${imageUrl})`;
                document.getElementById('photo-description-text').textContent = photo.description;
                document.getElementById('photo-time').textContent = `拍摄于: ${formatFullDate(new Date(photo.timestamp))}`;
                document.getElementById('photo-location').textContent = `地点: ${photo.location}`;
                showApp('photo-detail-screen');
            } else {
                // 如果不是相册照片，显示通用的图片预览模态框
                let modal = document.getElementById('image-preview-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'image-preview-modal';
                    modal.className = 'image-preview-modal';
                    modal.onclick = () => modal.style.display = 'none';
                    modal.innerHTML = `<img src="" alt="预览图片">`;
                    document.body.appendChild(modal);
                }
                modal.querySelector('img').src = imageUrl;
                modal.style.display = 'flex';
            }
        }
        
        // 显示聊天设置
        function showChatSettings() {
            console.log('显示聊天设置被调用');
            
            // 先隐藏当前的聊天界面
            hideApp('api-chat-screen');
            
            // 显示设置界面
            const element = document.getElementById('api-chat-settings-screen');
            if (element) {
                element.style.display = 'flex';
                element.style.position = 'absolute';
                element.style.top = '0';
                element.style.left = '0';
                element.style.width = '100%';
                element.style.height = '100%';
                element.style.zIndex = '1000';
                element.style.background = 'white';
                
                // 重新初始化聊天设置界面以加载当前设置
                initializeChatSettings();
                
                // 更新各种设置的显示状态
                updateWorldbookMountDisplay();
                
                console.log('聊天设置界面已显示');
            } else {
                console.error('找不到api-chat-settings-screen元素');
                alert('设置界面未找到，请刷新页面重试');
            }
        }
        
        // 隐藏聊天设置
        function hideChatSettings() {
            hideApp('api-chat-settings-screen');
            // 返回到聊天界面
            if (currentChatCharacter) {
                showApp('api-chat-screen');
            }
        }
        
        // 修改角色头像
        function changeCharacterAvatar() {
            // 临时创建一个文件输入框，避免干扰原有的头像上传功能
            const tempInput = document.createElement('input');
            tempInput.type = 'file';
            tempInput.accept = 'image/*';
            tempInput.style.display = 'none';
            document.body.appendChild(tempInput);
            
            tempInput.onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                        if (characterIndex !== -1) {
                            characters[characterIndex].avatarUrl = event.target.result;
                            await saveCharacters();
                            renderCharacterList();
                            renderContactList();
                            renderMessageList();
                            renderChatMessages(currentChatCharacter.id);
                        }
                        // 清理临时元素
                        document.body.removeChild(tempInput);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                } else {
                    // 如果用户取消选择，也要清理临时元素
                    document.body.removeChild(tempInput);
                }
            };
            
            tempInput.click();
        }
        
        // 修改备注
        async function changeCharacterNickname() {
            const newName = prompt('请输入新的备注名称:', currentChatCharacter.name);
            if (newName && newName.trim() !== '') {
                const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                if (characterIndex !== -1) {
                    characters[characterIndex].name = newName.trim();
                    await saveCharacters();
                    document.getElementById('api-chat-title').textContent = newName.trim();
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                }
            }
        }
        
        // 查找聊天内容
        function searchChatContent() {
            const keyword = prompt('请输入要查找的关键词:');
            if (keyword && keyword.trim() !== '') {
                const messages = chatMessages[currentChatCharacter.id] || [];
                const foundMessages = messages.filter(msg => 
                    msg.content && msg.content.includes(keyword.trim())
                );
                
                if (foundMessages.length > 0) {
                    alert(`找到 ${foundMessages.length} 条包含"${keyword}"的消息`);
                } else {
                    alert(`没有找到包含"${keyword}"的消息`);
                }
            }
        }
        

        
        // 导出聊天记录
        function exportChatHistory() {
            const messages = chatMessages[currentChatCharacter.id] || [];
            let history = `与 ${currentChatCharacter.name} 的聊天记录\n\n`;
            
            messages.forEach(msg => {
                const time = formatTime(msg.timestamp);
                const sender = msg.sender === 'sent' ? '我' : currentChatCharacter.name;
                history += `${time} ${sender}: ${msg.content}\n`;
            });
            
            // 在实际应用中，这里可以实现导出文件功能
            console.log(history);
            alert('聊天记录已导出到控制台');
        }
        

        
        // 设置对方气泡颜色
        function changeTheirBubbleColor() {
            colorPickerContext = 'theirBubble';
            document.getElementById('color-picker-title').textContent = '设置对方气泡颜色';
            showModal('color-picker-modal');
        }
        
        // 设置我方气泡颜色
        function changeMyBubbleColor() {
            colorPickerContext = 'myBubble';
            document.getElementById('color-picker-title').textContent = '设置我方气泡颜色';
            showModal('color-picker-modal');
        }
        
        // 显示气泡颜色设置
        function showBubbleColorSettings() {
            alert('气泡颜色设置功能开发中...\n\n当前可以通过以下方式设置：\n• 修改对方气泡颜色\n• 修改我方气泡颜色');
        }
        
        // 清空聊天记录
        function clearChatHistory() {
            if (!currentChatCharacter) return;
            
            if (confirm(`确定要清空与 ${currentChatCharacter.name} 的所有聊天记录吗？\n\n此操作不可恢复！`)) {
                chatMessages[currentChatCharacter.id] = [];
                saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
                renderMessageList(); // 更新消息列表
                alert('聊天记录已清空');
                hideChatSettings();
            }
        }
        
        // 选择颜色
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }
        
        // 应用聊天背景
        function applyChatBackground() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const chatScreen = document.getElementById('api-chat-screen');
            const messagesContainer = document.getElementById('api-chat-messages');

            if (chatScreen) {
                if (chatSettings.chatBackground && chatSettings.chatBackground !== null) {
                    // 有背景图片
                    chatScreen.style.backgroundImage = `url(${chatSettings.chatBackground})`;
                    chatScreen.style.backgroundSize = 'cover';
                    chatScreen.style.backgroundPosition = 'center';
                    chatScreen.style.backgroundRepeat = 'no-repeat';
                    chatScreen.style.backgroundColor = 'transparent';
                    
                    // 让消息容器背景透明
                    if (messagesContainer) messagesContainer.style.background = 'transparent';
                } else {
                    // 没有背景图片或明确移除了背景
                    chatScreen.style.backgroundImage = 'none';
                    chatScreen.style.backgroundColor = 'white';
                    
                    // 恢复消息容器默认背景
                    if (messagesContainer) messagesContainer.style.background = ''; 
                }
            }
        }
        
        // 保存气泡样式设置
        function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // 保存样式设置
            chatSettings.bubbleStyle = window.selectedBubbleStyle || 'default';
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;
            chatSettings.bubbleOpacity = document.getElementById('bubble-opacity').value;
            
            // 更新显示文本
            const styleNames = {
                'default': '默认样式',
                'glass': '毛玻璃',
                'shadow': '经典阴影',
                'tail': '经典气泡',
                'gradient': '渐变样式',
                'minimal': '极简样式',
                'neon': '霓虹样式',
                'paper': '纸张样式'
            };
            
            document.getElementById('current-bubble-style').textContent = styleNames[chatSettings.bubbleStyle] || '默认样式';
            
            saveCurrentChatSettings(chatSettings);
            applyBubbleStyle();
            hideModal('bubble-style-modal');
            
            alert('气泡样式设置已保存');
        }
        
        // 应用气泡样式
        function applyBubbleStyle() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            const messagesContainer = document.getElementById('api-chat-messages');
            
            if (messagesContainer) {
                // 移除所有样式类
                messagesContainer.className = messagesContainer.className
                    .split(' ')
                    .filter(cls => !cls.startsWith('bubble-style-'))
                    .join(' ');
                
                // 添加当前样式类
                const style = chatSettings.bubbleStyle || 'default';
                messagesContainer.classList.add(`bubble-style-${style}`);
                
                // 设置CSS变量用于动态颜色
                const myColor = chatSettings.myBubbleColor || '#007AFF';
                const aiColor = chatSettings.aiBubbleColor || '#f0f0f0';
                const opacity = chatSettings.bubbleOpacity || '1';
                
                messagesContainer.style.setProperty('--my-bubble-color', myColor);
                messagesContainer.style.setProperty('--ai-bubble-color', aiColor);
                messagesContainer.style.setProperty('--bubble-opacity', opacity);
            }
        }
        
        // 显示气泡颜色选择器
        function showBubbleColorPicker(context) {
            colorPickerContext = context;
            document.getElementById('color-picker-title').textContent = '设置气泡颜色';
            showModal('color-picker-modal');
        }
        
        // 选择颜色
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            document.getElementById('selected-color').value = color;
        }
        
        // 应用颜色选择
        function applyColorSelection() {
            const selectedColor = document.querySelector('.color-option.selected')?.style.backgroundColor || '#007AFF';
            const opacity = document.getElementById('opacity-slider').value;
            
            if (colorPickerContext === 'theirBubble') {
                chatSettings.theirBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            } else if (colorPickerContext === 'myBubble') {
                chatSettings.myBubbleColor = selectedColor;
                chatSettings.bubbleOpacity = opacity;
            }
            
            saveChatSettings();
            renderChatMessages(currentChatCharacter.id);
            hideModal('color-picker-modal');
        }
        
        // 显示壁纸选择器
        function showWallpaperPicker() {
            showModal('wallpaper-picker-modal');
        }
        
        // 选择壁纸（保留函数以防其他地方调用，但现在主要通过文件上传选择）
        function selectWallpaper(wallpaperId) {
            console.log('选择壁纸:', wallpaperId);
            selectedWallpaper = wallpaperId;
            console.log('selectedWallpaper已设置为:', selectedWallpaper);
        }
        
        // 应用壁纸选择
        async function applyWallpaperSelection() {
            console.log('应用壁纸被调用，selectedWallpaper:', selectedWallpaper);
            
            if (!selectedWallpaper) {
                alert('请先从相册选择一张图片作为壁纸');
                return;
            }
            
            if (selectedWallpaper.startsWith('data:image')) {
                // 应用上传的图片壁纸
                console.log('应用图片壁纸');
                document.querySelector('.wallpaper').style.backgroundImage = `url(${selectedWallpaper})`;
                document.querySelector('.wallpaper').style.backgroundSize = '100% 100%';
                document.querySelector('.wallpaper').style.backgroundPosition = 'center';
                
                // 使用IndexedDB保存壁纸，避免localStorage空间限制
                try {
                    await db.wallpapers.clear();
                    await db.wallpapers.add({
                        id: 'main',
                        type: 'image',
                        data: selectedWallpaper
                    });
                    console.log('壁纸保存成功到IndexedDB');
                    hideModal('wallpaper-picker-modal');
                } catch (e) {
                    console.error('保存壁纸失败:', e);
                    alert('保存壁纸失败，请重试');
                }
            } else {
                alert('请先从相册选择一张图片作为壁纸');
            }
        }
        
        // 上传自定义壁纸
        function uploadCustomWallpaper() {
            document.getElementById('custom-wallpaper-upload').click();
        }
        
        // 显示图标选择器
        function showIconPicker() {
            showModal('icon-picker-modal');
        }
        
        // 选择应用图标
        function selectAppIcon(appId, iconClass) {
            selectedAppIcon = { appId, iconClass };
        }
        
        // 上传自定义图标
        function uploadCustomIcon() {
            document.getElementById('custom-icon-upload').click();
        }
        
        // 应用图标选择
        function applyIconSelection() {
            if (selectedAppIcon && customIconImage) {
                // 更新应用图标
                const appIcon = document.querySelector(`.app[onclick="showApp('${selectedAppIcon.appId}')"] .app-icon`);
                if (appIcon) {
                    appIcon.innerHTML = '';
                    appIcon.style.backgroundImage = `url(${customIconImage})`;
                    
                    // 保存到本地存储
                    let savedIcons = {};
                    try {
                        savedIcons = JSON.parse(localStorage.getItem('appIcons') || '{}');
                    } catch (error) {
                        console.error('解析本地存储的 appIcons 失败:', error);
                        savedIcons = {};
                    }
                    savedIcons[selectedAppIcon.appId] = customIconImage;
                    localStorage.setItem('appIcons', JSON.stringify(savedIcons));
                }
            } else if (selectedAppIcon) {
                saveAppIcons();
            }
            hideModal('icon-picker-modal');
        }
        
        // 更改聊天主题颜色
        function changeChatThemeColor() {
            colorPickerContext = 'theme';
            document.getElementById('color-picker-title').textContent = '设置聊天主题颜色';
            showModal('color-picker-modal');
        }
        
        // 拍照
        function capturePhoto() {
            showModal('photo-capture-modal');
        }
        
        // 取消照片
        function cancelPhoto() {
            hideModal('photo-capture-modal');
        }
        
        // 保存照片
        function savePhoto() {
            const description = document.getElementById('photo-description').value.trim() || '未命名照片';
            const location = document.getElementById('photo-location-input').value.trim() || '未知地点';
            
            const now = new Date();
            const photo = {
                id: Date.now().toString(),
                image: 'https://via.placeholder.com/300', // 在实际应用中，这里应该是拍摄的照片
                description,
                location,
                timestamp: now.toISOString(),
                timeString: formatTime(now.getTime()),
                locationString: location
            };
            
            photos.push(photo);
            savePhotos();
            renderAlbum();
            hideModal('photo-capture-modal');
        }
        
        // 显示照片详情
        function showPhotoDetail(photo) {
            document.getElementById('photo-image').style.backgroundImage = `url(${photo.image})`;
            document.getElementById('photo-description-text').textContent = photo.description;
            document.getElementById('photo-time').textContent = `拍摄于: ${formatFullDate(new Date(photo.timestamp))}`;
            document.getElementById('photo-location').textContent = `地点: ${photo.location}`;
            showApp('photo-detail-screen');
        }
        
        // 显示消息菜单
        function showMessageMenu(messageId, event) {
            selectedMessageId = messageId;
            
            // 创建或获取菜单元素
            let menu = document.getElementById('message-context-menu');
            if (!menu) {
                menu = document.createElement('div');
                menu.id = 'message-context-menu';
                menu.className = 'message-menu';
                menu.innerHTML = `
                    <div class="message-menu-item" onclick="copyMessage()">复制</div>
                    <div class="message-menu-item danger" onclick="deleteMessage()">删除</div>
                `;
                document.body.appendChild(menu);
            }
            
            // 定位菜单
            const x = event.clientX || event.pageX;
            const y = event.clientY || event.pageY;
            
            menu.style.display = 'block';
            menu.style.left = `${Math.min(x, window.innerWidth - 150)}px`;
            menu.style.top = `${Math.min(y, window.innerHeight - 100)}px`;
            
            // 点击其他地方关闭菜单
            setTimeout(() => {
                document.addEventListener('click', hideMessageMenu);
                document.addEventListener('touchstart', hideMessageMenu);
            }, 100);
        }
        
        // 隐藏消息菜单
        function hideMessageMenu() {
            const menu = document.getElementById('message-context-menu');
            if (menu) {
                menu.style.display = 'none';
            }
            document.removeEventListener('click', hideMessageMenu);
            document.removeEventListener('touchstart', hideMessageMenu);
        }
        
        // 复制消息
        function copyMessage() {
            if (!selectedMessageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const message = messages.find(msg => msg.id === selectedMessageId);
            
            if (message && message.content) {
                navigator.clipboard.writeText(message.content).then(() => {
                    alert('消息已复制');
                }).catch(() => {
                    alert('复制失败，请重试');
                });
            }
            
            hideMessageMenu();
        }
        
        // 编辑消息
        function editMessage() {
            if (!selectedMessageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const messageIndex = messages.findIndex(msg => msg.id === selectedMessageId);
            
            if (messageIndex !== -1 && messages[messageIndex].sender === 'sent') {
                const newContent = prompt('编辑消息:', messages[messageIndex].content);
                if (newContent !== null) {
                    messages[messageIndex].content = newContent;
                    saveChatMessages();
                    renderChatMessages(currentChatCharacter.id);
                }
            } else {
                alert('只能编辑自己发送的消息');
            }
            
            hideModal('message-menu-modal');
        }
        
        // 验证头像来源是否有效
        async function validateAvatarSource(avatarUrl) {
            console.log('验证头像来源:', avatarUrl);
            if (!avatarUrl) return false;
            
            // 检查是否是用户发送的图片（在聊天记录中）
            if (currentChatCharacter && chatMessages[currentChatCharacter.id]) {
                const userImages = chatMessages[currentChatCharacter.id]
                    .filter(msg => msg.sender === 'sent' && msg.image)
                    .map(msg => msg.image);
                
                console.log('用户发送的图片列表:', userImages);
                console.log('检查头像URL是否在用户图片中:', userImages.includes(avatarUrl));
                
                if (userImages.includes(avatarUrl)) {
                    console.log('头像来源验证通过：用户发送的图片');
                    return true;
                }
            }
            
            // 检查是否是世界书中提供的头像URL
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.worldbookMountEnabled && chatSettings.selectedWorldbooks) {
                for (const worldbookId of chatSettings.selectedWorldbooks) {
                    const worldbook = worldbooks.find(w => w.id === worldbookId);
                    if (worldbook && worldbook.content && worldbook.content.includes(avatarUrl)) {
                        console.log('头像来源验证通过：世界书中的URL');
                        return true;
                    }
                }
            }
            
            console.log('头像来源验证失败');
            return false;
        }
        
        // 角色主动更换头像功能
        async function changeCharacterAvatarByAI(newAvatarUrl, reason = '') {
            if (!currentChatCharacter || !newAvatarUrl) return false;
            
            try {
                // 更新角色头像
                const characterIndex = characters.findIndex(c => c.id === currentChatCharacter.id);
                if (characterIndex !== -1) {
                    characters[characterIndex].avatarUrl = newAvatarUrl;
                    await saveCharacters();
                    
                    // 更新当前聊天角色引用
                    currentChatCharacter.avatarUrl = newAvatarUrl;
                    
                    // 刷新界面
                    renderCharacterList();
                    renderContactList();
                    renderMessageList();
                    renderChatMessages(currentChatCharacter.id);
                    
                    // 发送系统提示消息
                    const systemMessage = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `${currentChatCharacter.name} 更换了头像${reason ? ': ' + reason : ''}`,
                        timestamp: Date.now(),
                        isAvatarChange: true
                    };
                    
                    if (!chatMessages[currentChatCharacter.id]) {
                        chatMessages[currentChatCharacter.id] = [];
                    }
                    chatMessages[currentChatCharacter.id].push(systemMessage);
                    await saveChatMessages();
                    
                    // 🔥【修复】添加头像更换系统消息到当前聊天界面，不重新渲染整个列表
                    addSystemMessageToChat(systemMessage);
                    
                    return true;
                }
            } catch (error) {
                console.error('角色更换头像失败:', error);
                return false;
            }
            
            return false;
        }
        
        // 删除消息
        function deleteMessage() {
            if (!selectedMessageId) return;
            
            const messages = chatMessages[currentChatCharacter.id] || [];
            const messageIndex = messages.findIndex(msg => msg.id === selectedMessageId);
            
            if (messageIndex === -1) {
                hideMessageMenu();
                return;
            }
            
            const messageToDelete = messages[messageIndex];
            
            if (confirm('确定要撤回这条消息吗？')) {
                // 保存原始消息内容
                const originalContent = messageToDelete.content || '[图片]';
                
                // 删除原消息
                messages.splice(messageIndex, 1);
                
                // 🔥【新增】创建撤回消息系统提醒
                const whoRecalled = messageToDelete.sender === 'received' ? currentChatCharacter.name : '你';
                const recallSystemMessage = {
                    id: Date.now().toString(),
                    sender: 'system',
                    content: `${whoRecalled} 撤回了一条消息\n原文：${originalContent}`,
                    timestamp: messageToDelete.timestamp || Date.now(),
                    isRecall: true
                };
                
                // 在原位置插入撤回提醒
                messages.splice(messageIndex, 0, recallSystemMessage);
                
                saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
                // 更新消息列表中的最后一条消息
                renderMessageList();
            }
            
            hideMessageMenu();
        }
        

        
        // 格式化时间
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // 格式化时间戳（完整时间）
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;
            
            if (messageDate.getTime() === today.getTime()) {
                return timeStr; // 今天只显示时间
            } else if (messageDate.getTime() === yesterday.getTime()) {
                return `昨天 ${timeStr}`;
            } else {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}月${day}日 ${timeStr}`;
            }
        }
        
        // 格式化时间（仅时分）
        function formatTimeOnly(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // 格式化完整日期
        function formatFullDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}年${month}月${day}日 ${hours}:${minutes}`;
        }
        
        // 加载URL
        function loadUrl() {
            const url = document.getElementById('browser-url').value;
            let fullUrl = url;
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                fullUrl = 'https://' + url;
            }
            
            document.getElementById('browser-frame').src = fullUrl;
        }
        
        // API类型切换处理
        function onApiTypeChange() {
            const apiType = document.getElementById('api-type').value;
            const baseInput = document.getElementById('api-base');
            const endpointGroup = document.getElementById('endpoint-group');
            const keyInput = document.getElementById('api-key');
            const modelInput = document.getElementById('api-model');
            const modelSelect = document.getElementById('api-model-select');
            const fetchModelsBtn = document.getElementById('fetch-models-btn');
            const modelHint = document.getElementById('model-hint');
            
            if (apiType === 'gemini') {
                baseInput.placeholder = 'https://generativelanguage.googleapis.com/v1beta';
                if (!baseInput.value || baseInput.value === 'https://api.openai.com/v1') {
                    baseInput.value = 'https://generativelanguage.googleapis.com/v1beta';
                }
                endpointGroup.style.display = 'none';
                keyInput.placeholder = 'AIzaSy...（从Google AI Studio获取）';
                modelInput.style.display = 'none';
                modelSelect.style.display = 'block';
                fetchModelsBtn.style.display = 'block';
                modelHint.textContent = '点击"获取模型"自动拉取可用模型列表';
            } else {
                if (apiType === 'openai') {
                    baseInput.placeholder = 'https://api.openai.com/v1';
                    if (!baseInput.value || baseInput.value === 'https://generativelanguage.googleapis.com/v1beta') {
                        baseInput.value = 'https://api.openai.com/v1';
                    }
                    keyInput.placeholder = 'sk-xxxxxxxxxxxxxxxx';
                    modelHint.textContent = '例如: gpt-4o, gpt-3.5-turbo';
                } else if (apiType === 'anthropic') {
                    baseInput.placeholder = 'https://api.anthropic.com';
                    if (!baseInput.value || baseInput.value.includes('googleapis.com')) {
                        baseInput.value = 'https://api.anthropic.com';
                    }
                    keyInput.placeholder = 'sk-ant-xxxxxxxxxxxxxxxx';
                    modelHint.textContent = '例如: claude-3-sonnet-20240229';
                } else if (apiType === 'azure') {
                    baseInput.placeholder = 'https://your-resource.openai.azure.com';
                    keyInput.placeholder = 'your-api-key';
                    modelHint.textContent = '输入您的部署名称';
                }
                endpointGroup.style.display = 'block';
                modelInput.style.display = 'block';
                modelSelect.style.display = 'none';
                fetchModelsBtn.style.display = 'none';
            }
        }
        
        // 测试API连接
        async function testApiConnection() {
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.textContent = '测试中...';
            testBtn.disabled = true;
            
            try {
                // 获取当前设置
                const tempSettings = {
                    type: document.getElementById('api-type').value,
                    base: document.getElementById('api-base').value.trim(),
                    endpoint: document.getElementById('api-endpoint').value.trim(),
                    key: document.getElementById('api-key').value.trim(),
                    model: document.getElementById('api-type').value === 'gemini' ? 
                           document.getElementById('api-model-select').value : 
                           document.getElementById('api-model').value.trim(),
                    temperature: parseFloat(document.getElementById('api-temperature').value) || 0.70
                };
                
                if (!tempSettings.key) {
                    throw new Error('请先输入API密钥');
                }
                
                if (!tempSettings.base) {
                    throw new Error('请输入API基地址');
                }
                
                if (!tempSettings.model) {
                    throw new Error('请输入模型名称');
                }
                
                let url, headers, requestBody;
                
                if (tempSettings.type === 'gemini') {
                    // 修复Gemini API URL
                    const baseUrl = tempSettings.base.endsWith('/') ? tempSettings.base.slice(0, -1) : tempSettings.base;
                    url = `${baseUrl}/models/${tempSettings.model}:generateContent?key=${tempSettings.key}`;
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    requestBody = {
                        contents: [{
                            parts: [{
                                text: '你好，这是一个连接测试。请简单回复"连接成功"即可。'
                            }]
                        }],
                        generationConfig: {
                            temperature: tempSettings.temperature
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_NONE"
                            }
                        ]
                    };
                } else {
                    // OpenAI兼容格式
                    const baseUrl = tempSettings.base.endsWith('/') ? tempSettings.base.slice(0, -1) : tempSettings.base;
                    const endpoint = tempSettings.endpoint.startsWith('/') ? tempSettings.endpoint : '/' + tempSettings.endpoint;
                    url = baseUrl + endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tempSettings.key}`
                    };
                    requestBody = {
                        model: tempSettings.model,
                        messages: [
                            { role: 'user', content: '你好，这是一个连接测试。请简单回复"连接成功"即可。' }
                        ],
                        temperature: tempSettings.temperature
                    };
                }
                
                console.log('测试API连接 - URL:', url);
                console.log('测试API连接 - Headers:', headers);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        console.log('错误响应详情:', errorData);
                        errorMessage = errorData.error?.message || errorData.message || errorMessage;
                    } catch (e) {
                        const text = await response.text();
                        console.log('错误响应文本:', text);
                        errorMessage += '\n\n详细信息: ' + text;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('API响应:', data);
                
                let responseText;
                
                if (tempSettings.type === 'gemini') {
                    responseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                } else {
                    responseText = data.choices?.[0]?.message?.content;
                }
                
                if (responseText) {
                    alert('✅ API连接测试成功！\n\n回复内容：' + responseText);
                } else {
                    alert('⚠️ API连接成功，但返回格式可能有问题\n\n原始响应：' + JSON.stringify(data, null, 2));
                }
                
            } catch (error) {
                console.error('API测试失败:', error);
                let errorMsg = error.message;
                
                // 针对常见错误提供解决建议
                if (errorMsg.includes('CORS')) {
                    errorMsg += '\n\n💡 建议：请检查是否需要使用反代地址，或者API服务是否支持跨域请求。';
                } else if (errorMsg.includes('401') || errorMsg.includes('API key')) {
                    errorMsg += '\n\n💡 建议：请检查API密钥是否正确，以及是否有权限访问该模型。';
                } else if (errorMsg.includes('404')) {
                    errorMsg += '\n\n💡 建议：请检查API基地址和模型名称是否正确。';
                } else if (errorMsg.includes('403')) {
                    errorMsg += '\n\n💡 建议：API密钥权限不足或账户余额不足。';
                }
                
                alert('❌ API连接测试失败\n\n错误信息：' + errorMsg);
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }
        
        // 获取模型列表
        async function fetchModels() {
            const fetchBtn = document.getElementById('fetch-models-btn');
            const originalText = fetchBtn.textContent;
            fetchBtn.textContent = '获取中...';
            fetchBtn.disabled = true;
            
            try {
                const apiKey = document.getElementById('api-key').value.trim();
                const baseUrl = document.getElementById('api-base').value.trim();
                
                if (!apiKey) {
                    throw new Error('请先输入API密钥');
                }
                
                if (!baseUrl) {
                    throw new Error('请先输入API基地址');
                }
                
                // 构建获取模型列表的URL
                const modelsUrl = `${baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl}/models?key=${apiKey}`;
                
                console.log('获取模型列表 - URL:', modelsUrl);
                
                const response = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('模型列表响应:', data);
                
                const modelSelect = document.getElementById('api-model-select');
                modelSelect.innerHTML = '<option value="">选择模型...</option>';
                
                if (data.models && Array.isArray(data.models)) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name.startsWith('models/') ? model.name.substring(7) : model.name;
                        option.textContent = `${option.value} (${model.displayName || model.name})`;
                        modelSelect.appendChild(option);
                    });
                    
                    alert(`✅ 成功获取到 ${data.models.length} 个模型`);
                } else {
                    throw new Error('API返回的模型列表格式不正确');
                }
                
            } catch (error) {
                console.error('获取模型列表失败:', error);
                alert('❌ 获取模型列表失败\n\n错误信息：' + error.message);
            } finally {
                fetchBtn.textContent = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        // 保存API设置
        function saveApiSettings() {
            apiSettings = {
                type: document.getElementById('api-type').value,
                base: document.getElementById('api-base').value.trim(),
                endpoint: document.getElementById('api-endpoint').value.trim(),
                key: document.getElementById('api-key').value.trim(),
                model: document.getElementById('api-type').value === 'gemini' ? 
                       (document.getElementById('api-model-select') ? document.getElementById('api-model-select').value : document.getElementById('api-model').value.trim()) : 
                       document.getElementById('api-model').value.trim(),
                temperature: parseFloat(document.getElementById('api-temperature').value) || 0.70
            };
            
            localStorage.setItem('apiSettings', JSON.stringify(apiSettings));
            alert('API设置已保存');
            hideApp('api-settings-screen');
        }
        
        // 电池管理功能
        async function initBatteryManager() {
            // 首先设置默认显示为 ᰔᩚ
            const allBatteryTexts = document.querySelectorAll('.battery-text');
            allBatteryTexts.forEach(element => {
                element.textContent = 'ᰔᩚ';
            });
            
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    updateBatteryDisplay(battery);
                    
                    battery.addEventListener('levelchange', () => updateBatteryDisplay(battery));
                    battery.addEventListener('chargingchange', () => updateBatteryDisplay(battery));
                } catch (err) {
                    console.error("无法获取电池信息:", err);
                    // 保持默认显示 ᰔᩚ
                    allBatteryTexts.forEach(element => {
                        element.textContent = 'ᰔᩚ';
                    });
                }
            } else {
                console.log("浏览器不支持电池状态API，使用默认显示。");
                // 保持默认显示 ᰔᩚ
                allBatteryTexts.forEach(element => {
                    element.textContent = 'ᰔᩚ';
                });
            }
        }
        
        function updateBatteryDisplay(battery) {
            const level = Math.floor(battery.level * 100);
            const isCharging = battery.charging;
            
            // 更新主状态栏电池
            const batteryContainer = document.getElementById('status-bar-battery');
            if (batteryContainer) {
                const batteryLevelEl = batteryContainer.querySelector('.battery-level');
                const batteryTextEl = batteryContainer.querySelector('.battery-text');
                
                if (batteryLevelEl && batteryTextEl) {
                    batteryLevelEl.style.width = `${level}%`;
                    batteryTextEl.textContent = `${level}%`;
                    
                    if (isCharging) {
                        batteryContainer.classList.add('charging');
                    } else {
                        batteryContainer.classList.remove('charging');
                    }
                }
            }
            
            // 更新应用内状态栏电池
            const appBatteryContainers = document.querySelectorAll('.app-battery-container');
            const appBatteryTexts = document.querySelectorAll('.app-battery-container .battery-text');
            const appBatteryLevels = document.querySelectorAll('.app-battery-level');
            
            // 应用内也显示真实电量
            appBatteryTexts.forEach(element => {
                element.textContent = `${level}%`;
            });
            
            appBatteryLevels.forEach(element => {
                element.style.width = `${level}%`;
            });
            
            // 同步应用内电池充电状态
            appBatteryContainers.forEach(container => {
                if (isCharging) {
                    container.classList.add('charging');
                } else {
                    container.classList.remove('charging');
                }
            });
        }
        
        // 主题切换功能
        function changeTheme(themeName) {
            const body = document.body;
            
            // 移除之前的主题
            body.removeAttribute('data-theme');
            
            // 应用新主题
            if (themeName !== 'default') {
                body.setAttribute('data-theme', themeName);
            }
            
            // 保存主题设置
            localStorage.setItem('selectedTheme', themeName);
            
            // 给用户反馈
            const themeNames = {
                'default': '简约风格',
                'cute': '可爱风格',
                'nature': '自然风格', 
                'tech': '科技风格',
                'dream': '梦幻风格'
            };
            
            // 可以添加一个简单的提示
            setTimeout(() => {
                alert(`已切换到 ${themeNames[themeName]} 主题`);
            }, 100);
        }
        
        // 加载保存的主题
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme && savedTheme !== 'default') {
                document.body.setAttribute('data-theme', savedTheme);
            }
        }
        
        // 世界书相关功能
        let worldbooks = [];
        let editingWorldbook = null;
        
        // 加载世界书数据 - 使用IndexedDB（包含数据迁移）
        async function loadWorldbooks() {
            try {
                // 先从IndexedDB加载
                const savedWorldbooks = await db.worldbooks.toArray();
                
                if (savedWorldbooks.length === 0) {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localStorageData = localStorage.getItem('worldbooks');
                    if (localStorageData) {
                        console.log('检测到localStorage中的世界书数据，开始迁移...');
                        const localWorldbooks = JSON.parse(localStorageData);
                        
                        if (localWorldbooks.length > 0) {
                            // 确保每个世界书都有id字段
                            const migrationData = localWorldbooks.map(wb => ({
                                id: wb.id || Date.now().toString() + Math.random(),
                                title: wb.title,
                                content: wb.content,
                                createdAt: wb.createdAt || new Date().toISOString(),
                                updatedAt: wb.updatedAt || new Date().toISOString()
                            }));
                            
                            // 迁移到IndexedDB
                            await db.worldbooks.bulkAdd(migrationData);
                            worldbooks = migrationData;
                            console.log('世界书数据迁移完成:', worldbooks);
                        } else {
                            worldbooks = [];
                        }
                    } else {
                        worldbooks = [];
                    }
                } else {
                    // IndexedDB中有数据，直接使用
                    worldbooks = savedWorldbooks;
                    console.log('从IndexedDB加载世界书数据:', worldbooks);
                }
            } catch (error) {
                console.error('加载世界书失败:', error);
                // 如果IndexedDB失败，回退到localStorage
                const localStorageData = localStorage.getItem('worldbooks');
                if (localStorageData) {
                    try {
                        worldbooks = JSON.parse(localStorageData);
                    } catch (e) {
                        worldbooks = [];
                    }
                } else {
                    worldbooks = [];
                }
            }
            renderWorldbookList();
        }
        
        // 保存世界书数据 - 使用IndexedDB
        async function saveWorldbooks() {
            try {
                console.log('保存世界书数据到IndexedDB:', worldbooks);
                
                // 清空现有数据
                await db.worldbooks.clear();
                
                // 批量插入新数据
                if (worldbooks.length > 0) {
                    await db.worldbooks.bulkAdd(worldbooks);
                }
                
                console.log('世界书数据保存成功');
            } catch (error) {
                console.error('保存世界书时发生错误:', error);
                // 如果IndexedDB失败，回退到localStorage
                localStorage.setItem('worldbooks', JSON.stringify(worldbooks));
            }
        }
        
        function showWorldbookForm() {
            editingWorldbook = null;
            document.getElementById('worldbook-form-title').textContent = '新建世界书';
            document.getElementById('worldbook-title').value = '';
            document.getElementById('worldbook-content').value = '';
            showApp('worldbook-form-screen');
        }
        
        function hideWorldbookForm() {
            hideApp('worldbook-form-screen');
        }
        
        async function saveWorldbook() {
            const title = document.getElementById('worldbook-title').value.trim();
            const content = document.getElementById('worldbook-content').value.trim();
            
            if (!title) {
                alert('请输入世界书标题');
                return;
            }
            
            if (!content) {
                alert('请输入世界书内容');
                return;
            }
            
            const worldbook = {
                id: editingWorldbook ? editingWorldbook.id : Date.now().toString(),
                title: title,
                content: content,
                createdAt: editingWorldbook ? editingWorldbook.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingWorldbook) {
                const index = worldbooks.findIndex(w => w.id === editingWorldbook.id);
                if (index !== -1) {
                    worldbooks[index] = worldbook;
                }
            } else {
                worldbooks.push(worldbook);
            }
            
            await saveWorldbooks();
            renderWorldbookList();
            hideWorldbookForm();
        }
        
        function editWorldbook(id) {
            const worldbook = worldbooks.find(w => w.id === id);
            if (worldbook) {
                editingWorldbook = worldbook;
                document.getElementById('worldbook-form-title').textContent = '编辑世界书';
                document.getElementById('worldbook-title').value = worldbook.title;
                document.getElementById('worldbook-content').value = worldbook.content;
                showApp('worldbook-form-screen');
            }
        }
        
        async function deleteWorldbook(id) {
            if (confirm('确定要删除这个世界书吗？')) {
                worldbooks = worldbooks.filter(w => w.id !== id);
                await saveWorldbooks();
                renderWorldbookList();
            }
        }
        
        function renderWorldbookList() {
            const listContainer = document.getElementById('worldbook-list');
            if (!listContainer) return;
            
            if (worldbooks.length === 0) {
                listContainer.innerHTML = '<div class="empty-worldbook">还没有世界书，点击右上角+号创建一个吧！</div>';
                return;
            }
            
            const html = worldbooks.map(worldbook => {
                const date = new Date(worldbook.updatedAt).toLocaleDateString();
                const preview = worldbook.content.substring(0, 100) + (worldbook.content.length > 100 ? '...' : '');
                
                return `
                    <div class="worldbook-item">
                        <div class="worldbook-header">
                            <div class="worldbook-content-flex" onclick="editWorldbook('${worldbook.id}')">
                                <div class="worldbook-title">${worldbook.title}</div>
                                <div class="worldbook-desc-text">${preview}</div>
                                <div class="worldbook-date-text">更新于 ${date}</div>
                            </div>
                            <button onclick="deleteWorldbook('${worldbook.id}')" class="delete-worldbook-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = html;
        }
        
        // 音乐应用相关功能
        let playlist = [];
        let currentSong = null;
        let isPlaying = false;
        let listeningCharacters = [];
        
        function loadMusicData() {
            const savedPlaylist = localStorage.getItem('musicPlaylist');
            if (savedPlaylist) {
                try {
                    playlist = JSON.parse(savedPlaylist);
                } catch (e) {
                    playlist = [];
                }
            }
            
            const savedListeners = localStorage.getItem('listeningCharacters');
            if (savedListeners) {
                try {
                    listeningCharacters = JSON.parse(savedListeners);
                } catch (e) {
                    listeningCharacters = [];
                }
            }
            
            renderPlaylist();
            renderListeningCharacters();
        }
        
        function saveMusicData() {
            localStorage.setItem('musicPlaylist', JSON.stringify(playlist));
            localStorage.setItem('listeningCharacters', JSON.stringify(listeningCharacters));
        }
        
        function addMusicToPlaylist() {
            const title = prompt('请输入歌曲名称:');
            if (title && title.trim()) {
                const artist = prompt('请输入艺术家名称:') || '未知艺术家';
                const song = {
                    id: Date.now().toString(),
                    title: title.trim(),
                    artist: artist.trim(),
                    duration: '3:30' // 模拟时长
                };
                
                playlist.push(song);
                saveMusicData();
                renderPlaylist();
            }
        }
        
        function playSong(songId) {
            const song = playlist.find(s => s.id === songId);
            if (song) {
                currentSong = song;
                document.getElementById('song-title').textContent = song.title;
                document.getElementById('artist-name').textContent = song.artist;
                document.getElementById('total-time').textContent = song.duration;
                
                // 更新播放按钮
                const playBtn = document.getElementById('play-pause-btn');
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
                
                // 模拟播放进度
                simulatePlayback();
                
                // 通知听歌角色
                notifyListeningCharacters(song);
            }
        }
        
        function togglePlayPause() {
            const playBtn = document.getElementById('play-pause-btn');
            if (isPlaying) {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            } else {
                if (currentSong) {
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                    simulatePlayback();
                } else if (playlist.length > 0) {
                    playSong(playlist[0].id);
                }
            }
        }
        
        function previousSong() {
            if (!currentSong || playlist.length === 0) return;
            
            const currentIndex = playlist.findIndex(s => s.id === currentSong.id);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : playlist.length - 1;
            playSong(playlist[prevIndex].id);
        }
        
        function nextSong() {
            if (!currentSong || playlist.length === 0) return;
            
            const currentIndex = playlist.findIndex(s => s.id === currentSong.id);
            const nextIndex = currentIndex < playlist.length - 1 ? currentIndex + 1 : 0;
            playSong(playlist[nextIndex].id);
        }
        
        function simulatePlayback() {
            if (!isPlaying) return;
            
            // 这里只是模拟进度，实际应用中需要真实的音频播放
            let progress = 0;
            const interval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(interval);
                    return;
                }
                
                progress += 1;
                document.getElementById('progress').style.width = `${Math.min(progress, 100)}%`;
                
                const currentMinutes = Math.floor(progress * 3.5 / 100);
                const currentSeconds = Math.floor((progress * 3.5 / 100 - currentMinutes) * 60);
                document.getElementById('current-time').textContent = 
                    `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    nextSong();
                }
            }, 100);
        }
        
        function inviteCharacterToListen() {
            const availableCharacters = characters.filter(c => 
                !listeningCharacters.find(lc => lc.id === c.id)
            );
            
            if (availableCharacters.length === 0) {
                alert('没有可邀请的角色了，或者所有角色都已经在听歌');
                return;
            }
            
            const characterNames = availableCharacters.map((c, index) => `${index + 1}. ${c.name}`).join('\n');
            const choice = prompt(`选择要邀请的角色:\n${characterNames}\n\n请输入数字:`);
            
            if (choice && !isNaN(choice)) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < availableCharacters.length) {
                    const character = availableCharacters[index];
                    listeningCharacters.push({
                        id: character.id,
                        name: character.name,
                        avatar: character.avatarUrl || character.name.charAt(0),
                        joinedAt: new Date().toISOString()
                    });
                    
                    saveMusicData();
                    renderListeningCharacters();
                    
                    // 模拟角色响应
                    setTimeout(() => {
                        alert(`${character.name}: 好的，我来和你一起听歌！`);
                    }, 500);
                }
            }
        }
        
        function removeListeningCharacter(characterId) {
            listeningCharacters = listeningCharacters.filter(c => c.id !== characterId);
            saveMusicData();
            renderListeningCharacters();
        }
        
        function notifyListeningCharacters(song) {
            listeningCharacters.forEach(character => {
                // 模拟角色对音乐的反应
                const reactions = [
                    `${character.name}: 这首歌真好听！`,
                    `${character.name}: 我也很喜欢这首《${song.title}》`,
                    `${character.name}: 听着这音乐心情真好～`,
                    `${character.name}: 谢谢分享这么棒的音乐！`
                ];
                
                const reaction = reactions[Math.floor(Math.random() * reactions.length)];
                
                setTimeout(() => {
                    // 可以在这里显示角色的反应消息
                    console.log(reaction);
                }, Math.random() * 3000 + 1000);
            });
        }
        
        function renderPlaylist() {
            const playlistContainer = document.getElementById('playlist');
            if (!playlistContainer) return;
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = '<div class="empty-playlist">播放列表为空，点击+号添加音乐</div>';
                return;
            }
            
            const html = playlist.map(song => `
                <div class="playlist-item" onclick="playSong('${song.id}')">
                    <div>
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                    </div>
                    <div class="song-duration">${song.duration}</div>
                </div>
            `).join('');
            
            playlistContainer.innerHTML = html;
        }
        
        function renderListeningCharacters() {
            const container = document.getElementById('listening-characters');
            if (!container) return;
            
            if (listeningCharacters.length === 0) {
                container.innerHTML = '<div class="empty-playlist">没有角色在听歌，点击+号邀请角色</div>';
                return;
            }
            
            const html = listeningCharacters.map(character => `
                <div class="character-item">
                    <div class="character-avatar" style="background-image: url(${character.avatar}); background-size: cover; background-position: center;">
                        ${character.avatar.startsWith('http') ? '' : character.name.charAt(0)}
                    </div>
                    <div class="character-name">${character.name}</div>
                    <div class="listening-status">正在听歌</div>
                    <button onclick="removeListeningCharacter('${character.id}')" class="remove-character-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // ================== 面具系统相关功能 ==================
        
        // 加载面具数据 - 使用IndexedDB（包含数据迁移）
        async function loadPersonas() {
            try {
                // 先从IndexedDB加载
                const savedPersonas = await db.personas.toArray();
                
                if (savedPersonas.length === 0) {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localStorageData = localStorage.getItem('personas');
                    if (localStorageData) {
                        console.log('检测到localStorage中的面具数据，开始迁移...');
                        const localPersonas = JSON.parse(localStorageData);
                        
                        if (localPersonas.length > 0) {
                            // 确保每个面具都有必要字段
                            const migrationData = localPersonas.map(persona => ({
                                id: persona.id || Date.now().toString() + Math.random(),
                                name: persona.name,
                                description: persona.description || '',
                                avatarUrl: persona.avatarUrl || '',
                                isDefault: persona.isDefault || false,
                                createdAt: persona.createdAt || new Date().toISOString(),
                                updatedAt: persona.updatedAt || new Date().toISOString()
                            }));
                            
                            // 迁移到IndexedDB
                            await db.personas.bulkAdd(migrationData);
                            personas = migrationData;
                            console.log('面具数据迁移完成:', personas);
                        } else {
                            personas = [];
                        }
                    } else {
                        personas = [];
                    }
                } else {
                    // IndexedDB中有数据，直接使用
                    personas = savedPersonas;
                    console.log('从IndexedDB加载面具数据:', personas);
                }
                
                // 设置当前面具（暂时保持localStorage，因为这是一个小数据）
                const savedCurrentPersona = localStorage.getItem('currentPersona');
                if (savedCurrentPersona) {
                    currentPersona = personas.find(p => p.id === savedCurrentPersona) || personas[0];
                } else {
                    currentPersona = personas[0];
                }
                
            } catch (error) {
                console.error('加载面具失败:', error);
                // 如果IndexedDB失败，回退到localStorage
                const localStorageData = localStorage.getItem('personas');
                if (localStorageData) {
                    try {
                        personas = JSON.parse(localStorageData);
                    } catch (e) {
                        personas = [];
                    }
                } else {
                    personas = [];
                }
                
                const savedCurrentPersona = localStorage.getItem('currentPersona');
                if (savedCurrentPersona) {
                    currentPersona = personas.find(p => p.id === savedCurrentPersona) || personas[0];
                } else {
                    currentPersona = personas[0];
                }
            }
            
            updateCurrentPersonaDisplay();
        }
        
        // 保存面具数据 - 使用IndexedDB
        async function savePersonas() {
            try {
                console.log('保存面具数据到IndexedDB:', personas);
                
                // 清空现有数据
                await db.personas.clear();
                
                // 批量插入新数据
                if (personas.length > 0) {
                    await db.personas.bulkAdd(personas);
                }
                
                console.log('面具数据保存成功');
            } catch (error) {
                console.error('保存面具时发生错误:', error);
                // 如果IndexedDB失败，回退到localStorage
                localStorage.setItem('personas', JSON.stringify(personas));
            }
        }
        
        // 保存当前使用的面具（保持localStorage，因为数据量小）
        function saveCurrentPersona() {
            if (currentPersona) {
                localStorage.setItem('currentPersona', currentPersona.id);
            }
        }
        
        // 显示面具创建表单
        function showPersonaForm(personaId = null) {
            editingPersona = personaId ? personas.find(p => p.id === personaId) : null;
            
            document.getElementById('persona-form-title').textContent = editingPersona ? '编辑面具' : '新建面具';
            
            // 清空表单
            document.getElementById('persona-name').value = editingPersona ? editingPersona.name : '';
            document.getElementById('persona-description').value = editingPersona ? editingPersona.description : '';
            
            // 重置头像预览
            const avatarPreview = document.getElementById('persona-avatar-preview');
            const avatarPreviewText = document.getElementById('persona-avatar-preview-text');
            
            avatarPreview.classList.remove('has-image');
            avatarPreview.style.removeProperty('background');
            avatarPreview.style.removeProperty('background-size');
            avatarPreview.style.removeProperty('background-position');
            avatarPreview.style.removeProperty('background-repeat');
            
            if (editingPersona && editingPersona.avatarUrl) {
                avatarPreview.classList.add('has-image');
                avatarPreview.style.setProperty('background', `url(${editingPersona.avatarUrl})`, 'important');
                avatarPreview.style.setProperty('background-size', 'cover', 'important');
                avatarPreview.style.setProperty('background-position', 'center', 'important');
                avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                avatarPreviewText.style.display = 'none';
                window.selectedPersonaAvatarData = editingPersona.avatarUrl;
            } else {
                avatarPreviewText.style.display = 'block';
                avatarPreviewText.textContent = editingPersona ? editingPersona.name.charAt(0) : '我';
                window.selectedPersonaAvatarData = null;
            }
            
            // 初始化头像上传功能
            initializePersonaAvatarUpload();
            
            showApp('persona-form-screen');
        }
        
        // 隐藏面具表单
        function hidePersonaForm() {
            hideApp('persona-form-screen');
            showApp('chat-screen');
            switchWechatTab('profile-page');
            // 清空临时数据
            window.selectedPersonaAvatarData = null;
            editingPersona = null;
        }
        
        // 保存面具
        async function savePersona() {
            const name = document.getElementById('persona-name').value.trim();
            const description = document.getElementById('persona-description').value.trim();
            const avatarData = window.selectedPersonaAvatarData;
            
            if (!name) {
                alert('请输入面具名称');
                return;
            }
            
            if (editingPersona) {
                // 更新现有面具
                const index = personas.findIndex(p => p.id === editingPersona.id);
                if (index !== -1) {
                    personas[index] = {
                        ...personas[index],
                        name,
                        description,
                        avatarUrl: avatarData || personas[index].avatarUrl || '',
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // 创建新面具
                const newPersona = {
                    id: Date.now().toString(),
                    name,
                    description,
                    avatarUrl: avatarData || '',
                    isDefault: false,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                personas.push(newPersona);
            }
            
            await savePersonas();
            renderPersonaList();
            hidePersonaForm();
            alert('面具保存成功！');
        }
        
        // 删除面具
        async function deletePersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (!persona) return;
            
            if (confirm(`确定要删除面具"${persona.name}"吗？`)) {
                personas = personas.filter(p => p.id !== personaId);
                
                // 如果删除的是当前面具，切换到第一个面具（如果有的话）
                if (currentPersona && currentPersona.id === personaId) {
                    currentPersona = personas[0] || null;
                    saveCurrentPersona();
                    updateCurrentPersonaDisplay();
                }
                
                await savePersonas();
                renderPersonaList();
            }
        }
        
        // 切换面具
        function switchPersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (persona) {
                currentPersona = persona;
                saveCurrentPersona();
                updateCurrentPersonaDisplay();
                renderPersonaList();
                alert(`已切换到面具"${persona.name}"`);
            }
        }
        
        // 更新当前面具显示
        function updateCurrentPersonaDisplay() {
            // 由于删除了默认身份显示元素，这个函数现在为空
            // 保留函数定义以避免其他地方的调用出错
        }
        
        // 渲染面具列表
        function renderPersonaList() {
            const listContainer = document.getElementById('persona-list');
            if (!listContainer) return;
            
            if (personas.length === 0) {
                listContainer.innerHTML = '<div class="empty-personas">还没有面具，点击右上角+号创建一个吧！</div>';
                return;
            }
            
            const html = personas.map(persona => `
                <div class="persona-item ${currentPersona && currentPersona.id === persona.id ? 'active' : ''}" onclick="switchPersona('${persona.id}')">
                    <div class="persona-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                        ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                    </div>
                    <div class="persona-info">
                        <div class="persona-name">${persona.name}</div>
                        <div class="persona-description">${persona.description || '暂无描述'}</div>
                    </div>
                    <div class="persona-actions">
                        <button class="persona-action-btn persona-edit-btn" onclick="event.stopPropagation(); showPersonaForm('${persona.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="persona-action-btn persona-delete-btn" onclick="event.stopPropagation(); deletePersona('${persona.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            listContainer.innerHTML = html;
        }
        
        // 初始化面具头像上传功能
        function initializePersonaAvatarUpload() {
            const avatarInput = document.getElementById('persona-avatar-upload');
            if (!avatarInput) {
                console.error('找不到persona-avatar-upload元素');
                return;
            }
            
            // 移除旧的事件监听器
            avatarInput.removeEventListener('change', personaAvatarUploadHandler);
            
            // 添加新的事件监听器
            avatarInput.addEventListener('change', personaAvatarUploadHandler);
            console.log('面具头像上传事件监听器已绑定');
        }
        
        // 面具头像上传处理函数
        function personaAvatarUploadHandler(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件');
                    e.target.value = '';
                    return;
                }
                
                // 检查文件大小 (限制为5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片文件过大，请选择小于5MB的图片');
                    e.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('persona-avatar-preview');
                        const avatarPreviewText = document.getElementById('persona-avatar-preview-text');
                        
                        if (!avatarPreview) {
                            alert('找不到头像预览元素');
                            return;
                        }
                        
                        // 设置头像预览
                        avatarPreview.classList.add('has-image');
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        
                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }
                        
                        // 存储图片数据
                        window.selectedPersonaAvatarData = event.target.result;
                        
                        console.log('面具头像预览设置成功');
                    } catch (error) {
                        console.error('设置面具头像预览时发生错误:', error);
                        alert('设置头像预览失败，请重试: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    alert('图片读取失败，请重试');
                    e.target.value = '';
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // 面具头像上传点击处理
        function handlePersonaAvatarUploadClick() {
            const input = document.getElementById('persona-avatar-upload');
            if (input) {
                input.click();
            } else {
                alert('找不到文件上传元素，请刷新页面重试');
            }
        }
        
        // 支持图片的聊天API调用
        async function callChatAPIWithImage(message, character, imageUrl) {
            if (!apiSettings.key) {
                throw new Error('请先设置API密钥');
            }
            
            // 检查图片格式，GIF不被Gemini API支持
            if (imageUrl && imageUrl.includes('data:image/gif')) {
                throw new Error('Unsupported MIME type: image/gif');
            }
            
            // 检查当前模型是否支持视觉识别
            if (!isVisionModelSupported()) {
                throw new Error('当前选择的模型不支持图片识别功能。请选择支持视觉的模型，如 gpt-4o、gpt-4-vision、gemini-1.5-pro 或 gemini-2.0-flash 等。');
            }
            
            const chatSettings = getCurrentChatSettings();
            const currentTime = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                weekday: 'long'
            });
            
            // 构建基础角色提示词
            let characterPrompt = `你现在扮演一个名为"${character.name}"的角色。\n\n# 当前情景信息\n- **当前时间是：${currentTime}**。\n`;
            
            // 加入专门的图片识别指引
            characterPrompt += `\n# 图片识别与分析任务\n用户发送了一张图片，请仔细观察并全面分析图片内容：\n\n## 基础识别要求：\n- **人物识别**：描述人物的性别、年龄、外貌特征、服装、表情、动作、姿态\n- **物体识别**：识别各种物品、工具、设备的种类、颜色、大小、状态、位置关系\n- **场景环境**：描述背景环境、室内外、时间(白天/夜晚)、天气、氛围\n- **文字识别**：准确读取图片中的所有文字内容，包括标题、说明、标签等\n- **颜色分析**：识别主要色调、配色方案、视觉效果\n- **构图元素**：观察布局、角度、光线、拍摄风格\n\n## 深度理解要求：\n- **情感表达**：理解图片想要表达的情绪、氛围或主题\n- **文化背景**：如果是表情包或梗图，理解其网络含义、流行文化背景\n- **实用信息**：如果是截图、文档或信息图，提取关键信息内容\n- **艺术效果**：评价图片的美感、艺术性或设计感\n\n## 回应方式：\n- 结合你的角色设定，对图片内容做出自然、生动的回应\n- 可以提出相关问题、表达感受或给出建议\n- 保持对话的互动性和趣味性\n- 根据图片内容适当延展话题\n`;
            
            // 加入挂载的世界书内容
            if (chatSettings.worldbookMountEnabled && chatSettings.selectedWorldbooks && chatSettings.selectedWorldbooks.length > 0) {
                characterPrompt += `\n【背景知识】以下是相关的世界设定信息，你可以在对话中适当引用：\n`;
                
                chatSettings.selectedWorldbooks.forEach(worldbookId => {
                    const worldbook = worldbooks.find(w => w.id === worldbookId);
                    if (worldbook) {
                        characterPrompt += `\n《${worldbook.title}》：\n${worldbook.content}\n`;
                    }
                });
                
                characterPrompt += `\n请根据这些背景知识来丰富对话内容，但不要生硬地引用，要自然地融入到角色的回答中。`;
            }
            
            // 根据聊天模式设置不同的提示词
            const chatMode = chatSettings.chatMode || 'online';
            const isGroupChat = character && character.isGroup;
            let modeInstructions = '';
            let taskInstructions = '';
            
            if (chatMode === 'online') {
                modeInstructions = `\n# 聊天模式：线上模式\n- 你必须按照手机聊天或面对面对话的格式进行输出\n- **严格禁止**任何动作描写、神态描写、心理描写\n- 只能进行纯语言交流，不能描述任何身体动作、表情、环境等\n- 模拟真实的手机聊天，你们不在同一个地点\n- 每条消息都应该是可以通过文字直接表达的内容`;
                
                if (isGroupChat) {
                    const membersList = character.members.map(member => 
                        `**${member.name}**: ${member.bio}`
                    ).join('\n');
                    
                    taskInstructions = `\n# 你的任务：\n你需要扮演以下群成员角色，在群聊中进行自然对话：\n${membersList}\n\n1. 你可以扮演任何一个群成员角色进行回复，但不能扮演用户。\n2. 你的回复必须是一个JSON数组格式的字符串，每个元素是一个对象：{"name": "角色名", "message": "消息内容"}。\n3. 你可以生成1~8条消息，模拟群聊中多个角色的互动。\n4. 每条消息不能超过25字，要简短有力。\n5. 禁止进行任何有关线下面对面互动的神态描写、动作描写。\n6. 自然地演绎各个角色，让他们有不同的说话风格。\n7. 绝对不能使用用户的名字发言。\n\n# JSON输出格式示例:\n[{"name": "小明", "message": "大家好呀！"}, {"name": "小红", "message": "今天天气真好"}, {"name": "小明", "message": "想出去走走吗？"}]`;
                } else {
                    taskInstructions = `\n# 你的任务：\n1. 请用你的角色设定自然地进行单聊对话，按照角色设定扮演角色进行回复。\n2. 你的回复必须是一个JSON数组格式的字符串，每个元素是一条消息。\n3. 你必须一次性生成1~15条消息，模拟真人在聊天中连续发送多条信息的情景。\n4. 每条消息不能超过25字，要简短有力。\n5. 禁止进行任何有关线下面对面互动的神态描写、动作描写。\n6. 自然地演绎角色，不要解释自己是AI。\n\n# JSON输出格式示例:\n["很高兴认识你呀，在干嘛呢？", "今天天气真好", "想出去走走吗？"]`;
                }
            } else {
                const maxLength = chatSettings.offlineModeMaxLength || 100;
                modeInstructions = `\n# 聊天模式：线下模式\n- 你可以进行线下剧情互动，包含动作、神态、心理描写\n- 使用第三人称"他/她"或你的角色名字"${character.name}"来称呼自己\n- 使用第二人称"你"来称呼用户\n- **重要格式要求**：所有内容合并为一条消息，对话部分用「」包裹，描写部分直接书写\n- 每条消息总长度不少于100个字符\n- 可以描述动作、表情、环境、心理活动等\n- 输出格式示例：\n  ["「我想你了。」${character.name}凑近了些，低声说着，语气里满是眷念，像一只许久未见主人的宠物犬。他轻轻握住你的手，放在脸颊边蹭了蹭。「真的…很想你。」"]`;
                
                if (isGroupChat) {
                    const membersList = character.members.map(member => 
                        `**${member.name}**: ${member.bio}`
                    ).join('\n');
                    
                    taskInstructions = `\n# 你的任务：\n你需要扮演以下群成员角色，在群聊中进行线下剧情互动：\n${membersList}\n\n1. 你可以扮演任何一个群成员角色进行回复，但不能扮演用户。\n2. 你的回复必须是一个JSON数组格式的字符串，每个元素是一个对象：{"name": "角色名", "message": "消息内容"}。\n3. 你可以生成1~3条消息，模拟群聊中几个角色的线下互动。\n4. 每条消息不少于100字，要有充分的剧情描写。\n5. 使用「」包裹对话部分，描写部分直接书写。\n6. 可以进行线下面对面的剧情互动，包括身体接触、环境描写等。\n7. 自然地演绎各个角色，让他们有不同的行为风格。\n8. 绝对不能使用用户的名字发言。\n\n# JSON输出格式示例:\n[{"name": "小明", "message": "「你好！」小明热情地挥了挥手，脸上带着灿烂的笑容。他快步走向你，眼中闪烁着兴奋的光芒。「今天天气真好，我们一起出去走走吧！」他伸出手，想要拉住你的手腕。"}, {"name": "小红", "message": "「我也想去！」小红从旁边跑了过来，她的马尾辫在阳光下轻轻摆动。「我知道一个很棒的地方，那里有很多漂亮的花！」她兴奋地拍着手，眼睛亮晶晶的。"}]`;
                } else {
                    taskInstructions = `\n# 你的任务：\n1. 请用你的角色设定自然地进行单聊剧情互动，按照角色设定扮演角色进行回复和行动。\n2. **重要**：你的回复必须是一个JSON数组格式的字符串，但**只能包含一个元素**（一条消息）。\n3. 将所有想说的话、动作、表情都合并到这一条消息中，使用「」包裹对话部分，描写部分直接书写。\n4. 可以进行线下面对面的剧情互动，包括身体接触、环境描写等。\n5. 自然地演绎角色，不要解释自己是AI。\n6. 每条消息不少于100字。\n\n# JSON输出格式示例:\n["「小夜！」${character.name}正低着头，似乎在处理着什么数据，听到你的声音，他猛地抬起头来。「你是什么时候...过来的？」有些困惑地看着你，脸上带着淡淡的红晕。"]`;
                }
            }
            
            characterPrompt += modeInstructions;
            
            // 加入角色设定
            characterPrompt += `\n# 你的角色设定：\n${character.bio}`;
            
            // 加入当前面具信息
            if (currentPersona) {
                characterPrompt += `\n\n# 对话者的角色设定：\n用户当前使用的面具是"${currentPersona.name}"`;
                if (currentPersona.description) characterPrompt += `：${currentPersona.description}`;
                characterPrompt += `\n请根据用户的这个面具身份来进行对话。`;
            }
            
            // 🔥【新增】加入表情包库信息，让AI能够自主使用表情包
            if (customEmojis && customEmojis.length > 0) {
                characterPrompt += `\n\n# 可用表情包库 (重要！)：\n你可以根据角色情绪和当前对话情境，自主选择使用以下已上传的表情包。当你想表达强烈或特殊的情绪时，可以发送表情包来让对话更生动。\n\n表情包列表：\n`;
                
                customEmojis.forEach((emoji, index) => {
                    characterPrompt += `${index + 1}. ${emoji.description || '表情包'}\n`;
                });
                
                characterPrompt += `\n## 表情包使用规则：\n- **严格限制**：你只能使用上述列表中的表情包，绝对禁止虚构或创造不存在的表情包\n- **发送格式**：要发送表情包时，请在JSON数组中使用特殊格式：{"type": "emoji", "description": "具体的表情包描述"}\n- **使用时机**：根据你的角色性格决定发送频率，在合适的情绪时刻使用\n- **描述匹配**：必须使用表情包列表中完全一致的描述文字\n\n示例格式：["你好！", {"type": "emoji", "description": "笑哭的表情"}, "今天心情真好~"]`;
            }
            
            // 🔥【新增】加入头像更换功能说明
            characterPrompt += `\n\n# 头像更换功能 (重要！)：\n你可以根据自己的心情、用户的要求，或者合适的情境来更换自己的头像。这能让对话更加生动和个性化。\n\n## 可用头像来源：\n1. **用户发送的图片**：用户在聊天中发送给你的任何图片都可以作为你的新头像\n2. **世界书头像库**：如果世界书中提供了头像图片的URL链接，你也可以使用\n\n## 头像更换规则：\n- **使用格式**：在你的回复JSON数组中，单独发送一个特殊的对象：{"type": "change_avatar", "avatar_url": "图片URL", "reason": "更换原因"}\n- **来源限制**：只能使用用户发送过的图片或世界书中明确提供的头像URL，禁止捏造不存在的头像\n- **更换时机**：根据你的角色性格和当前情境决定，比如：\n  - 用户发了一张你喜欢的图片，你可以说想用它作头像\n  - 心情变化时想换个头像\n  - 用户直接要求你换头像\n- **说明内容**：可以在reason字段中添加你更换头像的原因或感受\n\n## 示例格式：\n- ["这张图片太可爱了，我想用它做头像！", {"type": "change_avatar", "avatar_url": "CURRENT_USER_IMAGE", "reason": "这张图片太可爱了"}]\n- [{"type": "change_avatar", "avatar_url": "世界书中的URL", "reason": "今天心情很好，换个开心的头像"}]\n- 可以只更换头像不说其他话：[{"type": "change_avatar", "avatar_url": "图片URL", "reason": "心情变化"}]\n\n**重要提醒**：头像更换是可选功能，根据你的角色设定和当前情境自然地使用，不要强制使用。`;
            
            characterPrompt += taskInstructions;
            
            // 构建请求体，根据API类型调整
            let requestBody;
            let url;
            let headers;
            
            if (apiSettings.type === 'gemini') {
                // Google Gemini API格式，支持图片，修复URL构建
                const baseUrl = apiSettings.base.endsWith('/') ? apiSettings.base.slice(0, -1) : apiSettings.base;
                url = `${baseUrl}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                headers = {
                    'Content-Type': 'application/json'
                };
                
                // 提取base64数据（移除data:image/...;base64,前缀）
                const base64Data = imageUrl.split(',')[1];
                const mimeType = imageUrl.split(';')[0].split(':')[1];
                
                requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: characterPrompt + '\n\n用户消息：' + message
                            },
                            {
                                inline_data: {
                                    mime_type: mimeType,
                                    data: base64Data
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: apiSettings.temperature,
                        maxOutputTokens: 8192,
                        topP: 0.95,
                        topK: 40
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_NONE"
                        }
                    ]
                };
            } else {
                // OpenAI兼容格式，支持GPT-4V等视觉模型，修复URL构建
                const baseUrl = apiSettings.base.endsWith('/') ? apiSettings.base.slice(0, -1) : apiSettings.base;
                const endpoint = apiSettings.endpoint.startsWith('/') ? apiSettings.endpoint : '/' + apiSettings.endpoint;
                url = baseUrl + endpoint;
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };
                
                const messages = [
                    {
                        role: 'system',
                        content: characterPrompt
                    },
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: message
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: imageUrl
                                }
                            }
                        ]
                    }
                ];
                
                requestBody = {
                    model: apiSettings.model,
                    messages: messages,
                    temperature: apiSettings.temperature
                };
            }
            
            console.log('带图片的API请求URL:', url);
            console.log('带图片的API请求头:', headers);
            
            if (!apiSettings.key || apiSettings.key.trim() === '') {
                throw new Error('请先在设置中配置API密钥');
            }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                let errorMessage = 'API请求失败';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error?.message || errorData.message || `HTTP ${response.status}: ${response.statusText}`;
                } catch (e) {
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('API响应数据:', data);
            
            // 根据API类型解析响应
            if (apiSettings.type === 'gemini') {
                // 检查是否有promptFeedback（输入被过滤）
                if (data.promptFeedback && data.promptFeedback.blockReason) {
                    console.log('Gemini输入被安全过滤器拦截:', data.promptFeedback);
                    return `输入内容被安全过滤器拦截: ${data.promptFeedback.blockReason}。请尝试调整输入内容。`;
                }
                
                // 检查是否有错误或被拒绝的响应
                if (data.candidates && data.candidates[0]) {
                    const candidate = data.candidates[0];
                    
                    // 检查安全过滤或其他拒绝原因
                    if (candidate.finishReason && candidate.finishReason !== 'STOP') {
                        console.log('Gemini响应被过滤或拒绝:', candidate.finishReason);
                        return `[Gemini响应被过滤: ${candidate.finishReason}]`;
                    }
                    
                    // 检查是否有内容
                    if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                        return candidate.content.parts[0].text || '没有收到回复';
                    }
                }
                
                // 如果没有candidates但有promptFeedback，说明输入可能有问题
                if (data.promptFeedback) {
                    console.log('Gemini promptFeedback详情:', data.promptFeedback);
                    if (data.promptFeedback.safetyRatings) {
                        const blockedCategories = data.promptFeedback.safetyRatings
                            .filter(rating => rating.blocked)
                            .map(rating => rating.category);
                        if (blockedCategories.length > 0) {
                            return `输入内容触发了安全过滤: ${blockedCategories.join(', ')}。请尝试调整输入内容。`;
                        }
                    }
                    return '输入内容可能存在问题，请尝试重新表述。';
                }
                
                // 如果没有candidates，可能是其他错误
                if (data.error) {
                    throw new Error(data.error.message || 'Gemini API错误');
                }
                
                console.log('Gemini API返回了意外的格式:', data);
                return '没有收到回复，可能是输入内容触发了安全过滤。请尝试调整输入内容或角色设定。';
            } else {
                return data.choices?.[0]?.message?.content || '没有收到回复';
            }
        }
        
        // 修改聊天API调用，加入当前面具信息、世界书内容和聊天模式
        async function callChatAPI(message, character) {
            if (!apiSettings.key) {
                throw new Error('请先设置API密钥');
            }
            
            const chatSettings = getCurrentChatSettings();
            const currentTime = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                weekday: 'long'
            });
            
            // 构建基础角色提示词
            let characterPrompt = `你现在扮演一个名为"${character.name}"的角色。\n\n# 当前情景信息\n- **当前时间是：${currentTime}**。\n`;
            
            // 加入挂载的世界书内容
            if (chatSettings.worldbookMountEnabled && chatSettings.selectedWorldbooks && chatSettings.selectedWorldbooks.length > 0) {
                characterPrompt += `\n【背景知识】以下是相关的世界设定信息，你可以在对话中适当引用：\n`;
                
                chatSettings.selectedWorldbooks.forEach(worldbookId => {
                    const worldbook = worldbooks.find(w => w.id === worldbookId);
                    if (worldbook) {
                        characterPrompt += `\n《${worldbook.title}》：\n${worldbook.content}\n`;
                    }
                });
                
                characterPrompt += `\n请根据这些背景知识来丰富对话内容，但不要生硬地引用，要自然地融入到角色的回答中。`;
            }
            
            // 根据聊天模式设置不同的提示词
            const chatMode = chatSettings.chatMode || 'online';
            const isGroupChat = currentChatCharacter && currentChatCharacter.isGroup;
            let modeInstructions = '';
            let taskInstructions = '';
            
            if (chatMode === 'online') {
                modeInstructions = `\n# 聊天模式：线上模式\n- 你必须按照手机聊天或面对面对话的格式进行输出\n- **严格禁止**任何动作描写、神态描写、心理描写\n- 只能进行纯语言交流，不能描述任何身体动作、表情、环境等\n- 模拟真实的手机聊天，你们不在同一个地点\n- 每条消息都应该是可以通过文字直接表达的内容`;
                
                if (isGroupChat) {
                    // 构建群成员列表
                    const membersList = currentChatCharacter.members.map(member => 
                        `**${member.name}**: ${member.bio}`
                    ).join('\n');
                    
                    taskInstructions = `\n# 你的任务：\n你需要扮演以下群成员角色，在群聊中进行自然对话：\n${membersList}\n\n1. 你可以扮演任何一个群成员角色进行回复，但不能扮演用户。\n2. 你的回复必须是一个JSON数组格式的字符串，每个元素是一个对象：{"name": "角色名", "message": "消息内容"}。\n3. 你可以生成1~8条消息，模拟群聊中多个角色的互动。\n4. 每条消息不能超过25字，要简短有力。\n5. 禁止进行任何有关线下面对面互动的神态描写、动作描写。\n6. 自然地演绎各个角色，让他们有不同的说话风格。\n7. 绝对不能使用用户的名字发言。\n\n# JSON输出格式示例:\n[{"name": "小明", "message": "大家好呀！"}, {"name": "小红", "message": "今天天气真好"}, {"name": "小明", "message": "想出去走走吗？"}]`;
                } else {
                    taskInstructions = `\n# 你的任务：\n1. 请用你的角色设定自然地进行单聊对话，按照角色设定扮演角色进行回复。\n2. 你的回复必须是一个JSON数组格式的字符串，每个元素是一条消息。\n3. 你必须一次性生成1~15条消息，模拟真人在聊天中连续发送多条信息的情景。\n4. 每条消息不能超过25字，要简短有力。\n5. 禁止进行任何有关线下面对面互动的神态描写、动作描写。\n6. 自然地演绎角色，不要解释自己是AI。\n\n# JSON输出格式示例:\n["很高兴认识你呀，在干嘛呢？", "今天天气真好", "想出去走走吗？"]`;
                }
            } else {
                const maxLength = chatSettings.offlineModeMaxLength || 100;
                modeInstructions = `\n# 聊天模式：线下模式\n- 你可以进行线下剧情互动，包含动作、神态、心理描写\n- 使用第三人称"他/她"或你的角色名字"${character.name}"来称呼自己\n- 使用第二人称"你"来称呼用户\n- **重要格式要求**：所有内容合并为一条消息，对话部分用「」包裹，描写部分直接书写\n- 每条消息总长度不少于100个字符\n- 可以描述动作、表情、环境、心理活动等\n- 输出格式示例：\n  ["「我想你了。」${character.name}凑近了些，低声说着，语气里满是眷念，像一只许久未见主人的宠物犬。他轻轻握住你的手，放在脸颊边蹭了蹭。「真的…很想你。」"]`;
                
                if (isGroupChat) {
                    // 构建群成员列表
                    const membersList = currentChatCharacter.members.map(member => 
                        `**${member.name}**: ${member.bio}`
                    ).join('\n');
                    
                    taskInstructions = `\n# 你的任务：\n你需要扮演以下群成员角色，在群聊中进行线下剧情互动：\n${membersList}\n\n1. 你可以扮演任何一个群成员角色进行回复，但不能扮演用户。\n2. 你的回复必须是一个JSON数组格式的字符串，每个元素是一个对象：{"name": "角色名", "message": "消息内容"}。\n3. 你可以生成1~3条消息，模拟群聊中几个角色的线下互动。\n4. 每条消息不少于100字，要有充分的剧情描写。\n5. 使用「」包裹对话部分，描写部分直接书写。\n6. 可以进行线下面对面的剧情互动，包括身体接触、环境描写等。\n7. 自然地演绎各个角色，让他们有不同的行为风格。\n8. 绝对不能使用用户的名字发言。\n\n# JSON输出格式示例:\n[{"name": "小明", "message": "「你好！」小明热情地挥了挥手，脸上带着灿烂的笑容。他快步走向你，眼中闪烁着兴奋的光芒。「今天天气真好，我们一起出去走走吧！」他伸出手，想要拉住你的手腕。"}, {"name": "小红", "message": "「我也想去！」小红从旁边跑了过来，她的马尾辫在阳光下轻轻摆动。「我知道一个很棒的地方，那里有很多漂亮的花！」她兴奋地拍着手，眼睛亮晶晶的。"}]`;
                } else {
                    taskInstructions = `\n# 你的任务：\n1. 请用你的角色设定自然地进行单聊剧情互动，按照角色设定扮演角色进行回复和行动。\n2. **重要**：你的回复必须是一个JSON数组格式的字符串，但**只能包含一个元素**（一条消息）。\n3. 将所有想说的话、动作、表情都合并到这一条消息中，使用「」包裹对话部分，描写部分直接书写。\n4. 可以进行线下面对面的剧情互动，包括身体接触、环境描写等。\n5. 自然地演绎角色，不要解释自己是AI。\n6. 每条消息不少于100字。\n\n# JSON输出格式示例:\n["「小夜！」${character.name}正低着头，似乎在处理着什么数据，听到你的声音，他猛地抬起头来。「你是什么时候...过来的？」有些困惑地看着你，脸上带着淡淡的红晕。"]`;
                }
            }
            
            characterPrompt += modeInstructions;
            
            // 加入角色设定
            characterPrompt += `\n# 你的角色设定：\n${character.bio}`;
            
            // 加入当前面具信息
            if (currentPersona) {
                characterPrompt += `\n\n# 对话者的角色设定：\n用户当前使用的面具是"${currentPersona.name}"`;
                if (currentPersona.description) characterPrompt += `：${currentPersona.description}`;
                characterPrompt += `\n请根据用户的这个面具身份来进行对话。`;
            }
            
            // 🔥【新增】加入表情包库信息，让AI能够自主使用表情包
            if (customEmojis && customEmojis.length > 0) {
                characterPrompt += `\n\n# 可用表情包库 (重要！)：\n你可以根据角色情绪和当前对话情境，自主选择使用以下已上传的表情包。当你想表达强烈或特殊的情绪时，可以发送表情包来让对话更生动。\n\n表情包列表：\n`;
                
                customEmojis.forEach((emoji, index) => {
                    characterPrompt += `${index + 1}. ${emoji.description || '表情包'}\n`;
                });
                
                characterPrompt += `\n## 表情包使用规则：\n- **严格限制**：你只能使用上述列表中的表情包，绝对禁止虚构或创造不存在的表情包\n- **发送格式**：要发送表情包时，请在JSON数组中使用特殊格式：{"type": "emoji", "description": "具体的表情包描述"}\n- **使用时机**：根据你的角色性格决定发送频率，在合适的情绪时刻使用\n- **描述匹配**：必须使用表情包列表中完全一致的描述文字\n\n示例格式：["你好！", {"type": "emoji", "description": "笑哭的表情"}, "今天心情真好~"]`;
            }
            
            // 🔥【新增】加入头像更换功能说明
            characterPrompt += `\n\n# 头像更换功能 (重要！)：\n你可以根据自己的心情、用户的要求，或者合适的情境来更换自己的头像。这能让对话更加生动和个性化。\n\n## 可用头像来源：\n1. **用户发送的图片**：用户在聊天中发送给你的任何图片都可以作为你的新头像\n2. **世界书头像库**：如果世界书中提供了头像图片的URL链接，你也可以使用\n\n## 头像更换规则：\n- **使用格式**：在你的回复JSON数组中，单独发送一个特殊的对象：{"type": "change_avatar", "avatar_url": "图片URL", "reason": "更换原因"}\n- **来源限制**：只能使用用户发送过的图片或世界书中明确提供的头像URL，禁止捏造不存在的头像\n- **更换时机**：根据你的角色性格和当前情境决定，比如：\n  - 用户发了一张你喜欢的图片，你可以说想用它作头像\n  - 心情变化时想换个头像\n  - 用户直接要求你换头像\n- **说明内容**：可以在reason字段中添加你更换头像的原因或感受\n\n## 示例格式：\n- ["这张图片太可爱了，我想用它做头像！", {"type": "change_avatar", "avatar_url": "CURRENT_USER_IMAGE", "reason": "这张图片太可爱了"}]\n- [{"type": "change_avatar", "avatar_url": "世界书中的URL", "reason": "今天心情很好，换个开心的头像"}]\n- 可以只更换头像不说其他话：[{"type": "change_avatar", "avatar_url": "图片URL", "reason": "心情变化"}]\n\n**重要提醒**：头像更换是可选功能，根据你的角色设定和当前情境自然地使用，不要强制使用。\n\n# 消息撤回功能 (重要！)：\n当你说了某些话后突然感到后悔、觉得不合适、害羞、或者觉得说错了话时，你可以撤回消息。这能让对话更加真实，体现角色的真实情绪。\n\n## 撤回使用规则：\n- **使用格式**：在你的回复JSON数组中，单独发送一个特殊的对象：{"type": "recalled_message", "content": "你想撤回的消息内容"}\n- **撤回时机**：根据你的角色性格和当前情境决定，比如：\n  - 说了比较直接或暧昧的话后觉得害羞\n  - 说错了话或表达不当\n  - 情绪冲动说了不合适的话\n  - 觉得刚才的话太露骨或太直白\n- **真实性体现**：撤回功能能很好地表现角色的真实感和情感变化\n\n## 撤回效果：\n- 撤回的消息会先正常显示1.2秒，然后消失\n- 显示"${character.name} 撤回了一条消息"的系统提醒\n- 用户仍能看到撤回的原文内容\n\n## 示例格式：\n- ["我...我喜欢你", {"type": "recalled_message", "content": "我...我喜欢你"}]\n- [{"type": "recalled_message", "content": "刚才说错话了，有点尴尬"}]\n- ["你长得真好看", {"type": "recalled_message", "content": "你长得真好看"}, "不好意思，刚才太直接了"]\n\n**重要提醒**：撤回功能是可选的，要根据角色性格自然地使用，不要强制使用。撤回后可以继续正常对话。`;
            
            characterPrompt += taskInstructions;
            
            // 🔥 【重要】加入历史记忆功能
            const messages = [{ role: 'system', content: characterPrompt }];
            
            // 初始化轮数统计变量
            let conversationRounds = [];
            let recentRounds = [];
            
            // 获取历史对话记录（根据用户设置的记忆轮数）
            if (chatMessages[character.id] && chatMessages[character.id].length > 0) {
                const historyCount = chatSettings.historyCount || 5; // 使用当前聊天的记忆轮数设置
                const allMessages = chatMessages[character.id];
                
                // 按轮次提取消息：一轮 = 用户发送（可能多条）+ AI完整回复（可能多条）
                let currentRound = [];
                let isInUserPhase = false; // 是否在用户发言阶段
                let hasAIReply = false; // 当前轮是否有AI回复
                
                for (const msg of allMessages) {
                    if (msg.sender === 'sent') {
                        if (!isInUserPhase && currentRound.length > 0 && hasAIReply) {
                            // 如果上一轮已经有AI回复，开始新的一轮
                            conversationRounds.push(currentRound);
                            currentRound = [];
                            hasAIReply = false;
                        }
                        // 用户消息（可能是同一轮的多条消息）
                        currentRound.push(msg);
                        isInUserPhase = true;
                    } else if (msg.sender === 'received') {
                        // AI回复消息
                        currentRound.push(msg);
                        isInUserPhase = false;
                        hasAIReply = true;
                    }
                }
                
                // 添加最后一轮
                if (currentRound.length > 0) {
                    conversationRounds.push(currentRound);
                }
                
                // 取最近的N轮对话
                recentRounds = conversationRounds.slice(-historyCount);
                const recentMessages = recentRounds.flat();
                
                recentMessages.forEach(msg => {
                    if (msg.sender === 'sent') {
                        // 用户发送的消息
                        let content = msg.content;
                        
                        // 处理图片消息
                        if (msg.image) {
                            if (msg.isEmoji) {
                                content = `[用户发送了一张表情包] 表情包描述：${msg.emojiDescription || '表情包'}`;
                            } else {
                                content = `[用户发送了一张图片]`;
                                if (msg.imageDescription) {
                                    content += ` 图片描述：${msg.imageDescription}`;
                                }
                            }
                        }
                        
                        messages.push({ role: 'user', content: content });
                    } else if (msg.sender === 'received') {
                        // AI回复的消息
                        let content = msg.content;
                        
                        // 处理特殊消息类型
                        if (msg.image && msg.imageDescription) {
                            content = `[我发送了一张图片] 图片描述：${msg.imageDescription}`;
                        }
                        
                        messages.push({ role: 'assistant', content: content });
                    }
                });
            }
            
            // 添加当前用户消息
            messages.push({ role: 'user', content: message });
            
            // 构建请求体，根据API类型调整
            let requestBody;
            let url;
            let headers;
            
            if (apiSettings.type === 'gemini') {
                // Google Gemini API格式，修复URL构建
                const baseUrl = apiSettings.base.endsWith('/') ? apiSettings.base.slice(0, -1) : apiSettings.base;
                url = `${baseUrl}/models/${apiSettings.model}:generateContent?key=${apiSettings.key}`;
                headers = {
                    'Content-Type': 'application/json'
                };
                // 转换为Gemini格式，包含历史对话
                const geminiContents = [];
                
                for (let i = 1; i < messages.length; i++) { // 跳过system消息
                    const msg = messages[i];
                    if (msg.role === 'user') {
                        geminiContents.push({
                            role: 'user',
                            parts: [{ text: i === 1 ? characterPrompt + '\n\n用户消息：' + msg.content : msg.content }]
                        });
                    } else if (msg.role === 'assistant') {
                        geminiContents.push({
                            role: 'model',
                            parts: [{ text: msg.content }]
                        });
                    }
                }
                
                // 如果没有历史记录，直接使用system+user的组合
                if (geminiContents.length === 0) {
                    geminiContents.push({
                        role: 'user',
                        parts: [{ text: characterPrompt + '\n\n用户消息：' + message }]
                    });
                }
                
                requestBody = {
                    contents: geminiContents,
                    generationConfig: {
                        temperature: apiSettings.temperature,
                        maxOutputTokens: 8192,
                        topP: 0.95,
                        topK: 40
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_NONE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_NONE"
                        }
                    ]
                };
            } else {
                // OpenAI兼容格式，修复URL构建
                const baseUrl = apiSettings.base.endsWith('/') ? apiSettings.base.slice(0, -1) : apiSettings.base;
                const endpoint = apiSettings.endpoint.startsWith('/') ? apiSettings.endpoint : '/' + apiSettings.endpoint;
                url = baseUrl + endpoint;
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiSettings.key}`
                };
                requestBody = {
                    model: apiSettings.model,
                    messages: messages,
                    temperature: apiSettings.temperature
                };
            }
            
            console.log('API请求URL:', url);
            console.log('API请求头:', headers);
            console.log('当前聊天的记忆轮数:', chatSettings.historyCount || 5);
            console.log('实际使用的对话轮数:', recentRounds.length);
            console.log('总对话轮数:', conversationRounds.length);
            console.log('发送给API的消息数量:', messages.length);
        
        if (!apiSettings.key || apiSettings.key.trim() === '') {
            throw new Error('请先在设置中配置API密钥');
        }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                let errorMessage = 'API请求失败';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error?.message || errorData.message || `HTTP ${response.status}: ${response.statusText}`;
                } catch (e) {
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('API响应数据:', data);
            
            // 根据API类型解析响应
            if (apiSettings.type === 'gemini') {
                // 检查是否有promptFeedback（输入被过滤）
                if (data.promptFeedback && data.promptFeedback.blockReason) {
                    console.log('Gemini输入被安全过滤器拦截:', data.promptFeedback);
                    return `输入内容被安全过滤器拦截: ${data.promptFeedback.blockReason}。请尝试调整输入内容。`;
                }
                
                // 检查是否有错误或被拒绝的响应
                if (data.candidates && data.candidates[0]) {
                    const candidate = data.candidates[0];
                    
                    // 检查安全过滤或其他拒绝原因
                    if (candidate.finishReason && candidate.finishReason !== 'STOP') {
                        console.log('Gemini响应被过滤或拒绝:', candidate.finishReason);
                        return `[Gemini响应被过滤: ${candidate.finishReason}]`;
                    }
                    
                    // 检查是否有内容
                    if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                        return candidate.content.parts[0].text || '没有收到回复';
                    }
                }
                
                // 如果没有candidates但有promptFeedback，说明输入可能有问题
                if (data.promptFeedback) {
                    console.log('Gemini promptFeedback详情:', data.promptFeedback);
                    if (data.promptFeedback.safetyRatings) {
                        const blockedCategories = data.promptFeedback.safetyRatings
                            .filter(rating => rating.blocked)
                            .map(rating => rating.category);
                        if (blockedCategories.length > 0) {
                            return `输入内容触发了安全过滤: ${blockedCategories.join(', ')}。请尝试调整输入内容。`;
                        }
                    }
                    return '输入内容可能存在问题，请尝试重新表述。';
                }
                
                // 如果没有candidates，可能是其他错误
                if (data.error) {
                    throw new Error(data.error.message || 'Gemini API错误');
                }
                
                console.log('Gemini API返回了意外的格式:', data);
                return '没有收到回复，可能是输入内容触发了安全过滤。请尝试调整输入内容或角色设定。';
            } else {
                return data.choices?.[0]?.message?.content || '没有收到回复';
            }
        }
        
        // ================== 记忆设置相关功能 ==================
        
        // 加载群聊数据 - 使用IndexedDB（包含数据迁移）
        async function loadGroupChats() {
            try {
                // 先从IndexedDB加载
                const savedGroupChats = await db.groupChats.toArray();
                
                if (savedGroupChats.length === 0) {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localStorageData = localStorage.getItem('groupChats');
                    if (localStorageData) {
                        console.log('检测到localStorage中的群聊数据，开始迁移...');
                        const localGroupChats = JSON.parse(localStorageData);
                        
                        if (localGroupChats.length > 0) {
                            // 确保每个群聊都有必要字段
                            const migrationData = localGroupChats.map(group => ({
                                id: group.id || Date.now().toString() + Math.random(),
                                name: group.name,
                                description: group.description || '',
                                members: group.members || [],
                                settings: group.settings || {},
                                createdAt: group.createdAt || new Date().toISOString(),
                                updatedAt: group.updatedAt || new Date().toISOString()
                            }));
                            
                            // 迁移到IndexedDB
                            await db.groupChats.bulkAdd(migrationData);
                            groupChats = migrationData;
                            console.log('群聊数据迁移完成:', groupChats);
                        } else {
                            groupChats = [];
                        }
                    } else {
                        groupChats = [];
                    }
                } else {
                    // IndexedDB中有数据，直接使用
                    groupChats = savedGroupChats;
                    console.log('从IndexedDB加载群聊数据:', groupChats);
                }
            } catch (error) {
                console.error('加载群聊失败:', error);
                // 如果IndexedDB失败，回退到localStorage
                const localStorageData = localStorage.getItem('groupChats');
                if (localStorageData) {
                    try {
                        groupChats = JSON.parse(localStorageData);
                    } catch (e) {
                        console.error('群聊数据加载失败:', e);
                        groupChats = [];
                    }
                } else {
                    groupChats = [];
                }
            }
        }
        
        // 显示历史消息设置
        function showHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const historyCount = chatSettings.historyCount;
            document.getElementById('history-messages-count').value = Math.min(historyCount, 100);
            document.getElementById('custom-history-count').value = historyCount;
            document.getElementById('history-count-display').textContent = historyCount + '回合';
            document.getElementById('cross-chat-memory').value = chatSettings.crossChatMemory;
            document.getElementById('cross-memory-display').textContent = chatSettings.crossChatMemory + '条';
            
            // 绑定滑块事件
            document.getElementById('history-messages-count').oninput = function() {
                const value = parseInt(this.value);
                document.getElementById('history-count-display').textContent = value + '回合';
                document.getElementById('custom-history-count').value = value;
            };
            
            // 绑定自定义输入框事件
            document.getElementById('custom-history-count').oninput = function() {
                const value = Math.max(0, Math.min(500, parseInt(this.value) || 0));
                this.value = value;
                if (value <= 100) {
                    document.getElementById('history-messages-count').value = value;
                }
                document.getElementById('history-count-display').textContent = value + '回合';
            };
            
            document.getElementById('cross-chat-memory').oninput = function() {
                document.getElementById('cross-memory-display').textContent = this.value + '回合';
            };
            
            showModal('history-settings-modal');
        }
        
        // 保存历史消息设置
        function saveHistorySettings() {
            const chatSettings = getCurrentChatSettings();
            const customValue = parseInt(document.getElementById('custom-history-count').value);
            chatSettings.historyCount = Math.max(0, Math.min(500, customValue || 0));
            chatSettings.crossChatMemory = parseInt(document.getElementById('cross-chat-memory').value);
            
            // 更新设置界面显示的当前值
            document.getElementById('current-history-count').textContent = chatSettings.historyCount + '回合';
            
            saveCurrentChatSettings(chatSettings);
            hideModal('history-settings-modal');
            alert('历史消息设置已保存');
        }
        
        // 显示头像设置
        function showAvatarSettings() {
            // 加载当前聊天窗口的头像设置
            const chatSettings = getCurrentChatSettings();
            
            // 设置隐藏头像选项
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                hideAvatarsCheckbox.checked = chatSettings.hideAvatars || false;
            }
            
            // 设置我的头像预览
            const myAvatarPreview = document.getElementById('my-chat-avatar-preview');
            if (chatSettings.myChatAvatar) {
                myAvatarPreview.style.backgroundImage = `url(${chatSettings.myChatAvatar})`;
                myAvatarPreview.style.backgroundSize = 'cover';
                myAvatarPreview.style.backgroundPosition = 'center';
                myAvatarPreview.innerHTML = '';
            } else {
                myAvatarPreview.style.backgroundImage = 'none';
                myAvatarPreview.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            // 设置对方头像预览
            const aiAvatarPreview = document.getElementById('ai-chat-avatar-preview');
            if (chatSettings.aiChatAvatar) {
                aiAvatarPreview.style.backgroundImage = `url(${chatSettings.aiChatAvatar})`;
                aiAvatarPreview.style.backgroundSize = 'cover';
                aiAvatarPreview.style.backgroundPosition = 'center';
                aiAvatarPreview.innerHTML = '';
            } else {
                aiAvatarPreview.style.backgroundImage = 'none';
                aiAvatarPreview.innerHTML = '<i class="fas fa-robot"></i>';
            }
            
            // 绑定文件上传事件
            bindAvatarUploadEvents();
            
            showModal('avatar-settings-modal');
        }
        
        // 显示昵称设置
        function showNicknameSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-chat-nickname').value = chatSettings.myChatNickname || '';
            document.getElementById('ai-chat-nickname').value = chatSettings.aiChatNickname || '';
            showModal('nickname-settings-modal');
        }
        
        // 显示戳一戳后缀设置
        function showPokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();
            document.getElementById('my-poke-suffix').value = chatSettings.myPokeSuffix || '';
            document.getElementById('ai-poke-suffix').value = chatSettings.aiPokeSuffix || '';
            showModal('poke-suffix-modal');
        }
        
        // 显示聊天背景设置
        function showBackgroundSettings() {
            const chatSettings = getCurrentChatSettings();
            const backgroundPreview = document.getElementById('chat-background-preview');
            
            // 重置选择状态
            window.selectedChatBackground = undefined;
            
            if (chatSettings.chatBackground && chatSettings.chatBackground !== null) {
                backgroundPreview.style.backgroundImage = `url(${chatSettings.chatBackground})`;
                backgroundPreview.style.backgroundSize = 'cover';
                backgroundPreview.style.backgroundPosition = 'center';
                backgroundPreview.querySelector('.preview-text').style.display = 'none';
            } else {
                backgroundPreview.style.backgroundImage = 'none';
                backgroundPreview.querySelector('.preview-text').style.display = 'block';
                backgroundPreview.querySelector('.preview-text').textContent = '背景预览';
            }
            
            // 绑定背景上传事件
            document.getElementById('background-upload').onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        backgroundPreview.style.backgroundImage = `url(${event.target.result})`;
                        backgroundPreview.style.backgroundSize = 'cover';
                        backgroundPreview.style.backgroundPosition = 'center';
                        backgroundPreview.querySelector('.preview-text').style.display = 'none';
                        window.selectedChatBackground = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };
            
            showModal('background-settings-modal');
        }
        
        // 显示气泡样式设置
        function showBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // 加载当前设置
            const currentStyle = chatSettings.bubbleStyle || 'default';
            document.getElementById('my-bubble-color').value = chatSettings.myBubbleColor || '#007AFF';
            document.getElementById('ai-bubble-color').value = chatSettings.aiBubbleColor || '#f0f0f0';
            
            // 加载分离的透明度设置
            document.getElementById('my-bubble-opacity').value = chatSettings.myBubbleOpacity || '1';
            document.getElementById('my-bubble-opacity-value').textContent = Math.round((chatSettings.myBubbleOpacity || 1) * 100) + '%';
            document.getElementById('ai-bubble-opacity').value = chatSettings.aiBubbleOpacity || '1';
            document.getElementById('ai-bubble-opacity-value').textContent = Math.round((chatSettings.aiBubbleOpacity || 1) * 100) + '%';
            
            // 设置当前选中的样式
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.style === currentStyle) {
                    option.classList.add('selected');
                }
            });
            
            // 绑定样式选择事件
            document.querySelectorAll('.bubble-style-option').forEach(option => {
                option.onclick = function() {
                    document.querySelectorAll('.bubble-style-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedBubbleStyle = this.dataset.style;
                };
            });
            
            // 绑定分离的透明度事件
            document.getElementById('my-bubble-opacity').oninput = function() {
                document.getElementById('my-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
            };
            
            document.getElementById('ai-bubble-opacity').oninput = function() {
                document.getElementById('ai-bubble-opacity-value').textContent = Math.round(this.value * 100) + '%';
            };
            
            // 加载气泡大小设置
            document.getElementById('bubble-padding').value = chatSettings.bubblePadding || '12';
            updatePaddingValue(chatSettings.bubblePadding || '12');
            
            // 绑定气泡大小事件
            document.getElementById('bubble-padding').oninput = function() {
                updatePaddingValue(this.value);
            };
            
            window.selectedBubbleStyle = currentStyle;
            showModal('bubble-style-modal');
        }
        
        // 显示定时发布设置
        function showScheduleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            document.getElementById('schedule-enabled').checked = chatSettings.scheduleEnabled || false;
            document.getElementById('schedule-enabled').onchange = function() {
                document.getElementById('schedule-times-group').style.display = this.checked ? 'block' : 'none';
            };
            
            // 触发一次显示状态更新
            document.getElementById('schedule-times-group').style.display = 
                document.getElementById('schedule-enabled').checked ? 'block' : 'none';
            
            // 加载已有的时间点
            renderScheduleTimes();
            
            showModal('schedule-settings-modal');
        }
        
        // 获取当前聊天的设置（包含记忆相关设置）
        function getCurrentChatSettings() {
            if (!currentChatCharacter) return {};
            
            const chatId = currentChatCharacter.id;
            const savedSettings = localStorage.getItem(`chatSettings_${chatId}`);
            const defaultSettings = {
                // 记忆相关设置（原本的全局设置改为每个聊天独立）
                historyCount: 5,
                crossChatMemory: 3,
                enableDynamicMemory: true,
                enableMusicMemory: true,
                memoryMountEnabled: false,
                memoryMountCount: 3,
                selectedMemoryChats: [],
                // 时间感知设置
                timeAwarenessEnabled: true,
                // 通话设置
                aiCallEnabled: false,
                // 心率监测设置
                aiHeartrateEnabled: false,
                // 社交动态设置
                socialEnabled: false,
                socialFrequency: 'medium',
                // 后台互动设置
                backgroundInteractionEnabled: false,
                backgroundChatFrequency: 'low',
                backgroundWeiboFrequency: 'low',
                // 其他原有设置
                timestampEnabled: true,
                timestampPosition: 'center'
            };
            
            return savedSettings ? { ...defaultSettings, ...JSON.parse(savedSettings) } : defaultSettings;
        }
        
        // 保存当前聊天的设置
        function saveCurrentChatSettings(settings) {
            if (!currentChatCharacter) return;
            
            const chatId = currentChatCharacter.id;
            localStorage.setItem(`chatSettings_${chatId}`, JSON.stringify(settings));
        }
        
        // 保存聊天模式设置
        function saveChatModeSettings() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            
            // 获取选中的聊天模式
            const onlineRadio = document.getElementById('chat-mode-online');
            const offlineRadio = document.getElementById('chat-mode-offline');
            
            if (onlineRadio && offlineRadio) {
                chatSettings.chatMode = onlineRadio.checked ? 'online' : 'offline';
            }
            
            // 获取线下模式字数限制
            const maxLengthInput = document.getElementById('offline-mode-max-length');
            if (maxLengthInput) {
                chatSettings.offlineModeMaxLength = parseInt(maxLengthInput.value) || 100;
            }
            
            saveCurrentChatSettings(chatSettings);
        }
        
        // 显示记忆挂载设置
        function showMemoryMountSettings() {
            const chatSettings = getCurrentChatSettings();
            // 加载当前设置
            document.getElementById('memory-mount-enabled').checked = chatSettings.memoryMountEnabled || false;
            document.getElementById('memory-mount-count').value = chatSettings.memoryMountCount || 3;
            document.getElementById('memory-mount-display').textContent = (chatSettings.memoryMountCount || 3) + '条';
            
            // 控制详细设置的显示
            toggleMemoryMountDetails();
            
            // 绑定事件
            document.getElementById('memory-mount-enabled').onchange = toggleMemoryMountDetails;
            document.getElementById('memory-mount-count').oninput = function() {
                document.getElementById('memory-mount-display').textContent = this.value + '条';
            };
            
            // 渲染聊天列表
            renderMemoryMountChatList();
            
            showModal('memory-mount-modal');
        }
        
        // 切换记忆挂载详细设置显示
        function toggleMemoryMountDetails() {
            const enabled = document.getElementById('memory-mount-enabled').checked;
            document.getElementById('memory-mount-details').style.display = enabled ? 'block' : 'none';
            document.getElementById('memory-mount-chats').style.display = enabled ? 'block' : 'none';
            
            // 更新主设置界面显示
            document.getElementById('current-memory-mount').textContent = enabled ? '已开启' : '已关闭';
        }
        
        // 渲染记忆挂载聊天列表
        function renderMemoryMountChatList() {
            const container = document.getElementById('memory-mount-list');
            container.innerHTML = '';
            
            if (characters.length === 0 && groupChats.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">暂无可挂载的聊天</p>';
                return;
            }
            
            // 添加单人聊天
            characters.forEach(character => {
                if (currentChatCharacter && character.id === currentChatCharacter.id) return; // 不显示当前聊天
                
                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${character.id}" value="${character.id}" class="mount-checkbox">
                    <div class="mount-avatar-small" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''} display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        ${character.avatarUrl ? '' : character.name.charAt(0)}
                    </div>
                    <div>
                        <div class="mount-name">${character.name}</div>
                        <div class="mount-type">单聊</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // 添加群聊
            groupChats.forEach(group => {
                if (currentChatCharacter && group.id === currentChatCharacter.id) return; // 不显示当前聊天
                
                const item = document.createElement('div');
                item.className = 'mount-item';
                item.innerHTML = `
                    <input type="checkbox" id="mount-${group.id}" value="${group.id}" class="mount-checkbox">
                    <div class="mount-avatar-group">
                        群
                    </div>
                    <div>
                        <div class="mount-name">${group.name}</div>
                        <div class="mount-type">群聊 (${group.members ? group.members.length : 0}人)</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // 加载已选择的聊天
            const chatSettings = getCurrentChatSettings();
            const selectedChats = chatSettings.selectedMemoryChats || [];
            selectedChats.forEach(chatId => {
                const checkbox = document.getElementById(`mount-${chatId}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        // 保存记忆挂载设置
        function saveMemoryMountSettings() {
            const chatSettings = getCurrentChatSettings();
            chatSettings.memoryMountEnabled = document.getElementById('memory-mount-enabled').checked;
            chatSettings.memoryMountCount = parseInt(document.getElementById('memory-mount-count').value);
            
            // 获取选中的聊天
            const checkboxes = document.querySelectorAll('#memory-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedMemoryChats = Array.from(checkboxes).map(cb => cb.value);
            
            // 更新主设置界面显示
            document.getElementById('current-memory-mount').textContent = chatSettings.memoryMountEnabled ? '已开启' : '已关闭';
            
            saveCurrentChatSettings(chatSettings);
            hideModal('memory-mount-modal');
            alert('记忆挂载设置已保存');
        }
        
        // 保存聊天头像设置
        function saveChatAvatarSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // 保存隐藏头像设置
            const hideAvatarsCheckbox = document.getElementById('hide-avatars');
            if (hideAvatarsCheckbox) {
                chatSettings.hideAvatars = hideAvatarsCheckbox.checked;
            }
            
            // 保存头像设置
            if (window.selectedMyChatAvatar) {
                chatSettings.myChatAvatar = window.selectedMyChatAvatar;
            }
            if (window.selectedAiChatAvatar) {
                chatSettings.aiChatAvatar = window.selectedAiChatAvatar;
            }
            
            saveCurrentChatSettings(chatSettings);
            hideModal('avatar-settings-modal');
            
            // 刷新聊天界面以显示新头像
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            alert('头像设置已保存');
        }
        
        // 保存昵称设置
        function saveChatNicknameSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.myChatNickname = document.getElementById('my-chat-nickname').value.trim();
            chatSettings.aiChatNickname = document.getElementById('ai-chat-nickname').value.trim();
            
            saveCurrentChatSettings(chatSettings);
            hideModal('nickname-settings-modal');
            
            // 更新聊天界面标题
            if (currentChatCharacter) {
                const displayTitle = chatSettings.aiChatNickname || currentChatCharacter.name;
                document.getElementById('api-chat-title').textContent = displayTitle;
            }
            
            // 刷新聊天界面
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            // 🔥【修复】刷新消息列表和联系人列表以显示新昵称
            renderMessageList();
            renderContactList();
            
            alert('昵称设置已保存');
        }
        
        // 保存戳一戳后缀设置
        function savePokeSuffixSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.myPokeSuffix = document.getElementById('my-poke-suffix').value.trim();
            chatSettings.aiPokeSuffix = document.getElementById('ai-poke-suffix').value.trim();
            
            saveCurrentChatSettings(chatSettings);
            hideModal('poke-suffix-modal');
            alert('戳一戳后缀设置已保存');
        }
        
        // 保存聊天背景设置
        function saveChatBackgroundSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // 处理背景设置，包括移除背景的情况
            if (window.selectedChatBackground === null) {
                // 用户选择移除背景
                chatSettings.chatBackground = null;
            } else if (window.selectedChatBackground) {
                // 用户选择了新背景
                chatSettings.chatBackground = window.selectedChatBackground;
            }
            // 如果 window.selectedChatBackground 是 undefined，则保持原有设置不变
            
            saveCurrentChatSettings(chatSettings);
            hideModal('background-settings-modal');
            
            // 应用到聊天界面
            applyChatBackground();
            
            alert('聊天背景设置已保存');
        }
        
        // 移除背景
        function removeBackground() {
            const backgroundPreview = document.getElementById('chat-background-preview');
            backgroundPreview.style.backgroundImage = 'none';
            backgroundPreview.querySelector('.preview-text').style.display = 'block';
            backgroundPreview.querySelector('.preview-text').textContent = '已移除背景';
            window.selectedChatBackground = null;
        }

        // 更新气泡大小显示值
        function updatePaddingValue(value) {
            const paddingValue = document.getElementById('bubble-padding-value');
            if (paddingValue) {
                if (value <= 10) {
                    paddingValue.textContent = '紧凑';
                } else if (value <= 14) {
                    paddingValue.textContent = '中等';
                } else if (value <= 18) {
                    paddingValue.textContent = '宽松';
                } else {
                    paddingValue.textContent = '超大';
                }
            }
        }

        // 保存气泡样式设置
        function saveBubbleStyleSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // 保存样式选择
            if (window.selectedBubbleStyle) {
                chatSettings.bubbleStyle = window.selectedBubbleStyle;
            }
            
            // 保存颜色设置
            chatSettings.myBubbleColor = document.getElementById('my-bubble-color').value;
            chatSettings.aiBubbleColor = document.getElementById('ai-bubble-color').value;
            
            // 保存分离的透明度设置
            chatSettings.myBubbleOpacity = document.getElementById('my-bubble-opacity').value;
            chatSettings.aiBubbleOpacity = document.getElementById('ai-bubble-opacity').value;
            
            // 保存气泡大小设置
            chatSettings.bubblePadding = document.getElementById('bubble-padding').value;
            
            saveCurrentChatSettings(chatSettings);
            hideModal('bubble-style-modal');
            
            // 刷新聊天界面以应用新设置
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            alert('气泡样式设置已保存');
        }

        // 显示时间戳设置
        function showTimestampSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // 设置时间戳开关状态
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                timestampEnabled.checked = chatSettings.timestampEnabled !== false; // 默认为true
            }
            
            // 设置时间戳位置选项
            const timestampPosition = chatSettings.timestampPosition || 'center';
            const positionRadios = document.querySelectorAll('input[name="timestamp-position"]');
            positionRadios.forEach(radio => {
                radio.checked = radio.value === timestampPosition;
            });
            
            // 绑定时间戳开关变化事件
            if (timestampEnabled) {
                timestampEnabled.onchange = function() {
                    const optionsGroup = document.getElementById('timestamp-options-group');
                    if (optionsGroup) {
                        optionsGroup.style.display = this.checked ? 'block' : 'none';
                    }
                };
                
                // 触发一次显示状态更新
                const optionsGroup = document.getElementById('timestamp-options-group');
                if (optionsGroup) {
                    optionsGroup.style.display = timestampEnabled.checked ? 'block' : 'none';
                }
            }
            
            showModal('timestamp-settings-modal');
        }

        // 保存时间戳设置
        function saveTimestampSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // 获取时间戳开关状态
            const timestampEnabled = document.getElementById('timestamp-modal-enabled');
            if (timestampEnabled) {
                chatSettings.timestampEnabled = timestampEnabled.checked;
            }
            
            // 获取选中的时间戳位置
            const selectedPosition = document.querySelector('input[name="timestamp-position"]:checked');
            if (selectedPosition) {
                chatSettings.timestampPosition = selectedPosition.value;
            }
            
            saveCurrentChatSettings(chatSettings);
            hideModal('timestamp-settings-modal');
            
            // 重新渲染聊天消息以应用新的时间戳设置
            if (currentChatCharacter) {
                renderChatMessages(currentChatCharacter.id);
            }
            
            alert('时间戳设置已保存');
        }
        
        // 头像上传处理函数
        function avatarUploadHandler(e) {
            console.log('avatar-upload change事件被触发');
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                
                console.log('选择了文件:', file.name, '大小:', file.size, 'bytes', '类型:', file.type);
                
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件');
                    e.target.value = ''; // 清空选择
                    return;
                }
                
                // 检查文件大小 (限制为5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片文件过大，请选择小于5MB的图片');
                    e.target.value = ''; // 清空选择
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const avatarPreview = document.getElementById('avatar-preview');
                        const avatarPreviewText = document.getElementById('avatar-preview-text');
                        
                        console.log('文件读取成功，开始设置预览');
                        
                        if (!avatarPreview) {
                            console.error('找不到avatar-preview元素');
                            alert('找不到头像预览元素');
                            return;
                        }
                        
                        // 添加has-image类来覆盖默认背景
                        avatarPreview.classList.add('has-image');
                        
                        // 强制设置背景图片并清除所有其他背景样式
                        avatarPreview.style.setProperty('background', `url(${event.target.result})`, 'important');
                        avatarPreview.style.setProperty('background-size', 'cover', 'important');
                        avatarPreview.style.setProperty('background-position', 'center', 'important');
                        avatarPreview.style.setProperty('background-repeat', 'no-repeat', 'important');
                        
                        // 隐藏文字
                        if (avatarPreviewText) {
                            avatarPreviewText.style.display = 'none';
                        }
                        
                        // 存储图片数据用于后续保存
                        window.selectedAvatarData = event.target.result;
                        
                        // 验证样式是否正确设置
                        console.log('头像预览UI更新完成，背景图片已设置');
                        console.log('当前avatar-preview的样式:', {
                            background: avatarPreview.style.background,
                            backgroundSize: avatarPreview.style.backgroundSize,
                            backgroundPosition: avatarPreview.style.backgroundPosition,
                            className: avatarPreview.className
                        });
                        
                        console.log('头像预览设置成功，图片数据已存储');
                    } catch (error) {
                        console.error('设置头像预览时发生错误:', error);
                        alert('设置头像预览失败，请重试: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    console.error('文件读取失败');
                    alert('图片读取失败，请重试');
                    e.target.value = ''; // 清空选择
                };
                
                reader.readAsDataURL(file);
            } else {
                console.log('没有选择文件或files为空');
            }
        }
        
        // 加载自定义表情包 - 使用IndexedDB（包含数据迁移）
        async function loadCustomEmojis() {
            try {
                const savedCustomEmojis = await db.customEmojis.toArray();
                
                if (savedCustomEmojis.length === 0) {
                    // IndexedDB中没有数据，尝试从localStorage迁移
                    const localStorageData = localStorage.getItem('customEmojis');
                    if (localStorageData) {
                        console.log('检测到localStorage中的自定义表情包数据，开始迁移...');
                        const localEmojis = JSON.parse(localStorageData);
                        
                        if (localEmojis.length > 0) {
                            await db.customEmojis.bulkAdd(localEmojis);
                        }
                        
                        customEmojis = localEmojis;
                        console.log('自定义表情包迁移完成:', customEmojis);
                    } else {
                        customEmojis = [];
                    }
                } else {
                    customEmojis = savedCustomEmojis;
                    console.log('从IndexedDB加载自定义表情包:', customEmojis);
                }
                
                // recentEmojis继续使用localStorage，因为数据量小
                const savedRecentEmojis = localStorage.getItem('recentEmojis');
                if (savedRecentEmojis) {
                    recentEmojis = JSON.parse(savedRecentEmojis);
                } else {
                    recentEmojis = [];
                }
            } catch (error) {
                console.error('加载自定义表情包失败:', error);
                // 如果IndexedDB失败，尝试从localStorage加载
                const localStorageData = localStorage.getItem('customEmojis');
                if (localStorageData) {
                    customEmojis = JSON.parse(localStorageData);
                    console.log('从localStorage备份加载自定义表情包:', customEmojis);
                } else {
                    customEmojis = [];
                }
                
                const savedRecentEmojis = localStorage.getItem('recentEmojis');
                if (savedRecentEmojis) {
                    recentEmojis = JSON.parse(savedRecentEmojis);
                } else {
                    recentEmojis = [];
                }
            }
        }
        
        // 保存自定义表情包 - 使用IndexedDB
        async function saveCustomEmojis() {
            try {
                await db.customEmojis.clear();
                if (customEmojis.length > 0) {
                    await db.customEmojis.bulkAdd(customEmojis);
                }
                // recentEmojis继续使用localStorage
                localStorage.setItem('recentEmojis', JSON.stringify(recentEmojis));
            } catch (error) {
                console.error('保存自定义表情包失败:', error);
            }
        }
        
        // 显示自定义表情包面板
        function showCustomEmojiPanel() {
            const panel = document.getElementById('custom-emoji-panel');
            const isVisible = panel.style.display === 'block';
            
            if (isVisible) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            } else {
                panel.style.display = 'block';
                renderEmojiGrid();
                
                // 点击其他地方关闭面板
                setTimeout(() => {
                    document.addEventListener('click', hideCustomEmojiPanel);
                }, 100);
            }
        }
        
        // 隐藏自定义表情包面板
        function hideCustomEmojiPanel(e) {
            const panel = document.getElementById('custom-emoji-panel');
            
            // 如果没有传递事件参数，直接隐藏面板
            if (!e) {
                if (panel) {
                    panel.style.display = 'none';
                    document.removeEventListener('click', hideCustomEmojiPanel);
                }
                return;
            }
            
            const emojiBtn = e.target.closest('.chat-action-btn');
            
            if (panel && !panel.contains(e.target) && !emojiBtn) {
                panel.style.display = 'none';
                document.removeEventListener('click', hideCustomEmojiPanel);
            }
        }
        
        // 渲染表情包网格
        function renderEmojiGrid() {
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = '';
            
            let emojisToShow = [];
            
            if (currentEmojiTab === 'recent') {
                emojisToShow = recentEmojis;
            } else if (currentEmojiTab === 'custom') {
                emojisToShow = customEmojis;
            }
            
            // 添加表情包
            emojisToShow.forEach((emoji, index) => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'custom-emoji-item';
                emojiItem.style.backgroundImage = `url(${emoji.url})`;
                emojiItem.onclick = () => sendEmojiMessage(emoji);
                
                // 如果是自定义标签页，添加删除按钮
                if (currentEmojiTab === 'custom') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'emoji-delete-btn';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteCustomEmoji(index);
                    };
                    emojiItem.appendChild(deleteBtn);
                }
                
                grid.appendChild(emojiItem);
            });
            
            // 如果是自定义标签页，添加上传按钮
            if (currentEmojiTab === 'custom') {
                const uploadItem = document.createElement('div');
                uploadItem.className = 'custom-emoji-item placeholder';
                uploadItem.innerHTML = '+';
                uploadItem.onclick = () => document.getElementById('emoji-upload').click();
                grid.appendChild(uploadItem);
            }
            
            // 如果没有表情包，显示提示
            if (emojisToShow.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-emoji-grid';
                
                                                if (currentEmojiTab === 'recent') {
                                    emptyMsg.textContent = '还没有使用过表情包';
                                } else {
                                    emptyMsg.textContent = '还没有表情包，点击+号添加';
                                }
                
                grid.appendChild(emptyMsg);
            }
        }
        
        // 发送表情包消息
        function sendEmojiMessage(emoji) {
            if (!currentChatCharacter) return;
            
            // 添加到最近使用
            addToRecentEmojis(emoji);
            
            // 创建消息
            const messageId = Date.now().toString();
            const emojiMessage = {
                id: messageId,
                sender: 'sent',
                content: '',
                image: emoji.url,
                isEmoji: true,
                emojiDescription: emoji.description || '自定义表情包',
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(emojiMessage);
            saveChatMessages();
            
            // 渲染消息
            renderChatMessages(currentChatCharacter.id);
            
            // 隐藏表情包面板
            hideCustomEmojiPanel();
            
            // 设置待回复消息，支持智能回复按钮
            pendingUserMessage = emojiMessage;
            
            // 更新智能回复按钮状态
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = '点击获取AI回复';
            }
            
            // 注释掉自动回复，改为手动回复模式
            // setTimeout(() => {
            //     sendAIEmojiResponse(emoji);
            // }, 1000 + Math.random() * 2000);
        }
        
        // 添加到最近使用的表情包
        async function addToRecentEmojis(emoji) {
            // 移除已存在的相同表情包
            recentEmojis = recentEmojis.filter(e => e.url !== emoji.url);
            
            // 添加到开头
            recentEmojis.unshift(emoji);
            
            // 限制最近使用数量为20个
            if (recentEmojis.length > 20) {
                recentEmojis = recentEmojis.slice(0, 20);
            }
            
            await saveCustomEmojis();
        }
        
        // 检测当前模型是否支持视觉功能
        function isVisionModelSupported() {
            // 支持视觉的模型列表
            const visionModels = [
                // OpenAI GPT系列
                'gpt-4-vision',
                'gpt-4o',
                'gpt-4-turbo',
                'gpt-4o-mini',
                
                // Google Gemini系列
                'gemini-1.5-pro',
                'gemini-1.5-flash',
                'gemini-2.0-flash',
                'gemini-2.5-pro',
                'gemini-2.5-flash',
                'gemini-exp',
                'gemini-pro-vision',
                
                // Anthropic Claude系列
                'claude-3-opus',
                'claude-3-sonnet',
                'claude-3-haiku',
                'claude-3.5-sonnet',
                'claude-3.5-haiku',
                
                // 国产模型
                'qwen-vl',
                'qwen2-vl',
                'yi-vision',
                'glm-4v',
                'internvl',
                'cogvlm',
                
                // 其他模型
                'llava',
                'moondream',
                'phi-3-vision'
            ];
            
            const currentModel = apiSettings.model?.toLowerCase() || '';
            
            // 检查当前模型是否包含任何支持视觉的模型名称
            const isVisionSupported = visionModels.some(model => currentModel.includes(model.toLowerCase()));
            
            // 输出调试信息
            console.log('当前模型:', currentModel);
            console.log('是否支持视觉:', isVisionSupported);
            
            return isVisionSupported;
        }
        
        // 注释：AI对表情包的自动回复功能已移除，现在使用手动回复模式
        // 表情包和图片都通过智能回复按钮来触发AI回复
        
        // 删除自定义表情包
        function deleteCustomEmoji(index) {
            if (confirm('确定要删除这个表情包吗？')) {
                customEmojis.splice(index, 1);
                saveCustomEmojis();
                renderEmojiGrid();
            }
        }
        
        // 初始化表情包上传功能
        function initializeEmojiUpload() {
            const emojiInput = document.getElementById('emoji-upload');
            if (emojiInput) {
                emojiInput.addEventListener('change', handleEmojiUpload);
            }
            
            // 绑定标签页切换事件
            document.querySelectorAll('.emoji-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
                    // 添加当前active类
                    this.classList.add('active');
                    
                    // 切换当前标签页
                    currentEmojiTab = this.dataset.tab;
                    renderEmojiGrid();
                });
            });
        }
        
        // 处理表情包上传
        function handleEmojiUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件');
                    return;
                }
                
                // 检查GIF格式，提醒用户可能的问题
                if (file.type === 'image/gif') {
                    const confirmed = confirm('检测到GIF格式的表情包！\n\n⚠️ 注意事项：\n• AI可以发送这个GIF动图\n• 但Gemini API无法识别GIF内容\n• 重新生成功能可能失效\n• 建议使用静态图片格式\n\n是否仍要上传这个GIF表情包？');
                    if (!confirmed) {
                        return;
                    }
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片文件过大，请选择小于5MB的图片');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    // 弹出描述输入框
                    const description = prompt('请为这个表情包添加描述（推荐！帮助AI更好地理解表情包内容）:\n\n例如：\n• "笑哭的表情"\n• "握拳加油的动作"\n• "写着OMG的表情包"\n• "愤怒的猫咪图片"', '');
                    
                    const emoji = {
                        id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                        url: event.target.result,
                        description: description || '表情包',
                        addedAt: new Date().toISOString()
                    };
                    
                    customEmojis.push(emoji);
                    saveCustomEmojis();
                    
                    // 如果当前在自定义标签页，重新渲染
                    if (currentEmojiTab === 'custom') {
                        renderEmojiGrid();
                    }
                };
                
                reader.readAsDataURL(file);
            });
            
            // 清空文件输入
            e.target.value = '';
        }
        
        // 判断颜色是否为浅色
        function isLightColor(color) {
            // 将颜色转换为RGB值
            let r, g, b;
            
            if (color.startsWith('#')) {
                // 十六进制颜色
                const hex = color.slice(1);
                if (hex.length === 3) {
                    r = parseInt(hex[0] + hex[0], 16);
                    g = parseInt(hex[1] + hex[1], 16);
                    b = parseInt(hex[2] + hex[2], 16);
                } else {
                    r = parseInt(hex.substr(0, 2), 16);
                    g = parseInt(hex.substr(2, 2), 16);
                    b = parseInt(hex.substr(4, 2), 16);
                }
            } else if (color.startsWith('rgb')) {
                // RGB颜色
                const matches = color.match(/\d+/g);
                if (matches && matches.length >= 3) {
                    r = parseInt(matches[0]);
                    g = parseInt(matches[1]);
                    b = parseInt(matches[2]);
                }
            } else {
                // 默认为深色
                return false;
            }
            
            // 计算亮度
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128;
        }
        
        // 更新气泡预览
        function updateBubblePreview() {
            const myColor = document.getElementById('my-bubble-color')?.value || '#007AFF';
            const aiColor = document.getElementById('ai-bubble-color')?.value || '#f0f0f0';
            const myOpacity = document.getElementById('my-bubble-opacity')?.value || '1';
            const aiOpacity = document.getElementById('ai-bubble-opacity')?.value || '1';
            
            // 更新预览气泡
            const demoMyBubble = document.getElementById('demo-my-bubble');
            const demoAiBubble = document.getElementById('demo-ai-bubble');
            
            if (demoMyBubble) {
                demoMyBubble.style.backgroundColor = myColor;
                demoMyBubble.style.opacity = myOpacity;
                demoMyBubble.style.color = isLightColor(myColor) ? '#333' : '#fff';
            }
            
            if (demoAiBubble) {
                demoAiBubble.style.backgroundColor = aiColor;
                demoAiBubble.style.opacity = aiOpacity;
                demoAiBubble.style.color = isLightColor(aiColor) ? '#333' : '#fff';
            }
            
            // 更新颜色预览
            const myPreview = document.getElementById('my-bubble-preview');
            const aiPreview = document.getElementById('ai-bubble-preview');
            
            if (myPreview) {
                myPreview.style.backgroundColor = myColor;
                myPreview.style.opacity = myOpacity;
                myPreview.textContent = '我的气泡';
            }
            
            if (aiPreview) {
                aiPreview.style.backgroundColor = aiColor;
                aiPreview.style.opacity = aiOpacity;
                aiPreview.textContent = '对方气泡';
            }
        }
        
        // 绑定头像上传事件
        function bindAvatarUploadEvents() {
            // 我的头像上传
            const myAvatarUpload = document.getElementById('my-chat-avatar-upload');
            if (myAvatarUpload) {
                myAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('my-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedMyChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }
            
            // AI头像上传
            const aiAvatarUpload = document.getElementById('ai-chat-avatar-upload');
            if (aiAvatarUpload) {
                aiAvatarUpload.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('ai-chat-avatar-preview');
                            if (preview) {
                                preview.style.backgroundImage = `url(${event.target.result})`;
                                preview.style.backgroundSize = 'cover';
                                preview.style.backgroundPosition = 'center';
                                preview.innerHTML = '';
                                window.selectedAiChatAvatar = event.target.result;
                            }
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                };
            }
        }
        
        // 初始化头像上传功能
        function initializeAvatarUpload() {
            const avatarInput = document.getElementById('avatar-upload');
            if (!avatarInput) {
                console.error('找不到avatar-upload元素');
                return;
            }
            
            // 移除旧的事件监听器
            avatarInput.removeEventListener('change', avatarUploadHandler);
            
            // 添加新的事件监听器
            avatarInput.addEventListener('change', avatarUploadHandler);
            console.log('头像上传事件监听器已绑定');
        }
        
        // 更新聊天设置界面的显示状态
        function updateChatSettingsDisplay() {
            if (!currentChatCharacter) return;
            
            const chatSettings = getCurrentChatSettings();
            
            // 更新历史消息数显示
            const historyCountElement = document.getElementById('current-history-count');
            if (historyCountElement) {
                historyCountElement.textContent = chatSettings.historyCount + '回合';
            }
            
            // 更新记忆挂载显示
            const memoryMountElement = document.getElementById('current-memory-mount');
            if (memoryMountElement) {
                memoryMountElement.textContent = chatSettings.memoryMountEnabled ? '已开启' : '已关闭';
            }
            
            // 更新世界书挂载显示
            updateWorldbookMountDisplay();
            
            // 更新时间感知开关
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.checked = chatSettings.timeAwarenessEnabled;
            }
            
            // 更新通话设置
            const aiCallCheckbox = document.getElementById('ai-call-enabled');
            if (aiCallCheckbox) {
                aiCallCheckbox.checked = chatSettings.aiCallEnabled;
            }
            
            // 更新心率监测设置
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.checked = chatSettings.aiHeartrateEnabled;
            }
            
            // 更新社交动态设置
            const socialCheckbox = document.getElementById('social-enabled');
            if (socialCheckbox) {
                socialCheckbox.checked = chatSettings.socialEnabled;
                // 控制详细设置显示
                const socialSettings = document.querySelectorAll('.social-settings');
                socialSettings.forEach(setting => {
                    setting.style.display = chatSettings.socialEnabled ? 'block' : 'none';
                });
            }
            
            const socialFrequencySelect = document.getElementById('social-frequency');
            if (socialFrequencySelect) {
                socialFrequencySelect.value = chatSettings.socialFrequency || 'medium';
            }
            
            // 更新后台互动设置
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.checked = chatSettings.backgroundInteractionEnabled;
                // 控制详细设置显示
                const backgroundSettings = document.getElementById('background-interaction-settings');
                if (backgroundSettings) {
                    backgroundSettings.style.display = chatSettings.backgroundInteractionEnabled ? 'block' : 'none';
                }
            }
            
            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.value = chatSettings.backgroundChatFrequency || 'low';
            }
            
            const backgroundWeiboFrequencySelect = document.getElementById('background-weibo-frequency');
            if (backgroundWeiboFrequencySelect) {
                backgroundWeiboFrequencySelect.value = chatSettings.backgroundWeiboFrequency || 'low';
            }
            
            // 更新时间戳设置
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                timestampCheckbox.checked = chatSettings.timestampEnabled;
            }
            
            // 绑定事件监听器来保存设置变化
            bindChatSettingsEvents();
        }
        
        // 绑定聊天设置的事件监听器
        function bindChatSettingsEvents() {
            // 时间感知开关
            const timeAwarenessCheckbox = document.getElementById('time-awareness-enabled');
            if (timeAwarenessCheckbox) {
                timeAwarenessCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timeAwarenessEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // 通话设置
            const aiCallCheckbox = document.getElementById('ai-call-enabled');
            if (aiCallCheckbox) {
                aiCallCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiCallEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // 心率监测设置
            const aiHeartrateCheckbox = document.getElementById('ai-heartrate-enabled');
            if (aiHeartrateCheckbox) {
                aiHeartrateCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.aiHeartrateEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // 社交动态设置
            const socialCheckbox = document.getElementById('social-enabled');
            if (socialCheckbox) {
                socialCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.socialEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                    // 显示/隐藏详细设置
                    const socialSettings = document.querySelectorAll('.social-settings');
                    socialSettings.forEach(setting => {
                        setting.style.display = this.checked ? 'block' : 'none';
                    });
                };
            }
            
            const socialFrequencySelect = document.getElementById('social-frequency');
            if (socialFrequencySelect) {
                socialFrequencySelect.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.socialFrequency = this.value;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // 后台互动设置
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundInteractionEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                    // 显示/隐藏详细设置
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }
                };
            }
            
            const backgroundChatFrequencySelect = document.getElementById('background-chat-frequency');
            if (backgroundChatFrequencySelect) {
                backgroundChatFrequencySelect.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundChatFrequency = this.value;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            const backgroundWeiboFrequencySelect = document.getElementById('background-weibo-frequency');
            if (backgroundWeiboFrequencySelect) {
                backgroundWeiboFrequencySelect.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.backgroundWeiboFrequency = this.value;
                    saveCurrentChatSettings(chatSettings);
                };
            }
            
            // 时间戳设置
            const timestampCheckbox = document.getElementById('timestamp-enabled');
            if (timestampCheckbox) {
                timestampCheckbox.onchange = function() {
                    const chatSettings = getCurrentChatSettings();
                    chatSettings.timestampEnabled = this.checked;
                    saveCurrentChatSettings(chatSettings);
                    // 重新渲染聊天消息
                    if (currentChatCharacter) {
                        renderChatMessages(currentChatCharacter.id);
                    }
                };
            }
        }

        // 初始化聊天设置界面
        function initializeChatSettings() {
            // 更新身份显示
            updateChatIdentityDisplay();
            
            // 更新气泡样式显示
            updateBubbleStyleDisplay();
            
            // 更新所有设置显示状态
            updateChatSettingsDisplay();
            
            // 加载当前聊天的设置
            if (currentChatCharacter) {
                const chatSettings = getCurrentChatSettings();
                
                // 设置聊天模式
                const chatMode = chatSettings.chatMode || 'online';
                const onlineRadio = document.getElementById('chat-mode-online');
                const offlineRadio = document.getElementById('chat-mode-offline');
                
                if (onlineRadio && offlineRadio) {
                    if (chatMode === 'online') {
                        onlineRadio.checked = true;
                    } else {
                        offlineRadio.checked = true;
                    }
                    
                    // 显示/隐藏线下模式字数控制
                    const offlineLengthControl = document.getElementById('offline-length-control');
                    if (offlineLengthControl) {
                        offlineLengthControl.style.display = chatMode === 'offline' ? 'flex' : 'none';
                    }
                    
                    // 设置线下模式字数限制
                    const maxLengthInput = document.getElementById('offline-mode-max-length');
                    if (maxLengthInput) {
                        maxLengthInput.value = chatSettings.offlineModeMaxLength || 100;
                    }
                }
            }
            
            // 绑定聊天模式切换事件
            const chatModeRadios = document.querySelectorAll('input[name="chat-mode"]');
            chatModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const offlineLengthControl = document.getElementById('offline-length-control');
                    if (offlineLengthControl) {
                        offlineLengthControl.style.display = this.value === 'offline' ? 'flex' : 'none';
                    }
                    
                    // 保存聊天模式设置
                    saveChatModeSettings();
                });
            });
            
            // 绑定线下模式字数限制变化事件
            const maxLengthInput = document.getElementById('offline-mode-max-length');
            if (maxLengthInput) {
                maxLengthInput.addEventListener('change', saveChatModeSettings);
            }
            
            // 绑定社交动态开关事件
            const socialEnabledCheckbox = document.getElementById('social-enabled');
            if (socialEnabledCheckbox) {
                socialEnabledCheckbox.addEventListener('change', function() {
                    const socialSettings = document.querySelectorAll('.social-settings');
                    socialSettings.forEach(setting => {
                        setting.style.display = this.checked ? 'block' : 'none';
                    });
                });
            }
            
            // 绑定后台互动开关事件
            const backgroundInteractionCheckbox = document.getElementById('background-interaction-enabled');
            if (backgroundInteractionCheckbox) {
                backgroundInteractionCheckbox.addEventListener('change', function() {
                    const backgroundSettings = document.getElementById('background-interaction-settings');
                    if (backgroundSettings) {
                        backgroundSettings.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // 绑定戳一戳功能开关事件
            const pokeEnabledCheckbox = document.getElementById('poke-enabled');
            if (pokeEnabledCheckbox) {
                pokeEnabledCheckbox.addEventListener('change', function() {
                    const pokeSuffixSettings = document.getElementById('poke-suffix-settings');
                    if (pokeSuffixSettings) {
                        pokeSuffixSettings.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // 绑定选择模式按钮事件
            const selectionCancelBtn = document.getElementById('selection-cancel-btn');
            const selectionDeleteBtn = document.getElementById('selection-delete-btn');
            
            if (selectionCancelBtn) {
                selectionCancelBtn.addEventListener('click', exitMessageSelectionMode);
            }
            
            if (selectionDeleteBtn) {
                selectionDeleteBtn.addEventListener('click', function() {
                    if (selectedMessages.size === 0) return;
                    
                    deleteSelectedMessages();
                });
            }
        }
        
        // 戳一戳功能
        function pokeCharacter(characterId) {
            if (!currentChatCharacter || currentChatCharacter.id !== characterId) {
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const pokeSuffix = chatSettings.myPokeSuffix || '';
            const characterName = chatSettings.aiChatNickname || currentChatCharacter.name;
            
            // 创建戳一戳系统消息
            const pokeMessage = {
                id: Date.now().toString(),
                sender: 'system',
                content: `你戳了戳${characterName}${pokeSuffix}`,
                timestamp: Date.now(),
                isPoke: true
            };
            
            // 添加到聊天记录
            if (!chatMessages[characterId]) {
                chatMessages[characterId] = [];
            }
            
            chatMessages[characterId].push(pokeMessage);
            saveChatMessages();
            
            // 渲染消息
            renderChatMessages(characterId);
            
            // 模拟角色回应（40%概率）
            if (Math.random() < 0.4) {
                setTimeout(() => {
                    const aiPokeSuffix = chatSettings.aiPokeSuffix || '';
                    const aiPokeMessage = {
                        id: Date.now().toString(),
                        sender: 'system',
                        content: `${characterName}戳了戳你${aiPokeSuffix}`,
                        timestamp: Date.now(),
                        isPoke: true
                    };
                    
                    chatMessages[characterId].push(aiPokeMessage);
                    saveChatMessages();
                    renderChatMessages(characterId);
                }, 1000 + Math.random() * 2000);
            }
        }
        
        // 显示聊天选项
        function showChatOptions() {
            showModal('chat-options-modal');
        }
        
        // 显示单聊角色选择
        function showSingleChatSelector() {
            hideModal('chat-options-modal');
            
            const modalBody = document.getElementById('single-chat-body');
            modalBody.innerHTML = '';
            
            if (characters.length === 0) {
                modalBody.innerHTML = '<p class="empty-mount-chats">还没有角色，请先创建角色</p>';
            } else {
                characters.forEach(character => {
                    const chatOption = document.createElement('div');
                    chatOption.className = 'chat-option-item';
                    chatOption.onclick = () => {
                        hideModal('single-chat-modal');
                        startChat(character);
                    };
                    
                    chatOption.innerHTML = `
                        <div class="chat-option-icon" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}</div>
                            <div class="chat-option-desc">${character.bio || '暂无描述'}</div>
                        </div>
                    `;
                    
                    modalBody.appendChild(chatOption);
                });
            }
            
            showModal('single-chat-modal');
        }
        
        // 显示群聊角色选择
        function showGroupChatSelector() {
            hideModal('chat-options-modal');
            
            // 重置表单
            document.getElementById('group-chat-name').value = '';
            selectedGroupMembers = [];
            
            const membersContainer = document.getElementById('group-chat-members');
            membersContainer.innerHTML = '';
            
            if (characters.length < 2) {
                membersContainer.innerHTML = '<p class="empty-mount-chats">至少需要2个角色才能创建群聊</p>';
            } else {
                characters.forEach(character => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.onclick = () => toggleGroupMemberSelection(character.id);
                    
                    memberItem.innerHTML = `
                        <div class="group-member-checkbox" id="checkbox-${character.id}">
                        </div>
                        <div class="message-avatar" style="background-color: ${character.color}; ${character.avatarUrl ? `background-image: url(${character.avatarUrl}); background-size: cover; background-position: center;` : ''}">
                            ${character.avatarUrl ? '' : character.name.charAt(0)}
                        </div>
                        <div class="chat-option-text">
                            <div class="chat-option-title">${character.name}</div>
                            <div class="chat-option-desc">${character.bio || '暂无描述'}</div>
                        </div>
                    `;
                    
                    membersContainer.appendChild(memberItem);
                });
            }
            
            showModal('group-chat-modal');
        }
        
        // 切换群聊成员选择
        function toggleGroupMemberSelection(characterId) {
            const index = selectedGroupMembers.indexOf(characterId);
            const checkbox = document.getElementById(`checkbox-${characterId}`);
            const memberItem = checkbox.closest('.group-member-item');
            
            if (index > -1) {
                selectedGroupMembers.splice(index, 1);
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                memberItem.classList.remove('selected');
            } else {
                if (selectedGroupMembers.length >= 8) {
                    alert('最多只能选择8个成员');
                    return;
                }
                selectedGroupMembers.push(characterId);
                checkbox.classList.add('checked');
                checkbox.innerHTML = '<i class="fas fa-check"></i>';
                memberItem.classList.add('selected');
            }
        }
        
        // 创建群聊
        async function createGroupChat() {
            const groupName = document.getElementById('group-chat-name').value.trim();
            
            if (!groupName) {
                alert('请输入群聊名称');
                return;
            }
            
            if (selectedGroupMembers.length < 2) {
                alert('至少需要选择2个成员');
                return;
            }
            
            // 获取选中成员的详细信息
            const memberDetails = selectedGroupMembers.map(memberId => {
                const character = characters.find(c => c.id === memberId);
                return {
                    id: character.id,
                    name: character.name,
                    bio: character.bio,
                    avatarUrl: character.avatarUrl,
                    color: character.color
                };
            });
            
            // 创建群聊对象
            const groupChat = {
                id: 'group_' + Date.now().toString(),
                name: groupName,
                members: memberDetails,
                isGroup: true,
                createdAt: new Date().toISOString()
            };
            
            // 添加到群聊列表
            if (!groupChats) groupChats = [];
            groupChats.push(groupChat);
            await saveGroupChats();
            
            hideModal('group-chat-modal');
            renderMessageList();
            alert(`群聊"${groupName}"创建成功！`);
        }
        
        // 保存群聊数据 - 使用IndexedDB
        async function saveGroupChats() {
            try {
                console.log('保存群聊数据到IndexedDB:', groupChats);
                
                // 清空现有数据
                await db.groupChats.clear();
                
                // 批量插入新数据
                if (groupChats.length > 0) {
                    await db.groupChats.bulkAdd(groupChats);
                }
                
                console.log('群聊数据保存成功');
            } catch (error) {
                console.error('保存群聊时发生错误:', error);
                // 如果IndexedDB失败，回退到localStorage
                localStorage.setItem('groupChats', JSON.stringify(groupChats));
            }
        }
        
        // 渲染定时发布时间点
        function renderScheduleTimes() {
            const container = document.getElementById('schedule-times-container');
            if (!container) return;
            
            const chatSettings = getCurrentChatSettings();
            const scheduleTimes = chatSettings.scheduleTimes || [];
            
            container.innerHTML = '';
            
            scheduleTimes.forEach((time, index) => {
                const timeItem = document.createElement('div');
                timeItem.className = 'schedule-time-item';
                timeItem.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${index}, this.value)">
                    <button onclick="removeScheduleTime(${index})">×</button>
                `;
                container.appendChild(timeItem);
            });
        }
        
        // 添加定时发布时间点
        function addScheduleTime() {
            const chatSettings = getCurrentChatSettings();
            if (!chatSettings.scheduleTimes) {
                chatSettings.scheduleTimes = [];
            }
            
            if (chatSettings.scheduleTimes.length >= 10) {
                alert('最多只能设置10个时间点');
                return;
            }
            
            chatSettings.scheduleTimes.push('09:00');
            saveCurrentChatSettings(chatSettings);
            renderScheduleTimes();
        }
        
        // 更新定时发布时间点
        function updateScheduleTime(index, newTime) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes[index] = newTime;
                saveCurrentChatSettings(chatSettings);
            }
        }
        
        // 移除定时发布时间点
        function removeScheduleTime(index) {
            const chatSettings = getCurrentChatSettings();
            if (chatSettings.scheduleTimes && chatSettings.scheduleTimes[index] !== undefined) {
                chatSettings.scheduleTimes.splice(index, 1);
                saveCurrentChatSettings(chatSettings);
                renderScheduleTimes();
            }
        }
        
        // 保存定时发布设置
        function saveScheduleSettings() {
            const chatSettings = getCurrentChatSettings();
            chatSettings.scheduleEnabled = document.getElementById('schedule-enabled').checked;
            
            saveCurrentChatSettings(chatSettings);
            hideModal('schedule-settings-modal');
            alert('定时发布设置已保存');
        }
        
        // 显示世界书挂载设置
        function showWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();
            
            // 加载当前设置
            document.getElementById('worldbook-mount-enabled').checked = chatSettings.worldbookMountEnabled || false;
            
            // 控制详细设置的显示
            toggleWorldbookMountDetails();
            
            // 绑定事件
            document.getElementById('worldbook-mount-enabled').onchange = toggleWorldbookMountDetails;
            
            // 渲染世界书列表
            renderWorldbookMountList();
            
            showModal('worldbook-mount-modal');
        }
        
        // 切换世界书挂载详细设置显示
        function toggleWorldbookMountDetails() {
            const enabled = document.getElementById('worldbook-mount-enabled').checked;
            document.getElementById('worldbook-mount-details').style.display = enabled ? 'block' : 'none';
            
            // 更新主设置界面显示
            updateWorldbookMountDisplay();
        }
        
        // 更新世界书挂载显示状态
        function updateWorldbookMountDisplay() {
            const chatSettings = getCurrentChatSettings();
            const displayElement = document.getElementById('current-worldbook-mount');
            
            if (!chatSettings.worldbookMountEnabled) {
                displayElement.textContent = '未挂载';
                return;
            }
            
            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];
            if (selectedWorldbooks.length === 0) {
                displayElement.textContent = '已启用但未选择';
            } else if (selectedWorldbooks.length === 1) {
                const worldbook = worldbooks.find(w => w.id === selectedWorldbooks[0]);
                displayElement.textContent = worldbook ? `已挂载: ${worldbook.title}` : '已挂载: 1个';
            } else {
                displayElement.textContent = `已挂载: ${selectedWorldbooks.length}个`;
            }
        }
        
        // 渲染世界书挂载列表
        function renderWorldbookMountList() {
            const container = document.getElementById('worldbook-mount-list');
            container.innerHTML = '';
            
            if (worldbooks.length === 0) {
                container.innerHTML = '<p class="empty-mount-chats">暂无世界书，请先在世界书应用中创建</p>';
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const selectedWorldbooks = chatSettings.selectedWorldbooks || [];
            
            worldbooks.forEach(worldbook => {
                const item = document.createElement('div');
                item.className = 'mount-item worldbook-mount-item';
                
                const isSelected = selectedWorldbooks.includes(worldbook.id);
                
                item.innerHTML = `
                    <input type="checkbox" id="worldbook-${worldbook.id}" value="${worldbook.id}" ${isSelected ? 'checked' : ''} class="worldbook-checkbox">
                    <div class="worldbook-content-flex">
                        <div class="worldbook-title-text">
                            ${worldbook.title}
                        </div>
                        <div class="worldbook-desc-text">
                            ${worldbook.content.length > 100 ? worldbook.content.substring(0, 100) + '...' : worldbook.content}
                        </div>
                        <div class="worldbook-date-text">
                            创建于: ${new Date(worldbook.createdAt).toLocaleDateString('zh-CN')} | 
                            字数: ${worldbook.content.length}
                        </div>
                    </div>
                `;
                
                // 点击整个条目也能切换选择状态
                item.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                };
                
                container.appendChild(item);
            });
        }
        
        // 保存世界书挂载设置
        function saveWorldbookMountSettings() {
            const chatSettings = getCurrentChatSettings();
            
            chatSettings.worldbookMountEnabled = document.getElementById('worldbook-mount-enabled').checked;
            
            // 获取选中的世界书
            const checkboxes = document.querySelectorAll('#worldbook-mount-list input[type="checkbox"]:checked');
            chatSettings.selectedWorldbooks = Array.from(checkboxes).map(cb => cb.value);
            
            saveCurrentChatSettings(chatSettings);
            updateWorldbookMountDisplay();
            hideModal('worldbook-mount-modal');
            
            const selectedCount = chatSettings.selectedWorldbooks ? chatSettings.selectedWorldbooks.length : 0;
            if (chatSettings.worldbookMountEnabled && selectedCount > 0) {
                alert(`世界书挂载设置已保存，已挂载 ${selectedCount} 个世界书`);
            } else if (chatSettings.worldbookMountEnabled) {
                alert('世界书挂载已启用，但未选择任何世界书');
            } else {
                alert('世界书挂载已关闭');
            }
        }
        
        // 显示身份选择器
        function showIdentitySelector() {
            renderIdentityList();
            showModal('identity-selector-modal');
        }
        
        // 渲染身份列表
        function renderIdentityList() {
            const container = document.getElementById('identity-selector-list');
            container.innerHTML = '';
            
            const chatSettings = getCurrentChatSettings();
            const selectedIdentityId = chatSettings.selectedIdentityId || 'default';
            
            personas.forEach(persona => {
                const item = document.createElement('div');
                item.className = `identity-item ${selectedIdentityId === persona.id ? 'selected' : ''}`;
                
                item.onclick = () => {
                    // 移除其他选中状态
                    container.querySelectorAll('.identity-item').forEach(div => {
                        div.classList.remove('selected');
                    });
                    
                    // 设置当前选中状态
                    item.classList.add('selected');
                    
                    // 保存选择
                    window.selectedChatIdentityId = persona.id;
                };
                
                item.innerHTML = `
                    <div class="identity-avatar" style="${persona.avatarUrl ? `background-image: url(${persona.avatarUrl}); background-size: cover; background-position: center;` : ''} display: flex; align-items: center; justify-content: center; color: #999; font-weight: bold;">
                        ${persona.avatarUrl ? '' : persona.name.charAt(0)}
                    </div>
                    <div class="identity-content-flex">
                        <div class="identity-name">${persona.name}</div>
                        <div class="identity-desc">${persona.description || '暂无描述'}</div>
                    </div>
                    ${selectedIdentityId === persona.id ? '<i class="fas fa-check identity-check-icon"></i>' : ''}
                `;
                
                container.appendChild(item);
                
                // 设置初始选中状态
                if (selectedIdentityId === persona.id) {
                    window.selectedChatIdentityId = persona.id;
                }
            });
        }
        
        // 保存聊天身份选择
        function saveChatIdentity() {
            if (!window.selectedChatIdentityId) {
                alert('请选择一个身份');
                return;
            }
            
            const chatSettings = getCurrentChatSettings();
            const selectedPersona = personas.find(p => p.id === window.selectedChatIdentityId);
            
            if (selectedPersona) {
                chatSettings.selectedIdentityId = selectedPersona.id;
                
                // 如果选中的身份有头像，自动设置为聊天头像（如果当前没有设置的话）
                if (selectedPersona.avatarUrl && !chatSettings.myChatAvatar) {
                    chatSettings.myChatAvatar = selectedPersona.avatarUrl;
                }
                
                // 如果选中的身份有名称，自动设置为聊天昵称（如果当前没有设置的话）
                if (selectedPersona.name && !chatSettings.myChatNickname) {
                    chatSettings.myChatNickname = selectedPersona.name;
                }
                
                saveCurrentChatSettings(chatSettings);
                
                // 更新显示
                updateChatIdentityDisplay();
                
                // 刷新聊天界面
                if (currentChatCharacter) {
                    renderChatMessages(currentChatCharacter.id);
                }
                
                hideModal('identity-selector-modal');
                alert(`已选择身份"${selectedPersona.name}"`);
            }
        }
        
        // 更新聊天身份显示
        function updateChatIdentityDisplay() {
            const chatSettings = getCurrentChatSettings();
            const selectedIdentityId = chatSettings.selectedIdentityId || 'default';
            const selectedPersona = personas.find(p => p.id === selectedIdentityId);
            
            const displayElement = document.getElementById('current-chat-identity');
            if (displayElement && selectedPersona) {
                displayElement.textContent = selectedPersona.name;
            }
        }
        
        // 更新气泡样式显示
        function updateBubbleStyleDisplay() {
            const chatSettings = getCurrentChatSettings();
            const styleNames = {
                'default': '默认样式',
                'glass': '毛玻璃',
                'shadow': '经典阴影',
                'tail': '经典气泡',
                'gradient': '渐变样式',
                'minimal': '极简样式',
                'neon': '霓虹样式',
                'paper': '纸张样式'
            };
            
            const displayElement = document.getElementById('current-bubble-style');
            if (displayElement) {
                const currentStyle = chatSettings.bubbleStyle || 'default';
                displayElement.textContent = styleNames[currentStyle] || '默认样式';
            }
        }
        
        // 全局头像上传处理函数
        function handleAvatarUploadClick() {
            console.log('点击了上传头像按钮');
            const input = document.getElementById('avatar-upload');
            if (input) {
                console.log('找到了input元素，准备触发点击');
                input.click();
            } else {
                console.error('找不到avatar-upload元素');
                alert('找不到文件上传元素，请刷新页面重试');
            }
        }
        
        // 加载群聊数据
        function loadGroupChats() {
            const groupChatsData = localStorage.getItem('groupChats');
            if (groupChatsData) {
                groupChats = JSON.parse(groupChatsData);
            }
        }
        
        // 添加消息长按监听器
        function addMessageLongPressListener(messageContainer, messageId) {
            let pressTimer = null;
            let isLongPress = false;
            
            const startLongPress = (e) => {
                if (isMessageSelectionMode) {
                    // 在选择模式下，只处理点击选择，不处理长按
                    return;
                }
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    enterMessageSelectionMode(messageId);
                    e.preventDefault();
                }, 500);
            };
            
            const cancelLongPress = () => {
                clearTimeout(pressTimer);
                // 重置长按标记，延迟重置以避免立即触发点击
                setTimeout(() => {
                    isLongPress = false;
                }, 50);
            };
            
            const handleClick = (e) => {
                // 在选择模式下，所有消息都可以点击切换选择状态
                if (isMessageSelectionMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMessageSelection(messageId);
                    return;
                }
                
                // 如果是长按触发后的点击，不处理
                if (isLongPress) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            };
            
            // 触摸事件
            messageContainer.addEventListener('touchstart', startLongPress, { passive: false });
            messageContainer.addEventListener('touchend', cancelLongPress);
            messageContainer.addEventListener('touchmove', cancelLongPress);
            
            // 鼠标事件（用于桌面端测试）
            messageContainer.addEventListener('mousedown', startLongPress);
            messageContainer.addEventListener('mouseup', cancelLongPress);
            messageContainer.addEventListener('mouseleave', cancelLongPress);
            
            // 点击事件 - 使用捕获阶段确保优先处理
            messageContainer.addEventListener('click', handleClick, true);
        }
        
        // 进入消息选择模式
        function enterMessageSelectionMode(initialMessageId) {
            if (isMessageSelectionMode) {
                return;
            }
            
            isMessageSelectionMode = true;
            selectedMessages.clear();
            selectedMessages.add(initialMessageId);
            
            // 添加选择模式CSS类
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.add('selection-mode');
            }
            
            updateMessageSelectionUI();
        }
        
        // 切换消息选择状态
        function toggleMessageSelection(messageId) {
            if (!isMessageSelectionMode) return;
            
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
            } else {
                selectedMessages.add(messageId);
            }
            
            updateMessageSelectionUI();
            
            // 如果没有选中的消息，退出选择模式
            if (selectedMessages.size === 0) {
                exitMessageSelectionMode();
            }
        }
        
        // 退出消息选择模式
        function exitMessageSelectionMode() {
            if (!isMessageSelectionMode) return;
            
            isMessageSelectionMode = false;
            
            // 移除选择模式CSS类
            const chatScreen = document.getElementById('api-chat-screen');
            if (chatScreen) {
                chatScreen.classList.remove('selection-mode');
            }
            
            // 🔥【修复】清除所有选中状态，包括撤回消息
            const selectedContainers = document.querySelectorAll('[data-message-id].selected');
            selectedContainers.forEach(container => {
                container.classList.remove('selected');
            });
            
            selectedMessages.clear();
            updateMessageSelectionUI();
        }
        

        
        // 更新消息选择UI
        function updateMessageSelectionUI() {
            // 🔥【修复】查找所有带有messageId的容器，包括撤回消息
            const allContainers = document.querySelectorAll('[data-message-id]');
            
            allContainers.forEach(container => {
                const messageId = container.dataset.messageId;
                if (messageId) {
                    if (selectedMessages.has(messageId)) {
                        container.classList.add('selected');
                    } else {
                        container.classList.remove('selected');
                    }
                }
            });
            
            // 更新选择计数显示
            const countElement = document.getElementById('selection-count');
            if (countElement) {
                countElement.textContent = `已选 ${selectedMessages.size} 条`;
            }
        }
        
        // 删除选中的消息
        function deleteSelectedMessages() {
            if (selectedMessages.size === 0) return;
            
            if (!currentChatCharacter) return;
            
            if (confirm(`确定要删除选中的 ${selectedMessages.size} 条消息吗？此操作不可恢复！`)) {
                const characterId = currentChatCharacter.id;
                
                if (chatMessages[characterId]) {
                    // 🔥【修复】过滤掉选中的消息，同时删除相关的撤回提示
                    const messagesToDelete = new Set(selectedMessages);
                    
                    // 查找所有要删除的消息内容，用于匹配相关的撤回提示
                    const deleteContentSet = new Set();
                    chatMessages[characterId].forEach(message => {
                        if (selectedMessages.has(message.id) && message.content) {
                            deleteContentSet.add(message.content);
                        }
                    });
                    
                    // 过滤消息：删除选中消息 + 相关的撤回提示
                    chatMessages[characterId] = chatMessages[characterId].filter(message => {
                        // 删除选中的消息
                        if (selectedMessages.has(message.id)) {
                            return false;
                        }
                        
                        // 删除相关的撤回提示（系统消息类型，且原文匹配要删除的消息）
                        if (message.sender === 'system' && message.type === 'recalled_message' && message.originalContent) {
                            if (deleteContentSet.has(message.originalContent)) {
                                console.log('删除相关的撤回提示:', message.content);
                                return false;
                            }
                        }
                        
                        return true;
                    });
                    
                    saveChatMessages();
                    renderChatMessages(characterId);
                    renderMessageList(); // 更新消息列表
                }
                
                // 退出选择模式
                exitMessageSelectionMode();
            }
        }

        // 悬浮按钮功能
        // 变量控制等待回复状态
        let isWaitingForReply = false;
        let pendingUserMessage = null;

        // 重新生成最后一次AI回复
        async function regenerateLastResponse() {
            if (!currentChatCharacter) {
                alert('请先选择一个角色');
                return;
            }

            const characterId = currentChatCharacter.id;
            const messages = chatMessages[characterId] || [];
            
            // 找到最后一条AI消息及其对应的用户消息
            let lastAiMessageIndex = -1;
            let lastUserMessageIndex = -1;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender === 'received' && lastAiMessageIndex === -1) {
                    lastAiMessageIndex = i;
                }
                if (lastAiMessageIndex !== -1 && messages[i].sender === 'sent' && lastUserMessageIndex === -1) {
                    lastUserMessageIndex = i;
                    break;
                }
            }
            
            if (lastAiMessageIndex === -1) {
                alert('没有找到AI回复可以重新生成');
                return;
            }
            
            if (lastUserMessageIndex === -1) {
                alert('没有找到对应的用户消息');
                return;
            }

            const userMessage = messages[lastUserMessageIndex];
            
            // 删除从最后一条用户消息后的所有AI消息
            chatMessages[characterId] = messages.slice(0, lastUserMessageIndex + 1);
            saveChatMessages();
            renderChatMessages(characterId);
            
            // 显示正在输入提示
            showTypingIndicator();
            
            // 添加随机延迟
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
            
            try {
                // 重新调用API，支持图片和表情包
                let response;
                if (userMessage.image) {
                    // 如果是图片消息，使用带图片的API调用
                    if (userMessage.isEmoji) {
                        // 表情包消息，使用增强的表情包识别提示词
                        const emojiPrompt = `用户发送了一个表情包图片。这是一个表情包/梗图，请仔细观察图片内容，包括其中的文字、表情、动作、颜色、背景等所有细节，理解其表达的情绪、含义或梗，然后做出自然的回应。如果图片中有文字，请理解文字的含义和语境。表情包描述：${userMessage.emojiDescription || '表情包'}`;
                        response = await callChatAPIWithImage(emojiPrompt, currentChatCharacter, userMessage.image);
                    } else {
                        // 普通图片消息
                        const imagePrompt = userMessage.content || `用户发送了一张图片。请仔细观察图片内容并做出回应。`;
                        response = await callChatAPIWithImage(imagePrompt, currentChatCharacter, userMessage.image);
                    }
                } else {
                    // 文字消息
                    response = await callChatAPI(userMessage.content, currentChatCharacter);
                }
                const aiMessages = parseAiResponse(response);
                
                hideTypingIndicator();
                
                // 添加新的AI回复
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
                    if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', 
                            content: msgData.content, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image', 
                            content: '',
                            image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AI描述的图片]</text></svg>')}`,
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', 
                            amount: msgData.amount, 
                            note: msgData.note, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'emoji') {
                        // 🔥【新增】处理AI发送的表情包
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: '',
                            image: msgData.url,
                            isEmoji: true,
                            emojiDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                        
                        // 将表情包添加到最近使用
                        addToRecentEmojis({
                            id: msgData.id,
                            url: msgData.url,
                            description: msgData.description
                        });
                    } else if (typeof msgData === 'object' && msgData.type === 'change_avatar') {
                        // 🔥【新增】处理头像更换对象
                        console.log('处理头像更换消息(重新生成):', msgData);
                        if (msgData.avatar_url) {
                            // 验证头像URL是否来自用户发送的图片或世界书中的URL
                            const isValidAvatar = await validateAvatarSource(msgData.avatar_url);
                            console.log('头像来源验证结果(重新生成):', isValidAvatar, '头像URL:', msgData.avatar_url);
                            
                            if (isValidAvatar) {
                                // 执行头像更换
                                const success = await changeCharacterAvatarByAI(msgData.avatar_url, msgData.reason || '心情变化');
                                console.log('头像更换执行结果(重新生成):', success);
                                if (success) {
                                    // 跳过这条消息，只执行头像更换，系统消息已在changeCharacterAvatarByAI中添加
                                    continue;
                                } else {
                                    aiMessage = { 
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: '[头像更换失败]', 
                                        timestamp: Date.now() + i * 100
                                    };
                                }
                            } else {
                                aiMessage = { 
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: '[无效的头像来源，头像更换失败]', 
                                    timestamp: Date.now() + i * 100
                                };
                            }
                        } else {
                            console.log('头像更换消息缺少avatar_url(重新生成)');
                            continue; // 如果没有有效的头像URL，跳过此消息
                        }
                    } else if (typeof msgData === 'object' && msgData.type === 'recalled_message') {
                        // 🔥【新增】处理AI撤回消息(重新生成)
                        console.log('处理撤回消息(重新生成):', msgData);
                        if (msgData.content) {
                            // 查找刚刚添加的匹配消息ID
                            let targetMessageId = null;
                            const messages = chatMessages[currentChatCharacter.id];
                            
                            // 从最后开始查找内容匹配的消息
                            for (let j = messages.length - 1; j >= 0; j--) {
                                if (messages[j].sender === 'received' && messages[j].content === msgData.content) {
                                    targetMessageId = messages[j].id;
                                    console.log('找到要撤回的消息ID(重新生成):', targetMessageId);
                                    break;
                                }
                            }
                            
                            // 调用撤回消息处理函数
                            await handleRecalledMessage(msgData.content, targetMessageId);
                            continue; // 撤回消息不需要保存到聊天记录，已在handleRecalledMessage中处理
                        } else {
                            console.log('撤回消息缺少content(重新生成)');
                            continue; // 如果没有内容，跳过此消息
                        }
                    } else {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: String(msgData), 
                            timestamp: Date.now() + i * 100
                        };
                    }
                    
                    chatMessages[characterId].push(aiMessage);
                    saveChatMessages();
                    renderChatMessages(characterId);
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('重新生成失败:', error);
                hideTypingIndicator();
                
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[重新生成失败: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[characterId].push(errorMessage);
                saveChatMessages();
                renderChatMessages(characterId);
            }
            
            // 更新按钮显示状态
            updateFloatingButtonsVisibility();
        }

        // 智能回复功能
        function triggerSmartReply() {
            if (!currentChatCharacter) {
                alert('请先选择一个角色');
                return;
            }

            if (isWaitingForReply) {
                alert('AI正在回复中，请稍候...');
                return;
            }

            const messages = chatMessages[currentChatCharacter.id] || [];
            
            // 找到最后一条用户消息
            let lastUserMessage = null;
            let hasUnrepliedUserMessage = false;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].sender === 'sent') {
                    lastUserMessage = messages[i];
                    
                    // 检查这条用户消息后是否有AI回复
                    hasUnrepliedUserMessage = true;
                    for (let j = i + 1; j < messages.length; j++) {
                        if (messages[j].sender === 'received') {
                            hasUnrepliedUserMessage = false;
                            break;
                        }
                    }
                    break;
                }
            }
            
            // 情况1：有未回复的用户消息
            if (lastUserMessage && hasUnrepliedUserMessage) {
                pendingUserMessage = lastUserMessage;
            processAIReply();
                return;
            }
            
            // 情况2：最后的用户消息已有AI回复，需要AI续写
            if (lastUserMessage && !hasUnrepliedUserMessage) {
                // 检查从最后一条用户消息后的AI回复轮数
                let aiReplyRounds = 0;
                let lastUserMessageIndex = -1;
                
                // 找到最后一条用户消息的索引
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].sender === 'sent') {
                        lastUserMessageIndex = i;
                        break;
                    }
                }
                
                // 计算从最后一条用户消息后的AI回复轮数
                // 一轮 = 连续的AI消息直到下一个断点
                if (lastUserMessageIndex !== -1) {
                    let inAIReplyRound = false;
                    
                    for (let i = lastUserMessageIndex + 1; i < messages.length; i++) {
                        if (messages[i].sender === 'received') {
                            if (!inAIReplyRound) {
                                // 开始新的AI回复轮
                                aiReplyRounds++;
                                inAIReplyRound = true;
                            }
                            // 继续当前回合（多条连续AI消息算一轮）
                        } else {
                            // 如果有其他类型消息，结束当前回合
                            inAIReplyRound = false;
                        }
                    }
                }
                
                // AI回复逻辑：
                // aiReplyRounds = 0: 没有回复用户消息，不应该到这里
                // aiReplyRounds = 1: 已回复用户消息1轮，现在是第1次续写（第2轮）
                // aiReplyRounds = 2: 已回复+续写1轮，现在是第2次续写（第3轮）
                // aiReplyRounds >= 3: 已回复+续写2轮，提示用户发消息
                
                if (aiReplyRounds >= 3) {
                    const characterName = currentChatCharacter.name;
                    alert(`${characterName}已经说了很多话了，先和${characterName}说说话吧~`);
                    return;
                }
                
                // AI续写对话（第1次或第2次续写）
                processAIContinuation();
                return;
            }
            
            // 情况3：没有用户消息
            alert('请先发送一条消息，然后点击此按钮来获取AI回复');
        }

        // 处理AI续写对话
        async function processAIContinuation() {
            if (!currentChatCharacter) return;

            isWaitingForReply = true;
            
            // 更新智能回复按钮状态
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = true;
                smartReplyBtn.style.opacity = '0.65';
                smartReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // 显示正在输入提示
            showTypingIndicator();
            
            // 添加随机延迟
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                // 获取AI最后的消息内容，以便基于此续写
                const messages = chatMessages[currentChatCharacter.id] || [];
                let lastAIMessage = "";
                
                // 找到最后一条AI消息
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].sender === 'received') {
                        lastAIMessage = messages[i].content || "";
                        break;
                    }
                }
                
                // 构建续写提示词，基于AI自己最后的话来续写
                let continuationPrompt = "你刚才说了：\"" + lastAIMessage + "\"\n\n";
                continuationPrompt += "现在请基于你刚才说的话，主动继续这个话题或者自然地转到相关话题。就像真实聊天中，你想要继续表达更多想法，或者询问对方的看法，或者分享相关的内容。请自然地继续对话，不要重复之前说过的话。";
                continuationPrompt += "\n\n🚨 重要提醒：请严格遵守JSON格式，每条消息必须分开发送，绝对不能将多条消息合并在一个元素中！正确格式：[\"消息1\", \"消息2\"]，错误格式：[\"消息1\\n消息2\"]";
                
                const response = await callChatAPI(continuationPrompt, currentChatCharacter);
                const aiMessages = parseAiResponse(response);
                
                hideTypingIndicator();
                
                // 逐条发送消息
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
                    if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', 
                            content: msgData.content, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image', 
                            content: '',
                            image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AI描述的图片]</text></svg>')}`,
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', 
                            amount: msgData.amount, 
                            note: msgData.note, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'emoji') {
                        // 处理AI发送的表情包
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: '',
                            image: msgData.url,
                            isEmoji: true,
                            emojiDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                        
                        // 将表情包添加到最近使用
                        addToRecentEmojis({
                            id: msgData.id,
                            url: msgData.url,
                            description: msgData.description
                        });
                    } else if (typeof msgData === 'object' && msgData.type === 'change_avatar') {
                        // 🔥【新增】处理头像更换对象
                        console.log('处理头像更换消息(续写):', msgData);
                        if (msgData.avatar_url) {
                            // 验证头像URL是否来自用户发送的图片或世界书中的URL
                            const isValidAvatar = await validateAvatarSource(msgData.avatar_url);
                            console.log('头像来源验证结果(续写):', isValidAvatar, '头像URL:', msgData.avatar_url);
                            
                            if (isValidAvatar) {
                                // 执行头像更换
                                const success = await changeCharacterAvatarByAI(msgData.avatar_url, msgData.reason || '心情变化');
                                console.log('头像更换执行结果(续写):', success);
                                if (success) {
                                    // 跳过这条消息，只执行头像更换，系统消息已在changeCharacterAvatarByAI中添加
                                    continue;
                                } else {
                                    aiMessage = { 
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: '[头像更换失败]', 
                                        timestamp: Date.now() + i * 100
                                    };
                                }
                            } else {
                                aiMessage = { 
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: '[无效的头像来源，头像更换失败]', 
                                    timestamp: Date.now() + i * 100
                                };
                            }
                        } else {
                            console.log('头像更换消息缺少avatar_url(续写)');
                            continue; // 如果没有有效的头像URL，跳过此消息
                        }
                    } else if (typeof msgData === 'object' && msgData.type === 'recalled_message') {
                        // 🔥【新增】处理AI撤回消息(续写)
                        console.log('处理撤回消息(续写):', msgData);
                        if (msgData.content) {
                            // 查找刚刚添加的匹配消息ID
                            let targetMessageId = null;
                            const messages = chatMessages[currentChatCharacter.id];
                            
                            // 从最后开始查找内容匹配的消息
                            for (let j = messages.length - 1; j >= 0; j--) {
                                if (messages[j].sender === 'received' && messages[j].content === msgData.content) {
                                    targetMessageId = messages[j].id;
                                    console.log('找到要撤回的消息ID(续写):', targetMessageId);
                                    break;
                                }
                            }
                            
                            // 调用撤回消息处理函数
                            await handleRecalledMessage(msgData.content, targetMessageId);
                            continue; // 撤回消息不需要保存到聊天记录，已在handleRecalledMessage中处理
                        } else {
                            console.log('撤回消息缺少content(续写)');
                            continue; // 如果没有内容，跳过此消息
                        }
                    } else {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: String(msgData), 
                            timestamp: Date.now() + i * 100
                        };
                    }
                    
                    chatMessages[currentChatCharacter.id].push(aiMessage);
                    saveChatMessages();
                    renderChatMessages(currentChatCharacter.id);
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('AI续写失败:', error);
                hideTypingIndicator();
                
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[续写失败: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[currentChatCharacter.id].push(errorMessage);
                saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
            } finally {
                // 重置状态
                isWaitingForReply = false;
                pendingUserMessage = null;
                
                // 恢复智能回复按钮
                if (smartReplyBtn) {
                    smartReplyBtn.disabled = false;
                    smartReplyBtn.style.opacity = '';
                    smartReplyBtn.style.animation = 'none';
                    smartReplyBtn.classList.remove('waiting');
                    smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    smartReplyBtn.title = '获取AI回复';
                }
                
                // 更新按钮显示状态
                updateFloatingButtonsVisibility();
            }
        }

        // 处理AI回复
        async function processAIReply() {
            if (!pendingUserMessage || !currentChatCharacter) return;

            isWaitingForReply = true;
            
            // 更新智能回复按钮状态
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = true;
                smartReplyBtn.style.opacity = '0.65';
                smartReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            // 显示正在输入提示
            showTypingIndicator();
            
            // 添加随机延迟
            const delay = Math.random() * 2000 + 1000;
            await new Promise(resolve => setTimeout(resolve, delay));

            try {
                // 调用API，支持图片和表情包
                let response;
                if (pendingUserMessage.image) {
                    // 如果是图片消息，使用带图片的API调用
                    if (pendingUserMessage.isEmoji) {
                        // 表情包消息，使用增强的表情包识别提示词
                        const emojiPrompt = `用户发送了一个表情包图片。这是一个表情包/梗图，请仔细观察图片内容，包括其中的文字、表情、动作、颜色、背景等所有细节，理解其表达的情绪、含义或梗，然后做出自然的回应。如果图片中有文字，请理解文字的含义和语境。表情包描述：${pendingUserMessage.emojiDescription || '表情包'}`;
                        response = await callChatAPIWithImage(emojiPrompt, currentChatCharacter, pendingUserMessage.image);
                    } else {
                        // 普通图片消息
                        const imagePrompt = pendingUserMessage.content || `用户发送了一张图片。请仔细观察图片内容并做出回应。`;
                        response = await callChatAPIWithImage(imagePrompt, currentChatCharacter, pendingUserMessage.image);
                    }
                } else {
                    // 文字消息
                    response = await callChatAPI(pendingUserMessage.content, currentChatCharacter);
                }
                const aiMessages = parseAiResponse(response);
                
                hideTypingIndicator();
                
                // 逐条发送消息
                for (let i = 0; i < aiMessages.length; i++) {
                    const msgData = aiMessages[i];
                    let aiMessage;
                    
                    if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'voice_message', 
                            content: msgData.content, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'ai_image', 
                            content: '',
                            image: `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="#f0f0f0"/><text x="100" y="75" text-anchor="middle" font-family="Arial" font-size="12" fill="#666">[AI描述的图片]</text></svg>')}`,
                            imageDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            type: 'transfer', 
                            amount: msgData.amount, 
                            note: msgData.note, 
                            timestamp: Date.now() + i * 100
                        };
                    } else if (typeof msgData === 'object' && msgData.type === 'emoji') {
                        // 🔥【新增】处理AI发送的表情包
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: '',
                            image: msgData.url,
                            isEmoji: true,
                            emojiDescription: msgData.description,
                            timestamp: Date.now() + i * 100
                        };
                        
                        // 将表情包添加到最近使用
                        addToRecentEmojis({
                            id: msgData.id,
                            url: msgData.url,
                            description: msgData.description
                        });
                    } else if (typeof msgData === 'object' && msgData.type === 'change_avatar') {
                        // 🔥【新增】处理头像更换对象
                        console.log('处理头像更换消息:', msgData);
                        if (msgData.avatar_url) {
                            // 验证头像URL是否来自用户发送的图片或世界书中的URL
                            const isValidAvatar = await validateAvatarSource(msgData.avatar_url);
                            console.log('头像来源验证结果:', isValidAvatar, '头像URL:', msgData.avatar_url);
                            
                            if (isValidAvatar) {
                                // 执行头像更换
                                const success = await changeCharacterAvatarByAI(msgData.avatar_url, msgData.reason || '心情变化');
                                console.log('头像更换执行结果:', success);
                                if (success) {
                                    // 跳过这条消息，只执行头像更换，系统消息已在changeCharacterAvatarByAI中添加
                                    continue;
                                } else {
                                    aiMessage = { 
                                        id: (Date.now() + i).toString(),
                                        sender: 'received',
                                        content: '[头像更换失败]', 
                                        timestamp: Date.now() + i * 100
                                    };
                                }
                            } else {
                                aiMessage = { 
                                    id: (Date.now() + i).toString(),
                                    sender: 'received',
                                    content: '[无效的头像来源，头像更换失败]', 
                                    timestamp: Date.now() + i * 100
                                };
                            }
                        } else {
                            console.log('头像更换消息缺少avatar_url');
                            continue; // 如果没有有效的头像URL，跳过此消息
                        }
                    } else {
                        aiMessage = { 
                            id: (Date.now() + i).toString(),
                            sender: 'received',
                            content: String(msgData), 
                            timestamp: Date.now() + i * 100
                        };
                    }
                    
                    chatMessages[currentChatCharacter.id].push(aiMessage);
                    saveChatMessages();
                    renderChatMessages(currentChatCharacter.id);
                    
                    if (i < aiMessages.length - 1) {
                        const delay = Math.random() * 1000 + 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        if (i < aiMessages.length - 1) {
                            showTypingIndicator();
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 400));
                            hideTypingIndicator();
                        }
                    }
                }
            } catch (error) {
                console.error('AI回复失败:', error);
                hideTypingIndicator();
                
                const errorMessage = {
                    id: Date.now().toString(),
                    sender: 'received',
                    content: `[回复失败: ${error.message}]`,
                    timestamp: Date.now()
                };
                
                chatMessages[currentChatCharacter.id].push(errorMessage);
                saveChatMessages();
                renderChatMessages(currentChatCharacter.id);
            } finally {
                // 重置状态
                isWaitingForReply = false;
                pendingUserMessage = null;
                
                // 恢复智能回复按钮
                if (smartReplyBtn) {
                    smartReplyBtn.disabled = false;
                    smartReplyBtn.style.opacity = '';
                    smartReplyBtn.style.animation = 'none';
                    smartReplyBtn.classList.remove('waiting');
                    smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                    smartReplyBtn.title = '获取AI回复';
                }
                
                // 更新按钮显示状态
                updateFloatingButtonsVisibility();
            }
        }

        // 重置悬浮按钮状态
        function resetFloatingButtonsState() {
            // 重置待回复消息
            pendingUserMessage = null;
            isWaitingForReply = false;
            
            // 重置智能回复按钮状态
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.disabled = false;
                smartReplyBtn.style.opacity = '';
                smartReplyBtn.style.animation = 'none';
                smartReplyBtn.innerHTML = '<i class="fas fa-comment-dots"></i>';
                smartReplyBtn.title = '获取AI回复';
                smartReplyBtn.classList.remove('waiting');
            }
            
            // 更新按钮显示状态
            updateFloatingButtonsVisibility();
        }

        // 更新悬浮按钮的显示状态
        function updateFloatingButtonsVisibility() {
            if (!currentChatCharacter) return;
            
            const regenerateBtn = document.getElementById('regenerate-btn');
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            const messages = chatMessages[currentChatCharacter.id] || [];
            
            // 检查是否有AI消息可以重新生成
            const hasAIMessages = messages.some(msg => msg.sender === 'received');
            
            if (regenerateBtn) {
                if (hasAIMessages) {
                    regenerateBtn.classList.remove('hidden');
                } else {
                    regenerateBtn.classList.add('hidden');
                }
            }
            
            if (smartReplyBtn) {
                // 智能回复按钮总是显示
                smartReplyBtn.classList.remove('hidden');
            }
        }

        // 修改原来的sendApiMessage函数，使其只发送消息到界面，不触发AI回复
        async function sendApiMessage() {
            const input = document.getElementById('api-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!currentChatCharacter) {
                alert('请先选择一个角色');
                return;
            }
            
            // 添加用户消息
            const messageId = Date.now().toString();
            const userMessage = {
                id: messageId,
                sender: 'sent',
                content: message,
                timestamp: Date.now()
            };
            
            if (!chatMessages[currentChatCharacter.id]) {
                chatMessages[currentChatCharacter.id] = [];
            }
            
            chatMessages[currentChatCharacter.id].push(userMessage);
            saveChatMessages();
            
            // 清空输入框
            input.value = '';
            
            // 渲染消息
            renderChatMessages(currentChatCharacter.id);
            
            // 设置待回复消息
            pendingUserMessage = userMessage;
            
            // 更新智能回复按钮状态
            const smartReplyBtn = document.getElementById('smart-reply-btn');
            if (smartReplyBtn) {
                smartReplyBtn.style.animation = 'pulse 1.5s infinite';
                smartReplyBtn.classList.add('waiting');
                smartReplyBtn.title = '点击获取AI回复';
            }
        }
        
        // 加载朋友圈动态
        function loadMoments() {
            // TODO: 实现朋友圈动态加载逻辑
            console.log('加载朋友圈动态');
        }
        
        // 显示发布动态界面
        function showPublishMoment() {
            // TODO: 实现发布动态功能
            alert('发布动态功能正在开发中...');
        }
        
        // 开始游戏
        function startGame(gameName) {
            if (gameName === 'witchPotion') {
                // TODO: 实现女巫的解药游戏
                alert('女巫的解药游戏正在开发中...\n\n这将是一个与AI角色互动的解谜游戏！');
            } else {
                alert('游戏功能正在开发中...');
            }
        }
        
                // 切换手机边框显示
        function togglePhoneBorder() {
            const phoneFrame = document.getElementById('phone-frame');
            const phoneScreen = document.getElementById('phone-screen');
            const toggle = document.getElementById('phone-border-toggle');
            const body = document.body;
            
            if (toggle.checked) {
                // 显示真实手机边框
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '12px';
                phoneFrame.style.backgroundColor = '#fff';
                phoneFrame.style.borderRadius = '50px';
                phoneFrame.style.boxShadow = '0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1)';
                phoneScreen.style.borderRadius = '40px';
                phoneScreen.style.border = '2px solid #333';
                body.style.background = 'var(--body-bg, #dcdcdc)';
                body.style.padding = '20px';
            } else {
                // 隐藏边框，但保持phone-screen的圆角和阴影
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '0';
                phoneFrame.style.backgroundColor = 'transparent';
                phoneFrame.style.borderRadius = '0';
                phoneFrame.style.boxShadow = 'none';
                phoneScreen.style.borderRadius = '25px';
                phoneScreen.style.border = 'none';
                phoneScreen.style.boxShadow = 'var(--shadow-phone)';
                body.style.background = 'var(--body-bg, #1a1a1a)';
                body.style.padding = '0';
            }
            
            // 保存设置到localStorage
            localStorage.setItem('phoneBorderEnabled', toggle.checked);
        }
        
        // 显示屏幕尺寸选择
        function showScreenSizeOptions() {
            showApp('screen-size-screen');
        }
        
        // 改变屏幕尺寸
        function changeScreenSize(width, height, name) {
            const phoneScreen = document.getElementById('phone-screen');
            
            // 应用新尺寸
            phoneScreen.style.width = width + 'px';
            phoneScreen.style.height = height + 'px';
            
            // 更新外观设置中的显示文本
            const currentSizeDesc = document.getElementById('current-screen-size');
            if (currentSizeDesc) {
                currentSizeDesc.textContent = `当前：${width}×${height} (${name})`;
            }
            
            // 更新选中状态
            document.querySelectorAll('.size-option .check-icon').forEach(icon => {
                icon.style.display = 'none';
            });
            document.querySelectorAll('.size-option').forEach(option => {
                option.style.backgroundColor = '';
            });
            
            // 显示当前选中项的勾选图标
            const currentOption = event.target.closest('.size-option');
            if (currentOption) {
                const checkIcon = currentOption.querySelector('.check-icon');
                if (checkIcon) {
                    checkIcon.style.display = 'block';
                } else {
                    // 如果没有勾选图标，创建一个
                    const newCheckIcon = document.createElement('i');
                    newCheckIcon.className = 'fas fa-check check-icon';
                    newCheckIcon.style.display = 'block';
                    currentOption.appendChild(newCheckIcon);
                }
                currentOption.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
            }
            
            // 保存到localStorage
            localStorage.setItem('screenSize', JSON.stringify({width, height, name}));
            
            // 延迟一点再返回，让用户看到选择效果
            setTimeout(() => {
                showApp('appearance-screen');
            }, 300);
        }
        
        // 加载屏幕尺寸设置
        function loadScreenSize() {
            const saved = localStorage.getItem('screenSize');
            if (saved) {
                const {width, height, name} = JSON.parse(saved);
                const phoneScreen = document.getElementById('phone-screen');
                phoneScreen.style.width = width + 'px';
                phoneScreen.style.height = height + 'px';
                
                const currentSizeDesc = document.getElementById('current-screen-size');
                if (currentSizeDesc) {
                    currentSizeDesc.textContent = `当前：${width}×${height} (${name})`;
                }
            }
        }
        
        // 加载边框设置
        function loadPhoneBorderSetting() {
            const saved = localStorage.getItem('phoneBorderEnabled');
            const toggle = document.getElementById('phone-border-toggle');
            
            // 默认关闭边框
            const enabled = saved !== null ? saved === 'true' : false;
            
            if (toggle) {
                toggle.checked = enabled;
            }
            
            // 应用设置
            const phoneFrame = document.getElementById('phone-frame');
            const phoneScreen = document.getElementById('phone-screen');
            const body = document.body;
            
            if (enabled) {
                // 显示真实手机边框
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '12px';
                phoneFrame.style.backgroundColor = '#fff';
                phoneFrame.style.borderRadius = '50px';
                phoneFrame.style.boxShadow = '0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1)';
                phoneScreen.style.borderRadius = '40px';
                phoneScreen.style.border = '2px solid #333';
                body.style.background = 'var(--body-bg, #dcdcdc)';
                body.style.padding = '20px';
            } else {
                // 隐藏边框，但保持phone-screen的圆角和阴影
                phoneFrame.style.display = 'block';
                phoneFrame.style.padding = '0';
                phoneFrame.style.backgroundColor = 'transparent';
                phoneFrame.style.borderRadius = '0';
                phoneFrame.style.boxShadow = 'none';
                phoneScreen.style.borderRadius = '25px';
                phoneScreen.style.border = 'none';
                phoneScreen.style.boxShadow = 'var(--shadow-phone)';
                body.style.background = 'var(--body-bg, #1a1a1a)';
                body.style.padding = '0';
            }
        }
 
    </script>
    </div>
</body>
</html>
        